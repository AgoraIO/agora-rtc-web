/**
 * AgoraWebSDK_N-LiveVideo-2023/8/31 17:26:43 Copyright AgoraInc.
 */

import e from"agora-rtc-sdk-ng";class t{_events=new Map;getListeners(e){const t=this._events.get(e);return Array.isArray(t)?t.map((e=>e.listener)):[]}on(e,t){let i=this._events.get(e);Array.isArray(i)||(i=[],this._events.set(e,i)),-1===this._indexOfListener(i,t)&&i.push({listener:t,once:!1})}addListener=this.on;once(e,t){let i=this._events.get(e);Array.isArray(i)||(i=[],this._events.set(e,i)),-1===this._indexOfListener(i,t)&&i.push({listener:t,once:!0})}off(e,t){const i=this._events.get(e);if(!Array.isArray(i))return;const s=this._indexOfListener(i,t);-1!==s&&i.splice(s,1),0===this._events.size&&this._events.delete(e)}removeAllListeners(e){if(!e)return this._events.clear();this._events.delete(e)}emit(e,...t){const i=this._events.get(e);Array.isArray(i)&&i.forEach((i=>{i.once&&this.off(e,i.listener),i.listener.apply(this,t||[])}))}safeEmit(e,...t){const i=this._events.get(e);Array.isArray(i)&&i.forEach((i=>{i.once&&this.off(e,i.listener);try{i.listener.apply(this,t||[])}catch(t){console.error(`safeEmit event:${e} error ${t?.toString()}`)}}))}_indexOfListener(e,t){return e.findIndex((e=>e.listener===t))}}const i=()=>{};function s(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:i};return e.promise=new Promise(((t,i)=>{e.resolve=i=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(i),e.value=i)},e.reject=t=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,i(t))}})),e}function h(e){const t=s();return t.resolve(e),t}var a,o,r,n,d;!function(e){e.AUTOPLAY_PREVENTED="autoplay_was_prevented",e.STATE_CHANGED="state_changed",e.VIDEO_STATE_CHANGED="video_state_changed",e.AUDIO_STATE_CHANGED="audio_state_changed",e.HOST_CHANGED="host_changed",e.USER_STATE_CHANGED="user_state_changed",e.ERROR="error"}(a||(a={})),function(e){e.CREATING="creating",e.CREATED="created",e.CONNECTING="connecting",e.CONNECTED="connected",e.CONNECT_FAILED="connect-failed",e.DESTROYED="destroyed"}(o||(o={})),function(e){e.JOINED="joined",e.LEFT="left",e.UNPUBLISHED="unpublished",e.PUBLISHED="published"}(r||(r={})),function(e){e.PLAYING="playing",e.PAUSED="paused",e.STOPPED="stopped",e.EMPTY="empty"}(n||(n={}));class l extends t{client;host;options;element;state=o.CREATING;videoState=n.EMPTY;audioState=n.EMPTY;pendingRemoteUsers=[];videoTrack;audioTrack;audioDefer;videoDefer;constructor(t){super(),this.options=t,this.create(),e.onAutoplayFailed=this.onAutoplayFailed}onAutoplayFailed=()=>{this.safeEmit(a.AUTOPLAY_PREVENTED)};setState(e){this.state!==e&&(this.state=e,this.safeEmit(a.STATE_CHANGED,e))}setVideoState(e){this.videoState!==e&&(this.videoState=e,this.safeEmit(a.VIDEO_STATE_CHANGED,e))}setAudioState(e){this.audioState!==e&&(this.audioState=e,this.safeEmit(a.AUDIO_STATE_CHANGED,e))}createElement(e,t,i,s){if(this.element="string"==typeof e?document.getElementById(e):e||document.createElement("video"),!this.element||"VIDEO"!==this.element.tagName)throw new Error(`Cannot get video element by id: ${e}`);t&&(this.element.style.width=`${t}px`),i&&(this.element.style.height=`${i}px`),s&&(this.element.style.aspectRatio=`${s}`)}async join(){this.setState(o.CONNECTING);const e=function(e){const t=/([^\/\?&]+)=([^\/\?&]+)/g,[,i,s,h,a]=Array.from(e.match(/^rte:\/\/([^\/]+)\/([^\/]+)\/([^\/\?]+)(\?[^\/\?]+)?/)||[]),o={appid:i,appname:s,steamname:h,token:null,uid:null};let r=[];for(;(r=Array.from(t.exec(a)||[])).length>0;)"token"===r[1]&&(o[r[1]]=r[2]),"uid"===r[1]&&(o[r[1]]=Number(r[2])||r[2]);return"null"===o.token&&(o.token=null),"null"===o.uid&&(o.uid=null),o}(this.options.url);try{await this.client.join(e.appid,`${e.appname}|${e.steamname}`,e.token,e.uid),this.setState(o.CONNECTED)}catch(e){this.setState(o.CONNECT_FAILED)}return this.state===o.CONNECTED&&this.bindEvents(),this.state===o.CONNECTED}reset(e){this.audioDefer&&!this.audioDefer.isFinished&&(this.audioDefer.reject(e),this.audioDefer=void 0),this.videoDefer&&!this.videoDefer.isFinished&&(this.videoDefer.reject(e),this.videoDefer=void 0),this.videoTrack&&(this.videoTrack.stop(),this.videoTrack=void 0,this.host&&this.client.unsubscribe(this.host,"video"),this.setVideoState(n.EMPTY)),this.audioTrack&&(this.audioTrack.stop(),this.audioTrack=void 0,this.host&&this.client.unsubscribe(this.host,"audio"),this.setAudioState(n.EMPTY)),this.host=void 0,this.pendingRemoteUsers=[],this.unbindEvent()}async recreate(){return this.reset("switch url"),this.client&&this.client.leave(),this.create()}setVolume(e){return e=Math.min(e,1),this.audioTrack?(this.audioTrack.setVolume(100*e),e):-1}getVolume(){return this.audioTrack?this.audioTrack.getVolumeLevel():-1}async playAudio(){if(this.host&&!this.host.hasAudio&&(this.audioDefer&&!this.audioDefer.isFinished||(this.audioDefer=s()),await this.audioDefer.promise),!this.host)return;const e=await this.client.subscribe(this.host,"audio");this.audioTrack=e,this.audioTrack.play(),this.setAudioState(n.PLAYING)}async playVideo(){if(this.host&&!this.host.hasVideo&&(this.videoDefer&&!this.videoDefer.isFinished||(this.videoDefer=s()),await this.videoDefer.promise),!this.host)return;const e=await this.client.subscribe(this.host,"video");this.videoTrack=e,this.videoTrack.play(this.element),this.setVideoState(n.PLAYING)}async pauseAudio(e){const t=this.audioState===n.PLAYING,i=this.audioState===n.PAUSED;if(this.audioTrack&&this.host&&(t||i))return t&&this.audioTrack.stop(),e?(await this.client.unsubscribe(this.host,"audio"),this.setAudioState(n.STOPPED)):this.setAudioState(n.PAUSED)}async pauseVideo(e){const t=this.videoState===n.PLAYING,i=this.videoState===n.PAUSED;if(this.videoTrack&&this.host&&(t||i))return t&&this.videoTrack.stop(),e?(await this.client.unsubscribe(this.host,"video"),this.setVideoState(n.STOPPED)):this.setVideoState(n.PAUSED)}async playRemoteUser(e){throw new Error("should implement by child class")}onUserJoined=async e=>{this.host?this.pendingRemoteUsers.push(e):await this.playRemoteUser(e),this.safeEmit(a.USER_STATE_CHANGED,{state:r.JOINED,user:e,isHost:this.host&&this.host.uid===e.uid})};onUserLeft=async e=>{this.safeEmit(a.USER_STATE_CHANGED,{state:r.LEFT,user:e,isHost:this.host&&this.host.uid===e.uid});const t=this.pendingRemoteUsers.findIndex((t=>t.uid===e.uid));if(-1!==t)return this.pendingRemoteUsers.splice(t,1);this.host&&this.host.uid===e.uid&&(this.audioDefer&&this.audioDefer.reject("user left"),this.videoDefer&&this.videoDefer.reject("user left"));const i=this.pendingRemoteUsers.findIndex((e=>e.hasVideo))||this.pendingRemoteUsers.findIndex((e=>e.hasVideo))||0;let s;this.pendingRemoteUsers.length>0&&(s=this.pendingRemoteUsers[i],this.pendingRemoteUsers.splice(i,1)),this.playRemoteUser(s)};onUserUnpublished=async(e,t)=>{const i=this.host&&this.host.uid===e.uid;this.safeEmit(a.USER_STATE_CHANGED,{state:r.UNPUBLISHED,user:e,mediaType:t,isHost:i}),"video"===t&&i&&(this.videoTrack=void 0,this.setVideoState(n.STOPPED),this.videoDefer=s(),this.playVideo().catch((()=>{}))),"audio"===t&&i&&(this.audioTrack=void 0,this.setAudioState(n.STOPPED),this.audioDefer=s(),this.playAudio().catch((()=>{})))};onUserPublished=async(e,t)=>{const i=this.host&&this.host.uid===e.uid;this.safeEmit(a.USER_STATE_CHANGED,{state:r.PUBLISHED,user:e,mediaType:t,isHost:i}),i&&("video"===t&&this.videoDefer&&this.videoDefer.resolve(),"audio"===t&&this.audioDefer&&this.audioDefer.resolve())};bindEvents(){this.client.on("user-published",this.onUserPublished),this.client.on("user-unpublished",this.onUserUnpublished),this.client.on("user-joined",this.onUserJoined),this.client.on("user-left",this.onUserLeft)}unbindEvent(){this.client.off("user-published",this.onUserPublished),this.client.off("user-unpublished",this.onUserUnpublished),this.client.off("user-joined",this.onUserJoined),this.client.off("user-left",this.onUserLeft)}async _retry(){return this.reset("retry"),this.client.leave(),this.join()}async _pause(e){await Promise.all([this.pauseAudio(e),this.pauseVideo(e)])}async _play(){let e=!1;if(this.videoTrack&&this.videoState===n.PAUSED&&(this.videoTrack.play(this.element),this.setVideoState(n.PLAYING)),this.audioTrack&&this.audioState===n.PAUSED&&(this.audioTrack.play(),this.setAudioState(n.PLAYING)),e=this.videoState===n.PLAYING||this.audioState===n.PLAYING,!e){if(this.state===o.CONNECT_FAILED&&await this.join(),this.state===o.CONNECT_FAILED){const e={message:"play failed",reason:this.host?"join failed!":"no user joined"};throw this.safeEmit(a.ERROR,e),e}this.host&&await this.playRemoteUser(this.host)}}async _switch(e){e!==this.options.url&&(this.options.url=e,await this.recreate())}async create(){this.setState(o.CREATING),this.setAudioState(n.EMPTY),this.setVideoState(n.EMPTY),this.client=e.createClient({mode:"live",codec:"vp8"}),this.createElement(this.options.id,this.options.width,this.options.height,this.options.aspectRatio),this.setState(o.CREATED),await this.join()}getStats(){if(this.client&&this.host)return{audio:this.client.getRemoteAudioStats()[this.host.uid],video:this.client.getRemoteVideoStats()[this.host.uid]}}async _destroy(){e.off("autoplay-failed",this.onAutoplayFailed),this.reset("destroy"),this.client&&this.client.leave(),this.state=o.DESTROYED}}!function(e){e.WILL_PLAY="will_play",e.PLAYING="playing",e.PAUSED="paused",e.STOPPED="stopped"}(d||(d={}));class u extends l{playDefer=h(!1);pauseDefer=h(!1);retryDefer=h(!1);switchDefer=h(!1);playState=d.STOPPED;get isPlaying(){return this.playState===d.PLAYING}get isPaused(){return this.playState===d.PAUSED}get isStopped(){return this.playState===d.STOPPED}async playRemoteUser(e){(!this.host||!e||this.host.uid!==e.uid)&&this.safeEmit(a.HOST_CHANGED,this.host,e),this.host=e,!this.host||this.isPaused||this.isStopped||await Promise.any([this.playAudio(),this.playVideo()]).catch((e=>{this.safeEmit(a.ERROR,e)}))}constructor(e){super(e)}async play(){await Promise.all([this.switchDefer.promise,this.pauseDefer.promise,this.playDefer.promise]),this.playDefer=s();const e=this.playState;try{this.playState=d.WILL_PLAY,await this._play(),this.playState=d.PLAYING}catch(t){throw this.playState=e,t}finally{this.playDefer.resolve(!0)}}async pause(e){await Promise.all([this.switchDefer.promise,this.pauseDefer.promise]),this.pauseDefer=s();try{await this._pause(e),this.playState=this.playState===d.STOPPED||e?d.STOPPED:d.PAUSED}finally{this.pauseDefer.resolve(!0)}}async retry(){await Promise.all([this.playDefer.promise,this.pauseDefer.promise,this.switchDefer.promise,this.retryDefer.promise]),this.retryDefer=s();try{await this._retry()}finally{this.retryDefer.resolve(!0)}}async switchURL(e){await this.switchDefer.promise,this.switchDefer=s();try{await this._switch(e)}finally{this.switchDefer.resolve(!0)}}destroy(){this._destroy(),this.playState=d.STOPPED,!this.playDefer.isFinished&&this.playDefer.reject(!1),!this.pauseDefer.isFinished&&this.pauseDefer.reject(!1),!this.retryDefer.isFinished&&this.retryDefer.reject(!1),!this.switchDefer.isFinished&&this.switchDefer.reject(!1),this.pauseDefer=h(!1),this.retryDefer=h(!1),this.playDefer=h(!1),this.switchDefer=h(!1)}}export{a as LiveVideoEvent,u as LiveVideoPlayer,o as LiveVideoState,n as MediaState,r as UserState};
