/**
 * AgoraLivePlayer-0.0.1(2024/4/11 17:00:11) Copyright AgoraInc.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).FLS={})}(this,(function(e){"use strict";function t(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(i){if("default"!==i&&!(i in e)){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}}))})),Object.freeze(e)}var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var s=function(e){return e&&e.Math==Math&&e},r=s("object"==typeof globalThis&&globalThis)||s("object"==typeof window&&window)||s("object"==typeof self&&self)||s("object"==typeof i&&i)||function(){return this}()||i||Function("return this")(),o=function(e){try{return!!e()}catch(e){return!0}},a=!o((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),c=a,d=Function.prototype,l=d.apply,h=d.call,u="object"==typeof Reflect&&Reflect.apply||(c?h.bind(l):function(){return h.apply(l,arguments)}),p=a,f=Function.prototype,m=f.call,E=p&&f.bind.bind(m,m),_=p?E:function(e){return function(){return m.apply(e,arguments)}},g=_,T=g({}.toString),S=g("".slice),v=function(e){return S(T(e),8,-1)},R=v,y=_,C=function(e){if("Function"===R(e))return y(e)},I="object"==typeof document&&document.all,A={all:I,IS_HTMLDDA:void 0===I&&void 0!==I},b=A.all,w=A.IS_HTMLDDA?function(e){return"function"==typeof e||e===b}:function(e){return"function"==typeof e},D={},O=!o((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),N=a,L=Function.prototype.call,P=N?L.bind(L):function(){return L.apply(L,arguments)},k={},M={}.propertyIsEnumerable,U=Object.getOwnPropertyDescriptor,x=U&&!M.call({1:2},1);k.f=x?function(e){var t=U(this,e);return!!t&&t.enumerable}:M;var F,V,B=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},G=o,j=v,W=Object,H=_("".split),K=G((function(){return!W("z").propertyIsEnumerable(0)}))?function(e){return"String"==j(e)?H(e,""):W(e)}:W,Y=function(e){return null==e},q=Y,$=TypeError,z=function(e){if(q(e))throw $("Can't call method on "+e);return e},X=K,J=z,Q=function(e){return X(J(e))},Z=w,ee=A.all,te=A.IS_HTMLDDA?function(e){return"object"==typeof e?null!==e:Z(e)||e===ee}:function(e){return"object"==typeof e?null!==e:Z(e)},ie={},ne=ie,se=r,re=w,oe=function(e){return re(e)?e:void 0},ae=function(e,t){return arguments.length<2?oe(ne[e])||oe(se[e]):ne[e]&&ne[e][t]||se[e]&&se[e][t]},ce=_({}.isPrototypeOf),de="undefined"!=typeof navigator&&String(navigator.userAgent)||"",le=r,he=de,ue=le.process,pe=le.Deno,fe=ue&&ue.versions||pe&&pe.version,me=fe&&fe.v8;me&&(V=(F=me.split("."))[0]>0&&F[0]<4?1:+(F[0]+F[1])),!V&&he&&(!(F=he.match(/Edge\/(\d+)/))||F[1]>=74)&&(F=he.match(/Chrome\/(\d+)/))&&(V=+F[1]);var Ee=V,_e=Ee,ge=o,Te=r.String,Se=!!Object.getOwnPropertySymbols&&!ge((function(){var e=Symbol();return!Te(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&_e&&_e<41})),ve=Se&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,Re=ae,ye=w,Ce=ce,Ie=Object,Ae=ve?function(e){return"symbol"==typeof e}:function(e){var t=Re("Symbol");return ye(t)&&Ce(t.prototype,Ie(e))},be=String,we=function(e){try{return be(e)}catch(e){return"Object"}},De=w,Oe=we,Ne=TypeError,Le=function(e){if(De(e))return e;throw Ne(Oe(e)+" is not a function")},Pe=Le,ke=Y,Me=function(e,t){var i=e[t];return ke(i)?void 0:Pe(i)},Ue=P,xe=w,Fe=te,Ve=TypeError,Be={exports:{}},Ge=r,je=Object.defineProperty,We=function(e,t){try{je(Ge,e,{value:t,configurable:!0,writable:!0})}catch(i){Ge[e]=t}return t},He="__core-js_shared__",Ke=r[He]||We(He,{}),Ye=Ke;(Be.exports=function(e,t){return Ye[e]||(Ye[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var qe=Be.exports,$e=z,ze=Object,Xe=function(e){return ze($e(e))},Je=Xe,Qe=_({}.hasOwnProperty),Ze=Object.hasOwn||function(e,t){return Qe(Je(e),t)},et=_,tt=0,it=Math.random(),nt=et(1..toString),st=function(e){return"Symbol("+(void 0===e?"":e)+")_"+nt(++tt+it,36)},rt=qe,ot=Ze,at=st,ct=Se,dt=ve,lt=r.Symbol,ht=rt("wks"),ut=dt?lt.for||lt:lt&&lt.withoutSetter||at,pt=function(e){return ot(ht,e)||(ht[e]=ct&&ot(lt,e)?lt[e]:ut("Symbol."+e)),ht[e]},ft=P,mt=te,Et=Ae,_t=Me,gt=function(e,t){var i,n;if("string"===t&&xe(i=e.toString)&&!Fe(n=Ue(i,e)))return n;if(xe(i=e.valueOf)&&!Fe(n=Ue(i,e)))return n;if("string"!==t&&xe(i=e.toString)&&!Fe(n=Ue(i,e)))return n;throw Ve("Can't convert object to primitive value")},Tt=TypeError,St=pt("toPrimitive"),vt=function(e,t){if(!mt(e)||Et(e))return e;var i,n=_t(e,St);if(n){if(void 0===t&&(t="default"),i=ft(n,e,t),!mt(i)||Et(i))return i;throw Tt("Can't convert object to primitive value")}return void 0===t&&(t="number"),gt(e,t)},Rt=Ae,yt=function(e){var t=vt(e,"string");return Rt(t)?t:t+""},Ct=te,It=r.document,At=Ct(It)&&Ct(It.createElement),bt=function(e){return At?It.createElement(e):{}},wt=bt,Dt=!O&&!o((function(){return 7!=Object.defineProperty(wt("div"),"a",{get:function(){return 7}}).a})),Ot=O,Nt=P,Lt=k,Pt=B,kt=Q,Mt=yt,Ut=Ze,xt=Dt,Ft=Object.getOwnPropertyDescriptor;D.f=Ot?Ft:function(e,t){if(e=kt(e),t=Mt(t),xt)try{return Ft(e,t)}catch(e){}if(Ut(e,t))return Pt(!Nt(Lt.f,e,t),e[t])};var Vt=o,Bt=w,Gt=/#|\.prototype\./,jt=function(e,t){var i=Ht[Wt(e)];return i==Yt||i!=Kt&&(Bt(t)?Vt(t):!!t)},Wt=jt.normalize=function(e){return String(e).replace(Gt,".").toLowerCase()},Ht=jt.data={},Kt=jt.NATIVE="N",Yt=jt.POLYFILL="P",qt=jt,$t=Le,zt=a,Xt=C(C.bind),Jt=function(e,t){return $t(e),void 0===t?e:zt?Xt(e,t):function(){return e.apply(t,arguments)}},Qt={},Zt=O&&o((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),ei=te,ti=String,ii=TypeError,ni=function(e){if(ei(e))return e;throw ii(ti(e)+" is not an object")},si=O,ri=Dt,oi=Zt,ai=ni,ci=yt,di=TypeError,li=Object.defineProperty,hi=Object.getOwnPropertyDescriptor,ui="enumerable",pi="configurable",fi="writable";Qt.f=si?oi?function(e,t,i){if(ai(e),t=ci(t),ai(i),"function"==typeof e&&"prototype"===t&&"value"in i&&fi in i&&!i[fi]){var n=hi(e,t);n&&n[fi]&&(e[t]=i.value,i={configurable:pi in i?i[pi]:n[pi],enumerable:ui in i?i[ui]:n[ui],writable:!1})}return li(e,t,i)}:li:function(e,t,i){if(ai(e),t=ci(t),ai(i),ri)try{return li(e,t,i)}catch(e){}if("get"in i||"set"in i)throw di("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var mi=Qt,Ei=B,_i=O?function(e,t,i){return mi.f(e,t,Ei(1,i))}:function(e,t,i){return e[t]=i,e},gi=r,Ti=u,Si=C,vi=w,Ri=D.f,yi=qt,Ci=ie,Ii=Jt,Ai=_i,bi=Ze,wi=function(e){var t=function(i,n,s){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,n)}return new e(i,n,s)}return Ti(e,this,arguments)};return t.prototype=e.prototype,t},Di=function(e,t){var i,n,s,r,o,a,c,d,l,h=e.target,u=e.global,p=e.stat,f=e.proto,m=u?gi:p?gi[h]:(gi[h]||{}).prototype,E=u?Ci:Ci[h]||Ai(Ci,h,{})[h],_=E.prototype;for(r in t)n=!(i=yi(u?r:h+(p?".":"#")+r,e.forced))&&m&&bi(m,r),a=E[r],n&&(c=e.dontCallGetSet?(l=Ri(m,r))&&l.value:m[r]),o=n&&c?c:t[r],n&&typeof a==typeof o||(d=e.bind&&n?Ii(o,gi):e.wrap&&n?wi(o):f&&vi(o)?Si(o):o,(e.sham||o&&o.sham||a&&a.sham)&&Ai(d,"sham",!0),Ai(E,r,d),f&&(bi(Ci,s=h+"Prototype")||Ai(Ci,s,{}),Ai(Ci[s],r,o),e.real&&_&&(i||!_[r])&&Ai(_,r,o)))},Oi=_([].slice),Ni=_,Li=Le,Pi=te,ki=Ze,Mi=Oi,Ui=a,xi=Function,Fi=Ni([].concat),Vi=Ni([].join),Bi={},Gi=function(e,t,i){if(!ki(Bi,t)){for(var n=[],s=0;s<t;s++)n[s]="a["+s+"]";Bi[t]=xi("C,a","return new C("+Vi(n,",")+")")}return Bi[t](e,i)},ji=Ui?xi.bind:function(e){var t=Li(this),i=t.prototype,n=Mi(arguments,1),s=function(){var i=Fi(n,Mi(arguments));return this instanceof s?Gi(t,i.length,i):t.apply(e,i)};return Pi(i)&&(s.prototype=i),s},Wi={};Wi[pt("toStringTag")]="z";var Hi="[object z]"===String(Wi),Ki=Hi,Yi=w,qi=v,$i=pt("toStringTag"),zi=Object,Xi="Arguments"==qi(function(){return arguments}()),Ji=Ki?qi:function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=zi(e),$i))?i:Xi?qi(t):"Object"==(n=qi(t))&&Yi(t.callee)?"Arguments":n},Qi=w,Zi=Ke,en=_(Function.toString);Qi(Zi.inspectSource)||(Zi.inspectSource=function(e){return en(e)});var tn=Zi.inspectSource,nn=_,sn=o,rn=w,on=Ji,an=tn,cn=function(){},dn=[],ln=ae("Reflect","construct"),hn=/^\s*(?:class|function)\b/,un=nn(hn.exec),pn=!hn.exec(cn),fn=function(e){if(!rn(e))return!1;try{return ln(cn,dn,e),!0}catch(e){return!1}},mn=function(e){if(!rn(e))return!1;switch(on(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return pn||!!un(hn,an(e))}catch(e){return!0}};mn.sham=!0;var En=!ln||sn((function(){var e;return fn(fn.call)||!fn(Object)||!fn((function(){e=!0}))||e}))?mn:fn,_n=En,gn=we,Tn=TypeError,Sn=function(e){if(_n(e))return e;throw Tn(gn(e)+" is not a constructor")},vn={},Rn=Math.ceil,yn=Math.floor,Cn=Math.trunc||function(e){var t=+e;return(t>0?yn:Rn)(t)},In=Cn,An=function(e){var t=+e;return t!=t||0===t?0:In(t)},bn=An,wn=Math.max,Dn=Math.min,On=function(e,t){var i=bn(e);return i<0?wn(i+t,0):Dn(i,t)},Nn=An,Ln=Math.min,Pn=function(e){return e>0?Ln(Nn(e),9007199254740991):0},kn=function(e){return Pn(e.length)},Mn=Q,Un=On,xn=kn,Fn=function(e){return function(t,i,n){var s,r=Mn(t),o=xn(r),a=Un(n,o);if(e&&i!=i){for(;o>a;)if((s=r[a++])!=s)return!0}else for(;o>a;a++)if((e||a in r)&&r[a]===i)return e||a||0;return!e&&-1}},Vn={includes:Fn(!0),indexOf:Fn(!1)},Bn={},Gn=Ze,jn=Q,Wn=Vn.indexOf,Hn=Bn,Kn=_([].push),Yn=function(e,t){var i,n=jn(e),s=0,r=[];for(i in n)!Gn(Hn,i)&&Gn(n,i)&&Kn(r,i);for(;t.length>s;)Gn(n,i=t[s++])&&(~Wn(r,i)||Kn(r,i));return r},qn=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],$n=Yn,zn=qn,Xn=Object.keys||function(e){return $n(e,zn)},Jn=O,Qn=Zt,Zn=Qt,es=ni,ts=Q,is=Xn;vn.f=Jn&&!Qn?Object.defineProperties:function(e,t){es(e);for(var i,n=ts(t),s=is(t),r=s.length,o=0;r>o;)Zn.f(e,i=s[o++],n[i]);return e};var ns,ss=ae("document","documentElement"),rs=st,os=qe("keys"),as=function(e){return os[e]||(os[e]=rs(e))},cs=ni,ds=vn,ls=qn,hs=Bn,us=ss,ps=bt,fs="prototype",ms="script",Es=as("IE_PROTO"),_s=function(){},gs=function(e){return"<"+ms+">"+e+"</"+ms+">"},Ts=function(e){e.write(gs("")),e.close();var t=e.parentWindow.Object;return e=null,t},Ss=function(){try{ns=new ActiveXObject("htmlfile")}catch(e){}var e,t,i;Ss="undefined"!=typeof document?document.domain&&ns?Ts(ns):(t=ps("iframe"),i="java"+ms+":",t.style.display="none",us.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(gs("document.F=Object")),e.close(),e.F):Ts(ns);for(var n=ls.length;n--;)delete Ss[fs][ls[n]];return Ss()};hs[Es]=!0;var vs=Object.create||function(e,t){var i;return null!==e?(_s[fs]=cs(e),i=new _s,_s[fs]=null,i[Es]=e):i=Ss(),void 0===t?i:ds.f(i,t)},Rs=Di,ys=u,Cs=ji,Is=Sn,As=ni,bs=te,ws=vs,Ds=o,Os=ae("Reflect","construct"),Ns=Object.prototype,Ls=[].push,Ps=Ds((function(){function e(){}return!(Os((function(){}),[],e)instanceof e)})),ks=!Ds((function(){Os((function(){}))})),Ms=Ps||ks;Rs({target:"Reflect",stat:!0,forced:Ms,sham:Ms},{construct:function(e,t){Is(e),As(t);var i=arguments.length<3?e:Is(arguments[2]);if(ks&&!Ps)return Os(e,t,i);if(e==i){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var n=[null];return ys(Ls,n,t),new(ys(Cs,e,n))}var s=i.prototype,r=ws(bs(s)?s:Ns),o=ys(e,r,t);return bs(o)?o:r}});var Us=n(ie.Reflect.construct),xs=!o((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Fs=Ze,Vs=w,Bs=Xe,Gs=xs,js=as("IE_PROTO"),Ws=Object,Hs=Ws.prototype,Ks=Gs?Ws.getPrototypeOf:function(e){var t=Bs(e);if(Fs(t,js))return t[js];var i=t.constructor;return Vs(i)&&t instanceof i?i.prototype:t instanceof Ws?Hs:null},Ys=_,qs=Le,$s=w,zs=String,Xs=TypeError,Js=function(e,t,i){try{return Ys(qs(Object.getOwnPropertyDescriptor(e,t)[i]))}catch(e){}},Qs=ni,Zs=function(e){if("object"==typeof e||$s(e))return e;throw Xs("Can't set "+zs(e)+" as a prototype")},er=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=Js(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch(e){}return function(i,n){return Qs(i),Zs(n),t?e(i,n):i.__proto__=n,i}}():void 0),tr={},ir=Yn,nr=qn.concat("length","prototype");tr.f=Object.getOwnPropertyNames||function(e){return ir(e,nr)};var sr={};sr.f=Object.getOwnPropertySymbols;var rr=ae,or=tr,ar=sr,cr=ni,dr=_([].concat),lr=rr("Reflect","ownKeys")||function(e){var t=or.f(cr(e)),i=ar.f;return i?dr(t,i(e)):t},hr=Ze,ur=lr,pr=D,fr=Qt,mr=te,Er=_i,_r=Error,gr=_("".replace),Tr=String(_r("zxcasd").stack),Sr=/\n\s*at [^:]*:[^\n]*/,vr=Sr.test(Tr),Rr=B,yr=!o((function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",Rr(1,7)),7!==e.stack)})),Cr=_i,Ir=function(e,t){if(vr&&"string"==typeof e&&!_r.prepareStackTrace)for(;t--;)e=gr(e,Sr,"");return e},Ar=yr,br=Error.captureStackTrace,wr={},Dr=wr,Or=pt("iterator"),Nr=Array.prototype,Lr=function(e){return void 0!==e&&(Dr.Array===e||Nr[Or]===e)},Pr=Ji,kr=Me,Mr=Y,Ur=wr,xr=pt("iterator"),Fr=function(e){if(!Mr(e))return kr(e,xr)||kr(e,"@@iterator")||Ur[Pr(e)]},Vr=P,Br=Le,Gr=ni,jr=we,Wr=Fr,Hr=TypeError,Kr=function(e,t){var i=arguments.length<2?Wr(e):t;if(Br(i))return Gr(Vr(i,e));throw Hr(jr(e)+" is not iterable")},Yr=P,qr=ni,$r=Me,zr=function(e,t,i){var n,s;qr(e);try{if(!(n=$r(e,"return"))){if("throw"===t)throw i;return i}n=Yr(n,e)}catch(e){s=!0,n=e}if("throw"===t)throw i;if(s)throw n;return qr(n),i},Xr=Jt,Jr=P,Qr=ni,Zr=we,eo=Lr,to=kn,io=ce,no=Kr,so=Fr,ro=zr,oo=TypeError,ao=function(e,t){this.stopped=e,this.result=t},co=ao.prototype,lo=function(e,t,i){var n,s,r,o,a,c,d,l=i&&i.that,h=!(!i||!i.AS_ENTRIES),u=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),f=!(!i||!i.INTERRUPTED),m=Xr(t,l),E=function(e){return n&&ro(n,"normal",e),new ao(!0,e)},_=function(e){return h?(Qr(e),f?m(e[0],e[1],E):m(e[0],e[1])):f?m(e,E):m(e)};if(u)n=e.iterator;else if(p)n=e;else{if(!(s=so(e)))throw oo(Zr(e)+" is not iterable");if(eo(s)){for(r=0,o=to(e);o>r;r++)if((a=_(e[r]))&&io(co,a))return a;return new ao(!1)}n=no(e,s)}for(c=u?e.next:n.next;!(d=Jr(c,n)).done;){try{a=_(d.value)}catch(e){ro(n,"throw",e)}if("object"==typeof a&&a&&io(co,a))return a}return new ao(!1)},ho=Ji,uo=String,po=function(e){if("Symbol"===ho(e))throw TypeError("Cannot convert a Symbol value to a string");return uo(e)},fo=po,mo=Di,Eo=ce,_o=Ks,go=er,To=function(e,t,i){for(var n=ur(t),s=fr.f,r=pr.f,o=0;o<n.length;o++){var a=n[o];hr(e,a)||i&&hr(i,a)||s(e,a,r(t,a))}},So=vs,vo=_i,Ro=B,yo=function(e,t){mr(t)&&"cause"in t&&Er(e,"cause",t.cause)},Co=function(e,t,i,n){Ar&&(br?br(e,t):Cr(e,"stack",Ir(i,n)))},Io=lo,Ao=function(e,t){return void 0===e?arguments.length<2?"":t:fo(e)},bo=pt("toStringTag"),wo=Error,Do=[].push,Oo=function(e,t){var i,n=Eo(No,this);go?i=go(wo(),n?_o(this):No):(i=n?this:So(No),vo(i,bo,"Error")),void 0!==t&&vo(i,"message",Ao(t)),Co(i,Oo,i.stack,1),arguments.length>2&&yo(i,arguments[2]);var s=[];return Io(e,Do,{that:s}),vo(i,"errors",s),i};go?go(Oo,wo):To(Oo,wo,{name:!0});var No=Oo.prototype=So(wo.prototype,{constructor:Ro(1,Oo),message:Ro(1,""),name:Ro(1,"AggregateError")});mo({global:!0,constructor:!0,arity:2},{AggregateError:Oo});var Lo,Po,ko,Mo=w,Uo=r.WeakMap,xo=Mo(Uo)&&/native code/.test(String(Uo)),Fo=r,Vo=te,Bo=_i,Go=Ze,jo=Ke,Wo=as,Ho=Bn,Ko="Object already initialized",Yo=Fo.TypeError,qo=Fo.WeakMap;if(xo||jo.state){var $o=jo.state||(jo.state=new qo);$o.get=$o.get,$o.has=$o.has,$o.set=$o.set,Lo=function(e,t){if($o.has(e))throw Yo(Ko);return t.facade=e,$o.set(e,t),t},Po=function(e){return $o.get(e)||{}},ko=function(e){return $o.has(e)}}else{var zo=Wo("state");Ho[zo]=!0,Lo=function(e,t){if(Go(e,zo))throw Yo(Ko);return t.facade=e,Bo(e,zo,t),t},Po=function(e){return Go(e,zo)?e[zo]:{}},ko=function(e){return Go(e,zo)}}var Xo,Jo,Qo,Zo={set:Lo,get:Po,has:ko,enforce:function(e){return ko(e)?Po(e):Lo(e,{})},getterFor:function(e){return function(t){var i;if(!Vo(t)||(i=Po(t)).type!==e)throw Yo("Incompatible receiver, "+e+" required");return i}}},ea=O,ta=Ze,ia=Function.prototype,na=ea&&Object.getOwnPropertyDescriptor,sa=ta(ia,"name"),ra={EXISTS:sa,PROPER:sa&&"something"===function(){}.name,CONFIGURABLE:sa&&(!ea||ea&&na(ia,"name").configurable)},oa=_i,aa=function(e,t,i,n){return n&&n.enumerable?e[t]=i:oa(e,t,i),e},ca=o,da=w,la=te,ha=vs,ua=Ks,pa=aa,fa=pt("iterator"),ma=!1;[].keys&&("next"in(Qo=[].keys())?(Jo=ua(ua(Qo)))!==Object.prototype&&(Xo=Jo):ma=!0);var Ea=!la(Xo)||ca((function(){var e={};return Xo[fa].call(e)!==e}));da((Xo=Ea?{}:ha(Xo))[fa])||pa(Xo,fa,(function(){return this}));var _a={IteratorPrototype:Xo,BUGGY_SAFARI_ITERATORS:ma},ga=Ji,Ta=Hi?{}.toString:function(){return"[object "+ga(this)+"]"},Sa=Hi,va=Qt.f,Ra=_i,ya=Ze,Ca=Ta,Ia=pt("toStringTag"),Aa=function(e,t,i,n){if(e){var s=i?e:e.prototype;ya(s,Ia)||va(s,Ia,{configurable:!0,value:t}),n&&!Sa&&Ra(s,"toString",Ca)}},ba=_a.IteratorPrototype,wa=vs,Da=B,Oa=Aa,Na=wr,La=function(){return this},Pa=Di,ka=P,Ma=ra,Ua=function(e,t,i,n){var s=t+" Iterator";return e.prototype=wa(ba,{next:Da(+!n,i)}),Oa(e,s,!1,!0),Na[s]=La,e},xa=Ks,Fa=Aa,Va=aa,Ba=wr,Ga=_a,ja=Ma.PROPER,Wa=Ga.BUGGY_SAFARI_ITERATORS,Ha=pt("iterator"),Ka="keys",Ya="values",qa="entries",$a=function(){return this},za=function(e,t,i,n,s,r,o){Ua(i,t,n);var a,c,d,l=function(e){if(e===s&&m)return m;if(!Wa&&e in p)return p[e];switch(e){case Ka:case Ya:case qa:return function(){return new i(this,e)}}return function(){return new i(this)}},h=t+" Iterator",u=!1,p=e.prototype,f=p[Ha]||p["@@iterator"]||s&&p[s],m=!Wa&&f||l(s),E="Array"==t&&p.entries||f;if(E&&(a=xa(E.call(new e)))!==Object.prototype&&a.next&&(Fa(a,h,!0,!0),Ba[h]=$a),ja&&s==Ya&&f&&f.name!==Ya&&(u=!0,m=function(){return ka(f,this)}),s)if(c={values:l(Ya),keys:r?m:l(Ka),entries:l(qa)},o)for(d in c)(Wa||u||!(d in p))&&Va(p,d,c[d]);else Pa({target:t,proto:!0,forced:Wa||u},c);return o&&p[Ha]!==m&&Va(p,Ha,m,{name:s}),Ba[t]=m,c},Xa=function(e,t){return{value:e,done:t}},Ja=Q,Qa=wr,Za=Zo;Qt.f;var ec=za,tc=Xa,ic="Array Iterator",nc=Za.set,sc=Za.getterFor(ic);ec(Array,"Array",(function(e,t){nc(this,{type:ic,target:Ja(e),index:0,kind:t})}),(function(){var e=sc(this),t=e.target,i=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,tc(void 0,!0)):tc("keys"==i?n:"values"==i?t[n]:[n,t[n]],!1)}),"values"),Qa.Arguments=Qa.Array;var rc,oc,ac,cc,dc="undefined"!=typeof process&&"process"==v(process),lc=Qt,hc=function(e,t,i){return lc.f(e,t,i)},uc=ae,pc=hc,fc=O,mc=pt("species"),Ec=function(e){var t=uc(e);fc&&t&&!t[mc]&&pc(t,mc,{configurable:!0,get:function(){return this}})},_c=ce,gc=TypeError,Tc=function(e,t){if(_c(t,e))return e;throw gc("Incorrect invocation")},Sc=ni,vc=Sn,Rc=Y,yc=pt("species"),Cc=function(e,t){var i,n=Sc(e).constructor;return void 0===n||Rc(i=Sc(n)[yc])?t:vc(i)},Ic=TypeError,Ac=/(?:ipad|iphone|ipod).*applewebkit/i.test(de),bc=r,wc=u,Dc=Jt,Oc=w,Nc=Ze,Lc=o,Pc=ss,kc=Oi,Mc=bt,Uc=function(e,t){if(e<t)throw Ic("Not enough arguments");return e},xc=Ac,Fc=dc,Vc=bc.setImmediate,Bc=bc.clearImmediate,Gc=bc.process,jc=bc.Dispatch,Wc=bc.Function,Hc=bc.MessageChannel,Kc=bc.String,Yc=0,qc={},$c="onreadystatechange";Lc((function(){rc=bc.location}));var zc=function(e){if(Nc(qc,e)){var t=qc[e];delete qc[e],t()}},Xc=function(e){return function(){zc(e)}},Jc=function(e){zc(e.data)},Qc=function(e){bc.postMessage(Kc(e),rc.protocol+"//"+rc.host)};Vc&&Bc||(Vc=function(e){Uc(arguments.length,1);var t=Oc(e)?e:Wc(e),i=kc(arguments,1);return qc[++Yc]=function(){wc(t,void 0,i)},oc(Yc),Yc},Bc=function(e){delete qc[e]},Fc?oc=function(e){Gc.nextTick(Xc(e))}:jc&&jc.now?oc=function(e){jc.now(Xc(e))}:Hc&&!xc?(cc=(ac=new Hc).port2,ac.port1.onmessage=Jc,oc=Dc(cc.postMessage,cc)):bc.addEventListener&&Oc(bc.postMessage)&&!bc.importScripts&&rc&&"file:"!==rc.protocol&&!Lc(Qc)?(oc=Qc,bc.addEventListener("message",Jc,!1)):oc=$c in Mc("script")?function(e){Pc.appendChild(Mc("script"))[$c]=function(){Pc.removeChild(this),zc(e)}}:function(e){setTimeout(Xc(e),0)});var Zc={set:Vc,clear:Bc},ed=function(){this.head=null,this.tail=null};ed.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var td,id,nd,sd,rd,od=ed,ad=/ipad|iphone|ipod/i.test(de)&&"undefined"!=typeof Pebble,cd=/web0s(?!.*chrome)/i.test(de),dd=r,ld=Jt,hd=D.f,ud=Zc.set,pd=od,fd=Ac,md=ad,Ed=cd,_d=dc,gd=dd.MutationObserver||dd.WebKitMutationObserver,Td=dd.document,Sd=dd.process,vd=dd.Promise,Rd=hd(dd,"queueMicrotask"),yd=Rd&&Rd.value;if(!yd){var Cd=new pd,Id=function(){var e,t;for(_d&&(e=Sd.domain)&&e.exit();t=Cd.get();)try{t()}catch(e){throw Cd.head&&td(),e}e&&e.enter()};fd||_d||Ed||!gd||!Td?!md&&vd&&vd.resolve?((sd=vd.resolve(void 0)).constructor=vd,rd=ld(sd.then,sd),td=function(){rd(Id)}):_d?td=function(){Sd.nextTick(Id)}:(ud=ld(ud,dd),td=function(){ud(Id)}):(id=!0,nd=Td.createTextNode(""),new gd(Id).observe(nd,{characterData:!0}),td=function(){nd.data=id=!id}),yd=function(e){Cd.head||td(),Cd.add(e)}}var Ad=yd,bd=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},wd=r.Promise,Dd="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,Od=!Dd&&!dc&&"object"==typeof window&&"object"==typeof document,Nd=r,Ld=wd,Pd=w,kd=qt,Md=tn,Ud=pt,xd=Od,Fd=Dd,Vd=Ee,Bd=Ld&&Ld.prototype,Gd=Ud("species"),jd=!1,Wd=Pd(Nd.PromiseRejectionEvent),Hd=kd("Promise",(function(){var e=Md(Ld),t=e!==String(Ld);if(!t&&66===Vd)return!0;if(!Bd.catch||!Bd.finally)return!0;if(!Vd||Vd<51||!/native code/.test(e)){var i=new Ld((function(e){e(1)})),n=function(e){e((function(){}),(function(){}))};if((i.constructor={})[Gd]=n,!(jd=i.then((function(){}))instanceof n))return!0}return!t&&(xd||Fd)&&!Wd})),Kd={CONSTRUCTOR:Hd,REJECTION_EVENT:Wd,SUBCLASSING:jd},Yd={},qd=Le,$d=TypeError,zd=function(e){var t,i;this.promise=new e((function(e,n){if(void 0!==t||void 0!==i)throw $d("Bad Promise constructor");t=e,i=n})),this.resolve=qd(t),this.reject=qd(i)};Yd.f=function(e){return new zd(e)};var Xd,Jd,Qd=Di,Zd=dc,el=r,tl=P,il=aa,nl=Aa,sl=Ec,rl=Le,ol=w,al=te,cl=Tc,dl=Cc,ll=Zc.set,hl=Ad,ul=function(e,t){try{1==arguments.length?console.error(e):console.error(e,t)}catch(e){}},pl=bd,fl=od,ml=Zo,El=wd,_l=Kd,gl=Yd,Tl="Promise",Sl=_l.CONSTRUCTOR,vl=_l.REJECTION_EVENT,Rl=ml.getterFor(Tl),yl=ml.set,Cl=El&&El.prototype,Il=El,Al=Cl,bl=el.TypeError,wl=el.document,Dl=el.process,Ol=gl.f,Nl=Ol,Ll=!!(wl&&wl.createEvent&&el.dispatchEvent),Pl="unhandledrejection",kl=function(e){var t;return!(!al(e)||!ol(t=e.then))&&t},Ml=function(e,t){var i,n,s,r=t.value,o=1==t.state,a=o?e.ok:e.fail,c=e.resolve,d=e.reject,l=e.domain;try{a?(o||(2===t.rejection&&Bl(t),t.rejection=1),!0===a?i=r:(l&&l.enter(),i=a(r),l&&(l.exit(),s=!0)),i===e.promise?d(bl("Promise-chain cycle")):(n=kl(i))?tl(n,i,c,d):c(i)):d(r)}catch(e){l&&!s&&l.exit(),d(e)}},Ul=function(e,t){e.notified||(e.notified=!0,hl((function(){for(var i,n=e.reactions;i=n.get();)Ml(i,e);e.notified=!1,t&&!e.rejection&&Fl(e)})))},xl=function(e,t,i){var n,s;Ll?((n=wl.createEvent("Event")).promise=t,n.reason=i,n.initEvent(e,!1,!0),el.dispatchEvent(n)):n={promise:t,reason:i},!vl&&(s=el["on"+e])?s(n):e===Pl&&ul("Unhandled promise rejection",i)},Fl=function(e){tl(ll,el,(function(){var t,i=e.facade,n=e.value;if(Vl(e)&&(t=pl((function(){Zd?Dl.emit("unhandledRejection",n,i):xl(Pl,i,n)})),e.rejection=Zd||Vl(e)?2:1,t.error))throw t.value}))},Vl=function(e){return 1!==e.rejection&&!e.parent},Bl=function(e){tl(ll,el,(function(){var t=e.facade;Zd?Dl.emit("rejectionHandled",t):xl("rejectionhandled",t,e.value)}))},Gl=function(e,t,i){return function(n){e(t,n,i)}},jl=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,Ul(e,!0))},Wl=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw bl("Promise can't be resolved itself");var n=kl(t);n?hl((function(){var i={done:!1};try{tl(n,t,Gl(Wl,i,e),Gl(jl,i,e))}catch(t){jl(i,t,e)}})):(e.value=t,e.state=1,Ul(e,!1))}catch(t){jl({done:!1},t,e)}}};Sl&&(Al=(Il=function(e){cl(this,Al),rl(e),tl(Xd,this);var t=Rl(this);try{e(Gl(Wl,t),Gl(jl,t))}catch(e){jl(t,e)}}).prototype,(Xd=function(e){yl(this,{type:Tl,done:!1,notified:!1,parent:!1,reactions:new fl,rejection:!1,state:0,value:void 0})}).prototype=il(Al,"then",(function(e,t){var i=Rl(this),n=Ol(dl(this,Il));return i.parent=!0,n.ok=!ol(e)||e,n.fail=ol(t)&&t,n.domain=Zd?Dl.domain:void 0,0==i.state?i.reactions.add(n):hl((function(){Ml(n,i)})),n.promise})),Jd=function(){var e=new Xd,t=Rl(e);this.promise=e,this.resolve=Gl(Wl,t),this.reject=Gl(jl,t)},gl.f=Ol=function(e){return e===Il||undefined===e?new Jd(e):Nl(e)}),Qd({global:!0,constructor:!0,wrap:!0,forced:Sl},{Promise:Il}),nl(Il,Tl,!1,!0),sl(Tl);var Hl=pt("iterator"),Kl=!1;try{var Yl=0,ql={next:function(){return{done:!!Yl++}},return:function(){Kl=!0}};ql[Hl]=function(){return this},Array.from(ql,(function(){throw 2}))}catch(e){}var $l=function(e,t){if(!t&&!Kl)return!1;var i=!1;try{var n={};n[Hl]=function(){return{next:function(){return{done:i=!0}}}},e(n)}catch(e){}return i},zl=wd,Xl=Kd.CONSTRUCTOR||!$l((function(e){zl.all(e).then(void 0,(function(){}))})),Jl=P,Ql=Le,Zl=Yd,eh=bd,th=lo;Di({target:"Promise",stat:!0,forced:Xl},{all:function(e){var t=this,i=Zl.f(t),n=i.resolve,s=i.reject,r=eh((function(){var i=Ql(t.resolve),r=[],o=0,a=1;th(e,(function(e){var c=o++,d=!1;a++,Jl(i,t,e).then((function(e){d||(d=!0,r[c]=e,--a||n(r))}),s)})),--a||n(r)}));return r.error&&s(r.value),i.promise}});var ih=Di,nh=Kd.CONSTRUCTOR;wd&&wd.prototype,ih({target:"Promise",proto:!0,forced:nh,real:!0},{catch:function(e){return this.then(void 0,e)}});var sh=P,rh=Le,oh=Yd,ah=bd,ch=lo;Di({target:"Promise",stat:!0,forced:Xl},{race:function(e){var t=this,i=oh.f(t),n=i.reject,s=ah((function(){var s=rh(t.resolve);ch(e,(function(e){sh(s,t,e).then(i.resolve,n)}))}));return s.error&&n(s.value),i.promise}});var dh=P,lh=Yd;Di({target:"Promise",stat:!0,forced:Kd.CONSTRUCTOR},{reject:function(e){var t=lh.f(this);return dh(t.reject,void 0,e),t.promise}});var hh=ni,uh=te,ph=Yd,fh=function(e,t){if(hh(e),uh(t)&&t.constructor===e)return t;var i=ph.f(e);return(0,i.resolve)(t),i.promise},mh=Di,Eh=wd,_h=Kd.CONSTRUCTOR,gh=fh,Th=ae("Promise"),Sh=!_h;mh({target:"Promise",stat:!0,forced:true},{resolve:function(e){return gh(Sh&&this===Th?Eh:this,e)}});var vh=P,Rh=Le,yh=Yd,Ch=bd,Ih=lo;Di({target:"Promise",stat:!0,forced:Xl},{allSettled:function(e){var t=this,i=yh.f(t),n=i.resolve,s=i.reject,r=Ch((function(){var i=Rh(t.resolve),s=[],r=0,o=1;Ih(e,(function(e){var a=r++,c=!1;o++,vh(i,t,e).then((function(e){c||(c=!0,s[a]={status:"fulfilled",value:e},--o||n(s))}),(function(e){c||(c=!0,s[a]={status:"rejected",reason:e},--o||n(s))}))})),--o||n(s)}));return r.error&&s(r.value),i.promise}});var Ah=P,bh=Le,wh=ae,Dh=Yd,Oh=bd,Nh=lo,Lh="No one promise resolved";Di({target:"Promise",stat:!0,forced:Xl},{any:function(e){var t=this,i=wh("AggregateError"),n=Dh.f(t),s=n.resolve,r=n.reject,o=Oh((function(){var n=bh(t.resolve),o=[],a=0,c=1,d=!1;Nh(e,(function(e){var l=a++,h=!1;c++,Ah(n,t,e).then((function(e){h||d||(d=!0,s(e))}),(function(e){h||d||(h=!0,o[l]=e,--c||r(new i(o,Lh)))}))})),--c||r(new i(o,Lh))}));return o.error&&r(o.value),n.promise}});var Ph=Di,kh=wd,Mh=o,Uh=ae,xh=w,Fh=Cc,Vh=fh,Bh=kh&&kh.prototype;Ph({target:"Promise",proto:!0,real:!0,forced:!!kh&&Mh((function(){Bh.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=Fh(this,Uh("Promise")),i=xh(e);return this.then(i?function(i){return Vh(t,e()).then((function(){return i}))}:e,i?function(i){return Vh(t,e()).then((function(){throw i}))}:e)}});var Gh=_,jh=An,Wh=po,Hh=z,Kh=Gh("".charAt),Yh=Gh("".charCodeAt),qh=Gh("".slice),$h=function(e){return function(t,i){var n,s,r=Wh(Hh(t)),o=jh(i),a=r.length;return o<0||o>=a?e?"":void 0:(n=Yh(r,o))<55296||n>56319||o+1===a||(s=Yh(r,o+1))<56320||s>57343?e?Kh(r,o):n:e?qh(r,o,o+2):s-56320+(n-55296<<10)+65536}},zh={codeAt:$h(!1),charAt:$h(!0)}.charAt,Xh=po,Jh=Zo,Qh=za,Zh=Xa,eu="String Iterator",tu=Jh.set,iu=Jh.getterFor(eu);Qh(String,"String",(function(e){tu(this,{type:eu,string:Xh(e),index:0})}),(function(){var e,t=iu(this),i=t.string,n=t.index;return n>=i.length?Zh(void 0,!0):(e=zh(i,n),t.index+=e.length,Zh(e,!1))}));var nu=ie.Promise,su={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},ru=r,ou=Ji,au=_i,cu=wr,du=pt("toStringTag");for(var lu in su){var hu=ru[lu],uu=hu&&hu.prototype;uu&&ou(uu)!==du&&au(uu,du,lu),cu[lu]=cu.Array}var pu=nu,fu=pu,mu=Yd;Di({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var e=mu.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var Eu=Yd,_u=bd;Di({target:"Promise",stat:!0,forced:!0},{try:function(e){var t=Eu.f(this),i=_u(e);return(i.error?t.reject:t.resolve)(i.value),t.promise}});var gu=fu,Tu=n(gu);function Su(e,t,i,n,s,r,o){try{var a=e[r](o),c=a.value}catch(e){return void i(e)}a.done?t(c):Tu.resolve(c).then(n,s)}function vu(e){return function(){var t=this,i=arguments;return new Tu((function(n,s){var r=e.apply(t,i);function o(e){Su(r,n,s,o,a,"next",e)}function a(e){Su(r,n,s,o,a,"throw",e)}o(void 0)}))}}function Ru(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var yu={exports:{}},Cu=Di,Iu=O,Au=Qt.f;Cu({target:"Object",stat:!0,forced:Object.defineProperty!==Au,sham:!Iu},{defineProperty:Au});var bu=ie.Object,wu=yu.exports=function(e,t,i){return bu.defineProperty(e,t,i)};bu.defineProperty.sham&&(wu.sham=!0);var Du=yu.exports,Ou=n(Du),Nu=v,Lu=Array.isArray||function(e){return"Array"==Nu(e)},Pu=TypeError,ku=function(e){if(e>9007199254740991)throw Pu("Maximum allowed index exceeded");return e},Mu=yt,Uu=Qt,xu=B,Fu=function(e,t,i){var n=Mu(t);n in e?Uu.f(e,n,xu(0,i)):e[n]=i},Vu=Lu,Bu=En,Gu=te,ju=pt("species"),Wu=Array,Hu=function(e){var t;return Vu(e)&&(t=e.constructor,(Bu(t)&&(t===Wu||Vu(t.prototype))||Gu(t)&&null===(t=t[ju]))&&(t=void 0)),void 0===t?Wu:t},Ku=function(e,t){return new(Hu(e))(0===t?0:t)},Yu=o,qu=Ee,$u=pt("species"),zu=function(e){return qu>=51||!Yu((function(){var t=[];return(t.constructor={})[$u]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Xu=Di,Ju=o,Qu=Lu,Zu=te,ep=Xe,tp=kn,ip=ku,np=Fu,sp=Ku,rp=zu,op=Ee,ap=pt("isConcatSpreadable"),cp=op>=51||!Ju((function(){var e=[];return e[ap]=!1,e.concat()[0]!==e})),dp=function(e){if(!Zu(e))return!1;var t=e[ap];return void 0!==t?!!t:Qu(e)};Xu({target:"Array",proto:!0,arity:1,forced:!cp||!rp("concat")},{concat:function(e){var t,i,n,s,r,o=ep(this),a=sp(o,0),c=0;for(t=-1,n=arguments.length;t<n;t++)if(dp(r=-1===t?o:arguments[t]))for(s=tp(r),ip(c+s),i=0;i<s;i++,c++)i in r&&np(a,c,r[i]);else ip(c+1),np(a,c++,r);return a.length=c,a}});var lp={},hp=On,up=kn,pp=Fu,fp=Array,mp=Math.max,Ep=v,_p=Q,gp=tr.f,Tp=function(e,t,i){for(var n=up(e),s=hp(t,n),r=hp(void 0===i?n:i,n),o=fp(mp(r-s,0)),a=0;s<r;s++,a++)pp(o,a,e[s]);return o.length=a,o},Sp="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];lp.f=function(e){return Sp&&"Window"==Ep(e)?function(e){try{return gp(e)}catch(e){return Tp(Sp)}}(e):gp(_p(e))};var vp={},Rp=pt;vp.f=Rp;var yp=ie,Cp=Ze,Ip=vp,Ap=Qt.f,bp=function(e){var t=yp.Symbol||(yp.Symbol={});Cp(t,e)||Ap(t,e,{value:Ip.f(e)})},wp=P,Dp=ae,Op=pt,Np=aa,Lp=function(){var e=Dp("Symbol"),t=e&&e.prototype,i=t&&t.valueOf,n=Op("toPrimitive");t&&!t[n]&&Np(t,n,(function(e){return wp(i,this)}),{arity:1})},Pp=Jt,kp=K,Mp=Xe,Up=kn,xp=Ku,Fp=_([].push),Vp=function(e){var t=1==e,i=2==e,n=3==e,s=4==e,r=6==e,o=7==e,a=5==e||r;return function(c,d,l,h){for(var u,p,f=Mp(c),m=kp(f),E=Pp(d,l),_=Up(m),g=0,T=h||xp,S=t?T(c,_):i||o?T(c,0):void 0;_>g;g++)if((a||g in m)&&(p=E(u=m[g],g,f),e))if(t)S[g]=p;else if(p)switch(e){case 3:return!0;case 5:return u;case 6:return g;case 2:Fp(S,u)}else switch(e){case 4:return!1;case 7:Fp(S,u)}return r?-1:n||s?s:S}},Bp={forEach:Vp(0),map:Vp(1),filter:Vp(2),some:Vp(3),every:Vp(4),find:Vp(5),findIndex:Vp(6),filterReject:Vp(7)},Gp=Di,jp=r,Wp=P,Hp=_,Kp=O,Yp=Se,qp=o,$p=Ze,zp=ce,Xp=ni,Jp=Q,Qp=yt,Zp=po,ef=B,tf=vs,nf=Xn,sf=tr,rf=lp,of=sr,af=D,cf=Qt,df=vn,lf=k,hf=aa,uf=hc,pf=qe,ff=Bn,mf=st,Ef=pt,_f=vp,gf=bp,Tf=Lp,Sf=Aa,vf=Zo,Rf=Bp.forEach,yf=as("hidden"),Cf="Symbol",If="prototype",Af=vf.set,bf=vf.getterFor(Cf),wf=Object[If],Df=jp.Symbol,Of=Df&&Df[If],Nf=jp.TypeError,Lf=jp.QObject,Pf=af.f,kf=cf.f,Mf=rf.f,Uf=lf.f,xf=Hp([].push),Ff=pf("symbols"),Vf=pf("op-symbols"),Bf=pf("wks"),Gf=!Lf||!Lf[If]||!Lf[If].findChild,jf=Kp&&qp((function(){return 7!=tf(kf({},"a",{get:function(){return kf(this,"a",{value:7}).a}})).a}))?function(e,t,i){var n=Pf(wf,t);n&&delete wf[t],kf(e,t,i),n&&e!==wf&&kf(wf,t,n)}:kf,Wf=function(e,t){var i=Ff[e]=tf(Of);return Af(i,{type:Cf,tag:e,description:t}),Kp||(i.description=t),i},Hf=function(e,t,i){e===wf&&Hf(Vf,t,i),Xp(e);var n=Qp(t);return Xp(i),$p(Ff,n)?(i.enumerable?($p(e,yf)&&e[yf][n]&&(e[yf][n]=!1),i=tf(i,{enumerable:ef(0,!1)})):($p(e,yf)||kf(e,yf,ef(1,{})),e[yf][n]=!0),jf(e,n,i)):kf(e,n,i)},Kf=function(e,t){Xp(e);var i=Jp(t),n=nf(i).concat(zf(i));return Rf(n,(function(t){Kp&&!Wp(Yf,i,t)||Hf(e,t,i[t])})),e},Yf=function(e){var t=Qp(e),i=Wp(Uf,this,t);return!(this===wf&&$p(Ff,t)&&!$p(Vf,t))&&(!(i||!$p(this,t)||!$p(Ff,t)||$p(this,yf)&&this[yf][t])||i)},qf=function(e,t){var i=Jp(e),n=Qp(t);if(i!==wf||!$p(Ff,n)||$p(Vf,n)){var s=Pf(i,n);return!s||!$p(Ff,n)||$p(i,yf)&&i[yf][n]||(s.enumerable=!0),s}},$f=function(e){var t=Mf(Jp(e)),i=[];return Rf(t,(function(e){$p(Ff,e)||$p(ff,e)||xf(i,e)})),i},zf=function(e){var t=e===wf,i=Mf(t?Vf:Jp(e)),n=[];return Rf(i,(function(e){!$p(Ff,e)||t&&!$p(wf,e)||xf(n,Ff[e])})),n};Yp||(Df=function(){if(zp(Of,this))throw Nf("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?Zp(arguments[0]):void 0,t=mf(e),i=function(e){this===wf&&Wp(i,Vf,e),$p(this,yf)&&$p(this[yf],t)&&(this[yf][t]=!1),jf(this,t,ef(1,e))};return Kp&&Gf&&jf(wf,t,{configurable:!0,set:i}),Wf(t,e)},hf(Of=Df[If],"toString",(function(){return bf(this).tag})),hf(Df,"withoutSetter",(function(e){return Wf(mf(e),e)})),lf.f=Yf,cf.f=Hf,df.f=Kf,af.f=qf,sf.f=rf.f=$f,of.f=zf,_f.f=function(e){return Wf(Ef(e),e)},Kp&&uf(Of,"description",{configurable:!0,get:function(){return bf(this).description}})),Gp({global:!0,constructor:!0,wrap:!0,forced:!Yp,sham:!Yp},{Symbol:Df}),Rf(nf(Bf),(function(e){gf(e)})),Gp({target:Cf,stat:!0,forced:!Yp},{useSetter:function(){Gf=!0},useSimple:function(){Gf=!1}}),Gp({target:"Object",stat:!0,forced:!Yp,sham:!Kp},{create:function(e,t){return void 0===t?tf(e):Kf(tf(e),t)},defineProperty:Hf,defineProperties:Kf,getOwnPropertyDescriptor:qf}),Gp({target:"Object",stat:!0,forced:!Yp},{getOwnPropertyNames:$f}),Tf(),Sf(Df,Cf),ff[yf]=!0;var Xf=Se&&!!Symbol.for&&!!Symbol.keyFor,Jf=Di,Qf=ae,Zf=Ze,em=po,tm=qe,im=Xf,nm=tm("string-to-symbol-registry"),sm=tm("symbol-to-string-registry");Jf({target:"Symbol",stat:!0,forced:!im},{for:function(e){var t=em(e);if(Zf(nm,t))return nm[t];var i=Qf("Symbol")(t);return nm[t]=i,sm[i]=t,i}});var rm=Di,om=Ze,am=Ae,cm=we,dm=Xf,lm=qe("symbol-to-string-registry");rm({target:"Symbol",stat:!0,forced:!dm},{keyFor:function(e){if(!am(e))throw TypeError(cm(e)+" is not a symbol");if(om(lm,e))return lm[e]}});var hm=Lu,um=w,pm=v,fm=po,mm=_([].push),Em=Di,_m=ae,gm=u,Tm=P,Sm=_,vm=o,Rm=w,ym=Ae,Cm=Oi,Im=function(e){if(um(e))return e;if(hm(e)){for(var t=e.length,i=[],n=0;n<t;n++){var s=e[n];"string"==typeof s?mm(i,s):"number"!=typeof s&&"Number"!=pm(s)&&"String"!=pm(s)||mm(i,fm(s))}var r=i.length,o=!0;return function(e,t){if(o)return o=!1,t;if(hm(this))return t;for(var n=0;n<r;n++)if(i[n]===e)return t}}},Am=Se,bm=String,wm=_m("JSON","stringify"),Dm=Sm(/./.exec),Om=Sm("".charAt),Nm=Sm("".charCodeAt),Lm=Sm("".replace),Pm=Sm(1..toString),km=/[\uD800-\uDFFF]/g,Mm=/^[\uD800-\uDBFF]$/,Um=/^[\uDC00-\uDFFF]$/,xm=!Am||vm((function(){var e=_m("Symbol")();return"[null]"!=wm([e])||"{}"!=wm({a:e})||"{}"!=wm(Object(e))})),Fm=vm((function(){return'"\\udf06\\ud834"'!==wm("\udf06\ud834")||'"\\udead"'!==wm("\udead")})),Vm=function(e,t){var i=Cm(arguments),n=Im(t);if(Rm(n)||void 0!==e&&!ym(e))return i[1]=function(e,t){if(Rm(n)&&(t=Tm(n,this,bm(e),t)),!ym(t))return t},gm(wm,null,i)},Bm=function(e,t,i){var n=Om(i,t-1),s=Om(i,t+1);return Dm(Mm,e)&&!Dm(Um,s)||Dm(Um,e)&&!Dm(Mm,n)?"\\u"+Pm(Nm(e,0),16):e};wm&&Em({target:"JSON",stat:!0,arity:3,forced:xm||Fm},{stringify:function(e,t,i){var n=Cm(arguments),s=gm(xm?Vm:wm,null,n);return Fm&&"string"==typeof s?Lm(s,km,Bm):s}});var Gm=sr,jm=Xe;Di({target:"Object",stat:!0,forced:!Se||o((function(){Gm.f(1)}))},{getOwnPropertySymbols:function(e){var t=Gm.f;return t?t(jm(e)):[]}}),bp("asyncIterator"),bp("hasInstance"),bp("isConcatSpreadable"),bp("iterator"),bp("match"),bp("matchAll"),bp("replace"),bp("search"),bp("species"),bp("split");var Wm=Lp;bp("toPrimitive"),Wm();var Hm=ae,Km=Aa;bp("toStringTag"),Km(Hm("Symbol"),"Symbol"),bp("unscopables"),Aa(r.JSON,"JSON",!0);var Ym=ie.Symbol,qm=pt,$m=Qt.f,zm=qm("metadata"),Xm=Function.prototype;void 0===Xm[zm]&&$m(Xm,zm,{value:null}),bp("dispose"),bp("metadata");var Jm=Ym;bp("asyncDispose");var Qm=_,Zm=ae("Symbol"),eE=Zm.keyFor,tE=Qm(Zm.prototype.valueOf),iE=Zm.isRegisteredSymbol||function(e){try{return void 0!==eE(tE(e))}catch(e){return!1}};Di({target:"Symbol",stat:!0},{isRegisteredSymbol:iE});for(var nE=qe,sE=ae,rE=_,oE=Ae,aE=pt,cE=sE("Symbol"),dE=cE.isWellKnownSymbol,lE=sE("Object","getOwnPropertyNames"),hE=rE(cE.prototype.valueOf),uE=nE("wks"),pE=0,fE=lE(cE),mE=fE.length;pE<mE;pE++)try{var EE=fE[pE];oE(cE[EE])&&aE(EE)}catch(e){}var _E=function(e){if(dE&&dE(e))return!0;try{for(var t=hE(e),i=0,n=lE(uE),s=n.length;i<s;i++)if(uE[n[i]]==t)return!0}catch(e){}return!1};Di({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:_E}),bp("matcher"),bp("observable"),Di({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:iE}),Di({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:_E}),bp("metadataKey"),bp("patternMatch"),bp("replaceAll");var gE=Jm,TE=n(gE),SE=vp.f("iterator"),vE=n(SE);function RE(e){return RE="function"==typeof TE&&"symbol"==typeof vE?function(e){return typeof e}:function(e){return e&&"function"==typeof TE&&e.constructor===TE&&e!==TE.prototype?"symbol":typeof e},RE(e)}var yE=n(vp.f("toPrimitive"));function CE(e){var t=function(e,t){if("object"!==RE(e)||null===e)return e;var i=e[yE];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==RE(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===RE(t)?t:String(t)}function IE(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Ou(e,CE(n.key),n)}}function AE(e,t,i){return t&&IE(e.prototype,t),i&&IE(e,i),Ou(e,"prototype",{writable:!1}),e}Di({target:"Object",stat:!0,sham:!O},{create:vs});var bE=ie.Object,wE=function(e,t){return bE.create(e,t)},DE=wE,OE=n(DE);Di({target:"Object",stat:!0},{setPrototypeOf:er});var NE=ie.Object.setPrototypeOf,LE=n(NE),PE=ji;Di({target:"Function",proto:!0,forced:Function.bind!==PE},{bind:PE});var kE=ie,ME=function(e){return kE[e+"Prototype"]},UE=ME("Function").bind,xE=ce,FE=UE,VE=Function.prototype,BE=function(e){var t=e.bind;return e===VE||xE(VE,e)&&t===VE.bind?FE:t},GE=n(BE);function jE(e,t){var i;return jE=LE?GE(i=LE).call(i):function(e,t){return e.__proto__=t,e},jE(e,t)}function WE(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=OE(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Ou(e,"prototype",{writable:!1}),t&&jE(e,t)}function HE(e,t){if(t&&("object"===RE(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}var KE=Xe,YE=Ks,qE=xs;Di({target:"Object",stat:!0,forced:o((function(){YE(1)})),sham:!qE},{getPrototypeOf:function(e){return YE(KE(e))}});var $E=ie.Object.getPrototypeOf,zE=n($E);function XE(e){var t;return XE=LE?GE(t=zE).call(t):function(e){return e.__proto__||zE(e)},XE(e)}var JE={exports:{}},QE={exports:{}};!function(e){var t=gE,i=SE;function n(s){return e.exports=n="function"==typeof t&&"symbol"==typeof i?function(e){return typeof e}:function(e){return e&&"function"==typeof t&&e.constructor===t&&e!==t.prototype?"symbol":typeof e},e.exports.__esModule=!0,e.exports.default=e.exports,n(s)}e.exports=n,e.exports.__esModule=!0,e.exports.default=e.exports}(QE);var ZE=QE.exports,e_=o,t_=Bp.forEach,i_=function(e,t){var i=[][e];return!!i&&e_((function(){i.call(null,t||function(){return 1},1)}))},n_=i_("forEach")?[].forEach:function(e){return t_(this,e,arguments.length>1?arguments[1]:void 0)};Di({target:"Array",proto:!0,forced:[].forEach!=n_},{forEach:n_});var s_=ME("Array").forEach,r_=Ji,o_=Ze,a_=ce,c_=s_,d_=Array.prototype,l_={DOMTokenList:!0,NodeList:!0},h_=function(e){var t=e.forEach;return e===d_||a_(d_,e)&&t===d_.forEach||o_(l_,r_(e))?c_:t},u_=h_,p_=O,f_=Lu,m_=TypeError,E_=Object.getOwnPropertyDescriptor,__=p_&&!function(){if(void 0!==this)return!0;try{Object.defineProperty([],"length",{writable:!1}).length=1}catch(e){return e instanceof TypeError}}()?function(e,t){if(f_(e)&&!E_(e,"length").writable)throw m_("Cannot set read only .length");return e.length=t}:function(e,t){return e.length=t},g_=Xe,T_=kn,S_=__,v_=ku;Di({target:"Array",proto:!0,arity:1,forced:o((function(){return 4294967297!==[].push.call({length:4294967296},1)}))||!function(){try{Object.defineProperty([],"length",{writable:!1}).push()}catch(e){return e instanceof TypeError}}()},{push:function(e){var t=g_(this),i=T_(t),n=arguments.length;v_(i+n);for(var s=0;s<n;s++)t[i]=arguments[s],i++;return S_(t,i),i}});var R_=ME("Array").push,y_=ce,C_=R_,I_=Array.prototype,A_=function(e){var t=e.push;return e===I_||y_(I_,e)&&t===I_.push?C_:t},b_=A_,w_=n(b_),D_=Di,O_=Lu,N_=_([].reverse),L_=[1,2];D_({target:"Array",proto:!0,forced:String(L_)===String(L_.reverse())},{reverse:function(){return O_(this)&&(this.length=this.length),N_(this)}});var P_=ME("Array").reverse,k_=ce,M_=P_,U_=Array.prototype,x_=function(e){var t=e.reverse;return e===U_||k_(U_,e)&&t===U_.reverse?M_:t},F_=x_,V_=Di,B_=Lu,G_=En,j_=te,W_=On,H_=kn,K_=Q,Y_=Fu,q_=pt,$_=Oi,z_=zu("slice"),X_=q_("species"),J_=Array,Q_=Math.max;V_({target:"Array",proto:!0,forced:!z_},{slice:function(e,t){var i,n,s,r=K_(this),o=H_(r),a=W_(e,o),c=W_(void 0===t?o:t,o);if(B_(r)&&(i=r.constructor,(G_(i)&&(i===J_||B_(i.prototype))||j_(i)&&null===(i=i[X_]))&&(i=void 0),i===J_||void 0===i))return $_(r,a,c);for(n=new(void 0===i?J_:i)(Q_(c-a,0)),s=0;a<c;a++,s++)a in r&&Y_(n,s,r[a]);return n.length=s,n}});var Z_=ME("Array").slice,eg=ce,tg=Z_,ig=Array.prototype,ng=function(e){var t=e.slice;return e===ig||eg(ig,e)&&t===ig.slice?tg:t},sg=ng,rg=n(sg);!function(e){var t=ZE.default,i=Du,n=gE,s=DE,r=$E,o=u_,a=b_,c=NE,d=gu,l=F_,h=sg;function u(){e.exports=u=function(){return p},e.exports.__esModule=!0,e.exports.default=e.exports;var p={},f=Object.prototype,m=f.hasOwnProperty,E=i||function(e,t,i){e[t]=i.value},_="function"==typeof n?n:{},g=_.iterator||"@@iterator",T=_.asyncIterator||"@@asyncIterator",S=_.toStringTag||"@@toStringTag";function v(e,t,n){return i(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{v({},"")}catch(e){v=function(e,t,i){return e[t]=i}}function R(e,t,i,n){var r=t&&t.prototype instanceof I?t:I,o=s(r.prototype),a=new x(n||[]);return E(o,"_invoke",{value:P(e,i,a)}),o}function y(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}p.wrap=R;var C={};function I(){}function A(){}function b(){}var w={};v(w,g,(function(){return this}));var D=r&&r(r(F([])));D&&D!==f&&m.call(D,g)&&(w=D);var O=b.prototype=I.prototype=s(w);function N(e){var t;o(t=["next","throw","return"]).call(t,(function(t){v(e,t,(function(e){return this._invoke(t,e)}))}))}function L(e,i){function n(s,r,o,a){var c=y(e[s],e,r);if("throw"!==c.type){var d=c.arg,l=d.value;return l&&"object"==t(l)&&m.call(l,"__await")?i.resolve(l.__await).then((function(e){n("next",e,o,a)}),(function(e){n("throw",e,o,a)})):i.resolve(l).then((function(e){d.value=e,o(d)}),(function(e){return n("throw",e,o,a)}))}a(c.arg)}var s;E(this,"_invoke",{value:function(e,t){function r(){return new i((function(i,s){n(e,t,i,s)}))}return s=s?s.then(r,r):r()}})}function P(e,t,i){var n="suspendedStart";return function(s,r){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===s)throw r;return V()}for(i.method=s,i.arg=r;;){var o=i.delegate;if(o){var a=k(o,i);if(a){if(a===C)continue;return a}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===n)throw n="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);n="executing";var c=y(e,t,i);if("normal"===c.type){if(n=i.done?"completed":"suspendedYield",c.arg===C)continue;return{value:c.arg,done:i.done}}"throw"===c.type&&(n="completed",i.method="throw",i.arg=c.arg)}}}function k(e,t){var i=t.method,n=e.iterator[i];if(void 0===n)return t.delegate=null,"throw"===i&&e.iterator.return&&(t.method="return",t.arg=void 0,k(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),C;var s=y(n,e.iterator,t.arg);if("throw"===s.type)return t.method="throw",t.arg=s.arg,t.delegate=null,C;var r=s.arg;return r?r.done?(t[e.resultName]=r.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,C):r:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,C)}function M(e){var t,i={tryLoc:e[0]};1 in e&&(i.catchLoc=e[1]),2 in e&&(i.finallyLoc=e[2],i.afterLoc=e[3]),a(t=this.tryEntries).call(t,i)}function U(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],o(e).call(e,M,this),this.reset(!0)}function F(e){if(e){var t=e[g];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,n=function t(){for(;++i<e.length;)if(m.call(e,i))return t.value=e[i],t.done=!1,t;return t.value=void 0,t.done=!0,t};return n.next=n}}return{next:V}}function V(){return{value:void 0,done:!0}}return A.prototype=b,E(O,"constructor",{value:b,configurable:!0}),E(b,"constructor",{value:A,configurable:!0}),A.displayName=v(b,S,"GeneratorFunction"),p.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===A||"GeneratorFunction"===(t.displayName||t.name))},p.mark=function(e){return c?c(e,b):(e.__proto__=b,v(e,S,"GeneratorFunction")),e.prototype=s(O),e},p.awrap=function(e){return{__await:e}},N(L.prototype),v(L.prototype,T,(function(){return this})),p.AsyncIterator=L,p.async=function(e,t,i,n,s){void 0===s&&(s=d);var r=new L(R(e,t,i,n),s);return p.isGeneratorFunction(t)?r:r.next().then((function(e){return e.done?e.value:r.next()}))},N(O),v(O,S,"Generator"),v(O,g,(function(){return this})),v(O,"toString",(function(){return"[object Generator]"})),p.keys=function(e){var t=Object(e),i=[];for(var n in t)a(i).call(i,n);return l(i).call(i),function e(){for(;i.length;){var n=i.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},p.values=F,x.prototype={constructor:x,reset:function(e){var t;if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,o(t=this.tryEntries).call(t,U),!e)for(var i in this)"t"===i.charAt(0)&&m.call(this,i)&&!isNaN(+h(i).call(i,1))&&(this[i]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function i(i,n){return r.type="throw",r.arg=e,t.next=i,n&&(t.method="next",t.arg=void 0),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var s=this.tryEntries[n],r=s.completion;if("root"===s.tryLoc)return i("end");if(s.tryLoc<=this.prev){var o=m.call(s,"catchLoc"),a=m.call(s,"finallyLoc");if(o&&a){if(this.prev<s.catchLoc)return i(s.catchLoc,!0);if(this.prev<s.finallyLoc)return i(s.finallyLoc)}else if(o){if(this.prev<s.catchLoc)return i(s.catchLoc,!0)}else{if(!a)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return i(s.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&m.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var s=n;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var r=s?s.completion:{};return r.type=e,r.arg=t,s?(this.method="next",this.next=s.finallyLoc,C):this.complete(r)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),C},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),U(i),C}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var n=i.completion;if("throw"===n.type){var s=n.arg;U(i)}return s}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,i){return this.delegate={iterator:F(e),resultName:t,nextLoc:i},"next"===this.method&&(this.arg=void 0),C}},p}e.exports=u,e.exports.__esModule=!0,e.exports.default=e.exports}(JE);var og=(0,JE.exports)(),ag=og;try{regeneratorRuntime=og}catch(e){"object"==typeof globalThis?globalThis.regeneratorRuntime=og:Function("r","regeneratorRuntime = r")(og)}var cg=n(ag),dg=ME("Array").concat,lg=ce,hg=dg,ug=Array.prototype,pg=function(e){var t=e.concat;return e===ug||lg(ug,e)&&t===ug.concat?hg:t},fg=n(pg),mg=n(pu),Eg=Xe,_g=Xn;Di({target:"Object",stat:!0,forced:o((function(){_g(1)}))},{keys:function(e){return _g(Eg(e))}});var gg=n(ie.Object.keys),Tg=n(ie.Object.getOwnPropertySymbols),Sg=Bp.filter;Di({target:"Array",proto:!0,forced:!zu("filter")},{filter:function(e){return Sg(this,e,arguments.length>1?arguments[1]:void 0)}});var vg=ME("Array").filter,Rg=ce,yg=vg,Cg=Array.prototype,Ig=function(e){var t=e.filter;return e===Cg||Rg(Cg,e)&&t===Cg.filter?yg:t},Ag=n(Ig),bg={exports:{}},wg=Di,Dg=o,Og=Q,Ng=D.f,Lg=O;wg({target:"Object",stat:!0,forced:!Lg||Dg((function(){Ng(1)})),sham:!Lg},{getOwnPropertyDescriptor:function(e,t){return Ng(Og(e),t)}});var Pg=ie.Object,kg=bg.exports=function(e,t){return Pg.getOwnPropertyDescriptor(e,t)};Pg.getOwnPropertyDescriptor.sham&&(kg.sham=!0);var Mg=n(bg.exports),Ug=lr,xg=Q,Fg=D,Vg=Fu;Di({target:"Object",stat:!0,sham:!O},{getOwnPropertyDescriptors:function(e){for(var t,i,n=xg(e),s=Fg.f,r=Ug(n),o={},a=0;r.length>a;)void 0!==(i=s(n,t=r[a++]))&&Vg(o,t,i);return o}});var Bg=n(ie.Object.getOwnPropertyDescriptors);var Gg={exports:{}},jg=o((function(){if("function"==typeof ArrayBuffer){var e=new ArrayBuffer(8);Object.isExtensible(e)&&Object.defineProperty(e,"a",{value:8})}})),Wg=o,Hg=te,Kg=v,Yg=jg,qg=Object.isExtensible,$g=Wg((function(){qg(1)}))||Yg?function(e){return!!Hg(e)&&((!Yg||"ArrayBuffer"!=Kg(e))&&(!qg||qg(e)))}:qg,zg=!o((function(){return Object.isExtensible(Object.preventExtensions({}))})),Xg=Di,Jg=_,Qg=Bn,Zg=te,eT=Ze,tT=Qt.f,iT=tr,nT=lp,sT=$g,rT=zg,oT=!1,aT=st("meta"),cT=0,dT=function(e){tT(e,aT,{value:{objectID:"O"+cT++,weakData:{}}})},lT=Gg.exports={enable:function(){lT.enable=function(){},oT=!0;var e=iT.f,t=Jg([].splice),i={};i[aT]=1,e(i).length&&(iT.f=function(i){for(var n=e(i),s=0,r=n.length;s<r;s++)if(n[s]===aT){t(n,s,1);break}return n},Xg({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:nT.f}))},fastKey:function(e,t){if(!Zg(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!eT(e,aT)){if(!sT(e))return"F";if(!t)return"E";dT(e)}return e[aT].objectID},getWeakData:function(e,t){if(!eT(e,aT)){if(!sT(e))return!0;if(!t)return!1;dT(e)}return e[aT].weakData},onFreeze:function(e){return rT&&oT&&sT(e)&&!eT(e,aT)&&dT(e),e}};Qg[aT]=!0;var hT=Gg.exports,uT=Di,pT=r,fT=hT,mT=o,ET=_i,_T=lo,gT=Tc,TT=w,ST=te,vT=Aa,RT=Qt.f,yT=Bp.forEach,CT=O,IT=Zo.set,AT=Zo.getterFor,bT=aa,wT=vs,DT=hc,OT=function(e,t,i){for(var n in t)i&&i.unsafe&&e[n]?e[n]=t[n]:bT(e,n,t[n],i);return e},NT=Jt,LT=Tc,PT=Y,kT=lo,MT=za,UT=Xa,xT=Ec,FT=O,VT=hT.fastKey,BT=Zo.set,GT=Zo.getterFor,jT={getConstructor:function(e,t,i,n){var s=e((function(e,s){LT(e,r),BT(e,{type:t,index:wT(null),first:void 0,last:void 0,size:0}),FT||(e.size=0),PT(s)||kT(s,e[n],{that:e,AS_ENTRIES:i})})),r=s.prototype,o=GT(t),a=function(e,t,i){var n,s,r=o(e),a=c(e,t);return a?a.value=i:(r.last=a={index:s=VT(t,!0),key:t,value:i,previous:n=r.last,next:void 0,removed:!1},r.first||(r.first=a),n&&(n.next=a),FT?r.size++:e.size++,"F"!==s&&(r.index[s]=a)),e},c=function(e,t){var i,n=o(e),s=VT(t);if("F"!==s)return n.index[s];for(i=n.first;i;i=i.next)if(i.key==t)return i};return OT(r,{clear:function(){for(var e=o(this),t=e.index,i=e.first;i;)i.removed=!0,i.previous&&(i.previous=i.previous.next=void 0),delete t[i.index],i=i.next;e.first=e.last=void 0,FT?e.size=0:this.size=0},delete:function(e){var t=this,i=o(t),n=c(t,e);if(n){var s=n.next,r=n.previous;delete i.index[n.index],n.removed=!0,r&&(r.next=s),s&&(s.previous=r),i.first==n&&(i.first=s),i.last==n&&(i.last=r),FT?i.size--:t.size--}return!!n},forEach:function(e){for(var t,i=o(this),n=NT(e,arguments.length>1?arguments[1]:void 0);t=t?t.next:i.first;)for(n(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!c(this,e)}}),OT(r,i?{get:function(e){var t=c(this,e);return t&&t.value},set:function(e,t){return a(this,0===e?0:e,t)}}:{add:function(e){return a(this,e=0===e?0:e,e)}}),FT&&DT(r,"size",{configurable:!0,get:function(){return o(this).size}}),s},setStrong:function(e,t,i){var n=t+" Iterator",s=GT(t),r=GT(n);MT(e,t,(function(e,t){BT(this,{type:n,target:e,state:s(e),kind:t,last:void 0})}),(function(){for(var e=r(this),t=e.kind,i=e.last;i&&i.removed;)i=i.previous;return e.target&&(e.last=i=i?i.next:e.state.first)?UT("keys"==t?i.key:"values"==t?i.value:[i.key,i.value],!1):(e.target=void 0,UT(void 0,!0))}),i?"entries":"values",!i,!0),xT(t)}},WT=function(e,t,i){var n,s=-1!==e.indexOf("Map"),r=-1!==e.indexOf("Weak"),o=s?"set":"add",a=pT[e],c=a&&a.prototype,d={};if(CT&&TT(a)&&(r||c.forEach&&!mT((function(){(new a).entries().next()})))){var l=(n=t((function(t,i){IT(gT(t,l),{type:e,collection:new a}),null!=i&&_T(i,t[o],{that:t,AS_ENTRIES:s})}))).prototype,h=AT(e);yT(["add","clear","delete","forEach","get","has","set","keys","values","entries"],(function(e){var t="add"==e||"set"==e;!(e in c)||r&&"clear"==e||ET(l,e,(function(i,n){var s=h(this).collection;if(!t&&r&&!ST(i))return"get"==e&&void 0;var o=s[e](0===i?0:i,n);return t?this:o}))})),r||RT(l,"size",{configurable:!0,get:function(){return h(this).collection.size}})}else n=i.getConstructor(t,e,s,o),fT.enable();return vT(n,e,!1,!0),d[e]=n,uT({global:!0,forced:!0},d),r||i.setStrong(n,e,s),n};WT("Map",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),jT);var HT=n(ie.Map),KT=Bp.map;Di({target:"Array",proto:!0,forced:!zu("map")},{map:function(e){return KT(this,e,arguments.length>1?arguments[1]:void 0)}});var YT=ME("Array").map,qT=ce,$T=YT,zT=Array.prototype,XT=function(e){var t=e.map;return e===zT||qT(zT,e)&&t===zT.map?$T:t},JT=n(XT),QT=we,ZT=TypeError,eS=Di,tS=Xe,iS=On,nS=An,sS=kn,rS=__,oS=ku,aS=Ku,cS=Fu,dS=function(e,t){if(!delete e[t])throw ZT("Cannot delete property "+QT(t)+" of "+QT(e))},lS=zu("splice"),hS=Math.max,uS=Math.min;eS({target:"Array",proto:!0,forced:!lS},{splice:function(e,t){var i,n,s,r,o,a,c=tS(this),d=sS(c),l=iS(e,d),h=arguments.length;for(0===h?i=n=0:1===h?(i=0,n=d-l):(i=h-2,n=uS(hS(nS(t),0),d-l)),oS(d+i-n),s=aS(c,n),r=0;r<n;r++)(o=l+r)in c&&cS(s,r,c[o]);if(s.length=n,i<n){for(r=l;r<d-n;r++)a=r+i,(o=r+n)in c?c[a]=c[o]:dS(c,a);for(r=d;r>d-n+i;r--)dS(c,r-1)}else if(i>n)for(r=d-n;r>l;r--)a=r+i-1,(o=r+n-1)in c?c[a]=c[o]:dS(c,a);for(r=0;r<i;r++)c[r+l]=arguments[r+2];return rS(c,d-n+i),s}});var pS=ME("Array").splice,fS=ce,mS=pS,ES=Array.prototype,_S=function(e){var t=e.splice;return e===ES||fS(ES,e)&&t===ES.splice?mS:t},gS=n(_S),TS=Di,SS=Bp.findIndex,vS="findIndex",RS=!0;vS in[]&&Array(1)[vS]((function(){RS=!1})),TS({target:"Array",proto:!0,forced:RS},{findIndex:function(e){return SS(this,e,arguments.length>1?arguments[1]:void 0)}});var yS=ME("Array").findIndex,CS=ce,IS=yS,AS=Array.prototype,bS=function(e){var t=e.findIndex;return e===AS||CS(AS,e)&&t===AS.findIndex?IS:t},wS=n(bS),DS=function(){function e(){Ru(this,e),this._events=new HT,this.addListener=this.on}return AE(e,[{key:"getListeners",value:function(e){var t=this._events.get(e);return Array.isArray(t)?JT(t).call(t,(function(e){return e.listener})):[]}},{key:"on",value:function(e,t){var i=this._events.get(e);Array.isArray(i)||(i=[],this._events.set(e,i)),-1===this._indexOfListener(i,t)&&i.push({listener:t,once:!1})}},{key:"once",value:function(e,t){var i=this._events.get(e);Array.isArray(i)||(i=[],this._events.set(e,i)),-1===this._indexOfListener(i,t)&&i.push({listener:t,once:!0})}},{key:"off",value:function(e,t){var i=this._events.get(e);if(Array.isArray(i)){if(!t)return this.removeAllListeners(e);var n=this._indexOfListener(i,t);-1!==n&&gS(i).call(i,n,1),0===this._events.size&&this._events.delete(e)}}},{key:"removeAllListeners",value:function(e){if(!e)return this._events.clear();this._events.delete(e)}},{key:"emit",value:function(e){for(var t=this,i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];var r=this._events.get(e);Array.isArray(r)&&r.forEach((function(i){i.once&&t.off(e,i.listener),i.listener.apply(t,n||[])}))}},{key:"safeEmit",value:function(e){for(var t=this,i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];var r=this._events.get(e);Array.isArray(r)&&r.forEach((function(i){i.once&&t.off(e,i.listener);try{i.listener.apply(t,n||[])}catch(t){var s;console.error(fg(s="safeEmit event:".concat(e," error ")).call(s,null==t?void 0:t.toString()))}}))}},{key:"_indexOfListener",value:function(e,t){return wS(e).call(e,(function(e){return e.listener===t}))}}]),e}();function OS(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var NS={exports:{}};!function(e,t){var i,n,s,r,o;i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,n=/^(?=([^\/?#]*))\1([^]*)$/,s=/(?:\/|^)\.(?=\/)/g,r=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,o={buildAbsoluteURL:function(e,t,i){if(i=i||{},e=e.trim(),!(t=t.trim())){if(!i.alwaysNormalize)return e;var s=o.parseURL(e);if(!s)throw new Error("Error trying to parse base URL.");return s.path=o.normalizePath(s.path),o.buildURLFromParts(s)}var r=o.parseURL(t);if(!r)throw new Error("Error trying to parse relative URL.");if(r.scheme)return i.alwaysNormalize?(r.path=o.normalizePath(r.path),o.buildURLFromParts(r)):t;var a=o.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var c=n.exec(a.path);a.netLoc=c[1],a.path=c[2]}a.netLoc&&!a.path&&(a.path="/");var d={scheme:a.scheme,netLoc:r.netLoc,path:null,params:r.params,query:r.query,fragment:r.fragment};if(!r.netLoc&&(d.netLoc=a.netLoc,"/"!==r.path[0]))if(r.path){var l=a.path,h=l.substring(0,l.lastIndexOf("/")+1)+r.path;d.path=o.normalizePath(h)}else d.path=a.path,r.params||(d.params=a.params,r.query||(d.query=a.query));return null===d.path&&(d.path=i.alwaysNormalize?o.normalizePath(r.path):r.path),o.buildURLFromParts(d)},parseURL:function(e){var t=i.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(s,"");e.length!==(e=e.replace(r,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}},e.exports=o}(NS);var LS=NS.exports;function PS(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function kS(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?PS(Object(i),!0).forEach((function(t){US(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):PS(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function MS(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function US(e,t,i){return(t=MS(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function xS(){return xS=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e},xS.apply(this,arguments)}const FS=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},VS=Number.isSafeInteger||function(e){return"number"==typeof e&&Math.abs(e)<=BS},BS=Number.MAX_SAFE_INTEGER||9007199254740991;let GS=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",e}({}),jS=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),WS=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.UNKNOWN="unknown",e}({});const HS=function(){},KS={trace:HS,debug:HS,log:HS,warn:HS,info:HS,error:HS};let YS=KS;function qS(e,...t){t.forEach((function(t){YS[t]=e[t]?e[t].bind(e):function(e){const t=self.console[e];return t?t.bind(self.console,`[${e}] >`):HS}(t)}))}const $S=YS,zS=/^(\d+)x(\d+)$/,XS=/(.+?)=(".*?"|.*?)(?:,|$)/g;class JS{constructor(e){"string"==typeof e&&(e=JS.parseAttrList(e)),xS(this,e)}get clientAttrs(){return Object.keys(this).filter((e=>"X-"===e.substring(0,2)))}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const i=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)i[e]=parseInt(t.slice(2*e,2*e+2),16);return i}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}bool(e){return"YES"===this[e]}decimalResolution(e){const t=zS.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const i={};for(XS.lastIndex=0;null!==(t=XS.exec(e));){let e=t[2];0===e.indexOf('"')&&e.lastIndexOf('"')===e.length-1&&(e=e.slice(1,-1));i[t[1].trim()]=e}return i}}function QS(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e}class ZS{constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const i=t.attr;for(const t in i)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==i[t]){$S.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=xS(new JS({}),i,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const e=new Date(this.attr["END-DATE"]);FS(e.getTime())&&(this._endDate=e)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return null!==e?new Date(this._startDate.getTime()+1e3*e):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(FS(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&FS(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class ev{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var tv={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class iv{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[tv.AUDIO]:null,[tv.VIDEO]:null,[tv.AUDIOVIDEO]:null},this.baseurl=e}setByteRange(e,t){const i=e.split("@",2);let n;n=1===i.length?(null==t?void 0:t.byteRangeEndOffset)||0:parseInt(i[1]),this._byteRange=[n,parseInt(i[0])+n]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=LS.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class nv extends iv{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new ev,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const e=Object.keys(this.levelkeys);if(1===e.length)return this._decryptdata=this.levelkeys[e[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;if(!FS(this.programDateTime))return null;const e=FS(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),t=e.length;if(t>1||1===t&&this.levelkeys[e[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}setElementaryStreamInfo(e,t,i,n,s,r=!1){const{elementaryStreams:o}=this,a=o[e];a?(a.startPTS=Math.min(a.startPTS,t),a.endPTS=Math.max(a.endPTS,i),a.startDTS=Math.min(a.startDTS,n),a.endDTS=Math.max(a.endDTS,s)):o[e]={startPTS:t,endPTS:i,startDTS:n,endDTS:s,partial:r}}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[tv.AUDIO]=null,e[tv.VIDEO]=null,e[tv.AUDIOVIDEO]=null}}class sv extends iv{constructor(e,t,i,n,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new ev,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=n;const r=e.enumeratedString("BYTERANGE");r&&this.setByteRange(r,s),s&&(this.fragOffset=s.fragOffset+s.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}class rv{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||0===t&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&FS(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const e=this.driftEndTime-this.driftStartTime;if(e>0){return 1e3*(this.driftEnd-this.driftStart)/e}return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function ov(e){return Uint8Array.from(atob(e),(e=>e.charCodeAt(0)))}function av(e){const t=e.split(":");let i=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),n=e[e.length-1].split(",");if(2===n.length){const t="base64"===n[0],s=n[1];t?(e.splice(-1,1),i=ov(s)):i=function(e){const t=cv(e).subarray(0,16),i=new Uint8Array(16);return i.set(t,16-t.length),i}(s)}}return i}function cv(e){return Uint8Array.from(unescape(encodeURIComponent(e)),(e=>e.charCodeAt(0)))}const dv="undefined"!=typeof self?self:void 0;var lv={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},hv={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function uv(e){switch(e){case hv.FAIRPLAY:return lv.FAIRPLAY;case hv.PLAYREADY:return lv.PLAYREADY;case hv.WIDEVINE:return lv.WIDEVINE;case hv.CLEARKEY:return lv.CLEARKEY}}var pv={WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function fv(e){switch(e){case lv.FAIRPLAY:return hv.FAIRPLAY;case lv.PLAYREADY:return hv.PLAYREADY;case lv.WIDEVINE:return hv.WIDEVINE;case lv.CLEARKEY:return hv.CLEARKEY}}function mv(e){const{drmSystems:t,widevineLicenseUrl:i}=e,n=t?[lv.FAIRPLAY,lv.WIDEVINE,lv.PLAYREADY,lv.CLEARKEY].filter((e=>!!t[e])):[];return!n[lv.WIDEVINE]&&i&&n.push(lv.WIDEVINE),n}const Ev=null!=dv&&null!=(_v=dv.navigator)&&_v.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var _v;function gv(e,t,i){return Uint8Array.prototype.slice?e.slice(t,i):new Uint8Array(Array.prototype.slice.call(e,t,i))}const Tv=(e,t)=>t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,Sv=(e,t)=>t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128,vv=(e,t)=>{const i=t;let n=0;for(;Tv(e,t);){n+=10;n+=Rv(e,t+6),Sv(e,t+10)&&(n+=10),t+=n}if(n>0)return e.subarray(i,i+n)},Rv=(e,t)=>{let i=0;return i=(127&e[t])<<21,i|=(127&e[t+1])<<14,i|=(127&e[t+2])<<7,i|=127&e[t+3],i},yv=(e,t)=>Tv(e,t)&&Rv(e,t+6)+10<=e.length-t,Cv=e=>{const t=bv(e);for(let e=0;e<t.length;e++){const i=t[e];if(Iv(i))return Lv(i)}},Iv=e=>e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info,Av=e=>{const t=String.fromCharCode(e[0],e[1],e[2],e[3]),i=Rv(e,4);return{type:t,size:i,data:e.subarray(10,10+i)}},bv=e=>{let t=0;const i=[];for(;Tv(e,t);){const n=Rv(e,t+6);t+=10;const s=t+n;for(;t+8<s;){const n=Av(e.subarray(t)),s=wv(n);s&&i.push(s),t+=n.size+10}Sv(e,t)&&(t+=10)}return i},wv=e=>"PRIV"===e.type?Dv(e):"W"===e.type[0]?Nv(e):Ov(e),Dv=e=>{if(e.size<2)return;const t=Pv(e.data,!0),i=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:i.buffer}},Ov=e=>{if(e.size<2)return;if("TXXX"===e.type){let t=1;const i=Pv(e.data.subarray(t),!0);t+=i.length+1;const n=Pv(e.data.subarray(t));return{key:e.type,info:i,data:n}}const t=Pv(e.data.subarray(1));return{key:e.type,data:t}},Nv=e=>{if("WXXX"===e.type){if(e.size<2)return;let t=1;const i=Pv(e.data.subarray(t),!0);t+=i.length+1;const n=Pv(e.data.subarray(t));return{key:e.type,info:i,data:n}}const t=Pv(e.data);return{key:e.type,data:t}},Lv=e=>{if(8===e.data.byteLength){const t=new Uint8Array(e.data),i=1&t[3];let n=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return n/=45,i&&(n+=47721858.84),Math.round(n)}},Pv=(e,t=!1)=>{const i=Mv();if(i){const n=i.decode(e);if(t){const e=n.indexOf("\0");return-1!==e?n.substring(0,e):n}return n.replace(/\0/g,"")}const n=e.length;let s,r,o,a="",c=0;for(;c<n;){if(s=e[c++],0===s&&t)return a;if(0!==s&&3!==s)switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(s);break;case 12:case 13:r=e[c++],a+=String.fromCharCode((31&s)<<6|63&r);break;case 14:r=e[c++],o=e[c++],a+=String.fromCharCode((15&s)<<12|(63&r)<<6|(63&o)<<0)}}return a};let kv;function Mv(){if(!navigator.userAgent.includes("PlayStation 4"))return kv||void 0===self.TextDecoder||(kv=new self.TextDecoder("utf-8")),kv}const Uv={hexDump:function(e){let t="";for(let i=0;i<e.length;i++){let n=e[i].toString(16);n.length<2&&(n="0"+n),t+=n}return t}},xv=Math.pow(2,32)-1,Fv=[].push,Vv={video:1,audio:2,id3:3,text:4};function Bv(e){return String.fromCharCode.apply(null,e)}function Gv(e,t){const i=e[t]<<8|e[t+1];return i<0?65536+i:i}function jv(e,t){const i=Hv(e,t);return i<0?4294967296+i:i}function Wv(e,t){let i=jv(e,t);return i*=Math.pow(2,32),i+=jv(e,t+4),i}function Hv(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function Kv(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i}function Yv(e,t){const i=[];if(!t.length)return i;const n=e.byteLength;for(let s=0;s<n;){const r=jv(e,s),o=r>1?s+r:n;if(Bv(e.subarray(s+4,s+8))===t[0])if(1===t.length)i.push(e.subarray(s+8,o));else{const n=Yv(e.subarray(s+8,o),t.slice(1));n.length&&Fv.apply(i,n)}s=o}return i}function qv(e){const t=[],i=e[0];let n=8;const s=jv(e,n);n+=4;let r=0,o=0;0===i?(r=jv(e,n),o=jv(e,n+4),n+=8):(r=Wv(e,n),o=Wv(e,n+8),n+=16),n+=2;let a=e.length+o;const c=Gv(e,n);n+=2;for(let i=0;i<c;i++){let i=n;const r=jv(e,i);i+=4;const o=2147483647&r;if(1===(2147483648&r)>>>31)return $S.warn("SIDX has hierarchical references (not supported)"),null;const c=jv(e,i);i+=4,t.push({referenceSize:o,subsegmentDuration:c,info:{duration:c/s,start:a,end:a+o-1}}),a+=o,i+=4,n=i}return{earliestPresentationTime:r,timescale:s,version:i,referencesCount:c,references:t}}function $v(e){const t=[],i=Yv(e,["moov","trak"]);for(let e=0;e<i.length;e++){const n=i[e],s=Yv(n,["tkhd"])[0];if(s){let e=s[0];const i=jv(s,0===e?12:20),r=Yv(n,["mdia","mdhd"])[0];if(r){e=r[0];const s=jv(r,0===e?12:20),o=Yv(n,["mdia","hdlr"])[0];if(o){const e=Bv(o.subarray(8,12)),r={soun:tv.AUDIO,vide:tv.VIDEO}[e];if(r){const e=zv(Yv(n,["mdia","minf","stbl","stsd"])[0]);t[i]={timescale:s,type:r},t[r]=kS({timescale:s,id:i},e)}}}}}return Yv(e,["moov","mvex","trex"]).forEach((e=>{const i=jv(e,4),n=t[i];n&&(n.default={duration:jv(e,12),flags:jv(e,20)})})),t}function zv(e){const t=e.subarray(8),i=t.subarray(86),n=Bv(t.subarray(4,8));let s=n;const r="enca"===n||"encv"===n;if(r){const e=Yv(t,[n])[0];Yv(e.subarray("enca"===n?28:78),["sinf"]).forEach((e=>{const t=Yv(e,["schm"])[0];if(t){const i=Bv(t.subarray(4,8));if("cbcs"===i||"cenc"===i){const t=Yv(e,["frma"])[0];t&&(s=Bv(t))}}}))}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const e=Yv(i,["avcC"])[0];s+="."+Jv(e[1])+Jv(e[2])+Jv(e[3]);break}case"mp4a":{const e=Yv(t,[n])[0],i=Yv(e.subarray(28),["esds"])[0];if(i&&i.length>12){let e=4;if(3!==i[e++])break;e=Xv(i,e),e+=2;const t=i[e++];if(128&t&&(e+=2),64&t&&(e+=i[e++]),4!==i[e++])break;e=Xv(i,e);const n=i[e++];if(64!==n)break;if(s+="."+Jv(n),e+=12,5!==i[e++])break;e=Xv(i,e);const r=i[e++];let o=(248&r)>>3;31===o&&(o+=1+((7&r)<<3)+((224&i[e])>>5)),s+="."+o}break}case"hvc1":case"hev1":{const e=Yv(i,["hvcC"])[0],t=e[1],n=["","A","B","C"][t>>6],r=31&t,o=jv(e,2),a=(32&t)>>5?"H":"L",c=e[12],d=e.subarray(6,12);s+="."+n+r,s+="."+o.toString(16).toUpperCase(),s+="."+a+c;let l="";for(let e=d.length;e--;){const t=d[e];if(t||l){l="."+t.toString(16).toUpperCase()+l}}s+=l;break}case"dvh1":case"dvhe":{const e=Yv(i,["dvcC"])[0],t=e[2]>>1&127,n=e[2]<<5&32|e[3]>>3&31;s+="."+Qv(t)+"."+Qv(n);break}case"vp09":{const e=Yv(i,["vpcC"])[0],t=e[4],n=e[5],r=e[6]>>4&15;s+="."+Qv(t)+"."+Qv(n)+"."+Qv(r);break}case"av01":{const e=Yv(i,["av1C"])[0],t=e[1]>>>5,n=31&e[1],r=e[2]>>>7?"H":"M",o=(64&e[2])>>6,a=(32&e[2])>>5,c=2===t&&o?a?12:10:o?10:8,d=(16&e[2])>>4,l=(8&e[2])>>3,h=(4&e[2])>>2,u=3&e[2],p=1,f=1,m=1,E=0;s+="."+t+"."+Qv(n)+r+"."+Qv(c)+"."+d+"."+l+h+u+"."+Qv(p)+"."+Qv(f)+"."+Qv(m)+"."+E;break}}return{codec:s,encrypted:r}}function Xv(e,t){const i=t+5;for(;128&e[t++]&&t<i;);return t}function Jv(e){return("0"+e.toString(16).toUpperCase()).slice(-2)}function Qv(e){return(e<10?"0":"")+e}function Zv(e){const t=Yv(e,["schm"])[0];if(t){const i=Bv(t.subarray(4,8));if("cbcs"===i||"cenc"===i)return Yv(e,["schi","tenc"])[0]}return $S.error("[eme] missing 'schm' box"),null}function eR(e){const t=jv(e,0);let i=8;1&t&&(i+=4),4&t&&(i+=4);let n=0;const s=jv(e,4);for(let r=0;r<s;r++){if(256&t){n+=jv(e,i),i+=4}512&t&&(i+=4),1024&t&&(i+=4),2048&t&&(i+=4)}return n}function tR(e,t){const i=new Uint8Array(e.length+t.length);return i.set(e),i.set(t,e.length),i}function iR(e,t){const i=[],n=t.samples,s=t.timescale,r=t.id;let o=!1;return Yv(n,["moof"]).map((a=>{const c=a.byteOffset-8;Yv(a,["traf"]).map((a=>{const d=Yv(a,["tfdt"]).map((e=>{const t=e[0];let i=jv(e,4);return 1===t&&(i*=Math.pow(2,32),i+=jv(e,8)),i/s}))[0];return void 0!==d&&(e=d),Yv(a,["tfhd"]).map((d=>{const l=jv(d,4),h=16777215&jv(d,0);let u=0;const p=0!=(16&h);let f=0;const m=0!=(32&h);let E=8;l===r&&(0!=(1&h)&&(E+=8),0!=(2&h)&&(E+=4),0!=(8&h)&&(u=jv(d,E),E+=4),p&&(f=jv(d,E),E+=4),m&&(E+=4),"video"===t.type&&(o=function(e){if(!e)return!1;const t=e.indexOf("."),i=t<0?e:e.substring(0,t);return"hvc1"===i||"hev1"===i||"dvh1"===i||"dvhe"===i}(t.codec)),Yv(a,["trun"]).map((r=>{const a=r[0],d=16777215&jv(r,0),l=0!=(1&d);let h=0;const p=0!=(4&d),m=0!=(256&d);let E=0;const _=0!=(512&d);let g=0;const T=0!=(1024&d),S=0!=(2048&d);let v=0;const R=jv(r,4);let y=8;l&&(h=jv(r,y),y+=4),p&&(y+=4);let C=h+c;for(let c=0;c<R;c++){if(m?(E=jv(r,y),y+=4):E=u,_?(g=jv(r,y),y+=4):g=f,T&&(y+=4),S&&(v=0===a?jv(r,y):Hv(r,y),y+=4),t.type===tv.VIDEO){let t=0;for(;t<g;){const r=jv(n,C);if(C+=4,nR(o,n[C])){sR(n.subarray(C,C+r),o?2:1,e+v/s,i)}C+=r,t+=r+4}}e+=E/s}})))}))}))})),i}function nR(e,t){if(e){const e=t>>1&63;return 39===e||40===e}return 6===(31&t)}function sR(e,t,i,n){const s=rR(e);let r=0;r+=t;let o=0,a=0,c=0;for(;r<s.length;){o=0;do{if(r>=s.length)break;c=s[r++],o+=c}while(255===c);a=0;do{if(r>=s.length)break;c=s[r++],a+=c}while(255===c);const e=s.length-r;let t=r;if(a<e)r+=a;else if(a>e){$S.error(`Malformed SEI payload. ${a} is too small, only ${e} bytes left to parse.`);break}if(4===o){if(181===s[t++]){const e=Gv(s,t);if(t+=2,49===e){const e=jv(s,t);if(t+=4,1195456820===e){const e=s[t++];if(3===e){const r=s[t++],a=64&r,c=a?2+3*(31&r):0,d=new Uint8Array(c);if(a){d[0]=r;for(let e=1;e<c;e++)d[e]=s[t++]}n.push({type:e,payloadType:o,pts:i,bytes:d})}}}}}else if(5===o&&a>16){const e=[];for(let i=0;i<16;i++){const n=s[t++].toString(16);e.push(1==n.length?"0"+n:n),3!==i&&5!==i&&7!==i&&9!==i||e.push("-")}const r=a-16,c=new Uint8Array(r);for(let e=0;e<r;e++)c[e]=s[t++];n.push({payloadType:o,pts:i,uuid:e.join(""),userData:Pv(c),userDataBytes:c})}}}function rR(e){const t=e.byteLength,i=[];let n=1;for(;n<t-2;)0===e[n]&&0===e[n+1]&&3===e[n+2]?(i.push(n+2),n+=2):n++;if(0===i.length)return e;const s=t-i.length,r=new Uint8Array(s);let o=0;for(n=0;n<s;o++,n++)o===i[0]&&(o++,i.shift()),r[n]=e[o];return r}function oR(e,t,i){if(16!==e.byteLength)throw new RangeError("Invalid system id");let n,s,r;if(t){n=1,s=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){const i=t[e];if(16!==i.byteLength)throw new RangeError("Invalid key");s.set(i,16*e)}}else n=0,s=new Uint8Array;n>0?(r=new Uint8Array(4),t.length>0&&new DataView(r.buffer).setUint32(0,t.length,!1)):r=new Uint8Array;const o=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(o.buffer).setUint32(0,i.byteLength,!1),function(e,...t){const i=t.length;let n=8,s=i;for(;s--;)n+=t[s].byteLength;const r=new Uint8Array(n);for(r[0]=n>>24&255,r[1]=n>>16&255,r[2]=n>>8&255,r[3]=255&n,r.set(e,4),s=0,n=8;s<i;s++)r.set(t[s],n),n+=t[s].byteLength;return r}([112,115,115,104],new Uint8Array([n,0,0,0]),e,r,s,o,i||new Uint8Array)}let aR={};class cR{static clearKeyUriToKeyIdMap(){aR={}}constructor(e,t,i,n=[1],s=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=n,this.iv=s,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&"AES-128"!==e}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case hv.FAIRPLAY:case hv.WIDEVINE:case hv.PLAYREADY:case hv.CLEARKEY:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof e&&("AES-128"!==this.method||this.iv||$S.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const t=function(e){const t=new Uint8Array(16);for(let i=12;i<16;i++)t[i]=e>>8*(15-i)&255;return t}(e);return new cR(this.method,this.uri,"identity",this.keyFormatVersions,t)}const t=av(this.uri);if(t)switch(this.keyFormat){case hv.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case hv.PLAYREADY:{const e=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=oR(e,null,t);const i=new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2),n=String.fromCharCode.apply(null,Array.from(i)),s=n.substring(n.indexOf("<"),n.length),r=(new DOMParser).parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(r){const e=r.childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE");if(e){const t=ov(e).subarray(0,16);!function(e){const t=function(e,t,i){const n=e[t];e[t]=e[i],e[i]=n};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}(t),this.keyId=t}}break}default:{let e=t.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=aR[this.uri];if(!e){const t=Object.keys(aR).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16);new DataView(e.buffer,12,4).setUint32(0,t),aR[this.uri]=e}this.keyId=e}return this}}const dR=/\{\$([a-zA-Z0-9-_]+)\}/g;function lR(e){return dR.test(e)}function hR(e,t,i){if(null!==e.variableList||e.hasVariableRefs)for(let n=i.length;n--;){const s=i[n],r=t[s];r&&(t[s]=uR(e,r))}}function uR(e,t){if(null!==e.variableList||e.hasVariableRefs){const i=e.variableList;return t.replace(dR,(t=>{const n=t.substring(2,t.length-1),s=null==i?void 0:i[n];return void 0===s?(e.playlistParsingError||(e.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${n}"`)),t):s}))}return t}function pR(e,t,i){let n,s,r=e.variableList;if(r||(e.variableList=r={}),"QUERYPARAM"in t){n=t.QUERYPARAM;try{const e=new self.URL(i).searchParams;if(!e.has(n))throw new Error(`"${n}" does not match any query parameter in URI: "${i}"`);s=e.get(n)}catch(t){e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${t.message}`))}}else n=t.NAME,s=t.VALUE;n in r?e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${n}"`)):r[n]=s||""}function fR(e,t,i){const n=t.IMPORT;if(i&&n in i){let t=e.variableList;t||(e.variableList=t={}),t[n]=i[n]}else e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${n}"`))}function mR(e=!0){if("undefined"==typeof self)return;return(e||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}const ER={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function _R(e,t,i=!0){return!e.split(",").some((e=>!gR(e,t,i)))}function gR(e,t,i=!0){var n;const s=mR(i);return null!=(n=null==s?void 0:s.isTypeSupported(TR(e,t)))&&n}function TR(e,t){return`${t}/mp4;codecs="${e}"`}function SR(e){if(e){const t=e.substring(0,4);return ER.video[t]}return 2}function vR(e){return e.split(",").reduce(((e,t)=>{const i=ER.video[t];return i?(2*i+e)/(e?3:2):(ER.audio[t]+e)/(e?2:1)}),0)}const RR={};const yR=/flac|opus/i;function CR(e,t=!0){return e.replace(yR,(e=>function(e,t=!0){if(RR[e])return RR[e];const i={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[e];for(let n=0;n<i.length;n++)if(gR(i[n],"audio",t))return RR[e]=i[n],i[n];return e}(e.toLowerCase(),t)))}function IR(e,t){return e&&"mp4a"!==e?e:t}const AR=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,bR=/#EXT-X-MEDIA:(.*)/g,wR=/^#EXT(?:INF|-X-TARGETDURATION):/m,DR=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),OR=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class NR{static findGroup(e,t){for(let i=0;i<e.length;i++){const n=e[i];if(n.id===t)return n}}static resolve(e,t){return LS.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return wR.test(e)}static parseMasterPlaylist(e,t){const i={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:lR(e)},n=[];let s;for(AR.lastIndex=0;null!=(s=AR.exec(e));)if(s[1]){var r;const e=new JS(s[1]);hR(i,e,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const o=uR(i,s[2]),a={attrs:e,bitrate:e.decimalInteger("BANDWIDTH")||e.decimalInteger("AVERAGE-BANDWIDTH"),name:e.NAME,url:NR.resolve(o,t)},c=e.decimalResolution("RESOLUTION");c&&(a.width=c.width,a.height=c.height),kR(e.CODECS,a),null!=(r=a.unknownCodecs)&&r.length||n.push(a),i.levels.push(a)}else if(s[3]){const e=s[3],n=s[4];switch(e){case"SESSION-DATA":{const e=new JS(n);hR(i,e,["DATA-ID","LANGUAGE","VALUE","URI"]);const t=e["DATA-ID"];t&&(null===i.sessionData&&(i.sessionData={}),i.sessionData[t]=e);break}case"SESSION-KEY":{const e=LR(n,t,i);e.encrypted&&e.isSupported()?(null===i.sessionKeys&&(i.sessionKeys=[]),i.sessionKeys.push(e)):$S.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${n}"`);break}case"DEFINE":{const e=new JS(n);hR(i,e,["NAME","VALUE","QUERYPARAM"]),pR(i,e,t)}break;case"CONTENT-STEERING":{const e=new JS(n);hR(i,e,["SERVER-URI","PATHWAY-ID"]),i.contentSteering={uri:NR.resolve(e["SERVER-URI"],t),pathwayId:e["PATHWAY-ID"]||"."};break}case"START":i.startTimeOffset=PR(n)}}const o=n.length>0&&n.length<i.levels.length;return i.levels=o?n:i.levels,0===i.levels.length&&(i.playlistParsingError=new Error("no levels found in manifest")),i}static parseMasterPlaylistMedia(e,t,i){let n;const s={},r=i.levels,o={AUDIO:r.map((e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec}))),SUBTITLES:r.map((e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec}))),"CLOSED-CAPTIONS":[]};let a=0;for(bR.lastIndex=0;null!==(n=bR.exec(e));){const e=new JS(n[1]),r=e.TYPE;if(r){const n=o[r],c=s[r]||[];s[r]=c,hR(i,e,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const d=e.LANGUAGE,l=e["ASSOC-LANGUAGE"],h=e.CHANNELS,u=e.CHARACTERISTICS,p=e["INSTREAM-ID"],f={attrs:e,bitrate:0,id:a++,groupId:e["GROUP-ID"]||"",name:e.NAME||d||"",type:r,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:d,url:e.URI?NR.resolve(e.URI,t):""};if(l&&(f.assocLang=l),h&&(f.channels=h),u&&(f.characteristics=u),p&&(f.instreamId=p),null!=n&&n.length){const e=NR.findGroup(n,f.groupId)||n[0];MR(f,e,"audioCodec"),MR(f,e,"textCodec")}c.push(f)}}return s}static parseLevelPlaylist(e,t,i,n,s,r){const o=new rv(t),a=o.fragments;let c,d,l,h=null,u=0,p=0,f=0,m=0,E=null,_=new nv(n,t),g=-1,T=!1,S=null;for(DR.lastIndex=0,o.m3u8=e,o.hasVariableRefs=lR(e);null!==(c=DR.exec(e));){T&&(T=!1,_=new nv(n,t),_.start=f,_.sn=u,_.cc=m,_.level=i,h&&(_.initSegment=h,_.rawProgramDateTime=h.rawProgramDateTime,h.rawProgramDateTime=null,S&&(_.setByteRange(S),S=null)));const e=c[1];if(e){_.duration=parseFloat(e);const t=(" "+c[2]).slice(1);_.title=t||null,_.tagList.push(t?["INF",e,t]:["INF",e])}else if(c[3]){if(FS(_.duration)){_.start=f,l&&FR(_,l,o),_.sn=u,_.level=i,_.cc=m,a.push(_);const e=(" "+c[3]).slice(1);_.relurl=uR(o,e),UR(_,E),E=_,f+=_.duration,u++,p=0,T=!0}}else if(c[4]){const e=(" "+c[4]).slice(1);E?_.setByteRange(e,E):_.setByteRange(e)}else if(c[5])_.rawProgramDateTime=(" "+c[5]).slice(1),_.tagList.push(["PROGRAM-DATE-TIME",_.rawProgramDateTime]),-1===g&&(g=a.length);else{if(c=c[0].match(OR),!c){$S.warn("No matches on slow regex match for level playlist!");continue}for(d=1;d<c.length&&void 0===c[d];d++);const e=(" "+c[d]).slice(1),s=(" "+c[d+1]).slice(1),f=c[d+2]?(" "+c[d+2]).slice(1):"";switch(e){case"PLAYLIST-TYPE":o.type=s.toUpperCase();break;case"MEDIA-SEQUENCE":u=o.startSN=parseInt(s);break;case"SKIP":{const e=new JS(s);hR(o,e,["RECENTLY-REMOVED-DATERANGES"]);const t=e.decimalInteger("SKIPPED-SEGMENTS");if(FS(t)){o.skippedSegments=t;for(let e=t;e--;)a.unshift(null);u+=t}const i=e.enumeratedString("RECENTLY-REMOVED-DATERANGES");i&&(o.recentlyRemovedDateranges=i.split("\t"));break}case"TARGETDURATION":o.targetduration=Math.max(parseInt(s),1);break;case"VERSION":o.version=parseInt(s);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":o.live=!1;break;case"#":(s||f)&&_.tagList.push(f?[s,f]:[s]);break;case"DISCONTINUITY":m++,_.tagList.push(["DIS"]);break;case"GAP":_.gap=!0,_.tagList.push([e]);break;case"BITRATE":_.tagList.push([e,s]);break;case"DATERANGE":{const e=new JS(s);hR(o,e,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),hR(o,e,e.clientAttrs);const t=new ZS(e,o.dateRanges[e.ID]);t.isValid||o.skippedSegments?o.dateRanges[t.id]=t:$S.warn(`Ignoring invalid DATERANGE tag: "${s}"`),_.tagList.push(["EXT-X-DATERANGE",s]);break}case"DEFINE":{const e=new JS(s);hR(o,e,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in e?fR(o,e,r):pR(o,e,t)}break;case"DISCONTINUITY-SEQUENCE":m=parseInt(s);break;case"KEY":{const e=LR(s,t,o);if(e.isSupported()){if("NONE"===e.method){l=void 0;break}l||(l={}),l[e.keyFormat]&&(l=xS({},l)),l[e.keyFormat]=e}else $S.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${s}"`);break}case"START":o.startTimeOffset=PR(s);break;case"MAP":{const e=new JS(s);if(hR(o,e,["BYTERANGE","URI"]),_.duration){const s=new nv(n,t);xR(s,e,i,l),h=s,_.initSegment=h,h.rawProgramDateTime&&!_.rawProgramDateTime&&(_.rawProgramDateTime=h.rawProgramDateTime)}else{const t=_.byteRangeEndOffset;if(t){const e=_.byteRangeStartOffset;S=`${t-e}@${e}`}else S=null;xR(_,e,i,l),h=_,T=!0}break}case"SERVER-CONTROL":{const e=new JS(s);o.canBlockReload=e.bool("CAN-BLOCK-RELOAD"),o.canSkipUntil=e.optionalFloat("CAN-SKIP-UNTIL",0),o.canSkipDateRanges=o.canSkipUntil>0&&e.bool("CAN-SKIP-DATERANGES"),o.partHoldBack=e.optionalFloat("PART-HOLD-BACK",0),o.holdBack=e.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const e=new JS(s);o.partTarget=e.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=o.partList;e||(e=o.partList=[]);const i=p>0?e[e.length-1]:void 0,n=p++,r=new JS(s);hR(o,r,["BYTERANGE","URI"]);const a=new sv(r,_,t,n,i);e.push(a),_.duration+=a.duration;break}case"PRELOAD-HINT":{const e=new JS(s);hR(o,e,["URI"]),o.preloadHint=e;break}case"RENDITION-REPORT":{const e=new JS(s);hR(o,e,["URI"]),o.renditionReports=o.renditionReports||[],o.renditionReports.push(e);break}default:$S.warn(`line parsed but not handled: ${c}`)}}}E&&!E.relurl?(a.pop(),f-=E.duration,o.partList&&(o.fragmentHint=E)):o.partList&&(UR(_,E),_.cc=m,o.fragmentHint=_,l&&FR(_,l,o));const v=a.length,R=a[0],y=a[v-1];if(f+=o.skippedSegments*o.targetduration,f>0&&v&&y){o.averagetargetduration=f/v;const e=y.sn;o.endSN="initSegment"!==e?e:0,o.live||(y.endList=!0),R&&(o.startCC=R.cc)}else o.endSN=0,o.startCC=0;return o.fragmentHint&&(f+=o.fragmentHint.duration),o.totalduration=f,o.endCC=m,g>0&&function(e,t){let i=e[t];for(let n=t;n--;){const t=e[n];if(!t)return;t.programDateTime=i.programDateTime-1e3*t.duration,i=t}}(a,g),o}}function LR(e,t,i){var n,s;const r=new JS(e);hR(i,r,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const o=null!=(n=r.METHOD)?n:"",a=r.URI,c=r.hexadecimalInteger("IV"),d=r.KEYFORMATVERSIONS,l=null!=(s=r.KEYFORMAT)?s:"identity";a&&r.IV&&!c&&$S.error(`Invalid IV: ${r.IV}`);const h=a?NR.resolve(a,t):"",u=(d||"1").split("/").map(Number).filter(Number.isFinite);return new cR(o,h,l,u,c)}function PR(e){const t=new JS(e).decimalFloatingPoint("TIME-OFFSET");return FS(t)?t:null}function kR(e,t){let i=(e||"").split(/[ ,]+/).filter((e=>e));["video","audio","text"].forEach((e=>{const n=i.filter((t=>function(e,t){const i=ER[t];return!!i&&!!i[e.slice(0,4)]}(t,e)));n.length&&(t[`${e}Codec`]=n.join(","),i=i.filter((e=>-1===n.indexOf(e))))})),t.unknownCodecs=i}function MR(e,t,i){const n=t[i];n&&(e[i]=n)}function UR(e,t){e.rawProgramDateTime?e.programDateTime=Date.parse(e.rawProgramDateTime):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime),FS(e.programDateTime)||(e.programDateTime=null,e.rawProgramDateTime=null)}function xR(e,t,i,n){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=i,e.sn="initSegment",n&&(e.levelkeys=n),e.initSegment=null}function FR(e,t,i){e.levelkeys=t;const{encryptedFragments:n}=i;n.length&&n[n.length-1].levelkeys===t||!Object.keys(t).some((e=>t[e].isCommonEncryption))||n.push(e)}var VR={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},BR={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function GR(e){const{type:t}=e;switch(t){case VR.AUDIO_TRACK:return BR.AUDIO;case VR.SUBTITLE_TRACK:return BR.SUBTITLE;default:return BR.MAIN}}function jR(e,t){let i=e.url;return void 0!==i&&0!==i.indexOf("data:")||(i=t.url),i}class WR{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.LEVEL_LOADING,this.onLevelLoading,this),e.on(GS.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(GS.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.LEVEL_LOADING,this.onLevelLoading,this),e.off(GS.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(GS.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,n=t.loader,s=new(i||n)(t);return this.loaders[e.type]=s,s}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:VR.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(e,t){const{id:i,level:n,pathwayId:s,url:r,deliveryDirectives:o}=t;this.load({id:i,level:n,pathwayId:s,responseType:"text",type:VR.LEVEL,url:r,deliveryDirectives:o})}onAudioTrackLoading(e,t){const{id:i,groupId:n,url:s,deliveryDirectives:r}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:VR.AUDIO_TRACK,url:s,deliveryDirectives:r})}onSubtitleTrackLoading(e,t){const{id:i,groupId:n,url:s,deliveryDirectives:r}=t;this.load({id:i,groupId:n,level:null,responseType:"text",type:VR.SUBTITLE_TRACK,url:s,deliveryDirectives:r})}load(e){var t;const i=this.hls.config;let n,s=this.getInternalLoader(e);if(s){const t=s.context;if(t&&t.url===e.url&&t.level===e.level)return void $S.trace("[playlist-loader]: playlist request ongoing");$S.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}if(n=e.type===VR.MANIFEST?i.manifestLoadPolicy.default:xS({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),FS(null==(t=e.deliveryDirectives)?void 0:t.part)){let t;if(e.type===VR.LEVEL&&null!==e.level?t=this.hls.levels[e.level].details:e.type===VR.AUDIO_TRACK&&null!==e.id?t=this.hls.audioTracks[e.id].details:e.type===VR.SUBTITLE_TRACK&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,i=t.targetduration;if(e&&i){const t=1e3*Math.max(3*e,.8*i);n=xS({},n,{maxTimeToFirstByteMs:Math.min(t,n.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,n.maxTimeToFirstByteMs)})}}}const r=n.errorRetry||n.timeoutRetry||{},o={loadPolicy:n,timeout:n.maxLoadTimeMs,maxRetry:r.maxNumRetry||0,retryDelay:r.retryDelayMs||0,maxRetryDelay:r.maxRetryDelayMs||0},a={onSuccess:(e,t,i,n)=>{const s=this.getInternalLoader(i);this.resetInternalLoader(i.type);const r=e.data;0===r.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),NR.isMediaPlaylist(r)?this.handleTrackOrLevelPlaylist(e,t,i,n||null,s):this.handleMasterPlaylist(e,t,i,n)):this.handleManifestParsingError(e,i,new Error("no EXTM3U delimiter"),n||null,t)},onError:(e,t,i,n)=>{this.handleNetworkError(t,i,!1,e,n)},onTimeout:(e,t,i)=>{this.handleNetworkError(t,i,!0,void 0,e)}};s.load(e,o,a)}handleMasterPlaylist(e,t,i,n){const s=this.hls,r=e.data,o=jR(e,i),a=NR.parseMasterPlaylist(r,o);if(a.playlistParsingError)return void this.handleManifestParsingError(e,i,a.playlistParsingError,n,t);const{contentSteering:c,levels:d,sessionData:l,sessionKeys:h,startTimeOffset:u,variableList:p}=a;this.variableList=p;const{AUDIO:f=[],SUBTITLES:m,"CLOSED-CAPTIONS":E}=NR.parseMasterPlaylistMedia(r,o,a);if(f.length){f.some((e=>!e.url))||!d[0].audioCodec||d[0].attrs.AUDIO||($S.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),f.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new JS({}),bitrate:0,url:""}))}s.trigger(GS.MANIFEST_LOADED,{levels:d,audioTracks:f,subtitles:m,captions:E,contentSteering:c,url:o,stats:t,networkDetails:n,sessionData:l,sessionKeys:h,startTimeOffset:u,variableList:p})}handleTrackOrLevelPlaylist(e,t,i,n,s){const r=this.hls,{id:o,level:a,type:c}=i,d=jR(e,i),l=FS(a)?a:FS(o)?o:0,h=GR(i),u=NR.parseLevelPlaylist(e.data,d,l,h,0,this.variableList);if(c===VR.MANIFEST){const e={attrs:new JS({}),bitrate:0,details:u,name:"",url:d};r.trigger(GS.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:d,stats:t,networkDetails:n,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=u,this.handlePlaylistLoaded(u,e,t,i,n,s)}handleManifestParsingError(e,t,i,n,s){this.hls.trigger(GS.ERROR,{type:jS.NETWORK_ERROR,details:WS.MANIFEST_PARSING_ERROR,fatal:t.type===VR.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:n,stats:s})}handleNetworkError(e,t,i=!1,n,s){let r=`A network ${i?"timeout":"error"+(n?" (status "+n.code+")":"")} occurred while loading ${e.type}`;e.type===VR.LEVEL?r+=`: ${e.level} id: ${e.id}`:e.type!==VR.AUDIO_TRACK&&e.type!==VR.SUBTITLE_TRACK||(r+=` id: ${e.id} group-id: "${e.groupId}"`);const o=new Error(r);$S.warn(`[playlist-loader]: ${r}`);let a=WS.UNKNOWN,c=!1;const d=this.getInternalLoader(e);switch(e.type){case VR.MANIFEST:a=i?WS.MANIFEST_LOAD_TIMEOUT:WS.MANIFEST_LOAD_ERROR,c=!0;break;case VR.LEVEL:a=i?WS.LEVEL_LOAD_TIMEOUT:WS.LEVEL_LOAD_ERROR,c=!1;break;case VR.AUDIO_TRACK:a=i?WS.AUDIO_TRACK_LOAD_TIMEOUT:WS.AUDIO_TRACK_LOAD_ERROR,c=!1;break;case VR.SUBTITLE_TRACK:a=i?WS.SUBTITLE_TRACK_LOAD_TIMEOUT:WS.SUBTITLE_LOAD_ERROR,c=!1}d&&this.resetInternalLoader(e.type);const l={type:jS.NETWORK_ERROR,details:a,fatal:c,url:e.url,loader:d,context:e,error:o,networkDetails:t,stats:s};if(n){const i=(null==t?void 0:t.url)||e.url;l.response=kS({url:i,data:void 0},n)}this.hls.trigger(GS.ERROR,l)}handlePlaylistLoaded(e,t,i,n,s,r){const o=this.hls,{type:a,level:c,id:d,groupId:l,deliveryDirectives:h}=n,u=jR(t,n),p=GR(n),f="number"==typeof n.level&&p===BR.MAIN?c:void 0;if(!e.fragments.length){const e=new Error("No Segments found in Playlist");return void o.trigger(GS.ERROR,{type:jS.NETWORK_ERROR,details:WS.LEVEL_EMPTY_ERROR,fatal:!1,url:u,error:e,reason:e.message,response:t,context:n,level:f,parent:p,networkDetails:s,stats:i})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const m=e.playlistParsingError;if(m)o.trigger(GS.ERROR,{type:jS.NETWORK_ERROR,details:WS.LEVEL_PARSING_ERROR,fatal:!1,url:u,error:m,reason:m.message,response:t,context:n,level:f,parent:p,networkDetails:s,stats:i});else switch(e.live&&r&&(r.getCacheAge&&(e.ageHeader=r.getCacheAge()||0),r.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),a){case VR.MANIFEST:case VR.LEVEL:o.trigger(GS.LEVEL_LOADED,{details:e,level:f||0,id:d||0,stats:i,networkDetails:s,deliveryDirectives:h});break;case VR.AUDIO_TRACK:o.trigger(GS.AUDIO_TRACK_LOADED,{details:e,id:d||0,groupId:l||"",stats:i,networkDetails:s,deliveryDirectives:h});break;case VR.SUBTITLE_TRACK:o.trigger(GS.SUBTITLE_TRACK_LOADED,{details:e,id:d||0,groupId:l||"",stats:i,networkDetails:s,deliveryDirectives:h})}}}function HR(e,t){let i;try{i=new Event("addtrack")}catch(e){i=document.createEvent("Event"),i.initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}function KR(e,t){const i=e.mode;if("disabled"===i&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(i){$S.debug(`[texttrack-utils]: ${i}`);try{const i=new self.TextTrackCue(t.startTime,t.endTime,t.text);i.id=t.id,e.addCue(i)}catch(e){$S.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${e}`)}}"disabled"===i&&(e.mode=i)}function YR(e){const t=e.mode;if("disabled"===t&&(e.mode="hidden"),e.cues)for(let t=e.cues.length;t--;)e.removeCue(e.cues[t]);"disabled"===t&&(e.mode=t)}function qR(e,t,i,n){const s=e.mode;if("disabled"===s&&(e.mode="hidden"),e.cues&&e.cues.length>0){const s=function(e,t,i){const n=[],s=function(e,t){if(t<e[0].startTime)return 0;const i=e.length-1;if(t>e[i].endTime)return-1;let n=0,s=i;for(;n<=s;){const r=Math.floor((s+n)/2);if(t<e[r].startTime)s=r-1;else{if(!(t>e[r].startTime&&n<i))return r;n=r+1}}return e[n].startTime-t<t-e[s].startTime?n:s}(e,t);if(s>-1)for(let r=s,o=e.length;r<o;r++){const s=e[r];if(s.startTime>=t&&s.endTime<=i)n.push(s);else if(s.startTime>i)return n}return n}(e.cues,t,i);for(let t=0;t<s.length;t++)n&&!n(s[t])||e.removeCue(s[t])}"disabled"===s&&(e.mode=s)}function $R(e){const t=[];for(let i=0;i<e.length;i++){const n=e[i];"subtitles"!==n.kind&&"captions"!==n.kind||!n.label||t.push(e[i])}return t}var zR="org.id3",XR="com.apple.quicktime.HLS",JR="https://aomedia.org/emsg/ID3";function QR(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function ZR(e,t,i,n,s){let r=new e(t,i,"");try{r.value=n,s&&(r.type=s)}catch(o){r=new e(t,i,JSON.stringify(s?kS({type:s},n):n))}return r}const ey=(()=>{const e=QR();try{e&&new e(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function ty(e,t){return e.getTime()/1e3-t}class iy{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(GS.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(GS.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(YR(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if("metadata"===i.kind&&"id3"===i.label)return HR(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:n}}}=this;if(!i&&!n)return;const{samples:s}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const r=QR();if(r)for(let e=0;e<s.length;e++){const t=s[e].type;if(t===JR&&!i||!n)continue;const o=bv(s[e].data);if(o){const i=s[e].pts;let n=i+s[e].duration;n>ey&&(n=ey);n-i<=0&&(n=i+.25);for(let e=0;e<o.length;e++){const s=o[e];if(!Iv(s)){this.updateId3CueEnds(i,t);const e=ZR(r,i,n,s,t);e&&this.id3Track.addCue(e)}}}}}updateId3CueEnds(e,t){var i;const n=null==(i=this.id3Track)?void 0:i.cues;if(n)for(let i=n.length;i--;){const s=n[i];s.type===t&&s.startTime<e&&s.endTime===ey&&(s.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:n}){const{id3Track:s,hls:r}=this;if(!r)return;const{config:{enableEmsgMetadataCues:o,enableID3MetadataCues:a}}=r;if(s&&(o||a)){let e;e="audio"===n?e=>e.type===zR&&a:"video"===n?e=>e.type===JR&&o:e=>e.type===zR&&a||e.type===JR&&o,qR(s,t,i,e)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:n}=this,{dateRanges:s}=t,r=Object.keys(s);if(n){const e=Object.keys(i).filter((e=>!r.includes(e)));for(let t=e.length;t--;){const s=e[t];Object.keys(i[s].cues).forEach((e=>{n.removeCue(i[s].cues[e])})),delete i[s]}}const o=t.fragments[t.fragments.length-1];if(0===r.length||!FS(null==o?void 0:o.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const a=o.programDateTime/1e3-o.start,c=QR();for(let e=0;e<r.length;e++){const t=r[e],n=s[t],o=ty(n.startDate,a),h=i[t],u=(null==h?void 0:h.cues)||{};let p=(null==h?void 0:h.durationKnown)||!1,f=ey;const m=n.endDate;if(m)f=ty(m,a),p=!0;else if(n.endOnNext&&!p){const e=r.reduce(((e,t)=>{if(t!==n.id){const i=s[t];if(i.class===n.class&&i.startDate>n.startDate&&(!e||n.startDate<e.startDate))return i}return e}),null);e&&(f=ty(e.startDate,a),p=!0)}const E=Object.keys(n.attr);for(let e=0;e<E.length;e++){const i=E[e];if("ID"===(l=i)||"CLASS"===l||"START-DATE"===l||"DURATION"===l||"END-DATE"===l||"END-ON-NEXT"===l)continue;const s=u[i];if(s)p&&!h.durationKnown&&(s.endTime=f);else if(c){let e=n.attr[i];QS(i)&&(d=e,e=Uint8Array.from(d.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);const s=ZR(c,o,f,{key:i,data:e},XR);s&&(s.id=t,this.id3Track.addCue(s),u[i]=s)}}i[t]={cues:u,dateRange:n,durationKnown:p}}var d,l}}class ny{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(null===e)return null;const{holdBack:t,partHoldBack:i,targetduration:n}=e,{liveSyncDuration:s,liveSyncDurationCount:r,lowLatencyMode:o}=this.config,a=this.hls.userConfig;let c=o&&i||t;(a.liveSyncDuration||a.liveSyncDurationCount||0===c)&&(c=void 0!==s?s:r*n);const d=n;return c+Math.min(1*this.stallCount,d)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,i=this.levelDetails;if(null===e||null===t||null===i)return null;const n=i.edge,s=e-t-this.edgeStalled,r=n-i.totalduration,o=n-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(r,s),o)}get drift(){const{levelDetails:e}=this;return null===e?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(GS.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(GS.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(GS.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(GS.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(GS.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(GS.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var i;t.details===WS.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(i=this.levelDetails)&&i.live&&$S.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(null===i)return;this._latency=i;const{lowLatencyMode:n,maxLiveSyncPlaybackRate:s}=this.config;if(!n||1===s||!t.live)return;const r=this.targetLatency;if(null===r)return;const o=i-r;if(o<Math.min(this.maxLatency,r+t.targetduration)&&o>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,s)),i=Math.round(2/(1+Math.exp(-.75*o-this.edgeStalled))*20)/20;e.playbackRate=Math.min(t,Math.max(1,i))}else 1!==e.playbackRate&&0!==e.playbackRate&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}const sy=["NONE","TYPE-0","TYPE-1",null];const ry=["SDR","PQ","HLG"];var oy={No:"",Yes:"YES",v2:"v2"};class ay{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class cy{constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter((e=>!!e)).map((e=>e.substring(0,4))).join(","),this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return dy(this._audioGroups,e)}hasSubtitleGroup(e){return dy(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t)if("audio"===e){let e=this._audioGroups;e||(e=this._audioGroups=[]),-1===e.indexOf(t)&&e.push(t)}else if("text"===e){let e=this._subtitleGroups;e||(e=this._subtitleGroups=[]),-1===e.indexOf(t)&&e.push(t)}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return null==(e=this.audioGroups)?void 0:e[0]}get textGroupId(){var e;return null==(e=this.subtitleGroups)?void 0:e[0]}addFallback(){}}function dy(e,t){return!(!t||!e)&&-1!==e.indexOf(t)}function ly(e,t){const i=t.startPTS;if(FS(i)){let n,s=0;t.sn>e.sn?(s=i-e.start,n=e):(s=e.start-i,n=t),n.duration!==s&&(n.duration=s)}else if(t.sn>e.sn){e.cc===t.cc&&e.minEndPTS?t.start=e.start+(e.minEndPTS-e.start):t.start=e.start+e.duration}else t.start=Math.max(e.start-t.duration,0)}function hy(e,t,i,n,s,r){n-i<=0&&($S.warn("Fragment should have a positive duration",t),n=i+t.duration,r=s+t.duration);let o=i,a=n;const c=t.startPTS,d=t.endPTS;if(FS(c)){const e=Math.abs(c-i);FS(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,o=Math.max(i,c),i=Math.min(i,c),s=Math.min(s,t.startDTS),a=Math.min(n,d),n=Math.max(n,d),r=Math.max(r,t.endDTS)}const l=i-t.start;0!==t.start&&(t.start=i),t.duration=n-t.start,t.startPTS=i,t.maxStartPTS=o,t.startDTS=s,t.endPTS=n,t.minEndPTS=a,t.endDTS=r;const h=t.sn;if(!e||h<e.startSN||h>e.endSN)return 0;let u;const p=h-e.startSN,f=e.fragments;for(f[p]=t,u=p;u>0;u--)ly(f[u],f[u-1]);for(u=p;u<f.length-1;u++)ly(f[u],f[u+1]);return e.fragmentHint&&ly(f[f.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,l}function uy(e,t){let i=null;const n=e.fragments;for(let e=n.length-1;e>=0;e--){const t=n[e].initSegment;if(t){i=t;break}}e.fragmentHint&&delete e.fragmentHint.endPTS;let s,r=0;if(function(e,t,i){const n=t.skippedSegments,s=Math.max(e.startSN,t.startSN)-t.startSN,r=(e.fragmentHint?1:0)+(n?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,o=t.startSN-e.startSN,a=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,c=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let e=s;e<=r;e++){const s=c[o+e];let r=a[e];n&&!r&&e<n&&(r=t.fragments[e]=s),s&&r&&i(s,r)}}(e,t,((e,n)=>{e.relurl&&(r=e.cc-n.cc),FS(e.startPTS)&&FS(e.endPTS)&&(n.start=n.startPTS=e.startPTS,n.startDTS=e.startDTS,n.maxStartPTS=e.maxStartPTS,n.endPTS=e.endPTS,n.endDTS=e.endDTS,n.minEndPTS=e.minEndPTS,n.duration=e.endPTS-e.startPTS,n.duration&&(s=n),t.PTSKnown=t.alignedSliding=!0),n.elementaryStreams=e.elementaryStreams,n.loader=e.loader,n.stats=e.stats,e.initSegment&&(n.initSegment=e.initSegment,i=e.initSegment)})),i){(t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments).forEach((e=>{var t;!e||e.initSegment&&e.initSegment.relurl!==(null==(t=i)?void 0:t.relurl)||(e.initSegment=i)}))}if(t.skippedSegments)if(t.deltaUpdateFailed=t.fragments.some((e=>!e)),t.deltaUpdateFailed){$S.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)t.fragments.shift();t.startSN=t.fragments[0].sn,t.startCC=t.fragments[0].cc}else t.canSkipDateRanges&&(t.dateRanges=function(e,t,i){const n=xS({},e);i&&i.forEach((e=>{delete n[e]}));return Object.keys(t).forEach((e=>{const i=new ZS(t[e].attr,n[e]);i.isValid?n[e]=i:$S.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(t[e].attr)}"`)})),n}(e.dateRanges,t.dateRanges,t.recentlyRemovedDateranges));const o=t.fragments;if(r){$S.warn("discontinuity sliding from playlist, take drift into account");for(let e=0;e<o.length;e++)o[e].cc+=r}t.skippedSegments&&(t.startCC=t.fragments[0].cc),function(e,t,i){if(e&&t){let n=0;for(let s=0,r=e.length;s<=r;s++){const r=e[s],o=t[s+n];r&&o&&r.index===o.index&&r.fragment.sn===o.fragment.sn?i(r,o):n--}}}(e.partList,t.partList,((e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats})),s?hy(t,s,s.startPTS,s.endPTS,s.startDTS,s.endDTS):py(e,t),o.length&&(t.totalduration=t.edge-o[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const a=t.advancedDateTime;if(t.advanced&&a){const e=t.edge;t.driftStart||(t.driftStartTime=a,t.driftStart=e),t.driftEndTime=a,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime}function py(e,t){const i=t.startSN+t.skippedSegments-e.startSN,n=e.fragments;i<0||i>=n.length||fy(t,n[i].start)}function fy(e,t){if(t){const i=e.fragments;for(let n=e.skippedSegments;n<i.length;n++)i[n].start+=t;e.fragmentHint&&(e.fragmentHint.start+=t)}}function my(e,t,i){var n;return null!=e&&e.details?Ey(null==(n=e.details)?void 0:n.partList,t,i):null}function Ey(e,t,i){if(e)for(let n=e.length;n--;){const s=e[n];if(s.index===i&&s.fragment.sn===t)return s}return null}function _y(e){e.forEach(((e,t)=>{const{details:i}=e;null!=i&&i.fragments&&i.fragments.forEach((e=>{e.level=t}))}))}function gy(e){switch(e.details){case WS.FRAG_LOAD_TIMEOUT:case WS.KEY_LOAD_TIMEOUT:case WS.LEVEL_LOAD_TIMEOUT:case WS.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function Ty(e,t){const i=gy(t);return e.default[(i?"timeout":"error")+"Retry"]}function Sy(e,t){const i="linear"===e.backoff?1:Math.pow(2,t);return Math.min(i*e.retryDelayMs,e.maxRetryDelayMs)}function vy(e){return kS(kS({},e),{errorRetry:null,timeoutRetry:null})}function Ry(e,t,i,n){if(!e)return!1;const s=null==n?void 0:n.code,r=t<e.maxNumRetry&&(function(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}(s)||!!i);return e.shouldRetry?e.shouldRetry(e,t,i,n,r):r}const yy={search:function(e,t){let i=0,n=e.length-1,s=null,r=null;for(;i<=n;){s=(i+n)/2|0,r=e[s];const o=t(r);if(o>0)i=s+1;else{if(!(o<0))return r;n=s-1}}return null}};function Cy(e,t,i=0,n=0){let s=null;if(e){s=t[e.sn-t[0].sn+1]||null;const n=e.endDTS-i;n>0&&n<15e-7&&(i+=15e-7)}else 0===i&&0===t[0].start&&(s=t[0]);if(s&&(!e||e.level===s.level)&&0===Iy(i,n,s))return s;const r=yy.search(t,Iy.bind(null,i,n));return!r||r===e&&s?s:r}function Iy(e=0,t=0,i){if(i.start<=e&&i.start+i.duration>e)return 0;const n=Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-n<=e?1:i.start-n>e&&i.start?-1:0}function Ay(e,t,i){const n=1e3*Math.min(t,i.duration+(i.deltaPTS?i.deltaPTS:0));return(i.endProgramDateTime||0)-n>e}var by=0,wy=2,Dy=3,Oy=5,Ny=0,Ly=1,Py=2;class ky{constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=$S.log.bind($S,`${t}:`),this.warn=$S.warn.bind($S,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t){const i=null==t?void 0:t.renditionReports;if(i){let n=-1;for(let s=0;s<i.length;s++){const r=i[s];let o;try{o=new self.URL(r.URI,t.url).href}catch(e){$S.warn(`Could not construct new URL for Rendition Report: ${e}`),o=r.URI||""}if(o===e){n=s;break}o===e.substring(0,o.length)&&(n=s)}if(-1!==n){const e=i[n],s=parseInt(e["LAST-MSN"])||(null==t?void 0:t.lastPartSn);let r=parseInt(e["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);r>=0&&e>t.partTarget&&(r+=1)}return new ay(s,r>=0?r:void 0,oy.No)}}}loadPlaylist(e){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return-1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,i){const{details:n,stats:s}=t,r=self.performance.now(),o=s.loading.first?Math.max(0,r-s.loading.first):0;if(n.advancedDateTime=Date.now()-o,n.live||null!=i&&i.live){if(n.reloaded(i),i&&this.log(`live playlist ${e} ${n.advanced?"REFRESHED "+n.lastPartSn+"-"+n.lastPartIndex:n.updated?"UPDATED":"MISSED"}`),i&&n.fragments.length>0&&uy(i,n),!this.canLoad||!n.live)return;let o,a,c;if(n.canBlockReload&&n.endSN&&n.advanced){const e=this.hls.config.lowLatencyMode,s=n.lastPartSn,r=n.endSN,d=n.lastPartIndex,l=s===r;-1!==d?(a=l?r+1:s,c=l?e?0:d:d+1):a=r+1;const h=n.age,u=h+n.ageHeader;let p=Math.min(u-n.partTarget,1.5*n.targetduration);if(p>0){if(i&&p>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${p} with playlist age: ${n.age}`),p=0;else{const e=Math.floor(p/n.targetduration);if(a+=e,void 0!==c){c+=Math.round(p%n.targetduration/n.partTarget)}this.log(`CDN Tune-in age: ${n.ageHeader}s last advanced ${h.toFixed(2)}s goal: ${p} skip sn ${e} to part ${c}`)}n.tuneInGoal=p}if(o=this.getDeliveryDirectives(n,t.deliveryDirectives,a,c),e||!l)return void this.loadPlaylist(o)}else(n.canBlockReload||n.canSkipUntil)&&(o=this.getDeliveryDirectives(n,t.deliveryDirectives,a,c));const d=this.hls.mainForwardBufferInfo,l=d?d.end-d.len:0,h=function(e,t=1/0){let i=1e3*e.targetduration;if(e.updated){const n=e.fragments,s=4;if(n.length&&i*s>t){const e=1e3*n[n.length-1].duration;e<i&&(i=e)}}else i/=2;return Math.round(i)}(n,1e3*(n.edge-l));n.updated&&r>this.requestScheduled+h&&(this.requestScheduled=s.loading.start),void 0!==a&&n.canBlockReload?this.requestScheduled=s.loading.first+h-(1e3*n.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+h<r?this.requestScheduled=r:this.requestScheduled-r<=0&&(this.requestScheduled+=h);let u=this.requestScheduled-r;u=Math.max(0,u),this.log(`reload live playlist ${e} in ${Math.round(u)} ms`),this.timer=self.setTimeout((()=>this.loadPlaylist(o)),u)}else this.clearTimer()}getDeliveryDirectives(e,t,i,n){let s=function(e,t){const{canSkipUntil:i,canSkipDateRanges:n,endSN:s}=e;return i&&(void 0!==t?t-s:0)<i?n?oy.v2:oy.Yes:oy.No}(e,i);return null!=t&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,n=t.part,s=oy.No),new ay(i,n,s)}checkRetry(e){const t=e.details,i=gy(e),n=e.errorAction,{action:s,retryCount:r=0,retryConfig:o}=n||{},a=!!n&&!!o&&(s===Oy||!n.resolved&&s===wy);if(a){var c;if(this.requestScheduled=-1,r>=o.maxNumRetry)return!1;if(i&&null!=(c=e.context)&&c.deliveryDirectives)this.warn(`Retrying playlist loading ${r+1}/${o.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const e=Sy(o,r);this.timer=self.setTimeout((()=>this.loadPlaylist()),e),this.warn(`Retrying playlist loading ${r+1}/${o.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,n.resolved=!0}return a}}class My{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class Uy{constructor(e,t,i,n=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new My(e),this.fast_=new My(t),this.defaultTTFB_=n,this.ttfb_=new My(e)}update(e,t){const{slow_:i,fast_:n,ttfb_:s}=this;i.halfLife!==e&&(this.slow_=new My(e,i.getEstimate(),i.getTotalWeight())),n.halfLife!==t&&(this.fast_=new My(t,n.getEstimate(),n.getTotalWeight())),s.halfLife!==e&&(this.ttfb_=new My(e,s.getEstimate(),s.getTotalWeight()))}sample(e,t){const i=(e=Math.max(e,this.minDelayMs_))/1e3,n=8*t/i;this.fast_.sample(i,n),this.slow_.sample(i,n)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const xy={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},Fy={};function Vy(e,t,i,n,s,r){const o=e.audioCodec?e.audioGroups:null,a=null==r?void 0:r.audioCodec,c=null==r?void 0:r.channels,d=c?parseInt(c):a?1/0:2;let l=null;if(null!=o&&o.length)try{l=1===o.length&&o[0]?t.groups[o[0]].channels:o.reduce(((e,i)=>{if(i){const n=t.groups[i];if(!n)throw new Error(`Audio track group ${i} not found`);Object.keys(n.channels).forEach((t=>{e[t]=(e[t]||0)+n.channels[t]}))}return e}),{2:0})}catch(e){return!0}return void 0!==e.videoCodec&&(e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(n,30)||"SDR"!==e.videoRange&&e.videoRange!==i||e.bitrate>Math.max(s,8e6))||!!l&&FS(d)&&Object.keys(l).some((e=>parseInt(e)>d))}function By(e,t,i){const n=e.videoCodec,s=e.audioCodec;if(!n||!s||!i)return Promise.resolve(xy);const r={width:e.width,height:e.height,bitrate:Math.ceil(Math.max(.9*e.bitrate,e.averageBitrate)),framerate:e.frameRate||30},o=e.videoRange;"SDR"!==o&&(r.transferFunction=o.toLowerCase());const a=n.split(",").map((e=>({type:"media-source",video:kS(kS({},r),{},{contentType:TR(e,"video")})})));return s&&e.audioGroups&&e.audioGroups.forEach((e=>{var i;e&&(null==(i=t.groups[e])||i.tracks.forEach((t=>{if(t.groupId===e){const e=t.channels||"",i=parseFloat(e);FS(i)&&i>2&&a.push.apply(a,s.split(",").map((e=>({type:"media-source",audio:{contentType:TR(e,"audio"),channels:""+i}}))))}})))})),Promise.all(a.map((e=>{const t=function(e){const{audio:t,video:i}=e,n=i||t;if(n){const e=n.contentType.split('"')[1];if(i)return`r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${e}_${Math.ceil(i.bitrate/1e5)}`;if(t)return`c${t.channels}${t.spatialRendering?"s":"n"}_${e}`}return""}(e);return Fy[t]||(Fy[t]=i.decodingInfo(e))}))).then((e=>({supported:!e.some((e=>!e.supported)),configurations:a,decodingInfoResults:e}))).catch((e=>({supported:!1,configurations:a,decodingInfoResults:[],error:e})))}function Gy(e,t){let i=!1,n=[];return e&&(i="SDR"!==e,n=[e]),t&&(n=t.allowedVideoRanges||ry.slice(0),i=void 0!==t.preferHDR?t.preferHDR:function(){if("function"==typeof matchMedia){const e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return!0===e.matches}return!1}(),n=i?n.filter((e=>"SDR"!==e)):["SDR"]),{preferHDR:i,allowedVideoRanges:n}}function jy(e,t){$S.log(`[abr] start candidates with "${e}" ignored because ${t}`)}function Wy(e,t,i){if("attrs"in e){const i=t.indexOf(e);if(-1!==i)return i}for(let n=0;n<t.length;n++){if(Hy(e,t[n],i))return n}return-1}function Hy(e,t,i){const{groupId:n,name:s,lang:r,assocLang:o,characteristics:a,default:c}=e,d=e.forced;return(void 0===n||t.groupId===n)&&(void 0===s||t.name===s)&&(void 0===r||t.lang===r)&&(void 0===r||t.assocLang===o)&&(void 0===c||t.default===c)&&(void 0===d||t.forced===d)&&(void 0===a||function(e,t=""){const i=e.split(","),n=t.split(",");return i.length===n.length&&!i.some((e=>-1===n.indexOf(e)))}(a,t.characteristics))&&(void 0===i||i(e,t))}function Ky(e,t){const{audioCodec:i,channels:n}=e;return!(void 0!==i&&(t.audioCodec||"").substring(0,4)!==i.substring(0,4)||void 0!==n&&n!==(t.channels||"2"))}function Yy(e,t,i){for(let n=t;n;n--)if(i(e[n]))return n;for(let n=t+1;n<e.length;n++)if(i(e[n]))return n;return-1}class qy{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var $y="NOT_LOADED",zy="APPENDING",Xy="PARTIAL",Jy="OK";class Qy{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(GS.BUFFER_APPENDED,this.onBufferAppended,this),e.on(GS.FRAG_BUFFERED,this.onFragBuffered,this),e.on(GS.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(GS.BUFFER_APPENDED,this.onBufferAppended,this),e.off(GS.FRAG_BUFFERED,this.onFragBuffered,this),e.off(GS.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let t=i.length;t--;){const n=i[t];if(!n)break;const s=n.end;if(n.start<=e&&null!==s&&e<=s)return n}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:i}=this,n=Object.keys(i);for(let s=n.length;s--;){const r=i[n[s]];if((null==r?void 0:r.body.type)===t&&r.buffered){const t=r.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,i,n){this.timeRanges&&(this.timeRanges[e]=t);const s=(null==n?void 0:n.fragment.sn)||-1;Object.keys(this.fragments).forEach((n=>{const r=this.fragments[n];if(!r)return;if(s>=r.body.sn)return;if(!r.buffered&&!r.loaded)return void(r.body.type===i&&this.removeFragment(r.body));const o=r.range[e];o&&o.time.some((e=>{const i=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return i&&this.removeFragment(r.body),i}))}))}detectPartialFragments(e){const t=this.timeRanges,{frag:i,part:n}=e;if(!t||"initSegment"===i.sn)return;const s=eC(i),r=this.fragments[s];if(!r||r.buffered&&i.gap)return;const o=!i.relurl;if(Object.keys(t).forEach((e=>{const s=i.elementaryStreams[e];if(!s)return;const a=t[e],c=o||!0===s.partial;r.range[e]=this.getBufferedTimes(i,n,c,a)})),r.loaded=null,Object.keys(r.range).length){r.buffered=!0;(r.body.endList=i.endList||r.body.endList)&&(this.endListFragments[r.body.type]=r),Zy(r)||this.removeParts(i.sn-1,i.type)}else this.removeFragment(r.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=i.filter((t=>t.fragment.sn>=e)))}fragBuffered(e,t){const i=eC(e);let n=this.fragments[i];!n&&t&&(n=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),n&&(n.loaded=null,n.buffered=!0)}getBufferedTimes(e,t,i,n){const s={time:[],partial:i},r=e.start,o=e.end,a=e.minEndPTS||o,c=e.maxStartPTS||r;for(let e=0;e<n.length;e++){const t=n.start(e)-this.bufferPadding,i=n.end(e)+this.bufferPadding;if(c>=t&&a<=i){s.time.push({startPTS:Math.max(r,n.start(e)),endPTS:Math.min(o,n.end(e))});break}if(r<i&&o>t){const t=Math.max(r,n.start(e)),i=Math.min(o,n.end(e));i>t&&(s.partial=!0,s.time.push({startPTS:t,endPTS:i}))}else if(o<=t)break}return s}getPartialFragment(e){let t,i,n,s=null,r=0;const{bufferPadding:o,fragments:a}=this;return Object.keys(a).forEach((c=>{const d=a[c];d&&Zy(d)&&(i=d.body.start-o,n=d.body.end+o,e>=i&&e<=n&&(t=Math.min(e-i,n-e),r<=t&&(s=d.body,r=t)))})),s}isEndListAppended(e){const t=this.endListFragments[e];return void 0!==t&&(t.buffered||Zy(t))}getState(e){const t=eC(e),i=this.fragments[t];return i?i.buffered?Zy(i)?Xy:Jy:zy:$y}isTimeBuffered(e,t,i){let n,s;for(let r=0;r<i.length;r++){if(n=i.start(r)-this.bufferPadding,s=i.end(r)+this.bufferPadding,e>=n&&t<=s)return!0;if(t<=n)return!1}return!1}onFragLoaded(e,t){const{frag:i,part:n}=t;if("initSegment"===i.sn||i.bitrateTest)return;const s=n?null:t,r=eC(i);this.fragments[r]={body:i,appendedPTS:null,loaded:s,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:n,timeRanges:s}=t;if("initSegment"===i.sn)return;const r=i.type;if(n){let e=this.activePartLists[r];e||(this.activePartLists[r]=e=[]),e.push(n)}this.timeRanges=s,Object.keys(s).forEach((e=>{const t=s[e];this.detectEvictedFragments(e,t,r,n)}))}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=eC(e);return!!this.fragments[t]}hasParts(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}removeFragmentsInRange(e,t,i,n,s){n&&!this.hasGaps||Object.keys(this.fragments).forEach((r=>{const o=this.fragments[r];if(!o)return;const a=o.body;a.type!==i||n&&!a.gap||a.start<t&&a.end>e&&(o.buffered||s)&&this.removeFragment(a)}))}removeFragment(e){const t=eC(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const t=e.sn;this.activePartLists[e.type]=i.filter((e=>e.fragment.sn!==t))}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function Zy(e){var t,i,n;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(i=e.range.audio)?void 0:i.partial)||(null==(n=e.range.audiovideo)?void 0:n.partial))}function eC(e){return`${e.type}_${e.level}_${e.sn}`}const tC={length:0,start:()=>0,end:()=>0};class iC{static isBuffered(e,t){try{if(e){const i=iC.getBuffered(e);for(let e=0;e<i.length;e++)if(t>=i.start(e)&&t<=i.end(e))return!0}}catch(e){}return!1}static bufferInfo(e,t,i){try{if(e){const n=iC.getBuffered(e),s=[];let r;for(r=0;r<n.length;r++)s.push({start:n.start(r),end:n.end(r)});return this.bufferedInfo(s,t,i)}}catch(e){}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.sort((function(e,t){const i=e.start-t.start;return i||t.end-e.end}));let n=[];if(i)for(let t=0;t<e.length;t++){const s=n.length;if(s){const r=n[s-1].end;e[t].start-r<i?e[t].end>r&&(n[s-1].end=e[t].end):n.push(e[t])}else n.push(e[t])}else n=e;let s,r=0,o=t,a=t;for(let e=0;e<n.length;e++){const c=n[e].start,d=n[e].end;if(t+i>=c&&t<d)o=c,a=d,r=a-t;else if(t+i<c){s=c;break}}return{len:r,start:o||0,end:a||0,nextStart:s}}static getBuffered(e){try{return e.buffered}catch(e){return $S.log("failed to get media.buffered",e),tC}}}class nC{constructor(e,t,i,n=0,s=-1,r=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=i,this.size=n,this.part=s,this.partial=r}}function sC(e,t){for(let n=0,s=e.length;n<s;n++){var i;if((null==(i=e[n])?void 0:i.cc)===t)return e[n]}return null}function rC(e,t){if(e){const i=e.start+t;e.start=e.startPTS=i,e.endPTS=i+e.duration}}function oC(e,t){const i=t.fragments;for(let t=0,n=i.length;t<n;t++)rC(i[t],e);t.fragmentHint&&rC(t.fragmentHint,e),t.alignedSliding=!0}function aC(e,t,i){t&&(!function(e,t,i){if(function(e,t,i){return!(!t||!(i.endCC>i.startCC||e&&e.cc<i.startCC))}(e,i,t)){const e=function(e,t){const i=e.fragments,n=t.fragments;if(!n.length||!i.length)return void $S.log("No fragments to align");const s=sC(i,n[0].cc);if(s&&(!s||s.startPTS))return s;$S.log("No frag in previous level to align on")}(i,t);e&&FS(e.start)&&($S.log(`Adjusting PTS using last level due to CC increase within current level ${t.url}`),oC(e.start,t))}}(e,i,t),!i.alignedSliding&&t&&cC(i,t),i.alignedSliding||!t||i.skippedSegments||py(t,i))}function cC(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;const i=e.fragments,n=t.fragments;if(!i.length||!n.length)return;let s,r;const o=Math.min(t.endCC,e.endCC);t.startCC<o&&e.startCC<o&&(s=sC(n,o),r=sC(i,o)),s&&r||(s=n[Math.floor(n.length/2)],r=sC(i,s.cc)||i[Math.floor(i.length/2)]);const a=s.programDateTime,c=r.programDateTime;if(!a||!c)return;oC((c-a)/1e3-(r.start-s.start),e)}const dC=Math.pow(2,17);class lC{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new pC({type:jS.NETWORK_ERROR,details:WS.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(i?"part list":"url")),networkDetails:null}));this.abort();const n=this.config,s=n.fLoader,r=n.loader;return new Promise(((o,a)=>{if(this.loader&&this.loader.destroy(),e.gap){if(e.tagList.some((e=>"GAP"===e[0])))return void a(uC(e));e.gap=!1}const c=this.loader=e.loader=s?new s(n):new r(n),d=hC(e),l=vy(n.fragLoadPolicy.default),h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:dC};e.stats=c.stats,c.load(d,h,{onSuccess:(t,i,n,s)=>{this.resetLoader(e,c);let r=t.data;n.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(r.slice(0,16)),r=r.slice(16)),o({frag:e,part:null,payload:r,networkDetails:s})},onError:(t,n,s,r)=>{this.resetLoader(e,c),a(new pC({type:jS.NETWORK_ERROR,details:WS.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:kS({url:i,data:void 0},t),error:new Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:s,stats:r}))},onAbort:(t,i,n)=>{this.resetLoader(e,c),a(new pC({type:jS.NETWORK_ERROR,details:WS.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:n,stats:t}))},onTimeout:(t,i,n)=>{this.resetLoader(e,c),a(new pC({type:jS.NETWORK_ERROR,details:WS.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${h.timeout}ms`),networkDetails:n,stats:t}))},onProgress:(i,n,s,r)=>{t&&t({frag:e,part:null,payload:s,networkDetails:r})}})}))}loadPart(e,t,i){this.abort();const n=this.config,s=n.fLoader,r=n.loader;return new Promise(((o,a)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap)return void a(uC(e,t));const c=this.loader=e.loader=s?new s(n):new r(n),d=hC(e,t),l=vy(n.fragLoadPolicy.default),h={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:dC};t.stats=c.stats,c.load(d,h,{onSuccess:(n,s,r,a)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const d={frag:e,part:t,payload:n.data,networkDetails:a};i(d),o(d)},onError:(i,n,s,r)=>{this.resetLoader(e,c),a(new pC({type:jS.NETWORK_ERROR,details:WS.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:kS({url:d.url,data:void 0},i),error:new Error(`HTTP Error ${i.code} ${i.text}`),networkDetails:s,stats:r}))},onAbort:(i,n,s)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),a(new pC({type:jS.NETWORK_ERROR,details:WS.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:s,stats:i}))},onTimeout:(i,n,s)=>{this.resetLoader(e,c),a(new pC({type:jS.NETWORK_ERROR,details:WS.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${h.timeout}ms`),networkDetails:s,stats:i}))}})}))}updateStatsFromPart(e,t){const i=e.stats,n=t.stats,s=n.total;if(i.loaded+=n.loaded,s){const n=Math.round(e.duration/t.duration),r=Math.min(Math.round(i.loaded/s),n),o=(n-r)*Math.round(i.loaded/r);i.total=i.loaded+o}else i.total=Math.max(i.loaded,i.total);const r=i.loading,o=n.loading;r.start?r.first+=o.first-o.start:(r.start=o.start,r.first=o.first),r.end=o.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function hC(e,t=null){const i=t||e,n={frag:e,part:t,responseType:"arraybuffer",url:i.url,headers:{},rangeStart:0,rangeEnd:0},s=i.byteRangeStartOffset,r=i.byteRangeEndOffset;if(FS(s)&&FS(r)){var o;let t=s,i=r;if("initSegment"===e.sn&&"AES-128"===(null==(o=e.decryptdata)?void 0:o.method)){const e=r-s;e%16&&(i=r+(16-e%16)),0!==s&&(n.resetIV=!0,t=s-16)}n.rangeStart=t,n.rangeEnd=i}return n}function uC(e,t){const i=new Error(`GAP ${e.gap?"tag":"attribute"} found`),n={type:jS.MEDIA_ERROR,details:WS.FRAG_GAP,fatal:!1,frag:e,error:i,networkDetails:null};return t&&(n.part=t),(t||e).stats.aborted=!0,new pC(n)}class pC extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class fC{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class mC{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}class EC{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let e=0;e<4;e++)i[e]=t.getUint32(4*e);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,n=i[0],s=i[1],r=i[2],o=i[3],a=this.invSubMix,c=a[0],d=a[1],l=a[2],h=a[3],u=new Uint32Array(256);let p=0,f=0,m=0;for(m=0;m<256;m++)u[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){let i=f^f<<1^f<<2^f<<3^f<<4;i=i>>>8^255&i^99,e[p]=i,t[i]=p;const a=u[p],m=u[a],E=u[m];let _=257*u[i]^16843008*i;n[p]=_<<24|_>>>8,s[p]=_<<16|_>>>16,r[p]=_<<8|_>>>24,o[p]=_,_=16843009*E^65537*m^257*a^16843008*p,c[i]=_<<24|_>>>8,d[i]=_<<16|_>>>16,l[i]=_<<8|_>>>24,h[i]=_,p?(p=a^u[u[u[E^a]]],f^=u[u[f]]):p=f=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,n=0;for(;n<t.length&&i;)i=t[n]===this.key[n],n++;if(i)return;this.key=t;const s=this.keySize=t.length;if(4!==s&&6!==s&&8!==s)throw new Error("Invalid aes key size="+s);const r=this.ksRows=4*(s+6+1);let o,a;const c=this.keySchedule=new Uint32Array(r),d=this.invKeySchedule=new Uint32Array(r),l=this.sBox,h=this.rcon,u=this.invSubMix,p=u[0],f=u[1],m=u[2],E=u[3];let _,g;for(o=0;o<r;o++)o<s?_=c[o]=t[o]:(g=_,o%s==0?(g=g<<8|g>>>24,g=l[g>>>24]<<24|l[g>>>16&255]<<16|l[g>>>8&255]<<8|l[255&g],g^=h[o/s|0]<<24):s>6&&o%s==4&&(g=l[g>>>24]<<24|l[g>>>16&255]<<16|l[g>>>8&255]<<8|l[255&g]),c[o]=_=(c[o-s]^g)>>>0);for(a=0;a<r;a++)o=r-a,g=3&a?c[o]:c[o-4],d[a]=a<4||o<=4?g:p[l[g>>>24]]^f[l[g>>>16&255]]^m[l[g>>>8&255]]^E[l[255&g]],d[a]=d[a]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){const n=this.keySize+6,s=this.invKeySchedule,r=this.invSBox,o=this.invSubMix,a=o[0],c=o[1],d=o[2],l=o[3],h=this.uint8ArrayToUint32Array_(i);let u=h[0],p=h[1],f=h[2],m=h[3];const E=new Int32Array(e),_=new Int32Array(E.length);let g,T,S,v,R,y,C,I,A,b,w,D,O,N;const L=this.networkToHostOrderSwap;for(;t<E.length;){for(A=L(E[t]),b=L(E[t+1]),w=L(E[t+2]),D=L(E[t+3]),R=A^s[0],y=D^s[1],C=w^s[2],I=b^s[3],O=4,N=1;N<n;N++)g=a[R>>>24]^c[y>>16&255]^d[C>>8&255]^l[255&I]^s[O],T=a[y>>>24]^c[C>>16&255]^d[I>>8&255]^l[255&R]^s[O+1],S=a[C>>>24]^c[I>>16&255]^d[R>>8&255]^l[255&y]^s[O+2],v=a[I>>>24]^c[R>>16&255]^d[y>>8&255]^l[255&C]^s[O+3],R=g,y=T,C=S,I=v,O+=4;g=r[R>>>24]<<24^r[y>>16&255]<<16^r[C>>8&255]<<8^r[255&I]^s[O],T=r[y>>>24]<<24^r[C>>16&255]<<16^r[I>>8&255]<<8^r[255&R]^s[O+1],S=r[C>>>24]<<24^r[I>>16&255]<<16^r[R>>8&255]<<8^r[255&y]^s[O+2],v=r[I>>>24]<<24^r[R>>16&255]<<16^r[y>>8&255]<<8^r[255&C]^s[O+3],_[t]=L(g^u),_[t+1]=L(v^p),_[t+2]=L(S^f),_[t+3]=L(T^m),u=A,p=b,f=w,m=D,t+=4}return _.buffer}}class _C{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e){}null===this.subtle&&(this.useSoftware=!0)}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?function(e){const t=e.byteLength,i=t&&new DataView(e.buffer).getUint8(t-1);return i?gv(e,0,t-i):e}(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i){return this.useSoftware?new Promise(((n,s)=>{this.softwareDecrypt(new Uint8Array(e),t,i);const r=this.flush();r?n(r.buffer):s(new Error("[softwareDecrypt] Failed to decrypt data"))})):this.webCryptoDecrypt(new Uint8Array(e),t,i)}softwareDecrypt(e,t,i){const{currentIV:n,currentResult:s,remainderData:r}=this;this.logOnce("JS AES decrypt"),r&&(e=tR(r,e),this.remainderData=null);const o=this.getValidChunk(e);if(!o.length)return null;n&&(i=n);let a=this.softwareDecrypter;a||(a=this.softwareDecrypter=new EC),a.expandKey(t);const c=s;return this.currentResult=a.decrypt(o.buffer,0,i),this.currentIV=gv(o,-16).buffer,c||null}webCryptoDecrypt(e,t,i){const n=this.subtle;return this.key===t&&this.fastAesKey||(this.key=t,this.fastAesKey=new mC(n,t)),this.fastAesKey.expandKey().then((t=>{if(!n)return Promise.reject(new Error("web crypto not initialized"));this.logOnce("WebCrypto AES decrypt");return new fC(n,new Uint8Array(i)).decrypt(e.buffer,t)})).catch((n=>($S.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${n.name}: ${n.message}`),this.onWebCryptoError(e,t,i))))}onWebCryptoError(e,t,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i);const n=this.flush();if(n)return n.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%16;return i!==e.length&&(t=gv(e,0,i),this.remainderData=gv(e,i)),t}logOnce(e){this.logEnabled&&($S.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const gC=function(e){let t="";const i=e.length;for(let n=0;n<i;n++)t+=`[${e.start(n).toFixed(3)}-${e.end(n).toFixed(3)}]`;return t},TC="STOPPED",SC="IDLE",vC="KEY_LOADING",RC="FRAG_LOADING",yC="FRAG_LOADING_WAITING_RETRY",CC="WAITING_TRACK",IC="PARSING",AC="PARSED",bC="ENDED",wC="ERROR",DC="WAITING_INIT_PTS",OC="WAITING_LEVEL";class NC extends qy{constructor(e,t,i,n,s){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=TC,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=s,this.logPrefix=n,this.log=$S.log.bind($S,`${n}:`),this.warn=$S.warn.bind($S,`${n}:`),this.hls=e,this.fragmentLoader=new lC(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new _C(e.config),e.on(GS.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=TC}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const i=t.partList;if(null!=i&&i.length){const e=i[i.length-1];return iC.isBuffered(this.media,e.start+e.duration/2)}const n=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(n)}getLevelDetails(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levelLastLoaded)?void 0:e.details}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const n=this.config;this.levels&&n.autoStartLoad&&this.state===TC&&this.startLoad(n.startPosition)}onMediaDetaching(){const e=this.media;null!=e&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:i,mediaBuffer:n,state:s}=this,r=i?i.currentTime:0,o=iC.bufferInfo(n||i,r,e.maxBufferHole);if(this.log(`media seeking to ${FS(r)?r.toFixed(3):r}, state: ${s}`),this.state===bC)this.resetLoadingState();else if(t){const i=e.maxFragLookUpTolerance,n=t.start-i,s=t.start+t.duration+i;if(!o.len||s<o.start||n>o.end){const e=r>s;(r<n||e)&&(e&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(r,1/0,this.playlistType,!0),this.lastCurrentTime=r),this.loadedmetadata||o.len||(this.nextLoadPosition=this.startPosition=r),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(GS.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=TC,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){this._doFragLoad(e,t,i,(t=>{if(this.fragContextChanged(e))return this.warn(`Fragment ${e.sn}${t.part?" p: "+t.part.index:""} of level ${e.level} was dropped during download.`),void this.fragmentTracker.removeFragment(e);e.stats.chunkCount++,this._handleFragmentLoadProgress(t)})).then((t=>{if(!t)return;const i=this.state;this.fragContextChanged(e)?(i===RC||!this.fragCurrent&&i===IC)&&(this.fragmentTracker.removeFragment(e),this.state=SC):("payload"in t&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(GS.FRAG_LOADED,t)),this._handleFragmentLoadComplete(t))})).catch((t=>{this.state!==TC&&this.state!==wC&&(this.warn(t),this.resetFragmentLoading(e))}))}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===zy){const t=e.type,n=this.getFwdBufferInfo(this.mediaBuffer,t),s=Math.max(e.duration,n?n.len:this.config.maxBufferLength);this.reduceMaxBufferLength(s)&&i.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===Xy&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const n={startOffset:e,endOffset:t,type:i};this.hls.trigger(GS.BUFFER_FLUSHING,n)}_loadInitSegment(e,t){this._doFragLoad(e,t).then((t=>{if(!t||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return t})).then((t=>{const{hls:i}=this,{payload:n}=t,s=e.decryptdata;if(n&&n.byteLength>0&&null!=s&&s.key&&s.iv&&"AES-128"===s.method){const r=self.performance.now();return this.decrypter.decrypt(new Uint8Array(n),s.key.buffer,s.iv.buffer).catch((t=>{throw i.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t})).then((n=>{const s=self.performance.now();return i.trigger(GS.FRAG_DECRYPTED,{frag:e,payload:n,stats:{tstart:r,tdecrypt:s}}),t.payload=n,this.completeInitSegmentLoad(t)}))}return this.completeInitSegmentLoad(t)})).catch((t=>{this.state!==TC&&this.state!==wC&&(this.warn(t),this.resetFragmentLoading(e))}))}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state=SC,e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){var i,n,s,r;const o=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===BR.MAIN?"level":"track"} ${e.level} (frag:[${(null!=(i=e.startPTS)?i:NaN).toFixed(3)}-${(null!=(n=e.endPTS)?n:NaN).toFixed(3)}] > buffer:${o?gC(iC.getBuffered(o)):"(detached)"})`),"initSegment"!==e.sn){var a;if(e.type!==BR.SUBTITLE){const t=e.elementaryStreams;if(!Object.keys(t).some((e=>!!t[e])))return void(this.state=SC)}const t=null==(a=this.levels)?void 0:a[e.level];null!=t&&t.fragmentError&&(this.log(`Resetting level fragment error count of ${t.fragmentError} on frag buffered`),t.fragmentError=0)}this.state=SC,o&&(!this.loadedmetadata&&e.type==BR.MAIN&&o.buffered.length&&(null==(s=this.fragCurrent)?void 0:s.sn)===(null==(r=this.fragPrevious)?void 0:r.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:n,partsLoaded:s}=e,r=!s||0===s.length||s.some((e=>!e)),o=new nC(i.level,i.sn,i.stats.chunkCount+1,0,n?n.index:-1,!r);t.flush(o)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,n){var s;const r=null==t?void 0:t.details;if(!this.levels||!r)throw new Error(`frag load aborted, missing level${r?"":" detail"}s`);let o=null;if(!e.encrypted||null!=(s=e.decryptdata)&&s.key?!e.encrypted&&r.encryptedFragments.length&&this.keyLoader.loadClear(e,r.encryptedFragments):(this.log(`Loading key for ${e.sn} of [${r.startSN}-${r.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${e.level}`),this.state=vC,this.fragCurrent=e,o=this.keyLoader.load(e).then((e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(GS.KEY_LOADED,e),this.state===vC&&(this.state=SC),e})),this.hls.trigger(GS.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))),i=Math.max(e.start,i||0),this.config.lowLatencyMode&&"initSegment"!==e.sn){const s=r.partList;if(s&&n){i>e.end&&r.fragmentHint&&(e=r.fragmentHint);const a=this.getNextPart(s,e,i);if(a>-1){const c=s[a];let d;return this.log(`Loading part sn: ${e.sn} p: ${c.index} cc: ${e.cc} of playlist [${r.startSN}-${r.endSN}] parts [0-${a}-${s.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=c.start+c.duration,this.state=RC,d=o?o.then((i=>!i||this.fragContextChanged(i.frag)?null:this.doFragPartsLoad(e,c,t,n))).catch((e=>this.handleFragLoadError(e))):this.doFragPartsLoad(e,c,t,n).catch((e=>this.handleFragLoadError(e))),this.hls.trigger(GS.FRAG_LOADING,{frag:e,part:c,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):d}if(!e.url||this.loadedEndOfParts(s,i))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${r?"of ["+r.startSN+"-"+r.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),FS(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=RC;const a=this.config.progressive;let c;return c=a&&o?o.then((t=>!t||this.fragContextChanged(null==t?void 0:t.frag)?null:this.fragmentLoader.load(e,n))).catch((e=>this.handleFragLoadError(e))):Promise.all([this.fragmentLoader.load(e,a?n:void 0),o]).then((([e])=>(!a&&e&&n&&n(e),e))).catch((e=>this.handleFragLoadError(e))),this.hls.trigger(GS.FRAG_LOADING,{frag:e,targetBufferTime:i}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):c}doFragPartsLoad(e,t,i,n){return new Promise(((s,r)=>{var o;const a=[],c=null==(o=i.details)?void 0:o.partList,d=t=>{this.fragmentLoader.loadPart(e,t,n).then((n=>{a[t.index]=n;const r=n.part;this.hls.trigger(GS.FRAG_LOADED,n);const o=my(i,e.sn,t.index+1)||Ey(c,e.sn,t.index+1);if(!o)return s({frag:e,part:r,partsLoaded:a});d(o)})).catch(r)};d(t)}))}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===WS.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(GS.ERROR,t)}else this.hls.trigger(GS.ERROR,{type:jS.OTHER_ERROR,details:WS.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==IC)return void(this.fragCurrent||this.state===TC||this.state===wC||(this.state=SC));const{frag:i,part:n,level:s}=t,r=self.performance.now();i.stats.parsing.end=r,n&&(n.stats.parsing.end=r),this.updateLevelTiming(i,n,s,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:n,sn:s,part:r}=e;if(null==t||!t[n])return this.warn(`Levels object was unset while buffering fragment ${s} of level ${n}. The current chunk will not be buffered.`),null;const o=t[n],a=r>-1?my(o,s,r):null,c=a?a.fragment:function(e,t,i){if(null==e||!e.details)return null;const n=e.details;let s=n.fragments[t-n.startSN];return s||(s=n.fragmentHint,s&&s.sn===t?s:t<n.startSN&&i&&i.sn===t?i:null)}(o,s,i);return c?(i&&i!==c&&(c.stats=i.stats),{frag:c,part:a,level:o}):null}bufferFragmentData(e,t,i,n,s){var r;if(!e||this.state!==IC)return;const{data1:o,data2:a}=e;let c=o;if(o&&a&&(c=tR(o,a)),null==(r=c)||!r.length)return;const d={type:e.type,frag:t,part:i,chunkMeta:n,parent:t.type,data:c};if(this.hls.trigger(GS.BUFFER_APPENDING,d),e.dropped&&e.independent&&!i){if(s)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!iC.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const i=t.currentTime,n=iC.bufferInfo(t,i,0),s=e.duration,r=Math.min(2*this.config.maxFragLookUpTolerance,.25*s),o=Math.max(Math.min(e.start-r,n.end-r),i+r);e.start-o>r&&this.flushMainBuffer(o,e.start)}getFwdBufferInfo(e,t){const i=this.getLoadPosition();return FS(i)?this.getFwdBufferInfoAtPos(e,i,t):null}getFwdBufferInfoAtPos(e,t,i){const{config:{maxBufferHole:n}}=this,s=iC.bufferInfo(e,t,n);if(0===s.len&&void 0!==s.nextStart){const r=this.fragmentTracker.getBufferedFrag(t,i);if(r&&s.nextStart<r.end)return iC.bufferInfo(e,t,Math.max(s.nextStart,n))}return s}getMaxBufferLength(e){const{config:t}=this;let i;return i=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e){const t=this.config,i=e||t.maxBufferLength;return t.maxMaxBufferLength>=i&&(t.maxMaxBufferLength/=2,this.warn(`Reduce max buffer length to ${t.maxMaxBufferLength}s`),!0)}getAppendedFrag(e,t=BR.MAIN){const i=this.fragmentTracker.getAppendedFrag(e,BR.MAIN);return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,n=i.length;if(!n)return null;const{config:s}=this,r=i[0].start;let o;if(t.live){const a=s.initialLiveManifestSize;if(n<a)return this.warn(`Not enough fragments to start playback (have: ${n}, need: ${a})`),null;(!t.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||e<r)&&(o=this.getInitialLiveFragment(t,i),this.startPosition=this.nextLoadPosition=o?this.hls.liveSyncPosition||o.start:e)}else e<=r&&(o=i[0]);if(!o){const i=s.lowLatencyMode?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,i,t)}return this.mapToInitFragWhenRequired(o)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===Jy||i===Xy&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,n,s){const r=e.gap,o=this.getNextFragment(this.nextLoadPosition,t);if(null===o)return o;if(e=o,r&&e&&!e.gap&&i.nextStart){const t=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,n);if(null!==t&&i.len+t.len>=s)return this.log(`buffer full after gaps in "${n}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}getNextPart(e,t,i){let n=-1,s=!1,r=!0;for(let o=0,a=e.length;o<a;o++){const a=e[o];if(r=r&&!a.independent,n>-1&&i<a.start)break;const c=a.loaded;c?n=-1:(s||a.independent||r)&&a.fragment===t&&(n=o),s=c}return n}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let n=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),n=function(e,t,i){if(null===t||!Array.isArray(e)||!e.length||!FS(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;i=i||0;for(let n=0;n<e.length;++n){const s=e[n];if(Ay(t,i,s))return s}return null}(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){const s=i.sn+1;if(s>=e.startSN&&s<=e.endSN){const r=t[s-e.startSN];i.cc===r.cc&&(n=r,this.log(`Live playlist, switching playlist, load frag with next SN: ${n.sn}`))}n||(n=function(e,t){return yy.search(e,(e=>e.cc<t?1:e.cc>t?-1:0))}(t,i.cc),n&&this.log(`Live playlist, switching playlist, load frag with same CC: ${n.sn}`))}}else{const t=this.hls.liveSyncPosition;null!==t&&(n=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}getFragmentAtPosition(e,t,i){const{config:n}=this;let{fragPrevious:s}=this,{fragments:r,endSN:o}=i;const{fragmentHint:a}=i,c=n.maxFragLookUpTolerance,d=i.partList,l=!!(n.lowLatencyMode&&null!=d&&d.length&&a);let h;if(l&&a&&!this.bitrateTest&&(r=r.concat(a),o=a.sn),e<t){h=Cy(s,r,e,e>t-c?0:c)}else h=r[r.length-1];if(h){const e=h.sn-i.startSN,t=this.fragmentTracker.getState(h);if((t===Jy||t===Xy&&h.gap)&&(s=h),s&&h.sn===s.sn&&(!l||d[0].fragment.sn>h.sn)){if(s&&h.level===s.level){const t=r[e+1];h=h.sn<o&&this.fragmentTracker.getState(t)!==Jy?t:null}}}return h}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const n=this.hls.liveSyncPosition,s=i.currentTime,r=e.fragments[0].start,o=e.edge,a=s>=r-t.maxFragLookUpTolerance&&s<=o;if(null!==n&&i.duration>n&&(s<n||!a)){const r=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!a&&i.readyState<4||s<o-r)&&(this.loadedmetadata||(this.nextLoadPosition=n),i.readyState&&(this.warn(`Playback: ${s.toFixed(3)} is located too far from the end of live sliding playlist: ${o}, reset currentTime to : ${n.toFixed(3)}`),i.currentTime=n))}}alignPlaylists(e,t,i){const n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;const s=e.fragments[0].start,r=!t,o=e.alignedSliding&&FS(s);if(r||!o&&!s){const{fragPrevious:s}=this;aC(s,i,e);const r=e.fragments[0].start;return this.log(`Live playlist sliding: ${r.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${s?s.sn:"na"} fragments: ${n}`),r}return s}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let i=this.startPosition;if(i<t&&(i=-1),-1===i||-1===this.lastCurrentTime){const n=null!==this.startTimeOffset,s=n?this.startTimeOffset:e.startTimeOffset;null!==s&&FS(s)?(i=t+s,s<0&&(i+=e.totalduration),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Start time offset ${s} found in ${n?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):e.live?i=this.hls.liveSyncPosition||t:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&"initSegment"!==e.sn&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===yC)||(this.state=SC)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;var n;if(this.fragContextChanged(i))return void this.warn(`Frag load error must match current frag to retry ${i.url} > ${null==(n=this.fragCurrent)?void 0:n.url}`);const s=t.details===WS.FRAG_GAP;s&&this.fragmentTracker.fragBuffered(i,!0);const r=t.errorAction,{action:o,retryCount:a=0,retryConfig:c}=r||{};if(r&&o===Oy&&c){this.resetStartWhenNotLoaded(this.levelLastLoaded);const n=Sy(c,a);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${a+1}/${c.maxNumRetry} in ${n}ms`),r.resolved=!0,this.retryDate=self.performance.now()+n,this.state=yC}else if(c&&r){if(this.resetFragmentErrors(e),!(a<c.maxNumRetry))return void $S.warn(`${t.details} reached or exceeded max retry (${a})`);s||o===Dy||(r.resolved=!0)}else(null==r?void 0:r.action)===wy?this.state=OC:this.state=wC;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===IC||this.state===AC){const t=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,t),n=i&&i.len>.5;n&&this.reduceMaxBufferLength(i.len);const s=!n;return s&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${t} buffer`),e.frag&&(this.fragmentTracker.removeFragment(e.frag),this.nextLoadPosition=e.frag.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(e){e===BR.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==TC&&(this.state=SC)}afterBufferFlushed(e,t,i){if(!e)return;const n=iC.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,n,i),this.state===bC&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=SC}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=e?e.details:null;null!=t&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,n){var s;const r=i.details;if(!r)return void this.warn("level.details undefined");if(!Object.keys(e.elementaryStreams).reduce(((t,s)=>{const o=e.elementaryStreams[s];if(o){const a=o.endPTS-o.startPTS;if(a<=0)return this.warn(`Could not parse fragment ${e.sn} ${s} duration reliably (${a})`),t||!1;const c=n?0:hy(r,e,o.startPTS,o.endPTS,o.startDTS,o.endDTS);return this.hls.trigger(GS.LEVEL_PTS_UPDATED,{details:r,level:i,drift:c,type:s,frag:e,start:o.startPTS,end:o.endPTS}),!0}return t}),!1)&&null===(null==(s=this.transmuxer)?void 0:s.error)){const t=new Error(`Found no media in fragment ${e.sn} of level ${e.level} resetting transmuxer to fallback to playlist timing`);if(0===i.fragmentError&&(i.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(t.message),this.hls.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=AC,this.hls.trigger(GS.FRAG_PARSED,{frag:e,part:t})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){"demuxerWorker"===e.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}class LC{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;return e.length?(i=1===e.length?e[0]:function(e,t){const i=new Uint8Array(t);let n=0;for(let t=0;t<e.length;t++){const s=e[t];i.set(s,n),n+=s.length}return i}(e,t),this.reset(),i):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function PC(e="",t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class kC{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,n){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=tR(this.cachedData,e),this.cachedData=null);let i,n=vv(e,0),s=n?n.length:0;const r=this._audioTrack,o=this._id3Track,a=n?Cv(n):void 0,c=e.length;for((null===this.basePTS||0===this.frameIndex&&FS(a))&&(this.basePTS=MC(a,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),n&&n.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:zR,duration:Number.POSITIVE_INFINITY});s<c;){if(this.canParse(e,s)){const t=this.appendFrame(r,e,s);t?(this.frameIndex++,this.lastPTS=t.sample.pts,s+=t.length,i=s):s=c}else yv(e,s)?(n=vv(e,s),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:zR,duration:Number.POSITIVE_INFINITY}),s+=n.length,i=s):s++;if(s===c&&i!==c){const t=gv(e,i);this.cachedData?this.cachedData=tR(this.cachedData,t):this.cachedData=t}}return{audioTrack:r,videoTrack:PC(),id3Track:o,textTrack:PC()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:PC(),id3Track:this._id3Track,textTrack:PC()}}destroy(){}}const MC=(e,t,i)=>{if(FS(e))return 90*e;return 9e4*t+(i?9e4*i.baseTime/i.timescale:0)};function UC(e,t){return 255===e[t]&&240==(246&e[t+1])}function xC(e,t){return 1&e[t+1]?7:9}function FC(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function VC(e,t){return t+1<e.length&&UC(e,t)}function BC(e,t){if(VC(e,t)){const i=xC(e,t);if(t+i>=e.length)return!1;const n=FC(e,t);if(n<=i)return!1;const s=t+n;return s===e.length||VC(e,s)}return!1}function GC(e,t,i,n,s){if(!e.samplerate){const r=function(e,t,i,n){let s,r,o,a;const c=navigator.userAgent.toLowerCase(),d=n,l=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=1+((192&t[i+2])>>>6);const h=(60&t[i+2])>>>2;if(!(h>l.length-1))return o=(1&t[i+2])<<2,o|=(192&t[i+3])>>>6,$S.log(`manifest codec:${n}, ADTS type:${s}, samplingIndex:${h}`),/firefox/i.test(c)?h>=6?(s=5,a=new Array(4),r=h-3):(s=2,a=new Array(2),r=h):-1!==c.indexOf("android")?(s=2,a=new Array(2),r=h):(s=5,a=new Array(4),n&&(-1!==n.indexOf("mp4a.40.29")||-1!==n.indexOf("mp4a.40.5"))||!n&&h>=6?r=h-3:((n&&-1!==n.indexOf("mp4a.40.2")&&(h>=6&&1===o||/vivaldi/i.test(c))||!n&&1===o)&&(s=2,a=new Array(2)),r=h)),a[0]=s<<3,a[0]|=(14&h)>>1,a[1]|=(1&h)<<7,a[1]|=o<<3,5===s&&(a[1]|=(14&r)>>1,a[2]=(1&r)<<7,a[2]|=8,a[3]=0),{config:a,samplerate:l[h],channelCount:o,codec:"mp4a.40."+s,manifestCodec:d};{const t=new Error(`invalid ADTS sampling index:${h}`);e.emit(GS.ERROR,GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.FRAG_PARSING_ERROR,fatal:!0,error:t,reason:t.message})}}(t,i,n,s);if(!r)return;e.config=r.config,e.samplerate=r.samplerate,e.channelCount=r.channelCount,e.codec=r.codec,e.manifestCodec=r.manifestCodec,$S.log(`parsed codec:${e.codec}, rate:${r.samplerate}, channels:${r.channelCount}`)}}function jC(e){return 9216e4/e}function WC(e,t,i,n,s){const r=n+s*jC(e.samplerate),o=function(e,t){const i=xC(e,t);if(t+i<=e.length){const n=FC(e,t)-i;if(n>0)return{headerLength:i,frameLength:n}}}(t,i);let a;if(o){const{frameLength:n,headerLength:s}=o,c=s+n,d=Math.max(0,i+c-t.length);d?(a=new Uint8Array(c-s),a.set(t.subarray(i+s,t.length),0)):a=t.subarray(i+s,i+c);const l={unit:a,pts:r};return d||e.samples.push(l),{sample:l,length:c,missing:d}}const c=t.length-i;a=new Uint8Array(c),a.set(t.subarray(i,t.length),0);return{sample:{unit:a,pts:r},length:c,missing:-1}}let HC=null;const KC=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],YC=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],qC=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],$C=[0,1,1,4];function zC(e,t,i,n,s){if(i+24>t.length)return;const r=XC(t,i);if(r&&i+r.frameLength<=t.length){const o=n+s*(9e4*r.samplesPerFrame/r.sampleRate),a={unit:t.subarray(i,i+r.frameLength),pts:o,dts:o};return e.config=[],e.channelCount=r.channelCount,e.samplerate=r.sampleRate,e.samples.push(a),{sample:a,length:r.frameLength,missing:0}}}function XC(e,t){const i=e[t+1]>>3&3,n=e[t+1]>>1&3,s=e[t+2]>>4&15,r=e[t+2]>>2&3;if(1!==i&&0!==s&&15!==s&&3!==r){const o=e[t+2]>>1&1,a=e[t+3]>>6,c=1e3*KC[14*(3===i?3-n:3===n?3:4)+s-1],d=YC[3*(3===i?0:2===i?1:2)+r],l=3===a?1:2,h=qC[i][n],u=$C[n],p=8*h*u,f=Math.floor(h*c/d+o)*u;if(null===HC){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);HC=e?parseInt(e[1]):0}return!!HC&&HC<=87&&2===n&&c>=224e3&&0===a&&(e[t+3]=128|e[t+3]),{sampleRate:d,channelCount:l,frameLength:f,samplesPerFrame:p}}}function JC(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])}function QC(e,t){return t+1<e.length&&JC(e,t)}function ZC(e,t){if(t+1<e.length&&JC(e,t)){const i=4,n=XC(e,t);let s=i;null!=n&&n.frameLength&&(s=n.frameLength);const r=t+s;return r===e.length||QC(e,r)}return!1}const eI=/\/emsg[-/]ID3/i;const tI=(e,t)=>{let i=0,n=5;t+=n;const s=new Uint32Array(1),r=new Uint32Array(1),o=new Uint8Array(1);for(;n>0;){o[0]=e[t];const a=Math.min(n,8),c=8-a;r[0]=4278190080>>>24+c<<c,s[0]=(o[0]&r[0])>>c,i=i?i<<a|s[0]:s[0],t+=1,n-=a}return i};class iI extends kC{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const n=nI(e,t,i,this.basePTS,this.frameIndex);if(-1!==n){return{sample:e.samples[e.samples.length-1],length:n,missing:0}}}static probe(e){if(!e)return!1;const t=vv(e,0);if(!t)return!1;const i=t.length;return 11===e[i]&&119===e[i+1]&&void 0!==Cv(t)&&tI(e,i)<16}}function nI(e,t,i,n,s){if(i+8>t.length)return-1;if(11!==t[i]||119!==t[i+1])return-1;const r=t[i+4]>>6;if(r>=3)return-1;const o=[48e3,44100,32e3][r],a=63&t[i+4],c=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*a+r];if(i+c>t.length)return-1;const d=t[i+6]>>5;let l=0;2===d?l+=2:(1&d&&1!==d&&(l+=2),4&d&&(l+=2));const h=(t[i+6]<<8|t[i+7])>>12-l&1,u=[2,1,2,3,3,4,4,5][d]+h,p=t[i+5]>>3,f=7&t[i+5],m=new Uint8Array([r<<6|p<<1|f>>2,(3&f)<<6|d<<3|h<<2|a>>4,a<<4&224]),E=n+s*(1536/o*9e4),_=t.subarray(i,i+c);return e.config=m,e.channelCount=u,e.samplerate=o,e.samples.push({unit:_,pts:E}),c}class sI{constructor(){this.VideoSample=null}createVideoSample(e,t,i,n){return{key:e,frame:!1,pts:t,dts:i,units:[],debug:n,length:0}}getLastNalUnit(e){var t;let i,n=this.VideoSample;if(n&&0!==n.units.length||(n=e[e.length-1]),null!=(t=n)&&t.units){const e=n.units;i=e[e.length-1]}return i}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const i=t.samples,n=i.length;if(!n)return void t.dropped++;{const t=i[n-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}e.debug.length&&$S.log(e.pts+"/"+e.dts+":"+e.debug)}}class rI{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,n=new Uint8Array(4),s=Math.min(4,t);if(0===s)throw new Error("no bytes available");n.set(e.subarray(i,i+s)),this.word=new DataView(n.buffer).getUint32(0),this.bitsAvailable=8*s,this.bytesAvailable-=s}skipBits(e){let t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&$S.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,i=8,n=8;for(let s=0;s<e;s++)0!==n&&(t=this.readEG(),n=(i+t+256)%256),i=0===n?i:n}readSPS(){let e,t,i,n=0,s=0,r=0,o=0;const a=this.readUByte.bind(this),c=this.readBits.bind(this),d=this.readUEG.bind(this),l=this.readBoolean.bind(this),h=this.skipBits.bind(this),u=this.skipEG.bind(this),p=this.skipUEG.bind(this),f=this.skipScalingList.bind(this);a();const m=a();if(c(5),h(3),a(),p(),100===m||110===m||122===m||244===m||44===m||83===m||86===m||118===m||128===m){const e=d();if(3===e&&h(1),p(),p(),h(1),l())for(t=3!==e?8:12,i=0;i<t;i++)l()&&f(i<6?16:64)}p();const E=d();if(0===E)d();else if(1===E)for(h(1),u(),u(),e=d(),i=0;i<e;i++)u();p(),h(1);const _=d(),g=d(),T=c(1);0===T&&h(1),h(1),l()&&(n=d(),s=d(),r=d(),o=d());let S=[1,1];if(l()&&l()){switch(a()){case 1:S=[1,1];break;case 2:S=[12,11];break;case 3:S=[10,11];break;case 4:S=[16,11];break;case 5:S=[40,33];break;case 6:S=[24,11];break;case 7:S=[20,11];break;case 8:S=[32,11];break;case 9:S=[80,33];break;case 10:S=[18,11];break;case 11:S=[15,11];break;case 12:S=[64,33];break;case 13:S=[160,99];break;case 14:S=[4,3];break;case 15:S=[3,2];break;case 16:S=[2,1];break;case 255:S=[a()<<8|a(),a()<<8|a()]}}return{width:Math.ceil(16*(_+1)-2*n-2*s),height:(2-T)*(g+1)*16-(T?2:4)*(r+o),pixelRatio:S}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class oI extends sI{parseAVCPES(e,t,i,n,s){const r=this.parseAVCNALu(e,i.data);let o,a=this.VideoSample,c=!1;i.data=null,a&&r.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),r.forEach((n=>{var r;switch(n.type){case 1:{let t=!1;o=!0;const s=n.data;if(c&&s.length>4){const e=new rI(s).readSliceType();2!==e&&4!==e&&7!==e&&9!==e||(t=!0)}var d;if(t)null!=(d=a)&&d.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null);a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),a.frame=!0,a.key=t;break}case 5:o=!0,null!=(r=a)&&r.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),a.key=!0,a.frame=!0;break;case 6:o=!0,sR(n.data,1,i.pts,t.samples);break;case 7:{var l,h;o=!0,c=!0;const t=n.data,i=new rI(t).readSPS();if(!e.sps||e.width!==i.width||e.height!==i.height||(null==(l=e.pixelRatio)?void 0:l[0])!==i.pixelRatio[0]||(null==(h=e.pixelRatio)?void 0:h[1])!==i.pixelRatio[1]){e.width=i.width,e.height=i.height,e.pixelRatio=i.pixelRatio,e.sps=[t],e.duration=s;const n=t.subarray(1,4);let r="avc1.";for(let e=0;e<3;e++){let t=n[e].toString(16);t.length<2&&(t="0"+t),r+=t}e.codec=r}break}case 8:o=!0,e.pps=[n.data];break;case 9:o=!0,e.audFound=!0,a&&this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:o=!0;break;default:o=!1,a&&(a.debug+="unknown NAL "+n.type+" ")}if(a&&o){a.units.push(n)}})),n&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}parseAVCNALu(e,t){const i=t.byteLength;let n=e.naluState||0;const s=n,r=[];let o,a,c,d=0,l=-1,h=0;for(-1===n&&(l=0,h=31&t[0],n=0,d=1);d<i;)if(o=t[d++],n)if(1!==n)if(o)if(1===o){if(a=d-n-1,l>=0){const e={data:t.subarray(l,a),type:h};r.push(e)}else{const i=this.getLastNalUnit(e.samples);i&&(s&&d<=4-s&&i.state&&(i.data=i.data.subarray(0,i.data.byteLength-s)),a>0&&(i.data=tR(i.data,t.subarray(0,a)),i.state=0))}d<i?(c=31&t[d],l=d,h=c,n=0):n=-1}else n=0;else n=3;else n=o?0:2;else n=o?0:1;if(l>=0&&n>=0){const e={data:t.subarray(l,i),type:h,state:n};r.push(e)}if(0===r.length){const i=this.getLastNalUnit(e.samples);i&&(i.data=tR(i.data,t))}return e.naluState=n,r}}class aI{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new _C(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,i){const n=e[t].unit;if(n.length<=16)return;const s=n.subarray(16,n.length-n.length%16),r=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(r).then((s=>{const r=new Uint8Array(s);n.set(r,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)}))}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length)return void i();if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,i=new Int8Array(t);let n=0;for(let t=32;t<e.length-16;t+=160,n+=16)i.set(e.subarray(t,t+16),n);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let n=0;for(let t=32;t<e.length-16;t+=160,n+=16)e.set(i.subarray(n,n+16),t);return e}decryptAvcSample(e,t,i,n,s){const r=rR(s.data),o=this.getAvcEncryptedData(r);this.decryptBuffer(o.buffer).then((o=>{s.data=this.getAvcDecryptedUnit(r,o),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,n)}))}decryptAvcSamples(e,t,i,n){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length)return void n();const s=e[t].units;for(;!(i>=s.length);i++){const r=s[i];if(!(r.data.length<=48||1!==r.type&&5!==r.type||(this.decryptAvcSample(e,t,i,n,r),this.decrypter.isSync())))return}}}}const cI=188;class dI{constructor(e,t,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.videoParser=new oI}static probe(e){const t=dI.syncOffset(e);return t>0&&$S.warn(`MPEG2-TS detected but first sync word found @ offset ${t}`),-1!==t}static syncOffset(e){const t=e.length;let i=Math.min(940,t-cI)+1,n=0;for(;n<i;){let s=!1,r=-1,o=0;for(let a=n;a<t;a+=cI){if(71!==e[a]||t-a!==cI&&71!==e[a+cI]){if(o)return-1;break}if(o++,-1===r&&(r=a,0!==r&&(i=Math.min(r+18612,e.length-cI)+1)),s||(s=0===lI(e,a)),s&&o>1&&(0===r&&o>2||a+cI>i))return r}n++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:Vv[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,i,n){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=dI.createTrack("video"),this._audioTrack=dI.createTrack("audio",n),this._id3Track=dI.createTrack("id3"),this._txtTrack=dI.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i,this._duration=n}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,n=!1){let s;i||(this.sampleAes=null);const r=this._videoTrack,o=this._audioTrack,a=this._id3Track,c=this._txtTrack;let d=r.pid,l=r.pesData,h=o.pid,u=a.pid,p=o.pesData,f=a.pesData,m=null,E=this.pmtParsed,_=this._pmtId,g=e.length;if(this.remainderData&&(g=(e=tR(this.remainderData,e)).length,this.remainderData=null),g<cI&&!n)return this.remainderData=e,{audioTrack:o,videoTrack:r,id3Track:a,textTrack:c};const T=Math.max(0,dI.syncOffset(e));g-=(g-T)%cI,g<e.byteLength&&!n&&(this.remainderData=new Uint8Array(e.buffer,g,e.buffer.byteLength-g));let S=0;for(let t=T;t<g;t+=cI)if(71===e[t]){const n=!!(64&e[t+1]),g=lI(e,t);let S;if((48&e[t+3])>>4>1){if(S=t+5+e[t+4],S===t+cI)continue}else S=t+4;switch(g){case d:n&&(l&&(s=fI(l))&&this.videoParser.parseAVCPES(r,c,s,!1,this._duration),l={data:[],size:0}),l&&(l.data.push(e.subarray(S,t+cI)),l.size+=t+cI-S);break;case h:if(n){if(p&&(s=fI(p)))switch(o.segmentCodec){case"aac":this.parseAACPES(o,s);break;case"mp3":this.parseMPEGPES(o,s);break;case"ac3":this.parseAC3PES(o,s)}p={data:[],size:0}}p&&(p.data.push(e.subarray(S,t+cI)),p.size+=t+cI-S);break;case u:n&&(f&&(s=fI(f))&&this.parseID3PES(a,s),f={data:[],size:0}),f&&(f.data.push(e.subarray(S,t+cI)),f.size+=t+cI-S);break;case 0:n&&(S+=e[S]+1),_=this._pmtId=hI(e,S);break;case _:{n&&(S+=e[S]+1);const s=uI(e,S,this.typeSupported,i);d=s.videoPid,d>0&&(r.pid=d,r.segmentCodec=s.segmentVideoCodec),h=s.audioPid,h>0&&(o.pid=h,o.segmentCodec=s.segmentAudioCodec),u=s.id3Pid,u>0&&(a.pid=u),null===m||E||($S.warn(`MPEG-TS PMT found at ${t} after unknown PID '${m}'. Backtracking to sync byte @${T} to parse all TS packets.`),m=null,t=T-188),E=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=g}}else S++;if(S>0){const e=new Error(`Found ${S} TS packet/s that do not start with 0x47`);this.observer.emit(GS.ERROR,GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message})}r.pesData=l,o.pesData=p,a.pesData=f;const v={audioTrack:o,videoTrack:r,id3Track:a,textTrack:c};return n&&this.extractRemainingSamples(v),v}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:n,textTrack:s}=e,r=i.pesData,o=t.pesData,a=n.pesData;let c;if(r&&(c=fI(r))?(this.videoParser.parseAVCPES(i,s,c,!0,this._duration),i.pesData=null):i.pesData=r,o&&(c=fI(o))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,c);break;case"mp3":this.parseMPEGPES(t,c);break;case"ac3":this.parseAC3PES(t,c)}t.pesData=null}else null!=o&&o.size&&$S.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=o;a&&(c=fI(a))?(this.parseID3PES(n,c),n.pesData=null):n.pesData=a}demuxSampleAes(e,t,i){const n=this.demux(e,i,!0,!this.config.progressive),s=this.sampleAes=new aI(this.observer,this.config,t);return this.decrypt(n,s)}decrypt(e,t){return new Promise((i=>{const{audioTrack:n,videoTrack:s}=e;n.samples&&"aac"===n.segmentCodec?t.decryptAacSamples(n.samples,0,(()=>{s.samples?t.decryptAvcSamples(s.samples,0,0,(()=>{i(e)})):i(e)})):s.samples&&t.decryptAvcSamples(s.samples,0,0,(()=>{i(e)}))}))}destroy(){this._duration=0}parseAACPES(e,t){let i=0;const n=this.aacOverFlow;let s,r,o,a=t.data;if(n){this.aacOverFlow=null;const t=n.missing,s=n.sample.unit.byteLength;if(-1===t)a=tR(n.sample.unit,a);else{const r=s-t;n.sample.unit.set(a.subarray(0,t),r),e.samples.push(n.sample),i=n.missing}}for(s=i,r=a.length;s<r-1&&!VC(a,s);s++);if(s!==i){let e;const t=s<r-1;e=t?`AAC PES did not start with ADTS header,offset:${s}`:"No ADTS header found in AAC PES";const i=new Error(e);if($S.warn(`parsing error: ${e}`),this.observer.emit(GS.ERROR,GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:i,reason:e}),!t)return}if(GC(e,this.observer,a,s,this.audioCodec),void 0!==t.pts)o=t.pts;else{if(!n)return void $S.warn("[tsdemuxer]: AAC PES unknown PTS");{const t=jC(e.samplerate);o=n.sample.pts+t}}let c,d=0;for(;s<r;){if(c=WC(e,a,s,o,d),s+=c.length,c.missing){this.aacOverFlow=c;break}for(d++;s<r-1&&!VC(a,s);s++);}}parseMPEGPES(e,t){const i=t.data,n=i.length;let s=0,r=0;const o=t.pts;if(void 0!==o)for(;r<n;)if(QC(i,r)){const t=zC(e,i,r,o,s);if(!t)break;r+=t.length,s++}else r++;else $S.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(e,t){{const i=t.data,n=t.pts;if(void 0===n)return void $S.warn("[tsdemuxer]: AC3 PES unknown PTS");const s=i.length;let r,o=0,a=0;for(;a<s&&(r=nI(e,i,a,n,o++))>0;)a+=r}}parseID3PES(e,t){if(void 0===t.pts)return void $S.warn("[tsdemuxer]: ID3 PES unknown PTS");const i=xS({},t,{type:this._videoTrack?JR:zR,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function lI(e,t){return((31&e[t+1])<<8)+e[t+2]}function hI(e,t){return(31&e[t+10])<<8|e[t+11]}function uI(e,t,i,n){const s={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},r=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<r;){const r=lI(e,t),o=(15&e[t+3])<<8|e[t+4];switch(e[t]){case 207:if(!n){pI("ADTS AAC");break}case 15:-1===s.audioPid&&(s.audioPid=r);break;case 21:-1===s.id3Pid&&(s.id3Pid=r);break;case 219:if(!n){pI("H.264");break}case 27:-1===s.videoPid&&(s.videoPid=r,s.segmentVideoCodec="avc");break;case 3:case 4:i.mpeg||i.mp3?-1===s.audioPid&&(s.audioPid=r,s.segmentAudioCodec="mp3"):$S.log("MPEG audio found, not supported in this browser");break;case 193:if(!n){pI("AC-3");break}case 129:i.ac3?-1===s.audioPid&&(s.audioPid=r,s.segmentAudioCodec="ac3"):$S.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===s.audioPid&&o>0){let n=t+5,a=o;for(;a>2;){if(106===e[n])!0!==i.ac3?$S.log("AC-3 audio found, not supported in this browser for now"):(s.audioPid=r,s.segmentAudioCodec="ac3");const t=e[n+1]+2;n+=t,a-=t}}break;case 194:case 135:$S.warn("Unsupported EC-3 in M2TS found");break;case 36:$S.warn("Unsupported HEVC in M2TS found")}t+=o+5}return s}function pI(e){$S.log(`${e} with AES-128-CBC encryption found in unencrypted stream`)}function fI(e){let t,i,n,s,r,o=0;const a=e.data;if(!e||0===e.size)return null;for(;a[0].length<19&&a.length>1;)a[0]=tR(a[0],a[1]),a.splice(1,1);t=a[0];if(1===(t[0]<<16)+(t[1]<<8)+t[2]){if(i=(t[4]<<8)+t[5],i&&i>e.size-6)return null;const c=t[7];192&c&&(s=536870912*(14&t[9])+4194304*(255&t[10])+16384*(254&t[11])+128*(255&t[12])+(254&t[13])/2,64&c?(r=536870912*(14&t[14])+4194304*(255&t[15])+16384*(254&t[16])+128*(255&t[17])+(254&t[18])/2,s-r>54e5&&($S.warn(`${Math.round((s-r)/9e4)}s delta between PTS and DTS, align them`),s=r)):r=s),n=t[8];let d=n+9;if(e.size<=d)return null;e.size-=d;const l=new Uint8Array(e.size);for(let e=0,i=a.length;e<i;e++){t=a[e];let i=t.byteLength;if(d){if(d>i){d-=i;continue}t=t.subarray(d),i-=d,d=0}l.set(t,o),o+=i}return i&&(i-=n+3),{data:l,pts:s,dts:r,len:i}}return null}class mI{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const EI=Math.pow(2,32)-1;class _I{static init(){let e;for(e in _I.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},_I.types)_I.types.hasOwnProperty(e)&&(_I.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);_I.HDLR_TYPES={video:t,audio:i};const n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);_I.STTS=_I.STSC=_I.STCO=s,_I.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),_I.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),_I.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),_I.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const r=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),a=new Uint8Array([0,0,0,1]);_I.FTYP=_I.box(_I.types.ftyp,r,a,r,o),_I.DINF=_I.box(_I.types.dinf,_I.box(_I.types.dref,n))}static box(e,...t){let i=8,n=t.length;const s=n;for(;n--;)i+=t[n].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=255&i,r.set(e,4),n=0,i=8;n<s;n++)r.set(t[n],i),i+=t[n].byteLength;return r}static hdlr(e){return _I.box(_I.types.hdlr,_I.HDLR_TYPES[e])}static mdat(e){return _I.box(_I.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(EI+1)),n=Math.floor(t%(EI+1));return _I.box(_I.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,n>>24,n>>16&255,n>>8&255,255&n,85,196,0,0]))}static mdia(e){return _I.box(_I.types.mdia,_I.mdhd(e.timescale,e.duration),_I.hdlr(e.type),_I.minf(e))}static mfhd(e){return _I.box(_I.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?_I.box(_I.types.minf,_I.box(_I.types.smhd,_I.SMHD),_I.DINF,_I.stbl(e)):_I.box(_I.types.minf,_I.box(_I.types.vmhd,_I.VMHD),_I.DINF,_I.stbl(e))}static moof(e,t,i){return _I.box(_I.types.moof,_I.mfhd(e),_I.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=_I.trak(e[t]);return _I.box.apply(null,[_I.types.moov,_I.mvhd(e[0].timescale,e[0].duration)].concat(i).concat(_I.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=_I.trex(e[t]);return _I.box.apply(null,[_I.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(EI+1)),n=Math.floor(t%(EI+1)),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,n>>24,n>>16&255,n>>8&255,255&n,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return _I.box(_I.types.mvhd,s)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let n,s;for(n=0;n<t.length;n++)s=t[n].flags,i[n+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return _I.box(_I.types.sdtp,i)}static stbl(e){return _I.box(_I.types.stbl,_I.stsd(e),_I.box(_I.types.stts,_I.STTS),_I.box(_I.types.stsc,_I.STSC),_I.box(_I.types.stsz,_I.STSZ),_I.box(_I.types.stco,_I.STCO))}static avc1(e){let t,i,n,s=[],r=[];for(t=0;t<e.sps.length;t++)i=e.sps[t],n=i.byteLength,s.push(n>>>8&255),s.push(255&n),s=s.concat(Array.prototype.slice.call(i));for(t=0;t<e.pps.length;t++)i=e.pps[t],n=i.byteLength,r.push(n>>>8&255),r.push(255&n),r=r.concat(Array.prototype.slice.call(i));const o=_I.box(_I.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|e.sps.length].concat(s).concat([e.pps.length]).concat(r))),a=e.width,c=e.height,d=e.pixelRatio[0],l=e.pixelRatio[1];return _I.box(_I.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,a>>8&255,255&a,c>>8&255,255&c,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,_I.box(_I.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),_I.box(_I.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,255&d,l>>24,l>>16&255,l>>8&255,255&l])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static audioStsd(e){const t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static mp4a(e){return _I.box(_I.types.mp4a,_I.audioStsd(e),_I.box(_I.types.esds,_I.esds(e)))}static mp3(e){return _I.box(_I.types[".mp3"],_I.audioStsd(e))}static ac3(e){return _I.box(_I.types["ac-3"],_I.audioStsd(e),_I.box(_I.types.dac3,e.config))}static stsd(e){return"audio"===e.type?"mp3"===e.segmentCodec&&"mp3"===e.codec?_I.box(_I.types.stsd,_I.STSD,_I.mp3(e)):"ac3"===e.segmentCodec?_I.box(_I.types.stsd,_I.STSD,_I.ac3(e)):_I.box(_I.types.stsd,_I.STSD,_I.mp4a(e)):_I.box(_I.types.stsd,_I.STSD,_I.avc1(e))}static tkhd(e){const t=e.id,i=e.duration*e.timescale,n=e.width,s=e.height,r=Math.floor(i/(EI+1)),o=Math.floor(i%(EI+1));return _I.box(_I.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,o>>24,o>>16&255,o>>8&255,255&o,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,255&n,0,0,s>>8&255,255&s,0,0]))}static traf(e,t){const i=_I.sdtp(e),n=e.id,s=Math.floor(t/(EI+1)),r=Math.floor(t%(EI+1));return _I.box(_I.types.traf,_I.box(_I.types.tfhd,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,255&n])),_I.box(_I.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,r>>24,r>>16&255,r>>8&255,255&r])),_I.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,_I.box(_I.types.trak,_I.tkhd(e),_I.mdia(e))}static trex(e){const t=e.id;return _I.box(_I.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],n=i.length,s=12+16*n,r=new Uint8Array(s);let o,a,c,d,l,h;for(t+=8+s,r.set(["video"===e.type?1:0,0,15,1,n>>>24&255,n>>>16&255,n>>>8&255,255&n,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),o=0;o<n;o++)a=i[o],c=a.duration,d=a.size,l=a.flags,h=a.cts,r.set([c>>>24&255,c>>>16&255,c>>>8&255,255&c,d>>>24&255,d>>>16&255,d>>>8&255,255&d,l.isLeading<<2|l.dependsOn,l.isDependedOn<<6|l.hasRedundancy<<4|l.paddingValue<<1|l.isNonSync,61440&l.degradPrio,15&l.degradPrio,h>>>24&255,h>>>16&255,h>>>8&255,255&h],12+16*o);return _I.box(_I.types.trun,r)}static initSegment(e){_I.types||_I.init();const t=_I.moov(e);return tR(_I.FTYP,t)}}_I.types=void 0,_I.HDLR_TYPES=void 0,_I.STTS=void 0,_I.STSC=void 0,_I.STCO=void 0,_I.STSZ=void 0,_I.VMHD=void 0,_I.SMHD=void 0,_I.STSD=void 0,_I.FTYP=void 0,_I.DINF=void 0;const gI=9e4;function TI(e,t,i=1,n=!1){const s=e*t*i;return n?Math.round(s):s}function SI(e,t=!1){return TI(e,1e3,1/gI,t)}let vI,RI=null,yI=null;class CI{constructor(e,t,i,n=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,null===RI){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);RI=e?parseInt(e[1]):0}if(null===yI){const e=navigator.userAgent.match(/Safari\/(\d+)/i);yI=e?parseInt(e[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){$S.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){$S.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){$S.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e.reduce(((e,i)=>{const n=i.pts-e;return n<-4294967296?(t=!0,II(e,i.pts)):n>0?e:i.pts}),e[0].pts);return t&&$S.debug("PTS rollover detected"),i}remux(e,t,i,n,s,r,o,a){let c,d,l,h,u,p,f=s,m=s;const E=e.pid>-1,_=t.pid>-1,g=t.samples.length,T=e.samples.length>0,S=o&&g>0||g>1;if((!E||T)&&(!_||S)||this.ISGenerated||o){if(this.ISGenerated){var v,R,y,C;const e=this.videoTrackConfig;!e||t.width===e.width&&t.height===e.height&&(null==(v=t.pixelRatio)?void 0:v[0])===(null==(R=e.pixelRatio)?void 0:R[0])&&(null==(y=t.pixelRatio)?void 0:y[1])===(null==(C=e.pixelRatio)?void 0:C[1])||this.resetInitSegment()}else l=this.generateIS(e,t,s,r);const i=this.isVideoContiguous;let n,o=-1;if(S&&(o=function(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!i&&this.config.forceKeyFrameOnDiscontinuity))if(p=!0,o>0){$S.warn(`[mp4-remuxer]: Dropped ${o} out of ${g} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(o),t.dropped+=o,m+=(t.samples[0].pts-e)/t.inputTimeScale,n=m}else-1===o&&($S.warn(`[mp4-remuxer]: No keyframe found out of ${g} video samples`),p=!1);if(this.ISGenerated){if(T&&S){const i=this.getVideoStartPts(t.samples),n=(II(e.samples[0].pts,i)-i)/t.inputTimeScale;f+=Math.max(0,n),m+=Math.max(0,-n)}if(T){if(e.samplerate||($S.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),l=this.generateIS(e,t,s,r)),d=this.remuxAudio(e,f,this.isAudioContiguous,r,_||S||a===BR.AUDIO?m:void 0),S){const n=d?d.endPTS-d.startPTS:0;t.inputTimeScale||($S.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),l=this.generateIS(e,t,s,r)),c=this.remuxVideo(t,m,i,n)}}else S&&(c=this.remuxVideo(t,m,i,0));c&&(c.firstKeyFrame=o,c.independent=-1!==o,c.firstKeyFramePTS=n)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(u=AI(i,s,this._initPTS,this._initDTS)),n.samples.length&&(h=bI(n,s,this._initPTS))),{audio:d,video:c,initSegment:l,independent:p,text:h,id3:u}}generateIS(e,t,i,n){const s=e.samples,r=t.samples,o=this.typeSupported,a={},c=this._initPTS;let d,l,h,u=!c||n,p="audio/mp4";if(u&&(d=l=1/0),e.config&&s.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":o.mpeg?(p="audio/mpeg",e.codec=""):o.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3"}a.audio={id:"audio",container:p,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&o.mpeg?new Uint8Array(0):_I.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(h=e.inputTimeScale,c&&h===c.timescale?u=!1:d=l=s[0].pts-Math.round(h*i))}if(t.sps&&t.pps&&r.length){if(t.timescale=t.inputTimeScale,a.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:_I.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(h=t.inputTimeScale,c&&h===c.timescale)u=!1;else{const e=this.getVideoStartPts(r),t=Math.round(h*i);l=Math.min(l,II(r[0].dts,e)-t),d=Math.min(d,e-t)}this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(a).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:d,timescale:h},this._initDTS={baseTime:l,timescale:h}):d=h=void 0,{tracks:a,initPTS:d,timescale:h}}remuxVideo(e,t,i,n){const s=e.inputTimeScale,r=e.samples,o=[],a=r.length,c=this._initPTS;let d,l,h=this.nextAvcDts,u=8,p=this.videoSampleDuration,f=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,E=!1;if(!i||null===h){const e=t*s,n=r[0].pts-II(r[0].dts,r[0].pts);RI&&null!==h&&Math.abs(e-n-h)<15e3?i=!0:h=e-n}const _=c.baseTime*s/c.timescale;for(let e=0;e<a;e++){const t=r[e];t.pts=II(t.pts-_,h),t.dts=II(t.dts-_,h),t.dts<r[e>0?e-1:e].dts&&(E=!0)}E&&r.sort((function(e,t){const i=e.dts-t.dts,n=e.pts-t.pts;return i||n})),d=r[0].dts,l=r[r.length-1].dts;const g=l-d,T=g?Math.round(g/(a-1)):p||e.inputTimeScale/30;if(i){const e=d-h,i=e>T,n=e<-1;if((i||n)&&(i?$S.warn(`AVC: ${SI(e,!0)} ms (${e}dts) hole between fragments detected at ${t.toFixed(3)}`):$S.warn(`AVC: ${SI(-e,!0)} ms (${e}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!n||h>=r[0].pts||RI)){d=h;const t=r[0].pts-e;if(i)r[0].dts=d,r[0].pts=t;else for(let i=0;i<r.length&&!(r[i].dts>t);i++)r[i].dts-=e,r[i].pts-=e;$S.log(`Video: Initial PTS/DTS adjusted: ${SI(t,!0)}/${SI(d,!0)}, delta: ${SI(e,!0)} ms`)}}d=Math.max(0,d);let S=0,v=0,R=d;for(let e=0;e<a;e++){const t=r[e],i=t.units,n=i.length;let s=0;for(let e=0;e<n;e++)s+=i[e].data.length;v+=s,S+=n,t.length=s,t.dts<R?(t.dts=R,R+=T/4|0||1):R=t.dts,f=Math.min(t.pts,f),m=Math.max(t.pts,m)}l=r[a-1].dts;const y=v+4*S+8;let C;try{C=new Uint8Array(y)}catch(e){return void this.observer.emit(GS.ERROR,GS.ERROR,{type:jS.MUX_ERROR,details:WS.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:y,reason:`fail allocating video mdat ${y}`})}const I=new DataView(C.buffer);I.setUint32(0,y),C.set(_I.types.mdat,4);let A=!1,b=Number.POSITIVE_INFINITY,w=Number.POSITIVE_INFINITY,D=Number.NEGATIVE_INFINITY,O=Number.NEGATIVE_INFINITY;for(let e=0;e<a;e++){const t=r[e],i=t.units;let c,d=0;for(let e=0,t=i.length;e<t;e++){const t=i[e],n=t.data,s=t.data.byteLength;I.setUint32(u,s),u+=4,C.set(n,u),u+=s,d+=4+s}if(e<a-1)p=r[e+1].dts-t.dts,c=r[e+1].pts-t.pts;else{const i=this.config,o=e>0?t.dts-r[e-1].dts:T;if(c=e>0?t.pts-r[e-1].pts:T,i.stretchShortVideoTrack&&null!==this.nextAudioPts){const e=Math.floor(i.maxBufferHole*s),r=(n?f+n*s:this.nextAudioPts)-t.pts;r>e?(p=r-o,p<0?p=o:A=!0,$S.log(`[mp4-remuxer]: It is approximately ${r/90} ms to the next segment; using duration ${p/90} ms for the last video frame.`)):p=o}else p=o}const l=Math.round(t.pts-t.dts);b=Math.min(b,p),D=Math.max(D,p),w=Math.min(w,c),O=Math.max(O,c),o.push(new wI(t.key,p,d,l))}if(o.length)if(RI){if(RI<70){const e=o[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(yI&&O-w<D-b&&T/D<.025&&0===o[0].cts){$S.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let e=d;for(let t=0,i=o.length;t<i;t++){const n=e+o[t].duration,s=e+o[t].cts;if(t<i-1){const e=n+o[t+1].cts;o[t].duration=e-s}else o[t].duration=t?o[t-1].duration:T;o[t].cts=0,e=n}}p=A||!p?T:p,this.nextAvcDts=h=l+p,this.videoSampleDuration=p,this.isVideoContiguous=!0;const N={data1:_I.moof(e.sequenceNumber++,d,xS({},e,{samples:o})),data2:C,startPTS:f/s,endPTS:(m+p)/s,startDTS:d/s,endDTS:h/s,type:"video",hasAudio:!1,hasVideo:!0,nb:o.length,dropped:e.dropped};return e.samples=[],e.dropped=0,N}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(e,t,i,n,s){const r=e.inputTimeScale,o=r/(e.samplerate?e.samplerate:r),a=this.getSamplesPerFrame(e),c=a*o,d=this._initPTS,l="mp3"===e.segmentCodec&&this.typeSupported.mpeg,h=[],u=void 0!==s;let p=e.samples,f=l?0:8,m=this.nextAudioPts||-1;const E=t*r,_=d.baseTime*r/d.timescale;if(this.isAudioContiguous=i=i||p.length&&m>0&&(n&&Math.abs(E-m)<9e3||Math.abs(II(p[0].pts-_,E)-m)<20*c),p.forEach((function(e){e.pts=II(e.pts-_,E)})),!i||m<0){if(p=p.filter((e=>e.pts>=0)),!p.length)return;m=0===s?0:n&&!u?Math.max(0,E):p[0].pts}if("aac"===e.segmentCodec){const t=this.config.maxAudioFramesDrift;for(let i=0,n=m;i<p.length;i++){const s=p[i],o=s.pts,a=o-n,d=Math.abs(1e3*a/r);if(a<=-t*c&&u)0===i&&($S.warn(`Audio frame @ ${(o/r).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*a/r)} ms.`),this.nextAudioPts=m=n=o);else if(a>=t*c&&d<1e4&&u){let t=Math.round(a/c);n=o-t*c,n<0&&(t--,n+=c),0===i&&(this.nextAudioPts=m=n),$S.warn(`[mp4-remuxer]: Injecting ${t} audio frame @ ${(n/r).toFixed(3)}s due to ${Math.round(1e3*a/r)} ms gap.`);for(let r=0;r<t;r++){const t=Math.max(n,0);let r=mI.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);r||($S.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),r=s.unit.subarray()),p.splice(i,0,{unit:r,pts:t}),n+=c,i++}}s.pts=n,n+=c}}let g,T=null,S=null,v=0,R=p.length;for(;R--;)v+=p[R].unit.byteLength;for(let t=0,n=p.length;t<n;t++){const n=p[t],s=n.unit;let r=n.pts;if(null!==S){h[t-1].duration=Math.round((r-S)/o)}else{if(i&&"aac"===e.segmentCodec&&(r=m),T=r,!(v>0))return;v+=f;try{g=new Uint8Array(v)}catch(e){return void this.observer.emit(GS.ERROR,GS.ERROR,{type:jS.MUX_ERROR,details:WS.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:v,reason:`fail allocating audio mdat ${v}`})}if(!l){new DataView(g.buffer).setUint32(0,v),g.set(_I.types.mdat,4)}}g.set(s,f);const c=s.byteLength;f+=c,h.push(new wI(!0,a,c,0)),S=r}const y=h.length;if(!y)return;const C=h[h.length-1];this.nextAudioPts=m=S+o*C.duration;const I=l?new Uint8Array(0):_I.moof(e.sequenceNumber++,T/o,xS({},e,{samples:h}));e.samples=[];const A=T/r,b=m/r,w={data1:I,data2:g,startPTS:A,endPTS:b,startDTS:A,endDTS:b,type:"audio",hasAudio:!0,hasVideo:!1,nb:y};return this.isAudioContiguous=!0,w}remuxEmptyAudio(e,t,i,n){const s=e.inputTimeScale,r=s/(e.samplerate?e.samplerate:s),o=this.nextAudioPts,a=this._initDTS,c=9e4*a.baseTime/a.timescale,d=(null!==o?o:n.startDTS*s)+c,l=n.endDTS*s+c,h=1024*r,u=Math.ceil((l-d)/h),p=mI.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if($S.warn("[mp4-remuxer]: remux empty Audio"),!p)return void $S.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");const f=[];for(let e=0;e<u;e++){const t=d+e*h;f.push({unit:p,pts:t,dts:t})}return e.samples=f,this.remuxAudio(e,t,i,!1)}}function II(e,t){let i;if(null===t)return e;for(i=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=i;return e}function AI(e,t,i,n){const s=e.samples.length;if(!s)return;const r=e.inputTimeScale;for(let o=0;o<s;o++){const s=e.samples[o];s.pts=II(s.pts-i.baseTime*r/i.timescale,t*r)/r,s.dts=II(s.dts-n.baseTime*r/n.timescale,t*r)/r}const o=e.samples;return e.samples=[],{samples:o}}function bI(e,t,i){const n=e.samples.length;if(!n)return;const s=e.inputTimeScale;for(let r=0;r<n;r++){const n=e.samples[r];n.pts=II(n.pts-i.baseTime*s/i.timescale,t*s)/s}e.samples.sort(((e,t)=>e.pts-t.pts));const r=e.samples;return e.samples=[],{samples:r}}class wI{constructor(e,t,i,n){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=i,this.cts=n,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}function DI(e,t){const i=null==e?void 0:e.codec;if(i&&i.length>4)return i;if(t===tv.AUDIO){if("ec-3"===i||"ac-3"===i||"alac"===i)return i;if("fLaC"===i||"Opus"===i){return CR(i,!1)}const e="mp4a.40.5";return $S.info(`Parsed audio codec "${i}" or audio object type not handled. Using "${e}"`),e}return $S.warn(`Unhandled video codec "${i}"`),"hvc1"===i||"hev1"===i?"hvc1.1.6.L120.90":"av01"===i?"av01.0.04M.08":"avc1.42e01e"}try{vI=self.performance.now.bind(self.performance)}catch(tM){$S.debug("Unable to use Performance API on this environment"),vI=null==dv?void 0:dv.Date.now}const OI=[{demux:class{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,n){const s=this.videoTrack=PC("video",1),r=this.audioTrack=PC("audio",1),o=this.txtTrack=PC("text",1);if(this.id3Track=PC("id3",1),this.timeOffset=0,null==e||!e.byteLength)return;const a=$v(e);if(a.video){const{id:e,timescale:t,codec:i}=a.video;s.id=e,s.timescale=o.timescale=t,s.codec=i}if(a.audio){const{id:e,timescale:t,codec:i}=a.audio;r.id=e,r.timescale=t,r.codec=i}o.id=Vv.text,s.sampleDuration=0,s.duration=r.duration=n}resetContiguity(){this.remainderData=null}static probe(e){return function(e){const t=e.byteLength;for(let i=0;i<t;){const n=jv(e,i);if(n>8&&109===e[i+4]&&111===e[i+5]&&111===e[i+6]&&102===e[i+7])return!0;i=n>1?i+n:t}return!1}(e)}demux(e,t){this.timeOffset=t;let i=e;const n=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=tR(this.remainderData,e));const t=function(e){const t={valid:null,remainder:null},i=Yv(e,["moof"]);if(i.length<2)return t.remainder=e,t;const n=i[i.length-1];return t.valid=gv(e,0,n.byteOffset-8),t.remainder=gv(e,n.byteOffset-8),t}(i);this.remainderData=t.remainder,n.samples=t.valid||new Uint8Array}else n.samples=i;const r=this.extractID3Track(n,t);return s.samples=iR(t,n),{videoTrack:n,audioTrack:this.audioTrack,id3Track:r,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const n=this.extractID3Track(t,this.timeOffset);return i.samples=iR(e,t),{videoTrack:t,audioTrack:PC(),id3Track:n,textTrack:PC()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const n=Yv(e.samples,["emsg"]);n&&n.forEach((e=>{const n=function(e){const t=e[0];let i="",n="",s=0,r=0,o=0,a=0,c=0,d=0;if(0===t){for(;"\0"!==Bv(e.subarray(d,d+1));)i+=Bv(e.subarray(d,d+1)),d+=1;for(i+=Bv(e.subarray(d,d+1)),d+=1;"\0"!==Bv(e.subarray(d,d+1));)n+=Bv(e.subarray(d,d+1)),d+=1;n+=Bv(e.subarray(d,d+1)),d+=1,s=jv(e,12),r=jv(e,16),a=jv(e,20),c=jv(e,24),d=28}else if(1===t){d+=4,s=jv(e,d),d+=4;const t=jv(e,d);d+=4;const r=jv(e,d);for(d+=4,o=2**32*t+r,VS(o)||(o=Number.MAX_SAFE_INTEGER,$S.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=jv(e,d),d+=4,c=jv(e,d),d+=4;"\0"!==Bv(e.subarray(d,d+1));)i+=Bv(e.subarray(d,d+1)),d+=1;for(i+=Bv(e.subarray(d,d+1)),d+=1;"\0"!==Bv(e.subarray(d,d+1));)n+=Bv(e.subarray(d,d+1)),d+=1;n+=Bv(e.subarray(d,d+1)),d+=1}return{schemeIdUri:i,value:n,timeScale:s,presentationTime:o,presentationTimeDelta:r,eventDuration:a,id:c,payload:e.subarray(d,e.byteLength)}}(e);if(eI.test(n.schemeIdUri)){const e=FS(n.presentationTime)?n.presentationTime/n.timeScale:t+n.presentationTimeDelta/n.timeScale;let s=4294967295===n.eventDuration?Number.POSITIVE_INFINITY:n.eventDuration/n.timeScale;s<=.001&&(s=Number.POSITIVE_INFINITY);const r=n.payload;i.samples.push({data:r,len:r.byteLength,dts:e,pts:e,type:JR,duration:s})}}))}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}},remux:class{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,i,n){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(function(e,t){if(!e||!t)return e;const i=t.keyId;i&&t.isCommonEncryption&&Yv(e,["moov","trak"]).forEach((e=>{const t=Yv(e,["mdia","minf","stbl","stsd"])[0].subarray(8);let n=Yv(t,["enca"]);const s=n.length>0;s||(n=Yv(t,["encv"])),n.forEach((e=>{Yv(s?e.subarray(28):e.subarray(78),["sinf"]).forEach((e=>{const t=Zv(e);if(t){const e=t.subarray(8,24);e.some((e=>0!==e))||($S.log(`[eme] Patching keyId in 'enc${s?"a":"v"}>sinf>>tenc' box: ${Uv.hexDump(e)} -> ${Uv.hexDump(i)}`),t.set(i,8))}}))}))}));return e}(e,n)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const n=this.initData=$v(e);n.audio&&(t=DI(n.audio,tv.AUDIO)),n.video&&(i=DI(n.video,tv.VIDEO));const s={};n.audio&&n.video?s.audiovideo={container:"video/mp4",codec:t+","+i,initSegment:e,id:"main"}:n.audio?s.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:n.video?s.video={container:"video/mp4",codec:i,initSegment:e,id:"main"}:$S.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s}remux(e,t,i,n,s,r){var o,a;let{initPTS:c,lastEndTime:d}=this;const l={audio:void 0,video:void 0,text:n,id3:i,initSegment:void 0};FS(d)||(d=this.lastEndTime=s||0);const h=t.samples;if(null==h||!h.length)return l;const u={initPTS:void 0,timescale:1};let p=this.initData;if(null!=(o=p)&&o.length||(this.generateInitSegment(h),p=this.initData),null==(a=p)||!a.length)return $S.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),l;this.emitInitSegment&&(u.tracks=this.initTracks,this.emitInitSegment=!1);const f=function(e,t){let i=0,n=0,s=0;const r=Yv(e,["moof","traf"]);for(let e=0;e<r.length;e++){const o=r[e],a=Yv(o,["tfhd"])[0],c=t[jv(a,4)];if(!c)continue;const d=c.default,l=jv(a,0)|(null==d?void 0:d.flags);let h=null==d?void 0:d.duration;8&l&&(h=jv(a,2&l?12:8));const u=c.timescale||9e4,p=Yv(o,["trun"]);for(let e=0;e<p.length;e++)i=eR(p[e]),!i&&h&&(i=h*jv(p[e],4)),c.type===tv.VIDEO?n+=i/u:c.type===tv.AUDIO&&(s+=i/u)}if(0===n&&0===s){let t=1/0,i=0,n=0;const s=Yv(e,["sidx"]);for(let e=0;e<s.length;e++){const r=qv(s[e]);if(null!=r&&r.references){t=Math.min(t,r.earliestPresentationTime/r.timescale);const e=r.references.reduce(((e,t)=>e+t.info.duration||0),0);i=Math.max(i,e+r.earliestPresentationTime/r.timescale),n=i-t}}if(n&&FS(n))return n}return n||s}(h,p),m=function(e,t){return Yv(t,["moof","traf"]).reduce(((t,i)=>{const n=Yv(i,["tfdt"])[0],s=n[0],r=Yv(i,["tfhd"]).reduce(((t,i)=>{const r=jv(i,4),o=e[r];if(o){let e=jv(n,4);if(1===s){if(e===xv)return $S.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),t;e*=xv+1,e+=jv(n,8)}const i=e/(o.timescale||9e4);if(FS(i)&&(null===t||i<t))return i}return t}),null);return null!==r&&FS(r)&&(null===t||r<t)?r:t}),null)}(p,h),E=null===m?s:m;(function(e,t,i,n){if(null===e)return!0;const s=Math.max(n,1),r=t-e.baseTime/e.timescale;return Math.abs(r-i)>s}(c,E,s,f)||u.timescale!==c.timescale&&r)&&(u.initPTS=E-s,c&&1===c.timescale&&$S.warn("Adjusting initPTS by "+(u.initPTS-c.baseTime)),this.initPTS=c={baseTime:u.initPTS,timescale:1});const _=e?E-c.baseTime/c.timescale:d,g=_+f;!function(e,t,i){Yv(t,["moof","traf"]).forEach((t=>{Yv(t,["tfhd"]).forEach((n=>{const s=jv(n,4),r=e[s];if(!r)return;const o=r.timescale||9e4;Yv(t,["tfdt"]).forEach((e=>{const t=e[0],n=i*o;if(n){let i=jv(e,4);if(0===t)i-=n,i=Math.max(i,0),Kv(e,4,i);else{i*=Math.pow(2,32),i+=jv(e,8),i-=n,i=Math.max(i,0);const t=Math.floor(i/(xv+1)),s=Math.floor(i%(xv+1));Kv(e,4,t),Kv(e,8,s)}}}))}))}))}(p,h,c.baseTime/c.timescale),f>0?this.lastEndTime=g:($S.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const T=!!p.audio,S=!!p.video;let v="";T&&(v+="audio"),S&&(v+="video");const R={data1:h,startPTS:_,startDTS:_,endPTS:g,endDTS:g,type:v,hasAudio:T,hasVideo:S,nb:1,dropped:0};return l.audio="audio"===R.type?R:void 0,l.video="audio"!==R.type?R:void 0,l.initSegment=u,l.id3=AI(i,s,c,c),n.samples.length&&(l.text=bI(n,s,c)),l}}},{demux:dI,remux:CI},{demux:class extends kC{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=vv(e,0);let i=(null==t?void 0:t.length)||0;if(ZC(e,i))return!1;for(let t=e.length;i<t;i++)if(BC(e,i))return $S.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&UC(e,t)&&FC(e,t)<=e.length-t}(e,t)}appendFrame(e,t,i){GC(e,this.observer,t,i,e.manifestCodec);const n=WC(e,t,i,this.basePTS,this.frameIndex);if(n&&0===n.missing)return n}},remux:CI},{demux:class extends kC{resetInitSegment(e,t,i,n){super.resetInitSegment(e,t,i,n),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:n,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=vv(e,0);let i=(null==t?void 0:t.length)||0;if(t&&11===e[i]&&119===e[i+1]&&void 0!==Cv(t)&&tI(e,i)<=16)return!1;for(let t=e.length;i<t;i++)if(ZC(e,i))return $S.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return JC(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,i){if(null!==this.basePTS)return zC(e,t,i,this.basePTS,this.frameIndex)}},remux:CI}];OI.splice(2,0,{demux:iI,remux:CI});class NI{constructor(e,t,i,n,s){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.vendor=n,this.id=s}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,n){const s=i.transmuxing;s.executeStart=vI();let r=new Uint8Array(e);const{currentTransmuxState:o,transmuxConfig:a}=this;n&&(this.currentTransmuxState=n);const{contiguous:c,discontinuity:d,trackSwitch:l,accurateTimeOffset:h,timeOffset:u,initSegmentChange:p}=n||o,{audioCodec:f,videoCodec:m,defaultInitPts:E,duration:_,initSegmentData:g}=a,T=function(e,t){let i=null;e.byteLength>0&&null!=(null==t?void 0:t.key)&&null!==t.iv&&null!=t.method&&(i=t);return i}(r,t);if(T&&"AES-128"===T.method){const e=this.getDecrypter();if(!e.isSync())return this.decryptionPromise=e.webCryptoDecrypt(r,T.key.buffer,T.iv.buffer).then((e=>{const t=this.push(e,null,i);return this.decryptionPromise=null,t})),this.decryptionPromise;{let t=e.softwareDecrypt(r,T.key.buffer,T.iv.buffer);if(i.part>-1&&(t=e.flush()),!t)return s.executeEnd=vI(),LI(i);r=new Uint8Array(t)}}const S=this.needsProbing(d,l);if(S){const e=this.configureTransmuxer(r);if(e)return $S.warn(`[transmuxer] ${e.message}`),this.observer.emit(GS.ERROR,GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),s.executeEnd=vI(),LI(i)}(d||l||p||S)&&this.resetInitSegment(g,f,m,_,t),(d||p||S)&&this.resetInitialTimestamp(E),c||this.resetContiguity();const v=this.transmux(r,T,u,h,i),R=this.currentTransmuxState;return R.contiguous=!0,R.discontinuity=!1,R.trackSwitch=!1,s.executeEnd=vI(),v}flush(e){const t=e.transmuxing;t.executeStart=vI();const{decrypter:i,currentTransmuxState:n,decryptionPromise:s}=this;if(s)return s.then((()=>this.flush(e)));const r=[],{timeOffset:o}=n;if(i){const t=i.flush();t&&r.push(this.push(t,null,e))}const{demuxer:a,remuxer:c}=this;if(!a||!c)return t.executeEnd=vI(),[LI(e)];const d=a.flush(o);return PI(d)?d.then((t=>(this.flushRemux(r,t,e),r))):(this.flushRemux(r,d,e),r)}flushRemux(e,t,i){const{audioTrack:n,videoTrack:s,id3Track:r,textTrack:o}=t,{accurateTimeOffset:a,timeOffset:c}=this.currentTransmuxState;$S.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const d=this.remuxer.remux(n,s,r,o,c,a,!0,this.id);e.push({remuxResult:d,chunkMeta:i}),i.transmuxing.executeEnd=vI()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;t&&i&&(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,n,s){const{demuxer:r,remuxer:o}=this;r&&o&&(r.resetInitSegment(e,t,i,n),o.resetInitSegment(e,t,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,n,s){let r;return r=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,i,n,s):this.transmuxUnencrypted(e,i,n,s),r}transmuxUnencrypted(e,t,i,n){const{audioTrack:s,videoTrack:r,id3Track:o,textTrack:a}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,r,o,a,t,i,!1,this.id),chunkMeta:n}}transmuxSampleAes(e,t,i,n,s){return this.demuxer.demuxSampleAes(e,t,i).then((e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,i,n,!1,this.id),chunkMeta:s})))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:n,vendor:s}=this;let r;for(let t=0,i=OI.length;t<i;t++){var o;if(null!=(o=OI[t].demux)&&o.probe(e)){r=OI[t];break}}if(!r)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,c=this.remuxer,d=r.remux,l=r.demux;c&&c instanceof d||(this.remuxer=new d(i,t,n,s)),a&&a instanceof l||(this.demuxer=new l(i,t,n),this.probe=l.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new _C(this.config)),e}}const LI=e=>({remuxResult:{},chunkMeta:e});function PI(e){return"then"in e&&e.then instanceof Function}class kI{constructor(e,t,i,n,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=n,this.defaultInitPts=s||null}}class MI{constructor(e,t,i,n,s,r){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=n,this.timeOffset=s,this.initSegmentChange=r}}var UI={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,i="~";function n(){}function s(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function r(e,t,n,r,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var a=new s(n,r||e,o),c=i?i+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,n,s=[];if(0===this._eventsCount)return s;for(n in e=this._events)t.call(e,n)&&s.push(i?n.slice(1):n);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},a.prototype.listeners=function(e){var t=i?i+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,r=n.length,o=new Array(r);s<r;s++)o[s]=n[s].fn;return o},a.prototype.listenerCount=function(e){var t=i?i+e:e,n=this._events[t];return n?n.fn?1:n.length:0},a.prototype.emit=function(e,t,n,s,r,o){var a=i?i+e:e;if(!this._events[a])return!1;var c,d,l=this._events[a],h=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),h){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,n),!0;case 4:return l.fn.call(l.context,t,n,s),!0;case 5:return l.fn.call(l.context,t,n,s,r),!0;case 6:return l.fn.call(l.context,t,n,s,r,o),!0}for(d=1,c=new Array(h-1);d<h;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var u,p=l.length;for(d=0;d<p;d++)switch(l[d].once&&this.removeListener(e,l[d].fn,void 0,!0),h){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,t);break;case 3:l[d].fn.call(l[d].context,t,n);break;case 4:l[d].fn.call(l[d].context,t,n,s);break;default:if(!c)for(u=1,c=new Array(h-1);u<h;u++)c[u-1]=arguments[u];l[d].fn.apply(l[d].context,c)}}return!0},a.prototype.on=function(e,t,i){return r(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return r(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,n,s){var r=i?i+e:e;if(!this._events[r])return this;if(!t)return o(this,r),this;var a=this._events[r];if(a.fn)a.fn!==t||s&&!a.once||n&&a.context!==n||o(this,r);else{for(var c=0,d=[],l=a.length;c<l;c++)(a[c].fn!==t||s&&!a[c].once||n&&a[c].context!==n)&&d.push(a[c]);d.length?this._events[r]=1===d.length?d[0]:d:o(this,r)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&o(this,t)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a}(UI);var xI=OS(UI.exports);class FI{constructor(e,t,i,n){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const s=e.config;this.hls=e,this.id=t,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=n;const r=(e,t)=>{(t=t||{}).frag=this.frag,t.id=this.id,e===GS.ERROR&&(this.error=t.error),this.hls.trigger(e,t)};this.observer=new xI,this.observer.on(GS.FRAG_DECRYPTED,r),this.observer.on(GS.ERROR,r);const o=mR(s.preferManagedMediaSource)||{isTypeSupported:()=>!1},a={mpeg:o.isTypeSupported("audio/mpeg"),mp3:o.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:o.isTypeSupported('audio/mp4; codecs="ac-3"')},c=navigator.vendor;if(this.useWorker&&"undefined"!=typeof Worker){if(s.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__){try{s.workerPath?($S.log(`loading Web Worker ${s.workerPath} for "${t}"`),this.workerContext=function(e){const t=new self.URL(e,self.location.href).href;return{worker:new self.Worker(t),scriptURL:t}}(s.workerPath)):($S.log(`injecting Web Worker for "${t}"`),this.workerContext=function(){const e=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),t=self.URL.createObjectURL(e);return{worker:new self.Worker(t),objectURL:t}}()),this.onwmsg=e=>this.onWorkerMessage(e);const{worker:e}=this.workerContext;e.addEventListener("message",this.onwmsg),e.onerror=e=>{const i=new Error(`${e.message}  (${e.filename}:${e.lineno})`);s.enableWorker=!1,$S.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(GS.ERROR,{type:jS.OTHER_ERROR,details:WS.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:i})},e.postMessage({cmd:"init",typeSupported:a,vendor:c,id:t,config:JSON.stringify(s)})}catch(e){$S.warn(`Error setting up "${t}" Web Worker, fallback to inline`,e),this.resetWorker(),this.error=null,this.transmuxer=new NI(this.observer,a,s,c,t)}return}}this.transmuxer=new NI(this.observer,a,s,c,t)}resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,i,n,s,r,o,a,c,d){var l,h;c.transmuxing.start=self.performance.now();const{transmuxer:u}=this,p=r?r.start:s.start,f=s.decryptdata,m=this.frag,E=!(m&&s.cc===m.cc),_=!(m&&c.level===m.level),g=m?c.sn-m.sn:-1,T=this.part?c.part-this.part.index:-1,S=0===g&&c.id>1&&c.id===(null==m?void 0:m.stats.chunkCount),v=!_&&(1===g||0===g&&(1===T||S&&T<=0)),R=self.performance.now();(_||g||0===s.stats.parsing.start)&&(s.stats.parsing.start=R),!r||!T&&v||(r.stats.parsing.start=R);const y=!(m&&(null==(l=s.initSegment)?void 0:l.url)===(null==(h=m.initSegment)?void 0:h.url)),C=new MI(E,v,a,_,p,y);if(!v||E||y){$S.log(`[transmuxer-interface, ${s.type}]: Starting new transmux session for sn: ${c.sn} p: ${c.part} level: ${c.level} id: ${c.id}\n        discontinuity: ${E}\n        trackSwitch: ${_}\n        contiguous: ${v}\n        accurateTimeOffset: ${a}\n        timeOffset: ${p}\n        initSegmentChange: ${y}`);const e=new kI(i,n,t,o,d);this.configureTransmuxer(e)}if(this.frag=s,this.part=r,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:f,chunkMeta:c,state:C},e instanceof ArrayBuffer?[e]:[]);else if(u){const t=u.push(e,f,c,C);PI(t)?(u.async=!0,t.then((e=>{this.handleTransmuxComplete(e)})).catch((e=>{this.transmuxerError(e,c,"transmuxer-interface push error")}))):(u.async=!1,this.handleTransmuxComplete(t))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let i=t.flush(e);PI(i)||t.async?(PI(i)||(i=Promise.resolve(i)),i.then((t=>{this.handleFlushResult(t,e)})).catch((t=>{this.transmuxerError(t,e,"transmuxer-interface flush error")}))):this.handleFlushResult(i,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.FRAG_PARSING_ERROR,chunkMeta:t,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach((e=>{this.handleTransmuxComplete(e)})),this.onFlush(t)}onWorkerMessage(e){const t=e.data,i=this.hls;switch(t.event){case"init":{var n;const e=null==(n=this.workerContext)?void 0:n.objectURL;e&&self.URL.revokeObjectURL(e);break}case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;case"workerLog":$S[t.data.logType]&&$S[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,i.trigger(t.event,t.data)}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}function VI(e,t){if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!BI(e[i].attrs,t[i].attrs))return!1;return!0}function BI(e,t,i){const n=e["STABLE-RENDITION-ID"];return n&&!i?n===t["STABLE-RENDITION-ID"]:!(i||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some((i=>e[i]!==t[i]))}function GI(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||"").toLowerCase())}class jI{constructor(e){this.buffered=void 0;const t=(t,i,n)=>{if((i>>>=0)>n-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${i}) is greater than the maximum bound (${n})`);return e[i][t]};this.buffered={get length(){return e.length},end:i=>t("end",i,e.length),start:i=>t("start",i,e.length)}}}class WI{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t,i){const n=this.queues[t];n.push(e),1!==n.length||i||this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const i=new Promise((e=>{t=e})),n={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(n,e),i}executeNext(e){const t=this.queues[e];if(t.length){const i=t[0];try{i.execute()}catch(t){$S.warn(`[buffer-operation-queue]: Exception executing "${e}" SourceBuffer operation: ${t}`),i.onError(t);const n=this.buffers[e];null!=n&&n.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const HI=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;function KI(e){const t=e.querySelectorAll("source");[].slice.call(t).forEach((t=>{e.removeChild(t)}))}const YI={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},qI=function(e){let t=e;return YI.hasOwnProperty(e)&&(t=YI[e]),String.fromCharCode(t)},$I=15,zI=100,XI={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},JI={17:2,18:4,21:6,22:8,23:10,19:13,20:15},QI={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},ZI={25:2,26:4,29:6,30:8,31:10,27:13,28:15},eA=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class tA{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i="function"==typeof t?t():t;$S.log(`${this.time} [${e}] ${i}`)}}}const iA=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class nA{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const n=t[i];e.hasOwnProperty(n)&&(this[n]=e[n])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class sA{constructor(){this.uchar=" ",this.penState=new nA}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class rA{constructor(e){this.chars=[],this.pos=0,this.currPenState=new nA,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<zI;e++)this.chars.push(new sA);this.logger=e}equals(e){for(let t=0;t<zI;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<zI;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<zI;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>zI&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=zI)}moveCursor(e){const t=this.pos+e;if(e>1)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=qI(e);this.pos>=zI?this.logger.log(0,(()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!")):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<zI;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<zI;i++){const n=this.chars[i].uchar;" "!==n&&(t=!1),e.push(n)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e);this.chars[this.pos].setPenState(this.currPenState)}}class oA{constructor(e){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<$I;t++)this.rows.push(new rA(e));this.logger=e}reset(){for(let e=0;e<$I;e++)this.rows[e].clear();this.currRow=14}equals(e){let t=!0;for(let i=0;i<$I;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<$I;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<$I;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e);this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,(()=>"pacData = "+JSON.stringify(e)));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<$I;e++)this.rows[e].clear();const e=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){const n=i.rows[e].cueStartTime,s=this.logger.time;if(null!==n&&null!==s&&n<s)for(let n=0;n<this.nrRollUpRows;n++)this.rows[t-this.nrRollUpRows+n+1].copy(i.rows[e+n])}}this.currRow=t;const i=this.rows[this.currRow];if(null!==e.indent){const t=e.indent,n=Math.max(t-1,0);i.setCursor(e.indent),e.color=i.chars[n].penState.foreground}const n={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){this.logger.log(2,(()=>"bkgData = "+JSON.stringify(e))),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,(()=>this.getDisplayText()));const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",n=-1;for(let i=0;i<$I;i++){const s=this.rows[i].getTextString();s&&(n=i+1,e?t.push("Row "+n+": '"+s+"'"):t.push(s.trim()))}return t.length>0&&(i=e?"["+t.join(" | ")+"]":t.join("\n")),i}getTextAndFormat(){return this.rows}}class aA{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new oA(i),this.nonDisplayedMemory=new oA(i),this.lastOutputScreen=new oA(i),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,(()=>"MODE="+e)),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,(()=>t+": "+this.writeScreen.getDisplayText(!0))),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,(()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0))),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,(()=>"DISP: "+this.displayedMemory.getDisplayText()))}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,n=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=n[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class cA{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const n=this.logger=new tA;this.channels=[null,new aA(e,t,n),new aA(e+1,i,n)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,n,s,r=!1;this.logger.time=e;for(let e=0;e<t.length;e+=2)if(n=127&t[e],s=127&t[e+1],0!==n||0!==s){if(this.logger.log(3,"["+iA([t[e],t[e+1]])+"] -> ("+iA([n,s])+")"),i=this.parseCmd(n,s),i||(i=this.parseMidrow(n,s)),i||(i=this.parsePAC(n,s)),i||(i=this.parseBackgroundAttributes(n,s)),!i&&(r=this.parseChars(n,s),r)){const e=this.currentChannel;if(e&&e>0){this.channels[e].insertChars(r)}else this.logger.log(2,"No channel found yet. TEXT-MODE?")}i||r||this.logger.log(2,"Couldn't parse cleaned data "+iA([n,s])+" orig: "+iA([t[e],t[e+1]]))}}parseCmd(e,t){const{cmdHistory:i}=this;if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=33&&t<=35))return!1;if(lA(e,t,i))return dA(null,null,i),this.logger.log(3,"Repeated command ("+iA([e,t])+") is dropped"),!0;const n=20===e||21===e||23===e?1:2,s=this.channels[n];return 20===e||21===e||28===e||29===e?32===t?s.ccRCL():33===t?s.ccBS():34===t?s.ccAOF():35===t?s.ccAON():36===t?s.ccDER():37===t?s.ccRU(2):38===t?s.ccRU(3):39===t?s.ccRU(4):40===t?s.ccFON():41===t?s.ccRDC():42===t?s.ccTR():43===t?s.ccRTD():44===t?s.ccEDM():45===t?s.ccCR():46===t?s.ccENM():47===t&&s.ccEOC():s.ccTO(t-32),dA(e,t,i),this.currentChannel=n,!0}parseMidrow(e,t){let i=0;if((17===e||25===e)&&t>=32&&t<=47){if(i=17===e?1:2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const n=this.channels[i];return!!n&&(n.ccMIDROW(t),this.logger.log(3,"MIDROW ("+iA([e,t])+")"),!0)}return!1}parsePAC(e,t){let i;const n=this.cmdHistory;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127)&&!((16===e||24===e)&&t>=64&&t<=95))return!1;if(lA(e,t,n))return dA(null,null,n),!0;const s=e<=23?1:2;i=t>=64&&t<=95?1===s?XI[e]:QI[e]:1===s?JI[e]:ZI[e];const r=this.channels[s];return!!r&&(r.setPAC(this.interpretPAC(i,t)),dA(e,t,n),this.currentChannel=s,!0)}interpretPAC(e,t){let i;const n={color:null,italics:!1,indent:null,underline:!1,row:e};return i=t>95?t-96:t-64,n.underline=1==(1&i),i<=13?n.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(n.italics=!0,n.color="white"):n.indent=4*Math.floor((i-16)/2),n}parseChars(e,t){let i,n=null,s=null;if(e>=25?(i=2,s=e-8):(i=1,s=e),s>=17&&s<=19){let e;e=17===s?t+80:18===s?t+112:t+144,this.logger.log(2,"Special char '"+qI(e)+"' in channel "+i),n=[e]}else e>=32&&e<=127&&(n=0===t?[e]:[e,t]);if(n){const i=iA(n);this.logger.log(3,"Char codes =  "+i.join(",")),dA(e,t,this.cmdHistory)}return n}parseBackgroundAttributes(e,t){if(!((16===e||24===e)&&t>=32&&t<=47)&&!((23===e||31===e)&&t>=45&&t<=47))return!1;let i;const n={};16===e||24===e?(i=Math.floor((t-32)/2),n.background=eA[i],t%2==1&&(n.background=n.background+"_semi")):45===t?n.background="transparent":(n.foreground="black",47===t&&(n.underline=!0));const s=e<=23?1:2;return this.channels[s].setBkgData(n),dA(e,t,this.cmdHistory),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}this.cmdHistory={a:null,b:null}}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function dA(e,t,i){i.a=e,i.b=t}function lA(e,t,i){return i.a===e&&i.b===t}class hA{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var uA=function(){if(null!=dv&&dv.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function i(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const i=t.toLowerCase();return!!~e.indexOf(i)&&i}function n(e){return i(t,e)}function s(e,...t){let i=1;for(;i<arguments.length;i++){const t=arguments[i];for(const i in t)e[i]=t[i]}return e}function r(t,r,o){const a=this,c={enumerable:!0};a.hasBeenReset=!1;let d="",l=!1,h=t,u=r,p=o,f=null,m="",E=!0,_="auto",g="start",T=50,S="middle",v=50,R="middle";Object.defineProperty(a,"id",s({},c,{get:function(){return d},set:function(e){d=""+e}})),Object.defineProperty(a,"pauseOnExit",s({},c,{get:function(){return l},set:function(e){l=!!e}})),Object.defineProperty(a,"startTime",s({},c,{get:function(){return h},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");h=e,this.hasBeenReset=!0}})),Object.defineProperty(a,"endTime",s({},c,{get:function(){return u},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(a,"text",s({},c,{get:function(){return p},set:function(e){p=""+e,this.hasBeenReset=!0}})),Object.defineProperty(a,"region",s({},c,{get:function(){return f},set:function(e){f=e,this.hasBeenReset=!0}})),Object.defineProperty(a,"vertical",s({},c,{get:function(){return m},set:function(t){const n=function(t){return i(e,t)}(t);if(!1===n)throw new SyntaxError("An invalid or illegal string was specified.");m=n,this.hasBeenReset=!0}})),Object.defineProperty(a,"snapToLines",s({},c,{get:function(){return E},set:function(e){E=!!e,this.hasBeenReset=!0}})),Object.defineProperty(a,"line",s({},c,{get:function(){return _},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");_=e,this.hasBeenReset=!0}})),Object.defineProperty(a,"lineAlign",s({},c,{get:function(){return g},set:function(e){const t=n(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");g=t,this.hasBeenReset=!0}})),Object.defineProperty(a,"position",s({},c,{get:function(){return T},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");T=e,this.hasBeenReset=!0}})),Object.defineProperty(a,"positionAlign",s({},c,{get:function(){return S},set:function(e){const t=n(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");S=t,this.hasBeenReset=!0}})),Object.defineProperty(a,"size",s({},c,{get:function(){return v},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");v=e,this.hasBeenReset=!0}})),Object.defineProperty(a,"align",s({},c,{get:function(){return R},set:function(e){const t=n(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");R=t,this.hasBeenReset=!0}})),a.displayState=void 0}return r.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},r}();class pA{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function fA(e){function t(e,t,i,n){return 3600*(0|e)+60*(0|t)+(0|i)+parseFloat(n||0)}const i=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return i?parseFloat(i[2])>59?t(i[2],i[3],0,i[4]):t(i[1],i[2],i[3],i[4]):null}class mA{constructor(){this.values=Object.create(null)}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let n=0;n<i.length;++n)if(t===i[n]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function EA(e,t,i,n){const s=n?e.split(n):[e];for(const e in s){if("string"!=typeof s[e])continue;const n=s[e].split(i);if(2!==n.length)continue;t(n[0],n[1])}}const _A=new uA(0,0,""),gA="middle"===_A.align?"middle":"center";function TA(e,t,i){const n=e;function s(){const t=fA(e);if(null===t)throw new Error("Malformed timestamp: "+n);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function r(){e=e.replace(/^\s+/,"")}if(r(),t.startTime=s(),r(),"--\x3e"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+n);e=e.slice(3),r(),t.endTime=s(),r(),function(e,t){const n=new mA;EA(e,(function(e,t){let s;switch(e){case"region":for(let s=i.length-1;s>=0;s--)if(i[s].id===t){n.set(e,i[s].region);break}break;case"vertical":n.alt(e,t,["rl","lr"]);break;case"line":s=t.split(","),n.integer(e,s[0]),n.percent(e,s[0])&&n.set("snapToLines",!1),n.alt(e,s[0],["auto"]),2===s.length&&n.alt("lineAlign",s[1],["start",gA,"end"]);break;case"position":s=t.split(","),n.percent(e,s[0]),2===s.length&&n.alt("positionAlign",s[1],["start",gA,"end","line-left","line-right","auto"]);break;case"size":n.percent(e,t);break;case"align":n.alt(e,t,["start",gA,"end","left","right"])}}),/:/,/\s/),t.region=n.get("region",null),t.vertical=n.get("vertical","");let s=n.get("line","auto");"auto"===s&&-1===_A.line&&(s=-1),t.line=s,t.lineAlign=n.get("lineAlign","start"),t.snapToLines=n.get("snapToLines",!0),t.size=n.get("size",100),t.align=n.get("align",gA);let r=n.get("position","auto");"auto"===r&&50===_A.position&&(r="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=r}(e,t)}function SA(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class vA{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new pA,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;function i(){let e=t.buffer,i=0;for(e=SA(e);i<e.length&&"\r"!==e[i]&&"\n"!==e[i];)++i;const n=e.slice(0,i);return"\r"===e[i]&&++i,"\n"===e[i]&&++i,t.buffer=e.slice(i),n}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{let e="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;e=i();const n=e.match(/^(Ã¯Â»Â¿)?WEBVTT([ \t].*)?$/);if(null==n||!n[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let n=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(n?n=!1:e=i(),t.state){case"HEADER":/:/.test(e)?EA(e,(function(e,t){}),/:/):e||(t.state="ID");continue;case"NOTE":e||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){t.state="NOTE";break}if(!e)continue;if(t.cue=new uA(0,0,""),t.state="CUE",-1===e.indexOf("--\x3e")){t.cue.id=e;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{TA(e,t.cue,t.regionList)}catch(e){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const i=-1!==e.indexOf("--\x3e");if(!e||i&&(n=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=e}continue;case"BADCUE":e||(t.state="ID")}}}catch(e){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const RA=/\r\n|\n\r|\n|\r/g,yA=function(e,t,i=0){return e.slice(i,i+t.length)===t},CA=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),s=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(FS(t)&&FS(i)&&FS(n)&&FS(s)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=6e4*n,t+=36e5*s,t},IA=function(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()};function AA(e,t,i){return IA(e.toString())+IA(t.toString())+IA(i)}const bA=function(e,t,i){let n=e[t],s=e[n.prevCC];if(!s||!s.new&&n.new)return e.ccOffset=e.presentationOffset=n.start,void(n.new=!1);for(;null!=(r=s)&&r.new;){var r;e.ccOffset+=n.start-s.start,n.new=!1,n=s,s=e[n.prevCC]}e.presentationOffset=i};function wA(e,t,i,n,s,r,o){const a=new vA,c=Pv(new Uint8Array(e)).trim().replace(RA,"\n").split("\n"),d=[],l=t?function(e,t=1){return TI(e,gI,1/t)}(t.baseTime,t.timescale):0;let h,u="00:00.000",p=0,f=0,m=!0;a.oncue=function(e){const r=i[n];let o=i.ccOffset;const a=(p-l)/9e4;if(null!=r&&r.new&&(void 0!==f?o=i.ccOffset=r.start:bA(i,n,a)),a){if(!t)return void(h=new Error("Missing initPTS for VTT MPEGTS"));o=a-i.presentationOffset}const c=e.endTime-e.startTime,u=II(9e4*(e.startTime+o-f),9e4*s)/9e4;e.startTime=Math.max(u,0),e.endTime=Math.max(u+c,0);const m=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(m)),e.id||(e.id=AA(e.startTime,e.endTime,m)),e.endTime>0&&d.push(e)},a.onparsingerror=function(e){h=e},a.onflush=function(){h?o(h):r(d)},c.forEach((e=>{if(m){if(yA(e,"X-TIMESTAMP-MAP=")){m=!1,e.slice(16).split(",").forEach((e=>{yA(e,"LOCAL:")?u=e.slice(6):yA(e,"MPEGTS:")&&(p=parseInt(e.slice(7)))}));try{f=CA(u)/1e3}catch(e){h=e}return}""===e&&(m=!1)}a.parse(e+"\n")})),a.flush()}const DA="stpp.ttml.im1t",OA=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,NA=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,LA={left:"start",center:"center",right:"end",start:"start",end:"end"};function PA(e,t,i,n){const s=Yv(new Uint8Array(e),["mdat"]);if(0===s.length)return void n(new Error("Could not parse IMSC1 mdat"));const r=s.map((e=>Pv(e))),o=function(e,t,i=1,n=!1){return TI(e,t,1/i,n)}(t.baseTime,1,t.timescale);try{r.forEach((e=>i(function(e,t){const i=(new DOMParser).parseFromString(e,"text/xml"),n=i.getElementsByTagName("tt")[0];if(!n)throw new Error("Invalid ttml");const s={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},r=Object.keys(s).reduce(((e,t)=>(e[t]=n.getAttribute(`ttp:${t}`)||s[t],e)),{}),o="preserve"!==n.getAttribute("xml:space"),a=MA(kA(n,"styling","style")),c=MA(kA(n,"layout","region")),d=kA(n,"body","[begin]");return[].map.call(d,(e=>{const i=UA(e,o);if(!i||!e.hasAttribute("begin"))return null;const n=VA(e.getAttribute("begin"),r),s=VA(e.getAttribute("dur"),r);let d=VA(e.getAttribute("end"),r);if(null===n)throw FA(e);if(null===d){if(null===s)throw FA(e);d=n+s}const l=new uA(n-t,d-t,i);l.id=AA(l.startTime,l.endTime,l.text);const h=function(e,t,i){const n="http://www.w3.org/ns/ttml#styling";let s=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;o&&i.hasOwnProperty(o)&&(s=i[o]);return r.reduce(((i,r)=>{const o=xA(t,n,r)||xA(e,n,r)||xA(s,n,r);return o&&(i[r]=o),i}),{})}(c[e.getAttribute("region")],a[e.getAttribute("style")],a),{textAlign:u}=h;if(u){const e=LA[u];e&&(l.lineAlign=e),l.align=u}return xS(l,h),l})).filter((e=>null!==e))}(e,o))))}catch(e){n(e)}}function kA(e,t,i){const n=e.getElementsByTagName(t)[0];return n?[].slice.call(n.querySelectorAll(i)):[]}function MA(e){return e.reduce(((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e}),{})}function UA(e,t){return[].slice.call(e.childNodes).reduce(((e,i,n)=>{var s;return"br"===i.nodeName&&n?e+"\n":null!=(s=i.childNodes)&&s.length?UA(i,t):t?e+i.textContent.trim().replace(/\s+/g," "):e+i.textContent}),"")}function xA(e,t,i){return e&&e.hasAttributeNS(t,i)?e.getAttributeNS(t,i):null}function FA(e){return new Error(`Could not parse ttml timestamp ${e}`)}function VA(e,t){if(!e)return null;let i=fA(e);return null===i&&(OA.test(e)?i=function(e,t){const i=OA.exec(e),n=(0|i[4])+(0|i[5])/t.subFrameRate;return 3600*(0|i[1])+60*(0|i[2])+(0|i[3])+n/t.frameRate}(e,t):NA.test(e)&&(i=function(e,t){const i=NA.exec(e),n=Number(i[1]);switch(i[2]){case"h":return 3600*n;case"m":return 60*n;case"ms":return 1e3*n;case"f":return n/t.frameRate;case"t":return n/t.tickRate}return n}(e,t))),i}function BA(e){return e.characteristics&&/transcribes-spoken-dialog/gi.test(e.characteristics)&&/describes-music-and-sound/gi.test(e.characteristics)?"captions":"subtitles"}function GA(e,t){return!!e&&e.kind===BA(t)&&GI(t,e)}class jA{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(GS.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(GS.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.on(GS.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(GS.BUFFER_CODECS,this.onBufferCodecs,this),e.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(GS.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(GS.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.off(GS.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(GS.BUFFER_CODECS,this.onBufferCodecs,this),e.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&FS(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&$S.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter(((t,i)=>this.isLevelAllowed(t)&&i<=e));return this.clientRect=null,jA.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,t.width||t.height||(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(e){}return e}isLevelAllowed(e){return!this.restrictedLevels.some((t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height))}static getMaxLevelByMediaSize(e,t,i){if(null==e||!e.length)return-1;let n=e.length-1;const s=Math.max(t,i);for(let t=0;t<e.length;t+=1){const i=e[t];if((i.width>=s||i.height>=s)&&(r=i,!(o=e[t+1])||r.width!==o.width||r.height!==o.height)){n=t;break}}var r,o;return n}}const WA="[eme]";class HA{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=HA.CDMCleanupPromise?[HA.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=$S.debug.bind($S,WA),this.log=$S.log.bind($S,WA),this.warn=$S.warn.bind($S,WA),this.error=$S.error.bind($S,WA),this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(GS.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(GS.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(GS.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(GS.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(GS.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(GS.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,n=t[e];if(n)return n.licenseUrl;if(e===lv.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${e}"`)}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(e,t,i)=>!!e&&i.indexOf(e)===t,n=t.map((e=>e.audioCodec)).filter(i),s=t.map((e=>e.videoCodec)).filter(i);return n.length+s.length===0&&s.push("avc1.42e01e"),new Promise(((t,i)=>{const r=e=>{const o=e.shift();this.getMediaKeysPromise(o,n,s).then((e=>t({keySystem:o,mediaKeys:e}))).catch((t=>{e.length?r(e):i(t instanceof KA?t:new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))}))};r(e)}))}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if("function"!=typeof i){let e=`Configured requestMediaKeySystemAccess is not a function ${i}`;return null===Ev&&"http:"===self.location.protocol&&(e=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(e))}return i(e,t)}getMediaKeysPromise(e,t,i){const n=function(e,t,i,n){let s;switch(e){case lv.FAIRPLAY:s=["cenc","sinf"];break;case lv.WIDEVINE:case lv.PLAYREADY:s=["cenc"];break;case lv.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${e}`)}return function(e,t,i,n){return[{initDataTypes:e,persistentState:n.persistentState||"optional",distinctiveIdentifier:n.distinctiveIdentifier||"optional",sessionTypes:n.sessionTypes||[n.sessionType||"temporary"],audioCapabilities:t.map((e=>({contentType:`audio/mp4; codecs="${e}"`,robustness:n.audioRobustness||"",encryptionScheme:n.audioEncryptionScheme||null}))),videoCapabilities:i.map((e=>({contentType:`video/mp4; codecs="${e}"`,robustness:n.videoRobustness||"",encryptionScheme:n.videoEncryptionScheme||null})))}]}(s,t,i,n)}(e,t,i,this.config.drmSystemOptions),s=this.keySystemAccessPromises[e];let r=null==s?void 0:s.keySystemAccess;if(!r){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(n)}`),r=this.requestMediaKeySystemAccess(e,n);const t=this.keySystemAccessPromises[e]={keySystemAccess:r};return r.catch((t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)})),r.then((i=>{this.log(`Access for key-system "${i.keySystem}" obtained`);const n=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),t.mediaKeys=i.createMediaKeys().then((t=>(this.log(`Media-keys created for "${e}"`),n.then((i=>i?this.setMediaKeysServerCertificate(t,e,i):t))))),t.mediaKeys.catch((t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)})),t.mediaKeys}))}return r.then((()=>s.mediaKeys))}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${Uv.hexDump(e.keyId||[])}`);const n=i.createSession(),s={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:n,keyStatus:"status-pending"};return this.mediaKeySessions.push(s),s}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),n=this.getKeyIdString(t),s="cenc";this.keyIdToKeySessionPromise[n]=this.generateRequestWithPreferredKeySession(i,s,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return Uv.hexDump(e.keyId)}updateKeySession(e,t){var i;const n=e.mediaKeysSession;return this.log(`Updating key-session "${n.sessionId}" for keyID ${Uv.hexDump((null==(i=e.decryptdata)?void 0:i.keyId)||[])}\n      } (data length: ${t?t.byteLength:t})`),n.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise(((t,i)=>{const n=mv(this.config),s=e.map(uv).filter((e=>!!e&&-1!==n.indexOf(e)));return this.getKeySystemSelectionPromise(s).then((({keySystem:e})=>{const n=fv(e);n?t(n):i(new Error(`Unable to find format for key-system "${e}"`))})).catch(i)}))}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),n=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${n}`);let s=this.keyIdToKeySessionPromise[i];return s||(s=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(t).then((({keySystem:i,mediaKeys:s})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${n}`),this.attemptSetMediaKeys(i,s).then((()=>{this.throwIfDestroyed();const e=this.createMediaKeySessionContext({keySystem:i,mediaKeys:s,decryptdata:t});return this.generateRequestWithPreferredKeySession(e,"cenc",t.pssh,"playlist-key")}))))),s.catch((e=>this.handleError(e)))),s}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof KA?this.hls.trigger(GS.ERROR,e.data):this.hls.trigger(GS.ERROR,{type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const t=uv(e.keyFormat),i=t?[t]:mv(this.config);return this.attemptKeySystemAccess(i)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=mv(this.config)),0===e.length)throw new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}_onMediaEncrypted(e){const{initDataType:t,initData:i}=e;if(this.debug(`"${e.type}" event: init data type: "${t}"`),null===i)return;let n,s;if("sinf"===t&&this.config.drmSystems[lv.FAIRPLAY]){const e=Bv(new Uint8Array(i));try{const t=ov(JSON.parse(e).sinf),i=Zv(new Uint8Array(t));if(!i)return;n=i.subarray(8,24),s=lv.FAIRPLAY}catch(e){return void this.warn('Failed to parse sinf "encrypted" event message initData')}}else{const e=function(e){if(!(e instanceof ArrayBuffer)||e.byteLength<32)return null;const t={version:0,systemId:"",kids:null,data:null},i=new DataView(e),n=i.getUint32(0);if(e.byteLength!==n&&n>44)return null;if(1886614376!==i.getUint32(4))return null;if(t.version=i.getUint32(8)>>>24,t.version>1)return null;t.systemId=Uv.hexDump(new Uint8Array(e,12,16));const s=i.getUint32(28);if(0===t.version){if(n-32<s)return null;t.data=new Uint8Array(e,32,s)}else if(1===t.version){t.kids=[];for(let i=0;i<s;i++)t.kids.push(new Uint8Array(e,32+16*i,16))}return t}(i);if(null===e)return;0===e.version&&e.systemId===pv.WIDEVINE&&e.data&&(n=e.data.subarray(8,24)),s=function(e){if(e===pv.WIDEVINE)return lv.WIDEVINE}(e.systemId)}if(!s||!n)return;const r=Uv.hexDump(n),{keyIdToKeySessionPromise:o,mediaKeySessions:a}=this;let c=o[r];for(let e=0;e<a.length;e++){const s=a[e],d=s.decryptdata;if(d.pssh||!d.keyId)continue;const l=Uv.hexDump(d.keyId);if(r===l||-1!==d.uri.replace(/-/g,"").indexOf(r)){c=o[l],delete o[l],d.pssh=new Uint8Array(i),d.keyId=n,c=o[r]=c.then((()=>this.generateRequestWithPreferredKeySession(s,t,i,"encrypted-event-key-match")));break}}c||(c=o[r]=this.getKeySystemSelectionPromise([s]).then((({keySystem:e,mediaKeys:s})=>{var o;this.throwIfDestroyed();const a=new cR("ISO-23001-7",r,null!=(o=fv(e))?o:"");return a.pssh=new Uint8Array(i),a.keyId=n,this.attemptSetMediaKeys(e,s).then((()=>{this.throwIfDestroyed();const n=this.createMediaKeySessionContext({decryptdata:a,keySystem:e,mediaKeys:s});return this.generateRequestWithPreferredKeySession(n,t,i,"encrypted-event-no-match")}))}))),c.catch((e=>this.handleError(e)))}_onWaitingForKey(e){this.log(`"${e.type}" event`)}attemptSetMediaKeys(e,t){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const n=Promise.all(i).then((()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)}));return this.setMediaKeysQueue.push(n),n.then((()=>{this.log(`Media-keys set for "${e}"`),i.push(n),this.setMediaKeysQueue=this.setMediaKeysQueue.filter((e=>-1===i.indexOf(e)))}))}generateRequestWithPreferredKeySession(e,t,i,n){var s,r;const o=null==(s=this.config.drmSystems)||null==(r=s[e.keySystem])?void 0:r.generateRequest;if(o)try{const n=o.call(this.hls,t,i,e);if(!n)throw new Error("Invalid response from configured generateRequest filter");t=n.initDataType,i=e.decryptdata.pssh=n.initData?new Uint8Array(n.initData):null}catch(e){var a;if(this.warn(e.message),null!=(a=this.hls)&&a.config.debug)throw e}if(null===i)return this.log(`Skipping key-session request for "${n}" (no initData)`),Promise.resolve(e);const c=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${n}": ${c} (init data type: ${t} length: ${i?i.byteLength:null})`);const d=new xI,l=e._onmessage=t=>{const i=e.mediaKeysSession;if(!i)return void d.emit("error",new Error("invalid state"));const{messageType:n,message:s}=t;this.log(`"${n}" message event for session "${i.sessionId}" message size: ${s.byteLength}`),"license-request"===n||"license-renewal"===n?this.renewLicense(e,s).catch((e=>{this.handleError(e),d.emit("error",e)})):"license-release"===n?e.keySystem===lv.FAIRPLAY&&(this.updateKeySession(e,cv("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${n}"`)},h=e._onkeystatuseschange=t=>{if(!e.mediaKeysSession)return void d.emit("error",new Error("invalid state"));this.onKeyStatusChange(e);const i=e.keyStatus;d.emit("keyStatus",i),"expired"===i&&(this.warn(`${e.keySystem} expired for key ${c}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",l),e.mediaKeysSession.addEventListener("keystatuseschange",h);const u=new Promise(((e,t)=>{d.on("error",t),d.on("keyStatus",(i=>{i.startsWith("usable")?e():"output-restricted"===i?t(new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===i?t(new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${i}"`)):"expired"===i?t(new Error("key expired while generating request")):this.warn(`unhandled key status change "${i}"`)}))}));return e.mediaKeysSession.generateRequest(t,i).then((()=>{var t;this.log(`Request generated for key-session "${null==(t=e.mediaKeysSession)?void 0:t.sessionId}" keyId: ${c}`)})).catch((e=>{throw new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},`Error generating key-session request: ${e}`)})).then((()=>u)).catch((t=>{throw d.removeAllListeners(),this.removeSession(e),t})).then((()=>(d.removeAllListeners(),e)))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach(((t,i)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${Uv.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${Uv.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t}))}fetchServerCertificate(e){const t=this.config,i=new(0,t.loader)(t),n=this.getServerCertificateUrl(e);return n?(this.log(`Fetching server certificate for "${e}"`),new Promise(((s,r)=>{const o={responseType:"arraybuffer",url:n},a=t.certLoadPolicy.default,c={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(e,t,i,n)=>{s(e.data)},onError:(t,i,s,a)=>{r(new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:kS({url:o.url,data:void 0},t)},`"${e}" certificate request failed (${n}). Status: ${t.code} (${t.text})`))},onTimeout:(t,i,s)=>{r(new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:{url:o.url,data:void 0}},`"${e}" certificate request timed out (${n})`))},onAbort:(e,t,i)=>{r(new Error("aborted"))}};i.load(o,c,d)}))):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise(((n,s)=>{e.setServerCertificate(i).then((s=>{this.log(`setServerCertificate ${s?"success":"not supported by CDM"} (${null==i?void 0:i.byteLength}) on "${t}"`),n(e)})).catch((e=>{s(new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))}))}))}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then((t=>this.updateKeySession(e,new Uint8Array(t)).catch((e=>{throw new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const n=(new DOMParser).parseFromString(i,"application/xml"),s=n.querySelectorAll("HttpHeader");if(s.length>0){let t;for(let i=0,n=s.length;i<n;i++){var r,o;t=s[i];const n=null==(r=t.querySelector("name"))?void 0:r.textContent,a=null==(o=t.querySelector("value"))?void 0:o.textContent;n&&a&&e.setRequestHeader(n,a)}}const a=n.querySelector("Challenge"),c=null==a?void 0:a.textContent;if(!c)throw new Error("Cannot find <Challenge> in key message");return cv(atob(c))}setupLicenseXHR(e,t,i,n){const s=this.config.licenseXhrSetup;return s?Promise.resolve().then((()=>{if(!i.decryptdata)throw new Error("Key removed");return s.call(this.hls,e,t,i,n)})).catch((r=>{if(!i.decryptdata)throw r;return e.open("POST",t,!0),s.call(this.hls,e,t,i,n)})).then((i=>{e.readyState||e.open("POST",t,!0);return{xhr:e,licenseChallenge:i||n}})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:n}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise(((n,s)=>{const r=this.getLicenseServerUrl(e.keySystem);this.log(`Sending license request to URL: ${r}`);const o=new XMLHttpRequest;o.responseType="arraybuffer",o.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return s(new Error("invalid state"));if(4===o.readyState)if(200===o.status){this._requestLicenseFailureCount=0;let t=o.response;this.log(`License received ${t instanceof ArrayBuffer?t.byteLength:t}`);const i=this.config.licenseResponseCallback;if(i)try{t=i.call(this.hls,o,r,e)}catch(e){this.error(e)}n(t)}else{const a=i.errorRetry,c=a?a.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||o.status>=400&&o.status<500)s(new KA({type:jS.KEY_SYSTEM_ERROR,details:WS.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:o,response:{url:r,data:void 0,code:o.status,text:o.statusText}},`License Request XHR failed (${r}). Status: ${o.status} (${o.statusText})`));else{const i=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${i} attempts left`),this.requestLicense(e,t).then(n,s)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=o,this.setupLicenseXHR(o,r,e,t).then((({xhr:t,licenseChallenge:i})=>{e.keySystem==lv.PLAYREADY&&(i=this.unpackPlayReadyKeyMessage(t,i)),t.send(i)}))}))}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},cR.clearKeyUriToKeyIdMap();const i=t.length;HA.CDMCleanupPromise=Promise.all(t.map((e=>this.removeSession(e))).concat(null==e?void 0:e.setMediaKeys(null).catch((e=>{this.log(`Could not clear media keys: ${e}`)})))).then((()=>{i&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)})).catch((e=>{this.log(`Could not close sessions and clear media keys: ${e}`)}))}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(t&&this.config.emeEnabled&&!this.keyFormatPromise){const e=t.reduce(((e,t)=>(-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e)),[]);this.log(`Selecting key-system from session-keys ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const n=this.mediaKeySessions.indexOf(e);return n>-1&&this.mediaKeySessions.splice(n,1),t.remove().catch((e=>{this.log(`Could not remove session: ${e}`)})).then((()=>t.close())).catch((e=>{this.log(`Could not close session: ${e}`)}))}}}HA.CDMCleanupPromise=void 0;class KA extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}var YA,qA,$A;!function(e){e.MANIFEST="m",e.AUDIO="a",e.VIDEO="v",e.MUXED="av",e.INIT="i",e.CAPTION="c",e.TIMED_TEXT="tt",e.KEY="k",e.OTHER="o"}(YA||(YA={})),function(e){e.DASH="d",e.HLS="h",e.SMOOTH="s",e.OTHER="o"}(qA||(qA={})),function(e){e.OBJECT="CMCD-Object",e.REQUEST="CMCD-Request",e.SESSION="CMCD-Session",e.STATUS="CMCD-Status"}($A||($A={}));const zA={[$A.OBJECT]:["br","d","ot","tb"],[$A.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[$A.SESSION]:["cid","pr","sf","sid","st","v"],[$A.STATUS]:["bs","rtp"]};class XA{constructor(e,t){this.value=void 0,this.params=void 0,Array.isArray(e)&&(e=e.map((e=>e instanceof XA?e:new XA(e)))),this.value=e,this.params=t}}class JA{constructor(e){this.description=void 0,this.description=e}}const QA="Dict";function ZA(e,t,i,n){return new Error(`failed to ${e} "${s=t,Array.isArray(s)?JSON.stringify(s):s instanceof Map?"Map{}":s instanceof Set?"Set{}":"object"==typeof s?JSON.stringify(s):String(s)}" as ${i}`,{cause:n});var s}const eb="Bare Item",tb="Boolean",ib="Byte Sequence",nb="Decimal",sb="Integer";const rb=/[\x00-\x1f\x7f]+/,ob="Token",ab="Key";function cb(e,t,i){return ZA("serialize",e,t,i)}function db(e){if(!1===ArrayBuffer.isView(e))throw cb(e,ib);return`:${t=e,btoa(String.fromCharCode(...t))}:`;var t}function lb(e){if(function(e){return e<-999999999999999||999999999999999<e}(e))throw cb(e,sb);return e.toString()}function hb(e,t){if(e<0)return-hb(-e,t);const i=Math.pow(10,t);if(Math.abs(e*i%1-.5)<Number.EPSILON){const t=Math.floor(e*i);return(t%2==0?t:t+1)/i}return Math.round(e*i)/i}function ub(e){const t=hb(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw cb(e,nb);const i=t.toString();return i.includes(".")?i:`${i}.0`}const pb="String";function fb(e){const t=function(e){return e.description||e.toString().slice(7,-1)}(e);if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t))throw cb(t,ob);return t}function mb(e){switch(typeof e){case"number":if(!FS(e))throw cb(e,eb);return Number.isInteger(e)?lb(e):ub(e);case"string":return function(e){if(rb.test(e))throw cb(e,pb);return`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}(e);case"symbol":return fb(e);case"boolean":return function(e){if("boolean"!=typeof e)throw cb(e,tb);return e?"?1":"?0"}(e);case"object":if(e instanceof Date)return function(e){return`@${lb(e.getTime()/1e3)}`}(e);if(e instanceof Uint8Array)return db(e);if(e instanceof JA)return fb(e);default:throw cb(e,eb)}}function Eb(e){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(e))throw cb(e,ab);return e}function _b(e){return null==e?"":Object.entries(e).map((([e,t])=>!0===t?`;${Eb(e)}`:`;${Eb(e)}=${mb(t)}`)).join("")}function gb(e){return e instanceof XA?`${mb(e.value)}${_b(e.params)}`:mb(e)}function Tb(e,t={whitespace:!0}){if("object"!=typeof e)throw cb(e,QA);const i=e instanceof Map?e.entries():Object.entries(e),n=null!=t&&t.whitespace?" ":"";return Array.from(i).map((([e,t])=>{t instanceof XA==!1&&(t=new XA(t));let i=Eb(e);var n;return!0===t.value?i+=_b(t.params):(i+="=",Array.isArray(t.value)?i+=`(${(n=t).value.map(gb).join(" ")})${_b(n.params)}`:i+=gb(t)),i})).join(`,${n}`)}const Sb=e=>"ot"===e||"sf"===e||"st"===e,vb=e=>"number"==typeof e?FS(e):null!=e&&""!==e&&!1!==e;const Rb=e=>Math.round(e),yb=e=>100*Rb(e/100),Cb={br:Rb,d:Rb,bl:yb,dl:yb,mtp:yb,nor:(e,t)=>(null!=t&&t.baseUrl&&(e=function(e,t){const i=new URL(e),n=new URL(t);if(i.origin!==n.origin)return e;const s=i.pathname.split("/").slice(1),r=n.pathname.split("/").slice(1,-1);for(;s[0]===r[0];)s.shift(),r.shift();for(;r.length;)r.shift(),s.unshift("..");return s.join("/")}(e,t.baseUrl)),encodeURIComponent(e)),rtp:yb,tb:Rb};function Ib(e,t={}){return e?function(e,t){return Tb(e,t)}(function(e,t){const i={};if(null==e||"object"!=typeof e)return i;const n=Object.keys(e).sort(),s=xS({},Cb,null==t?void 0:t.formatters),r=null==t?void 0:t.filter;return n.forEach((n=>{if(null!=r&&r(n))return;let o=e[n];const a=s[n];a&&(o=a(o,t)),"v"===n&&1===o||"pr"==n&&1===o||vb(o)&&(Sb(n)&&"string"==typeof o&&(o=new JA(o)),i[n]=o)})),i}(e,t),xS({whitespace:!1},t)):""}function Ab(e,t,i){return xS(e,function(e,t={}){if(!e)return{};const i=Object.entries(e),n=Object.entries(zA).concat(Object.entries((null==t?void 0:t.customHeaderMap)||{})),s=i.reduce(((e,t)=>{var i;const[s,r]=t,o=(null==(i=n.find((e=>e[1].includes(s))))?void 0:i[0])||$A.REQUEST;return null!=e[o]||(e[o]={}),e[o][s]=r,e}),{});return Object.entries(s).reduce(((e,[i,n])=>(e[i]=Ib(n,t),e)),{})}(t,i))}const bb="CMCD";const wb=/CMCD=[^&#]+/;function Db(e,t,i){const n=function(e,t={}){if(!e)return"";const i=Ib(e,t);return`${bb}=${encodeURIComponent(i)}`}(t,i);if(!n)return e;if(wb.test(e))return e.replace(wb,n);const s=e.includes("?")?"&":"?";return`${e}${s}${n}`}function Ob(e,t,i,n){e&&Object.keys(t).forEach((s=>{const r=e.filter((e=>e.groupId===s)).map((e=>{const r=xS({},e);return r.details=void 0,r.attrs=new JS(r.attrs),r.url=r.attrs.URI=Nb(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",i),r.groupId=r.attrs["GROUP-ID"]=t[s],r.attrs["PATHWAY-ID"]=n,r}));e.push(...r)}))}function Nb(e,t,i,n){const{HOST:s,PARAMS:r,[i]:o}=n;let a;t&&(a=null==o?void 0:o[t],a&&(e=a));const c=new self.URL(e);return s&&!a&&(c.host=s),r&&Object.keys(r).sort().forEach((e=>{e&&c.searchParams.set(e,r[e])})),c.href}const Lb=/^age:\s*[\d.]+\s*$/im;class Pb{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new ev,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null,this.stats=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,n=this.stats;n.loading.first=0,n.loaded=0,n.aborted=!1;const s=this.xhrSetup;s?Promise.resolve().then((()=>{if(!this.stats.aborted)return s(i,t.url)})).catch((e=>(i.open("GET",t.url,!0),s(i,t.url)))).then((()=>{this.stats.aborted||this.openAndSendXhr(i,t,e)})).catch((e=>{this.callbacks.onError({code:i.status,text:e.message},t,i,n)})):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const n=t.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:r}=i.loadPolicy;if(n)for(const t in n)e.setRequestHeader(t,n[t]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&FS(s)?s:r,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const n=t.readyState,s=this.config;if(!i.aborted&&n>=2&&(0===i.loading.first&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),4===n)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const n=t.status,r="text"!==t.responseType;if(n>=200&&n<300&&(r&&t.response||null!==t.responseText)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const s=r?t.response:t.responseText,o="arraybuffer"===t.responseType?s.byteLength:s.length;if(i.loaded=i.total=o,i.bwEstimate=8e3*i.total/(i.loading.end-i.loading.first),!this.callbacks)return;const a=this.callbacks.onProgress;if(a&&a(i,e,s,t),!this.callbacks)return;const c={url:t.responseURL,data:s,code:n};this.callbacks.onSuccess(c,i,e,t)}else{const r=s.loadPolicy.errorRetry;Ry(r,i.retry,!1,{url:e.url,data:void 0,code:n})?this.retry(r):($S.error(`${n} while loading ${e.url}`),this.callbacks.onError({code:n,text:t.statusText},e,t,i))}}}loadtimeout(){var e;const t=null==(e=this.config)?void 0:e.loadPolicy.timeoutRetry;if(Ry(t,this.stats.retry,!0))this.retry(t);else{var i;$S.warn(`timeout while loading ${null==(i=this.context)?void 0:i.url}`);const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=Sy(e,i.retry),i.retry++,$S.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==t?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&Lb.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const kb=/(\d+)-(\d+)\/(\d+)/;class Mb{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||Ub,this.controller=new self.AbortController,this.stats=new ev}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const n=this.stats;if(n.loading.start)throw new Error("Loader can only be used once.");n.loading.start=self.performance.now();const s=function(e,t){const i={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(xS({},e.headers))};e.rangeEnd&&i.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1));return i}(e,this.controller.signal),r=i.onProgress,o="arraybuffer"===e.responseType,a=o?"byteLength":"length",{maxTimeToFirstByteMs:c,maxLoadTimeMs:d}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,s),self.clearTimeout(this.requestTimeout),t.timeout=c&&FS(c)?c:d,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(n,e,this.response)}),t.timeout),self.fetch(this.request).then((s=>{this.response=this.loader=s;const a=Math.max(self.performance.now(),n.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=d,this.requestTimeout=self.setTimeout((()=>{this.abortInternal(),i.onTimeout(n,e,this.response)}),d-(a-n.loading.start)),!s.ok){const{status:e,statusText:t}=s;throw new xb(t||"fetch, bad network response",e,s)}return n.loading.first=a,n.total=function(e){const t=e.get("Content-Range");if(t){const e=function(e){const t=kb.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}(t);if(FS(e))return e}const i=e.get("Content-Length");if(i)return parseInt(i)}(s.headers)||n.total,r&&FS(t.highWaterMark)?this.loadProgressively(s,n,e,t.highWaterMark,r):o?s.arrayBuffer():"json"===e.responseType?s.json():s.text()})).then((s=>{const o=this.response;if(!o)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),n.loading.end=Math.max(self.performance.now(),n.loading.first);const c=s[a];c&&(n.loaded=n.total=c);const d={url:o.url,data:s,code:o.status};r&&!FS(t.highWaterMark)&&r(n,e,s,o),i.onSuccess(d,n,e,o)})).catch((t=>{if(self.clearTimeout(this.requestTimeout),n.aborted)return;const s=t&&t.code||0,r=t?t.message:null;i.onError({code:s,text:r},e,t?t.details:null,n)}))}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,n=0,s){const r=new LC,o=e.body.getReader(),a=()=>o.read().then((o=>{if(o.done)return r.dataLength&&s(t,i,r.flush(),e),Promise.resolve(new ArrayBuffer(0));const c=o.value,d=c.length;return t.loaded+=d,d<n||r.dataLength?(r.push(c),r.dataLength>=n&&s(t,i,r.flush(),e)):s(t,i,c,e),a()})).catch((()=>Promise.reject()));return a()}}function Ub(e,t){return new self.Request(e.url,t)}class xb extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const Fb=/\s/,Vb={newCue(e,t,i,n){const s=[];let r,o,a,c,d;const l=self.VTTCue||self.TextTrackCue;for(let u=0;u<n.rows.length;u++)if(r=n.rows[u],a=!0,c=0,d="",!r.isEmpty()){var h;for(let e=0;e<r.chars.length;e++)Fb.test(r.chars[e].uchar)&&a?c++:(d+=r.chars[e].uchar,a=!1);r.cueStartTime=t,t===i&&(i+=1e-4),c>=16?c--:c++;const n=SA(d.trim()),p=AA(t,i,n);null!=e&&null!=(h=e.cues)&&h.getCueById(p)||(o=new l(t,i,n),o.id=p,o.line=u+1,o.align="left",o.position=10+Math.min(80,10*Math.floor(8*c/32)),s.push(o))}return e&&s.length&&(s.sort(((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line)),s.forEach((t=>KR(e,t)))),s}},Bb=kS(kS({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Pb,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:class{constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:e,partCurrent:t,hls:i}=this,{autoLevelEnabled:n,media:s}=i;if(!e||!s)return;const r=performance.now(),o=t?t.stats:e.stats,a=t?t.duration:e.duration,c=r-o.loading.start,d=i.minAutoLevel;if(o.aborted||o.loaded&&o.loaded===o.total||e.level<=d)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!n||s.paused||!s.playbackRate||!s.readyState)return;const l=i.mainForwardBufferInfo;if(null===l)return;const h=this.bwEstimator.getEstimateTTFB(),u=Math.abs(s.playbackRate);if(c<=Math.max(h,a/(2*u)*1e3))return;const p=l.len/u,f=o.loading.first?o.loading.first-o.loading.start:-1,m=o.loaded&&f>-1,E=this.getBwEstimate(),_=i.levels,g=_[e.level],T=o.total||Math.max(o.loaded,Math.round(a*g.averageBitrate/8));let S=m?c-f:c;S<1&&m&&(S=Math.min(c,8*o.loaded/E));const v=m?1e3*o.loaded/S:0,R=v?(T-o.loaded)/v:8*T/E+h/1e3;if(R<=p)return;const y=v?8*v:E;let C,I=Number.POSITIVE_INFINITY;for(C=e.level-1;C>d;C--){const e=_[C].maxBitrate;if(I=this.getTimeToLoadFrag(h/1e3,y,a*e,!_[C].details),I<p)break}if(I>=R)return;if(I>10*a)return;i.nextLoadLevel=i.nextAutoLevel=C,m?this.bwEstimator.sample(c-Math.min(h,f),o.loaded):this.bwEstimator.sampleTTFB(c);const A=_[C].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>A&&this.resetEstimator(A),this.clearTimer(),$S.warn(`[abr] Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} is loading too slowly;\n      Time to underbuffer: ${p.toFixed(3)} s\n      Estimated load time for current fragment: ${R.toFixed(3)} s\n      Estimated load time for down switch fragment: ${I.toFixed(3)} s\n      TTFB estimate: ${0|f} ms\n      Current BW estimate: ${FS(E)?0|E:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${C} @ ${0|A} bps`),i.trigger(GS.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:t,stats:o})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&($S.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new Uy(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.FRAG_LOADING,this.onFragLoading,this),e.on(GS.FRAG_LOADED,this.onFragLoaded,this),e.on(GS.FRAG_BUFFERED,this.onFragBuffered,this),e.on(GS.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.on(GS.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(GS.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(GS.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.FRAG_LOADING,this.onFragLoading,this),e.off(GS.FRAG_LOADED,this.onFragLoaded,this),e.off(GS.FRAG_BUFFERED,this.onFragBuffered,this),e.off(GS.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.off(GS.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(GS.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(GS.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){var n;if(!i.bitrateTest)this.fragCurrent=i,this.partCurrent=null!=(n=t.part)?n:null;this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case WS.BUFFER_ADD_CODEC_ERROR:case WS.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case WS.FRAG_LOAD_TIMEOUT:{const e=t.frag,{fragCurrent:i,partCurrent:n}=this;if(e&&i&&e.sn===i.sn&&e.level===i.level){const t=performance.now(),i=n?n.stats:e.stats,s=t-i.loading.start,r=i.loading.first?i.loading.first-i.loading.start:-1;if(i.loaded&&r>-1){const e=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(s-Math.min(e,r),i.loaded)}else this.bwEstimator.sampleTTFB(s)}break}}}getTimeToLoadFrag(e,t,i,n){return e+i/t+(n?this.lastLevelLoadSec:0)}onLevelLoaded(e,t){const i=this.hls.config,{loading:n}=t.stats,s=n.end-n.start;FS(s)&&(this.lastLevelLoadSec=s/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(e,{frag:t,part:i}){const n=i?i.stats:t.stats;if(t.type===BR.MAIN&&this.bwEstimator.sampleTTFB(n.loading.first-n.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const e=i?i.duration:t.duration,s=this.hls.levels[t.level],r=(s.loaded?s.loaded.bytes:0)+n.loaded,o=(s.loaded?s.loaded.duration:0)+e;s.loaded={bytes:r,duration:o},s.realBitrate=Math.round(8*r/o)}if(t.bitrateTest){const e={stats:n,frag:t,part:i,id:t.type};this.onFragBuffered(GS.FRAG_BUFFERED,e),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:n}=t,s=null!=n&&n.stats.loaded?n.stats:i.stats;if(s.aborted)return;if(this.ignoreFragment(i))return;const r=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(r,s.loaded),s.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=r/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==BR.MAIN||"initSegment"===e.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),n=this.hls.config.maxStarvationDelay,s=this.findBestLevel(i,t,e,0,n,1,1);if(s>-1)return s;const r=this.hls.firstLevel,o=Math.min(Math.max(r,t),e);return $S.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${r} clamped to ${o}`),o}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(!(-1===e||t&&i&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return e;const n=t&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==e){const t=this.hls.levels;if(t.length>Math.max(e,n)&&t[e].loadError<=t[n].loadError)return e}return this._nextAutoLevel=n,this.nextAutoLevelKey=this.getAutoLevelKey(),n}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{maxAutoLevel:n,config:s,minAutoLevel:r}=i,o=t?t.duration:e?e.duration:0,a=this.getBwEstimate(),c=this.getStarvationDelay();let d=s.abrBandWidthFactor,l=s.abrBandWidthUpFactor;if(c){const e=this.findBestLevel(a,r,n,c,0,d,l);if(e>=0)return e}let h=o?Math.min(o,s.maxStarvationDelay):s.maxStarvationDelay;if(!c){const e=this.bitrateTestDelay;if(e){h=(o?Math.min(o,s.maxLoadingDelay):s.maxLoadingDelay)-e,$S.info(`[abr] bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*h)} ms`),d=l=1}}const u=this.findBestLevel(a,r,n,c,h,d,l);if($S.info(`[abr] ${c?"rebuffering expected":"buffer is empty"}, optimal quality level ${u}`),u>-1)return u;const p=i.levels[r],f=i.levels[i.loadLevel];return(null==p?void 0:p.bitrate)<(null==f?void 0:f.bitrate)?r:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1,n=e.mainForwardBufferInfo;return(n?n.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,n,s,r,o){var a;const c=n+s,d=this.lastLoadedFragLevel,l=-1===d?this.hls.firstLevel:d,{fragCurrent:h,partCurrent:u}=this,{levels:p,allAudioTracks:f,loadLevel:m,config:E}=this.hls;if(1===p.length)return 0;const _=p[l],g=!(null==_||null==(a=_.details)||!a.live),T=-1===m||-1===d;let S,v="SDR",R=(null==_?void 0:_.frameRate)||0;const{audioPreference:y,videoPreference:C}=E,I=this.audioTracksByGroup||(this.audioTracksByGroup=function(e){return e.reduce(((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const n=t.channels||"2";return i.channels[n]=(i.channels[n]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e}),{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}(f));if(T){if(-1!==this.firstSelection)return this.firstSelection;const n=this.codecTiers||(this.codecTiers=function(e,t,i,n){return e.slice(i,n+1).reduce(((e,i)=>{if(!i.codecSet)return e;const n=i.audioGroups;let s=e[i.codecSet];s||(e[i.codecSet]=s={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!n,fragmentError:0}),s.minBitrate=Math.min(s.minBitrate,i.bitrate);const r=Math.min(i.height,i.width);return s.minHeight=Math.min(s.minHeight,r),s.minFramerate=Math.min(s.minFramerate,i.frameRate),s.maxScore=Math.max(s.maxScore,i.score),s.fragmentError+=i.fragmentError,s.videoRanges[i.videoRange]=(s.videoRanges[i.videoRange]||0)+1,n&&n.forEach((e=>{if(!e)return;const i=t.groups[e];s.hasDefaultAudio=s.hasDefaultAudio||t.hasDefaultAudio?i.hasDefault:i.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(i.channels).forEach((e=>{s.channels[e]=(s.channels[e]||0)+i.channels[e]}))})),e}),{})}(p,I,t,i)),s=function(e,t,i,n,s){const r=Object.keys(e),o=null==n?void 0:n.channels,a=null==n?void 0:n.audioCodec,c=o&&2===parseInt(o);let d=!0,l=!1,h=1/0,u=1/0,p=1/0,f=0,m=[];const{preferHDR:E,allowedVideoRanges:_}=Gy(t,s);for(let t=r.length;t--;){const i=e[r[t]];d=i.channels[2]>0,h=Math.min(h,i.minHeight),u=Math.min(u,i.minFramerate),p=Math.min(p,i.minBitrate);const n=_.filter((e=>i.videoRanges[e]>0));n.length>0&&(l=!0,m=n)}h=FS(h)?h:0,u=FS(u)?u:0;const g=Math.max(1080,h),T=Math.max(30,u);return p=FS(p)?p:i,i=Math.max(p,i),l||(t=void 0,m=[]),{codecSet:r.reduce(((t,n)=>{const s=e[n];if(n===t)return t;if(s.minBitrate>i)return jy(n,`min bitrate of ${s.minBitrate} > current estimate of ${i}`),t;if(!s.hasDefaultAudio)return jy(n,"no renditions with default or auto-select sound found"),t;if(a&&n.indexOf(a.substring(0,4))%5!=0)return jy(n,`audio codec preference "${a}" not found`),t;if(o&&!c){if(!s.channels[o])return jy(n,`no renditions with ${o} channel sound found (channels options: ${Object.keys(s.channels)})`),t}else if((!a||c)&&d&&0===s.channels[2])return jy(n,"no renditions with stereo sound found"),t;return s.minHeight>g?(jy(n,`min resolution of ${s.minHeight} > maximum of ${g}`),t):s.minFramerate>T?(jy(n,`min framerate of ${s.minFramerate} > maximum of ${T}`),t):m.some((e=>s.videoRanges[e]>0))?s.maxScore<f?(jy(n,`max score of ${s.maxScore} < selected max of ${f}`),t):t&&(vR(n)>=vR(t)||s.fragmentError>e[t].fragmentError)?t:(f=s.maxScore,n):(jy(n,`no variants with VIDEO-RANGE of ${JSON.stringify(m)} found`),t)}),void 0),videoRanges:m,preferHDR:E,minFramerate:u,minBitrate:p}}(n,v,e,y,C),{codecSet:r,videoRanges:o,minFramerate:a,minBitrate:c,preferHDR:d}=s;S=r,v=d?o[o.length-1]:o[0],R=a,e=Math.max(e,c),$S.log(`[abr] picked start tier ${JSON.stringify(s)}`)}else S=null==_?void 0:_.codecSet,v=null==_?void 0:_.videoRange;const A=u?u.duration:h?h.duration:0,b=this.bwEstimator.getEstimateTTFB()/1e3,w=[];for(let a=i;a>=t;a--){var D;const t=p[a],h=a>l;if(!t)continue;if(E.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){const i=navigator.mediaCapabilities;"function"==typeof(null==i?void 0:i.decodingInfo)&&Vy(t,I,v,R,e,y)?(t.supportedPromise=By(t,I,i),t.supportedPromise.then((e=>{if(!this.hls)return;t.supportedResult=e;const i=this.hls.levels,n=i.indexOf(t);e.error?$S.warn(`[abr] MediaCapabilities decodingInfo error: "${e.error}" for level ${n} ${JSON.stringify(e)}`):e.supported||($S.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${n} ${JSON.stringify(e)}`),n>-1&&i.length>1&&($S.log(`[abr] Removing unsupported level ${n}`),this.hls.removeLevel(n)))}))):t.supportedResult=xy}if(S&&t.codecSet!==S||v&&t.videoRange!==v||h&&R>t.frameRate||!h&&R>0&&R<t.frameRate||t.supportedResult&&(null==(D=t.supportedResult.decodingInfoResults)||!D[0].smooth)){w.push(a);continue}const f=t.details,C=(u?null==f?void 0:f.partTarget:null==f?void 0:f.averagetargetduration)||A;let O;O=h?o*e:r*e;const N=A&&n>=2*A&&0===s?p[a].averageBitrate:p[a].maxBitrate,L=this.getTimeToLoadFrag(b,O,N*C,void 0===f);if(O>=N&&(a===d||0===t.loadError&&0===t.fragmentError)&&(L<=b||!FS(L)||g&&!this.bitrateTestDelay||L<c)){const e=this.forcedAutoLevel;return a===m||-1!==e&&e===m||(w.length&&$S.trace(`[abr] Skipped level(s) ${w.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${p[w[0]].codecs}" ${p[w[0]].videoRange}; not compatible with "${_.codecs}" ${v}`),$S.info(`[abr] switch candidate:${l}->${a} adjustedbw(${Math.round(O)})-bitrate=${Math.round(O-N)} ttfb:${b.toFixed(1)} avgDuration:${C.toFixed(1)} maxFetchDuration:${c.toFixed(1)} fetchDuration:${L.toFixed(1)} firstSelection:${T} codecSet:${S} videoRange:${v} hls.loadLevel:${m}`)),T&&(this.firstSelection=a),a}}return-1}set nextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls,n=Math.min(Math.max(e,i),t);this._nextAutoLevel!==n&&(this.nextAutoLevelKey="",this._nextAutoLevel=n)}},bufferController:class{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=e=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=e=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:e,mediaSource:t}=this;this.log("Media source opened"),e&&(e.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(GS.MEDIA_ATTACHED,{media:e,mediaSource:t})),t&&t.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:e,_objectUrl:t}=this;e!==t&&$S.error(`Media element src was set while attaching MediaSource (${t} > ${e})`)},this.hls=e;const t="[buffer-controller]";this.appendSource=e.config.preferManagedMediaSource&&"undefined"!=typeof self&&self.ManagedMediaSource,this.log=$S.log.bind($S,t),this.warn=$S.warn.bind($S,t),this.error=$S.error.bind($S,t),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:e}=this;e.on(GS.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.on(GS.BUFFER_RESET,this.onBufferReset,this),e.on(GS.BUFFER_APPENDING,this.onBufferAppending,this),e.on(GS.BUFFER_CODECS,this.onBufferCodecs,this),e.on(GS.BUFFER_EOS,this.onBufferEos,this),e.on(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(GS.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(GS.FRAG_PARSED,this.onFragParsed,this),e.on(GS.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(GS.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.off(GS.BUFFER_RESET,this.onBufferReset,this),e.off(GS.BUFFER_APPENDING,this.onBufferAppending,this),e.off(GS.BUFFER_CODECS,this.onBufferCodecs,this),e.off(GS.BUFFER_EOS,this.onBufferEos,this),e.off(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(GS.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(GS.FRAG_PARSED,this.onFragParsed,this),e.off(GS.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new WI(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const i=this.media=t.media,n=mR(this.appendSource);if(i&&n){var s;const e=this.mediaSource=new n;this.log(`created media source: ${null==(s=e.constructor)?void 0:s.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming));const t=this._objectUrl=self.URL.createObjectURL(e);if(this.appendSource)try{i.removeAttribute("src");const n=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||n&&e instanceof n,KI(i),function(e,t){const i=self.document.createElement("source");i.type="video/mp4",i.src=t,e.appendChild(i)}(i,t),i.load()}catch(e){i.src=t}else i.src=t;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:i}=this;if(t){if(this.log("media source detaching"),"open"===t.readyState)try{t.endOfStream()}catch(e){this.warn(`onMediaDetaching: ${e.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming)),e&&(e.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(e.removeAttribute("src"),this.appendSource&&KI(e),e.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(GS.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((e=>{this.resetBuffer(e)})),this._initSourceBuffer()}resetBuffer(e){const t=this.sourceBuffer[e];try{var i;if(t)this.removeBufferListeners(e),this.sourceBuffer[e]=void 0,null!=(i=this.mediaSource)&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t)}catch(t){this.warn(`onBufferReset ${e}`,t)}}onBufferCodecs(e,t){const i=this.getSourceBufferTypes().length,n=Object.keys(t);if(n.forEach((e=>{if(i){const i=this.tracks[e];if(i&&"function"==typeof i.buffer.changeType){var n;const{id:s,codec:r,levelCodec:o,container:a,metadata:c}=t[e],d=IR(i.codec,i.levelCodec),l=null==d?void 0:d.replace(HI,"$1");let h=IR(r,o);const u=null==(n=h)?void 0:n.replace(HI,"$1");if(h&&l!==u){"audio"===e.slice(0,5)&&(h=CR(h,this.appendSource));const t=`${a};codecs=${h}`;this.appendChangeType(e,t),this.log(`switching codec ${d} to ${h}`),this.tracks[e]={buffer:i.buffer,codec:r,container:a,levelCodec:o,metadata:c,id:s}}}}else this.pendingTracks[e]=t[e]})),i)return;const s=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==s&&(this.log(`${s} bufferCodec event(s) expected ${n.join(",")}`),this.bufferCodecEventsExpected=s),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(e,t){const{operationQueue:i}=this,n={execute:()=>{const n=this.sourceBuffer[e];n&&(this.log(`changing ${e} sourceBuffer type to ${t}`),n.changeType(t)),i.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn(`Failed to change ${e} SourceBuffer type`,t)}};i.append(n,e,!!this.pendingTracks[e])}onBufferAppending(e,t){const{hls:i,operationQueue:n,tracks:s}=this,{data:r,type:o,frag:a,part:c,chunkMeta:d}=t,l=d.buffering[o],h=self.performance.now();l.start=h;const u=a.stats.buffering,p=c?c.stats.buffering:null;0===u.start&&(u.start=h),p&&0===p.start&&(p.start=h);const f=s.audio;let m=!1;"audio"===o&&"audio/mpeg"===(null==f?void 0:f.container)&&(m=!this.lastMpegAudioChunk||1===d.id||this.lastMpegAudioChunk.sn!==d.sn,this.lastMpegAudioChunk=d);const E=a.start,_={execute:()=>{if(l.executeStart=self.performance.now(),m){const e=this.sourceBuffer[o];if(e){const t=E-e.timestampOffset;Math.abs(t)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${E} (delta: ${t}) sn: ${a.sn})`),e.timestampOffset=E)}}this.appendExecutor(r,o)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();l.executeEnd=l.end=e,0===u.first&&(u.first=e),p&&0===p.first&&(p.first=e);const{sourceBuffer:t}=this,i={};for(const e in t)i[e]=iC.getBuffered(t[e]);this.appendErrors[o]=0,"audio"===o||"video"===o?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(GS.BUFFER_APPENDED,{type:o,frag:a,part:c,chunkMeta:d,parent:a.type,timeRanges:i})},onError:e=>{const t={type:jS.MEDIA_ERROR,parent:a.type,details:WS.BUFFER_APPEND_ERROR,sourceBufferName:o,frag:a,part:c,chunkMeta:d,error:e,err:e,fatal:!1};if(e.code===DOMException.QUOTA_EXCEEDED_ERR)t.details=WS.BUFFER_FULL_ERROR;else{const e=++this.appendErrors[o];t.details=WS.BUFFER_APPEND_ERROR,this.warn(`Failed ${e}/${i.config.appendErrorMaxRetry} times to append segment in "${o}" sourceBuffer`),e>=i.config.appendErrorMaxRetry&&(t.fatal=!0)}i.trigger(GS.ERROR,t)}};n.append(_,o,!!this.pendingTracks[o])}onBufferFlushing(e,t){const{operationQueue:i}=this,n=e=>({execute:this.removeExecutor.bind(this,e,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(GS.BUFFER_FLUSHED,{type:e})},onError:t=>{this.warn(`Failed to remove from ${e} SourceBuffer`,t)}});t.type?i.append(n(t.type),t.type):this.getSourceBufferTypes().forEach((e=>{i.append(n(e),e)}))}onFragParsed(e,t){const{frag:i,part:n}=t,s=[],r=n?n.elementaryStreams:i.elementaryStreams;r[tv.AUDIOVIDEO]?s.push("audiovideo"):(r[tv.AUDIO]&&s.push("audio"),r[tv.VIDEO]&&s.push("video"));0===s.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers((()=>{const e=self.performance.now();i.stats.buffering.end=e,n&&(n.stats.buffering.end=e);const t=n?n.stats:i.stats;this.hls.trigger(GS.FRAG_BUFFERED,{frag:i,part:n,stats:t,id:i.type})}),s)}onFragChanged(e,t){this.trimBuffers()}onBufferEos(e,t){this.getSourceBufferTypes().reduce(((e,i)=>{const n=this.sourceBuffer[i];return!n||t.type&&t.type!==i||(n.ending=!0,n.ended||(n.ended=!0,this.log(`${i} sourceBuffer now EOS`))),e&&!(n&&!n.ended)}),!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers((()=>{this.getSourceBufferTypes().forEach((e=>{const t=this.sourceBuffer[e];t&&(t.ending=!1)}));const{mediaSource:e}=this;e&&"open"===e.readyState?(this.log("Calling mediaSource.endOfStream()"),e.endOfStream()):e&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${e.readyState}`)})))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||null===t)return;if(!this.getSourceBufferTypes().length)return;const n=e.config,s=i.currentTime,r=t.levelTargetDuration,o=t.live&&null!==n.liveBackBufferLength?n.liveBackBufferLength:n.backBufferLength;if(FS(o)&&o>0){const e=Math.max(o,r),t=Math.floor(s/r)*r-e;this.flushBackBuffer(s,r,t)}if(FS(n.frontBufferFlushThreshold)&&n.frontBufferFlushThreshold>0){const e=Math.max(n.maxBufferLength,n.frontBufferFlushThreshold),t=Math.max(e,r),i=Math.floor(s/r)*r+t;this.flushFrontBuffer(s,r,i)}}flushBackBuffer(e,t,i){const{details:n,sourceBuffer:s}=this;this.getSourceBufferTypes().forEach((r=>{const o=s[r];if(o){const s=iC.getBuffered(o);if(s.length>0&&i>s.start(0)){if(this.hls.trigger(GS.BACK_BUFFER_REACHED,{bufferEnd:i}),null!=n&&n.live)this.hls.trigger(GS.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(o.ended&&s.end(s.length-1)-e<2*t)return void this.log(`Cannot flush ${r} back buffer while SourceBuffer is in ended state`);this.hls.trigger(GS.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:r})}}}))}flushFrontBuffer(e,t,i){const{sourceBuffer:n}=this;this.getSourceBufferTypes().forEach((s=>{const r=n[s];if(r){const n=iC.getBuffered(r),o=n.length;if(o<2)return;const a=n.start(o-1),c=n.end(o-1);if(i>a||e>=a&&e<=c)return;if(r.ended&&e-c<2*t)return void this.log(`Cannot flush ${s} front buffer while SourceBuffer is in ended state`);this.hls.trigger(GS.BUFFER_FLUSHING,{startOffset:a,endOffset:1/0,type:s})}}))}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;const{details:e,hls:t,media:i,mediaSource:n}=this,s=e.fragments[0].start+e.totalduration,r=i.duration,o=FS(n.duration)?n.duration:0;e.live&&t.config.liveDurationInfinity?(n.duration=1/0,this.updateSeekableRange(e)):(s>o&&s>r||!FS(r))&&(this.log(`Updating Media Source duration to ${s.toFixed(3)}`),n.duration=s)}updateSeekableRange(e){const t=this.mediaSource,i=e.fragments;if(i.length&&e.live&&null!=t&&t.setLiveSeekableRange){const n=Math.max(0,i[0].start),s=Math.max(n,n+e.totalduration);this.log(`Media Source duration is set to ${t.duration}. Setting seekable range to ${n}-${s}.`),t.setLiveSeekableRange(n,s)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:i}=this,n=Object.keys(i).length;if(n&&(!e||2===n||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};const e=this.getSourceBufferTypes();if(e.length)this.hls.trigger(GS.BUFFER_CREATED,{tracks:this.tracks}),e.forEach((e=>{t.executeNext(e)}));else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const n in e)if(!t[n]){const s=e[n];if(!s)throw Error(`source buffer exists for track ${n}, however track does not`);let r=s.levelCodec||s.codec;r&&"audio"===n.slice(0,5)&&(r=CR(r,this.appendSource));const o=`${s.container};codecs=${r}`;this.log(`creating sourceBuffer(${o})`);try{const e=t[n]=i.addSourceBuffer(o),a=n;this.addBufferListener(a,"updatestart",this._onSBUpdateStart),this.addBufferListener(a,"updateend",this._onSBUpdateEnd),this.addBufferListener(a,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(a,"bufferedchange",((e,t)=>{const i=t.removedRanges;null!=i&&i.length&&this.hls.trigger(GS.BUFFER_FLUSHED,{type:n})})),this.tracks[n]={buffer:e,codec:r,container:s.container,levelCodec:s.levelCodec,metadata:s.metadata,id:s.id}}catch(e){this.error(`error while trying to add sourceBuffer: ${e.message}`),this.hls.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,sourceBufferName:n,mimeType:o})}}}get mediaSrc(){var e;const t=(null==(e=this.media)?void 0:e.firstChild)||this.media;return null==t?void 0:t.src}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){var t;if("closed"===(null==(t=this.mediaSource)?void 0:t.readyState))return void this.resetBuffer(e);const{operationQueue:i}=this;i.current(e).onComplete(),i.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){var i;const n=new Error(`${e} SourceBuffer error. MediaSource readyState: ${null==(i=this.mediaSource)?void 0:i.readyState}`);this.error(`${n}`,t),this.hls.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:n,fatal:!1});const s=this.operationQueue.current(e);s&&s.onError(n)}removeExecutor(e,t,i){const{media:n,mediaSource:s,operationQueue:r,sourceBuffer:o}=this,a=o[e];if(!n||!s||!a)return this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void r.shiftAndExecuteNext(e);const c=FS(n.duration)?n.duration:1/0,d=FS(s.duration)?s.duration:1/0,l=Math.max(0,t),h=Math.min(i,c,d);h>l&&(!a.ending||a.ended)?(a.ended=!1,this.log(`Removing [${l},${h}] from the ${e} SourceBuffer`),a.remove(l,h)):r.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.sourceBuffer[t];if(i)i.ended=!1,i.appendBuffer(e);else if(!this.pendingTracks[t])throw new Error(`Attempting to append to the ${t} SourceBuffer, but it does not exist`)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),void Promise.resolve().then(e);const{operationQueue:i}=this,n=t.map((e=>i.appendBlocker(e)));Promise.all(n).then((()=>{e(),t.forEach((e=>{const t=this.sourceBuffer[e];null!=t&&t.updating||i.shiftAndExecuteNext(e)}))}))}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,i){const n=this.sourceBuffer[e];if(!n)return;const s=i.bind(this,e);this.listeners[e].push({event:t,listener:s}),n.addEventListener(t,s)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach((e=>{t.removeEventListener(e.event,e.listener)}))}},capLevelController:jA,errorController:class{constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=$S.log.bind($S,"[info]:"),this.warn=$S.warn.bind($S,"[warning]:"),this.error=$S.error.bind($S,"[error]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(GS.ERROR,this.onError,this),e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(GS.ERROR,this.onError,this),e.off(GS.ERROR,this.onErrorOut,this),e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(null==e?void 0:e.type)===BR.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i,n;if(t.fatal)return;const s=this.hls,r=t.context;switch(t.details){case WS.FRAG_LOAD_ERROR:case WS.FRAG_LOAD_TIMEOUT:case WS.KEY_LOAD_ERROR:case WS.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case WS.FRAG_PARSING_ERROR:if(null!=(i=t.frag)&&i.gap)return void(t.errorAction={action:by,flags:Ny});case WS.FRAG_GAP:case WS.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=wy);case WS.LEVEL_EMPTY_ERROR:case WS.LEVEL_PARSING_ERROR:{var o,a;const e=t.parent===BR.MAIN?t.level:s.loadLevel;t.details===WS.LEVEL_EMPTY_ERROR&&null!=(o=t.context)&&null!=(a=o.levelDetails)&&a.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case WS.LEVEL_LOAD_ERROR:case WS.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==r?void 0:r.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.level)));case WS.AUDIO_TRACK_LOAD_ERROR:case WS.AUDIO_TRACK_LOAD_TIMEOUT:case WS.SUBTITLE_LOAD_ERROR:case WS.SUBTITLE_TRACK_LOAD_TIMEOUT:if(r){const e=s.levels[s.loadLevel];if(e&&(r.type===VR.AUDIO_TRACK&&e.hasAudioGroup(r.groupId)||r.type===VR.SUBTITLE_TRACK&&e.hasSubtitleGroup(r.groupId)))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,s.loadLevel),t.errorAction.action=wy,void(t.errorAction.flags=Ly)}return;case WS.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const e=s.levels[s.loadLevel],i=null==e?void 0:e.attrs["HDCP-LEVEL"];i?t.errorAction={action:wy,flags:Py,hdcpLevel:i}:this.keySystemError(t)}return;case WS.BUFFER_ADD_CODEC_ERROR:case WS.REMUX_ALLOC_ERROR:case WS.BUFFER_APPEND_ERROR:return void(t.errorAction=this.getLevelSwitchAction(t,null!=(n=t.level)?n:s.loadLevel));case WS.INTERNAL_EXCEPTION:case WS.BUFFER_APPENDING_ERROR:case WS.BUFFER_FULL_ERROR:case WS.LEVEL_SWITCH_ERROR:case WS.BUFFER_STALLED_ERROR:case WS.BUFFER_SEEK_OVER_HOLE:case WS.BUFFER_NUDGE_ON_STALL:return void(t.errorAction={action:by,flags:Ny})}t.type===jS.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=Ty(this.hls.config.playlistLoadPolicy,e),n=this.playlistError++;if(Ry(i,n,gy(e),e.response))return{action:Oy,flags:Ny,retryConfig:i,retryCount:n};const s=this.getLevelSwitchAction(e,t);return i&&(s.retryConfig=i,s.retryCount=n),s}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),n=t.levels[i],{fragLoadPolicy:s,keyLoadPolicy:r}=t.config,o=Ty(e.details.startsWith("key")?r:s,e),a=t.levels.reduce(((e,t)=>e+t.fragmentError),0);if(n){e.details!==WS.FRAG_GAP&&n.fragmentError++;if(Ry(o,a,gy(e),e.response))return{action:Oy,flags:Ny,retryConfig:o,retryCount:a}}const c=this.getLevelSwitchAction(e,i);return o&&(c.retryConfig=o,c.retryCount=a),c}getLevelSwitchAction(e,t){const i=this.hls;null==t&&(t=i.loadLevel);const n=this.hls.levels[t];if(n){var s,r;const t=e.details;n.loadError++,t===WS.BUFFER_APPEND_ERROR&&n.fragmentError++;let c=-1;const{levels:d,loadLevel:l,minAutoLevel:h,maxAutoLevel:u}=i;i.autoLevelEnabled||(i.loadLevel=-1);const p=null==(s=e.frag)?void 0:s.type,f=(p===BR.AUDIO&&t===WS.FRAG_PARSING_ERROR||"audio"===e.sourceBufferName&&(t===WS.BUFFER_ADD_CODEC_ERROR||t===WS.BUFFER_APPEND_ERROR))&&d.some((({audioCodec:e})=>n.audioCodec!==e)),m="video"===e.sourceBufferName&&(t===WS.BUFFER_ADD_CODEC_ERROR||t===WS.BUFFER_APPEND_ERROR)&&d.some((({codecSet:e,audioCodec:t})=>n.codecSet!==e&&n.audioCodec===t)),{type:E,groupId:_}=null!=(r=e.context)?r:{};for(let i=d.length;i--;){const s=(i+l)%d.length;if(s!==l&&s>=h&&s<=u&&0===d[s].loadError){var o,a;const i=d[s];if(t===WS.FRAG_GAP&&e.frag){const t=d[s].details;if(t){const i=Cy(e.frag,t.fragments,e.frag.start);if(null!=i&&i.gap)continue}}else{if(E===VR.AUDIO_TRACK&&i.hasAudioGroup(_)||E===VR.SUBTITLE_TRACK&&i.hasSubtitleGroup(_))continue;if(p===BR.AUDIO&&null!=(o=n.audioGroups)&&o.some((e=>i.hasAudioGroup(e)))||p===BR.SUBTITLE&&null!=(a=n.subtitleGroups)&&a.some((e=>i.hasSubtitleGroup(e)))||f&&n.audioCodec===i.audioCodec||!f&&n.audioCodec!==i.audioCodec||m&&n.codecSet===i.codecSet)continue}c=s;break}}if(c>-1&&i.loadLevel!==c)return e.levelRetry=!0,this.playlistError=0,{action:wy,flags:Ny,nextAutoLevel:c}}return{action:wy,flags:Ly}}onErrorOut(e,t){var i;switch(null==(i=t.errorAction)?void 0:i.action){case by:break;case wy:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===WS.FRAG_GAP?/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):t.fatal=!0}t.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:n,hdcpLevel:s,nextAutoLevel:r}=i;switch(n){case Ny:this.switchLevel(e,r);break;case Py:s&&(t.maxHdcpLevel=sy[sy.indexOf(s)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`)}i.resolved||this.switchLevel(e,r)}switchLevel(e,t){void 0!==t&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}},fpsController:class{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(GS.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(GS.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,i){const n=performance.now();if(t){if(this.lastTime){const e=n-this.lastTime,s=i-this.lastDroppedFrames,r=t-this.lastDecodedFrames,o=1e3*s/e,a=this.hls;if(a.trigger(GS.FPS_DROP,{currentDropped:s,currentDecoded:r,totalDroppedFrames:i}),o>0&&s>a.config.fpsDroppedMonitoringThreshold*r){let e=a.currentLevel;$S.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===a.autoLevelCapping||a.autoLevelCapping>=e)&&(e-=1,a.trigger(GS.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:a.currentLevel}),a.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=n,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}},stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Ev,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:Vb,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:class extends NC{constructor(e,t,i){super(e,t,i,"[subtitle-stream-controller]",BR.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.on(GS.ERROR,this.onError,this),e.on(GS.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(GS.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(GS.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(GS.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(GS.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.off(GS.ERROR,this.onError,this),e.off(GS.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(GS.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(GS.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(GS.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(GS.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state=SC,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:n}=t;if(this.fragPrevious=i,this.state=SC,!n)return;const s=this.tracksBuffered[this.currentTrackId];if(!s)return;let r;const o=i.start;for(let e=0;e<s.length;e++)if(o>=s[e].start&&o<=s[e].end){r=s[e];break}const a=i.start+i.duration;r?r.end=a:(r={start:o,end:a},s.push(r)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null)}onBufferFlushing(e,t){const{startOffset:i,endOffset:n}=t;if(0===i&&n!==Number.POSITIVE_INFINITY){const e=n-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach((t=>{for(let i=0;i<t.length;)if(t[i].end<=e)t.shift();else{if(!(t[i].start<e))break;t[i].start=e,i++}})),this.fragmentTracker.removeFragmentsInRange(i,e,BR.SUBTITLE)}}onFragBuffered(e,t){var i;this.loadedmetadata||t.frag.type!==BR.MAIN||null!=(i=this.media)&&i.buffered.length&&(this.loadedmetadata=!0)}onError(e,t){const i=t.frag;(null==i?void 0:i.type)===BR.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==TC&&(this.state=SC))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){this.levels&&VI(this.levels,t)?this.levels=t.map((e=>new cy(e))):(this.tracksBuffered=[],this.levels=t.map((e=>{const t=new cy(e);return this.tracksBuffered[t.id]=[],t})),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,BR.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,null==(i=this.levels)||!i.length||-1===this.currentTrackId)return void this.clearInterval();const n=this.levels[this.currentTrackId];null!=n&&n.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,n&&this.setInterval(500)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:n,levels:s}=this,{details:r,id:o}=t;if(!s)return void this.warn(`Subtitle tracks were reset while loading level ${o}`);const a=s[n];if(o>=s.length||o!==n||!a)return;this.log(`Subtitle track ${o} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let c=0;if(r.live||null!=(i=a.details)&&i.live){const e=this.mainDetails;if(r.deltaUpdateFailed||!e)return;const t=e.fragments[0];var d;if(a.details)c=this.alignPlaylists(r,a.details,null==(d=this.levelLastLoaded)?void 0:d.details),0===c&&t&&(c=t.start,fy(r,c));else r.hasProgramDateTime&&e.hasProgramDateTime?(cC(r,e),c=r.fragments[0].start):t&&(c=t.start,fy(r,c))}if(a.details=r,this.levelLastLoaded=a,this.startFragRequested||!this.mainDetails&&r.live||this.setStartPosition(this.mainDetails||r,c),this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===SC){Cy(null,r.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),a.details=void 0)}}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,n=t.decryptdata,s=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&null!=n&&n.key&&n.iv&&"AES-128"===n.method){const e=performance.now();this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer).catch((e=>{throw s.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e})).then((i=>{const n=performance.now();s.trigger(GS.FRAG_DECRYPTED,{frag:t,payload:i,stats:{tstart:e,tdecrypt:n}})})).catch((e=>{this.warn(`${e.name}: ${e.message}`),this.state=SC}))}}doTick(){if(this.media){if(this.state===SC){const{currentTrackId:e,levels:t}=this,i=null==t?void 0:t[e];if(!i||!t.length||!i.details)return;const{config:n}=this,s=this.getLoadPosition(),r=iC.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,n.maxBufferHole),{end:o,len:a}=r,c=this.getFwdBufferInfo(this.media,BR.MAIN),d=i.details;if(a>this.getMaxBufferLength(null==c?void 0:c.len)+d.levelTargetDuration)return;const l=d.fragments,h=l.length,u=d.edge;let p=null;const f=this.fragPrevious;if(o<u){const e=n.maxFragLookUpTolerance,t=o>u-e?0:e;p=Cy(f,l,Math.max(l[0].start,o),t),!p&&f&&f.start<l[0].start&&(p=l[0])}else p=l[h-1];if(!p)return;if(p=this.mapToInitFragWhenRequired(p),"initSegment"!==p.sn){const e=l[p.sn-d.startSN-1];e&&e.cc===p.cc&&this.fragmentTracker.getState(e)===$y&&(p=e)}this.fragmentTracker.getState(p)===$y&&this.loadFragment(p,i,o)}}else this.state=SC}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,i){this.fragCurrent=e,"initSegment"===e.sn?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,i))}get mediaBufferTimeRanges(){return new jI(this.tracksBuffered[this.currentTrackId]||[])}},subtitleTrackController:class extends ky{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const t=$R(this.media.textTracks);for(let i=0;i<t.length;i++)if("hidden"===t[i].mode)e=t[i];else if("showing"===t[i].mode){e=t[i];break}const i=this.findTrackForTextTrack(e);this.subtitleTrack!==i&&this.setSubtitleTrack(i)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.on(GS.LEVEL_LOADING,this.onLevelLoading,this),e.on(GS.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(GS.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(GS.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.off(GS.LEVEL_LOADING,this.onLevelLoading,this),e.off(GS.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(GS.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(GS.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId);$R(this.media.textTracks).forEach((e=>{YR(e)})),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:n,details:s}=t,r=this.tracksInGroup[i];if(!r||r.groupId!==n)return void this.warn(`Subtitle track with id:${i} and group:${n} not found in active group ${null==r?void 0:r.groupId}`);const o=r.details;r.details=t.details,this.log(`Subtitle track ${i} "${r.name}" lang:${r.lang} group:${n} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,n=this.groupIds;let s=this.currentTrack;if(!i||(null==n?void 0:n.length)!==(null==i?void 0:i.length)||null!=i&&i.some((e=>-1===(null==n?void 0:n.indexOf(e))))){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter((e=>!i||-1!==i.indexOf(e.groupId)));if(e.length)this.selectDefaultTrack&&!e.some((e=>e.default))&&(this.selectDefaultTrack=!1),e.forEach(((e,t)=>{e.id=t}));else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.subtitlePreference;if(!s&&t){this.selectDefaultTrack=!1;const i=Wy(t,e);if(i>-1)s=e[i];else{const e=Wy(t,this.tracks);s=this.tracks[e]}}let n=this.findTrackId(s);-1===n&&s&&(n=this.findTrackId(null));const r={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${null==i?void 0:i.join(",")}" group-id`),this.hls.trigger(GS.SUBTITLE_TRACKS_UPDATED,r),-1!==n&&-1===this.trackId&&this.setSubtitleTrack(n)}else this.shouldReloadPlaylist(s)&&this.setSubtitleTrack(this.trackId)}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let n=0;n<t.length;n++){const s=t[n];if((!i||s.default)&&(i||e)&&(!e||Hy(s,e)))return n}if(e){for(let i=0;i<t.length;i++){const n=t[i];if(BI(e.attrs,n.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<t.length;i++){const n=t[i];if(BI(e.attrs,n.attrs,["LANGUAGE"]))return i}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){if(GI(t[i],e))return i}}return-1}onError(e,t){!t.fatal&&t.context&&(t.context.type!==VR.SUBTITLE_TRACK||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&Hy(e,i))return i;const n=Wy(e,this.tracksInGroup);if(n>-1){const e=this.tracksInGroup[n];return this.setSubtitleTrack(n),e}if(i)return null;{const i=Wy(e,t);if(i>-1)return t[i]}}}return null}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){const i=t.id,n=t.groupId;let s=t.url;if(e)try{s=e.addDirectives(s)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(GS.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:n,deliveryDirectives:e||null})}}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=$R(e.textTracks),i=this.currentTrack;let n;if(i&&(n=t.filter((e=>GI(i,e)))[0],n||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach((e=>{"disabled"!==e.mode&&e!==n&&(e.mode="disabled")})),n){const e=this.subtitleDisplay?"showing":"hidden";n.mode!==e&&(n.mode=e)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=e);if(e<-1||e>=t.length||!FS(e))return void this.warn(`Invalid subtitle track id: ${e}`);this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e]||null;if(this.trackId=e,this.currentTrack=n,this.toggleTrackModes(),!n)return void this.hls.trigger(GS.SUBTITLE_TRACK_SWITCH,{id:e});const s=!!n.details&&!n.details.live;if(e===this.trackId&&n===i&&s)return;this.log(`Switching to subtitle-track ${e}`+(n?` "${n.name}" lang:${n.lang} group:${n.groupId}`:""));const{id:r,groupId:o="",name:a,type:c,url:d}=n;this.hls.trigger(GS.SUBTITLE_TRACK_SWITCH,{id:r,groupId:o,name:a,type:c,url:d});const l=this.switchParams(n.url,null==i?void 0:i.details);this.loadPlaylist(l)}},timelineController:class{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(GS.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(GS.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(GS.FRAG_LOADING,this.onFragLoading,this),e.on(GS.FRAG_LOADED,this.onFragLoaded,this),e.on(GS.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(GS.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(GS.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(GS.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(GS.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(GS.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(GS.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(GS.FRAG_LOADING,this.onFragLoading,this),e.off(GS.FRAG_LOADED,this.onFragLoaded,this),e.off(GS.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(GS.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(GS.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(GS.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const e=new hA(this,"textTrack1"),t=new hA(this,"textTrack2"),i=new hA(this,"textTrack3"),n=new hA(this,"textTrack4");this.cea608Parser1=new cA(1,e,t),this.cea608Parser2=new cA(3,i,n)}}addCues(e,t,i,n,s){let r=!1;for(let e=s.length;e--;){const n=s[e],l=(o=n[0],a=n[1],c=t,d=i,Math.min(a,d)-Math.max(o,c));if(l>=0&&(n[0]=Math.min(n[0],t),n[1]=Math.max(n[1],i),r=!0,l/(i-t)>.5))return}var o,a,c,d;if(r||s.push([t,i]),this.config.renderTextTracksNatively){const s=this.captionsTracks[e];this.Cues.newCue(s,t,i,n)}else{const s=this.Cues.newCue(null,t,i,n);this.hls.trigger(GS.CUES_PARSED,{type:"captions",cues:s,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:s}){const{unparsedVttFrags:r}=this;"main"===i&&(this.initPTS[t.cc]={baseTime:n,timescale:s}),r.length&&(this.unparsedVttFrags=[],r.forEach((e=>{this.onFragLoaded(GS.FRAG_LOADED,e)})))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let n=0;n<i.textTracks.length;n++){const s=i.textTracks[n];if(GA(s,{name:e,lang:t,attrs:{}}))return s}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:n}=this,{label:s,languageCode:r}=t[e],o=this.getExistingTrack(s,r);if(o)i[e]=o,YR(i[e]),HR(i[e],n);else{const t=this.createTextTrack("captions",s,r);t&&(t[e]=!0,i[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=i,this.hls.trigger(GS.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(e,t,i){const n=this.media;if(n)return n.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach((t=>{YR(e[t]),delete e[t]})),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)YR(t[e])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],n=i.some((e=>e.textCodec===DA));if(this.config.enableWebVTT||n&&this.config.enableIMSC1){if(VI(this.tracks,i))return void(this.tracks=i);if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const e=this.media,t=e?$R(e.textTracks):null;if(this.tracks.forEach(((e,i)=>{let n;if(t){let i=null;for(let n=0;n<t.length;n++)if(t[n]&&GA(t[n],e)){i=t[n],t[n]=null;break}i&&(n=i)}if(n)YR(n);else{const t=BA(e);n=this.createTextTrack(t,e.name,e.lang),n&&(n.mode="disabled")}n&&this.textTracks.push(n)})),null!=t&&t.length){const e=t.filter((e=>null!==e)).map((e=>e.label));e.length&&$S.warn(`Media element contains unused subtitle tracks: ${e.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const e=this.tracks.map((e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e})));this.hls.trigger(GS.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach((e=>{const t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;const i=`textTrack${t[1]}`,n=this.captionsProperties[i];n&&(n.label=e.name,e.lang&&(n.languageCode=e.lang),n.media=e)}))}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:n,lastCc:s,lastSn:r,lastPartIndex:o}=this;if(this.enabled&&i&&n&&t.frag.type===BR.MAIN){var a,c;const{cc:e,sn:d}=t.frag,l=null!=(a=null==t||null==(c=t.part)?void 0:c.index)?a:-1;d===r+1||d===r&&l===o+1||e===s||(i.reset(),n.reset()),this.lastCc=e,this.lastSn=d,this.lastPartIndex=l}}onFragLoaded(e,t){const{frag:i,payload:n}=t;if(i.type===BR.SUBTITLE)if(n.byteLength){const e=i.decryptdata,s="stats"in t;if(null==e||!e.encrypted||s){const e=this.tracks[i.level],s=this.vttCCs;s[i.cc]||(s[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),e&&e.textCodec===DA?this._parseIMSC1(i,n):this._parseVTTs(t)}}else this.hls.trigger(GS.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;PA(t,this.initPTS[e.cc],(t=>{this._appendCues(t,e.level),i.trigger(GS.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})}),(t=>{$S.log(`Failed to parse IMSC1: ${t}`),i.trigger(GS.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})}))}_parseVTTs(e){var t;const{frag:i,payload:n}=e,{initPTS:s,unparsedVttFrags:r}=this,o=s.length-1;if(!s[i.cc]&&-1===o)return void r.push(e);const a=this.hls;wA(null!=(t=i.initSegment)&&t.data?tR(i.initSegment.data,new Uint8Array(n)):n,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,(e=>{this._appendCues(e,i.level),a.trigger(GS.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})}),(t=>{const s="Missing initPTS for VTT MPEGTS"===t.message;s?r.push(e):this._fallbackToIMSC1(i,n),$S.log(`Failed to parse VTT cue: ${t}`),s&&o>i.cc||a.trigger(GS.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:t})}))}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||PA(t,this.initPTS[e.cc],(()=>{i.textCodec=DA,this._parseIMSC1(e,t)}),(()=>{i.textCodec="wvtt"}))}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const i=this.textTracks[t];if(!i||"disabled"===i.mode)return;e.forEach((e=>KR(i,e)))}else{const n=this.tracks[t];if(!n)return;const s=n.default?"default":"subtitles"+t;i.trigger(GS.CUES_PARSED,{type:"subtitles",cues:e,track:s})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===BR.SUBTITLE&&this.onFragLoaded(GS.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:n}=this;if(!this.enabled||!i||!n)return;const{frag:s,samples:r}=t;if(s.type!==BR.MAIN||"NONE"!==this.closedCaptionsForLevel(s))for(let e=0;e<r.length;e++){const t=r[e].bytes;if(t){const s=this.extractCea608Data(t);i.addData(r[e].pts,s[0]),n.addData(r[e].pts,s[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:n,type:s}){const{media:r}=this;if(r&&!(r.currentTime<i)){if(!s||"video"===s){const{captionsTracks:e}=this;Object.keys(e).forEach((n=>qR(e[n],t,i)))}if(this.config.renderTextTracksNatively&&0===t&&void 0!==n){const{textTracks:e}=this;Object.keys(e).forEach((i=>qR(e[i],t,n)))}}}extractCea608Data(e){const t=[[],[]],i=31&e[0];let n=2;for(let s=0;s<i;s++){const i=e[n++],s=127&e[n++],r=127&e[n++];if(0===s&&0===r)continue;if(0!=(4&i)){const e=3&i;0!==e&&1!==e||(t[e].push(s),t[e].push(r))}}return t}},audioStreamController:class extends NC{constructor(e,t,i){super(e,t,i,"[audio-stream-controller]",BR.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.on(GS.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(GS.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(GS.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(GS.ERROR,this.onError,this),e.on(GS.BUFFER_RESET,this.onBufferReset,this),e.on(GS.BUFFER_CREATED,this.onBufferCreated,this),e.on(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(GS.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(GS.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(GS.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.off(GS.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(GS.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(GS.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(GS.ERROR,this.onError,this),e.off(GS.BUFFER_RESET,this.onBufferReset,this),e.off(GS.BUFFER_CREATED,this.onBufferCreated,this),e.off(GS.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(GS.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(GS.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(GS.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:i,initPTS:n,timescale:s}){if("main"===i){const e=t.cc;this.initPTS[t.cc]={baseTime:n,timescale:s},this.log(`InitPTS for cc: ${e} found from main: ${n}`),this.videoTrackCC=e,this.state===DC&&this.tick()}}startLoad(e){if(!this.levels)return this.startPosition=e,void(this.state=TC);const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),t>0&&-1===e?(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t,this.state=SC):(this.loadedmetadata=!1,this.state=CC),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case SC:this.doTickIdle();break;case CC:{var e;const{levels:t,trackId:i}=this,n=null==t||null==(e=t[i])?void 0:e.details;if(n){if(this.waitForCdnTuneIn(n))break;this.state=DC}break}case yC:{var t;const e=performance.now(),i=this.retryDate;if(!i||e>=i||null!=(t=this.media)&&t.seeking){const{levels:e,trackId:t}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==e?void 0:e[t])||null),this.state=SC}break}case DC:{const e=this.waitingData;if(e){const{frag:t,part:i,cache:n,complete:s}=e;if(void 0!==this.initPTS[t.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=RC;const e={frag:t,part:i,payload:n.flush(),networkDetails:null};this._handleFragmentLoadProgress(e),s&&super._handleFragmentLoadComplete(e)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${t.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const e=this.getLoadPosition(),i=iC.bufferInfo(this.mediaBuffer,e,this.config.maxBufferHole);Iy(i.end,this.config.maxFragLookUpTolerance,t)<0&&(this.log(`Waiting fragment cc (${t.cc}) @ ${t.start} cancelled because another fragment at ${i.end} is needed`),this.clearWaitingFragment())}}else this.state=SC}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=SC)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:i,trackId:n}=this,s=e.config;if(!i&&(this.startFragRequested||!s.startFragPrefetch)||null==t||!t[n])return;const r=t[n],o=r.details;if(!o||o.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(o))return void(this.state=CC);const a=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&a&&(this.bufferFlushed=!1,this.afterBufferFlushed(a,tv.AUDIO,BR.AUDIO));const c=this.getFwdBufferInfo(a,BR.AUDIO);if(null===c)return;const{bufferedTrack:d,switchingTrack:l}=this;if(!l&&this._streamEnded(c,o))return e.trigger(GS.BUFFER_EOS,{type:"audio"}),void(this.state=bC);const h=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,BR.MAIN),u=c.len,p=this.getMaxBufferLength(null==h?void 0:h.len),f=o.fragments,m=f[0].start;let E=this.flushing?this.getLoadPosition():c.end;if(l&&i){const e=this.getLoadPosition();d&&!BI(l.attrs,d.attrs)&&(E=e),o.PTSKnown&&e<m&&(c.end>m||c.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=m+.05)}if(u>=p&&!l&&E<f[f.length-1].start)return;let _=this.getNextFragment(E,o),g=!1;if(_&&this.isLoopLoading(_,E)&&(g=!!_.gap,_=this.getNextFragmentLoopLoading(_,o,c,BR.MAIN,p)),!_)return void(this.bufferFlushed=!0);const T=h&&_.start>h.end+o.targetduration;if(T||(null==h||!h.len)&&c.len){const e=this.getAppendedFrag(_.start,BR.MAIN);if(null===e)return;if(g||(g=!!e.gap||!!T&&0===h.len),T&&!g||g&&c.nextStart&&c.nextStart<e.end)return}this.loadFragment(_,r,E)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map((e=>new cy(e)))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:n}=this;n&&(n.abortRequests(),this.removeUnbufferedFrags(n.start)),this.resetLoadingState(),i?this.setInterval(100):this.resetTransmuxer(),i?(this.switchingTrack=t,this.state=SC,this.flushAudioIfNeeded(t)):(this.switchingTrack=null,this.bufferedTrack=t,this.state=TC),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(GS.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var i;if(null==this.mainDetails)return void(this.cachedTrackLoadedData=t);const{levels:n}=this,{details:s,id:r}=t;if(!n)return void this.warn(`Audio tracks were reset while loading level ${r}`);this.log(`Audio track ${r} loaded [${s.startSN},${s.endSN}]${s.lastPartSn?`[part-${s.lastPartSn}-${s.lastPartIndex}]`:""},duration:${s.totalduration}`);const o=n[r];let a=0;if(s.live||null!=(i=o.details)&&i.live){this.checkLiveUpdate(s);const e=this.mainDetails;if(s.deltaUpdateFailed||!e)return;var c;if(!o.details&&s.hasProgramDateTime&&e.hasProgramDateTime)cC(s,e),a=s.fragments[0].start;else a=this.alignPlaylists(s,o.details,null==(c=this.levelLastLoaded)?void 0:c.details)}o.details=s,this.levelLastLoaded=o,this.startFragRequested||!this.mainDetails&&s.live||this.setStartPosition(this.mainDetails||s,a),this.state!==CC||this.waitForCdnTuneIn(s)||(this.state=SC),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:n,payload:s}=e,{config:r,trackId:o,levels:a}=this;if(!a)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const c=a[o];if(!c)return void this.warn("Audio track is undefined on fragment load progress");const d=c.details;if(!d)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(i.start);const l=r.defaultAudioCodec||c.audioCodec||"mp4a.40.2";let h=this.transmuxer;h||(h=this.transmuxer=new FI(this.hls,BR.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const u=this.initPTS[i.cc],p=null==(t=i.initSegment)?void 0:t.data;if(void 0!==u){const e=!1,t=n?n.index:-1,r=-1!==t,o=new nC(i.level,i.sn,i.stats.chunkCount,s.byteLength,t,r);h.push(s,p,l,"",i,n,d.totalduration,e,o,u)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${d.startSN} ,${d.endSN}],track ${o}`);const{cache:e}=this.waitingData=this.waitingData||{frag:i,part:n,cache:new LC,complete:!1};e.push(new Uint8Array(s)),this.waitingVideoCC=this.videoTrackCC,this.state=DC}}_handleFragmentLoadComplete(e){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:i,part:n}=t;if(i.type===BR.AUDIO)if(this.fragContextChanged(i))this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if("initSegment"!==i.sn){this.fragPrevious=i;const e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(GS.AUDIO_TRACK_SWITCHED,kS({},e)))}this.fragBufferedComplete(i,n)}else if(!this.loadedmetadata&&i.type===BR.MAIN){const e=this.videoBuffer||this.media;if(e){iC.getBuffered(e).length&&(this.loadedmetadata=!0)}}}onError(e,t){var i;if(t.fatal)this.state=wC;else switch(t.details){case WS.FRAG_GAP:case WS.FRAG_PARSING_ERROR:case WS.FRAG_DECRYPT_ERROR:case WS.FRAG_LOAD_ERROR:case WS.FRAG_LOAD_TIMEOUT:case WS.KEY_LOAD_ERROR:case WS.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(BR.AUDIO,t);break;case WS.AUDIO_TRACK_LOAD_ERROR:case WS.AUDIO_TRACK_LOAD_TIMEOUT:case WS.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==CC||(null==(i=t.context)?void 0:i.type)!==VR.AUDIO_TRACK||(this.state=SC);break;case WS.BUFFER_APPEND_ERROR:case WS.BUFFER_FULL_ERROR:if(!t.parent||"audio"!==t.parent)return;if(t.details===WS.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case WS.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onBufferFlushing(e,{type:t}){t!==tv.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==tv.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===bC&&(this.state=SC);const e=this.mediaBuffer||this.media;e&&(this.afterBufferFlushed(e,t,BR.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:n}=this,{remuxResult:s,chunkMeta:r}=e,o=this.getCurrentContext(r);if(!o)return void this.resetWhenMissingContext(r);const{frag:a,part:c,level:d}=o,{details:l}=d,{audio:h,text:u,id3:p,initSegment:f}=s;if(!this.fragContextChanged(a)&&l){if(this.state=IC,this.switchingTrack&&h&&this.completeAudioSwitch(this.switchingTrack),null!=f&&f.tracks){const e=a.initSegment||a;this._bufferInitSegment(d,f.tracks,e,r),n.trigger(GS.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:i,tracks:f.tracks})}if(h){const{startPTS:e,endPTS:t,startDTS:i,endDTS:n}=h;c&&(c.elementaryStreams[tv.AUDIO]={startPTS:e,endPTS:t,startDTS:i,endDTS:n}),a.setElementaryStreamInfo(tv.AUDIO,e,t,i,n),this.bufferFragmentData(h,a,c,r)}if(null!=p&&null!=(t=p.samples)&&t.length){const e=xS({id:i,frag:a,details:l},p);n.trigger(GS.FRAG_PARSING_METADATA,e)}if(u){const e=xS({id:i,frag:a,details:l},u);n.trigger(GS.FRAG_PARSING_USERDATA,e)}}else this.fragmentTracker.removeFragment(a)}_bufferInitSegment(e,t,i,n){if(this.state!==IC)return;t.video&&delete t.video;const s=t.audio;if(!s)return;s.id="audio";const r=e.audioCodec;this.log(`Init audio buffer, container:${s.container}, codecs[level/parsed]=[${r}/${s.codec}]`),r&&1===r.split(",").length&&(s.levelCodec=r),this.hls.trigger(GS.BUFFER_CODECS,t);const o=s.initSegment;if(null!=o&&o.byteLength){const e={type:"audio",frag:i,part:null,chunkMeta:n,parent:i.type,data:o};this.hls.trigger(GS.BUFFER_APPENDING,e)}this.tickImmediate()}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);var s;if(this.fragCurrent=e,this.switchingTrack||n===$y||n===Xy)if("initSegment"===e.sn)this._loadInitSegment(e,t);else if(null!=(s=t.details)&&s.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=DC;const i=this.mainDetails;i&&i.fragments[0].start!==t.details.fragments[0].start&&cC(t.details,i)}else this.startFragRequested=!0,super.loadFragment(e,t,i);else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){const{media:t,bufferedTrack:i}=this,n=null==i?void 0:i.attrs,s=e.attrs;t&&n&&(n.CHANNELS!==s.CHANNELS||i.name!==e.name||i.lang!==e.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(GS.AUDIO_TRACK_SWITCHED,kS({},e))}},audioTrackController:class extends ky{constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.on(GS.LEVEL_LOADING,this.onLevelLoading,this),e.on(GS.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(GS.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(GS.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.off(GS.LEVEL_LOADING,this.onLevelLoading,this),e.off(GS.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(GS.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(GS.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:n,details:s}=t,r=this.tracksInGroup[i];if(!r||r.groupId!==n)return void this.warn(`Audio track with id:${i} and group:${n} not found in active group ${null==r?void 0:r.groupId}`);const o=r.details;r.details=t.details,this.log(`Audio track ${i} "${r.name}" lang:${r.lang} group:${n} loaded [${s.startSN}-${s.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,o)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,n=this.groupIds;let s=this.currentTrack;if(!i||(null==n?void 0:n.length)!==(null==i?void 0:i.length)||null!=i&&i.some((e=>-1===(null==n?void 0:n.indexOf(e))))){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter((e=>!i||-1!==i.indexOf(e.groupId)));if(e.length)this.selectDefaultTrack&&!e.some((e=>e.default))&&(this.selectDefaultTrack=!1),e.forEach(((e,t)=>{e.id=t}));else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.audioPreference;if(!s&&t){const i=Wy(t,e,Ky);if(i>-1)s=e[i];else{const e=Wy(t,this.tracks);s=this.tracks[e]}}let n=this.findTrackId(s);-1===n&&s&&(n=this.findTrackId(null));const o={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group(s): ${null==i?void 0:i.join(",")}`),this.hls.trigger(GS.AUDIO_TRACKS_UPDATED,o);const a=this.trackId;if(-1!==n&&-1===a)this.setAudioTrack(n);else if(e.length&&-1===a){var r;const t=new Error(`No audio track selected for current audio group-ID(s): ${null==(r=this.groupIds)?void 0:r.join(",")} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}else this.shouldReloadPlaylist(s)&&this.setAudioTrack(this.trackId)}onError(e,t){!t.fatal&&t.context&&(t.context.type!==VR.AUDIO_TRACK||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||(this.requestScheduled=-1,this.checkRetry(t)))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const n=this.currentTrack;if(n&&Hy(e,n,Ky))return n;const s=Wy(e,this.tracksInGroup,Ky);if(s>-1){const e=this.tracksInGroup[s];return this.setAudioTrack(s),e}if(n){let n=t.loadLevel;-1===n&&(n=t.firstAutoLevel);const s=function(e,t,i,n,s){const r=t[n],o=t.reduce(((e,t,i)=>{const n=t.uri;return(e[n]||(e[n]=[])).push(i),e}),{})[r.uri];o.length>1&&(n=Math.max.apply(Math,o));const a=r.videoRange,c=r.frameRate,d=r.codecSet.substring(0,4),l=Yy(t,n,(t=>{if(t.videoRange!==a||t.frameRate!==c||t.codecSet.substring(0,4)!==d)return!1;const n=t.audioGroups,r=i.filter((e=>!n||-1!==n.indexOf(e.groupId)));return Wy(e,r,s)>-1}));return l>-1?l:Yy(t,n,(t=>{const n=t.audioGroups,r=i.filter((e=>!n||-1!==n.indexOf(e.groupId)));return Wy(e,r,s)>-1}))}(e,t.levels,i,n,Ky);if(-1===s)return null;t.nextLoadLevel=s}if(e.channels||e.audioCodec){const t=Wy(e,i);if(t>-1)return i[t]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length)return void this.warn(`Invalid audio track id: ${e}`);this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,n=t[e],s=n.details&&!n.details.live;if(e===this.trackId&&n===i&&s)return;if(this.log(`Switching to audio-track ${e} "${n.name}" lang:${n.lang} group:${n.groupId} channels:${n.channels}`),this.trackId=e,this.currentTrack=n,this.hls.trigger(GS.AUDIO_TRACK_SWITCHING,kS({},n)),s)return;const r=this.switchParams(n.url,null==i?void 0:i.details);this.loadPlaylist(r)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const n=t[i];if((!this.selectDefaultTrack||n.default)&&(!e||Hy(e,n,Ky)))return i}if(e){const{name:i,lang:n,assocLang:s,characteristics:r,audioCodec:o,channels:a}=e;for(let e=0;e<t.length;e++){if(Hy({name:i,lang:n,assocLang:s,characteristics:r,audioCodec:o,channels:a},t[e],Ky))return e}for(let i=0;i<t.length;i++){const n=t[i];if(BI(e.attrs,n.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<t.length;i++){const n=t[i];if(BI(e.attrs,n.attrs,["LANGUAGE"]))return i}}return-1}loadPlaylist(e){const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){super.loadPlaylist();const i=t.id,n=t.groupId;let s=t.url;if(e)try{s=e.addDirectives(s)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}this.log(`loading audio-track playlist ${i} "${t.name}" lang:${t.lang} group:${n}`),this.clearTimer(),this.hls.trigger(GS.AUDIO_TRACK_LOADING,{url:s,id:i,groupId:n,deliveryDirectives:e||null})}}},emeController:HA,cmcdController:class{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:YA.MANIFEST,su:!this.initialized})}catch(e){$S.warn("Could not generate manifest CMCD data.",e)}},this.applyFragmentData=e=>{try{const t=e.frag,i=this.hls.levels[t.level],n=this.getObjectType(t),s={d:1e3*t.duration,ot:n};n!==YA.VIDEO&&n!==YA.AUDIO&&n!=YA.MUXED||(s.br=i.bitrate/1e3,s.tb=this.getTopBandwidth(n)/1e3,s.bl=this.getBufferLength(n)),this.apply(e,s)}catch(e){$S.warn("Could not generate segment CMCD data.",e)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;null!=i&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||function(){try{return crypto.randomUUID()}catch(e){try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch(e){let t=(new Date).getTime();const i="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)}));return i}}}(),this.cid=i.contentId,this.useHeaders=!0===i.useHeaders,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(GS.MEDIA_DETACHED,this.onMediaDetached,this),e.on(GS.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(GS.MEDIA_DETACHED,this.onMediaDetached,this),e.off(GS.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,n;this.audioBuffer=null==(i=t.tracks.audio)?void 0:i.buffer,this.videoBuffer=null==(n=t.tracks.video)?void 0:n.buffer}createData(){var e;return{v:1,sf:qA.HLS,sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){xS(t,this.createData());const i=t.ot===YA.INIT||t.ot===YA.VIDEO||t.ot===YA.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering);const{includeKeys:n}=this;n&&(t=Object.keys(t).reduce(((e,i)=>(n.includes(i)&&(e[i]=t[i]),e)),{})),this.useHeaders?(e.headers||(e.headers={}),Ab(e.headers,t)):e.url=Db(e.url,t)}getObjectType(e){const{type:t}=e;return"subtitle"===t?YA.TIMED_TEXT:"initSegment"===e.sn?YA.INIT:"audio"===t?YA.AUDIO:"main"===t?this.hls.audioTracks.length?YA.VIDEO:YA.MUXED:void 0}getTopBandwidth(e){let t,i=0;const n=this.hls;if(e===YA.AUDIO)t=n.audioTracks;else{const e=n.maxAutoLevel,i=e>-1?e+1:n.levels.length;t=n.levels.slice(0,i)}for(const e of t)e.bitrate>i&&(i=e.bitrate);return i>0?i:NaN}getBufferLength(e){const t=this.hls.media,i=e===YA.AUDIO?this.audioBuffer:this.videoBuffer;if(!i||!t)return NaN;return 1e3*iC.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new i(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,i,n){t(e),this.loader.load(e,i,n)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new i(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,i,n){t(e),this.loader.load(e,i,n)}}}},contentSteeringController:class{constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=$S.log.bind($S,"[content-steering]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.on(GS.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.off(GS.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=1e3*this.timeToLoad-(performance.now()-this.updated);if(e>0)return void this.scheduleRefresh(this.uri,e)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter((t=>t!==e)))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;null!==i&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((null==i?void 0:i.action)===wy&&i.flags===Ly){const e=this.levels;let n=this.pathwayPriority,s=this.pathwayId;if(t.context){const{groupId:i,pathwayId:n,type:r}=t.context;i&&e?s=this.getPathwayForGroupId(i,r,s):n&&(s=n)}s in this.penalizedPathways||(this.penalizedPathways[s]=performance.now()),!n&&e&&(n=e.reduce(((e,t)=>(-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e)),[])),n&&n.length>1&&(this.updatePathwayPriority(n),i.resolved=this.pathwayId!==s),i.resolved||$S.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${s} levels: ${e?e.length:e} priorities: ${JSON.stringify(n)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length?(this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t):e}getLevelsForPathway(e){return null===this.levels?[]:this.levels.filter((t=>e===t.pathwayId))}updatePathwayPriority(e){let t;this.pathwayPriority=e;const i=this.penalizedPathways,n=performance.now();Object.keys(i).forEach((e=>{n-i[e]>3e5&&delete i[e]}));for(let n=0;n<e.length;n++){const s=e[n];if(s in i)continue;if(s===this.pathwayId)return;const r=this.hls.nextLoadLevel,o=this.hls.levels[r];if(t=this.getLevelsForPathway(s),t.length>0){this.log(`Setting Pathway to "${s}"`),this.pathwayId=s,_y(t),this.hls.trigger(GS.LEVELS_UPDATED,{levels:t});const e=this.hls.levels[r];o&&e&&this.levels&&(e.attrs["STABLE-VARIANT-ID"]!==o.attrs["STABLE-VARIANT-ID"]&&e.bitrate!==o.bitrate&&this.log(`Unstable Pathways change from bitrate ${o.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=r);break}}}getPathwayForGroupId(e,t,i){const n=this.getLevelsForPathway(i).concat(this.levels||[]);for(let i=0;i<n.length;i++)if(t===VR.AUDIO_TRACK&&n[i].hasAudioGroup(e)||t===VR.SUBTITLE_TRACK&&n[i].hasSubtitleGroup(e))return n[i].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},n={};e.forEach((e=>{const{ID:s,"BASE-ID":r,"URI-REPLACEMENT":o}=e;if(t.some((e=>e.pathwayId===s)))return;const a=this.getLevelsForPathway(r).map((e=>{const t=new JS(e.attrs);t["PATHWAY-ID"]=s;const r=t.AUDIO&&`${t.AUDIO}_clone_${s}`,a=t.SUBTITLES&&`${t.SUBTITLES}_clone_${s}`;r&&(i[t.AUDIO]=r,t.AUDIO=r),a&&(n[t.SUBTITLES]=a,t.SUBTITLES=a);const c=Nb(e.uri,t["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",o),d=new cy({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:c,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(let t=1;t<e.audioGroups.length;t++)d.addGroupId("audio",`${e.audioGroups[t]}_clone_${s}`);if(e.subtitleGroups)for(let t=1;t<e.subtitleGroups.length;t++)d.addGroupId("text",`${e.subtitleGroups[t]}_clone_${s}`);return d}));t.push(...a),Ob(this.audioTracks,i,o,s),Ob(this.subtitleTracks,n,o,s)}))}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;let n;this.loader&&this.loader.destroy(),this.loader=new i(t);try{n=new self.URL(e)}catch(t){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${e}`)}if("data:"!==n.protocol){const e=0|(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate);n.searchParams.set("_HLS_pathway",this.pathwayId),n.searchParams.set("_HLS_throughput",""+e)}const s={responseType:"json",url:n.href},r=t.steeringManifestLoadPolicy.default,o=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(e,t,i,s)=>{this.log(`Loaded steering manifest: "${n}"`);const r=e.data;if(1!==r.VERSION)return void this.log(`Steering VERSION ${r.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=r.TTL;const{"RELOAD-URI":o,"PATHWAY-CLONES":a,"PATHWAY-PRIORITY":c}=r;if(o)try{this.uri=new self.URL(o,n).href}catch(e){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${o}`)}this.scheduleRefresh(this.uri||i.url),a&&this.clonePathways(a);const d={steeringManifest:r,url:n.toString()};this.hls.trigger(GS.STEERING_MANIFEST_LOADED,d),c&&this.updatePathwayPriority(c)},onError:(e,t,i,n)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),410===e.code)return this.enabled=!1,void this.log(`Steering manifest ${t.url} no longer available`);let s=1e3*this.timeToLoad;if(429!==e.code)this.scheduleRefresh(this.uri||t.url,s);else{const e=this.loader;if("function"==typeof(null==e?void 0:e.getResponseHeader)){const t=e.getResponseHeader("Retry-After");t&&(s=1e3*parseFloat(t))}this.log(`Steering manifest ${t.url} rate limited`)}},onTimeout:(e,t,i)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}};this.log(`Requesting steering manifest: ${n}`),this.loader.load(s,a,c)}scheduleRefresh(e,t=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout((()=>{var t;const i=null==(t=this.hls)?void 0:t.media;!i||i.ended?this.scheduleRefresh(e,1e3*this.timeToLoad):this.loadSteeringManifest(e)}),t)}}});function Gb(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(Gb):Object.keys(e).reduce(((t,i)=>(t[i]=Gb(e[i]),t)),{}):e}function jb(e){const t=e.loader;if(t!==Mb&&t!==Pb)$S.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1;else{(function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1})()&&(e.loader=Mb,e.progressive=!0,e.enableSoftwareAES=!0,$S.log("[config]: Progressive streaming enabled, using FetchLoader"))}}let Wb;class Hb extends ky{constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.on(GS.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(GS.FRAG_BUFFERED,this.onFragBuffered,this),e.on(GS.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.off(GS.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(GS.FRAG_BUFFERED,this.onFragBuffered,this),e.off(GS.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach((e=>{e.loadError=0,e.fragmentError=0})),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,n=[],s={},r={};let o=!1,a=!1,c=!1;t.levels.forEach((e=>{var t,d;const l=e.attrs;let{audioCodec:h,videoCodec:u}=e;-1!==(null==(t=h)?void 0:t.indexOf("mp4a.40.34"))&&(Wb||(Wb=/chrome|firefox/i.test(navigator.userAgent)),Wb&&(e.audioCodec=h=void 0)),h&&(e.audioCodec=h=CR(h,i)),0===(null==(d=u)?void 0:d.indexOf("avc1"))&&(u=e.videoCodec=function(e){const t=e.split(".");if(t.length>2){let e=t.shift()+".";return e+=parseInt(t.shift()).toString(16),e+=("000"+parseInt(t.shift()).toString(16)).slice(-4),e}return e}(u));const{width:p,height:f,unknownCodecs:m}=e;if(o||(o=!(!p||!f)),a||(a=!!u),c||(c=!!h),null!=m&&m.length||h&&!_R(h,"audio",i)||u&&!_R(u,"video",i))return;const{CODECS:E,"FRAME-RATE":_,"HDCP-LEVEL":g,"PATHWAY-ID":T,RESOLUTION:S,"VIDEO-RANGE":v}=l,R=`${`${T||"."}-`}${e.bitrate}-${S}-${_}-${E}-${v}-${g}`;if(s[R])if(s[R].uri===e.url||e.attrs["PATHWAY-ID"])s[R].addGroupId("audio",l.AUDIO),s[R].addGroupId("text",l.SUBTITLES);else{const t=r[R]+=1;e.attrs["PATHWAY-ID"]=new Array(t+1).join(".");const i=new cy(e);s[R]=i,n.push(i)}else{const t=new cy(e);s[R]=t,r[R]=1,n.push(t)}})),this.filterAndSortMediaOptions(n,t,o,a,c)}filterAndSortMediaOptions(e,t,i,n,s){let r=[],o=[],a=e;if((i||n)&&s&&(a=a.filter((({videoCodec:e,videoRange:t,width:i,height:n})=>{return(!!e||!(!i||!n))&&(!!(s=t)&&ry.indexOf(s)>-1);var s}))),0===a.length)return void Promise.resolve().then((()=>{if(this.hls){t.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(t.levels[0].attrs)}`);const e=new Error("no level with compatible codecs found in manifest");this.hls.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:e,reason:e.message})}}));if(t.audioTracks){const{preferManagedMediaSource:e}=this.hls.config;r=t.audioTracks.filter((t=>!t.audioCodec||_R(t.audioCodec,"audio",e))),Kb(r)}t.subtitles&&(o=t.subtitles,Kb(o));const c=a.slice(0);a.sort(((e,t)=>{if(e.attrs["HDCP-LEVEL"]!==t.attrs["HDCP-LEVEL"])return(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&e.height!==t.height)return e.height-t.height;if(e.frameRate!==t.frameRate)return e.frameRate-t.frameRate;if(e.videoRange!==t.videoRange)return ry.indexOf(e.videoRange)-ry.indexOf(t.videoRange);if(e.videoCodec!==t.videoCodec){const i=SR(e.videoCodec),n=SR(t.videoCodec);if(i!==n)return n-i}if(e.uri===t.uri&&e.codecSet!==t.codecSet){const i=vR(e.codecSet),n=vR(t.codecSet);if(i!==n)return n-i}return e.averageBitrate!==t.averageBitrate?e.averageBitrate-t.averageBitrate:0}));let d=c[0];if(this.steering&&(a=this.steering.filterParsedLevels(a),a.length!==c.length))for(let e=0;e<c.length;e++)if(c[e].pathwayId===a[0].pathwayId){d=c[e];break}this._levels=a;for(let e=0;e<a.length;e++)if(a[e]===d){var l;this._firstLevel=e;const t=d.bitrate,i=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${a.length} level(s) found, first bitrate: ${t}`),void 0===(null==(l=this.hls.userConfig)?void 0:l.abrEwmaDefaultEstimate)){const e=Math.min(t,this.hls.config.abrEwmaDefaultEstimateMax);e>i&&i===Bb.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=e)}break}const h=s&&!n,u={levels:a,audioTracks:r,subtitleTracks:o,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:s,video:n,altAudio:!h&&r.some((e=>!!e.url))};this.hls.trigger(GS.MANIFEST_PARSED,u),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(0===t.length)return;if(e<0||e>=t.length){const i=new Error("invalid level idx"),n=e<0;if(this.hls.trigger(GS.ERROR,{type:jS.OTHER_ERROR,details:WS.LEVEL_SWITCH_ERROR,level:e,fatal:n,error:i,reason:i.message}),n)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,n=this.currentLevel,s=n?n.attrs["PATHWAY-ID"]:void 0,r=t[e],o=r.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=r,i===e&&r.details&&n&&s===o)return;this.log(`Switching to level ${e} (${r.height?r.height+"p ":""}${r.videoRange?r.videoRange+" ":""}${r.codecSet?r.codecSet+" ":""}@${r.bitrate})${o?" with Pathway "+o:""} from level ${i}${s?" with Pathway "+s:""}`);const a={level:e,attrs:r.attrs,details:r.details,bitrate:r.bitrate,averageBitrate:r.averageBitrate,maxBitrate:r.maxBitrate,realBitrate:r.realBitrate,width:r.width,height:r.height,codecSet:r.codecSet,audioCodec:r.audioCodec,videoCodec:r.videoCodec,audioGroups:r.audioGroups,subtitleGroups:r.subtitleGroups,loaded:r.loaded,loadError:r.loadError,fragmentError:r.fragmentError,name:r.name,id:r.id,uri:r.uri,url:r.url,urlId:0,audioGroupIds:r.audioGroupIds,textGroupIds:r.textGroupIds};this.hls.trigger(GS.LEVEL_SWITCHING,a);const c=r.details;if(!c||c.live){const e=this.switchParams(r.uri,null==n?void 0:n.details);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){!t.fatal&&t.context&&t.context.type===VR.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(void 0!==t&&t.type===BR.MAIN){const e=t.elementaryStreams;if(!Object.keys(e).some((t=>!!e[t])))return;const i=this._levels[t.level];null!=i&&i.loadError&&(this.log(`Resetting level error count of ${i.loadError} on frag buffered`),i.loadError=0)}}onLevelLoaded(e,t){var i;const{level:n,details:s}=t,r=this._levels[n];var o;if(!r)return this.warn(`Invalid level index ${n}`),void(null!=(o=t.deliveryDirectives)&&o.skip&&(s.deltaUpdateFailed=!0));n===this.currentLevelIndex?(0===r.fragmentError&&(r.loadError=0),this.playlistLoaded(n,t,r.details)):null!=(i=t.deliveryDirectives)&&i.skip&&(s.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let n=i.uri;if(e)try{n=e.addDirectives(n)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}const s=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${void 0!==(null==e?void 0:e.msn)?" at sn "+e.msn+" part "+e.part:""} with${s?" Pathway "+s:""} ${n}`),this.clearTimer(),this.hls.trigger(GS.LEVEL_LOADING,{url:n,level:t,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;const i=this._levels.filter(((t,i)=>i!==e||(this.steering&&this.steering.removeLevel(t),t===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,t.details&&t.details.fragments.forEach((e=>e.level=-1))),!1)));_y(i),this._levels=i,this.currentLevelIndex>-1&&null!=(t=this.currentLevel)&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(GS.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(GS.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function Kb(e){const t={};e.forEach((e=>{const i=e.groupId||"";e.id=t[i]=t[i]||0,t[i]++}))}class Yb{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const n=this.keyUriToKeyInfo[i].loader;if(n){var t;if(e&&e!==(null==(t=n.context)?void 0:t.frag.type))return;n.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=WS.KEY_LOAD_ERROR,i,n,s){return new pC({type:jS.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:s,error:i,networkDetails:n})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:n}=e;for(let e=0;e<t.length;e++){const s=t[e];if(n<=s.cc&&("initSegment"===i||"initSegment"===s.sn||i<s.sn)){this.emeController.selectKeySystemFormat(s).then((e=>{s.setKeyFormat(e)}));break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then((t=>this.loadInternal(e,t))):this.loadInternal(e)}loadInternal(e,t){var i,n;t&&e.setKeyFormat(t);const s=e.decryptdata;if(!s){const i=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,WS.KEY_LOAD_ERROR,i))}const r=s.uri;if(!r)return Promise.reject(this.createKeyLoadError(e,WS.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${r}"`)));let o=this.keyUriToKeyInfo[r];if(null!=(i=o)&&i.decryptdata.key)return s.key=o.decryptdata.key,Promise.resolve({frag:e,keyInfo:o});var a;if(null!=(n=o)&&n.keyLoadPromise)switch(null==(a=o.mediaKeySessionContext)?void 0:a.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return o.keyLoadPromise.then((t=>(s.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:o})))}switch(o=this.keyUriToKeyInfo[r]={decryptdata:s,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},s.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===s.keyFormat?this.loadKeyHTTP(o,e):this.loadKeyEME(o,e);case"AES-128":return this.loadKeyHTTP(o,e);default:return Promise.reject(this.createKeyLoadError(e,WS.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${s.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const t=this.emeController.loadKey(i);if(t)return(e.keyLoadPromise=t.then((t=>(e.mediaKeySessionContext=t,i)))).catch((t=>{throw e.keyLoadPromise=null,t}))}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,n=new(0,i.loader)(i);return t.keyLoader=e.loader=n,e.keyLoadPromise=new Promise(((s,r)=>{const o={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},a=i.keyLoadPolicy.default,c={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},d={onSuccess:(e,t,i,n)=>{const{frag:o,keyInfo:a,url:c}=i;if(!o.decryptdata||a!==this.keyUriToKeyInfo[c])return r(this.createKeyLoadError(o,WS.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),n));a.decryptdata.key=o.decryptdata.key=new Uint8Array(e.data),o.keyLoader=null,a.loader=null,s({frag:o,keyInfo:a})},onError:(e,i,n,s)=>{this.resetLoader(i),r(this.createKeyLoadError(t,WS.KEY_LOAD_ERROR,new Error(`HTTP Error ${e.code} loading key ${e.text}`),n,kS({url:o.url,data:void 0},e)))},onTimeout:(e,i,n)=>{this.resetLoader(i),r(this.createKeyLoadError(t,WS.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),n))},onAbort:(e,i,n)=>{this.resetLoader(i),r(this.createKeyLoadError(t,WS.INTERNAL_ABORTED,new Error("key loading aborted"),n))}};n.load(o,c,d)}))}resetLoader(e){const{frag:t,keyInfo:i,url:n}=e,s=i.loader;t.keyLoader===s&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[n],s&&s.destroy()}}function qb(){return self.SourceBuffer||self.WebKitSourceBuffer}function $b(){if(!mR())return!1;const e=qb();return!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove}class zb{constructor(e,t,i,n){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=i,this.hls=n}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:i,media:n,stalled:s}=this;if(null===n)return;const{currentTime:r,seeking:o}=n,a=this.seeking&&!o,c=!this.seeking&&o;if(this.seeking=o,r!==e){if(this.moved=!0,o||(this.nudgeRetry=0),null!==s){if(this.stallReported){const e=self.performance.now()-s;$S.warn(`playback not stuck anymore @${r}, after ${Math.round(e)}ms`),this.stallReported=!1}this.stalled=null}return}if(c||a)return void(this.stalled=null);if(n.paused&&!o||n.ended||0===n.playbackRate||!iC.getBuffered(n).length)return void(this.nudgeRetry=0);const d=iC.bufferInfo(n,r,0),l=d.nextStart||0;if(o){const e=d.len>2,i=!l||t&&t.start<=r||l-r>2&&!this.fragmentTracker.getPartialFragment(r);if(e||i)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var h;if(!(d.len>0)&&!l)return;const e=Math.max(l,d.start||0)-r,t=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,i=(null==t||null==(h=t.details)?void 0:h.live)?2*t.details.targetduration:2,s=this.fragmentTracker.getPartialFragment(r);if(e>0&&(e<=i||s))return void(n.paused||this._trySkipBufferHole(s))}const u=self.performance.now();if(null===s)return void(this.stalled=u);const p=u-s;if(!o&&p>=250&&(this._reportStall(d),!this.media))return;const f=iC.bufferInfo(n,r,i.maxBufferHole);this._tryFixBufferStall(f,p)}_tryFixBufferStall(e,t){const{config:i,fragmentTracker:n,media:s}=this;if(null===s)return;const r=s.currentTime,o=n.getPartialFragment(r);if(o){if(this._trySkipBufferHole(o)||!this.media)return}(e.len>i.maxBufferHole||e.nextStart&&e.nextStart-r<i.maxBufferHole)&&t>1e3*i.highBufferWatchdogPeriod&&($S.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:i,stallReported:n}=this;if(!n&&i){this.stallReported=!0;const n=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(e)})`);$S.warn(n.message),t.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.BUFFER_STALLED_ERROR,fatal:!1,error:n,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:i,media:n}=this;if(null===n)return 0;const s=n.currentTime,r=iC.bufferInfo(n,s,0),o=s<r.start?r.start:r.nextStart;if(o){const a=r.len<=t.maxBufferHole,c=r.len>0&&r.len<1&&n.readyState<3,d=o-s;if(d>0&&(a||c)){if(d>t.maxBufferHole){const{fragmentTracker:t}=this;let i=!1;if(0===s){const e=t.getAppendedFrag(0,BR.MAIN);e&&o<e.end&&(i=!0)}if(!i){const i=e||t.getAppendedFrag(s,BR.MAIN);if(i){let e=!1,n=i.end;for(;n<o;){const i=t.getPartialFragment(n);if(!i){e=!0;break}n+=i.duration}if(e)return 0}}}const r=Math.max(o+.05,s+.1);if($S.warn(`skipping hole, adjusting currentTime from ${s} to ${r}`),this.moved=!0,this.stalled=null,n.currentTime=r,e&&!e.gap){const t=new Error(`fragment loaded with buffer holes, seeking from ${s} to ${r}`);i.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:t,reason:t.message,frag:e})}return r}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:i,nudgeRetry:n}=this;if(null===i)return;const s=i.currentTime;if(this.nudgeRetry++,n<e.nudgeMaxRetry){const r=s+(n+1)*e.nudgeOffset,o=new Error(`Nudging 'currentTime' from ${s} to ${r}`);$S.warn(o.message),i.currentTime=r,t.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.BUFFER_NUDGE_ON_STALL,error:o,fatal:!1})}else{const i=new Error(`Playhead still not moving while enough data buffered @${s} after ${e.nudgeMaxRetry} nudges`);$S.error(i.message),t.trigger(GS.ERROR,{type:jS.MEDIA_ERROR,details:WS.BUFFER_STALLED_ERROR,error:i,fatal:!0})}}}class Xb extends NC{constructor(e,t,i){super(e,t,i,"[stream-controller]",BR.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.on(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.on(GS.LEVEL_LOADING,this.onLevelLoading,this),e.on(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.on(GS.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(GS.ERROR,this.onError,this),e.on(GS.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(GS.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(GS.BUFFER_CREATED,this.onBufferCreated,this),e.on(GS.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(GS.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(GS.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(GS.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(GS.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(GS.MANIFEST_LOADING,this.onManifestLoading,this),e.off(GS.MANIFEST_PARSED,this.onManifestParsed,this),e.off(GS.LEVEL_LOADED,this.onLevelLoaded,this),e.off(GS.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(GS.ERROR,this.onError,this),e.off(GS.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(GS.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(GS.BUFFER_CREATED,this.onBufferCreated,this),e.off(GS.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(GS.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(GS.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:i}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let e=i.startLevel;-1===e&&(i.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=i.firstAutoLevel),i.nextLoadLevel=e,this.level=i.loadLevel,this.loadedmetadata=!1}t>0&&-1===e&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=SC,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=TC}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case OC:{const{levels:e,level:t}=this,i=null==e?void 0:e[t],n=null==i?void 0:i.details;if(n&&(!n.live||this.levelLastLoaded===i)){if(this.waitForCdnTuneIn(n))break;this.state=SC;break}if(this.hls.nextLoadLevel!==this.level){this.state=SC;break}break}case yC:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||null!=(e=this.media)&&e.seeking){const{levels:e,level:t}=this,i=null==e?void 0:e[t];this.resetStartWhenNotLoaded(i||null),this.state=SC}}}this.state===SC&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:n}=this;if(null===t||!n&&(this.startFragRequested||!e.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;const s=e.nextLoadLevel;if(null==i||!i[s])return;const r=i[s],o=this.getMainFwdBufferInfo();if(null===o)return;const a=this.getLevelDetails();if(a&&this._streamEnded(o,a)){const e={};return this.altAudio&&(e.type="video"),this.hls.trigger(GS.BUFFER_EOS,e),void(this.state=bC)}e.loadLevel!==s&&-1===e.manualLevel&&this.log(`Adapting to level ${s} from level ${this.level}`),this.level=e.nextLoadLevel=s;const c=r.details;if(!c||this.state===OC||c.live&&this.levelLastLoaded!==r)return this.level=s,void(this.state=OC);const d=o.len,l=this.getMaxBufferLength(r.maxBitrate);if(d>=l)return;this.backtrackFragment&&this.backtrackFragment.start>o.end&&(this.backtrackFragment=null);const h=this.backtrackFragment?this.backtrackFragment.start:o.end;let u=this.getNextFragment(h,c);if(this.couldBacktrack&&!this.fragPrevious&&u&&"initSegment"!==u.sn&&this.fragmentTracker.getState(u)!==Jy){var p;const e=(null!=(p=this.backtrackFragment)?p:u).sn-c.startSN,t=c.fragments[e-1];t&&u.cc===t.cc&&(u=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&o.len&&(this.backtrackFragment=null);if(u&&this.isLoopLoading(u,h)){if(!u.gap){const e=this.audioOnly&&!this.altAudio?tv.AUDIO:tv.VIDEO,t=(e===tv.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,BR.MAIN)}u=this.getNextFragmentLoopLoading(u,c,o,BR.MAIN,l)}u&&(!u.initSegment||u.initSegment.data||this.bitrateTest||(u=u.initSegment),this.loadFragment(u,r,h))}loadFragment(e,t,i){const n=this.fragmentTracker.getState(e);this.fragCurrent=e,n===$y||n===Xy?"initSegment"===e.sn?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,i)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,BR.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null!=t&&t.readyState){let i;const n=this.getAppendedFrag(t.currentTime);n&&n.start>1&&this.flushMainBuffer(0,n.start-1);const s=this.getLevelDetails();if(null!=s&&s.live){const e=this.getMainFwdBufferInfo();if(!e||e.len<2*s.targetduration)return}if(!t.paused&&e){const t=e[this.hls.nextLoadLevel],n=this.fragLastKbps;i=n&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*n)+1:0}else i=0;const r=this.getBufferedFrag(t.currentTime+i);if(r){const e=this.followingBufferedFrag(r);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,i=e.duration,n=Math.max(r.end,t+Math.min(Math.max(i-this.config.maxFragLookUpTolerance,i*(this.couldBacktrack?.5:.125)),i*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(n,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case vC:case RC:case yC:case IC:case AC:this.state=SC}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new zb(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;FS(t)&&this.log(`Media seeked to ${t.toFixed(3)}`);const i=this.getMainFwdBufferInfo();null!==i&&0!==i.len?this.tick():this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`)}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(GS.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(e,t){let i=!1,n=!1;t.levels.forEach((e=>{const t=e.audioCodec;t&&(i=i||-1!==t.indexOf("mp4a.40.2"),n=n||-1!==t.indexOf("mp4a.40.5"))})),this.audioCodecSwitch=i&&n&&!function(){var e;const t=qb();return"function"==typeof(null==t||null==(e=t.prototype)?void 0:e.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==SC)return;const n=i[t.level];(!n.details||n.details.live&&this.levelLastLoaded!==n||this.waitForCdnTuneIn(n.details))&&(this.state=OC)}onLevelLoaded(e,t){var i;const{levels:n}=this,s=t.level,r=t.details,o=r.totalduration;if(!n)return void this.warn(`Levels were reset while loading level ${s}`);this.log(`Level ${s} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""}, cc [${r.startCC}, ${r.endCC}] duration:${o}`);const a=n[s],c=this.fragCurrent;!c||this.state!==RC&&this.state!==yC||c.level!==t.level&&c.loader&&this.abortCurrentFrag();let d=0;if(r.live||null!=(i=a.details)&&i.live){var l;if(this.checkLiveUpdate(r),r.deltaUpdateFailed)return;d=this.alignPlaylists(r,a.details,null==(l=this.levelLastLoaded)?void 0:l.details)}if(a.details=r,this.levelLastLoaded=a,this.hls.trigger(GS.LEVEL_UPDATED,{details:r,level:s}),this.state===OC){if(this.waitForCdnTuneIn(r))return;this.state=SC}this.startFragRequested?r.live&&this.synchronizeToLiveEdge(r):this.setStartPosition(r,d),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:n,payload:s}=e,{levels:r}=this;if(!r)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);const o=r[i.level],a=o.details;if(!a)return this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),void this.fragmentTracker.removeFragment(i);const c=o.videoCodec,d=a.PTSKnown||!a.live,l=null==(t=i.initSegment)?void 0:t.data,h=this._getAudioCodec(o),u=this.transmuxer=this.transmuxer||new FI(this.hls,BR.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),p=n?n.index:-1,f=-1!==p,m=new nC(i.level,i.sn,i.stats.chunkCount,s.byteLength,p,f),E=this.initPTS[i.cc];u.push(s,l,h,c,i,n,a.totalduration,d,m,E)}onAudioTrackSwitching(e,t){const i=this.altAudio;if(!!!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;e&&(this.log("Switching to main audio track, cancel main fragment load"),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const e=this.hls;i&&(e.trigger(GS.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),e.trigger(GS.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=t.id,n=!!this.hls.audioTracks[i].url;if(n){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=n,this.tick()}onBufferCreated(e,t){const i=t.tracks;let n,s,r=!1;for(const e in i){const t=i[e];if("main"===t.id){if(s=e,n=t,"video"===e){const t=i[e];t&&(this.videoBuffer=t.buffer)}}else r=!0}r&&n?(this.log(`Alternate track found, use ${s}.buffered to schedule main fragment loading`),this.mediaBuffer=n.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:n}=t;if(i&&i.type!==BR.MAIN)return;if(this.fragContextChanged(i))return this.warn(`Fragment ${i.sn}${n?" p: "+n.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===AC&&(this.state=SC));const s=n?n.stats:i.stats;this.fragLastKbps=Math.round(8*s.total/(s.buffering.end-s.loading.first)),"initSegment"!==i.sn&&(this.fragPrevious=i),this.fragBufferedComplete(i,n)}onError(e,t){var i;if(t.fatal)this.state=wC;else switch(t.details){case WS.FRAG_GAP:case WS.FRAG_PARSING_ERROR:case WS.FRAG_DECRYPT_ERROR:case WS.FRAG_LOAD_ERROR:case WS.FRAG_LOAD_TIMEOUT:case WS.KEY_LOAD_ERROR:case WS.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(BR.MAIN,t);break;case WS.LEVEL_LOAD_ERROR:case WS.LEVEL_LOAD_TIMEOUT:case WS.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==OC||(null==(i=t.context)?void 0:i.type)!==VR.LEVEL||(this.state=SC);break;case WS.BUFFER_APPEND_ERROR:case WS.BUFFER_FULL_ERROR:if(!t.parent||"main"!==t.parent)return;if(t.details===WS.BUFFER_APPEND_ERROR)return void this.resetLoadingState();this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case WS.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}checkBuffer(){const{media:e,gapController:t}=this;if(e&&t&&e.readyState){if(this.loadedmetadata||!iC.getBuffered(e).length){const e=this.state!==SC?this.fragCurrent:null;t.poll(this.lastCurrentTime,e)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=SC,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==tv.AUDIO||this.audioOnly&&!this.altAudio){const e=(t===tv.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(e,t,BR.MAIN),this.tick()}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking)return void this.log(`could not seek to ${i}, already seeking at ${t}`);const n=iC.getBuffered(e),s=(n.length?n.start(0):0)-i;s>0&&(s<this.config.maxBufferHole||s<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${s} to match buffer start`),i+=s,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${t}`),e.currentTime=i}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then((i=>{const{hls:n}=this;if(!i||this.fragContextChanged(e))return;t.fragmentError=0,this.state=SC,this.startFragRequested=!1,this.bitrateTest=!1;const s=e.stats;s.parsing.start=s.parsing.end=s.buffering.start=s.buffering.end=self.performance.now(),n.trigger(GS.FRAG_LOADED,i),e.bitrateTest=!1}))}_handleTransmuxComplete(e){var t;const i="main",{hls:n}=this,{remuxResult:s,chunkMeta:r}=e,o=this.getCurrentContext(r);if(!o)return void this.resetWhenMissingContext(r);const{frag:a,part:c,level:d}=o,{video:l,text:h,id3:u,initSegment:p}=s,{details:f}=d,m=this.altAudio?void 0:s.audio;if(this.fragContextChanged(a))this.fragmentTracker.removeFragment(a);else{if(this.state=IC,p){if(null!=p&&p.tracks){const e=a.initSegment||a;this._bufferInitSegment(d,p.tracks,e,r),n.trigger(GS.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:i,tracks:p.tracks})}const e=p.initPTS,t=p.timescale;FS(e)&&(this.initPTS[a.cc]={baseTime:e,timescale:t},n.trigger(GS.INIT_PTS_FOUND,{frag:a,id:i,initPTS:e,timescale:t}))}if(l&&f&&"initSegment"!==a.sn){const e=f.fragments[a.sn-1-f.startSN],t=a.sn===f.startSN,i=!e||a.cc>e.cc;if(!1!==s.independent){const{startPTS:e,endPTS:n,startDTS:s,endDTS:o}=l;if(c)c.elementaryStreams[l.type]={startPTS:e,endPTS:n,startDTS:s,endDTS:o};else if(l.firstKeyFrame&&l.independent&&1===r.id&&!i&&(this.couldBacktrack=!0),l.dropped&&l.independent){const s=this.getMainFwdBufferInfo(),r=(s?s.end:this.getLoadPosition())+this.config.maxBufferHole,c=l.firstKeyFramePTS?l.firstKeyFramePTS:e;if(!t&&r<c-this.config.maxBufferHole&&!i)return void this.backtrack(a);i&&(a.gap=!0),a.setElementaryStreamInfo(l.type,a.start,n,a.start,o,!0)}else t&&e>2&&(a.gap=!0);a.setElementaryStreamInfo(l.type,e,n,s,o),this.backtrackFragment&&(this.backtrackFragment=a),this.bufferFragmentData(l,a,c,r,t||i)}else{if(!t&&!i)return void this.backtrack(a);a.gap=!0}}if(m){const{startPTS:e,endPTS:t,startDTS:i,endDTS:n}=m;c&&(c.elementaryStreams[tv.AUDIO]={startPTS:e,endPTS:t,startDTS:i,endDTS:n}),a.setElementaryStreamInfo(tv.AUDIO,e,t,i,n),this.bufferFragmentData(m,a,c,r)}if(f&&null!=u&&null!=(t=u.samples)&&t.length){const e={id:i,frag:a,details:f,samples:u.samples};n.trigger(GS.FRAG_PARSING_METADATA,e)}if(f&&h){const e={id:i,frag:a,details:f,samples:h.samples};n.trigger(GS.FRAG_PARSING_USERDATA,e)}}}_bufferInitSegment(e,t,i,n){if(this.state!==IC)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:s,video:r,audiovideo:o}=t;if(s){let t=e.audioCodec;const i=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(t&&(t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==s.metadata.channelCount&&-1===i.indexOf("firefox")&&(t="mp4a.40.5")),t&&-1!==t.indexOf("mp4a.40.5")&&-1!==i.indexOf("android")&&"audio/mpeg"!==s.container&&(t="mp4a.40.2",this.log(`Android: force audio codec to ${t}`)),e.audioCodec&&e.audioCodec!==t&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${t}"`),s.levelCodec=t,s.id="main",this.log(`Init audio buffer, container:${s.container}, codecs[selected/level/parsed]=[${t||""}/${e.audioCodec||""}/${s.codec}]`)}r&&(r.levelCodec=e.videoCodec,r.id="main",this.log(`Init video buffer, container:${r.container}, codecs[level/parsed]=[${e.videoCodec||""}/${r.codec}]`)),o&&this.log(`Init audiovideo buffer, container:${o.container}, codecs[level/parsed]=[${e.codecs}/${o.codec}]`),this.hls.trigger(GS.BUFFER_CODECS,t),Object.keys(t).forEach((e=>{const s=t[e].initSegment;null!=s&&s.byteLength&&this.hls.trigger(GS.BUFFER_APPENDING,{type:e,data:s,frag:i,part:null,chunkMeta:n,parent:i.type})})),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,BR.MAIN)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=SC}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const i=e.currentTime;if(iC.isBuffered(e,i)?t=this.getAppendedFrag(i):iC.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const e=this.fragPlaying,i=t.level;e&&t.sn===e.sn&&e.level===i||(this.fragPlaying=t,this.hls.trigger(GS.FRAG_CHANGED,{frag:t}),e&&e.level===i||this.hls.trigger(GS.LEVEL_SWITCHED,{level:i}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,i=this.currentFrag;if(i&&FS(t)&&FS(i.programDateTime)){const e=i.programDateTime+1e3*(t-i.start);return new Date(e)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class Jb{static get version(){return"1.5.7"}static isMSESupported(){return $b()}static isSupported(){return function(){if(!$b())return!1;const e=mR();return"function"==typeof(null==e?void 0:e.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some((t=>e.isTypeSupported(TR(t,"video"))))||["mp4a.40.2","fLaC"].some((t=>e.isTypeSupported(TR(t,"audio")))))}()}static getMediaSource(){return mR()}static get Events(){return GS}static get ErrorTypes(){return jS}static get ErrorDetails(){return WS}static get DefaultConfig(){return Jb.defaultConfig?Jb.defaultConfig:Bb}static set DefaultConfig(e){Jb.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new xI,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,function(e,t){if("object"==typeof console&&!0===e||"object"==typeof e){qS(e,"debug","log","info","warn","error");try{YS.log(`Debug logs enabled for "${t}" in hls.js version 1.5.7`)}catch(e){YS=KS}}else YS=KS}(e.debug||!1,"Hls instance");const t=this.config=function(e,t){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=Gb(e),n=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach((e=>{const s=`${"level"===e?"playlist":e}LoadPolicy`,r=void 0===t[s],o=[];n.forEach((n=>{const a=`${e}Loading${n}`,c=t[a];if(void 0!==c&&r){o.push(a);const e=i[s].default;switch(t[s]={default:e},n){case"TimeOut":e.maxLoadTimeMs=c,e.maxTimeToFirstByteMs=c;break;case"MaxRetry":e.errorRetry.maxNumRetry=c,e.timeoutRetry.maxNumRetry=c;break;case"RetryDelay":e.errorRetry.retryDelayMs=c,e.timeoutRetry.retryDelayMs=c;break;case"MaxRetryTimeout":e.errorRetry.maxRetryDelayMs=c,e.timeoutRetry.maxRetryDelayMs=c}}})),o.length&&$S.warn(`hls.js config: "${o.join('", "')}" setting(s) are deprecated, use "${s}": ${JSON.stringify(t[s])}`)})),kS(kS({},i),t)}(Jb.DefaultConfig,e);this.userConfig=e,t.progressive&&jb(t);const{abrController:i,bufferController:n,capLevelController:s,errorController:r,fpsController:o}=t,a=new r(this),c=this.abrController=new i(this),d=this.bufferController=new n(this),l=this.capLevelController=new s(this),h=new o(this),u=new WR(this),p=new iy(this),f=t.contentSteeringController,m=f?new f(this):null,E=this.levelController=new Hb(this,m),_=new Qy(this),g=new Yb(this.config),T=this.streamController=new Xb(this,_,g);l.setStreamController(T),h.setStreamController(T);const S=[u,E,T];m&&S.splice(1,0,m),this.networkControllers=S;const v=[c,d,l,h,p,_];this.audioTrackController=this.createController(t.audioTrackController,S);const R=t.audioStreamController;R&&S.push(new R(this,_,g)),this.subtitleTrackController=this.createController(t.subtitleTrackController,S);const y=t.subtitleStreamController;y&&S.push(new y(this,_,g)),this.createController(t.timelineController,v),g.emeController=this.emeController=this.createController(t.emeController,v),this.cmcdController=this.createController(t.cmcdController,v),this.latencyController=this.createController(ny,v),this.coreComponents=v,S.push(a);const C=a.onErrorOut;"function"==typeof C&&this.on(GS.ERROR,C,a)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,n){this._emitter.off(e,t,i,n)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){if($S.error("An internal error happened while handling event "+e+'. Error message: "'+t.message+'". Here is a stacktrace:',t),!this.triggeringException){this.triggeringException=!0;const i=e===GS.ERROR;this.trigger(GS.ERROR,{type:jS.OTHER_ERROR,details:WS.INTERNAL_EXCEPTION,fatal:i,event:e,error:t}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){$S.log("destroy"),this.trigger(GS.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((e=>e.destroy())),this.networkControllers.length=0,this.coreComponents.forEach((e=>e.destroy())),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){$S.log("attachMedia"),this._media=e,this.trigger(GS.MEDIA_ATTACHING,{media:e})}detachMedia(){$S.log("detachMedia"),this.trigger(GS.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,i=this.url,n=this.url=LS.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,$S.log(`loadSource:${n}`),t&&i&&(i!==n||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(GS.MANIFEST_LOADING,{url:e})}startLoad(e=-1){$S.log(`startLoad(${e})`),this.started=!0,this.networkControllers.forEach((t=>{t.startLoad(e)}))}stopLoad(){$S.log("stopLoad"),this.started=!1,this.networkControllers.forEach((e=>{e.stopLoad()}))}resumeBuffering(){this.started&&this.networkControllers.forEach((e=>{"fragmentLoader"in e&&e.startLoad(-1)}))}pauseBuffering(){this.networkControllers.forEach((e=>{"fragmentLoader"in e&&e.stopLoad()}))}swapAudioCodec(){$S.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){$S.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e){this.levelController.removeLevel(e)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){$S.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){$S.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){$S.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){$S.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return-1===e&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){$S.log(`set startLevel:${e}`),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&($S.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){(function(e){return sy.indexOf(e)>-1})(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let n=0;n<i;n++)if(e[n].maxBitrate>=t)return n;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let n;if(n=-1===t&&null!=e&&e.length?e.length-1:t,i)for(let t=n;t--;){const n=e[t].attrs["HDCP-LEVEL"];if(n&&n<=i)return t}return n}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(e){var t;return null==(t=this.audioTrackController)?void 0:t.setAudioOption(e)}setSubtitleOption(e){var t;return null==(t=this.subtitleTrackController)||t.setSubtitleOption(e),null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}var Qb,Zb,ew,tw,iw,nw;Jb.defaultConfig=void 0,function(e){e.ERROR="error",e.READY_FOR_PLAY="ready_for_play",e.UNRECOVERABLE_ERROR="unrecoverable_error",e.AUTOPLAY_PREVENTED="autoplay_was_prevented"}(Qb||(Qb={})),e.RtcSourceEvent=void 0,(Zb=e.RtcSourceEvent||(e.RtcSourceEvent={})).AUTOPLAY_PREVENTED="autoplay_was_prevented",Zb.STATE_CHANGED="state_changed",Zb.VIDEO_STATE_CHANGED="video_state_changed",Zb.AUDIO_STATE_CHANGED="audio_state_changed",Zb.HOST_CHANGED="host_changed",Zb.USER_STATE_CHANGED="user_state_changed",e.RtcSourceState=void 0,(ew=e.RtcSourceState||(e.RtcSourceState={})).CREATING="creating",ew.CREATED="created",ew.CONNECTING="connecting",ew.CONNECTED="connected",ew.CONNECT_FAILED="connect-failed",ew.DESTROYED="destroyed",e.RtcUserState=void 0,(tw=e.RtcUserState||(e.RtcUserState={})).JOINED="joined",tw.LEFT="left",tw.UNPUBLISHED="unpublished",tw.PUBLISHED="published",e.RtcMediaState=void 0,(iw=e.RtcMediaState||(e.RtcMediaState={})).PLAYING="playing",iw.PAUSED="paused",iw.STOPPED="stopped",iw.EMPTY="empty",e.MediaSource=void 0,(nw=e.MediaSource||(e.MediaSource={})).HLS="hls",nw.RTC="rtc";var sw={exports:{}};!function(e,t){!function(i,n){var s="function",r="undefined",o="object",a="string",c="major",d="model",l="name",h="type",u="vendor",p="version",f="architecture",m="console",E="mobile",_="tablet",g="smarttv",T="wearable",S="embedded",v="Amazon",R="Apple",y="ASUS",C="BlackBerry",I="Browser",A="Chrome",b="Firefox",w="Google",D="Huawei",O="LG",N="Microsoft",L="Motorola",P="Opera",k="Samsung",M="Sharp",U="Sony",x="Xiaomi",F="Zebra",V="Facebook",B="Chromium OS",G="Mac OS",j=function(e){for(var t={},i=0;i<e.length;i++)t[e[i].toUpperCase()]=e[i];return t},W=function(e,t){return typeof e===a&&-1!==H(t).indexOf(H(e))},H=function(e){return e.toLowerCase()},K=function(e,t){if(typeof e===a)return e=e.replace(/^\s\s*/,""),typeof t===r?e:e.substring(0,350)},Y=function(e,t){for(var i,r,a,c,d,l,h=0;h<t.length&&!d;){var u=t[h],p=t[h+1];for(i=r=0;i<u.length&&!d&&u[i];)if(d=u[i++].exec(e))for(a=0;a<p.length;a++)l=d[++r],typeof(c=p[a])===o&&c.length>0?2===c.length?typeof c[1]==s?this[c[0]]=c[1].call(this,l):this[c[0]]=c[1]:3===c.length?typeof c[1]!==s||c[1].exec&&c[1].test?this[c[0]]=l?l.replace(c[1],c[2]):n:this[c[0]]=l?c[1].call(this,l,c[2]):n:4===c.length&&(this[c[0]]=l?c[3].call(this,l.replace(c[1],c[2])):n):this[c]=l||n;h+=2}},q=function(e,t){for(var i in t)if(typeof t[i]===o&&t[i].length>0){for(var s=0;s<t[i].length;s++)if(W(t[i][s],e))return"?"===i?n:i}else if(W(t[i],e))return"?"===i?n:i;return e},$={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},z={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,P+" Mini"]],[/\bopr\/([\w\.]+)/i],[p,[l,P]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UC"+I]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[p,[l,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+I],p],[/\bfocus\/([\w\.]+)/i],[p,[l,b+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,P+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,P+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI "+I]],[/fxios\/([-\w\.]+)/i],[p,[l,b]],[/\bqihu|(qi?ho?o?|360)browser/i],[[l,"360 "+I]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1 "+I],p],[/(comodo_dragon)\/([\w\.]+)/i],[[l,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[l,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,V],p],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,A+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,A+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android "+I]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,q,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,b+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[l,p],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[f,"amd64"]],[/(ia32(?=;))/i],[[f,H]],[/((?:i[346]|x)86)[;\)]/i],[[f,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[f,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[f,"armhf"]],[/windows (ce|mobile); ppc;/i],[[f,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[f,/ower/,"",H]],[/(sun4\w)[;\)]/i],[[f,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[f,H]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[u,k],[h,_]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[u,k],[h,E]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[u,R],[h,E]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[u,R],[h,_]],[/(macintosh);/i],[d,[u,R]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[u,M],[h,E]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[u,D],[h,_]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[u,D],[h,E]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[u,x],[h,E]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[u,x],[h,_]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[u,"OPPO"],[h,E]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[u,"Vivo"],[h,E]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[u,"Realme"],[h,E]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[u,L],[h,E]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[u,L],[h,_]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[u,O],[h,_]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[u,O],[h,E]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[u,"Lenovo"],[h,_]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[u,"Nokia"],[h,E]],[/(pixel c)\b/i],[d,[u,w],[h,_]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[u,w],[h,E]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[u,U],[h,E]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[u,U],[h,_]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[u,"OnePlus"],[h,E]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[u,v],[h,_]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[u,v],[h,E]],[/(playbook);[-\w\),; ]+(rim)/i],[d,u,[h,_]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[u,C],[h,E]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[u,y],[h,_]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[u,y],[h,E]],[/(nexus 9)/i],[d,[u,"HTC"],[h,_]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[u,[d,/_/g," "],[h,E]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[u,"Acer"],[h,_]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[u,"Meizu"],[h,E]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[u,d,[h,E]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[u,d,[h,_]],[/(surface duo)/i],[d,[u,N],[h,_]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[u,"Fairphone"],[h,E]],[/(u304aa)/i],[d,[u,"AT&T"],[h,E]],[/\bsie-(\w*)/i],[d,[u,"Siemens"],[h,E]],[/\b(rct\w+) b/i],[d,[u,"RCA"],[h,_]],[/\b(venue[\d ]{2,7}) b/i],[d,[u,"Dell"],[h,_]],[/\b(q(?:mv|ta)\w+) b/i],[d,[u,"Verizon"],[h,_]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[u,"Barnes & Noble"],[h,_]],[/\b(tm\d{3}\w+) b/i],[d,[u,"NuVision"],[h,_]],[/\b(k88) b/i],[d,[u,"ZTE"],[h,_]],[/\b(nx\d{3}j) b/i],[d,[u,"ZTE"],[h,E]],[/\b(gen\d{3}) b.+49h/i],[d,[u,"Swiss"],[h,E]],[/\b(zur\d{3}) b/i],[d,[u,"Swiss"],[h,_]],[/\b((zeki)?tb.*\b) b/i],[d,[u,"Zeki"],[h,_]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[u,"Dragon Touch"],d,[h,_]],[/\b(ns-?\w{0,9}) b/i],[d,[u,"Insignia"],[h,_]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[u,"NextBook"],[h,_]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[u,"Voice"],d,[h,E]],[/\b(lvtel\-)?(v1[12]) b/i],[[u,"LvTel"],d,[h,E]],[/\b(ph-1) /i],[d,[u,"Essential"],[h,E]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[u,"Envizen"],[h,_]],[/\b(trio[-\w\. ]+) b/i],[d,[u,"MachSpeed"],[h,_]],[/\btu_(1491) b/i],[d,[u,"Rotor"],[h,_]],[/(shield[\w ]+) b/i],[d,[u,"Nvidia"],[h,_]],[/(sprint) (\w+)/i],[u,d,[h,E]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[u,N],[h,E]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[u,F],[h,_]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[u,F],[h,E]],[/smart-tv.+(samsung)/i],[u,[h,g]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[u,k],[h,g]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[u,O],[h,g]],[/(apple) ?tv/i],[u,[d,R+" TV"],[h,g]],[/crkey/i],[[d,A+"cast"],[u,w],[h,g]],[/droid.+aft(\w)( bui|\))/i],[d,[u,v],[h,g]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[u,M],[h,g]],[/(bravia[\w ]+)( bui|\))/i],[d,[u,U],[h,g]],[/(mitv-\w{5}) bui/i],[d,[u,x],[h,g]],[/Hbbtv.*(technisat) (.*);/i],[u,d,[h,g]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[u,K],[d,K],[h,g]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[h,g]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[u,d,[h,m]],[/droid.+; (shield) bui/i],[d,[u,"Nvidia"],[h,m]],[/(playstation [345portablevi]+)/i],[d,[u,U],[h,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[u,N],[h,m]],[/((pebble))app/i],[u,d,[h,T]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[u,R],[h,T]],[/droid.+; (glass) \d/i],[d,[u,w],[h,T]],[/droid.+; (wt63?0{2,3})\)/i],[d,[u,F],[h,T]],[/(quest( 2| pro)?)/i],[d,[u,V],[h,T]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[u,[h,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[h,E]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[h,_]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[h,_]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[h,E]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[u,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[l,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[l,[p,q,$]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[l,"Windows"],[p,q,$]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,G],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,p],[/\(bb(10);/i],[p,[l,C]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,b+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,A+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,B],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[l,p]]},X=function(e,t){if(typeof e===o&&(t=e,e=n),!(this instanceof X))return new X(e,t).getResult();var m=typeof i!==r&&i.navigator?i.navigator:n,g=e||(m&&m.userAgent?m.userAgent:""),T=m&&m.userAgentData?m.userAgentData:n,S=t?function(e,t){var i={};for(var n in e)t[n]&&t[n].length%2==0?i[n]=t[n].concat(e[n]):i[n]=e[n];return i}(z,t):z;return this.getBrowser=function(){var e={};return e[l]=n,e[p]=n,Y.call(e,g,S.browser),e[c]=function(e){return typeof e===a?e.replace(/[^\d\.]/g,"").split(".")[0]:n}(e[p]),m&&m.brave&&typeof m.brave.isBrave==s&&(e[l]="Brave"),e},this.getCPU=function(){var e={};return e[f]=n,Y.call(e,g,S.cpu),e},this.getDevice=function(){var e={};return e[u]=n,e[d]=n,e[h]=n,Y.call(e,g,S.device),!e[h]&&T&&T.mobile&&(e[h]=E),"Macintosh"==e[d]&&m&&typeof m.standalone!==r&&m.maxTouchPoints&&m.maxTouchPoints>2&&(e[d]="iPad",e[h]=_),e},this.getEngine=function(){var e={};return e[l]=n,e[p]=n,Y.call(e,g,S.engine),e},this.getOS=function(){var e={};return e[l]=n,e[p]=n,Y.call(e,g,S.os),!e[l]&&T&&"Unknown"!=T.platform&&(e[l]=T.platform.replace(/chrome os/i,B).replace(/macos/i,G)),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return g},this.setUA=function(e){return g=typeof e===a&&e.length>350?K(e,350):e,this},this.setUA(g),this};X.VERSION="0.7.34",X.BROWSER=j([l,p,c]),X.CPU=j([f]),X.DEVICE=j([d,u,h,m,E,g,_,T,S]),X.ENGINE=X.OS=j([l,p]),e.exports&&(t=e.exports=X),t.UAParser=X;var J=typeof i!==r&&(i.jQuery||i.Zepto);if(J&&!J.ua){var Q=new X;J.ua=Q.getResult(),J.ua.get=function(){return Q.getUA()},J.ua.set=function(e){Q.setUA(e);var t=Q.getResult();for(var i in t)J.ua[i]=t[i]}}}("object"==typeof window?window:i)}(sw,sw.exports);var rw=n(sw.exports);function ow(e,t){return function(){return e.apply(t,arguments)}}const{toString:aw}=Object.prototype,{getPrototypeOf:cw}=Object,dw=(lw=Object.create(null),e=>{const t=aw.call(e);return lw[t]||(lw[t]=t.slice(8,-1).toLowerCase())});var lw;const hw=e=>(e=e.toLowerCase(),t=>dw(t)===e),uw=e=>t=>typeof t===e,{isArray:pw}=Array,fw=uw("undefined");const mw=hw("ArrayBuffer");const Ew=uw("string"),_w=uw("function"),gw=uw("number"),Tw=e=>null!==e&&"object"==typeof e,Sw=e=>{if("object"!==dw(e))return!1;const t=cw(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)},vw=hw("Date"),Rw=hw("File"),yw=hw("Blob"),Cw=hw("FileList"),Iw=hw("URLSearchParams");function Aw(e,t,{allOwnKeys:i=!1}={}){if(null==e)return;let n,s;if("object"!=typeof e&&(e=[e]),pw(e))for(n=0,s=e.length;n<s;n++)t.call(null,e[n],n,e);else{const s=i?Object.getOwnPropertyNames(e):Object.keys(e),r=s.length;let o;for(n=0;n<r;n++)o=s[n],t.call(null,e[o],o,e)}}function bw(e,t){t=t.toLowerCase();const i=Object.keys(e);let n,s=i.length;for(;s-- >0;)if(n=i[s],t===n.toLowerCase())return n;return null}const ww="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:global,Dw=e=>!fw(e)&&e!==ww;const Ow=(Nw="undefined"!=typeof Uint8Array&&cw(Uint8Array),e=>Nw&&e instanceof Nw);var Nw;const Lw=hw("HTMLFormElement"),Pw=(({hasOwnProperty:e})=>(t,i)=>e.call(t,i))(Object.prototype),kw=hw("RegExp"),Mw=(e,t)=>{const i=Object.getOwnPropertyDescriptors(e),n={};Aw(i,((i,s)=>{let r;!1!==(r=t(i,s,e))&&(n[s]=r||i)})),Object.defineProperties(e,n)},Uw="abcdefghijklmnopqrstuvwxyz",xw="0123456789",Fw={DIGIT:xw,ALPHA:Uw,ALPHA_DIGIT:Uw+Uw.toUpperCase()+xw};const Vw=hw("AsyncFunction");var Bw={isArray:pw,isArrayBuffer:mw,isBuffer:function(e){return null!==e&&!fw(e)&&null!==e.constructor&&!fw(e.constructor)&&_w(e.constructor.isBuffer)&&e.constructor.isBuffer(e)},isFormData:e=>{let t;return e&&("function"==typeof FormData&&e instanceof FormData||_w(e.append)&&("formdata"===(t=dw(e))||"object"===t&&_w(e.toString)&&"[object FormData]"===e.toString()))},isArrayBufferView:function(e){let t;return t="undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&mw(e.buffer),t},isString:Ew,isNumber:gw,isBoolean:e=>!0===e||!1===e,isObject:Tw,isPlainObject:Sw,isUndefined:fw,isDate:vw,isFile:Rw,isBlob:yw,isRegExp:kw,isFunction:_w,isStream:e=>Tw(e)&&_w(e.pipe),isURLSearchParams:Iw,isTypedArray:Ow,isFileList:Cw,forEach:Aw,merge:function e(){const{caseless:t}=Dw(this)&&this||{},i={},n=(n,s)=>{const r=t&&bw(i,s)||s;Sw(i[r])&&Sw(n)?i[r]=e(i[r],n):Sw(n)?i[r]=e({},n):pw(n)?i[r]=n.slice():i[r]=n};for(let e=0,t=arguments.length;e<t;e++)arguments[e]&&Aw(arguments[e],n);return i},extend:(e,t,i,{allOwnKeys:n}={})=>(Aw(t,((t,n)=>{i&&_w(t)?e[n]=ow(t,i):e[n]=t}),{allOwnKeys:n}),e),trim:e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(65279===e.charCodeAt(0)&&(e=e.slice(1)),e),inherits:(e,t,i,n)=>{e.prototype=Object.create(t.prototype,n),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),i&&Object.assign(e.prototype,i)},toFlatObject:(e,t,i,n)=>{let s,r,o;const a={};if(t=t||{},null==e)return t;do{for(s=Object.getOwnPropertyNames(e),r=s.length;r-- >0;)o=s[r],n&&!n(o,e,t)||a[o]||(t[o]=e[o],a[o]=!0);e=!1!==i&&cw(e)}while(e&&(!i||i(e,t))&&e!==Object.prototype);return t},kindOf:dw,kindOfTest:hw,endsWith:(e,t,i)=>{e=String(e),(void 0===i||i>e.length)&&(i=e.length),i-=t.length;const n=e.indexOf(t,i);return-1!==n&&n===i},toArray:e=>{if(!e)return null;if(pw(e))return e;let t=e.length;if(!gw(t))return null;const i=new Array(t);for(;t-- >0;)i[t]=e[t];return i},forEachEntry:(e,t)=>{const i=(e&&e[Symbol.iterator]).call(e);let n;for(;(n=i.next())&&!n.done;){const i=n.value;t.call(e,i[0],i[1])}},matchAll:(e,t)=>{let i;const n=[];for(;null!==(i=e.exec(t));)n.push(i);return n},isHTMLForm:Lw,hasOwnProperty:Pw,hasOwnProp:Pw,reduceDescriptors:Mw,freezeMethods:e=>{Mw(e,((t,i)=>{if(_w(e)&&-1!==["arguments","caller","callee"].indexOf(i))return!1;const n=e[i];_w(n)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))}))},toObjectSet:(e,t)=>{const i={},n=e=>{e.forEach((e=>{i[e]=!0}))};return pw(e)?n(e):n(String(e).split(t)),i},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(e,t,i){return t.toUpperCase()+i})),noop:()=>{},toFiniteNumber:(e,t)=>(e=+e,Number.isFinite(e)?e:t),findKey:bw,global:ww,isContextDefined:Dw,ALPHABET:Fw,generateString:(e=16,t=Fw.ALPHA_DIGIT)=>{let i="";const{length:n}=t;for(;e--;)i+=t[Math.random()*n|0];return i},isSpecCompliantForm:function(e){return!!(e&&_w(e.append)&&"FormData"===e[Symbol.toStringTag]&&e[Symbol.iterator])},toJSONObject:e=>{const t=new Array(10),i=(e,n)=>{if(Tw(e)){if(t.indexOf(e)>=0)return;if(!("toJSON"in e)){t[n]=e;const s=pw(e)?[]:{};return Aw(e,((e,t)=>{const r=i(e,n+1);!fw(r)&&(s[t]=r)})),t[n]=void 0,s}}return e};return i(e,0)},isAsyncFn:Vw,isThenable:e=>e&&(Tw(e)||_w(e))&&_w(e.then)&&_w(e.catch)};function Gw(e,t,i,n,s){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack,this.message=e,this.name="AxiosError",t&&(this.code=t),i&&(this.config=i),n&&(this.request=n),s&&(this.response=s)}Bw.inherits(Gw,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:Bw.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const jw=Gw.prototype,Ww={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{Ww[e]={value:e}})),Object.defineProperties(Gw,Ww),Object.defineProperty(jw,"isAxiosError",{value:!0}),Gw.from=(e,t,i,n,s,r)=>{const o=Object.create(jw);return Bw.toFlatObject(e,o,(function(e){return e!==Error.prototype}),(e=>"isAxiosError"!==e)),Gw.call(o,e.message,t,i,n,s),o.cause=e,o.name=e.name,r&&Object.assign(o,r),o};function Hw(e){return Bw.isPlainObject(e)||Bw.isArray(e)}function Kw(e){return Bw.endsWith(e,"[]")?e.slice(0,-2):e}function Yw(e,t,i){return e?e.concat(t).map((function(e,t){return e=Kw(e),!i&&t?"["+e+"]":e})).join(i?".":""):t}const qw=Bw.toFlatObject(Bw,{},null,(function(e){return/^is[A-Z]/.test(e)}));function $w(e,t,i){if(!Bw.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const n=(i=Bw.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(e,t){return!Bw.isUndefined(t[e])}))).metaTokens,s=i.visitor||d,r=i.dots,o=i.indexes,a=(i.Blob||"undefined"!=typeof Blob&&Blob)&&Bw.isSpecCompliantForm(t);if(!Bw.isFunction(s))throw new TypeError("visitor must be a function");function c(e){if(null===e)return"";if(Bw.isDate(e))return e.toISOString();if(!a&&Bw.isBlob(e))throw new Gw("Blob is not supported. Use a Buffer instead.");return Bw.isArrayBuffer(e)||Bw.isTypedArray(e)?a&&"function"==typeof Blob?new Blob([e]):Buffer.from(e):e}function d(e,i,s){let a=e;if(e&&!s&&"object"==typeof e)if(Bw.endsWith(i,"{}"))i=n?i:i.slice(0,-2),e=JSON.stringify(e);else if(Bw.isArray(e)&&function(e){return Bw.isArray(e)&&!e.some(Hw)}(e)||(Bw.isFileList(e)||Bw.endsWith(i,"[]"))&&(a=Bw.toArray(e)))return i=Kw(i),a.forEach((function(e,n){!Bw.isUndefined(e)&&null!==e&&t.append(!0===o?Yw([i],n,r):null===o?i:i+"[]",c(e))})),!1;return!!Hw(e)||(t.append(Yw(s,i,r),c(e)),!1)}const l=[],h=Object.assign(qw,{defaultVisitor:d,convertValue:c,isVisitable:Hw});if(!Bw.isObject(e))throw new TypeError("data must be an object");return function e(i,n){if(!Bw.isUndefined(i)){if(-1!==l.indexOf(i))throw Error("Circular reference detected in "+n.join("."));l.push(i),Bw.forEach(i,(function(i,r){!0===(!(Bw.isUndefined(i)||null===i)&&s.call(t,i,Bw.isString(r)?r.trim():r,n,h))&&e(i,n?n.concat(r):[r])})),l.pop()}}(e),t}function zw(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(e){return t[e]}))}function Xw(e,t){this._pairs=[],e&&$w(e,this,t)}const Jw=Xw.prototype;function Qw(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Zw(e,t,i){if(!t)return e;const n=i&&i.encode||Qw,s=i&&i.serialize;let r;if(r=s?s(t,i):Bw.isURLSearchParams(t)?t.toString():new Xw(t,i).toString(n),r){const t=e.indexOf("#");-1!==t&&(e=e.slice(0,t)),e+=(-1===e.indexOf("?")?"?":"&")+r}return e}Jw.append=function(e,t){this._pairs.push([e,t])},Jw.toString=function(e){const t=e?function(t){return e.call(this,t,zw)}:zw;return this._pairs.map((function(e){return t(e[0])+"="+t(e[1])}),"").join("&")};var eD=class{constructor(){this.handlers=[]}use(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){Bw.forEach(this.handlers,(function(t){null!==t&&e(t)}))}},tD={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},iD={isBrowser:!0,classes:{URLSearchParams:"undefined"!=typeof URLSearchParams?URLSearchParams:Xw,FormData:"undefined"!=typeof FormData?FormData:null,Blob:"undefined"!=typeof Blob?Blob:null},protocols:["http","https","file","blob","url","data"]};const nD="undefined"!=typeof window&&"undefined"!=typeof document,sD=(rD="undefined"!=typeof navigator&&navigator.product,nD&&["ReactNative","NativeScript","NS"].indexOf(rD)<0);var rD;const oD="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope&&"function"==typeof self.importScripts;var aD={...Object.freeze({__proto__:null,hasBrowserEnv:nD,hasStandardBrowserEnv:sD,hasStandardBrowserWebWorkerEnv:oD}),...iD};function cD(e){function t(e,i,n,s){let r=e[s++];if("__proto__"===r)return!0;const o=Number.isFinite(+r),a=s>=e.length;if(r=!r&&Bw.isArray(n)?n.length:r,a)return Bw.hasOwnProp(n,r)?n[r]=[n[r],i]:n[r]=i,!o;n[r]&&Bw.isObject(n[r])||(n[r]=[]);return t(e,i,n[r],s)&&Bw.isArray(n[r])&&(n[r]=function(e){const t={},i=Object.keys(e);let n;const s=i.length;let r;for(n=0;n<s;n++)r=i[n],t[r]=e[r];return t}(n[r])),!o}if(Bw.isFormData(e)&&Bw.isFunction(e.entries)){const i={};return Bw.forEachEntry(e,((e,n)=>{t(function(e){return Bw.matchAll(/\w+|\[(\w*)]/g,e).map((e=>"[]"===e[0]?"":e[1]||e[0]))}(e),n,i,0)})),i}return null}const dD={transitional:tD,adapter:["xhr","http"],transformRequest:[function(e,t){const i=t.getContentType()||"",n=i.indexOf("application/json")>-1,s=Bw.isObject(e);s&&Bw.isHTMLForm(e)&&(e=new FormData(e));if(Bw.isFormData(e))return n?JSON.stringify(cD(e)):e;if(Bw.isArrayBuffer(e)||Bw.isBuffer(e)||Bw.isStream(e)||Bw.isFile(e)||Bw.isBlob(e))return e;if(Bw.isArrayBufferView(e))return e.buffer;if(Bw.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let r;if(s){if(i.indexOf("application/x-www-form-urlencoded")>-1)return function(e,t){return $w(e,new aD.classes.URLSearchParams,Object.assign({visitor:function(e,t,i,n){return aD.isNode&&Bw.isBuffer(e)?(this.append(t,e.toString("base64")),!1):n.defaultVisitor.apply(this,arguments)}},t))}(e,this.formSerializer).toString();if((r=Bw.isFileList(e))||i.indexOf("multipart/form-data")>-1){const t=this.env&&this.env.FormData;return $w(r?{"files[]":e}:e,t&&new t,this.formSerializer)}}return s||n?(t.setContentType("application/json",!1),function(e,t,i){if(Bw.isString(e))try{return(t||JSON.parse)(e),Bw.trim(e)}catch(e){if("SyntaxError"!==e.name)throw e}return(i||JSON.stringify)(e)}(e)):e}],transformResponse:[function(e){const t=this.transitional||dD.transitional,i=t&&t.forcedJSONParsing,n="json"===this.responseType;if(e&&Bw.isString(e)&&(i&&!this.responseType||n)){const i=!(t&&t.silentJSONParsing)&&n;try{return JSON.parse(e)}catch(e){if(i){if("SyntaxError"===e.name)throw Gw.from(e,Gw.ERR_BAD_RESPONSE,this,null,this.response);throw e}}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:aD.classes.FormData,Blob:aD.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};Bw.forEach(["delete","get","head","post","put","patch"],(e=>{dD.headers[e]={}}));var lD=dD;const hD=Bw.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]);const uD=Symbol("internals");function pD(e){return e&&String(e).trim().toLowerCase()}function fD(e){return!1===e||null==e?e:Bw.isArray(e)?e.map(fD):String(e)}function mD(e,t,i,n,s){return Bw.isFunction(n)?n.call(this,t,i):(s&&(t=i),Bw.isString(t)?Bw.isString(n)?-1!==t.indexOf(n):Bw.isRegExp(n)?n.test(t):void 0:void 0)}class ED{constructor(e){e&&this.set(e)}set(e,t,i){const n=this;function s(e,t,i){const s=pD(t);if(!s)throw new Error("header name must be a non-empty string");const r=Bw.findKey(n,s);(!r||void 0===n[r]||!0===i||void 0===i&&!1!==n[r])&&(n[r||t]=fD(e))}const r=(e,t)=>Bw.forEach(e,((e,i)=>s(e,i,t)));return Bw.isPlainObject(e)||e instanceof this.constructor?r(e,t):Bw.isString(e)&&(e=e.trim())&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim())?r((e=>{const t={};let i,n,s;return e&&e.split("\n").forEach((function(e){s=e.indexOf(":"),i=e.substring(0,s).trim().toLowerCase(),n=e.substring(s+1).trim(),!i||t[i]&&hD[i]||("set-cookie"===i?t[i]?t[i].push(n):t[i]=[n]:t[i]=t[i]?t[i]+", "+n:n)})),t})(e),t):null!=e&&s(t,e,i),this}get(e,t){if(e=pD(e)){const i=Bw.findKey(this,e);if(i){const e=this[i];if(!t)return e;if(!0===t)return function(e){const t=Object.create(null),i=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let n;for(;n=i.exec(e);)t[n[1]]=n[2];return t}(e);if(Bw.isFunction(t))return t.call(this,e,i);if(Bw.isRegExp(t))return t.exec(e);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=pD(e)){const i=Bw.findKey(this,e);return!(!i||void 0===this[i]||t&&!mD(0,this[i],i,t))}return!1}delete(e,t){const i=this;let n=!1;function s(e){if(e=pD(e)){const s=Bw.findKey(i,e);!s||t&&!mD(0,i[s],s,t)||(delete i[s],n=!0)}}return Bw.isArray(e)?e.forEach(s):s(e),n}clear(e){const t=Object.keys(this);let i=t.length,n=!1;for(;i--;){const s=t[i];e&&!mD(0,this[s],s,e,!0)||(delete this[s],n=!0)}return n}normalize(e){const t=this,i={};return Bw.forEach(this,((n,s)=>{const r=Bw.findKey(i,s);if(r)return t[r]=fD(n),void delete t[s];const o=e?function(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,((e,t,i)=>t.toUpperCase()+i))}(s):String(s).trim();o!==s&&delete t[s],t[o]=fD(n),i[o]=!0})),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return Bw.forEach(this,((i,n)=>{null!=i&&!1!==i&&(t[n]=e&&Bw.isArray(i)?i.join(", "):i)})),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((([e,t])=>e+": "+t)).join("\n")}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const i=new this(e);return t.forEach((e=>i.set(e))),i}static accessor(e){const t=(this[uD]=this[uD]={accessors:{}}).accessors,i=this.prototype;function n(e){const n=pD(e);t[n]||(!function(e,t){const i=Bw.toCamelCase(" "+t);["get","set","has"].forEach((n=>{Object.defineProperty(e,n+i,{value:function(e,i,s){return this[n].call(this,t,e,i,s)},configurable:!0})}))}(i,e),t[n]=!0)}return Bw.isArray(e)?e.forEach(n):n(e),this}}ED.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),Bw.reduceDescriptors(ED.prototype,(({value:e},t)=>{let i=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(e){this[i]=e}}})),Bw.freezeMethods(ED);var _D=ED;function gD(e,t){const i=this||lD,n=t||i,s=_D.from(n.headers);let r=n.data;return Bw.forEach(e,(function(e){r=e.call(i,r,s.normalize(),t?t.status:void 0)})),s.normalize(),r}function TD(e){return!(!e||!e.__CANCEL__)}function SD(e,t,i){Gw.call(this,null==e?"canceled":e,Gw.ERR_CANCELED,t,i),this.name="CanceledError"}Bw.inherits(SD,Gw,{__CANCEL__:!0});var vD=aD.hasStandardBrowserEnv?{write(e,t,i,n,s,r){const o=[e+"="+encodeURIComponent(t)];Bw.isNumber(i)&&o.push("expires="+new Date(i).toGMTString()),Bw.isString(n)&&o.push("path="+n),Bw.isString(s)&&o.push("domain="+s),!0===r&&o.push("secure"),document.cookie=o.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function RD(e,t){return e&&!/^([a-z][a-z\d+\-.]*:)?\/\//i.test(t)?function(e,t){return t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e}(e,t):t}var yD=aD.hasStandardBrowserEnv?function(){const e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a");let i;function n(i){let n=i;return e&&(t.setAttribute("href",n),n=t.href),t.setAttribute("href",n),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:"/"===t.pathname.charAt(0)?t.pathname:"/"+t.pathname}}return i=n(window.location.href),function(e){const t=Bw.isString(e)?n(e):e;return t.protocol===i.protocol&&t.host===i.host}}():function(){return!0};function CD(e,t){let i=0;const n=function(e,t){e=e||10;const i=new Array(e),n=new Array(e);let s,r=0,o=0;return t=void 0!==t?t:1e3,function(a){const c=Date.now(),d=n[o];s||(s=c),i[r]=a,n[r]=c;let l=o,h=0;for(;l!==r;)h+=i[l++],l%=e;if(r=(r+1)%e,r===o&&(o=(o+1)%e),c-s<t)return;const u=d&&c-d;return u?Math.round(1e3*h/u):void 0}}(50,250);return s=>{const r=s.loaded,o=s.lengthComputable?s.total:void 0,a=r-i,c=n(a);i=r;const d={loaded:r,total:o,progress:o?r/o:void 0,bytes:a,rate:c||void 0,estimated:c&&o&&r<=o?(o-r)/c:void 0,event:s};d[t?"download":"upload"]=!0,e(d)}}var ID="undefined"!=typeof XMLHttpRequest&&function(e){return new Promise((function(t,i){let n=e.data;const s=_D.from(e.headers).normalize();let r,o,{responseType:a,withXSRFToken:c}=e;function d(){e.cancelToken&&e.cancelToken.unsubscribe(r),e.signal&&e.signal.removeEventListener("abort",r)}if(Bw.isFormData(n))if(aD.hasStandardBrowserEnv||aD.hasStandardBrowserWebWorkerEnv)s.setContentType(!1);else if(!1!==(o=s.getContentType())){const[e,...t]=o?o.split(";").map((e=>e.trim())).filter(Boolean):[];s.setContentType([e||"multipart/form-data",...t].join("; "))}let l=new XMLHttpRequest;if(e.auth){const t=e.auth.username||"",i=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";s.set("Authorization","Basic "+btoa(t+":"+i))}const h=RD(e.baseURL,e.url);function u(){if(!l)return;const n=_D.from("getAllResponseHeaders"in l&&l.getAllResponseHeaders());!function(e,t,i){const n=i.config.validateStatus;i.status&&n&&!n(i.status)?t(new Gw("Request failed with status code "+i.status,[Gw.ERR_BAD_REQUEST,Gw.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):e(i)}((function(e){t(e),d()}),(function(e){i(e),d()}),{data:a&&"text"!==a&&"json"!==a?l.response:l.responseText,status:l.status,statusText:l.statusText,headers:n,config:e,request:l}),l=null}if(l.open(e.method.toUpperCase(),Zw(h,e.params,e.paramsSerializer),!0),l.timeout=e.timeout,"onloadend"in l?l.onloadend=u:l.onreadystatechange=function(){l&&4===l.readyState&&(0!==l.status||l.responseURL&&0===l.responseURL.indexOf("file:"))&&setTimeout(u)},l.onabort=function(){l&&(i(new Gw("Request aborted",Gw.ECONNABORTED,e,l)),l=null)},l.onerror=function(){i(new Gw("Network Error",Gw.ERR_NETWORK,e,l)),l=null},l.ontimeout=function(){let t=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded";const n=e.transitional||tD;e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),i(new Gw(t,n.clarifyTimeoutError?Gw.ETIMEDOUT:Gw.ECONNABORTED,e,l)),l=null},aD.hasStandardBrowserEnv&&(c&&Bw.isFunction(c)&&(c=c(e)),c||!1!==c&&yD(h))){const t=e.xsrfHeaderName&&e.xsrfCookieName&&vD.read(e.xsrfCookieName);t&&s.set(e.xsrfHeaderName,t)}void 0===n&&s.setContentType(null),"setRequestHeader"in l&&Bw.forEach(s.toJSON(),(function(e,t){l.setRequestHeader(t,e)})),Bw.isUndefined(e.withCredentials)||(l.withCredentials=!!e.withCredentials),a&&"json"!==a&&(l.responseType=e.responseType),"function"==typeof e.onDownloadProgress&&l.addEventListener("progress",CD(e.onDownloadProgress,!0)),"function"==typeof e.onUploadProgress&&l.upload&&l.upload.addEventListener("progress",CD(e.onUploadProgress)),(e.cancelToken||e.signal)&&(r=t=>{l&&(i(!t||t.type?new SD(null,e,l):t),l.abort(),l=null)},e.cancelToken&&e.cancelToken.subscribe(r),e.signal&&(e.signal.aborted?r():e.signal.addEventListener("abort",r)));const p=function(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}(h);p&&-1===aD.protocols.indexOf(p)?i(new Gw("Unsupported protocol "+p+":",Gw.ERR_BAD_REQUEST,e)):l.send(n||null)}))};const AD={http:null,xhr:ID};Bw.forEach(AD,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch(e){}Object.defineProperty(e,"adapterName",{value:t})}}));const bD=e=>`- ${e}`,wD=e=>Bw.isFunction(e)||null===e||!1===e;var DD={getAdapter:e=>{e=Bw.isArray(e)?e:[e];const{length:t}=e;let i,n;const s={};for(let r=0;r<t;r++){let t;if(i=e[r],n=i,!wD(i)&&(n=AD[(t=String(i)).toLowerCase()],void 0===n))throw new Gw(`Unknown adapter '${t}'`);if(n)break;s[t||"#"+r]=n}if(!n){const e=Object.entries(s).map((([e,t])=>`adapter ${e} `+(!1===t?"is not supported by the environment":"is not available in the build")));throw new Gw("There is no suitable adapter to dispatch the request "+(t?e.length>1?"since :\n"+e.map(bD).join("\n"):" "+bD(e[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return n},adapters:AD};function OD(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new SD(null,e)}function ND(e){OD(e),e.headers=_D.from(e.headers),e.data=gD.call(e,e.transformRequest),-1!==["post","put","patch"].indexOf(e.method)&&e.headers.setContentType("application/x-www-form-urlencoded",!1);return DD.getAdapter(e.adapter||lD.adapter)(e).then((function(t){return OD(e),t.data=gD.call(e,e.transformResponse,t),t.headers=_D.from(t.headers),t}),(function(t){return TD(t)||(OD(e),t&&t.response&&(t.response.data=gD.call(e,e.transformResponse,t.response),t.response.headers=_D.from(t.response.headers))),Promise.reject(t)}))}const LD=e=>e instanceof _D?e.toJSON():e;function PD(e,t){t=t||{};const i={};function n(e,t,i){return Bw.isPlainObject(e)&&Bw.isPlainObject(t)?Bw.merge.call({caseless:i},e,t):Bw.isPlainObject(t)?Bw.merge({},t):Bw.isArray(t)?t.slice():t}function s(e,t,i){return Bw.isUndefined(t)?Bw.isUndefined(e)?void 0:n(void 0,e,i):n(e,t,i)}function r(e,t){if(!Bw.isUndefined(t))return n(void 0,t)}function o(e,t){return Bw.isUndefined(t)?Bw.isUndefined(e)?void 0:n(void 0,e):n(void 0,t)}function a(i,s,r){return r in t?n(i,s):r in e?n(void 0,i):void 0}const c={url:r,method:r,data:r,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(e,t)=>s(LD(e),LD(t),!0)};return Bw.forEach(Object.keys(Object.assign({},e,t)),(function(n){const r=c[n]||s,o=r(e[n],t[n],n);Bw.isUndefined(o)&&r!==a||(i[n]=o)})),i}const kD="1.6.7",MD={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{MD[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}}));const UD={};MD.transitional=function(e,t,i){function n(e,t){return"[Axios v"+kD+"] Transitional option '"+e+"'"+t+(i?". "+i:"")}return(i,s,r)=>{if(!1===e)throw new Gw(n(s," has been removed"+(t?" in "+t:"")),Gw.ERR_DEPRECATED);return t&&!UD[s]&&(UD[s]=!0,console.warn(n(s," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(i,s,r)}};var xD={assertOptions:function(e,t,i){if("object"!=typeof e)throw new Gw("options must be an object",Gw.ERR_BAD_OPTION_VALUE);const n=Object.keys(e);let s=n.length;for(;s-- >0;){const r=n[s],o=t[r];if(o){const t=e[r],i=void 0===t||o(t,r,e);if(!0!==i)throw new Gw("option "+r+" must be "+i,Gw.ERR_BAD_OPTION_VALUE)}else if(!0!==i)throw new Gw("Unknown option "+r,Gw.ERR_BAD_OPTION)}},validators:MD};const FD=xD.validators;class VD{constructor(e){this.defaults=e,this.interceptors={request:new eD,response:new eD}}async request(e,t){try{return await this._request(e,t)}catch(e){if(e instanceof Error){let t;Error.captureStackTrace?Error.captureStackTrace(t={}):t=new Error;const i=t.stack?t.stack.replace(/^.+\n/,""):"";e.stack?i&&!String(e.stack).endsWith(i.replace(/^.+\n.+\n/,""))&&(e.stack+="\n"+i):e.stack=i}throw e}}_request(e,t){"string"==typeof e?(t=t||{}).url=e:t=e||{},t=PD(this.defaults,t);const{transitional:i,paramsSerializer:n,headers:s}=t;void 0!==i&&xD.assertOptions(i,{silentJSONParsing:FD.transitional(FD.boolean),forcedJSONParsing:FD.transitional(FD.boolean),clarifyTimeoutError:FD.transitional(FD.boolean)},!1),null!=n&&(Bw.isFunction(n)?t.paramsSerializer={serialize:n}:xD.assertOptions(n,{encode:FD.function,serialize:FD.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let r=s&&Bw.merge(s.common,s[t.method]);s&&Bw.forEach(["delete","get","head","post","put","patch","common"],(e=>{delete s[e]})),t.headers=_D.concat(r,s);const o=[];let a=!0;this.interceptors.request.forEach((function(e){"function"==typeof e.runWhen&&!1===e.runWhen(t)||(a=a&&e.synchronous,o.unshift(e.fulfilled,e.rejected))}));const c=[];let d;this.interceptors.response.forEach((function(e){c.push(e.fulfilled,e.rejected)}));let l,h=0;if(!a){const e=[ND.bind(this),void 0];for(e.unshift.apply(e,o),e.push.apply(e,c),l=e.length,d=Promise.resolve(t);h<l;)d=d.then(e[h++],e[h++]);return d}l=o.length;let u=t;for(h=0;h<l;){const e=o[h++],t=o[h++];try{u=e(u)}catch(e){t.call(this,e);break}}try{d=ND.call(this,u)}catch(e){return Promise.reject(e)}for(h=0,l=c.length;h<l;)d=d.then(c[h++],c[h++]);return d}getUri(e){return Zw(RD((e=PD(this.defaults,e)).baseURL,e.url),e.params,e.paramsSerializer)}}Bw.forEach(["delete","get","head","options"],(function(e){VD.prototype[e]=function(t,i){return this.request(PD(i||{},{method:e,url:t,data:(i||{}).data}))}})),Bw.forEach(["post","put","patch"],(function(e){function t(t){return function(i,n,s){return this.request(PD(s||{},{method:e,headers:t?{"Content-Type":"multipart/form-data"}:{},url:i,data:n}))}}VD.prototype[e]=t(),VD.prototype[e+"Form"]=t(!0)}));var BD=VD;class GD{constructor(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");let t;this.promise=new Promise((function(e){t=e}));const i=this;this.promise.then((e=>{if(!i._listeners)return;let t=i._listeners.length;for(;t-- >0;)i._listeners[t](e);i._listeners=null})),this.promise.then=e=>{let t;const n=new Promise((e=>{i.subscribe(e),t=e})).then(e);return n.cancel=function(){i.unsubscribe(t)},n},e((function(e,n,s){i.reason||(i.reason=new SD(e,n,s),t(i.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);-1!==t&&this._listeners.splice(t,1)}static source(){let e;return{token:new GD((function(t){e=t})),cancel:e}}}var jD=GD;const WD={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(WD).forEach((([e,t])=>{WD[t]=e}));var HD=WD;const KD=function e(t){const i=new BD(t),n=ow(BD.prototype.request,i);return Bw.extend(n,BD.prototype,i,{allOwnKeys:!0}),Bw.extend(n,i,null,{allOwnKeys:!0}),n.create=function(i){return e(PD(t,i))},n}(lD);KD.Axios=BD,KD.CanceledError=SD,KD.CancelToken=jD,KD.isCancel=TD,KD.VERSION=kD,KD.toFormData=$w,KD.AxiosError=Gw,KD.Cancel=KD.CanceledError,KD.all=function(e){return Promise.all(e)},KD.spread=function(e){return function(t){return e.apply(null,t)}},KD.isAxiosError=function(e){return Bw.isObject(e)&&!0===e.isAxiosError},KD.mergeConfig=PD,KD.AxiosHeaders=_D,KD.formToJSON=e=>cD(Bw.isHTMLForm(e)?new FormData(e):e),KD.getAdapter=DD.getAdapter,KD.HttpStatusCode=HD,KD.default=KD;var YD=KD;const qD=()=>{};function $D(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:qD};return e.promise=new Promise(((t,i)=>{e.resolve=i=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(i),e.value=i)},e.reject=t=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,i(t))}})),e}const zD=new Map,XD=new Map,JD=new Map;async function QD(e,t,i){zD.get(e)||zD.set(e,[]),XD.get(e)||XD.set(e,t),JD.get(e)||JD.set(e,0);const n=zD.get(e),s=XD.get(e);if(!n||!s)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(JD.get(e)===s){const e=$D();n.push(e),await e.promise}JD.set(e,JD.get(e)+1);for(var r=arguments.length,o=new Array(r>3?r-3:0),a=3;a<r;a++)o[a-3]=arguments[a];const c=await i(...o);return JD.set(e,JD.get(e)-1),JD.get(e)===s-1&&n.length>0&&(n[0].resolve(),n.shift()),0===JD.get(e)&&(zD.set(e,[]),XD.set(e,0),JD.set(e,0)),c}let ZD=function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e}({}),eO=function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e}({});const tO=new rw;let iO=tO.getResult(),nO=null;function sO(e){if(!nO){e&&tO.setUA(e),iO=tO.getResult();const t=function(e){if("Blink"===e.engine.name&&"WeChat"!==e.browser.name)return eO.CHROME;switch(e.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return eO.CHROME;case"Safari":case"Mobile Safari":return eO.SAFARI;case"Edge":return eO.EDGE;case"Firefox":return eO.FIREFOX;case"QQBrowser":return eO.QQ;case"Opera":return eO.OPERA;case"WeChat":return eO.WECHAT;default:return e.browser.name||""}}(iO),i=function(e){let t;return t="Blink"===e.engine.name?e.engine.version||"":e.browser.version||"",t.split(".")[0]}(iO),n=function(e){return"Windows"===e.os.name?e.os.version?e.os.name+" "+e.os.version:e.os.name:e.os.name||""}(iO),s=iO.os.version;if(!(t&&i&&n&&s))return{name:t,version:i,os:n,osVersion:s};nO={name:t,version:i,os:n,osVersion:s}}return nO}function rO(){return sO().os}function oO(){const e=sO();return"".concat(e.os," ").concat(e.osVersion)}function aO(){const e=sO();return!!("WebKit"===iO.engine.name&&e.os===ZD.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==eO.SAFARI||hO()&&e.name!==eO.SAFARI)}function cO(){return sO().name===eO.CHROME}function dO(){return sO().name===eO.SAFARI}function lO(){return sO().name===eO.FIREFOX}function hO(){return sO().os===ZD.IOS}function uO(e,t,i){const n=sO();if(n.os!==ZD.IOS||!n.osVersion)return!1;const s=n.osVersion.split(".");return i?t&&Number(s[0])===e&&Number(s[1])<t||Number(s[0])<e:t?Number(s[0])===e&&Number(s[1])<=t||Number(s[0])<e:Number(s[0])<=e}function pO(){const e=sO();return!(e.name!==eO.CHROME||!e.osVersion)&&Number(e.version)<=90}function fO(){const e=sO();if(e.os!==ZD.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||14===Number(t[0])&&Number(t[1])<=6}function mO(){const e=sO();if(e.os!==ZD.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])}function EO(){const e=sO();if(e.os!==ZD.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 16===Number(t[0])}function _O(){const e=sO();if(e.os!==ZD.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&Number(t[1])>=1}function gO(){return dO()&&navigator.maxTouchPoints>0}function TO(){return sO().name===eO.WECHAT}function SO(){const e=sO();return e.name!==eO.EDGE&&e.name!==eO.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function vO(){return rO()===ZD.ANDROID}function RO(){const e=sO();return vO()&&(e.name===eO.CHROME||e.name===eO.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}let yO=function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e}({}),CO=class extends Error{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(t),this.code=void 0,this.message=void 0,this.data=void 0,this.name="AgoraRTCException",this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=i}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),"\n").concat(this.stack):"".concat(this.stack)}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return"error"===e&&(t||console).error(this.toString()),"warning"===e&&(t||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}};function IO(e,t){if("boolean"!=typeof e)throw new CO(yO.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function AO(e,t,i){if(!i.includes(e))throw new CO(yO.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(i)))}function bO(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e4;if(e<i||e>n||(!(arguments.length>4&&void 0!==arguments[4])||arguments[4])&&!function(e){return"number"==typeof e&&e%1==0}(e))throw new CO(yO.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(i,", ").concat(n,"]. integer only"))}function wO(e,t){if("number"!=typeof e){if(!(e.min||e.max||e.ideal||e.exact))throw new CO(yO.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));void 0!==e.min&&bO(e.min,"".concat(t,".min"),0,1/0),void 0!==e.max&&bO(e.max,"".concat(t,".max"),1,1/0),void 0!==e.exact&&bO(e.exact,"".concat(t,".exact"),1,1/0),void 0!==e.ideal&&bO(e.ideal,"".concat(t,".ideal"),1,1/0)}else bO(e,t,1,1/0)}function DO(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:255,s=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(null==e)throw new CO(yO.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!LO(e,i,n,s))throw new CO(yO.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(i,",").concat(n,"].").concat(s?" ASCII characters only.":""))}function OO(e,t){if(!Array.isArray(e))throw new CO(yO.INVALID_PARAMS,"".concat(t," should be an array"))}function NO(e){return null==e}function LO(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:255,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return"string"==typeof e&&e.length<=i&&e.length>=t&&(!n||function(e){if("string"!=typeof e)return!1;for(let t=0;t<e.length;t+=1){const i=e.charCodeAt(t);if(i<0||i>255)return!1}return!0}(e))}function PO(e,t,i){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,i);const n=e.getUint32(t,i),s=e.getUint32(t+4,i),r=Number(!!i),o=Number(!i);return BigInt(n*o+s*r)<<BigInt(32)|BigInt(n*r+s*o)}function kO(e,t,i,n){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,i,n);const s=Number(i>>BigInt(32)),r=Number(i&BigInt(4294967295));n?(e.setUint32(t+4,s,n),e.setUint32(t,r,n)):(e.setUint32(t,s,n),e.setUint32(t+4,r,n))}var MO=function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e}(MO||{}),UO=function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e}(UO||{});const xO=new class{constructor(){this._clientSize=null,this.getClientWidth=()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth,this.getClientHeight=()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight,this.getStyle=e=>window.getComputedStyle(e,null),this.checkCssVisibleProperty=e=>{let t=!0;const i=this.getStyle(e),{display:n,visibility:s,opacity:r,filter:o}=i;return("none"===n||["hidden","collapse"].includes(s)||Number(r)<.1)&&(t=!1),!!t&&(o&&o.split(" ").filter((e=>{const t=e.split("(")[0];return["brightness","blur","opacity"].includes(t)})).map((e=>{const[t,i]=e.split(/\(|\)/);return[t,Number(i.match(/^[0-9\.]+/))]})).forEach((e=>{const[i,n]=e;switch(i){case"brightness":(n<.1||n>3)&&(t=!1);break;case"blur":n>3&&(t=!1);break;case"opacity":n<.1&&(t=!1)}})),t)},this.checkPropertyUpToAllParentNodes=(e,t)=>{let i=!0,n=!0;const s=e=>t(e);let r=e;for(;r&&n;)s(r)||(i=!1,n=!1),r=r.parentElement,r||(n=!1);return i},this.checkActualCssVisibleIncludeInherit=e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty),this.getSizeAboutClient=e=>{const{width:t,height:i,left:n,right:s,top:r,bottom:o}=e.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:i,left:n,right:s,top:r,bottom:o,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}},this.checkActualSize=()=>{const{width:e,height:t,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(e,t,i)},this.elementFromPoint=(e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null,this.checkCoverForAPoint=(e,t,i)=>{const n=this.elementFromPoint(e,t);return null!==n&&n!==i},this.getPointPositionList=()=>{const{width:e,height:t,left:i,top:n}=this._clientSize,s=e/6,r=t/6,o=[],a=10**6;for(let e=0;e<5;e++)for(let t=0;t<5;t++){const c=(i*a+(0===e?.1:4===e?(s*e*a-1e5)/a:s*e)*a)/a,d=(n*a+(0===t?.1:4===t?(r*t*a-1e5)/a:r*t)*a)/a;o.push({x:c,y:d})}return[...o]},this.checkElementCover=e=>this.getPointPositionList().map((t=>this.checkCoverForAPoint(t.x,t.y,e))).filter((e=>!!e)).length>6,this.checkSizeIsVisible=(e,t,i)=>(e>50||i/e<=10)&&(t>50||i/t<=10),this.checkSizeOfPartInClient=()=>{const{left:e,right:t,top:i,bottom:n,clientHeight:s,clientWidth:r,clientMin:o}=this._clientSize;let a,c,d,l;if(e<0)a=0;else{if(!(e<r))return!1;a=e}if(t<0)return!1;if(c=t<r?t:r,i<0)d=0;else{if(!(i<s))return!1;d=i}if(n<0)return!1;l=n<s?n:s;const h=c-a,u=l-d;return this.checkSizeIsVisible(h,u,o)},this.returnHiddenResult=e=>(this._clientSize=null,{visible:!1,reason:e}),this.checkOneElementVisible=e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(MO.COVERED);{const e=this.checkActualSize(),t=this.checkSizeOfPartInClient();return e&&!t?this.returnHiddenResult(MO.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(MO.SIZE)}}return this.returnHiddenResult(MO.STYLE)}return this.returnHiddenResult(UO.UNMOUNTED)}return this.returnHiddenResult(UO.INVALID_HTML_ELEMENT)},this.checkElementIsMountedOnDom=e=>this.checkPropertyUpToAllParentNodes(e,(e=>"HTML"!==e.nodeName.toUpperCase()?null!==e.parentElement:!!document.documentElement))}};function FO(e){return(new TextEncoder).encode(e)}const VO=function(e,t){const i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i};const BO=async e=>function(e,t){let i="";return new Uint8Array(e).forEach((e=>{i+=e.toString(t).padStart(2,"0")})),i}(await crypto.subtle.digest("SHA-256",FO(e)),16);let GO=class{constructor(){this._events={},this.addListener=this.on}getListeners(e){return this._events[e]?this._events[e].map((e=>e.listener)):[]}on(e,t){this._events[e]||(this._events[e]=[]);const i=this._events[e];-1===this._indexOfListener(i,t)&&i.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const i=this._events[e];-1===this._indexOfListener(i,t)&&i.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const i=this._events[e],n=this._indexOfListener(i,t);-1!==n&&i.splice(n,1),0===this._events[e].length&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map((e=>e));for(var i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];for(let i=0;i<t.length;i+=1){const s=t[i];s.once&&this.off(e,s.listener),s.listener.apply(this,n||[])}}safeEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];[...this._events[e]||[]].forEach((t=>{t.once&&this.off(e,t.listener);try{t.listener.apply(this,i)}catch(t){console.error("safeEmit event:".concat(e," error ").concat(null==t?void 0:t.toString()))}}))}_indexOfListener(e,t){let i=e.length;for(;i--;)if(e[i].listener===t)return i;return-1}};let jO=null;function WO(){if(jO)return jO;if(window.electron)return jO=window.electron;if(!window.require)return null;try{return jO=window.require("electron"),jO}catch(e){return null}}let HO=function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.DATACHANNEL_FAILBACK="Client._datachannelFailback",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e}({}),KO=function(e){return e.TRACER="tracer",e}({});function YO(e){return bO(e.timeout,"config.timeout",0,1e5),bO(e.timeoutFactor,"config.timeoutFactor",0,100,!1),bO(e.maxRetryCount,"config.maxRetryConfig",0,1/0),bO(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}!function(e){e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY"}({});let qO=function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.FALLBACK="FALLBACK",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e}({});function $O(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach((e=>{if(!e.urls)throw Error()}))}catch(e){return!1}return!0}function zO(e){return DO(e.turnServerURL,"turnServerURL"),DO(e.username,"username"),DO(e.password,"password"),e.udpport&&bO(e.udpport,"udpport",1,99999,!0),e.forceturn&&IO(e.forceturn,"forceturn"),e.security&&IO(e.security,"security"),e.tcpport&&bO(e.tcpport,"tcpport",1,99999,!0),!0}function XO(e){return void 0!==e.level&&AO(e.level,"level",[1,2,3]),void 0!==e.delay&&bO(e.delay,"delay",0,3e3,!0),!0}let JO=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.INJECT_STREAM_STATUS="stream-inject-status",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e}({}),QO=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),ZO=function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({}),eN=function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({});function tN(e,t){for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return 0===e.getListeners(t).length?Promise.reject(new CO(yO.UNEXPECTED_ERROR,"can not emit promise")):new Promise(((i,s)=>{e.emit(t,...n,i,s)}))}function iN(e,t){if(0===e.getListeners(t).length)return Promise.resolve();for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return tN(e,t,...n)}function nN(e,t){if(0===e.getListeners(t).length)return null;for(var i=arguments.length,n=new Array(i>2?i-2:0),s=2;s<i;s++)n[s-2]=arguments[s];return sN(e,t,...n)}function sN(e,t){let i=null,n=null;for(var s=arguments.length,r=new Array(s>2?s-2:0),o=2;o<s;o++)r[o-2]=arguments[o];if(e.emit(t,...r,(e=>{i=e}),(e=>{n=e})),null!==n)throw n;if(null===i)throw new CO(yO.UNEXPECTED_ERROR,"handler is not sync");return i}const rN=new class extends GO{set networkState(e){this.emit(eN.NETWORK_STATE_CHANGE,e,this._networkState),e===ZO.ONLINE?this.emit(eN.ONLINE):e===ZO.OFFLINE&&(this.onlineWaiter=new Promise((e=>{this.once(eN.ONLINE,(()=>{this.onlineWaiter=void 0,e(ZO.ONLINE)}))})),this.emit(eN.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===ZO.ONLINE}constructor(){super(),this._moduleName="network-indicator",this._networkState=ZO.ONLINE,this.onlineWaiter=void 0,window.addEventListener("online",(()=>{this.networkState=ZO.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=ZO.OFFLINE}))}};function oN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function aN(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?oN(Object(i),!0).forEach((function(t){cN(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):oN(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function cN(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function dN(e,t){const i=e.indexOf(t);-1!==i&&e.splice(i,1)}function lN(e){const t=[];return e.forEach((e=>{-1===t.indexOf(e)&&t.push(e)})),t}function hN(e){"undefined"!=typeof Promise?Promise.resolve().then(e):setTimeout(e,0)}function uN(e){return JSON.parse(JSON.stringify(e))}function pN(e){try{return uN(e)}catch(t){return e}}const fN={};function mN(e,t){fN[t]||(fN[t]=!0,e())}function EN(e){const t=window.atob(e),i=new Uint8Array(new ArrayBuffer(t.length));for(let e=0;e<t.length;e+=1)i[e]=t.charCodeAt(e);return i}function _N(e){let t="";for(let i=0;i<e.length;i+=1)t+=String.fromCharCode(e[i]);return window.btoa(t)}function gN(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=t.reduce(((e,t)=>e+t.length),0),s=new Uint8Array(new ArrayBuffer(n));let r=0;return t.forEach((e=>{s.set(e,r),r+=e.length})),s}function TN(e){return window.TextEncoder?(new TextEncoder).encode(e).length:e.length}function SN(e){let t=0;return/DingTalk/i.test(navigator.userAgent)&&e.realFormData&&(e=e.realFormData),e.forEach((e=>{t+="string"==typeof e?TN(e):e.size})),t+138}function vN(e){const t=new CO(yO.TIMEOUT,"timeout");return new Promise(((i,n)=>{window.setTimeout((()=>n(t)),e)}))}function RN(e){return new Promise((t=>{window.setTimeout(t,e)}))}function yN(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const i=Math.random().toString(16).substr(2,e).toLowerCase();return i.length===e?"".concat(t).concat(i):"".concat(t).concat(i)+yN(e-i.length,"")}function CN(){return yN(32,"").toUpperCase()}const IN=()=>{},AN=new class{constructor(){this.fnMap=new Map}throttleByKey(e,t,i,n){for(var s=arguments.length,r=new Array(s>4?s-4:0),o=4;o<s;o++)r[o-4]=arguments[o];if(this.fnMap.has(t)){const s=this.fnMap.get(t);if(s.threshold!==i){s.fn(...s.args),clearTimeout(s.timer);const o=window.setTimeout((()=>{const e=this.fnMap.get(t);e&&e.fn(...e.args),this.fnMap.delete(t)}),i);this.fnMap.set(t,{fn:e,threshold:i,timer:o,args:r,skipFn:n})}else s.skipFn&&s.skipFn(...s.args),this.fnMap.set(t,aN(aN({},s),{},{fn:e,args:r,skipFn:n}))}else{const s=window.setTimeout((()=>{const e=this.fnMap.get(t);e&&e.fn(...e.args),this.fnMap.delete(t)}),i);this.fnMap.set(t,{fn:e,threshold:i,timer:s,args:r,skipFn:n})}}},bN=AN.throttleByKey.bind(AN);function wN(e){return"object"==typeof e&&null!==e&&!(e instanceof RegExp)}function DN(e,t){if(!wN(e)||!wN(t))return t;if(Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const i=[...e];for(let n=0;n<t.length;n++)i[n]=DN(e[n],t[n]);return i}{const i=aN({},e);for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)?i[n]=DN(e[n],t[n]):i[n]=t[n]);return i}}function ON(e,t){let i=[0];if(t&&(i=new Array(t).fill(0)),0===e)return i;let n=0;for(;e>0&&(i[n]=255&e,e>>=8,n++,!t||n!==t););return i}let NN=1,LN=console,PN=class{static setLogger(e){LN=e}constructor(e){this.lockingPromise=Promise.resolve(),this.locks=0,this.name="",this.lockId=void 0,this.lockId=NN++,e&&(this.name=e),LN.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,LN.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat("string"==typeof e?e:""));const i=new Promise((i=>{t=()=>{this.locks-=1,LN.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat("string"==typeof e?e:"")),i()}})),n=this.lockingPromise.then((()=>t));return this.lockingPromise=this.lockingPromise.then((()=>i)),n}};function kN(e,t){return function(i,n,s){const r=s.value;if("function"!=typeof r)throw new Error("Cannot use mutex on object property.");return s.value=async function(){const i=this[t];if(!i)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const s=await i.lock("From ".concat(e,".").concat(n));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await r.apply(this,a)}finally{s()}},s}}const MN={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function UN(e,t){const i=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,i)}function xN(e,t,i,n){const s=Object.assign({},MN,n);let r=s.timeout;const o=async()=>{await function(e){return new Promise((t=>{window.setTimeout(t,e)}))}(r),r*=s.timeoutFactor,r=Math.min(s.maxRetryTimeout,r)};let a=!1;const c=new Promise((async(n,r)=>{t=t||(()=>!1),i=i||(()=>!0);for(let c=0;c<s.maxRetryCount;c+=1){if(a)return r(new CO(yO.OPERATION_ABORTED));try{const i=await e();if(!t(i,c))return n(i);if(c+1===s.maxRetryCount)return n(i);await o()}catch(e){if(!i(e,c))return r(e);if(c+1===s.maxRetryCount)return r(e);await o()}}}));return c.cancel=()=>a=!0,c}let FN,VN=class{constructor(e){this.input=[],this.size=void 0,this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){return 0===this.input.length?0:this.input.reduce(((e,t)=>e+t))/this.input.length}},BN=0,GN=0;function jN(e,t,i,n){return new Promise(((s,r)=>{t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),BN+=TN(t.data)):i&&(t.data.size?BN+=t.data.size:t.data instanceof FormData?BN+=SN(t.data):BN+=TN(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,YD.request(t).then((e=>{"string"==typeof e.data?GN+=TN(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?GN+=e.data.byteLength:GN+=TN(JSON.stringify(e.data)),n&&s({data:e.data,headers:e.headers}),s(e.data)})).catch((e=>{YD.isCancel(e)?r(new CO(yO.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?r(new CO(yO.NETWORK_TIMEOUT,e.message)):e.response?r(new CO(yO.NETWORK_RESPONSE_ERROR,e.response.status)):r(new CO(yO.NETWORK_ERROR,e.message))}))}))}async function WN(e,t){const i=new Blob([t.data],{type:"buffer"});return await jN(e,aN(aN({},t),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}const HN=()=>void 0!==window.isSecureContext;const KN=function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){const e=t[1],i=t[2];return"".concat(e,".").concat(i)}const i=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(i&&i[1]&&i[2]){const e=i[1],t=i[2];return"".concat(e,".").concat(100*(Number(t)+1))}return"4.0.0.999"}("4.20.2"),YN=function(){try{return!0===JSON.parse("true")}catch(e){return!0}}();let qN=function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e}({});const $N="v4.20.2-4-g5cbf16f5-dirty(2024/4/11 11:57:35)",zN={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!1,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!1,USE_SUB_RTX:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:100,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,USE_XR:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],PLUGIN_INFO:[]};function XN(e,t,i){Object.keys(zN).includes(e)&&(!i&&Object.keys(QN).includes(e)||(zN[e]=t,"ENABLE_VIDEO_SEI"===e&&!0===t&&(zN.ENABLE_ENCODED_TRANSFORM=!0)))}function JN(e){return zN[e]}const QN={};var ZN=function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.AVOID_JOIN_START="AVOID_JOIN_START",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e}(ZN||{});let eL=function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e}({});!function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"}({});const tL=128,iL=96,nL=1e3,sL=10;let rL=0;function oL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function aL(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?oL(Object(i),!0).forEach((function(t){cL(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):oL(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function cL(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const dL=new class extends GO{reportLogUploadError(e){this.emit("REPORT_LOG_UPLOAD",e)}};class lL{constructor(e){this.logger=void 0,this.prefixLists=[],this.logger=e}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.debug(...this.prefixLists,...t)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.info(...this.prefixLists,...t)}warning(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.warning(...this.prefixLists,...t)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];this.logger.error(...this.prefixLists,...t)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function hL(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function uL(){const e=new Date,t=/((\d+:){2}\d+)/.exec((new Date).toUTCString());return t?(null==t?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const pL={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},fL=Date.now(),mL=e=>{for(const t in pL)if(Object.prototype.hasOwnProperty.call(pL,t)&&pL[t]===e)return t;return"DEFAULT"};const EL=new class{constructor(){this.proxyServerURL=void 0,this.logLevel=pL.DEBUG,this.uploadState="collecting",this.uploadLogWaitingList=[],this.uploadLogUploadingList=[],this.uploadErrorCount=0,this.currentLogID=0,this.url=void 0,this.extLog=(e,t)=>{this.appendLogToWaitingList(e,...t)}}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[pL.DEBUG].concat(t);this.log.apply(this,n)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[pL.INFO].concat(t);this.log.apply(this,n)}warning(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[pL.WARNING].concat(t);this.log.apply(this,n)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[pL.ERROR].concat(t);this.log.apply(this,n)}upload(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const n=[pL.DEBUG].concat(t);this.uploadLog.apply(this,n)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){XN("UPLOAD_LOG",!0)}disableLogUpload(){XN("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new lL(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if(Date.now()-fL<100)return void setTimeout((()=>{this.log(...t)}),Date.now()-fL);const n=Math.max(0,Math.min(4,t[0]));if(t[0]=hL()+" Agora-SDK [".concat(mL(n),"]:"),this.appendLogToWaitingList(n,...t),n<this.logLevel)return;const s=hL()+" %cAgora-SDK [".concat(mL(n),"]:");let r=[];if(!JN("USE_NEW_LOG"))switch(n){case pL.DEBUG:r=[s,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,r);break;case pL.INFO:r=[s,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,r);break;case pL.WARNING:r=[s,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,r);break;case pL.ERROR:r=[s,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,r)}}uploadLog(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if(Date.now()-fL<100)return void setTimeout((()=>{this.uploadLog(...t)}),Date.now()-fL);const n=Math.max(0,Math.min(4,t[0]));t[0]=hL()+" Agora-SDK [".concat(mL(n),"]:"),this.appendLogToWaitingList(n,...t)}appendLogToWaitingList(e){if(!JN("UPLOAD_LOG"))return;for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];Array.isArray(i[0])?i[0][0]=uL()+" Agora-SDK [".concat(mL(e),"]:"):i[0]=uL()+" Agora-SDK [".concat(mL(e),"]:");let s="";i.forEach((e=>{"object"==typeof e&&(e=JSON.stringify(e)),s+="".concat(e," ")})),this.uploadLogWaitingList.push({payload_str:s,log_level:e,log_item_id:this.currentLogID++}),"uploading"===this.uploadState&&0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",0===this.uploadLogUploadingList.length&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:KN,process_id:JN("PROCESS_ID"),payload:JSON.stringify(e)};return xN((async()=>{const e=await YD.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(JN("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(JN("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if("OK"!==e.data){const t=new Error("unexpected upload log response");throw t.response=e,t}}),(()=>(this.uploadLogUploadingList=[],!1)),(e=>(e.response?dL.reportLogUploadError({status:e.response.status,data:e.response.data,headers:e.response.headers,message:e.message}):e.request?dL.reportLogUploadError({status:e.request.status,message:e.message}):dL.reportLogUploadError({status:-1,message:e.message}),!0)),{timeout:JN("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:JN("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){0===this.uploadLogUploadingList.length&&0===this.uploadLogWaitingList.length||(0===this.uploadLogUploadingList.length&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,JN("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),JN("UPLOAD_LOG_INTERVAL"))})).catch((e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),JN("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),JN("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}};var _L;function gL(e){return DO(e.reportId,"params.reportId",0,100,!1),DO(e.category,"params.category",0,100,!1),DO(e.event,"params.event",0,100,!1),DO(e.label,"params.label",0,100,!1),bO(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(_L={}).FREE="free",_L.UPLOADING="uploading",function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"}({});const TL={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let SL=function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e}({}),vL=function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e}({});!function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"}({}),function(e){e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}({});class RL{constructor(){this.baseInfoMap=new Map,this.proxyServer=void 0,this.eventUploadTimer=void 0,this.setSessionIdTimer=void 0,this.url=void 0,this.backupUrl=void 0,this._appId=void 0,this.keyEventUploadPendingItems=[],this.normalEventUploadPendingItems=[],this.apiInvokeUploadPendingItems=[],this.apiInvokeCount=0,this.ltsList=[],this.lastSendNormalEventTime=Date.now(),this.customReportCounterTimer=void 0,this.customReportCount=0,this.extApiInvoke=async e=>{for(const t of e){const e=aL(aL({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:KO.TRACER});this.sendApiInvoke(e)}},this.eventUploadTimer=window.setInterval(this.doSend.bind(this),JN("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),JN("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}adjustSessionStartTime(e){if(!this.baseInfoMap.has(e)&&!this.baseInfoMap.get(e))return void EL.error("adjust session ".concat(e," start time, sid is not exist or info is undefined"));const t=this.baseInfoMap.get(e),i=Date.now(),n=t.startTime;t.startTime=i,EL.debug("rewrite session ".concat(e," startTime: ").concat(i," , ").concat(i-n,"ms")),this.baseInfoMap.set(e,t)}setAppId(e){this._appId=e}reportApiInvoke(e,t,i){t.timeout=t.timeout||6e4,t.reportResult=void 0===t.reportResult||t.reportResult;const n=Date.now();this.apiInvokeCount+=1;const s=this.apiInvokeCount,r=()=>({tag:t.tag,invokeId:s,sid:e,name:t.name,apiInvokeTime:n,options:t.options,states:t.states||null}),o=!!JN("SHOW_REPORT_INVOKER_LOG");o&&EL.info("".concat(t.name," start"),t.options);let a=!1;RN(t.timeout).then((()=>{a||(this.sendApiInvoke(aL(aL({},r()),{},{error:yO.API_INVOKE_TIMEOUT,success:!1})),EL.debug("".concat(t.name," timeout")))}));const c=new CO(yO.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:e=>{const n=()=>{if(a)throw c;return a=!0,this.sendApiInvoke(aL(aL({},r()),{},{success:!0},t.reportResult&&{result:e})),o&&EL.info("".concat(t.name," onSuccess")),e};return i?bN(n,t.name+"Success",i,(()=>a=!0)):n()},onError:e=>{const n=()=>{if(a)throw e;a=!0,this.sendApiInvoke(aL(aL({},r()),{},{success:!1,error:e})),o&&EL.info("".concat(t.name," onFailure"),e.toString())};return i?bN(n,t.name+"Error",i,(()=>a=!0)):n()}}}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const i=Date.now(),n=this.createBaseInfo(e,i);n.cname=t.cname;const s=Object.assign({},{willUploadConsoleLog:JN("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:YN?"global":"oversea",areas:JN("AREAS")&&JN("AREAS").join(",")},t.extend),{stringUid:r,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:l}=t,h=Date.now(),u=aL(aL({},n),{},{eventType:SL.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,build:$N,lts:h,elapse:h-i,extend:JSON.stringify(s),mode:t.mode,process:JN("PROCESS_ID"),appType:JN("APP_TYPE"),success:!0,version:KN,stringUid:r,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:d,clientType:20,clientRole:l,serviceId:JN("PROCESS_ID"),extensionID:JN("PLUGIN_INFO").join(",")||""});this.send({type:vL.SESSION,data:u},!0)}joinChooseServer(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL({},n),{},{eventType:SL.JOIN_CHOOSE_SERVER,lts:s,eventElapse:s-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:s-i.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3});this.send({type:vL.JOIN_CHOOSE_SERVER,data:r},!0)}reqUserAccount(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL({},n),{},{eventType:SL.REQ_USER_ACCOUNT,lts:s,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:s-i.startTime,eventElapse:s-t.lts,extend:JSON.stringify(t.extend)});this.send({type:vL.REQ_USER_ACCOUNT,data:r},!0)}joinGateway(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info;t.vid&&(n.vid=t.vid),n.uid=t.uid,n.cid=t.cid;const s=Date.now(),{firstSuccess:r,avoidJoinStartTime:o,isProxy:a,addr:c}=t,d=s-(r&&o?o:i.startTime),l=aL(aL({},n),{},{eventType:SL.JOIN_GATEWAY,lts:s,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,elapse:d,eventElapse:s-t.lts,firstSuccess:r,signalChannel:t.signalChannel}),h=l.success?1:0;if(t.succ&&(i.lastJoinSuccessTime=s),r)this.send({type:vL.JOIN_GATEWAY,data:l},!0);else{let e;if(c)if(a){const t=c.match(/h=(\d{1,3}-){3}\d{1,3}/g),i=c.match(/p=[0-9]{1,6}/g);e={isSuccess:h,gatewayIp:t&&t.length?t[0].split("=")[1].replace(/-/g,"."):"",port:i&&i.length?i[0].split("=")[1]:"",isProxy:a?1:0}}else{const t=c.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),i=c.match(/(:|p=)[0-9]{1,6}/g);e={isSuccess:h,gatewayIp:t&&t.length?t[0].split("//")[1].replace(/-/g,"."):"",port:i&&i.length?i[0].split(/:|p=/g)[1]:"",isProxy:a?1:0}}else e={isSuccess:h,gatewayIp:"",port:"",isProxy:a?1:0};delete l.success,delete l.eventType,delete l.firstSuccess,l.vid=Number(l.vid);const t=Object.assign({},l,e,{eventType:SL.REJOIN_GATEWAY});this.send({type:vL.RE_JOIN_GATEWAY,data:t},!0)}}joinChannelTimeout(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=Date.now(),s=aL(aL({},i.info),{},{lts:n,timeout:t,elapse:n-i.startTime});this.send({type:vL.JOIN_CHANNEL_TIMEOUT,data:s},!0)}publish(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL({},n),{},{eventType:SL.PUBLISH,lts:s,eventElapse:t.eventElapse,elapse:s-i.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:vL.PUBLISH,data:r},!0)}subscribe(e,t,i){const n=this.baseInfoMap.get(e);if(!n)return;const s=n.info,r=Date.now(),o=aL(aL({},s),{},{eventType:SL.SUBSCRIBE,lts:r,eventElapse:t.eventElapse,elapse:r-n.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});"string"==typeof t.peerid?o.peerSuid=t.peerid:o.peer=t.peerid,this.send({type:vL.SUBSCRIBE,data:o},!0)}wsCompressorInit(e){const t=[...this.baseInfoMap.keys()],i=t.length?t[0]:"UnableToGetSid",n=this.baseInfoMap.get(i);if(!n)return;const s=n.info,r=Date.now(),o=aL(aL({},s),{},{eventType:SL.WS_COMPRESSOR_INIT,lts:r,eventElapse:e.eventElapse,elapse:r-n.startTime,status:e.status?1:2});this.send({type:vL.WS_COMPRESSOR_INIT,data:o},!0)}firstRemoteVideoDecode(e,t,i,n){const s=this.baseInfoMap.get(e);if(!s)return;const r=s.info,o=Date.now(),a=aL(aL(aL({},r),n),{},{elapse:o-s.startTime,eventType:t,lts:o,firstDecodeFrame:Math.max(o-s.startTime,0),apEnd:Math.max(n.apEnd-s.startTime,0),apStart:Math.max(n.apStart-s.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-s.startTime,0),joinGwStart:Math.max(n.joinGwStart-s.startTime,0),pcEnd:Math.max(n.pcEnd-s.startTime,0),pcStart:Math.max(n.pcStart-s.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-s.startTime,0),subscriberStart:Math.max(n.subscriberStart-s.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-s.startTime,0)});this.send({type:i,data:a},!0)}firstRemoteFrame(e,t,i,n){const s=this.baseInfoMap.get(e);if(!s)return;const r=s.info,o=Date.now(),a=aL(aL(aL({},r),n),{},{elapse:o-s.startTime,eventType:t,lts:o});this.send({type:i,data:a},!0)}pcStats(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL(aL({},n),t),{},{vid:void 0===n.vid?0:Number(n.vid),elapse:s-i.startTime,eventType:SL.PC_STATS,lts:s});this.send({type:vL.PC_STATS,data:r},!0)}updateRemoteRTPCapabilities(e,t){if(e){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL(aL({},n),t),{},{vid:void 0===n.vid?0:Number(n.vid),eventType:SL.UPDATE_REMOTE_RTPCAPABILITIES,lts:s});this.send({type:vL.UPDATE_REMOTE_RTPCAPABILITIES,data:r},!0)}}onGatewayStream(e,t,i,n){const s=this.baseInfoMap.get(e);if(!s)return;const r=s.info,o=Date.now(),a=aL(aL(aL({},r),n),{},{eventType:t,lts:o});this.send({type:i,data:a},!0)}streamSwitch(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL({},n),{},{eventType:SL.STREAM_SWITCH,lts:s,isDual:t.isdual,elapse:s-i.startTime,success:t.succ});this.send({type:vL.STREAM_SWITCH,data:r},!0)}requestProxyAppCenter(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL({},n),{},{eventType:SL.REQUEST_PROXY_APPCENTER,lts:s,eventElapse:s-t.lts,elapse:s-i.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:vL.REQUEST_PROXY_APPCENTER,data:r},!0)}requestProxyWorkerManager(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL({},n),{},{eventType:SL.REQUEST_PROXY_WORKER_MANAGER,lts:s,eventElapse:s-t.lts,elapse:s-i.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:vL.REQUEST_PROXY_WORKER_MANAGER,data:r},!0)}setProxyServer(e){this.proxyServer=e,e?EL.debug("reportProxyServerurl: ".concat(e)):EL.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL({},n),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:s,elapse:s-i.startTime,joinChannelSuccessElapse:s-(i.lastJoinSuccessTime||s),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:vL.PEER_PUBLISH_STATUS,data:r},!0)}workerEvent(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now();(function(e,t,i){const n=e[t];if(!n||"string"!=typeof n)return[e];e[t]="";const s=TN(JSON.stringify(e));let r=0;const o=[];let a=0;for(let c=0;c<n.length;c++)a+=n.charCodeAt(c)<=127?1:3,a<=i-s||(o[o.length]=aN(aN({},e),{},{[t]:n.substring(r,c)}),r=c,a=n.charCodeAt(c)<=127?1:3);return r!==n.length-1&&(o[o.length]=aN(aN({},e),{},{[t]:n.substring(r)})),o})(aL(aL(aL({},n),t),{},{elapse:s-i.startTime,lts:s,productType:"WebRTC"}),"payload",1300).forEach((e=>this.send({type:vL.WORKER_EVENT,data:e},!0)))}apworkerEvent(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL(aL({},n),t),{},{elapse:s-i.startTime,lts:s});this.send({type:vL.AP_WORKER_EVENT,data:r},!0)}joinWebProxyAP(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL(aL({},n),t),{},{elapse:s-i.startTime,lts:s,extend:t.extend||void 0});this.send({type:vL.JOIN_WEB_PROXY_AP,data:r},!0)}WebSocketQuit(e,t){const i=this.baseInfoMap.get(e);if(!i)return;const n=i.info,s=Date.now(),r=aL(aL(aL({},n),t),{},{elapse:s-i.startTime,lts:s});this.send({type:vL.WEBSOCKET_QUIT,data:r},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>JN("CUSTOM_REPORT_LIMIT"))throw new CO(yO.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const i=Date.now(),n=t.map((t=>({type:vL.USER_ANALYTICS,data:aL(aL({sid:e},t),{},{lts:i})})));try{JN("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(e){throw EL.error("send custom report message failed",e.toString()),new CO(yO.CUSTOM_REPORT_SEND_FAILED,e.message)}}sendApiInvoke(e){const t=JN("NOT_REPORT_EVENT");if(e.tag&&t.includes&&t.includes(e.tag))return!1;if(null===e.sid)return this.apiInvokeUploadPendingItems.push(e),!1;const i=this.baseInfoMap.get(e.sid);if(!i)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:n,uid:s,cid:r}=i.info;let o;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof CO){const{code:t,message:i}=e.error;o=t||i||e.error.toString()}else o=e.error.toString();const a={invokeId:e.invokeId,sid:e.sid,cname:n,cid:r,uid:s,lts:e.lts,success:e.success,elapse:e.lts-i.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?o:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:vL.API_INVOKE,data:a},!1),!0}appendSessionId(){RL.__CLIENT_LIST__.forEach((e=>{if(e._sessionId){const t=this.apiInvokeUploadPendingItems.length;for(let i=0;i<t;i++){const t=this.apiInvokeUploadPendingItems.shift();t&&(t.sid=e._sessionId,this.sendApiInvoke(Object.assign({},t)))}}}))}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>JN("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const i=[],n=[];for(;e.length;){const t=e.shift();i.length<20?i.push(t):n.push(t)}e.push(...n);for(const e of[...i])-1!==this.ltsList.indexOf(e.data.lts)?(e.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(e.data.lts)):(this.ltsList.push(e.data.lts),this.ltsList.sort(((e,t)=>e-t)));return t||(this.lastSendNormalEventTime=Date.now()),JN("ENABLE_EVENT_REPORT")?(i.length&&(JN("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((e=>i=>{JN("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(e):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(e),this.normalEventUploadPendingItems.length>JN("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-JN("NORMAL_EVENT_QUEUE_CAPACITY")),EL.warning("report: drop normal events"))))})(i)),e):e}async postDataToStatsCollector2(e){rN.networkState===ZO.OFFLINE&&await Promise.race([rN.onlineWaiter,RN(2*MN.maxRetryTimeout)]);const t=e=>{let t=new Uint8Array;return e.forEach((e=>{const i=FO(JSON.stringify(e.data)),n=new ArrayBuffer(5),s=(e=>{let t=0;return Object.entries(vL).forEach((i=>{let[n,s]=i;s===e.type&&(t=EventNameToID[n])})),t})(e),r=new DataView(n);r.setUint16(0,i.byteLength,!0),r.setUint8(2,255&s),r.setUint8(3,s>>>8&255),r.setUint8(4,s>>>16&255),t=VO(t,new Uint8Array(n)),t=VO(t,i)})),t},i="event";let n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(JN("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(JN("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let s=0;s<2;s+=1){1===s&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(JN("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(JN("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await jN(n,{timeout:1e4,data:t(e),headers:aL(aL({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(e){if(1===s)throw e;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map((e=>JSON.stringify(e))),vid:(e=>{const t=e&&e.data.sid&&this.baseInfoMap.get(e.data.sid);return t&&t.info.vid&&+t.info.vid||0})(e[0])};rN.networkState===ZO.OFFLINE&&await Promise.race([rN.onlineWaiter,RN(2*MN.maxRetryTimeout)]);const n=t?"/events/proto-raws":"/events/messages";let s=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(JN("EVENT_REPORT_DOMAIN"),"&p=").concat(JN("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(JN("EVENT_REPORT_DOMAIN"),":").concat(JN("STATS_COLLECTOR_PORT")).concat(n));for(let e=0;e<2;e+=1){1===e&&(s=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(JN("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(JN("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(JN("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(JN("STATS_COLLECTOR_PORT")).concat(n)));try{t?await WN(s,{timeout:1e4,data:i}):await jN(s,{timeout:1e4,data:i})}catch(t){if(1===e)throw t;continue}return}}createBaseInfo(e,t){const i=Object.assign({},TL);return i.sid=e,this.baseInfoMap.set(e,{info:i,startTime:t}),i}reportResourceTiming(e,t){const i=performance.getEntriesByName(e),n=i[i.length-1];n&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:n,tag:KO.TRACER}).onSuccess()}}function yL(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function(t,i,n){const s=n.value;if("function"==typeof s){const r=e.className||t.__className__||("AgoraRTCClient"===t.constructor.name?"Client":t.constructor.name);n.value=function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];let a=n;if(e.argsMap)try{a=e.argsMap(this,...n)}catch(e){EL.warning(e),a=[]}try{JSON.stringify(a)}catch(e){EL.warning("arguments for method ".concat(r,".").concat(String(i)," not serializable for apiInvoke.")),a=[]}const c=(e.report||CL).reportApiInvoke(this._sessionId||null,{name:"".concat(r,".").concat(String(i)),options:a,tag:KO.TRACER,reportResult:e.reportResult},e.throttleTime);try{const t=s.apply(this,n);return t instanceof Promise?t.then((t=>(c.onSuccess(e.reportResult&&t),t))).catch((e=>{throw c.onError(e),e})):(c.onSuccess(e.reportResult&&t),t)}catch(e){throw c.onError(e),e}}}return n}}RL.__CLIENT_LIST__=[];const CL=new RL;dL.on("REPORT_LOG_UPLOAD",(e=>{e.networkState=rN.networkState,CL.reportApiInvoke(null,{name:"logUploadError",options:e,tag:KO.TRACER})}));let IL=!0,AL=!0;function bL(e,t,i){const n=e.match(t);return n&&n.length>=i&&parseInt(n[i],10)}function wL(e,t,i){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,s=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return s.apply(this,arguments);const r=e=>{const t=i(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,r),s.apply(this,[e,r])};const r=n.removeEventListener;n.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return r.apply(this,arguments);if(!this._eventMap[t].has(i))return r.apply(this,arguments);const n=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,r.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function DL(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(IL=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function OL(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(AL=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function NL(){if("object"==typeof window){if(IL)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function LL(e,t){AL&&console.warn(e+" is deprecated, please use "+t+" instead.")}function PL(e){return"[object Object]"===Object.prototype.toString.call(e)}function kL(e){return PL(e)?Object.keys(e).reduce((function(t,i){const n=PL(e[i]),s=n?kL(e[i]):e[i],r=n&&!Object.keys(s).length;return void 0===s||r?t:Object.assign(t,{[i]:s})}),{}):e}function ML(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((n=>{n.endsWith("Id")?ML(e,e.get(t[n]),i):n.endsWith("Ids")&&t[n].forEach((t=>{ML(e,e.get(t),i)}))})))}function UL(e,t,i){const n=i?"outbound-rtp":"inbound-rtp",s=new Map;if(null===t)return s;const r=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&r.push(e)})),r.forEach((t=>{e.forEach((i=>{i.type===n&&i.trackId===t.id&&ML(e,i,s)}))})),s}const xL=NL;function FL(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const n="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const s=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[s("min",i)]=n.ideal,t.optional.push(e),e={},e[s("max",i)]=n.ideal,t.optional.push(e)):(e[s("",i)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[s("",i)]=n.exact):["min","max"].forEach((e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[s(e,i)]=n[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,s){if(t.version>=61)return s(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"==typeof e.video){let r=e.video.facingMode;r=r&&("object"==typeof r?r:{ideal:r});const o=t.version<66;if(r&&("user"===r.exact||"environment"===r.exact||"user"===r.ideal||"environment"===r.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||o)){let t;if(delete e.video.facingMode,"environment"===r.exact||"environment"===r.ideal?t=["back","rear"]:"user"!==r.exact&&"user"!==r.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{let o=(i=i.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!o&&i.length&&t.includes("back")&&(o=i[i.length-1]),o&&(e.video.deviceId=r.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=n(e.video),xL("chrome: "+JSON.stringify(e)),s(e)}))}e.video=n(e.video)}return xL("chrome: "+JSON.stringify(e)),s(e)},r=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,n){s(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{n&&n(r(e))}))}))}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return s(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(r(e))))))}}}function VL(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function BL(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s)})),t.stream.getTracks().forEach((i=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const s=new Event("track");s.track=i,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else wL(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function GL(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let s=i.apply(this,arguments);return s||(s=t(this,e),this._senders.push(s)),s};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function jL(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const s=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},r=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const n=function(e){i(r(s(e)))};return t.apply(this,[n,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(r(s(t)))},i])})).then(i,n)}}function WL(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>UL(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),wL(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>UL(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,n;return this.getSenders().forEach((i=>{i.track===e&&(t?n=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?n=!0:i=t),t.track===e))),n||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function HL(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(n)&&this._shimmedLocalStreams[i.id].push(n):this._shimmedLocalStreams[i.id]=[i,n],n};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const n=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),s.apply(this,arguments)}}function KL(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return HL(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}n.apply(this,[t])};const s=e.RTCPeerConnection.prototype.removeStream;function r(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],s=e._streams[n.id];i=i.replace(new RegExp(s.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const s=this.getSenders().find((e=>e.track===t));if(s)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const r=this._streams[i.id];if(r)r.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const n=new e.MediaStream([t]);this._streams[i.id]=n,this._reverseStreams[n.id]=i,this.addStream(n)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=r(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>r(this,e)))}};e.RTCPeerConnection.prototype[t]=n[t]}));const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],s=e._streams[n.id];i=i.replace(new RegExp(n.id,"g"),s.id)})),new RTCSessionDescription({type:t.type,sdp:i})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=a.get.apply(this);return""===e.type?e:r(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function YL(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}))}function qL(e,t){wL(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}var $L=Object.freeze({__proto__:null,fixNegotiationNeeded:qL,shimAddTrackRemoveTrack:KL,shimAddTrackRemoveTrackWithNative:HL,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const n=i.video&&i.video.width,s=i.video&&i.video.height,r=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:r||3}},n&&(i.video.mandatory.maxWidth=n),s&&(i.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:GL,shimGetStats:jL,shimGetUserMedia:FL,shimMediaStream:VL,shimOnTrack:BL,shimPeerConnection:YL,shimSenderReceiverGetStats:WL});function zL(e,t){const i=e&&e.navigator,n=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,n){LL("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function XL(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function JL(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,s,r]=arguments;return n.apply(this,[e||null]).then((e=>{if(t.version<53&&!s)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,n)=>{e.set(n,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(s,r)}}function QL(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function ZL(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),wL(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function eP(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){LL("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function tP(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function iP(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const i=e.length>0;i&&e.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=t.apply(this,arguments);if(i){const{sender:t}=n,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return n})}function nP(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function sP(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function rP(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var oP=Object.freeze({__proto__:null,shimAddTransceiver:iP,shimCreateAnswer:rP,shimCreateOffer:sP,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:nP,shimGetUserMedia:zL,shimOnTrack:XL,shimPeerConnection:JL,shimRTCDataChannel:tP,shimReceiverGetStats:ZL,shimRemoveStream:eP,shimSenderGetStats:QL});function aP(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function cP(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function dP(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,n=t.createAnswer,s=t.setLocalDescription,r=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],s=i.apply(this,[n]);return t?(s.then(e,t),Promise.resolve()):s},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],s=n.apply(this,[i]);return t?(s.then(e,t),Promise.resolve()):s};let a=function(e,t,i){const n=s.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,i){const n=r.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,i){const n=o.apply(this,[e]);return i?(n.then(t,i),Promise.resolve()):n},t.addIceCandidate=a}function lP(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(hP(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,n){t.mediaDevices.getUserMedia(e).then(i,n)}.bind(t))}function hP(e){return e&&void 0!==e.video?Object.assign({},e,{video:kL(e.video)}):e}function uP(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let n=e.iceServers[i];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(LL("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function pP(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function fP(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function mP(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var EP=Object.freeze({__proto__:null,shimAudioContext:mP,shimCallbacksAPI:dP,shimConstraints:hP,shimCreateOfferLegacy:fP,shimGetUserMedia:lP,shimLocalStreamsAPI:aP,shimRTCIceServerUrls:uP,shimRemoteStreamsAPI:cP,shimTrackEventTransceiver:pP}),_P={exports:{}};!function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>0===e.indexOf(i)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":i.relatedAddress=t[e+1];break;case"rport":i.relatedPort=parseInt(t[e+1],10);break;case"tcptype":i.tcpType=t[e+1];break;case"ufrag":i.ufrag=t[e+1],i.usernameFragment=t[e+1];break;default:void 0===i[t[e]]&&(i[t[e]]=t[e+1])}return i},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let i;const n=e.substring(e.indexOf(" ")+1).split(";");for(let e=0;e<n.length;e++)i=n[e].trim().split("="),t[i[0].trim()]=i[1];return t},t.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const n=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+i+" "+n.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),i={ssrc:parseInt(e.substring(7,t),10)},n=e.indexOf(":",t);return n>-1?(i.attribute=e.substring(t+1,n),i.value=e.substring(n+1)):i.attribute=e.substring(t+1),i},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const n=t.matchPrefix(e+i,"a=ice-ufrag:")[0],s=t.matchPrefix(e+i,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substring(12),password:s.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" ");i.profile=n[2];for(let s=3;s<n.length;s++){const r=n[s],o=t.matchPrefix(e,"a=rtpmap:"+r+" ")[0];if(o){const n=t.parseRtpMap(o),s=t.matchPrefix(e,"a=fmtp:"+r+" ");switch(n.parameters=s.length?t.parseFmtp(s[0]):{},n.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+r+" ").map(t.parseRtcpFb),i.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(n.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e))}));const s=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach((e=>{s.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),i},t.writeRtpDescription=function(e,i){let n="";n+="m="+e+" ",n+=i.codecs.length>0?"9":"0",n+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",n+=i.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((e=>{n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e)}));let s=0;return i.codecs.forEach((e=>{e.maxptime>s&&(s=e.maxptime)})),s>0&&(n+="a=maxptime:"+s+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((e=>{n+=t.writeExtmap(e)})),n},t.parseRtpEncodingParameters=function(e){const i=[],n=t.parseRtpParameters(e),s=-1!==n.fecMechanisms.indexOf("RED"),r=-1!==n.fecMechanisms.indexOf("ULPFEC"),o=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=o.length>0&&o[0].ssrc;let c;const d=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));d.length>0&&d[0].length>1&&d[0][0]===a&&(c=d[0][1]),n.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),i.push(t),s&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:r?"red+ulpfec":"red"},i.push(t))}})),0===i.length&&a&&i.push({ssrc:a});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,i.forEach((e=>{e.maxBitrate=l}))),i},t.parseRtcpParameters=function(e){const i={},n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];n&&(i.cname=n.value,i.ssrc=n.ssrc);const s=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=0===s.length;const r=t.matchPrefix(e,"a=rtcp-mux");return i.mux=r.length>0,i},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let i;const n=t.matchPrefix(e,"a=msid:");if(1===n.length)return i=n[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return s.length>0?(i=s[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");let s;n.length>0&&(s=parseInt(n[0].substring(19),10)),isNaN(s)&&(s=65536);const r=t.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const o=t.matchPrefix(e,"a=sctpmap:");if(o.length>0){const e=o[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:s}}},t.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,i,n){let s;const r=void 0!==i?i:2;s=e||t.generateSessionId();return"v=0\r\no="+(n||"thisisadapterortc")+" "+s+" "+r+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,i){const n=t.splitLines(e);for(let e=0;e<n.length;e++)switch(n[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[e].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const i=t.splitLines(e)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const i=t.splitLines(e);for(let e=0;e<i.length;e++)if(i[e].length<2||"="!==i[e].charAt(1))return!1;return!0},e.exports=t}(_P);var gP=_P.exports,TP=n(gP),SP=t({__proto__:null,default:TP},[gP]);function vP(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),n=TP.parseCandidate(e.candidate),s=Object.assign(i,n);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,wL(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function RP(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||wL(e,"icecandidate",(e=>{if(e.candidate){const t=TP.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e}))}function yP(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(e){if(!e||!e.sdp)return!1;const t=TP.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=TP.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i},s=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i},r=function(e,i){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const s=TP.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?n=parseInt(s[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(n=2147483637),n},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const e=n(arguments[0]),t=s(e),i=r(arguments[0],e);let o;o=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a}return o.apply(this,arguments)}}function CP(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const n=arguments[0],s=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&s>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},wL(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function IP(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function AP(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function bP(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function wP(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return i.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>i.apply(this,[e])))})}var DP=Object.freeze({__proto__:null,removeExtmapAllowMixed:AP,shimAddIceCandidateNullOrEmpty:bP,shimConnectionState:IP,shimMaxMessageSize:yP,shimParameterlessSetLocalDescription:wP,shimRTCIceCandidate:vP,shimRTCIceCandidateRelayProtocol:RP,shimSendThrowTypeError:CP});!function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const i=NL,n=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=bL(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=bL(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=bL(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),s={browserDetails:n,commonShim:DP,extractVersion:bL,disableLog:DL,disableWarnings:OL,sdp:SP};switch(n.browser){case"chrome":if(!$L||!YL||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),s;if(null===n.version)return i("Chrome shim can not determine version, not shimming."),s;i("adapter.js shimming chrome."),s.browserShim=$L,bP(e,n),wP(e),FL(e,n),VL(e),YL(e,n),BL(e),KL(e,n),GL(e),jL(e),WL(e),qL(e,n),vP(e),RP(e),IP(e),yP(e,n),CP(e),AP(e,n);break;case"firefox":if(!oP||!JL||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),s;i("adapter.js shimming firefox."),s.browserShim=oP,bP(e,n),wP(e),zL(e,n),JL(e,n),XL(e),eP(e),QL(e),ZL(e),tP(e),iP(e),nP(e),sP(e),rP(e),vP(e),IP(e),yP(e,n),CP(e);break;case"safari":if(!EP||!t.shimSafari)return i("Safari shim is not included in this adapter release."),s;i("adapter.js shimming safari."),s.browserShim=EP,bP(e,n),wP(e),uP(e),fP(e),dP(e),aP(e),cP(e),pP(e),lP(e),mP(e),vP(e),RP(e),yP(e,n),CP(e),AP(e,n);break;default:i("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window}),
/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */
function(){var e;function t(e){var t=0;return function(){return t<e.length?{done:!1,value:e[t++]}:{done:!0}}}var n="function"==typeof Object.defineProperties?Object.defineProperty:function(e,t,i){return e==Array.prototype||e==Object.prototype||(e[t]=i.value),e};var s,r=function(e){e=["object"==typeof globalThis&&globalThis,e,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof i&&i];for(var t=0;t<e.length;++t){var n=e[t];if(n&&n.Math==Math)return n}throw Error("Cannot find global object")}(this);function o(e,t){if(t)e:{var i=r;e=e.split(".");for(var s=0;s<e.length-1;s++){var o=e[s];if(!(o in i))break e;i=i[o]}(t=t(s=i[e=e[e.length-1]]))!=s&&null!=t&&n(i,e,{configurable:!0,writable:!0,value:t})}}function a(e){return(e={next:e})[Symbol.iterator]=function(){return this},e}function c(e){var i="undefined"!=typeof Symbol&&Symbol.iterator&&e[Symbol.iterator];return i?i.call(e):{next:t(e)}}if(o("Symbol",(function(e){function t(e,t){this.A=e,n(this,"description",{configurable:!0,writable:!0,value:t})}if(e)return e;t.prototype.toString=function(){return this.A};var i="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",s=0;return function e(n){if(this instanceof e)throw new TypeError("Symbol is not a constructor");return new t(i+(n||"")+"_"+s++,n)}})),o("Symbol.iterator",(function(e){if(e)return e;e=Symbol("Symbol.iterator");for(var i="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),s=0;s<i.length;s++){var o=r[i[s]];"function"==typeof o&&"function"!=typeof o.prototype[e]&&n(o.prototype,e,{configurable:!0,writable:!0,value:function(){return a(t(this))}})}return e})),"function"==typeof Object.setPrototypeOf)s=Object.setPrototypeOf;else{var d;e:{var l={};try{l.__proto__={a:!0},d=l.a;break e}catch(e){}d=!1}s=d?function(e,t){if(e.__proto__=t,e.__proto__!==t)throw new TypeError(e+" is not extensible");return e}:null}var h=s;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function p(e){if(e.m)throw new TypeError("Generator is already running");e.m=!0}function f(e,t){return e.h=3,{value:t}}function m(e){this.g=new u,this.G=e}function E(e,t,i,n){try{var s=t.call(e.g.j,i);if(!(s instanceof Object))throw new TypeError("Iterator result "+s+" is not an object");if(!s.done)return e.g.m=!1,s;var r=s.value}catch(t){return e.g.j=null,e.g.s(t),_(e)}return e.g.j=null,n.call(e.g,r),_(e)}function _(e){for(;e.g.h;)try{var t=e.G(e.g);if(t)return e.g.m=!1,{value:t.value,done:!1}}catch(t){e.g.v=void 0,e.g.s(t)}if(e.g.m=!1,e.g.l){if(t=e.g.l,e.g.l=null,t.F)throw t.D;return{value:t.return,done:!0}}return{value:void 0,done:!0}}function g(e){this.next=function(t){return e.o(t)},this.throw=function(t){return e.s(t)},this.return=function(t){return function(e,t){p(e.g);var i=e.g.j;return i?E(e,"return"in i?i.return:function(e){return{value:e,done:!0}},t,e.g.return):(e.g.return(t),_(e))}(e,t)},this[Symbol.iterator]=function(){return this}}function T(e,t){return t=new g(new m(t)),h&&e.prototype&&h(t,e.prototype),t}if(u.prototype.o=function(e){this.v=e},u.prototype.s=function(e){this.l={D:e,F:!0},this.h=this.C||this.u},u.prototype.return=function(e){this.l={return:e},this.h=this.u},m.prototype.o=function(e){return p(this.g),this.g.j?E(this,this.g.j.next,e,this.g.o):(this.g.o(e),_(this))},m.prototype.s=function(e){return p(this.g),this.g.j?E(this,this.g.j.throw,e,this.g.o):(this.g.s(e),_(this))},o("Array.prototype.entries",(function(e){return e||function(){return function(e,t){e instanceof String&&(e+="");var i=0,n=!1,s={next:function(){if(!n&&i<e.length){var s=i++;return{value:t(s,e[s]),done:!1}}return n=!0,{done:!0,value:void 0}}};return s[Symbol.iterator]=function(){return s},s}(this,(function(e,t){return[e,t]}))}})),"undefined"!=typeof Blob&&("undefined"==typeof FormData||!FormData.prototype.keys)){var S=function(e,t){for(var i=0;i<e.length;i++)t(e[i])},v=function(e){return e.replace(/\r?\n|\r/g,"\r\n")},R=function(e,t,i){return t instanceof Blob?(i=void 0!==i?String(i+""):"string"==typeof t.name?t.name:"blob",t.name===i&&"[object Blob]"!==Object.prototype.toString.call(t)||(t=new File([t],i)),[String(e),t]):[String(e),String(t)]},y=function(e,t){if(e.length<t)throw new TypeError(t+" argument required, but only "+e.length+" present.")},C="object"==typeof globalThis?globalThis:"object"==typeof window?window:"object"==typeof self?self:this,I=C.FormData,A=C.XMLHttpRequest&&C.XMLHttpRequest.prototype.send,b=C.Request&&C.fetch,w=C.navigator&&C.navigator.sendBeacon,D=C.Element&&C.Element.prototype,O=C.Symbol&&Symbol.toStringTag;O&&(Blob.prototype[O]||(Blob.prototype[O]="Blob"),"File"in C&&!File.prototype[O]&&(File.prototype[O]="File"));try{new File([],"")}catch(e){C.File=function(e,t,i){return e=new Blob(e,i||{}),Object.defineProperties(e,{name:{value:t},lastModified:{value:+(i&&void 0!==i.lastModified?new Date(i.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),O&&Object.defineProperty(e,O,{value:"File"}),e}}var N=function(e){return e.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},L=function(e){this.i=[];var t=this;e&&S(e.elements,(function(e){if(e.name&&!e.disabled&&"submit"!==e.type&&"button"!==e.type&&!e.matches("form fieldset[disabled] *"))if("file"===e.type){var i=e.files&&e.files.length?e.files:[new File([],"",{type:"application/octet-stream"})];S(i,(function(i){t.append(e.name,i)}))}else"select-multiple"===e.type||"select-one"===e.type?S(e.options,(function(i){!i.disabled&&i.selected&&t.append(e.name,i.value)})):"checkbox"===e.type||"radio"===e.type?e.checked&&t.append(e.name,e.value):(i="textarea"===e.type?v(e.value):e.value,t.append(e.name,i))}))};if((e=L.prototype).append=function(e,t,i){y(arguments,2),this.i.push(R(e,t,i))},e.delete=function(e){y(arguments,1);var t=[];e=String(e),S(this.i,(function(i){i[0]!==e&&t.push(i)})),this.i=t},e.entries=function e(){var t,i=this;return T(e,(function(e){if(1==e.h&&(t=0),3!=e.h)return t<i.i.length?e=f(e,i.i[t]):(e.h=0,e=void 0),e;t++,e.h=2}))},e.forEach=function(e,t){y(arguments,1);for(var i=c(this),n=i.next();!n.done;n=i.next()){var s=c(n.value);n=s.next().value,s=s.next().value,e.call(t,s,n,this)}},e.get=function(e){y(arguments,1);var t=this.i;e=String(e);for(var i=0;i<t.length;i++)if(t[i][0]===e)return t[i][1];return null},e.getAll=function(e){y(arguments,1);var t=[];return e=String(e),S(this.i,(function(i){i[0]===e&&t.push(i[1])})),t},e.has=function(e){y(arguments,1),e=String(e);for(var t=0;t<this.i.length;t++)if(this.i[t][0]===e)return!0;return!1},e.keys=function e(){var t,i,n,s,r=this;return T(e,(function(e){if(1==e.h&&(t=c(r),i=t.next()),3!=e.h)return i.done?void(e.h=0):(n=i.value,s=c(n),f(e,s.next().value));i=t.next(),e.h=2}))},e.set=function(e,t,i){y(arguments,2),e=String(e);var n=[],s=R(e,t,i),r=!0;S(this.i,(function(t){t[0]===e?r&&(r=!n.push(s)):n.push(t)})),r&&n.push(s),this.i=n},e.values=function e(){var t,i,n,s,r=this;return T(e,(function(e){if(1==e.h&&(t=c(r),i=t.next()),3!=e.h)return i.done?void(e.h=0):(n=i.value,(s=c(n)).next(),f(e,s.next().value));i=t.next(),e.h=2}))},L.prototype._asNative=function(){for(var e=new I,t=c(this),i=t.next();!i.done;i=t.next()){var n=c(i.value);i=n.next().value,n=n.next().value,e.append(i,n)}return e},L.prototype._blob=function(){var e="----formdata-polyfill-"+Math.random(),t=[],i="--"+e+'\r\nContent-Disposition: form-data; name="';return this.forEach((function(e,n){return"string"==typeof e?t.push(i+N(v(n))+'"\r\n\r\n'+v(e)+"\r\n"):t.push(i+N(v(n))+'"; filename="'+N(e.name)+'"\r\nContent-Type: '+(e.type||"application/octet-stream")+"\r\n\r\n",e,"\r\n")})),t.push("--"+e+"--"),new Blob(t,{type:"multipart/form-data; boundary="+e})},L.prototype[Symbol.iterator]=function(){return this.entries()},L.prototype.toString=function(){return"[object FormData]"},D&&!D.matches&&(D.matches=D.matchesSelector||D.mozMatchesSelector||D.msMatchesSelector||D.oMatchesSelector||D.webkitMatchesSelector||function(e){for(var t=(e=(this.document||this.ownerDocument).querySelectorAll(e)).length;0<=--t&&e.item(t)!==this;);return-1<t}),O&&(L.prototype[O]="FormData"),A){var P=C.XMLHttpRequest.prototype.setRequestHeader;C.XMLHttpRequest.prototype.setRequestHeader=function(e,t){P.call(this,e,t),"content-type"===e.toLowerCase()&&(this.B=!0)},C.XMLHttpRequest.prototype.send=function(e){e instanceof L?(e=e._blob(),this.B||this.setRequestHeader("Content-Type",e.type),A.call(this,e)):A.call(this,e)}}b&&(C.fetch=function(e,t){return t&&t.body&&t.body instanceof L&&(t.body=t.body._blob()),b.call(this,e,t)}),w&&(C.navigator.sendBeacon=function(e,t){return t instanceof L&&(t=t._asNative()),w.call(this,e,t)}),C.FormData=L}}();function OP(e){let t=e.length;for(;--t>=0;)e[t]=0}const NP=256,LP=286,PP=30,kP=15,MP=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),UP=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),xP=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),FP=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),VP=new Array(576);OP(VP);const BP=new Array(60);OP(BP);const GP=new Array(512);OP(GP);const jP=new Array(256);OP(jP);const WP=new Array(29);OP(WP);const HP=new Array(PP);function KP(e,t,i,n,s){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=n,this.max_length=s,this.has_stree=e&&e.length}let YP,qP,$P;function zP(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}OP(HP);const XP=e=>e<256?GP[e]:GP[256+(e>>>7)],JP=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},QP=(e,t,i)=>{e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,JP(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)},ZP=(e,t,i)=>{QP(e,i[2*t],i[2*t+1])},ek=(e,t)=>{let i=0;do{i|=1&e,e>>>=1,i<<=1}while(--t>0);return i>>>1},tk=(e,t,i)=>{const n=new Array(16);let s,r,o=0;for(s=1;s<=kP;s++)o=o+i[s-1]<<1,n[s]=o;for(r=0;r<=t;r++){let t=e[2*r+1];0!==t&&(e[2*r]=ek(n[t]++,t))}},ik=e=>{let t;for(t=0;t<LP;t++)e.dyn_ltree[2*t]=0;for(t=0;t<PP;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},nk=e=>{e.bi_valid>8?JP(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},sk=(e,t,i,n)=>{const s=2*t,r=2*i;return e[s]<e[r]||e[s]===e[r]&&n[t]<=n[i]},rk=(e,t,i)=>{const n=e.heap[i];let s=i<<1;for(;s<=e.heap_len&&(s<e.heap_len&&sk(t,e.heap[s+1],e.heap[s],e.depth)&&s++,!sk(t,n,e.heap[s],e.depth));)e.heap[i]=e.heap[s],i=s,s<<=1;e.heap[i]=n},ok=(e,t,i)=>{let n,s,r,o,a=0;if(0!==e.sym_next)do{n=255&e.pending_buf[e.sym_buf+a++],n+=(255&e.pending_buf[e.sym_buf+a++])<<8,s=e.pending_buf[e.sym_buf+a++],0===n?ZP(e,s,t):(r=jP[s],ZP(e,r+NP+1,t),o=MP[r],0!==o&&(s-=WP[r],QP(e,s,o)),n--,r=XP(n),ZP(e,r,i),o=UP[r],0!==o&&(n-=HP[r],QP(e,n,o)))}while(a<e.sym_next);ZP(e,256,t)},ak=(e,t)=>{const i=t.dyn_tree,n=t.stat_desc.static_tree,s=t.stat_desc.has_stree,r=t.stat_desc.elems;let o,a,c,d=-1;for(e.heap_len=0,e.heap_max=573,o=0;o<r;o++)0!==i[2*o]?(e.heap[++e.heap_len]=d=o,e.depth[o]=0):i[2*o+1]=0;for(;e.heap_len<2;)c=e.heap[++e.heap_len]=d<2?++d:0,i[2*c]=1,e.depth[c]=0,e.opt_len--,s&&(e.static_len-=n[2*c+1]);for(t.max_code=d,o=e.heap_len>>1;o>=1;o--)rk(e,i,o);c=r;do{o=e.heap[1],e.heap[1]=e.heap[e.heap_len--],rk(e,i,1),a=e.heap[1],e.heap[--e.heap_max]=o,e.heap[--e.heap_max]=a,i[2*c]=i[2*o]+i[2*a],e.depth[c]=(e.depth[o]>=e.depth[a]?e.depth[o]:e.depth[a])+1,i[2*o+1]=i[2*a+1]=c,e.heap[1]=c++,rk(e,i,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((e,t)=>{const i=t.dyn_tree,n=t.max_code,s=t.stat_desc.static_tree,r=t.stat_desc.has_stree,o=t.stat_desc.extra_bits,a=t.stat_desc.extra_base,c=t.stat_desc.max_length;let d,l,h,u,p,f,m=0;for(u=0;u<=kP;u++)e.bl_count[u]=0;for(i[2*e.heap[e.heap_max]+1]=0,d=e.heap_max+1;d<573;d++)l=e.heap[d],u=i[2*i[2*l+1]+1]+1,u>c&&(u=c,m++),i[2*l+1]=u,l>n||(e.bl_count[u]++,p=0,l>=a&&(p=o[l-a]),f=i[2*l],e.opt_len+=f*(u+p),r&&(e.static_len+=f*(s[2*l+1]+p)));if(0!==m){do{for(u=c-1;0===e.bl_count[u];)u--;e.bl_count[u]--,e.bl_count[u+1]+=2,e.bl_count[c]--,m-=2}while(m>0);for(u=c;0!==u;u--)for(l=e.bl_count[u];0!==l;)h=e.heap[--d],h>n||(i[2*h+1]!==u&&(e.opt_len+=(u-i[2*h+1])*i[2*h],i[2*h+1]=u),l--)}})(e,t),tk(i,d,e.bl_count)},ck=(e,t,i)=>{let n,s,r=-1,o=t[1],a=0,c=7,d=4;for(0===o&&(c=138,d=3),t[2*(i+1)+1]=65535,n=0;n<=i;n++)s=o,o=t[2*(n+1)+1],++a<c&&s===o||(a<d?e.bl_tree[2*s]+=a:0!==s?(s!==r&&e.bl_tree[2*s]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,r=s,0===o?(c=138,d=3):s===o?(c=6,d=3):(c=7,d=4))},dk=(e,t,i)=>{let n,s,r=-1,o=t[1],a=0,c=7,d=4;for(0===o&&(c=138,d=3),n=0;n<=i;n++)if(s=o,o=t[2*(n+1)+1],!(++a<c&&s===o)){if(a<d)do{ZP(e,s,e.bl_tree)}while(0!=--a);else 0!==s?(s!==r&&(ZP(e,s,e.bl_tree),a--),ZP(e,16,e.bl_tree),QP(e,a-3,2)):a<=10?(ZP(e,17,e.bl_tree),QP(e,a-3,3)):(ZP(e,18,e.bl_tree),QP(e,a-11,7));a=0,r=s,0===o?(c=138,d=3):s===o?(c=6,d=3):(c=7,d=4)}};let lk=!1;const hk=(e,t,i,n)=>{QP(e,0+(n?1:0),3),nk(e),JP(e,i),JP(e,~i),i&&e.pending_buf.set(e.window.subarray(t,t+i),e.pending),e.pending+=i};var uk=e=>{lk||((()=>{let e,t,i,n,s;const r=new Array(16);for(i=0,n=0;n<28;n++)for(WP[n]=i,e=0;e<1<<MP[n];e++)jP[i++]=n;for(jP[i-1]=n,s=0,n=0;n<16;n++)for(HP[n]=s,e=0;e<1<<UP[n];e++)GP[s++]=n;for(s>>=7;n<PP;n++)for(HP[n]=s<<7,e=0;e<1<<UP[n]-7;e++)GP[256+s++]=n;for(t=0;t<=kP;t++)r[t]=0;for(e=0;e<=143;)VP[2*e+1]=8,e++,r[8]++;for(;e<=255;)VP[2*e+1]=9,e++,r[9]++;for(;e<=279;)VP[2*e+1]=7,e++,r[7]++;for(;e<=287;)VP[2*e+1]=8,e++,r[8]++;for(tk(VP,287,r),e=0;e<PP;e++)BP[2*e+1]=5,BP[2*e]=ek(e,5);YP=new KP(VP,MP,257,LP,kP),qP=new KP(BP,UP,0,PP,kP),$P=new KP(new Array(0),xP,0,19,7)})(),lk=!0),e.l_desc=new zP(e.dyn_ltree,YP),e.d_desc=new zP(e.dyn_dtree,qP),e.bl_desc=new zP(e.bl_tree,$P),e.bi_buf=0,e.bi_valid=0,ik(e)},pk=(e,t,i,n)=>{let s,r,o=0;e.level>0?(2===e.strm.data_type&&(e.strm.data_type=(e=>{let t,i=4093624447;for(t=0;t<=31;t++,i>>>=1)if(1&i&&0!==e.dyn_ltree[2*t])return 0;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return 1;for(t=32;t<NP;t++)if(0!==e.dyn_ltree[2*t])return 1;return 0})(e)),ak(e,e.l_desc),ak(e,e.d_desc),o=(e=>{let t;for(ck(e,e.dyn_ltree,e.l_desc.max_code),ck(e,e.dyn_dtree,e.d_desc.max_code),ak(e,e.bl_desc),t=18;t>=3&&0===e.bl_tree[2*FP[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t})(e),s=e.opt_len+3+7>>>3,r=e.static_len+3+7>>>3,r<=s&&(s=r)):s=r=i+5,i+4<=s&&-1!==t?hk(e,t,i,n):4===e.strategy||r===s?(QP(e,2+(n?1:0),3),ok(e,VP,BP)):(QP(e,4+(n?1:0),3),((e,t,i,n)=>{let s;for(QP(e,t-257,5),QP(e,i-1,5),QP(e,n-4,4),s=0;s<n;s++)QP(e,e.bl_tree[2*FP[s]+1],3);dk(e,e.dyn_ltree,t-1),dk(e,e.dyn_dtree,i-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),ok(e,e.dyn_ltree,e.dyn_dtree)),ik(e),n&&nk(e)},fk=(e,t,i)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=i,0===t?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(jP[i]+NP+1)]++,e.dyn_dtree[2*XP(t)]++),e.sym_next===e.sym_end),mk=e=>{QP(e,2,3),ZP(e,256,VP),(e=>{16===e.bi_valid?(JP(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(e)},Ek={_tr_init:uk,_tr_stored_block:hk,_tr_flush_block:pk,_tr_tally:fk,_tr_align:mk};var _k=(e,t,i,n)=>{let s=65535&e|0,r=e>>>16&65535|0,o=0;for(;0!==i;){o=i>2e3?2e3:i,i-=o;do{s=s+t[n++]|0,r=r+s|0}while(--o);s%=65521,r%=65521}return s|r<<16|0};const gk=new Uint32Array((()=>{let e,t=[];for(var i=0;i<256;i++){e=i;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t})());var Tk=(e,t,i,n)=>{const s=gk,r=n+i;e^=-1;for(let i=n;i<r;i++)e=e>>>8^s[255&(e^t[i])];return-1^e},Sk={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},vk={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Rk,_tr_stored_block:yk,_tr_flush_block:Ck,_tr_tally:Ik,_tr_align:Ak}=Ek,{Z_NO_FLUSH:bk,Z_PARTIAL_FLUSH:wk,Z_FULL_FLUSH:Dk,Z_FINISH:Ok,Z_BLOCK:Nk,Z_OK:Lk,Z_STREAM_END:Pk,Z_STREAM_ERROR:kk,Z_DATA_ERROR:Mk,Z_BUF_ERROR:Uk,Z_DEFAULT_COMPRESSION:xk,Z_FILTERED:Fk,Z_HUFFMAN_ONLY:Vk,Z_RLE:Bk,Z_FIXED:Gk,Z_DEFAULT_STRATEGY:jk,Z_UNKNOWN:Wk,Z_DEFLATED:Hk}=vk,Kk=286,Yk=30,qk=19,$k=2*Kk+1,zk=15,Xk=258,Jk=262,Qk=42,Zk=113,eM=666,tM=(e,t)=>(e.msg=Sk[t],t),iM=e=>2*e-(e>4?9:0),nM=e=>{let t=e.length;for(;--t>=0;)e[t]=0},sM=e=>{let t,i,n,s=e.w_size;t=e.hash_size,n=t;do{i=e.head[--n],e.head[n]=i>=s?i-s:0}while(--t);t=s,n=t;do{i=e.prev[--n],e.prev[n]=i>=s?i-s:0}while(--t)};let rM=(e,t,i)=>(t<<e.hash_shift^i)&e.hash_mask;const oM=e=>{const t=e.state;let i=t.pending;i>e.avail_out&&(i=e.avail_out),0!==i&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+i),e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,0===t.pending&&(t.pending_out=0))},aM=(e,t)=>{Ck(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,oM(e.strm)},cM=(e,t)=>{e.pending_buf[e.pending++]=t},dM=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},lM=(e,t,i,n)=>{let s=e.avail_in;return s>n&&(s=n),0===s?0:(e.avail_in-=s,t.set(e.input.subarray(e.next_in,e.next_in+s),i),1===e.state.wrap?e.adler=_k(e.adler,t,s,i):2===e.state.wrap&&(e.adler=Tk(e.adler,t,s,i)),e.next_in+=s,e.total_in+=s,s)},hM=(e,t)=>{let i,n,s=e.max_chain_length,r=e.strstart,o=e.prev_length,a=e.nice_match;const c=e.strstart>e.w_size-Jk?e.strstart-(e.w_size-Jk):0,d=e.window,l=e.w_mask,h=e.prev,u=e.strstart+Xk;let p=d[r+o-1],f=d[r+o];e.prev_length>=e.good_match&&(s>>=2),a>e.lookahead&&(a=e.lookahead);do{if(i=t,d[i+o]===f&&d[i+o-1]===p&&d[i]===d[r]&&d[++i]===d[r+1]){r+=2,i++;do{}while(d[++r]===d[++i]&&d[++r]===d[++i]&&d[++r]===d[++i]&&d[++r]===d[++i]&&d[++r]===d[++i]&&d[++r]===d[++i]&&d[++r]===d[++i]&&d[++r]===d[++i]&&r<u);if(n=Xk-(u-r),r=u-Xk,n>o){if(e.match_start=t,o=n,n>=a)break;p=d[r+o-1],f=d[r+o]}}}while((t=h[t&l])>c&&0!=--s);return o<=e.lookahead?o:e.lookahead},uM=e=>{const t=e.w_size;let i,n,s;do{if(n=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-Jk)&&(e.window.set(e.window.subarray(t,t+t-n),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),sM(e),n+=t),0===e.strm.avail_in)break;if(i=lM(e.strm,e.window,e.strstart+e.lookahead,n),e.lookahead+=i,e.lookahead+e.insert>=3)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=rM(e,e.ins_h,e.window[s+1]);e.insert&&(e.ins_h=rM(e,e.ins_h,e.window[s+3-1]),e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Jk&&0!==e.strm.avail_in)},pM=(e,t)=>{let i,n,s,r=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o=0,a=e.strm.avail_in;do{if(i=65535,s=e.bi_valid+42>>3,e.strm.avail_out<s)break;if(s=e.strm.avail_out-s,n=e.strstart-e.block_start,i>n+e.strm.avail_in&&(i=n+e.strm.avail_in),i>s&&(i=s),i<r&&(0===i&&t!==Ok||t===bk||i!==n+e.strm.avail_in))break;o=t===Ok&&i===n+e.strm.avail_in?1:0,yk(e,0,0,o),e.pending_buf[e.pending-4]=i,e.pending_buf[e.pending-3]=i>>8,e.pending_buf[e.pending-2]=~i,e.pending_buf[e.pending-1]=~i>>8,oM(e.strm),n&&(n>i&&(n=i),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+n),e.strm.next_out),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n,e.block_start+=n,i-=n),i&&(lM(e.strm,e.strm.output,e.strm.next_out,i),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i)}while(0===o);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),o?4:t!==bk&&t!==Ok&&0===e.strm.avail_in&&e.strstart===e.block_start?2:(s=e.window_size-e.strstart,e.strm.avail_in>s&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,s+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),s>e.strm.avail_in&&(s=e.strm.avail_in),s&&(lM(e.strm,e.window,e.strstart,s),e.strstart+=s,e.insert+=s>e.w_size-e.insert?e.w_size-e.insert:s),e.high_water<e.strstart&&(e.high_water=e.strstart),s=e.bi_valid+42>>3,s=e.pending_buf_size-s>65535?65535:e.pending_buf_size-s,r=s>e.w_size?e.w_size:s,n=e.strstart-e.block_start,(n>=r||(n||t===Ok)&&t!==bk&&0===e.strm.avail_in&&n<=s)&&(i=n>s?s:n,o=t===Ok&&0===e.strm.avail_in&&i===n?1:0,yk(e,e.block_start,i,o),e.block_start+=i,oM(e.strm)),o?3:1)},fM=(e,t)=>{let i,n;for(;;){if(e.lookahead<Jk){if(uM(e),e.lookahead<Jk&&t===bk)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=rM(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==i&&e.strstart-i<=e.w_size-Jk&&(e.match_length=hM(e,i)),e.match_length>=3)if(n=Ik(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do{e.strstart++,e.ins_h=rM(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=rM(e,e.ins_h,e.window[e.strstart+1]);else n=Ik(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(aM(e,!1),0===e.strm.avail_out))return 1}return e.insert=e.strstart<2?e.strstart:2,t===Ok?(aM(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(aM(e,!1),0===e.strm.avail_out)?1:2},mM=(e,t)=>{let i,n,s;for(;;){if(e.lookahead<Jk){if(uM(e),e.lookahead<Jk&&t===bk)return 1;if(0===e.lookahead)break}if(i=0,e.lookahead>=3&&(e.ins_h=rM(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,0!==i&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-Jk&&(e.match_length=hM(e,i),e.match_length<=5&&(e.strategy===Fk||3===e.match_length&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){s=e.strstart+e.lookahead-3,n=Ik(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=s&&(e.ins_h=rM(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=2,e.strstart++,n&&(aM(e,!1),0===e.strm.avail_out))return 1}else if(e.match_available){if(n=Ik(e,0,e.window[e.strstart-1]),n&&aM(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=Ik(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===Ok?(aM(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(aM(e,!1),0===e.strm.avail_out)?1:2};function EM(e,t,i,n,s){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=n,this.func=s}const _M=[new EM(0,0,0,0,pM),new EM(4,4,8,4,fM),new EM(4,5,16,8,fM),new EM(4,6,32,32,fM),new EM(4,4,16,16,mM),new EM(8,16,32,32,mM),new EM(8,16,128,128,mM),new EM(8,32,128,256,mM),new EM(32,128,258,1024,mM),new EM(32,258,258,4096,mM)];function gM(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Hk,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*$k),this.dyn_dtree=new Uint16Array(2*(2*Yk+1)),this.bl_tree=new Uint16Array(2*(2*qk+1)),nM(this.dyn_ltree),nM(this.dyn_dtree),nM(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(zk+1),this.heap=new Uint16Array(2*Kk+1),nM(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Kk+1),nM(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const TM=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Qk&&57!==t.status&&69!==t.status&&73!==t.status&&91!==t.status&&103!==t.status&&t.status!==Zk&&t.status!==eM?1:0},SM=e=>{if(TM(e))return tM(e,kk);e.total_in=e.total_out=0,e.data_type=Wk;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=2===t.wrap?57:t.wrap?Qk:Zk,e.adler=2===t.wrap?0:1,t.last_flush=-2,Rk(t),Lk},vM=e=>{const t=SM(e);return t===Lk&&(e=>{e.window_size=2*e.w_size,nM(e.head),e.max_lazy_match=_M[e.level].max_lazy,e.good_match=_M[e.level].good_length,e.nice_match=_M[e.level].nice_length,e.max_chain_length=_M[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=2,e.match_available=0,e.ins_h=0})(e.state),t},RM=(e,t,i,n,s,r)=>{if(!e)return kk;let o=1;if(t===xk&&(t=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),s<1||s>9||i!==Hk||n<8||n>15||t<0||t>9||r<0||r>Gk||8===n&&1!==o)return tM(e,kk);8===n&&(n=9);const a=new gM;return e.state=a,a.strm=e,a.status=Qk,a.wrap=o,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=s+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<s+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=r,a.method=i,vM(e)};var yM=(e,t)=>{if(TM(e)||t>Nk||t<0)return e?tM(e,kk):kk;const i=e.state;if(!e.output||0!==e.avail_in&&!e.input||i.status===eM&&t!==Ok)return tM(e,0===e.avail_out?Uk:kk);const n=i.last_flush;if(i.last_flush=t,0!==i.pending){if(oM(e),0===e.avail_out)return i.last_flush=-1,Lk}else if(0===e.avail_in&&iM(t)<=iM(n)&&t!==Ok)return tM(e,Uk);if(i.status===eM&&0!==e.avail_in)return tM(e,Uk);if(i.status===Qk&&0===i.wrap&&(i.status=Zk),i.status===Qk){let t=Hk+(i.w_bits-8<<4)<<8,n=-1;if(n=i.strategy>=Vk||i.level<2?0:i.level<6?1:6===i.level?2:3,t|=n<<6,0!==i.strstart&&(t|=32),t+=31-t%31,dM(i,t),0!==i.strstart&&(dM(i,e.adler>>>16),dM(i,65535&e.adler)),e.adler=1,i.status=Zk,oM(e),0!==i.pending)return i.last_flush=-1,Lk}if(57===i.status)if(e.adler=0,cM(i,31),cM(i,139),cM(i,8),i.gzhead)cM(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),cM(i,255&i.gzhead.time),cM(i,i.gzhead.time>>8&255),cM(i,i.gzhead.time>>16&255),cM(i,i.gzhead.time>>24&255),cM(i,9===i.level?2:i.strategy>=Vk||i.level<2?4:0),cM(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(cM(i,255&i.gzhead.extra.length),cM(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=Tk(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(cM(i,0),cM(i,0),cM(i,0),cM(i,0),cM(i,0),cM(i,9===i.level?2:i.strategy>=Vk||i.level<2?4:0),cM(i,3),i.status=Zk,oM(e),0!==i.pending)return i.last_flush=-1,Lk;if(69===i.status){if(i.gzhead.extra){let t=i.pending,n=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+n>i.pending_buf_size;){let s=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+s),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>t&&(e.adler=Tk(e.adler,i.pending_buf,i.pending-t,t)),i.gzindex+=s,oM(e),0!==i.pending)return i.last_flush=-1,Lk;t=0,n-=s}let s=new Uint8Array(i.gzhead.extra);i.pending_buf.set(s.subarray(i.gzindex,i.gzindex+n),i.pending),i.pending+=n,i.gzhead.hcrc&&i.pending>t&&(e.adler=Tk(e.adler,i.pending_buf,i.pending-t,t)),i.gzindex=0}i.status=73}if(73===i.status){if(i.gzhead.name){let t,n=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>n&&(e.adler=Tk(e.adler,i.pending_buf,i.pending-n,n)),oM(e),0!==i.pending)return i.last_flush=-1,Lk;n=0}t=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,cM(i,t)}while(0!==t);i.gzhead.hcrc&&i.pending>n&&(e.adler=Tk(e.adler,i.pending_buf,i.pending-n,n)),i.gzindex=0}i.status=91}if(91===i.status){if(i.gzhead.comment){let t,n=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>n&&(e.adler=Tk(e.adler,i.pending_buf,i.pending-n,n)),oM(e),0!==i.pending)return i.last_flush=-1,Lk;n=0}t=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,cM(i,t)}while(0!==t);i.gzhead.hcrc&&i.pending>n&&(e.adler=Tk(e.adler,i.pending_buf,i.pending-n,n))}i.status=103}if(103===i.status){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(oM(e),0!==i.pending))return i.last_flush=-1,Lk;cM(i,255&e.adler),cM(i,e.adler>>8&255),e.adler=0}if(i.status=Zk,oM(e),0!==i.pending)return i.last_flush=-1,Lk}if(0!==e.avail_in||0!==i.lookahead||t!==bk&&i.status!==eM){let n=0===i.level?pM(i,t):i.strategy===Vk?((e,t)=>{let i;for(;;){if(0===e.lookahead&&(uM(e),0===e.lookahead)){if(t===bk)return 1;break}if(e.match_length=0,i=Ik(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,i&&(aM(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===Ok?(aM(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(aM(e,!1),0===e.strm.avail_out)?1:2})(i,t):i.strategy===Bk?((e,t)=>{let i,n,s,r;const o=e.window;for(;;){if(e.lookahead<=Xk){if(uM(e),e.lookahead<=Xk&&t===bk)return 1;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=3&&e.strstart>0&&(s=e.strstart-1,n=o[s],n===o[++s]&&n===o[++s]&&n===o[++s])){r=e.strstart+Xk;do{}while(n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&n===o[++s]&&s<r);e.match_length=Xk-(r-s),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=3?(i=Ik(e,1,e.match_length-3),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(i=Ik(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),i&&(aM(e,!1),0===e.strm.avail_out))return 1}return e.insert=0,t===Ok?(aM(e,!0),0===e.strm.avail_out?3:4):e.sym_next&&(aM(e,!1),0===e.strm.avail_out)?1:2})(i,t):_M[i.level].func(i,t);if(3!==n&&4!==n||(i.status=eM),1===n||3===n)return 0===e.avail_out&&(i.last_flush=-1),Lk;if(2===n&&(t===wk?Ak(i):t!==Nk&&(yk(i,0,0,!1),t===Dk&&(nM(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),oM(e),0===e.avail_out))return i.last_flush=-1,Lk}return t!==Ok?Lk:i.wrap<=0?Pk:(2===i.wrap?(cM(i,255&e.adler),cM(i,e.adler>>8&255),cM(i,e.adler>>16&255),cM(i,e.adler>>24&255),cM(i,255&e.total_in),cM(i,e.total_in>>8&255),cM(i,e.total_in>>16&255),cM(i,e.total_in>>24&255)):(dM(i,e.adler>>>16),dM(i,65535&e.adler)),oM(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?Lk:Pk)},CM=(e,t)=>{let i=t.length;if(TM(e))return kk;const n=e.state,s=n.wrap;if(2===s||1===s&&n.status!==Qk||n.lookahead)return kk;if(1===s&&(e.adler=_k(e.adler,t,i,0)),n.wrap=0,i>=n.w_size){0===s&&(nM(n.head),n.strstart=0,n.block_start=0,n.insert=0);let e=new Uint8Array(n.w_size);e.set(t.subarray(i-n.w_size,i),0),t=e,i=n.w_size}const r=e.avail_in,o=e.next_in,a=e.input;for(e.avail_in=i,e.next_in=0,e.input=t,uM(n);n.lookahead>=3;){let e=n.strstart,t=n.lookahead-2;do{n.ins_h=rM(n,n.ins_h,n.window[e+3-1]),n.prev[e&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=e,e++}while(--t);n.strstart=e,n.lookahead=2,uM(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,e.next_in=o,e.input=a,e.avail_in=r,n.wrap=s,Lk},IM={deflateInit:(e,t)=>RM(e,t,Hk,15,8,jk),deflateInit2:RM,deflateReset:vM,deflateResetKeep:SM,deflateSetHeader:(e,t)=>TM(e)||2!==e.state.wrap?kk:(e.state.gzhead=t,Lk),deflate:yM,deflateEnd:e=>{if(TM(e))return kk;const t=e.state.status;return e.state=null,t===Zk?tM(e,Mk):Lk},deflateSetDictionary:CM,deflateInfo:"pako deflate (from Nodeca project)"};const AM=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var bM={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const i=t.shift();if(i){if("object"!=typeof i)throw new TypeError(i+"must be non-object");for(const t in i)AM(i,t)&&(e[t]=i[t])}}return e},flattenChunks:e=>{let t=0;for(let i=0,n=e.length;i<n;i++)t+=e[i].length;const i=new Uint8Array(t);for(let t=0,n=0,s=e.length;t<s;t++){let s=e[t];i.set(s,n),n+=s.length}return i}};let wM=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){wM=!1}const DM=new Uint8Array(256);for(let e=0;e<256;e++)DM[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;DM[254]=DM[254]=1;var OM={string2buf:e=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(e);let t,i,n,s,r,o=e.length,a=0;for(s=0;s<o;s++)i=e.charCodeAt(s),55296==(64512&i)&&s+1<o&&(n=e.charCodeAt(s+1),56320==(64512&n)&&(i=65536+(i-55296<<10)+(n-56320),s++)),a+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(a),r=0,s=0;r<a;s++)i=e.charCodeAt(s),55296==(64512&i)&&s+1<o&&(n=e.charCodeAt(s+1),56320==(64512&n)&&(i=65536+(i-55296<<10)+(n-56320),s++)),i<128?t[r++]=i:i<2048?(t[r++]=192|i>>>6,t[r++]=128|63&i):i<65536?(t[r++]=224|i>>>12,t[r++]=128|i>>>6&63,t[r++]=128|63&i):(t[r++]=240|i>>>18,t[r++]=128|i>>>12&63,t[r++]=128|i>>>6&63,t[r++]=128|63&i);return t},buf2string:(e,t)=>{const i=t||e.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(e.subarray(0,t));let n,s;const r=new Array(2*i);for(s=0,n=0;n<i;){let t=e[n++];if(t<128){r[s++]=t;continue}let o=DM[t];if(o>4)r[s++]=65533,n+=o-1;else{for(t&=2===o?31:3===o?15:7;o>1&&n<i;)t=t<<6|63&e[n++],o--;o>1?r[s++]=65533:t<65536?r[s++]=t:(t-=65536,r[s++]=55296|t>>10&1023,r[s++]=56320|1023&t)}}return((e,t)=>{if(t<65534&&e.subarray&&wM)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let i="";for(let n=0;n<t;n++)i+=String.fromCharCode(e[n]);return i})(r,s)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let i=t-1;for(;i>=0&&128==(192&e[i]);)i--;return i<0||0===i?t:i+DM[e[i]]>t?i:t}};var NM=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const LM=Object.prototype.toString,{Z_NO_FLUSH:PM,Z_SYNC_FLUSH:kM,Z_FULL_FLUSH:MM,Z_FINISH:UM,Z_OK:xM,Z_STREAM_END:FM,Z_DEFAULT_COMPRESSION:VM,Z_DEFAULT_STRATEGY:BM,Z_DEFLATED:GM}=vk;function jM(e){this.options=bM.assign({level:VM,method:GM,chunkSize:16384,windowBits:15,memLevel:8,strategy:BM},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new NM,this.strm.avail_out=0;let i=IM.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==xM)throw new Error(Sk[i]);if(t.header&&IM.deflateSetHeader(this.strm,t.header),t.dictionary){let e;if(e="string"==typeof t.dictionary?OM.string2buf(t.dictionary):"[object ArrayBuffer]"===LM.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,i=IM.deflateSetDictionary(this.strm,e),i!==xM)throw new Error(Sk[i]);this._dict_set=!0}}function WM(e,t){const i=new jM(t);if(i.push(e,!0),i.err)throw i.msg||Sk[i.err];return i.result}jM.prototype.push=function(e,t){const i=this.strm,n=this.options.chunkSize;let s,r;if(this.ended)return!1;for(r=t===~~t?t:!0===t?UM:PM,"string"==typeof e?i.input=OM.string2buf(e):"[object ArrayBuffer]"===LM.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;)if(0===i.avail_out&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),(r===kM||r===MM)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(s=IM.deflate(i,r),s===FM)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),s=IM.deflateEnd(this.strm),this.onEnd(s),this.ended=!0,s===xM;if(0!==i.avail_out){if(r>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(0===i.avail_in)break}else this.onData(i.output)}return!0},jM.prototype.onData=function(e){this.chunks.push(e)},jM.prototype.onEnd=function(e){e===xM&&(this.result=bM.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var HM={Deflate:jM,deflate:WM,deflateRaw:function(e,t){return(t=t||{}).raw=!0,WM(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,WM(e,t)},constants:vk};const KM=16209;var YM=function(e,t){let i,n,s,r,o,a,c,d,l,h,u,p,f,m,E,_,g,T,S,v,R,y,C,I;const A=e.state;i=e.next_in,C=e.input,n=i+(e.avail_in-5),s=e.next_out,I=e.output,r=s-(t-e.avail_out),o=s+(e.avail_out-257),a=A.dmax,c=A.wsize,d=A.whave,l=A.wnext,h=A.window,u=A.hold,p=A.bits,f=A.lencode,m=A.distcode,E=(1<<A.lenbits)-1,_=(1<<A.distbits)-1;e:do{p<15&&(u+=C[i++]<<p,p+=8,u+=C[i++]<<p,p+=8),g=f[u&E];t:for(;;){if(T=g>>>24,u>>>=T,p-=T,T=g>>>16&255,0===T)I[s++]=65535&g;else{if(!(16&T)){if(0==(64&T)){g=f[(65535&g)+(u&(1<<T)-1)];continue t}if(32&T){A.mode=16191;break e}e.msg="invalid literal/length code",A.mode=KM;break e}S=65535&g,T&=15,T&&(p<T&&(u+=C[i++]<<p,p+=8),S+=u&(1<<T)-1,u>>>=T,p-=T),p<15&&(u+=C[i++]<<p,p+=8,u+=C[i++]<<p,p+=8),g=m[u&_];i:for(;;){if(T=g>>>24,u>>>=T,p-=T,T=g>>>16&255,!(16&T)){if(0==(64&T)){g=m[(65535&g)+(u&(1<<T)-1)];continue i}e.msg="invalid distance code",A.mode=KM;break e}if(v=65535&g,T&=15,p<T&&(u+=C[i++]<<p,p+=8,p<T&&(u+=C[i++]<<p,p+=8)),v+=u&(1<<T)-1,v>a){e.msg="invalid distance too far back",A.mode=KM;break e}if(u>>>=T,p-=T,T=s-r,v>T){if(T=v-T,T>d&&A.sane){e.msg="invalid distance too far back",A.mode=KM;break e}if(R=0,y=h,0===l){if(R+=c-T,T<S){S-=T;do{I[s++]=h[R++]}while(--T);R=s-v,y=I}}else if(l<T){if(R+=c+l-T,T-=l,T<S){S-=T;do{I[s++]=h[R++]}while(--T);if(R=0,l<S){T=l,S-=T;do{I[s++]=h[R++]}while(--T);R=s-v,y=I}}}else if(R+=l-T,T<S){S-=T;do{I[s++]=h[R++]}while(--T);R=s-v,y=I}for(;S>2;)I[s++]=y[R++],I[s++]=y[R++],I[s++]=y[R++],S-=3;S&&(I[s++]=y[R++],S>1&&(I[s++]=y[R++]))}else{R=s-v;do{I[s++]=I[R++],I[s++]=I[R++],I[s++]=I[R++],S-=3}while(S>2);S&&(I[s++]=I[R++],S>1&&(I[s++]=I[R++]))}break}}break}}while(i<n&&s<o);S=p>>3,i-=S,p-=S<<3,u&=(1<<p)-1,e.next_in=i,e.next_out=s,e.avail_in=i<n?n-i+5:5-(i-n),e.avail_out=s<o?o-s+257:257-(s-o),A.hold=u,A.bits=p};const qM=15,$M=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),zM=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),XM=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),JM=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var QM=(e,t,i,n,s,r,o,a)=>{const c=a.bits;let d,l,h,u,p,f,m=0,E=0,_=0,g=0,T=0,S=0,v=0,R=0,y=0,C=0,I=null;const A=new Uint16Array(16),b=new Uint16Array(16);let w,D,O,N=null;for(m=0;m<=qM;m++)A[m]=0;for(E=0;E<n;E++)A[t[i+E]]++;for(T=c,g=qM;g>=1&&0===A[g];g--);if(T>g&&(T=g),0===g)return s[r++]=20971520,s[r++]=20971520,a.bits=1,0;for(_=1;_<g&&0===A[_];_++);for(T<_&&(T=_),R=1,m=1;m<=qM;m++)if(R<<=1,R-=A[m],R<0)return-1;if(R>0&&(0===e||1!==g))return-1;for(b[1]=0,m=1;m<qM;m++)b[m+1]=b[m]+A[m];for(E=0;E<n;E++)0!==t[i+E]&&(o[b[t[i+E]]++]=E);if(0===e?(I=N=o,f=20):1===e?(I=$M,N=zM,f=257):(I=XM,N=JM,f=0),C=0,E=0,m=_,p=r,S=T,v=0,h=-1,y=1<<T,u=y-1,1===e&&y>852||2===e&&y>592)return 1;for(;;){w=m-v,o[E]+1<f?(D=0,O=o[E]):o[E]>=f?(D=N[o[E]-f],O=I[o[E]-f]):(D=96,O=0),d=1<<m-v,l=1<<S,_=l;do{l-=d,s[p+(C>>v)+l]=w<<24|D<<16|O|0}while(0!==l);for(d=1<<m-1;C&d;)d>>=1;if(0!==d?(C&=d-1,C+=d):C=0,E++,0==--A[m]){if(m===g)break;m=t[i+o[E]]}if(m>T&&(C&u)!==h){for(0===v&&(v=T),p+=_,S=m-v,R=1<<S;S+v<g&&(R-=A[S+v],!(R<=0));)S++,R<<=1;if(y+=1<<S,1===e&&y>852||2===e&&y>592)return 1;h=C&u,s[h]=T<<24|S<<16|p-r|0}}return 0!==C&&(s[p+C]=m-v<<24|64<<16|0),a.bits=T,0};const{Z_FINISH:ZM,Z_BLOCK:eU,Z_TREES:tU,Z_OK:iU,Z_STREAM_END:nU,Z_NEED_DICT:sU,Z_STREAM_ERROR:rU,Z_DATA_ERROR:oU,Z_MEM_ERROR:aU,Z_BUF_ERROR:cU,Z_DEFLATED:dU}=vk,lU=16180,hU=16190,uU=16191,pU=16192,fU=16194,mU=16199,EU=16200,_U=16206,gU=16209,TU=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function SU(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const vU=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<lU||t.mode>16211?1:0},RU=e=>{if(vU(e))return rU;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=lU,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,iU},yU=e=>{if(vU(e))return rU;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,RU(e)},CU=(e,t)=>{let i;if(vU(e))return rU;const n=e.state;return t<0?(i=0,t=-t):(i=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?rU:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=i,n.wbits=t,yU(e))},IU=(e,t)=>{if(!e)return rU;const i=new SU;e.state=i,i.strm=e,i.window=null,i.mode=lU;const n=CU(e,t);return n!==iU&&(e.state=null),n};let AU,bU,wU=!0;const DU=e=>{if(wU){AU=new Int32Array(512),bU=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(QM(1,e.lens,0,288,AU,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;QM(2,e.lens,0,32,bU,0,e.work,{bits:5}),wU=!1}e.lencode=AU,e.lenbits=9,e.distcode=bU,e.distbits=5},OU=(e,t,i,n)=>{let s;const r=e.state;return null===r.window&&(r.wsize=1<<r.wbits,r.wnext=0,r.whave=0,r.window=new Uint8Array(r.wsize)),n>=r.wsize?(r.window.set(t.subarray(i-r.wsize,i),0),r.wnext=0,r.whave=r.wsize):(s=r.wsize-r.wnext,s>n&&(s=n),r.window.set(t.subarray(i-n,i-n+s),r.wnext),(n-=s)?(r.window.set(t.subarray(i-n,i),0),r.wnext=n,r.whave=r.wsize):(r.wnext+=s,r.wnext===r.wsize&&(r.wnext=0),r.whave<r.wsize&&(r.whave+=s))),0};var NU=(e,t)=>{let i,n,s,r,o,a,c,d,l,h,u,p,f,m,E,_,g,T,S,v,R,y,C=0;const I=new Uint8Array(4);let A,b;const w=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(vU(e)||!e.output||!e.input&&0!==e.avail_in)return rU;i=e.state,i.mode===uU&&(i.mode=pU),o=e.next_out,s=e.output,c=e.avail_out,r=e.next_in,n=e.input,a=e.avail_in,d=i.hold,l=i.bits,h=a,u=c,y=iU;e:for(;;)switch(i.mode){case lU:if(0===i.wrap){i.mode=pU;break}for(;l<16;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(2&i.wrap&&35615===d){0===i.wbits&&(i.wbits=15),i.check=0,I[0]=255&d,I[1]=d>>>8&255,i.check=Tk(i.check,I,2,0),d=0,l=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&d)<<8)+(d>>8))%31){e.msg="incorrect header check",i.mode=gU;break}if((15&d)!==dU){e.msg="unknown compression method",i.mode=gU;break}if(d>>>=4,l-=4,R=8+(15&d),0===i.wbits&&(i.wbits=R),R>15||R>i.wbits){e.msg="invalid window size",i.mode=gU;break}i.dmax=1<<i.wbits,i.flags=0,e.adler=i.check=1,i.mode=512&d?16189:uU,d=0,l=0;break;case 16181:for(;l<16;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(i.flags=d,(255&i.flags)!==dU){e.msg="unknown compression method",i.mode=gU;break}if(57344&i.flags){e.msg="unknown header flags set",i.mode=gU;break}i.head&&(i.head.text=d>>8&1),512&i.flags&&4&i.wrap&&(I[0]=255&d,I[1]=d>>>8&255,i.check=Tk(i.check,I,2,0)),d=0,l=0,i.mode=16182;case 16182:for(;l<32;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}i.head&&(i.head.time=d),512&i.flags&&4&i.wrap&&(I[0]=255&d,I[1]=d>>>8&255,I[2]=d>>>16&255,I[3]=d>>>24&255,i.check=Tk(i.check,I,4,0)),d=0,l=0,i.mode=16183;case 16183:for(;l<16;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}i.head&&(i.head.xflags=255&d,i.head.os=d>>8),512&i.flags&&4&i.wrap&&(I[0]=255&d,I[1]=d>>>8&255,i.check=Tk(i.check,I,2,0)),d=0,l=0,i.mode=16184;case 16184:if(1024&i.flags){for(;l<16;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}i.length=d,i.head&&(i.head.extra_len=d),512&i.flags&&4&i.wrap&&(I[0]=255&d,I[1]=d>>>8&255,i.check=Tk(i.check,I,2,0)),d=0,l=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&i.flags&&(p=i.length,p>a&&(p=a),p&&(i.head&&(R=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(n.subarray(r,r+p),R)),512&i.flags&&4&i.wrap&&(i.check=Tk(i.check,n,p,r)),a-=p,r+=p,i.length-=p),i.length))break e;i.length=0,i.mode=16186;case 16186:if(2048&i.flags){if(0===a)break e;p=0;do{R=n[r+p++],i.head&&R&&i.length<65536&&(i.head.name+=String.fromCharCode(R))}while(R&&p<a);if(512&i.flags&&4&i.wrap&&(i.check=Tk(i.check,n,p,r)),a-=p,r+=p,R)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&i.flags){if(0===a)break e;p=0;do{R=n[r+p++],i.head&&R&&i.length<65536&&(i.head.comment+=String.fromCharCode(R))}while(R&&p<a);if(512&i.flags&&4&i.wrap&&(i.check=Tk(i.check,n,p,r)),a-=p,r+=p,R)break e}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&i.flags){for(;l<16;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(4&i.wrap&&d!==(65535&i.check)){e.msg="header crc mismatch",i.mode=gU;break}d=0,l=0}i.head&&(i.head.hcrc=i.flags>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=uU;break;case 16189:for(;l<32;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}e.adler=i.check=TU(d),d=0,l=0,i.mode=hU;case hU:if(0===i.havedict)return e.next_out=o,e.avail_out=c,e.next_in=r,e.avail_in=a,i.hold=d,i.bits=l,sU;e.adler=i.check=1,i.mode=uU;case uU:if(t===eU||t===tU)break e;case pU:if(i.last){d>>>=7&l,l-=7&l,i.mode=_U;break}for(;l<3;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}switch(i.last=1&d,d>>>=1,l-=1,3&d){case 0:i.mode=16193;break;case 1:if(DU(i),i.mode=mU,t===tU){d>>>=2,l-=2;break e}break;case 2:i.mode=16196;break;case 3:e.msg="invalid block type",i.mode=gU}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){e.msg="invalid stored block lengths",i.mode=gU;break}if(i.length=65535&d,d=0,l=0,i.mode=fU,t===tU)break e;case fU:i.mode=16195;case 16195:if(p=i.length,p){if(p>a&&(p=a),p>c&&(p=c),0===p)break e;s.set(n.subarray(r,r+p),o),a-=p,r+=p,c-=p,o+=p,i.length-=p;break}i.mode=uU;break;case 16196:for(;l<14;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(i.nlen=257+(31&d),d>>>=5,l-=5,i.ndist=1+(31&d),d>>>=5,l-=5,i.ncode=4+(15&d),d>>>=4,l-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=gU;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;l<3;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}i.lens[w[i.have++]]=7&d,d>>>=3,l-=3}for(;i.have<19;)i.lens[w[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,A={bits:i.lenbits},y=QM(0,i.lens,0,19,i.lencode,0,i.work,A),i.lenbits=A.bits,y){e.msg="invalid code lengths set",i.mode=gU;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;C=i.lencode[d&(1<<i.lenbits)-1],E=C>>>24,_=C>>>16&255,g=65535&C,!(E<=l);){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(g<16)d>>>=E,l-=E,i.lens[i.have++]=g;else{if(16===g){for(b=E+2;l<b;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(d>>>=E,l-=E,0===i.have){e.msg="invalid bit length repeat",i.mode=gU;break}R=i.lens[i.have-1],p=3+(3&d),d>>>=2,l-=2}else if(17===g){for(b=E+3;l<b;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}d>>>=E,l-=E,R=0,p=3+(7&d),d>>>=3,l-=3}else{for(b=E+7;l<b;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}d>>>=E,l-=E,R=0,p=11+(127&d),d>>>=7,l-=7}if(i.have+p>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=gU;break}for(;p--;)i.lens[i.have++]=R}}if(i.mode===gU)break;if(0===i.lens[256]){e.msg="invalid code -- missing end-of-block",i.mode=gU;break}if(i.lenbits=9,A={bits:i.lenbits},y=QM(1,i.lens,0,i.nlen,i.lencode,0,i.work,A),i.lenbits=A.bits,y){e.msg="invalid literal/lengths set",i.mode=gU;break}if(i.distbits=6,i.distcode=i.distdyn,A={bits:i.distbits},y=QM(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,A),i.distbits=A.bits,y){e.msg="invalid distances set",i.mode=gU;break}if(i.mode=mU,t===tU)break e;case mU:i.mode=EU;case EU:if(a>=6&&c>=258){e.next_out=o,e.avail_out=c,e.next_in=r,e.avail_in=a,i.hold=d,i.bits=l,YM(e,u),o=e.next_out,s=e.output,c=e.avail_out,r=e.next_in,n=e.input,a=e.avail_in,d=i.hold,l=i.bits,i.mode===uU&&(i.back=-1);break}for(i.back=0;C=i.lencode[d&(1<<i.lenbits)-1],E=C>>>24,_=C>>>16&255,g=65535&C,!(E<=l);){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(_&&0==(240&_)){for(T=E,S=_,v=g;C=i.lencode[v+((d&(1<<T+S)-1)>>T)],E=C>>>24,_=C>>>16&255,g=65535&C,!(T+E<=l);){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}d>>>=T,l-=T,i.back+=T}if(d>>>=E,l-=E,i.back+=E,i.length=g,0===_){i.mode=16205;break}if(32&_){i.back=-1,i.mode=uU;break}if(64&_){e.msg="invalid literal/length code",i.mode=gU;break}i.extra=15&_,i.mode=16201;case 16201:if(i.extra){for(b=i.extra;l<b;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}i.length+=d&(1<<i.extra)-1,d>>>=i.extra,l-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;C=i.distcode[d&(1<<i.distbits)-1],E=C>>>24,_=C>>>16&255,g=65535&C,!(E<=l);){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(0==(240&_)){for(T=E,S=_,v=g;C=i.distcode[v+((d&(1<<T+S)-1)>>T)],E=C>>>24,_=C>>>16&255,g=65535&C,!(T+E<=l);){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}d>>>=T,l-=T,i.back+=T}if(d>>>=E,l-=E,i.back+=E,64&_){e.msg="invalid distance code",i.mode=gU;break}i.offset=g,i.extra=15&_,i.mode=16203;case 16203:if(i.extra){for(b=i.extra;l<b;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}i.offset+=d&(1<<i.extra)-1,d>>>=i.extra,l-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=gU;break}i.mode=16204;case 16204:if(0===c)break e;if(p=u-c,i.offset>p){if(p=i.offset-p,p>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=gU;break}p>i.wnext?(p-=i.wnext,f=i.wsize-p):f=i.wnext-p,p>i.length&&(p=i.length),m=i.window}else m=s,f=o-i.offset,p=i.length;p>c&&(p=c),c-=p,i.length-=p;do{s[o++]=m[f++]}while(--p);0===i.length&&(i.mode=EU);break;case 16205:if(0===c)break e;s[o++]=i.length,c--,i.mode=EU;break;case _U:if(i.wrap){for(;l<32;){if(0===a)break e;a--,d|=n[r++]<<l,l+=8}if(u-=c,e.total_out+=u,i.total+=u,4&i.wrap&&u&&(e.adler=i.check=i.flags?Tk(i.check,s,u,o-u):_k(i.check,s,u,o-u)),u=c,4&i.wrap&&(i.flags?d:TU(d))!==i.check){e.msg="incorrect data check",i.mode=gU;break}d=0,l=0}i.mode=16207;case 16207:if(i.wrap&&i.flags){for(;l<32;){if(0===a)break e;a--,d+=n[r++]<<l,l+=8}if(4&i.wrap&&d!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=gU;break}d=0,l=0}i.mode=16208;case 16208:y=nU;break e;case gU:y=oU;break e;case 16210:return aU;default:return rU}return e.next_out=o,e.avail_out=c,e.next_in=r,e.avail_in=a,i.hold=d,i.bits=l,(i.wsize||u!==e.avail_out&&i.mode<gU&&(i.mode<_U||t!==ZM))&&OU(e,e.output,e.next_out,u-e.avail_out),h-=e.avail_in,u-=e.avail_out,e.total_in+=h,e.total_out+=u,i.total+=u,4&i.wrap&&u&&(e.adler=i.check=i.flags?Tk(i.check,s,u,e.next_out-u):_k(i.check,s,u,e.next_out-u)),e.data_type=i.bits+(i.last?64:0)+(i.mode===uU?128:0)+(i.mode===mU||i.mode===fU?256:0),(0===h&&0===u||t===ZM)&&y===iU&&(y=cU),y},LU={inflateReset:yU,inflateReset2:CU,inflateResetKeep:RU,inflateInit:e=>IU(e,15),inflateInit2:IU,inflate:NU,inflateEnd:e=>{if(vU(e))return rU;let t=e.state;return t.window&&(t.window=null),e.state=null,iU},inflateGetHeader:(e,t)=>{if(vU(e))return rU;const i=e.state;return 0==(2&i.wrap)?rU:(i.head=t,t.done=!1,iU)},inflateSetDictionary:(e,t)=>{const i=t.length;let n,s,r;return vU(e)?rU:(n=e.state,0!==n.wrap&&n.mode!==hU?rU:n.mode===hU&&(s=1,s=_k(s,t,i,0),s!==n.check)?oU:(r=OU(e,t,i,i),r?(n.mode=16210,aU):(n.havedict=1,iU)))},inflateInfo:"pako inflate (from Nodeca project)"};var PU=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const kU=Object.prototype.toString,{Z_NO_FLUSH:MU,Z_FINISH:UU,Z_OK:xU,Z_STREAM_END:FU,Z_NEED_DICT:VU,Z_STREAM_ERROR:BU,Z_DATA_ERROR:GU,Z_MEM_ERROR:jU}=vk;function WU(e){this.options=bM.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new NM,this.strm.avail_out=0;let i=LU.inflateInit2(this.strm,t.windowBits);if(i!==xU)throw new Error(Sk[i]);if(this.header=new PU,LU.inflateGetHeader(this.strm,this.header),t.dictionary&&("string"==typeof t.dictionary?t.dictionary=OM.string2buf(t.dictionary):"[object ArrayBuffer]"===kU.call(t.dictionary)&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=LU.inflateSetDictionary(this.strm,t.dictionary),i!==xU)))throw new Error(Sk[i])}function HU(e,t){const i=new WU(t);if(i.push(e),i.err)throw i.msg||Sk[i.err];return i.result}WU.prototype.push=function(e,t){const i=this.strm,n=this.options.chunkSize,s=this.options.dictionary;let r,o,a;if(this.ended)return!1;for(o=t===~~t?t:!0===t?UU:MU,"[object ArrayBuffer]"===kU.call(e)?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;){for(0===i.avail_out&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),r=LU.inflate(i,o),r===VU&&s&&(r=LU.inflateSetDictionary(i,s),r===xU?r=LU.inflate(i,o):r===GU&&(r=VU));i.avail_in>0&&r===FU&&i.state.wrap>0&&0!==e[i.next_in];)LU.inflateReset(i),r=LU.inflate(i,o);switch(r){case BU:case GU:case VU:case jU:return this.onEnd(r),this.ended=!0,!1}if(a=i.avail_out,i.next_out&&(0===i.avail_out||r===FU))if("string"===this.options.to){let e=OM.utf8border(i.output,i.next_out),t=i.next_out-e,s=OM.buf2string(i.output,e);i.next_out=t,i.avail_out=n-t,t&&i.output.set(i.output.subarray(e,e+t),0),this.onData(s)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(r!==xU||0!==a){if(r===FU)return r=LU.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,!0;if(0===i.avail_in)break}}return!0},WU.prototype.onData=function(e){this.chunks.push(e)},WU.prototype.onEnd=function(e){e===xU&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=bM.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var KU={Inflate:WU,inflate:HU,inflateRaw:function(e,t){return(t=t||{}).raw=!0,HU(e,t)},ungzip:HU,constants:vk};const{Deflate:YU,deflate:qU,deflateRaw:$U,gzip:zU}=HM,{Inflate:XU,inflate:JU,inflateRaw:QU,ungzip:ZU}=KU;var ex=qU,tx=JU;const ix={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1};function nx(){return ix}let sx=function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e}({});function rx(e,t,i){return{sampleRate:e,stereo:t,bitrate:i}}function ox(e,t,i,n,s){return{width:e,height:t,frameRate:i,bitrateMin:n,bitrateMax:s}}const ax={"90p":ox(160,90),"90p_1":ox(160,90),"120p":ox(160,120,15,30,65),"120p_1":ox(160,120,15,30,65),"120p_3":ox(120,120,15,30,50),"120p_4":ox(212,120),"180p":ox(320,180,15,30,140),"180p_1":ox(320,180,15,30,140),"180p_3":ox(180,180,15,30,100),"180p_4":ox(240,180,15,30,120),"240p":ox(320,240,15,40,200),"240p_1":ox(320,240,15,40,200),"240p_3":ox(240,240,15,40,140),"240p_4":ox(424,240,15,40,220),"360p":ox(640,360,15,80,400),"360p_1":ox(640,360,15,80,400),"360p_3":ox(360,360,15,80,260),"360p_4":ox(640,360,30,80,600),"360p_6":ox(360,360,30,80,400),"360p_7":ox(480,360,15,80,320),"360p_8":ox(480,360,30,80,490),"360p_9":ox(640,360,15,80,800),"360p_10":ox(640,360,24,80,800),"360p_11":ox(640,360,24,80,1e3),"480p":ox(640,480,15,100,500),"480p_1":ox(640,480,15,100,500),"480p_2":ox(640,480,30,100,1e3),"480p_3":ox(480,480,15,100,400),"480p_4":ox(640,480,30,100,750),"480p_6":ox(480,480,30,100,600),"480p_8":ox(848,480,15,100,610),"480p_9":ox(848,480,30,100,930),"480p_10":ox(640,480,10,100,400),"720p":ox(1280,720,15,120,1130),"720p_auto":ox(1280,720,30,900,3e3),"720p_1":ox(1280,720,15,120,1130),"720p_2":ox(1280,720,30,120,2e3),"720p_3":ox(1280,720,30,120,1710),"720p_5":ox(960,720,15,120,910),"720p_6":ox(960,720,30,120,1380),"1080p":ox(1920,1080,15,120,2080),"1080p_1":ox(1920,1080,15,120,2080),"1080p_2":ox(1920,1080,30,120,3e3),"1080p_3":ox(1920,1080,30,120,3150),"1080p_5":ox(1920,1080,60,120,4780),"1440p":ox(2560,1440,30,120,4850),"1440p_1":ox(2560,1440,30,120,4850),"1440p_2":ox(2560,1440,60,120,7350),"4k":ox(3840,2160,30,120,8910),"4k_1":ox(3840,2160,30,120,8910),"4k_3":ox(3840,2160,60,120,13500)},cx=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}];function dx(e){return e||(e="480p_1"),"string"==typeof e?Object.assign({},ax[e]):e}const lx={speech_low_quality:rx(16e3,!1),speech_standard:rx(32e3,!1,18),music_standard:rx(48e3,!1),standard_stereo:rx(48e3,!0,56),high_quality:rx(48e3,!1,128),high_quality_stereo:rx(48e3,!0,192)};const hx=[];function ux(e){return AO(e,"mediaSource",["screen","window","application"]),!0}let px=function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e}({}),fx=function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e}({});let mx=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({});!function(e){e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM"}({}),function(e){e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY"}({});let Ex=function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e}({}),_x=function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e}({}),gx=function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e}({}),Tx=function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e}({});!function(e){e.UPDATE_TRACK_SOURCE="update-track-source"}({});const Sx={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},vx={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},Rx={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},yx={uplinkNetworkQuality:0,downlinkNetworkQuality:0},Cx={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let Ix=function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e}({}),Ax=function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e}({}),bx=function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e}({}),wx=function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e}({}),Dx=function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e}({}),Ox=function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e}({});const Nx={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let Lx=function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e}({});function Px(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function kx(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Px(Object(i),!0).forEach((function(t){Mx(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Px(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Mx(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function Ux(e,t,i,n,s){var r={};return Object.keys(n).forEach((function(e){r[e]=n[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}class xx extends GO{constructor(e,t){super(),this.trackMediaType=void 0,this._ID=void 0,this._rtpTransceiver=void 0,this._lowRtpTransceiver=void 0,this._hints=[],this._isClosed=!1,this._originMediaStreamTrack=void 0,this._mediaStreamTrack=void 0,this._external={},this._ID=t||yN(8,"track-"),this._originMediaStreamTrack=e,this._mediaStreamTrack=e,function(e){hx.includes(e)||hx.push(e)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){if(!e){const e=CL.reportApiInvoke(null,{name:HO.GET_MEDIA_STREAM_TRACK,options:[],tag:KO.TRACER});this._mediaStreamTrack&&"string"==typeof this._mediaStreamTrack.label?e.onSuccess(this._mediaStreamTrack.label):e.onSuccess("")}return this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===mx.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){const t=hx.indexOf(e);-1!==t&&hx.splice(t,1)}(this),this.emit(_x.CLOSED),this.removeAllListeners(Ex.SEI_RECEIVED)}_updateRtpTransceiver(e,t){if(t===mx.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(Ex.TRANSCEIVER_UPDATED,e,t)}}class Fx extends xx{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,t){super(e,t),this._enabled=!0,this._muted=!1,this._isExternalTrack=!1,this._isClosed=!1,this._enabledMutex=void 0,this.processor=void 0,this._processorContext=void 0,this.processorDestination=void 0,this._handleTrackEnded=()=>{this.onTrackEnded()},this._enabledMutex=new PN("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,t;return null!==(e=null===(t=this._originMediaStreamTrack)||void 0===t?void 0:t.label)&&void 0!==e?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,EL.debug("[".concat(this.getTrackId(),"] close")),this.emit(px.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this._isExternalTrack=i,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await iN(this,px.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){EL.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(_x.TRACK_ENDED)}stateCheck(e,t){if(EL.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(t,"]")),IO(t,e),this._enabled&&this._muted&&"enabled"===e&&!1===t)throw new CO(yO.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",EL);if(!this._enabled&&!this._muted&&"muted"===e&&!0===t)throw new CO(yO.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",EL)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Promise.resolve([])}}const Vx=window.AudioContext||window.webkitAudioContext;let Bx=null;const Gx=new class extends GO{constructor(){super(...arguments),this.prevState=void 0,this.curState=void 0,this.currentTime=void 0,this.currentTimeStuckAt=void 0,this.interruptDetectorTrack=void 0,this.onLocalAudioTrackMute=()=>{EL.info("ios15-interruption-start"),this.emit(sx.IOS_15_16_INTERRUPTION_START)},this.onLocalAudioTrackUnmute=async()=>{EL.info("ios15-interruption-end"),"running"!==this.curState||this.duringInterruption?EL.info("ios15-interruption-end-canceled"):(Bx&&await Bx.suspend(),this.emit(sx.IOS_15_16_INTERRUPTION_END))}}get duringInterruption(){return"running"===this.prevState&&"interrupted"===this.curState}bindInterruptDetectorTrack(e){EL.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){EL.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function jx(){if(!Bx){if(function(){if(!Vx)return void EL.error("your browser is not support web audio");EL.info("create audio context");const e=kx({},JN("WEBAUDIO_INIT_OPTIONS"));EL.debug("audio context init option:",JSON.stringify(e)),Bx=new Vx(e),Gx.curState=Bx.state,Bx.onstatechange=()=>{Gx.prevState=Gx.curState,Gx.curState=Bx?Bx.state:void 0;const{prevState:e,curState:t}=Gx,i="running"===t,n="interrupted"===t,s="running"===e,r="suspended"===e,o="interrupted"===e,a=sO().osVersion;(hO()||gO())&&s&&n&&(EL.info("ios".concat(a,"-interruption-start")),Gx.emit(sx.IOS_INTERRUPTION_START)),(hO()||gO())&&(r||o)&&i&&(EL.info("ios".concat(a,"-interruption-end")),Gx.emit(sx.IOS_INTERRUPTION_END)),e!==t&&Gx.emit(sx.STATE_CHANGE,t,e)},setInterval((()=>{var e;const t=null===(e=Bx)||void 0===e?void 0:e.currentTime;Gx.currentTime!==t?(Gx.currentTimeStuckAt&&(EL.debug("AudioContext current time resume at ".concat(t)),Gx.currentTimeStuckAt=void 0),Gx.currentTime=t):(t!==Gx.currentTimeStuckAt&&(CL.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:t},tag:KO.TRACER}).onSuccess(),EL.warning("AudioContext current time stuck at ".concat(t))),Gx.currentTimeStuckAt=t)}),5e3),async function(e){const t=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,n=!1,s=!1,r=!1;function o(t){"running"===e.state?a(!1):hO()||gO()?"suspended"===e.state&&(a(!0),t&&e.resume().then(c,c)):"closed"!==e.state&&(a(!0),t&&e.resume().then(c,c))}function a(e){if(n!==e){n=e;for(let i=0,n=t;i<n.length;i+=1){const t=n[i];e?window.addEventListener(t,d,{capture:!0,passive:!0}):window.removeEventListener(t,d,{capture:!0,passive:!0})}}}function c(){o(!1)}function d(){o(!0)}function l(e){if(!r)if(i.paused)if(e){let t;h(!1),r=!0;try{t=i.play(),t?t.then(u,u):(i.addEventListener("playing",u),i.addEventListener("abort",u),i.addEventListener("error",u))}catch(e){u()}}else h(!0);else h(!1)}function h(e){if(s!==e){s=e;for(let i=0,n=t;i<n.length;i++){const t=n[i];e?window.addEventListener(t,p,{capture:!0,passive:!0}):window.removeEventListener(t,p,{capture:!0,passive:!0})}}}function u(){i.removeEventListener("playing",u),i.removeEventListener("abort",u),i.removeEventListener("error",u),r=!1,l(!1)}function p(){l(!0)}if(hO()){const t=e.createMediaStreamDestination(),n=document.createElement("div");n.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=n.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=t.stream,l(!0)}Gx.on(sx.STATE_CHANGE,(function(){o(!0)})),o(!1)}(Bx)}(),!Bx)throw new CO(yO.NOT_SUPPORTED,"can not create audio context");return Bx}return Bx}function Wx(e){if(function(){if(null!==Hx)return Hx;const e=jx(),t=e.createBufferSource(),i=e.createGain(),n=e.createGain();t.connect(i),t.connect(n),t.disconnect(i);let s=!1;try{t.disconnect(i)}catch(e){s=!0}return t.disconnect(),Hx=s,s}())return;const t=e.connect,i=e.disconnect;e.connect=(i,n,s)=>(e._inputNodes||(e._inputNodes=[]),e._inputNodes.includes(i)||(i instanceof AudioNode?(e._inputNodes.push(i),t.call(e,i,n,s)):t.call(e,i,n)),e),e.disconnect=(n,s,r)=>{i.call(e),n?dN(e._inputNodes,n):e._inputNodes=[];for(const i of e._inputNodes)t.call(e,i)}}let Hx=null;function Kx(e,t){let i=!1;const n=1/t;if(JN("DISABLE_WEBAUDIO")){const t=window.setInterval((()=>{i?window.clearInterval(t):e(performance.now()/1e3)}),1e3*n)}else{const t=jx();let s=t.createGain();s.gain.value=0,s.connect(t.destination);const r=()=>{if(i)return void(s=null);const o=t.createOscillator();o.onended=r,o.connect(s),o.start(0),o.stop(t.currentTime+n),e(t.currentTime)};r()}return()=>{i=!0}}let Yx=class{constructor(){this.context=void 0,this.analyserNode=void 0,this.sourceNode=void 0,this.context=jx(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch(e){}this.sourceNode=e,null==e||e.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode)return 0;if(!this.context||hO()||gO()||"running"!==this.context.state&&this.context.resume(),!this.analyserNode)return 0;const e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{const t=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(t);for(let i=0;i<e.length;++i)e[i]=t[i]/128-1}const t=e.reduce(((e,t)=>e+t*t),0)/e.length;return Math.max(10*Math.log10(t)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,t;null===(e=this.sourceNode)||void 0===e||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,null===(t=this.sourceNode)||void 0===t||t.connect(this.analyserNode)}catch(e){EL.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}},qx=class extends GO{get processSourceNode(){return this.sourceNode}set processedNode(e){var t;if(!this.isDestroyed&&this._processedNode!==e){try{var i;null===(i=this.sourceNode)||void 0===i||i.disconnect(this.outputNode)}catch(e){}null===(t=this._processedNode)||void 0===t||t.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),this.outputNode=void 0,this.outputTrack=void 0,this.isPlayed=!1,this.sourceNode=void 0,this.context=void 0,this.audioBufferNode=void 0,this.destNode=void 0,this.audioOutputLevel=0,this.volumeLevelAnalyser=void 0,this._processedNode=void 0,this.playNode=void 0,this.isDestroyed=!1,this.onNoAudioInput=void 0,this.isNoAudioInput=!1,this._noAudioInputCount=0,this.context=jx(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Wx(this.outputNode),this.volumeLevelAnalyser=new Yx}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=e=>{this.emit(Tx.ON_AUDIO_BUFFER,function(e){for(let t=0;t<e.outputBuffer.numberOfChannels;t+=1){const i=e.outputBuffer.getChannelData(t);for(let e=0;e<i.length;e+=1)i[e]=0}return e.inputBuffer}(e))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!nx().webAudioMediaStreamDest)throw new CO(yO.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){"running"!==this.context.state&&hN((()=>{Gx.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch(e){}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;hO()||gO()?"suspended"===this.context.state&&this.context.resume():"running"!==this.context.state&&this.context.resume();const t=this.volumeLevelAnalyser.getAnalyserNode();let i;t.getFloatTimeDomainData?(i=new Float32Array(t.fftSize),t.getFloatTimeDomainData(i)):(i=new Uint8Array(t.fftSize),t.getByteTimeDomainData(i));let n=!1;for(let e=0;e<i.length;e++)0!==i[e]&&(n=!0);return n?(this.isNoAudioInput=!1,!0):(await RN(200),await this.checkHasAudioInput(e?e+1:1)&&n)}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,t;null===(e=this.processedNode)||void 0===e||e.disconnect(),null===(t=this.sourceNode)||void 0===t||t.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?null===(e=this.processedNode)||void 0===e||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}},$x=class extends qx{get isFreeze(){return!1}constructor(e,t,i){var n;if(super(),this.sourceNode=void 0,this.track=void 0,this.clonedTrack=void 0,this.audioElement=void 0,this.isCurrentTrackCloned=!1,this.isRemoteTrack=!1,this.originVolumeLevelAnalyser=void 0,this.rebuildWebAudio=async()=>{if(EL.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void EL.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>EL.info("resume success"))),EL.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const e=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?e.stop():this.isCurrentTrackCloned=!0;const t=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(t),Wx(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const i=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(i,this.context.currentTime),Wx(this.outputNode),this.emit(Tx.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=t,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()},"audio"!==e.kind)throw new CO(yO.UNEXPECTED_ERROR);this.track=e;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!t,this.sourceNode=this.context.createMediaStreamSource(s),Wx(this.sourceNode),i){const e=i.clone();e.enabled=!0,this.clonedTrack=e,EL.debug("create an unmuted track ".concat(e.id," from the original track ").concat(i.id," to get the volume"));const t=this.context.createMediaStreamSource(new MediaStream([e]));Wx(t),this.originVolumeLevelAnalyser=new Yx,this.originVolumeLevelAnalyser.updateSource(t)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const r=sO();t&&r.os===ZD.IOS&&Number(null===(n=r.osVersion)||void 0===n?void 0:n.split(".")[0])<15&&(Gx.on(sx.STATE_CHANGE,(()=>{"suspended"===this.context.state?document.body.addEventListener("click",this.rebuildWebAudio,!0):"running"===this.context.state&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((e=>{e||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;const t=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(t),Wx(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Tx.UPDATE_SOURCE),this.audioElement.srcObject=t}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Gx.off("state-change",this.rebuildWebAudio),null===(e=this.originVolumeLevelAnalyser)||void 0===e||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){const t=e.clone();t.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=t),EL.debug("create an unmuted track ".concat(t.id," from the original track ").concat(e.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([t]));Wx(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}};async function zx(e,t,i){const n=(e,t)=>e?"number"!=typeof e?e.max||e.exact||e.ideal||e.min||t:e:t,s={audio:!!i&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:n(t.height,1080),maxWidth:n(t.width,1920)}}};return t.frameRate&&"number"!=typeof t.frameRate?(s.video.mandatory.maxFrameRate=t.frameRate.max,s.video.mandatory.minFrameRate=t.frameRate.min):"number"==typeof t.frameRate&&(s.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(s)}async function Xx(e,t){const i=await async function(e){let t=["window","screen"];"application"!==e&&"window"!==e||(t=["window"]),"screen"===e&&(t=["screen"]);const i=WO();if(!i)throw console.error("failed to fetch electron, please mount it to window"),new CO(yO.ELECTRON_IS_NULL);let n=null;try{var s;n=(null===(s=i.desktopCapturer)||void 0===s?void 0:s.getSources({types:t}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch(e){n=null}n&&n.then||(n=new Promise(((e,n)=>{i.desktopCapturer.getSources({types:t},((t,i)=>{t?n(t):e(i)}))})));try{return await n}catch(e){throw new CO(yO.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,e.toString())}}(e.mediaSource),{sourceId:n,audio:s}=await function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise(((i,n)=>{const s=document.createElement("div");s.innerText="share screen",s.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const r=document.createElement("div");r.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const o=document.createElement("div");o.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",o.setAttribute("style","height: 12%;");const a=document.createElement("div");a.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const c=document.createElement("div");c.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const d=document.createElement("button");d.innerHTML="cancel",d.setAttribute("style","width: 85px;"),d.onclick=()=>{document.body.removeChild(u);const e=new Error("NotAllowedError");e.name="NotAllowedError",n(e)};let l=t;const h=document.createElement("div");if(t){const e=document.createElement("input");e.setAttribute("type","checkbox");const t=document.createElement("span");e.setAttribute("style","margin-right: 6px;"),t.innerText="Share audio",e.checked=l,e.onchange=()=>{l=e.checked},h.appendChild(e),h.appendChild(t)}c.appendChild(h),c.appendChild(d),r.appendChild(o),r.appendChild(a),r.appendChild(c);const u=document.createElement("div");u.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),u.appendChild(s),u.appendChild(r),document.body.appendChild(u),e.map((e=>{if(e.id){const t=document.createElement("div");t.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let n=e.thumbnail;try{const{width:e}=n.getSize();e>1920&&(n=n.resize({width:1920}))}catch(e){throw e&&e.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),e}t.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+n.toDataURL()+' /></div><span style="\theight: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+e.name.replace(/[\u00A0-\u9999<>\&]/g,(function(e){return"&#"+e.charCodeAt(0)+";"}))+"</span>",t.onclick=()=>{document.body.removeChild(u),i({sourceId:e.id,audio:l})},a.appendChild(t)}}))}))}(i,t);return await zx(n,e,s)}const Jx=new PN("safari");let Qx=!1,Zx=!1;async function eF(e,t){let i=0,n=null;for(;i<2;)try{n=await tF(e,t,i>0);break}catch(e){if(e instanceof CO)throw EL.error("[".concat(t,"] ").concat(e.toString())),e;const n=iF(e.name||e.code||e,e.message);if(n.code===yO.MEDIA_OPTION_INVALID){EL.debug("[".concat(t,"] detect media option invalid, retry")),i+=1,await RN(500);continue}throw EL.error("[".concat(t,"] ").concat(n.toString())),n}if(!n)throw new CO(yO.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n}async function tF(e,t,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new CO(yO.NOT_SUPPORTED,"can not find getUserMedia");i&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const n=nx(),s=new MediaStream;if(e.audioSource&&s.addTrack(e.audioSource),e.videoSource&&s.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return EL.debug("Using Video Source/ Audio Source"),s;if(e.screen)if(WO())e.screen.sourceId?nF(s,await zx(e.screen.sourceId,e.screen,e.screenAudio)):nF(s,await Xx(e.screen,e.screenAudio));else if(cO()&&e.screen.extensionId&&e.screen.mandatory){if(!n.getStreamFromExtension)throw new CO(yO.NOT_SUPPORTED,"This browser does not support screen sharing");EL.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const i=await(o=e.screen.extensionId,a=t,new Promise(((e,t)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},(i=>{if(!i||!i.streamId)return EL.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),i),void t(new CO(yO.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));e(i.streamId)}))}catch(e){EL.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),e.toString()),t(new CO(yO.CHROME_PLUGIN_NOT_INSTALL))}})));e.screen.mandatory.chromeMediaSourceId=i,nF(s,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(n.getDisplayMedia){var r;e.screen.mediaSource&&ux(e.screen.mediaSource);const i={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:null!==(r=e.screen.displaySurface)&&void 0!==r?r:"screen"===e.screen.mediaSource?"monitor":e.screen.mediaSource},{selfBrowserSurface:n,surfaceSwitching:o,systemAudio:a}=e.screen,c={selfBrowserSurface:n,surfaceSwitching:o,systemAudio:a};!n&&delete c.selfBrowserSurface,!o&&delete c.surfaceSwitching,!a&&delete c.systemAudio,EL.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:i,audio:!!e.screenAudio,controls:c})),nF(s,await navigator.mediaDevices.getDisplayMedia(kx({video:i,audio:!!e.screenAudio},c)))}else{if(!lO())throw EL.error("[".concat(t,"] This browser does not support screenSharing")),new CO(yO.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&ux(e.screen.mediaSource);const i={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};EL.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(i))),nF(s,await navigator.mediaDevices.getUserMedia(i))}}var o,a;if(!e.video&&!e.audio)return s;let c={video:e.video,audio:e.audio},d=JN("MEDIA_DEVICE_CONSTRAINTS");if(d)try{"string"==typeof d&&(d=JSON.parse(d)),c=DN(c,d)}catch(e){}EL.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),sO();let l,h=null;(dO()||hO()||aO())&&(h=await Jx.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(e){throw h&&h(),e}return c.audio&&(Qx=!0),c.video&&(Zx=!0),nF(s,l),h&&h(),s}function iF(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new CO(yO.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new CO(yO.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new CO(yO.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new CO(yO.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new CO(yO.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new CO(yO.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return EL.error("getUserMedia unexpected error",e),new CO(yO.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function nF(e,t){const i=e.getVideoTracks()[0],n=e.getAudioTracks()[0],s=t.getVideoTracks()[0],r=t.getAudioTracks()[0];r&&(n&&e.removeTrack(n),e.addTrack(r)),s&&(i&&e.removeTrack(i),e.addTrack(s))}const sF=new class extends GO{get state(){return this._state}set state(e){e!==this._state&&(this.emit(wx.STATE_CHANGE,e),this._state=e)}constructor(){super(),this._state=bx.IDLE,this.isAccessMicrophonePermission=!1,this.isAccessCameraPermission=!1,this.lastAccessMicrophonePermission=!1,this.lastAccessCameraPermission=!1,this.checkdeviceMatched=!1,this.deviceInfoMap=new Map,this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(JN("ENUMERATE_DEVICES_INTERVAL")||(vO()||rO()===ZD.HARMONY_OS)&&SO())&&this.updateDevicesInfo()}),JN("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((e=>EL.error(e.toString())))}async enumerateDevices(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new CO(yO.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const n=await navigator.mediaDevices.enumerateDevices(),s=this.checkMediaDeviceInfoIsOk(n);let r=!this.isAccessMicrophonePermission&&e,o=!this.isAccessCameraPermission&&t;s.audio&&(r=!1),s.video&&(o=!1);let a=null,c=null,d=null;if(!i&&(r||o)){if(Jx.isLocked&&(EL.debug("[device manager] wait GUM lock"),(await Jx.lock())(),EL.debug("[device manager] GUM unlock")),Qx&&(r=!1,this.isAccessMicrophonePermission=!0),Zx&&(o=!1,this.isAccessCameraPermission=!0),EL.debug("[device manager] check media device permissions",e,t,r,o),r&&o){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(e){const t=iF(e.name||e.code||e,e.message);if(t.code===yO.PERMISSION_DENIED)throw t;EL.warning("getUserMedia failed in getDevices",t)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(r){try{a=await navigator.mediaDevices.getUserMedia({audio:e})}catch(e){const t=iF(e.name||e.code||e,e.message);if(t.code===yO.PERMISSION_DENIED)throw t;EL.warning("getUserMedia failed in getDevices",t)}this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({video:t})}catch(e){const t=iF(e.name||e.code||e,e.message);if(t.code===yO.PERMISSION_DENIED)throw t;EL.warning("getUserMedia failed in getDevices",t)}this.isAccessCameraPermission=!0}EL.debug("[device manager] mic permission",e,"cam permission",t)}try{const e=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((e=>e.stop())),c&&c.getTracks().forEach((e=>e.stop())),d&&d.getTracks().forEach((e=>e.stop())),a=null,c=null,d=null,e}catch(e){return a&&a.getTracks().forEach((e=>e.stop())),c&&c.getTracks().forEach((e=>e.stop())),d&&d.getTracks().forEach((e=>e.stop())),a=null,c=null,d=null,new CO(yO.ENUMERATE_DEVICES_FAILED,e.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((e=>"audioinput"===e.kind))}async getCamerasDevices(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter((e=>"videoinput"===e.kind))}async getSpeakers(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((e=>"audiooutput"===e.kind))}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach((i=>{i.device.label===e&&(t=i.device.deviceId)})),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find((t=>t.deviceId===e));if(!t)throw new CO(yO.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=bx.INITING;try{await this.updateDevicesInfo(),this.state=bx.INITEND}catch(e){throw EL.warning("Device Detection functionality cannot start properly.",e.toString()),this.state=bx.IDLE,("boolean"==typeof isSecureContext?isSecureContext:"https:"===location.protocol||"file:"===location.protocol||"localhost"===location.hostname||"127.0.0.1"===location.hostname||"::1"===location.hostname)||new CO(yO.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),e}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),i=[];if(e[0]&&e[0].label&&!1===this.checkdeviceMatched){this.checkdeviceMatched=!0;const t=e.find((e=>"audioinput"===e.kind&&"default"===e.deviceId)),i=e.find((e=>"audiooutput"===e.kind&&"default"===e.deviceId));t&&i?i.groupId===t.groupId?EL.debug("[device-check] default input ".concat(t.label," and output ").concat(i.label," is the same group")):EL.warning("[device-check] default input ".concat(t.label," and output ").concat(i.label," is not the same group")):EL.debug("[device-check] default input or output not found")}const n=this.checkMediaDeviceInfoIsOk(e);if(e.forEach((e=>{if(!e.deviceId)return;const n=this.deviceInfoMap.get("".concat(e.kind,"_").concat(e.deviceId));if("ACTIVE"!==(n?n.state:"INACTIVE")){const n={initAt:t,updateAt:t,device:e,state:"ACTIVE"};this.deviceInfoMap.set("".concat(e.kind,"_").concat(e.deviceId),n),i.push(n)}n&&(n.updateAt=t)})),this.deviceInfoMap.forEach(((e,n)=>{"ACTIVE"===e.state&&e.updateAt!==t&&(e.state="INACTIVE",i.push(e))})),this.state!==bx.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach((e=>{switch(e.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(wx.RECORDING_DEVICE_CHANGED,e);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(wx.CAMERA_DEVICE_CHANGED,e);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(wx.PLAYOUT_DEVICE_CHANGED,e)}})),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter((e=>"audioinput"===e.kind)),i=e.filter((e=>"videoinput"===e.kind)),n={audio:!1,video:!1};for(const e of t)if(e.label&&e.deviceId){n.audio=!0;break}for(const e of i)if(e.label&&e.deviceId){n.video=!0;break}return n}};let rF=!1;const oF=new class extends GO{constructor(){super(...arguments),this.onAutoplayFailed=void 0,this.onAudioAutoplayFailed=void 0}};function aF(){if(sO(),!rF){const e=t=>{t.preventDefault(),rF=!1,RO()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};rF=!0,RO()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),EL.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),oF.onAutoplayFailed?oF.onAutoplayFailed():oF.onAudioAutoplayFailed?EL.warning("AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.\n\n  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."):EL.warning("We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.\n\n  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.\n\n  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web ."),oF.emit("autoplay-failed")}}function cF(e,t,i,n){if(!e)return;const s=CL.getBaseInfoBySessionId(e);if(!s)return;const r=s.info,o=Date.now(),a=kx(kx({},r),{},{vid:void 0===r.vid?0:Number(r.vid),lts:o,elapse:o-s.startTime,cbRegistered:oF.onAutoplayFailed||oF.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:t,trackId:n,extend:void 0});CL.send({type:vL.AUTOPLAY_FAILED,data:a},!0)}const dF=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],lF=new class{constructor(){this.onAutoplayFailed=void 0,this.elementMap=new Map,this.elementStateMap=new Map,this.elementsNeedToResume=[],this.sinkIdMap=new Map,this.autoResumeAfterInterruption=e=>{Array.from(this.elementMap.entries()).forEach((t=>{let[i,n]=t;const s=this.elementStateMap.get(i),r=n.srcObject.getAudioTracks()[0],o=r&&r.readyState;if(EL.debug("resume after interrupted, ele: ".concat(s," audio: ").concat(o," ").concat(e)),"live"===o){if(e)return n.pause(),void n.play();if("running"===Gx.curState)return mO()?(n.pause(),void n.play()):void(s&&"paused"===s&&n.play())}}))},this.autoResumeAfterInterruptionOnIOS15_16=()=>{Array.from(this.elementMap.entries()).forEach((e=>{let[t,i]=e;const n=i.srcObject.getAudioTracks()[0];n&&"live"===n.readyState&&(EL.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())}))},this.autoResumeAudioElement(),Gx.on(sx.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Gx.on(sx.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Gx.on(sx.STATE_CHANGE,(()=>{hO()&&"suspended"===Gx.prevState&&"running"===Gx.curState&&this.autoResumeAfterInterruption()}))}async setSinkID(e,t){const i=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),i)try{await i.setSinkId(t)}catch(e){throw new CO(yO.PERMISSION_DENIED,"can not set sink id: "+e.toString())}}play(e,t,i,n){if(this.elementMap.has(t))return;const s=document.createElement("audio");s.autoplay=!0,s.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,s),this.elementMap.set(t,s),this.elementStateMap.set(t,Dx.INIT),this.setVolume(t,i);const r=this.sinkIdMap.get(t);if(r)try{s.setSinkId(r).catch((e=>{EL.warning("[".concat(t,"] set sink id failed"),e.toString())}))}catch(e){EL.warning("[".concat(t,"] set sink id failed"),e.toString())}const o=s.play();o&&o.then&&o.catch((e=>{n&&cF(n,"audio",e.message,t),EL.warning("audio element play warning",e.toString()),this.elementMap.has(t)&&"NotAllowedError"===e.name&&(EL.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(s),hN((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),aF()})))}))}updateTrack(e,t){const i=this.elementMap.get(e);i&&(i.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&"playing"===this.elementStateMap.get(e)}setVolume(e,t){const i=this.elementMap.get(e);i&&(t=Math.max(0,Math.min(100,t)),i.volume=t/100)}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const i=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(i,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){dF.forEach((i=>{t.addEventListener(i,(i=>{const n=this.elementStateMap.get(e),s="pause"===i.type?"paused":i.type;if(EL.debug("[".concat(e,"] audio-element-status change ").concat(n," => ").concat(s)),"error"===i.type){const i=null==t?void 0:t.error;i&&EL.error("[".concat(e,"] media error, code: ").concat(i.code,", message: ").concat(i.message))}this.elementStateMap.set(e,s)}))}))}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach((e=>{e.play().then((e=>{EL.debug("Auto resume audio element success")})).catch((e=>{EL.warning("Auto resume audio element failed!",e)}))})),this.elementsNeedToResume=[]};new Promise((e=>{document.body?e():window.addEventListener("load",(()=>e()))})).then((()=>{RO()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))}))}};function hF(){return function(e,t,i){const n=i.value;return"function"==typeof n&&(i.value=function(){this._isClosed&&new CO(yO.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",EL);for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];const s=n.apply(this,t);return s instanceof Promise?new Promise(((e,t)=>{s.then(e).catch(t)})):s}),i}}let uF=class extends GO{constructor(e){super(),this.name="VideoProcessorDestination",this.ID="0",this._source=void 0,this.videoContext=void 0,this.inputTrack=void 0,this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new CO(yO.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new CO(yO.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error("ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.\nProbably you are making pipeline like this:\nvideoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).");e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(Ix.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Ix.ON_TRACK,void 0)}},pF=class extends GO{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t){super(),this.constraintsMap=new Map,this.statsRegistry=[],this.usageRegistry=[],this.trackId=void 0,this.direction=void 0,this._chained=!1,this.trackId=e,this.direction=t}async getConstraints(){return await tN(this,Ax.REQUEST_CONSTRAINTS)}async requestApplyConstraints(e,t){return EL.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),iN(this,Ax.REQUEST_UPDATE_CONSTRAINTS,Array.from(this.constraintsMap.values()))}async requestRevertConstraints(e){if(this.constraintsMap.has(e))return EL.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),iN(this,Ax.REQUEST_UPDATE_CONSTRAINTS,Array.from(this.constraintsMap.values()))}registerStats(e,t,i){this.statsRegistry.find((i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===t))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:i})}unregisterStats(e,t){const i=this.statsRegistry.findIndex((i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===t));-1!==i&&this.statsRegistry.splice(i,1)}gatherStats(){const e=[];for(const{processorID:t,processorName:i,type:n,cb:s}of this.statsRegistry)try{const r=s();e.push({processorID:t,processorName:i,type:n,stats:r})}catch(e){EL.error(new CO(yO.UNEXPECTED_ERROR,e.message))}return e}registerUsage(e,t){this.usageRegistry.find((t=>t.processorID===e.ID&&t.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){const t=this.usageRegistry.findIndex((t=>t.processorID===e.ID&&t.processorName===e.name));-1!==t&&this.usageRegistry.splice(t,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:t}of this.usageRegistry)try{let i=t();i instanceof Promise&&(i=await i),e.push(kx(kx({},i),{},{direction:this.direction}))}catch(e){EL.error("gather extension usage error",e)}return e}getDirection(){return this.direction}},fF=class extends GO{constructor(e){super(),this.name="AudioProcessorDestination",this.ID="0",this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext=void 0,this._source=void 0,this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new CO(yO.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new CO(yO.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Ix.ON_TRACK,void 0),this.emit(Ix.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error("ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.\n        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).");e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(Ix.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(Ix.ON_NODE,this.inputNode))}},mF=class extends GO{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,t,i){super(),this.constraintsMap=new Map,this.statsRegistry=[],this.audioContext=void 0,this.trackId=void 0,this.direction=void 0,this.usageRegistry=[],this._chained=!1,this.audioContext=e,this.trackId=t,this.direction=i}async getConstraints(){return tN(this,Ax.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(e,t){return EL.info("processor ".concat(t.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(t,e),iN(this,Ax.REQUEST_UPDATE_CONSTRAINTS,Array.from(this.constraintsMap.values()))}async requestRevertConstraints(e){if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),iN(this,Ax.REQUEST_UPDATE_CONSTRAINTS,Array.from(this.constraintsMap.values()))}registerStats(e,t,i){this.statsRegistry.find((i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===t))||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:t,cb:i})}unregisterStats(e,t){const i=this.statsRegistry.findIndex((i=>i.processorID===e.ID&&i.processorName===e.name&&i.type===t));-1!==i&&this.statsRegistry.splice(i,1)}gatherStats(){const e=[];for(const{processorID:t,processorName:i,type:n,cb:s}of this.statsRegistry)try{const r=s();e.push({processorID:t,processorName:i,type:n,stats:r})}catch(e){EL.error(new CO(yO.UNEXPECTED_ERROR,e.message))}return e}registerUsage(e,t){this.usageRegistry.find((t=>t.processorID===e.ID&&t.processorName===e.name))||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:t})}unregisterUsage(e){const t=this.usageRegistry.findIndex((t=>t.processorID===e.ID&&t.processorName===e.name));-1!==t&&this.usageRegistry.splice(t,1)}async gatherUsage(){const e=[];if(!this.chained)return[];for(const{cb:t}of this.usageRegistry)try{let i=t();i instanceof Promise&&(i=await i),e.push(kx(kx({},i),{},{direction:this.direction}))}catch(e){EL.error("gather extension usage error",e)}return e}getDirection(){return this.direction}},EF=class extends GO{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),this.context=void 0,this.processSourceNode=void 0,this.outputTrack=void 0,this.processedNode=void 0,this.clonedTrack=void 0,this.outputNode=void 0,this.outputNode=new _F}setVolume(){}createOutputTrack(){throw new CO(yO.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}},_F=class{disconnect(){}connect(){}};var gF,TF,SF,vF,RF,yF,CF,IF,AF,bF,wF,DF,OF,NF,LF,PF,kF,MF,UF,xF,FF,VF,BF,GF,jF,WF,HF,KF,YF,qF,$F,zF,XF,JF,QF,ZF,eV,tV,iV,nV;let sV=(gF=yL({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),TF=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),SF=hF(),vF=kN("LocalAudioTrack","_enabledMutex"),RF=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),yF=hF(),CF=kN("LocalAudioTrack","_enabledMutex"),IF=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),AF=hF(),bF=hF(),wF=hF(),DF=yL({argsMap:e=>[e.getTrackId()]}),OF=hF(),NF=yL({argsMap:e=>[e.getTrackId()]}),LF=hF(),PF=yL({argsMap:e=>[e.getTrackId()]}),kF=yL({argsMap:(e,t)=>[e.getTrackId(),t.name]}),MF=yL({argsMap:e=>[e.getTrackId()]}),Ux((UF=class extends Fx{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?lF.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,i,n){super(e,i),this.trackMediaType="audio",this._encoderConfig=void 0,this._trackSource=void 0,this._enabled=!0,this._volume=100,this._useAudioElement=!0,this._bypassWebAudio=!1,this.processor=void 0,this._processorContext=void 0,this._processorDestination=void 0,this._getOriginVolumeLevel=void 0,this._encoderConfig=t,this._getOriginVolumeLevel=!!n,this._trackSource=new EF,JN("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),JN("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),dO()&&!Bx?setTimeout((()=>this.initWebAudio())):this.initWebAudio()}setVolume(e){bO(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&lF.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void EL.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,iN(this,px.NEED_REPLACE_TRACK,this).then((()=>{EL.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((e=>{EL.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),e)})))}catch(e){}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!cO()&&JN("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new CO(yO.NOT_SUPPORTED,"your browser does not support setting the audio output device");await lF.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,i){return this._setEnabled(e,t,i)}async _setEnabled(e,t,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(EL.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await iN(this,px.NEED_ENABLE_TRACK,this),EL.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(e){throw i||(this._enabled=!1),EL.error("[".concat(this.getTrackId(),"] setEnabled to true error"),e.toString()),e}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await iN(this,px.NEED_DISABLE_TRACK,this)}catch(e){throw i||(this._enabled=!0),EL.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,EL.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await iN(this,px.NEED_MUTE_TRACK,this):await iN(this,px.NEED_UNMUTE_TRACK,this))}getStats(){mN((()=>{EL.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning");return nN(this,px.GET_STATS)||kx({},Sx)}setAudioFrameCallback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Tx.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Tx.ON_AUDIO_BUFFER),this._source.on(Tx.ON_AUDIO_BUFFER,(t=>e(t)))}play(){EL.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(EL.debug("[".concat(this.getTrackId(),"] start audio playback in element")),lF.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){EL.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?lF.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];EL.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&lF.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await iN(this,px.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return Promise.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new CO(yO.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new CO(yO.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;null===(e=this._source.processSourceNode)||void 0===e||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(Ix.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),await iN(this,px.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await iN(this,px.NEED_REPLACE_TRACK,this))})),e.on(Ix.ON_NODE,(e=>{this._source.processedNode=e}))}unbindProcessorDestinationEvents(e){e.removeAllListeners(Ix.ON_TRACK),e.removeAllListeners(Ix.ON_NODE)}bindProcessorContextEvents(e){e.on(Ax.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}unbindProcessorContextEvents(e){e.removeAllListeners(Ax.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof EF&&(this._trackSource=new $x(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new mF(this._source.context,this.getTrackId(),"local"),t=new fF(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(Tx.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})})),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(lF.stop(this.getTrackId()),this._source.play()),iN(this,px.NEED_REPLACE_MIXING_TRACK,this).then((()=>{EL.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))})).catch((e=>{EL.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),e)}))),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[gF],Object.getOwnPropertyDescriptor(UF.prototype,"setVolume"),UF.prototype),Ux(UF.prototype,"setPlaybackDevice",[TF,SF],Object.getOwnPropertyDescriptor(UF.prototype,"setPlaybackDevice"),UF.prototype),Ux(UF.prototype,"setEnabled",[vF,RF,yF],Object.getOwnPropertyDescriptor(UF.prototype,"setEnabled"),UF.prototype),Ux(UF.prototype,"setMuted",[CF,IF,AF],Object.getOwnPropertyDescriptor(UF.prototype,"setMuted"),UF.prototype),Ux(UF.prototype,"getStats",[bF],Object.getOwnPropertyDescriptor(UF.prototype,"getStats"),UF.prototype),Ux(UF.prototype,"setAudioFrameCallback",[wF],Object.getOwnPropertyDescriptor(UF.prototype,"setAudioFrameCallback"),UF.prototype),Ux(UF.prototype,"play",[DF,OF],Object.getOwnPropertyDescriptor(UF.prototype,"play"),UF.prototype),Ux(UF.prototype,"stop",[NF,LF],Object.getOwnPropertyDescriptor(UF.prototype,"stop"),UF.prototype),Ux(UF.prototype,"close",[PF],Object.getOwnPropertyDescriptor(UF.prototype,"close"),UF.prototype),Ux(UF.prototype,"pipe",[kF],Object.getOwnPropertyDescriptor(UF.prototype,"pipe"),UF.prototype),Ux(UF.prototype,"unpipe",[MF],Object.getOwnPropertyDescriptor(UF.prototype,"unpipe"),UF.prototype),UF),rV=(xF=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),FF=hF(),VF=kN("MicrophoneAudioTrack","_enabledMutex"),BF=yL({argsMap:(e,t,i)=>[e.getTrackId(),t,i]}),GF=hF(),jF=yL({argsMap:e=>[e.getTrackId()]}),Ux((WF=class extends sV{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,i,n){super(e,t.encoderConfig?function(e){return"string"==typeof e?Object.assign({},lx[e]):e}(t.encoderConfig):{},n,JN("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),this._config=void 0,this._deviceName="default",this._constraints=void 0,this._originalConstraints=void 0,this._enabled=!0,this._config=t,this._constraints=i,this._originalConstraints=i,this._deviceName=e.label,"boolean"==typeof t.bypassWebAudio&&(this._bypassWebAudio=t.bypassWebAudio),(mO()||EO())&&Gx.bindInterruptDetectorTrack(this)}async setDevice(e){if(EL.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await sF.getDeviceById(e),i={};i.audio=kx({},this._constraints),i.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let n=null;try{n=await eF(i,this.getTrackId())}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setDevice failed"),e.toString()),n=await eF({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(n.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const t=await sF.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}EL.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,i){if(t)return EL.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(EL.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){var n;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),null===(n=this._source.clonedTrack)||void 0===n||n.stop(),i||(this._enabled=!1);try{await iN(this,px.NEED_DISABLE_TRACK,this)}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setEnabled false failed"),e.toString()),e}return}const s=kx({},this._constraints),r=sF.searchDeviceIdByName(this._deviceName);r&&!s.deviceId&&(s.deviceId=r);try{i||(this._enabled=!0);const e=await eF({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getAudioTracks()[0],!1),await iN(this,px.NEED_ENABLE_TRACK,this)}catch(e){throw i||(this._enabled=!1),EL.error("[".concat(this.getTrackId(),"] setEnabled true failed"),e.toString()),e}EL.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(mO()||EO())&&Gx.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((hO()||gO())&&this._enabled&&!this._isClosed&&Gx.duringInterruption){const e=async()=>{Gx.off(sx.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(EL.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Gx.on(sx.IOS_INTERRUPTION_END,e)}else EL.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(_x.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,i=sF.searchDeviceIdByName(this._deviceName);if(i&&!t.deviceId&&(t.deviceId=i),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const e=await eF({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(Ax.REQUEST_UPDATE_CONSTRAINTS,(async(e,t,i)=>{try{const i=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(i),t()}catch(e){i(e)}}))}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(Ax.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[xF,FF],Object.getOwnPropertyDescriptor(WF.prototype,"setDevice"),WF.prototype),Ux(WF.prototype,"setEnabled",[VF,BF,GF],Object.getOwnPropertyDescriptor(WF.prototype,"setEnabled"),WF.prototype),Ux(WF.prototype,"close",[jF],Object.getOwnPropertyDescriptor(WF.prototype,"close"),WF.prototype),WF);HF=yL({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),KF=hF(),YF=yL({argsMap:e=>[e.getTrackId()]}),qF=hF(),$F=yL({argsMap:e=>[e.getTrackId()]}),zF=hF(),XF=yL({argsMap:e=>[e.getTrackId()]}),JF=hF(),QF=yL({argsMap:e=>[e.getTrackId()]}),ZF=hF(),eV=yL({argsMap:e=>[e.getTrackId()]}),tV=yL({argsMap:e=>[e.getTrackId()]}),iV=hF(),Ux((nV=class extends sV{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,i,n){super(t.createOutputTrack(),i,n),this.source=void 0,this._bufferSource=void 0,this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(Tx.AUDIO_SOURCE_STATE_CHANGE,(e=>{this.safeEmit(_x.SOURCE_STATE_CHANGE,e)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(e){}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){bO(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[HF,KF],Object.getOwnPropertyDescriptor(nV.prototype,"startProcessAudioBuffer"),nV.prototype),Ux(nV.prototype,"pauseProcessAudioBuffer",[YF,qF],Object.getOwnPropertyDescriptor(nV.prototype,"pauseProcessAudioBuffer"),nV.prototype),Ux(nV.prototype,"seekAudioBuffer",[$F,zF],Object.getOwnPropertyDescriptor(nV.prototype,"seekAudioBuffer"),nV.prototype),Ux(nV.prototype,"resumeProcessAudioBuffer",[XF,JF],Object.getOwnPropertyDescriptor(nV.prototype,"resumeProcessAudioBuffer"),nV.prototype),Ux(nV.prototype,"stopProcessAudioBuffer",[QF,ZF],Object.getOwnPropertyDescriptor(nV.prototype,"stopProcessAudioBuffer"),nV.prototype),Ux(nV.prototype,"close",[eV],Object.getOwnPropertyDescriptor(nV.prototype,"close"),nV.prototype),Ux(nV.prototype,"setAudioBufferPlaybackSpeed",[tV,iV],Object.getOwnPropertyDescriptor(nV.prototype,"setAudioBufferPlaybackSpeed"),nV.prototype);let oV=class e extends sV{get __className__(){return"MixingAudioTrack"}get isActive(){for(const e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){const e=jx().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,yN(8,"track-mix-")),this.trackList=void 0,this.destNode=void 0,this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch(e){}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return-1!==this.trackList.indexOf(e)}addAudioTrack(e){-1===this.trackList.indexOf(e)?(EL.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):EL.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(-1!==this.trackList.indexOf(e)){EL.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch(e){}dN(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){const e={};this.trackList.forEach((t=>{t._encoderConfig&&((t._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=t._encoderConfig.bitrate),(t._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=t._encoderConfig.sampleRate),(t._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=t._encoderConfig.sampleSize),t._encoderConfig.stereo&&(e.stereo=!0))})),this._encoderConfig=e}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach((i=>{i instanceof e?i.emit(Ex.TRANSCEIVER_UPDATED,t):i._updateRtpTransceiver(t)})))}};function aV(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const i=dx(e.encoderConfig);return null!=i.width&&(t.width=i.width),null!=i.height&&(t.height=i.height),!(window.navigator.appVersion&&null!==window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35)&&i.frameRate&&(t.frameRate=i.frameRate),sO().name===eO.EDGE&&"object"==typeof t.frameRate&&(t.frameRate.max=60),lO()&&(t.frameRate={ideal:30,max:30}),t}const cV=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new Promise(((i,n)=>{t.toBlob((async e=>{if(t.remove(),e){const n=await dV(e);i({buffer:n,width:t.width,height:t.height})}else n(new CO(yO.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,1)}))},dV=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};let lV=class{get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(EL.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var t;e!==this._videoState&&(EL.debug("[".concat(this.trackId,"] video-status change ").concat(this._videoState," => ").concat(e)),this._videoState=e,null===(t=this.onVideoStateChanged)||void 0===t||t.call(this,this.videoState))}constructor(e){this.trackId=void 0,this.config=void 0,this.onFirstVideoFrameDecoded=void 0,this.onVideoStateChanged=void 0,this.freezeTimeCounterList=[],this.renderFreezeAccTime=0,this.isKeepLastFrame=!1,this.timeUpdatedCount=0,this.freezeTime=0,this.playbackTime=0,this.lastTimeUpdatedTime=0,this.autoplayFailed=!1,this.videoTrack=void 0,this.videoElement=void 0,this.cacheVideoElement=void 0,this._videoState=Ox.VideoStateStopped,this.videoElementCheckInterval=void 0,this.videoElementFreezeTimeout=void 0,this._videoElementStatus=Dx.NONE,this.isGettingVideoDimensions=!1,this.startGetVideoDimensions=()=>{const e=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return EL.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(e,500)};!this.isGettingVideoDimensions&&e()},this.autoResumeAfterInterruption=()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&"running"===Gx.curState&&(EL.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(oO())),_O()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))},this.handleVideoEvents=e=>{switch(e.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=Dx.PLAYING;break;case"loadeddata":if(this.videoState=Ox.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch(e){}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Dx.CANPLAY;break;case"stalled":this.videoElementStatus=Dx.STALLED;break;case"suspend":this.videoElementStatus=Dx.SUSPEND;break;case"pause":this.videoElementStatus=Dx.PAUSED,hO()||gO()||dO()&&this.autoplayFailed||!this.videoTrack||"live"!==this.videoTrack.readyState||(EL.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Dx.WAITING;break;case"abort":this.videoElementStatus=Dx.ABORT;break;case"ended":this.videoElementStatus=Dx.ENDED;break;case"emptied":this.videoElementStatus=Dx.EMPTIED;break;case"error":{this.videoElementStatus=Dx.ERROR;const e=this.videoElement.error;e&&EL.error("[".concat(this.trackId,"] media error, code: ").concat(e.code,", message: ").concat(e.message));break}case"timeupdate":{const e=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=e);const t=e-this.lastTimeUpdatedTime,i=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=e,uB.lastVisibleTime<uB.lastHiddenTime||i<uB.lastHiddenTime||i<uB.lastVisibleTime)return;for(t>JN("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=t),this.playbackTime+=t;this.playbackTime>=6e3;){this.playbackTime-=6e3;const e=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(e),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}},this.autoResumeAfterInterruptionOnIOS15_16=()=>{this.videoTrack&&"live"===this.videoTrack.readyState&&(EL.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(oO())),_O()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))},this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),Gx.on(sx.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Gx.on(sx.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return null!==(e=this.videoElement.parentElement)&&void 0!==e?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){const t=this.videoElement.play();t&&t.catch&&t.catch((t=>{e&&cF(e,"video",t.message,this.trackId),"NotAllowedError"===t.name?(EL.warning("detected video element autoplay failed",t),this.autoplayFailed=!0,this.handleAutoPlayFailed()):EL.warning("[".concat(this.trackId,"] play warning: "),t)}));const i=sO();if(("Safari"===i.name&&15===Number(i.version)||mO())&&t&&t.then){const e=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};t.then(e).catch(e)}}getCurrentFrame(){const e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;const t=e.getContext("2d");if(!t)return EL.error("create canvas context failed!"),new ImageData(2,2);t.drawImage(this.videoElement,0,0,e.width,e.height);const i=t.getImageData(0,0,e.width,e.height);return e.remove(),i}async getCurrentFrameToUint8Array(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const n=i.getContext("2d");return n?(n.drawImage(this.videoElement,0,0,i.width,i.height),new Promise(((n,s)=>{i.toBlob((async e=>{if(i.remove(),e){const t=await dV(e);n({buffer:t,width:i.width,height:i.height})}else s(new CO(yO.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,t<0?.1:t>1?1:t)}))):await cV(e)}destroy(){Gx.off(sx.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Gx.off(sx.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Ox.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Dx.INIT,!this.videoElementCheckInterval&&(hV.forEach((e=>{this.videoElement.addEventListener(e,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{(function(e){return e!==document.body&&document.body.contains(e)})(this.videoElement)||(this.videoElementStatus=Dx.DESTROYED)}),1e3),JN("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,t;let i;const n=()=>{"visible"===document.visibilityState&&(document.removeEventListener("visibilitychange",n),this.videoElementFreezeTimeout=window.setTimeout(s,JN("VIDEO_FREEZE_DURATION")))},s=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Ox.VideoStateDecoding&&("visible"===document.visibilityState?this.videoState=Ox.VideoStateFrozen:document.addEventListener("visibilitychange",n))},r=(e,t)=>{if(this.videoElementStatus===Dx.PLAYING){if(i){const e=t.presentationTime-i.presentationTime;this.videoState===Ox.VideoStateStarting&&(this.videoState=Ox.VideoStateDecoding),this.videoState===Ox.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(s,JN("VIDEO_FREEZE_DURATION"))),e<JN("VIDEO_FREEZE_DURATION")&&this.videoState===Ox.VideoStateFrozen&&(this.videoState=Ox.VideoStateDecoding),e>JN("VIDEO_FREEZE_DURATION")&&uB.lastVisibleTime>=uB.lastHiddenTime&&i.timestamp>uB.lastVisibleTime&&i.timestamp>uB.lastHiddenTime&&(this.renderFreezeAccTime+=e)}i=kx(kx({},t),{},{timestamp:e})}var n,o;JN("ENABLE_VIDEO_FRAME_CALLBACK")&&(null===(n=(o=this.videoElement).requestVideoFrameCallback)||void 0===n||n.call(o,r))};null===(e=(t=this.videoElement).requestVideoFrameCallback)||void 0===e||e.call(t,r)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),vO()&&(this.videoElement.poster="noposter");const i=sO();"Safari"===i.name&&15===Number(i.version)||mO()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,lO()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,lO()&&this.videoElement.load());const n=this.videoElement.play();void 0!==n&&n.catch((e=>{EL.debug("[".concat(this.trackId,"] playback interrupted"),e.toString())}))}resetVideoElement(){hV.forEach((e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=Dx.NONE}handleAutoPlayFailed(){const e=t=>{t.preventDefault(),this.videoElement.play().then((()=>{EL.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((e=>{EL.error(e)})),this.autoplayFailed=!1,RO()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};RO()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),aF()}};const hV=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];let uV=class extends lV{constructor(e){super(e),this.container=void 0,this.slot=void 0,this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;const t=e.element;t!==this.slot&&(this.destroy(),this.slot=t),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var t;null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(e){var t;let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return null!==(t=this.container)&&void 0!==t&&t.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(e,i):await cV(e)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch(e){}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",JN("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if(null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch(e){}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;null!==(e=this.container)&&void 0!==e&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}};function pV(e){return new Promise(((t,i)=>{let n=!1;const s=document.createElement("video");s.setAttribute("autoplay",""),s.setAttribute("muted",""),s.muted=!0,s.autoplay=!0,s.setAttribute("playsinline",""),s.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(s);const r=hO()?"canplay":"playing";s.addEventListener(r,(()=>{const e=s.videoWidth,i=s.videoHeight;!e&&lO()||(n=!0,s.srcObject=null,s.remove(),t([e,i]))})),s.srcObject=new MediaStream([e]),s.play().catch(IN),setTimeout((()=>{n||(s.srcObject=null,s.remove(),t([s.videoWidth,s.videoHeight]))}),4e3)}))}const fV=async(e,t,i)=>await(async(e,t,i)=>{const n=function(e){const t=[];for(let i=0;i<e.length;i+=2)t.push(parseInt(e.slice(i,i+2),16));return Uint8Array.from(t)}(function(e){const t="0123456789abcdef";function i(e){let i,n="";for(i=0;i<=3;i++)n+=t.charAt(e>>8*i+4&15)+t.charAt(e>>8*i&15);return n}function n(e,t){const i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function s(e,t,i,s,r,o){return n(function(e,t){return e<<t|e>>>32-t}(n(n(t,e),n(s,o)),r),i)}function r(e,t,i,n,r,o,a){return s(t&i|~t&n,e,t,r,o,a)}function o(e,t,i,n,r,o,a){return s(t&n|i&~n,e,t,r,o,a)}function a(e,t,i,n,r,o,a){return s(t^i^n,e,t,r,o,a)}function c(e,t,i,n,r,o,a){return s(i^(t|~n),e,t,r,o,a)}const d=function(e){let t;const i=1+(e.length+8>>6),n=new Array(16*i);for(t=0;t<16*i;t++)n[t]=0;for(t=0;t<e.length;t++)n[t>>2]|=e.charCodeAt(t)<<t%4*8;return n[t>>2]|=128<<t%4*8,n[16*i-2]=8*e.length,n}(e);let l,h,u,p,f,m=1732584193,E=-271733879,_=-1732584194,g=271733878;for(l=0;l<d.length;l+=16)h=m,u=E,p=_,f=g,m=r(m,E,_,g,d[l+0],7,-680876936),g=r(g,m,E,_,d[l+1],12,-389564586),_=r(_,g,m,E,d[l+2],17,606105819),E=r(E,_,g,m,d[l+3],22,-1044525330),m=r(m,E,_,g,d[l+4],7,-176418897),g=r(g,m,E,_,d[l+5],12,1200080426),_=r(_,g,m,E,d[l+6],17,-1473231341),E=r(E,_,g,m,d[l+7],22,-45705983),m=r(m,E,_,g,d[l+8],7,1770035416),g=r(g,m,E,_,d[l+9],12,-1958414417),_=r(_,g,m,E,d[l+10],17,-42063),E=r(E,_,g,m,d[l+11],22,-1990404162),m=r(m,E,_,g,d[l+12],7,1804603682),g=r(g,m,E,_,d[l+13],12,-40341101),_=r(_,g,m,E,d[l+14],17,-1502002290),E=r(E,_,g,m,d[l+15],22,1236535329),m=o(m,E,_,g,d[l+1],5,-165796510),g=o(g,m,E,_,d[l+6],9,-1069501632),_=o(_,g,m,E,d[l+11],14,643717713),E=o(E,_,g,m,d[l+0],20,-373897302),m=o(m,E,_,g,d[l+5],5,-701558691),g=o(g,m,E,_,d[l+10],9,38016083),_=o(_,g,m,E,d[l+15],14,-660478335),E=o(E,_,g,m,d[l+4],20,-405537848),m=o(m,E,_,g,d[l+9],5,568446438),g=o(g,m,E,_,d[l+14],9,-1019803690),_=o(_,g,m,E,d[l+3],14,-187363961),E=o(E,_,g,m,d[l+8],20,1163531501),m=o(m,E,_,g,d[l+13],5,-1444681467),g=o(g,m,E,_,d[l+2],9,-51403784),_=o(_,g,m,E,d[l+7],14,1735328473),E=o(E,_,g,m,d[l+12],20,-1926607734),m=a(m,E,_,g,d[l+5],4,-378558),g=a(g,m,E,_,d[l+8],11,-2022574463),_=a(_,g,m,E,d[l+11],16,1839030562),E=a(E,_,g,m,d[l+14],23,-35309556),m=a(m,E,_,g,d[l+1],4,-1530992060),g=a(g,m,E,_,d[l+4],11,1272893353),_=a(_,g,m,E,d[l+7],16,-155497632),E=a(E,_,g,m,d[l+10],23,-1094730640),m=a(m,E,_,g,d[l+13],4,681279174),g=a(g,m,E,_,d[l+0],11,-358537222),_=a(_,g,m,E,d[l+3],16,-722521979),E=a(E,_,g,m,d[l+6],23,76029189),m=a(m,E,_,g,d[l+9],4,-640364487),g=a(g,m,E,_,d[l+12],11,-421815835),_=a(_,g,m,E,d[l+15],16,530742520),E=a(E,_,g,m,d[l+2],23,-995338651),m=c(m,E,_,g,d[l+0],6,-198630844),g=c(g,m,E,_,d[l+7],10,1126891415),_=c(_,g,m,E,d[l+14],15,-1416354905),E=c(E,_,g,m,d[l+5],21,-57434055),m=c(m,E,_,g,d[l+12],6,1700485571),g=c(g,m,E,_,d[l+3],10,-1894986606),_=c(_,g,m,E,d[l+10],15,-1051523),E=c(E,_,g,m,d[l+1],21,-2054922799),m=c(m,E,_,g,d[l+8],6,1873313359),g=c(g,m,E,_,d[l+15],10,-30611744),_=c(_,g,m,E,d[l+6],15,-1560198380),E=c(E,_,g,m,d[l+13],21,1309151649),m=c(m,E,_,g,d[l+4],6,-145523070),g=c(g,m,E,_,d[l+11],10,-1120210379),_=c(_,g,m,E,d[l+2],15,718787259),E=c(E,_,g,m,d[l+9],21,-343485551),m=n(m,h),E=n(E,u),_=n(_,p),g=n(g,f);return i(m)+i(E)+i(_)+i(g)}(""+t+i)).slice(0,16),s=n.slice(0,12),r=await window.crypto.subtle.importKey("raw",n,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:s},r,e))})(e.buffer,t,i);var mV,EV,_V,gV,TV,SV,vV,RV,yV,CV,IV,AV,bV,wV,DV,OV,NV,LV,PV,kV,MV,UV,xV,FV,VV,BV,GV,jV,WV,HV,KV,YV,qV,$V,zV;let XV=(mV=yL({argsMap:(e,t,i)=>[e.getTrackId(),"string"==typeof t?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),EV=hF(),_V=yL({argsMap:e=>[e.getTrackId()]}),gV=kN("LocalVideoTrack","_enabledMutex"),TV=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),SV=hF(),vV=kN("LocalVideoTrack","_enabledMutex"),RV=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),yV=hF(),CV=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),IV=hF(),AV=hF(),bV=yL({argsMap:(e,t,i)=>[e.getTrackId(),t,i]}),wV=hF(),DV=hF(),OV=hF(),NV=hF(),LV=hF(),PV=hF(),kV=hF(),MV=yL({argsMap:(e,t)=>[e.getTrackId(),t.name]}),UV=yL({argsMap:e=>[e.getTrackId()]}),xV=yL({argsMap:e=>[e.getTrackId()]}),FV=yL({argsMap:(e,t,i)=>[e.getTrackId(),t.label,i]}),VV=yL(),BV=class e extends Fx{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Dx.PLAYING)}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,t,i,n,s,r){if(super(e,s),this.trackMediaType="video",this._player=void 0,this.isUseScaleResolutionDownBy=!1,this._videoVisibleTimer=null,this._statsTimer=null,this._previousVideoVisibleStatus=void 0,this._clearPreviousVideoVisibleStatus=()=>this._previousVideoVisibleStatus=void 0,this._encoderConfig=void 0,this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1},this._optimizationMode=void 0,this._videoHeight=void 0,this._videoWidth=void 0,this._forceBitrateLimit=void 0,this._enabled=!0,this.processorDestination=void 0,this._processorContext=void 0,dO()){const{width:t,height:i}=e.getSettings();this._videoWidth=t,this._videoHeight=i}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=t,this._scalabilityMode=i,this._optimizationMode=n,this._hints=r||[],-1===this._hints.indexOf(fx.SCREEN_TRACK))this.updateBitrateFromProfile();else if(function(e,t,i){const n=sO();return!(n.name!==e||!n.osVersion)&&(i?Number(n.version)>=t&&Number(n.version)<=i:Number(n.version)===t)}(eO.CHROME,115)&&-1!==rO().indexOf("Windows")){const t=function(e,t){if("VideoFrame"in window&&"TransformStream"in window&&nx().supportWebRTCInsertableStream){const i=new MediaStreamTrackProcessor(e),n=new MediaStreamTrackGenerator({kind:"video"});let s,r,o=Date.now();const a=()=>{c&&(clearInterval(c),c=void 0),s&&(s.close(),s=void 0),e.stop(),r=void 0,n.removeEventListener("ended",a)};let c=window.setInterval((()=>{if(r&&s&&Date.now()-o>(null!=t?t:1e3))try{"live"===n.readyState?r.enqueue(s.clone()):a()}catch(e){a()}}),null!=t?t:1e3);const d=new TransformStream({transform:(e,t)=>{"live"===n.readyState?(r=t,o=Date.now(),void 0===s?(s=e,t.enqueue(e.clone())):(t.enqueue(s),s=e)):e.close()}});return n.addEventListener("ended",a),i.readable.pipeThrough(d).pipeTo(n.writable),n}}(e);t&&(EL.info("local screen video track begin to inject frame"),this._mediaStreamTrack=t)}t&&-1!==this._hints.indexOf(fx.CUSTOM_TRACK)&&this.setEncoderConfiguration(t),this._processorContext=new pF(this.getTrackId(),"local"),this.processorDestination=new uF(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const t=document.getElementById(e);t?e=t:(EL.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}EL.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const i=kx(kx(kx({},this._getDefaultPlayerConfig()),t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new lV(i):this._player=new uV(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const e=this.getVideoElementVisibleStatus();this.safeEmit(_x.VIDEO_ELEMENT_VISIBLE_STATUS,e)}catch(e){}}),JN("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,EL.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(EL.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{await iN(this,px.NEED_DISABLE_TRACK,this)}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}return t||(this._enabled=!1),void EL.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await iN(this,px.NEED_ENABLE_TRACK,this)}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setEnabled to true error"),e.toString()),e}EL.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,EL.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await iN(this,px.NEED_MUTE_TRACK,this):await iN(this,px.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(e,t){if(!this._enabled)throw new CO(yO.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if("720p_auto"===e?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=dx(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){const t=aV({encoderConfig:e});(dO()||hO()||gO())&&(t.deviceId=void 0),EL.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(t));try{await this._originMediaStreamTrack.applyConstraints(t),this.updateMediaStreamTrackResolution()}catch(e){const t=new CO(yO.UNEXPECTED_ERROR,e.toString());throw EL.error("[".concat(this.getTrackId(),"] applyConstraints error"),t.toString()),t}}this._encoderConfig=e,-1===this._hints.indexOf(fx.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await iN(this,px.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(EL)}}getStats(){mN((()=>{EL.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning");return nN(this,px.GET_STATS)||kx({},vx)}async setBeautyEffect(e){EL.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,t):await cV(e)}async setBitrateLimit(e){if(EL.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e){this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate);try{await iN(this,px.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(EL)}}}async setOptimizationMode(e){if("motion"!==e&&"detail"!==e&&"balanced"!==e)return void EL.error(yO.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const t=this._optimizationMode;try{this._optimizationMode=e,await iN(this,px.SET_OPTIMIZATION_MODE,this)}catch(e){throw this._optimizationMode=t,EL.error("[".concat(this.getTrackId(),"] set optimization mode failed"),e.toString()),e}EL.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))}setScalabiltyMode(e){if(1===e.numSpatialLayers&&1!==e.numTemporalLayers)return EL.error(yO.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,EL.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){pV(this._originMediaStreamTrack).then((e=>{let[t,i]=e;this._videoHeight=i,this._videoWidth=t})).catch(IN)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(e){if(!this._enabled)throw new CO(yO.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");EL.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=dx(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,-1===this._hints.indexOf(fx.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await iN(this,px.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(EL)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:e,height:t,frameRate:i}=this.getMediaStreamTrackSettings();if(!e||!t||!i)return;const{bitrateMax:n,bitrateMin:s}=this._encoderConfig;if(null==s||null==n){const{max:r,min:o}=function(e,t,i,n,s){const r=JN("BITRATE_ADAPTER_TYPE");if("DEFAULT_BITRATE"===r)return{min:n,max:s};if(void 0===s){var o;const a=Math.floor(200*Math.pow(i/15,.6)*Math.pow(e*t/640/360,.75));s="STANDARD_BITRATE"===r?4*a:2*a,n=null!==(o=n)&&void 0!==o?o:a}else{var a;n=null!==(a=n)&&void 0!==a?a:Math.floor(s/10)}return{min:n,max:s}}(e,t,i,s,n);this._encoderConfig.bitrateMin=o,this._encoderConfig.bitrateMax=r,EL.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(t,", fps: ").concat(i,"] => [brMax: ").concat(r,", brMin: ").concat(o,"]"))}}getVideoElementVisibleStatus(){try{var e,t;const i=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),n={track:this,element:null==this||null===(t=this._player)||void 0===t?void 0:t.getVideoElement(),slot:null==i?void 0:i.parentElement},{element:s,slot:r}=n;if(this.isPlaying&&s instanceof HTMLVideoElement&&r instanceof HTMLElement){const e=xO.checkOneElementVisible(s),t=Object.assign({},e);if(t.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=t.visible;const e=CL.reportApiInvoke(null,{tag:KO.TRACER,name:HO.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});t.visible?e.onSuccess("Video is visible"):e.onSuccess("Invisible because of ".concat(t.reason))}return t}return}catch(e){throw new CO(yO.GET_VIDEO_ELEMENT_VISIBLE_ERROR,e.message)}}async renewMediaStreamTrack(e){}pipe(e){if(this.processor===e)return e;if(e._source)throw new CO(yO.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._encoderConfig;t&&(n=kx(kx({},n),dx(t))),n=pN(n);const s=yN(8,"track-video-cloned-"),r=new e(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,n,pN(this._scalabilityMode),this._optimizationMode,s,pN(this._hints));return t&&n&&r.setEncoderConfiguration(n),EL.debug("clone video track from ".concat(this.getTrackId()," to ").concat(s,", clone ").concat(i)),r}async replaceTrack(e,t){if(!(e instanceof MediaStreamTrack))throw new CO(yO.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if("video"!==e.kind)throw new CO(yO.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(e,t,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!dO()&&!hO())return;this._statsTimer&&window.clearInterval(this._statsTimer);let e=2,t=cx[e],i=-1,n=Date.now();const s=e=>{e>2||e<0||(n=Date.now(),t=cx[e],this.setSenderConfiguration(t))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval((()=>{const r=this.getStats(),o=nN(this,px.GET_RTC_STATS);if(r.sendPackets>0&&o){-1===i&&(i=Date.now());const a=Date.now();if(a-i<1e3||a-n<JN("PROFILE_SWITCH_INTERVAL"))return;const c=r.sendFrameRate,d=.6*t.frameRate,l=.9*t.frameRate;"number"==typeof c&&c>0&&c<d?e>0&&(e--,s(e),EL.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(c,", switchProfile to ").concat(e))):o.OutgoingAvailableBandwidth<t.bitrateMin?e>0&&(e--,s(e),EL.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(o.OutgoingAvailableBandwidth,", bitrateMin ").concat(t.bitrateMin,", switchProfile to ").concat(e))):"number"==typeof c&&c>l&&e<cx.length-1&&o.OutgoingAvailableBandwidth>1.2*cx[e+1].bitrateMin&&(e++,s(e),EL.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(c,", OutgoingAvailableBandwidth ").concat(o.OutgoingAvailableBandwidth,", switchProfile to ").concat(e)))}}),JN("CHECK_LOCAL_STATS_INTERVAL"))}sendSeiData(e){if(mN((()=>{CL.reportApiInvoke(null,{name:HO.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:KO.TRACER}).onSuccess("")}),this._mediaStreamTrack.id||this.getTrackId()),!JN("ENABLE_VIDEO_SEI")||!JN("ENABLE_ENCODED_TRANSFORM"))return void EL.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new CO(yO.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const t=this.getRTCRtpTransceiver();if(!t)return void EL.warning("Video track is not published, SEI can not be send");const i=t.sender.getParameters();if(0===i.codecs.length)return;const n=i.codecs[0].mimeType.toLocaleLowerCase();"video/h264"===n?this.safeEmit("sei-to-send",e):EL.warning("SEI is not supported by ".concat(n))}bindProcessorDestinationEvents(){this.processorDestination.on(Ix.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),await iN(this,px.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await iN(this,px.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Ix.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Ax.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Ax.REQUEST_CONSTRAINTS)}},Ux(BV.prototype,"play",[mV,EV],Object.getOwnPropertyDescriptor(BV.prototype,"play"),BV.prototype),Ux(BV.prototype,"stop",[_V],Object.getOwnPropertyDescriptor(BV.prototype,"stop"),BV.prototype),Ux(BV.prototype,"setEnabled",[gV,TV,SV],Object.getOwnPropertyDescriptor(BV.prototype,"setEnabled"),BV.prototype),Ux(BV.prototype,"setMuted",[vV,RV,yV],Object.getOwnPropertyDescriptor(BV.prototype,"setMuted"),BV.prototype),Ux(BV.prototype,"setEncoderConfiguration",[CV,IV],Object.getOwnPropertyDescriptor(BV.prototype,"setEncoderConfiguration"),BV.prototype),Ux(BV.prototype,"getStats",[AV],Object.getOwnPropertyDescriptor(BV.prototype,"getStats"),BV.prototype),Ux(BV.prototype,"setBeautyEffect",[bV,wV],Object.getOwnPropertyDescriptor(BV.prototype,"setBeautyEffect"),BV.prototype),Ux(BV.prototype,"getCurrentFrameData",[DV],Object.getOwnPropertyDescriptor(BV.prototype,"getCurrentFrameData"),BV.prototype),Ux(BV.prototype,"getCurrentFrameImage",[OV],Object.getOwnPropertyDescriptor(BV.prototype,"getCurrentFrameImage"),BV.prototype),Ux(BV.prototype,"setBitrateLimit",[NV],Object.getOwnPropertyDescriptor(BV.prototype,"setBitrateLimit"),BV.prototype),Ux(BV.prototype,"setOptimizationMode",[LV],Object.getOwnPropertyDescriptor(BV.prototype,"setOptimizationMode"),BV.prototype),Ux(BV.prototype,"setScalabiltyMode",[PV],Object.getOwnPropertyDescriptor(BV.prototype,"setScalabiltyMode"),BV.prototype),Ux(BV.prototype,"updateMediaStreamTrackResolution",[kV],Object.getOwnPropertyDescriptor(BV.prototype,"updateMediaStreamTrackResolution"),BV.prototype),Ux(BV.prototype,"pipe",[MV],Object.getOwnPropertyDescriptor(BV.prototype,"pipe"),BV.prototype),Ux(BV.prototype,"unpipe",[UV],Object.getOwnPropertyDescriptor(BV.prototype,"unpipe"),BV.prototype),Ux(BV.prototype,"close",[xV],Object.getOwnPropertyDescriptor(BV.prototype,"close"),BV.prototype),Ux(BV.prototype,"replaceTrack",[FV],Object.getOwnPropertyDescriptor(BV.prototype,"replaceTrack"),BV.prototype),Ux(BV.prototype,"startMonitorStats",[VV],Object.getOwnPropertyDescriptor(BV.prototype,"startMonitorStats"),BV.prototype),BV);var JV,QV,ZV,eB,tB,iB,nB,sB,rB,oB,aB,cB;GV=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),jV=hF(),WV=kN("CameraVideoTrack","_enabledMutex"),HV=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),KV=hF(),YV=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),qV=hF(),$V=yL({argsMap:e=>[e.getTrackId()]}),zV=class e extends XV{get __className__(){return"CameraVideoTrack"}constructor(e,t,i,n,s,r){super(e,dx(t.encoderConfig),n,s,r),this._config=void 0,this._originalConstraints=void 0,this._constraints=void 0,this._enabled=!0,this._deviceName="default",this.tryResumeVideoForIOS15_16WeChat=async()=>{(mO()||EO())&&!function(){const e=sO();if(e.os!==ZD.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return 15===Number(t[0])&&Number(t[1])>=2}()&&TO()&&this._enabled&&!this._isClosed&&(EL.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())},this._config=t,this._originalConstraints=i,this._constraints=i,this._deviceName=e.label,this._encoderConfig=dx(this._config.encoderConfig),Gx.on(sx.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Gx.on(sx.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(e){return"string"==typeof e?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0}async _setDeviceById(e){if(EL.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{const t=await sF.getDeviceById(e),i={};i.video=kx({},this._constraints),i.video.deviceId={exact:e},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let n=null;try{n=await eF(i,this.getTrackId())}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setDevice failed"),e.toString()),n=await eF({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),e}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}else try{const t=await sF.getDeviceById(e);this._deviceName=t.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setDevice error"),e.toString()),e}EL.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(e){EL.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));const t={video:kx(kx({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let e=null;try{e=await eF(t,this.getTrackId())}catch(t){throw EL.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),t.toString()),e=await eF({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1),t}await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=kx({},t.video),EL.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(e,t){if(!t){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(EL.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const e=await eF({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!1)}await iN(this,px.NEED_ENABLE_TRACK,this)}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setEnabled true error"),e.toString()),e}this.updateMediaStreamTrackResolution(),EL.info("[".concat(this.getTrackId(),"] setEnabled to true success")),t||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),t||(this._enabled=!1);try{await iN(this,px.NEED_DISABLE_TRACK,this)}catch(e){throw EL.error("[".concat(this.getTrackId(),"] setEnabled to false error"),e.toString()),e}EL.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(e,t){if(!this._enabled)throw new CO(yO.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");"720p_auto"===e?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),e=dx(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin);const i=uN(this._config);i.encoderConfig=e;const n=aV(i);(dO()||hO()||gO())&&(n.deviceId=void 0),EL.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(e){const t=new CO(yO.UNEXPECTED_ERROR,e.toString());throw EL.error("[".concat(this.getTrackId(),"] applyConstraints error"),t.toString()),t}this._config=i,this._constraints=n,this._originalConstraints=n,this._encoderConfig=e,-1===this._hints.indexOf(fx.SCREEN_TRACK)&&this.updateBitrateFromProfile();try{await iN(this,px.NEED_UPDATE_VIDEO_ENCODER,this)}catch(e){return e.throw(EL)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((hO()||gO())&&this._enabled&&!this._isClosed&&Gx.duringInterruption){const e=async()=>{Gx.off(sx.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(EL.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Gx.on(sx.IOS_INTERRUPTION_END,e)}else EL.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(_x.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,i=sF.searchDeviceIdByName(this._deviceName);if(i&&!t.deviceId&&(t.deviceId={exact:i}),this._enabled){const e=await eF({video:t},this.getTrackId());this._constraints=t,await this._updateOriginMediaStreamTrack(e.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Gx.off(sx.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Gx.off(sx.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this._encoderConfig;t&&(n=kx(kx({},n),dx(t))),n=pN(n);const s=yN(8,"track-cam-cloned-"),r=new e(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,pN(kx(kx({},this._config),{},{encoderConfig:n})),pN(this._constraints),pN(this._scalabilityMode),this._optimizationMode,s);return t&&n&&r.setEncoderConfiguration(n),EL.debug("clone track from ".concat(this.getTrackId()," to ").concat(s,", clone ").concat(i)),r}bindProcessorContextEvents(){this.processorContext.on(Ax.REQUEST_UPDATE_CONSTRAINTS,(async(e,t,i)=>{try{const i=Object.assign({},this._originalConstraints,...e);await this.renewMediaStreamTrack(i),t()}catch(e){i(e)}})),this.processorContext.on(Ax.REQUEST_CONSTRAINTS,(async e=>{e(this._originMediaStreamTrack.getSettings())}))}},Ux(zV.prototype,"setDevice",[GV,jV],Object.getOwnPropertyDescriptor(zV.prototype,"setDevice"),zV.prototype),Ux(zV.prototype,"setEnabled",[WV,HV,KV],Object.getOwnPropertyDescriptor(zV.prototype,"setEnabled"),zV.prototype),Ux(zV.prototype,"setEncoderConfiguration",[YV,qV],Object.getOwnPropertyDescriptor(zV.prototype,"setEncoderConfiguration"),zV.prototype),Ux(zV.prototype,"close",[$V],Object.getOwnPropertyDescriptor(zV.prototype,"close"),zV.prototype);let dB=class extends xx{getUserId(){return this._userId}constructor(e,t,i,n){super(e,"track-".concat(e.kind,"-").concat(t,"-").concat(n.clientId,"_").concat(yN(5,""))),this._userId=void 0,this._uintId=void 0,this._isDestroyed=!1,this.store=void 0,this.processor=void 0,this.processorContext=void 0,this._userId=t,this._uintId=i,this.store=n}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,EL.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}},lB=(JV=yL({argsMap:(e,t,i)=>[e.getTrackId(),"string"==typeof t?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),QV=yL({argsMap:e=>[e.getTrackId()]}),ZV=yL({argsMap:(e,t)=>[e.getTrackId(),t.name]}),eB=yL({argsMap:e=>[e.getTrackId()]}),Ux((tB=class extends dB{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Dx.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,i,n){super(e,t,i,n),this._videoVisibleTimer=null,this._previousVideoVisibleStatus=void 0,this._clearPreviousVideoVisibleStatus=()=>this._previousVideoVisibleStatus=void 0,this.trackMediaType="video",this._videoWidth=void 0,this._videoHeight=void 0,this._player=void 0,this.processorDestination=void 0,this.processorContext=void 0,this.updateMediaStreamTrackResolution(),this.processorContext=new pF(this.getTrackId(),"remote"),this.processorDestination=new uF(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return mN((()=>{EL.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),nN(this,px.GET_STATS)||kx({},Cx)}play(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof e){const t=document.getElementById(e);t?e=t:(EL.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}EL.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const i=kx(kx({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new lV(i):this._player=new uV(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(gx.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=e=>{this.safeEmit(gx.VIDEO_STATE_CHANGED,e)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const e=this.getVideoElementVisibleStatus();this.safeEmit(gx.VIDEO_ELEMENT_VISIBLE_STATUS,e)}catch(e){}}),JN("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,EL.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){pV(this._originMediaStreamTrack).then((e=>{let[t,i]=e;this._videoHeight=i,this._videoWidth=t})).catch(IN)}_updatePlayerSource(){EL.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const i=null==this||null===(e=this._player)||void 0===e?void 0:e.getContainerElement(),n={track:this,element:null==this||null===(t=this._player)||void 0===t?void 0:t.getVideoElement(),slot:null==i?void 0:i.parentElement},{element:s,slot:r}=n;if(this.isPlaying&&s instanceof HTMLVideoElement&&r instanceof HTMLElement){const e=xO.checkOneElementVisible(s),t=Object.assign({},e);if(t.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=t.visible;const e=CL.reportApiInvoke(null,{tag:KO.TRACER,name:HO.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});t.visible?e.onSuccess("Video is visible"):e.onSuccess("Invisible because of ".concat(t.reason))}return t}return}catch(e){throw new CO(yO.GET_VIDEO_ELEMENT_VISIBLE_ERROR,e.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new CO(yO.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Ix.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Ix.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(Ex.SEI_RECEIVED,e)}}).prototype,"play",[JV],Object.getOwnPropertyDescriptor(tB.prototype,"play"),tB.prototype),Ux(tB.prototype,"stop",[QV],Object.getOwnPropertyDescriptor(tB.prototype,"stop"),tB.prototype),Ux(tB.prototype,"pipe",[ZV],Object.getOwnPropertyDescriptor(tB.prototype,"pipe"),tB.prototype),Ux(tB.prototype,"unpipe",[eB],Object.getOwnPropertyDescriptor(tB.prototype,"unpipe"),tB.prototype),tB),hB=(iB=yL({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),nB=yL({argsMap:(e,t)=>[e.getTrackId(),t]}),sB=yL({argsMap:e=>[e.getTrackId()]}),rB=yL({argsMap:e=>[e.getTrackId()]}),oB=yL({argsMap:(e,t)=>[e.getTrackId(),t.name]}),aB=yL({argsMap:e=>[e.getTrackId()]}),Ux((cB=class extends dB{get isPlaying(){return this._useAudioElement?lF.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,i,n){super(e,t,i,n),this.trackMediaType="audio",this._source=void 0,this._useAudioElement=!0,this._volume=100,this.processorContext=void 0,this.processorDestination=void 0,this._played=!1,this._bypassWebAudio=!1,JN("DISABLE_WEBAUDIO")?(this._source=new EF,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new $x(e,!0),JN("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Tx.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(gx.FIRST_FRAME_DECODED)})),this.processorContext=new mF(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new fF(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Tx.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Tx.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Tx.ON_AUDIO_BUFFER),this._source.on(Tx.ON_AUDIO_BUFFER,(t=>e(t)))}setVolume(e){this._volume=e,this._useAudioElement?lF.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!cO()&&JN("RESTRICTION_SET_PLAYBACK_DEVICE"))throw new CO(yO.NOT_SUPPORTED,"your browser does not support setting the audio output device");await lF.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return mN((()=>{EL.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),nN(this,px.GET_STATS)||kx({},Rx)}play(){EL.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(EL.debug("[".concat(this.getTrackId(),"] use audio element to play")),lF.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){EL.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?lF.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];EL.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&lF.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new CO(yO.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new CO(yO.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new CO(yO.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;null===(e=this._source.processSourceNode)||void 0===e||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Ix.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(Ix.ON_NODE,(e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Ix.ON_TRACK),this.processorDestination.removeAllListeners(Ix.ON_NODE)}}).prototype,"setVolume",[iB],Object.getOwnPropertyDescriptor(cB.prototype,"setVolume"),cB.prototype),Ux(cB.prototype,"setPlaybackDevice",[nB],Object.getOwnPropertyDescriptor(cB.prototype,"setPlaybackDevice"),cB.prototype),Ux(cB.prototype,"play",[sB],Object.getOwnPropertyDescriptor(cB.prototype,"play"),cB.prototype),Ux(cB.prototype,"stop",[rB],Object.getOwnPropertyDescriptor(cB.prototype,"stop"),cB.prototype),Ux(cB.prototype,"pipe",[oB],Object.getOwnPropertyDescriptor(cB.prototype,"pipe"),cB.prototype),Ux(cB.prototype,"unpipe",[aB],Object.getOwnPropertyDescriptor(cB.prototype,"unpipe"),cB.prototype),cB);const uB=new class extends GO{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),this._lastHiddenTime=0,this._lastVisibleTime=0,document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),EL.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}};var pB=function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e}(pB||{});let fB=class extends GO{constructor(e,t){super(),this._version=1,this._type=3,this._config=void 0,this._originDataChannel=void 0,this._dataStreamPacketHeader=new ArrayBuffer(4),this._dataStreamPacketHandler=void 0,this._datachannelEventMap=new Map,this._config=e,t&&(this._originDataChannel=t,this._bandDataChannelEvents(t)),this._initPacketHeader(),this._dataStreamPacketHandler=new class{constructor(){this._sequence=0,this._startTime=Date.now(),this.isUseOneByte=!0}get startTime(){const e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){const t={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){const i=new Uint8Array(4);i.set([1,0,0,0]);const n={id:0,length:4,data:i.buffer},s={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[n]};t.commonPacketHeader.extension=1,t.extension=s,t.payload=this.compress(e),t.commonPacketHeader.length=8+(t.extension.length+2)+t.payload.byteLength}else t.commonPacketHeader.length=8+t.payload.byteLength;JN("SHOW_DATASTREAM2_LOG")&&EL.debug("send data header: ".concat(JSON.stringify(t.commonPacketHeader)));const i=new ArrayBuffer(t.commonPacketHeader.length),n=new Uint8Array(i),s=new DataView(i);let r=0;if(s.setUint16(r,t.commonPacketHeader.extension<<15|t.commonPacketHeader.reserved<<14|t.commonPacketHeader.length,!0),r+=2,s.setUint32(r,t.commonPacketHeader.sequence,!0),r+=4,s.setUint16(r,t.commonStreamHeader,!0),r+=2,t.extension){const e=this.serializeExtension(t.extension);n.set(new Uint8Array(e),r),r+=e.byteLength}if(n.set(new Uint8Array(t.payload),r),r+=t.payload.byteLength,r!==t.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);const t=new DataView(e);let i=0;const n=t.getUint16(i,!0);i+=2;const s={length:16383&n,reserved:(16384&n)>>14,extension:(32768&n)>>15,sequence:t.getUint16(i+2,!0)<<16|t.getUint16(i,!0)};let r,o;if(i+=4,JN("SHOW_DATASTREAM2_LOG")&&EL.debug("receive data header: ".concat(JSON.stringify(s))),t.getUint16(i,!0),i+=2,s.extension){o=this.deserializeExtension(e.slice(i)),i+=2+o.length,r=e.slice(i);let t=!1;if(o.datas.length>0){const e=o.datas.find((e=>0===e.id));e&&(t=1==(1&new DataView(e.data).getUint32(0,!0)))}r=t?this.decompress(r):r}else r=e.slice(8);return r}serializeExtension(e){const{profile:t,length:i,datas:n}=e,s=new ArrayBuffer(i+2),r=new Uint8Array(s),o=new DataView(s);let a=0;if(o.setUint8(a++,t),o.setUint8(a++,i),n.forEach((e=>{t?(o.setUint8(a++,e.id),o.setUint8(a++,e.length),r.set(new Uint8Array(e.data),a),a+=e.data.byteLength):(o.setUint8(a++,e.id|e.length<<4),r.set(new Uint8Array(e.data),a),a+=e.data.byteLength)})),a!==i+2)throw Error("serialize extension error, is ".concat(a,"!==").concat(i+2));return s}deserializeExtension(e){const t=new DataView(e);let i=0;const n=t.getUint8(i);i++;const s=t.getUint8(i);i++;const r=n===pB.TWO_BYTE,o=[],a=new DataView(e,2);let c=0;for(;c<s;){let e=0,t=0,i=new ArrayBuffer(0);r?(e=a.getUint8(c),c++,t=a.getUint8(c),c++):(e=15&a.getUint8(c),t=a.getUint8(c)>>4,c++),t>0&&(i=a.buffer.slice(c+2,c+2+t),c+=i.byteLength),o.push({id:e,length:t,data:i})}if(c!==s)throw Error("parse error");return{profile:n,length:s,datas:o}}decompress(e){return tx(new Uint8Array(e))}compress(e){return ex(new Uint8Array(e))}}}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return JN("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,t;return null!==(e=null===(t=this._originDataChannel)||void 0===t?void 0:t.readyState)&&void 0!==e?e:"connecting"}get _originDataChannelId(){var e,t;return null!==(e=null===(t=this._originDataChannel)||void 0===t?void 0:t.id)&&void 0!==e?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Promise(((e,t)=>{if(this._originDataChannel){"open"===this._originDataChannel.readyState&&e();const i=setTimeout((()=>{var e;t(new CO(yO.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat(null===(e=this._originDataChannel)||void 0===e?void 0:e.id)))}),1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new CO(yO.DATACHANNEL_CONNECTION_TIMEOUT)}}else t(new CO(yO.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))}))}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){const e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[Lx.OPEN,Lx.CLOSE,Lx.ERROR].forEach((t=>{const i=()=>{this.emit(t)};this._datachannelEventMap.set(t,i),e.addEventListener(t,i)}))}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach((t=>{let[i,n]=t;e.removeEventListener(i,n)})),this._datachannelEventMap.clear()}},mB=class extends fB{constructor(e){super(e),this._messageListener=void 0,this._messageListener=e=>{if(e.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const t=e.data.slice(0,this._dataStreamPacketHeader.byteLength),i=new DataView(t).getUint8(3);if(i!==this.id)return void(JN("SHOW_DATASTREAM2_LOG")&&EL.debug("invalid datachannel id: ".concat(i," !== ").concat(this.id)));let n=e.data.slice(this._dataStreamPacketHeader.byteLength);n=this._dataStreamPacketHandler.deserialize(n),this.emit(Lx.MESSAGE,n)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}},EB=class extends fB{send(e){if(this._originDataChannel){let t=e;t=this._dataStreamPacketHandler.serialize(e);const i=new Uint8Array(this._dataStreamPacketHeader.byteLength+t.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(t),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}};function _B(){const e=new Blob([atob("ZnVuY3Rpb24gZShlKXtjb25zdCB0PW5ldyBEYXRhVmlldyhlLmRhdGEpO2lmKDA9PT10LmdldFVpbnQ4KDApJiYwPT09dC5nZXRVaW50OCgxKSYmMD09PXQuZ2V0VWludDgoMikmJjE9PT10LmdldFVpbnQ4KDMpJiY2PT09dC5nZXRVaW50OCg0KSl7bGV0IG49NixyPTAsbz0wO2Zvcig7MjU1PT09KG89dC5nZXRVaW50OChuKyspKTspcis9MjU1O3IrPW87Y29uc3QgYT1mdW5jdGlvbihlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLG89W10sYT0wO2Zvcig7YTxuOylhKzM8biYmMD09PXJbYV0mJjA9PT1yW2ErMV0mJjM9PT1yW2ErMl0mJigwPT09clthKzNdfHwxPT09clthKzNdfHwyPT09clthKzNdfHwzPT09clthKzNdKT8oby5wdXNoKHJbYV0sclthKzFdLHJbYSszXSksYSs9NCk6KG8ucHVzaChyW2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShvKX0oZS5kYXRhLG4scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGEpfXJldHVybiBudWxsfWZ1bmN0aW9uIHQoZSx0KXtjb25zdCBuPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9ZS5sZW5ndGg7bGV0IG49W10scj0wO2Zvcig7cjx0OylyKzI8dCYmMD09PWVbcl0mJjA9PT1lW3IrMV0mJigwPT09ZVtyKzJdfHwxPT09ZVtyKzJdfHwyPT09ZVtyKzJdfHwzPT09ZVtyKzJdKT8obi5wdXNoKGVbcl0sZVtyKzFdLDMsZVtyKzJdKSxyKz0zKToobi5wdXNoKGVbcl0pLHIrKyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KG4pfSh0KSxyPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihyLzI1NSksYT1yJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK3IrZS5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBpPTA7Zm9yKDtpPG87KXNbNitpXT0yNTUsaSsrO3JldHVybiBzWzYraV09YSxpKysscy5zZXQobiw2K2kpLHMuc2V0KG5ldyBVaW50OEFycmF5KGUpLDYraStyKSxzLmJ1ZmZlcn1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIlNhZmFyaSIpPi0xJiYtMT09PW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikmJihzZWxmLm9ucnRjdHJhbnNmb3JtPW49Pntjb25zdCByPW4udHJhbnNmb3JtZXI7bGV0IG89W107ci5vcHRpb25zLnBvcnQub25tZXNzYWdlPWU9PntlLmRhdGEuc2VpJiZvLnB1c2goZS5kYXRhLnNlaSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBhPXIucmVhZGFibGUuZ2V0UmVhZGVyKCkscz1yLndyaXRhYmxlLmdldFdyaXRlcigpOyJyeCI9PT1yLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2EucmVhZCgpLnRoZW4oKHI9PntpZighci5kb25lKXtpZihyLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7YS5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1vLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout((()=>URL.revokeObjectURL(e)),0),new Worker(URL.createObjectURL(e))}const gB=new Map;const TB=new Map;const SB=new Map;async function vB(e,t){if(!nx().supportWebRTCEncodedTransform)return void EL.warning("browser not support video encoded transform");if(SB.has(e))return;if(!e.track)return;const i={track:e.track};if(cO()){if(!e.createEncodedStreams)return void EL.warning("browser not support createEncodedStreams() API");let s=null;try{s=e.createEncodedStreams()}catch(e){return void EL.error("create video-encoded-streams error",e&&e.message)}let r=[];t.on("sei-to-send",(e=>{r.push(e)}));const o=new TransformStream({transform(t,s){i.controller||(i.controller=s),e.track&&e.track.id!==i.track.id&&(EL.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",n),i.track=e.track,i.track.addEventListener("ended",n));const o=r.shift();o&&(t.data=function(e,t){const i=function(e){const t=e.length;let i=[],n=0;for(;n<t;)n+2<t&&0===e[n]&&0===e[n+1]&&(0===e[n+2]||1===e[n+2]||2===e[n+2]||3===e[n+2])?(i.push(e[n],e[n+1],3,e[n+2]),n+=3):(i.push(e[n]),n++);return new Uint8Array(i)}(t),n=i.length,s=Math.floor(n/255),r=n%255,o=new Uint8Array(6+s+1+n+e.byteLength);o[0]=0,o[1]=0,o[2]=0,o[3]=1,o[4]=6,o[5]=101;let a=0;for(;a<s;)o[6+a]=255,a++;return o[6+a]=r,a++,o.set(i,6+a),o.set(new Uint8Array(e),6+a+n),o.buffer}(t.data,o)),s.enqueue(t)}});s.readable.pipeThrough(o).pipeTo(s.writable)}else{if(!dO())return;{if("undefined"==typeof RTCRtpScriptTransform)return void EL.warning("browser not support RTCRtpScriptTransform");const s=_B(),r=new MessageChannel;await new Promise((e=>s.onmessage=t=>{"registered"===t.data&&e(void 0)}));const o=new RTCRtpScriptTransform(s,{name:"tx",port:r.port2},[r.port2]);e.transform=o,await new Promise((e=>s.onmessage=t=>{"started"===t.data&&e(void 0)})),t.on("sei-to-send",(e=>{r.port1.postMessage({sei:e})})),r.port1.onmessage=t=>{var s;t.data.transformed&&e.track&&(null===(s=e.track)||void 0===s?void 0:s.id)!==i.track.id&&(EL.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",n),i.track=e.track,i.track.addEventListener("ended",n))},i.worker=s}}function n(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",n)}const t=SB.get(e);if(t){SB.delete(e);try{var i,s;null===(i=t.controller)||void 0===i||i.terminate(),null===(s=t.worker)||void 0===s||s.terminate()}catch(e){EL.warning(e&&e.message)}}}SB.set(e,i),e.track.addEventListener("ended",n)}const RB=new Map;async function yB(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!nx().supportWebRTCEncodedTransform)return void EL.warning("browser not support video encoded transform");if(!e.track)return;if(RB.has(e)){const i=RB.get(e);return void(i&&(i.onSei=t.onSei))}const i={track:e.track,onSei:t.onSei};if(cO()){if(!e.createEncodedStreams)return void EL.warning("browser not support createEncodedStreams() API");let t=null;try{t=e.createEncodedStreams()}catch(e){return void EL.error("create video-encoded-streams error",e&&e.message)}const s=new TransformStream({transform(t,s){i.controller||(i.controller=s),e.track&&e.track.id!==i.track.id&&(EL.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",n),i.track=e.track,i.track.addEventListener("ended",n));const r=function(e){const t=new DataView(e.data);if(0===t.getUint8(0)&&0===t.getUint8(1)&&0===t.getUint8(2)&&1===t.getUint8(3)&&6===t.getUint8(4)){let i=6,n=0,s=0;for(;255===(s=t.getUint8(i++));)n+=255;n+=s;const r=function(e,t,i){let n=new Uint8Array(e,t,i),s=[],r=0;for(;r<i;)r+3<i&&0===n[r]&&0===n[r+1]&&3===n[r+2]&&(0===n[r+3]||1===n[r+3]||2===n[r+3]||3===n[r+3])?(s.push(n[r],n[r+1],n[r+3]),r+=4):(s.push(n[r]),r++);return new Uint8Array(s)}(e.data,i,n);return new Uint8Array(r)}return null}(t);r&&i.onSei&&i.onSei(r),s.enqueue(t)}});t.readable.pipeThrough(s).pipeTo(t.writable)}else if(dO()){if("undefined"==typeof RTCRtpScriptTransform)return void EL.warning("browser not support RTCRtpScriptTransform");const t=_B(),s=new MessageChannel;await new Promise((e=>t.onmessage=t=>{"registered"===t.data&&e(void 0)}));const r=new RTCRtpScriptTransform(t,{name:"rx",port:s.port2},[s.port2]);e.transform=r,await new Promise((e=>t.onmessage=t=>{"started"===t.data&&e(void 0)})),s.port1.onmessage=t=>{var s;t.data.transformed&&e.track&&(null===(s=e.track)||void 0===s?void 0:s.id)!==i.track.id?(EL.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",n),i.track=e.track,i.track.addEventListener("ended",n)):t.data.sei&&i.onSei&&i.onSei(t.data.sei)},i.worker=t}function n(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",n)}!function(e){const t=RB.get(e);if(t){RB.delete(e);try{var i,n;null===(i=t.controller)||void 0===i||i.terminate(),null===(n=t.worker)||void 0===n||n.terminate()}catch(e){EL.warning(e&&e.message)}}}(e)}RB.set(e,i),e.track.addEventListener("ended",n)}!function(){const e=sO();ix.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),ix.getStreamFromExtension=e.name===eO.CHROME&&Number(e.version)>34,ix.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver)return!1;if(!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const e=new RTCPeerConnection;let t=!1;try{e.addTransceiver("audio"),t=!0}catch(e){}return e.close(),t}(),ix.supportMinBitrate=e.name===eO.CHROME||e.name===eO.EDGE,ix.supportSetRtpSenderParameters=function(){const e=sO();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!SO()||!(!dO()&&!aO())||e.name===eO.FIREFOX&&Number(e.version)>=64)}(),e.name===eO.SAFARI&&(Number(e.version)>=14?ix.supportDualStream=!0:ix.supportDualStream=!1),ix.webAudioMediaStreamDest=function(){const e=sO();return!(e.name===eO.SAFARI&&Number(e.version)<12)}(),ix.supportReplaceTrack=!!window.RTCRtpSender&&"function"==typeof RTCRtpSender.prototype.replaceTrack,ix.supportWebGL="undefined"!=typeof WebGLRenderingContext,ix.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,SO()||(ix.webAudioWithAEC=!0),ix.supportShareAudio=function(){const e=sO();return(e.os===ZD.WIN_10||e.os===ZD.WIN_81||e.os===ZD.WIN_7||e.os===ZD.LINUX||e.os===ZD.MAC_OS||e.os===ZD.CHROMIUM_OS)&&e.name===eO.CHROME&&Number(e.version)>=74}(),ix.supportDataChannel=!!(function(e){const t=sO();return!(t.name!==eO.CHROME||!t.osVersion)&&Number(t.version)>=e}(76)||function(e){const t=sO();return!(t.name!==eO.FIREFOX||!t.osVersion)&&Number(t.version)>=e}(68)||function(e){const t=sO();return!(t.name!==eO.SAFARI||!t.osVersion)&&Number(t.version)>=e}(14)),ix.supportPCSetConfiguration=function(){const e=window.RTCPeerConnection;return!lO()&&!!e&&e.prototype.setConfiguration instanceof Function}(),ix.supportWebRTCEncodedTransform=function(){const e=sO();return"Chrome"===e.name&&Number(e.version)>=86||"Safari"===e.name&&Number(e.version)>=15}(),ix.supportWebRTCInsertableStream=function(){const e=sO();return(e.name===eO.CHROME||e.name===eO.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),hN((()=>{ix.supportDualStreamEncoding=function(){const e=sO();return!!JN("DISABLE_WEBAUDIO")||("Safari"===e.name&&Number(e.version)>=14||!!("Chrome"===e.name&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&JN("CHROME_DUAL_STREAM_USE_ENCODING")))}(),EL.info("browser compatibility",JSON.stringify(ix),JSON.stringify(e))}))}();const CB=["CHINA","GLOBAL"],IB=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),s=[];for(let e=0;e<6;e++)s.push("1");const r=s.join(""),o={};return o[e]=n,o[t]=r,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=IB,YN||(zN.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],zN.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],zN.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],zN.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],zN.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],zN.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],zN.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",zN.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",zN.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",zN.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",zN.AREAS=["NORTH_AMERICA","OVERSEA"]);const AB=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],bB=[];function wB(e,t){return!!t&&bB.some((i=>i.uid===e&&i.channelName===t))}function DB(e){var t,i;function n(t,i){try{var r=e[t](i),o=r.value,a=o instanceof OB;Promise.resolve(a?o.v:o).then((function(i){if(a){var c="return"===t?"return":"next";if(!o.k||i.done)return n(c,i);i=e[c](i).value}s(r.done?"return":"normal",i)}),(function(e){n("throw",e)}))}catch(e){s("throw",e)}}function s(e,s){switch(e){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,s){return new Promise((function(r,o){var a={key:e,arg:s,resolve:r,reject:o,next:null};i?i=i.next=a:(t=i=a,n(e,s))}))},"function"!=typeof e.return&&(this.return=void 0)}function OB(e,t){this.v=e,this.k=t}function NB(e){var t={},i=!1;function n(t,n){return i=!0,n=new Promise((function(i){i(e[t](n))})),{done:!1,value:new OB(n,1)}}return t["undefined"!=typeof Symbol&&Symbol.iterator||"@@iterator"]=function(){return this},t.next=function(e){return i?(i=!1,e):n("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(i)throw i=!1,e;return n("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return i?(i=!1,e):n("return",e)}),t}function LB(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=Symbol.asyncIterator,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new PB(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function PB(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return PB=function(e){this.s=e,this.n=e.next},PB.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?Promise.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?Promise.reject(e):t(i.apply(this.s,arguments))}},new PB(e)}function kB(e){return new OB(e,0)}function MB(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function UB(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?MB(Object(i),!0).forEach((function(t){FB(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):MB(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function xB(e){return function(){return new DB(e.apply(this,arguments))}}function FB(e,t,i){return(t=function(e){var t=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var n=i.call(e,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function VB(e,t,i,n,s){var r={};return Object.keys(n).forEach((function(e){r[e]=n[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,n){return n(e,t,i)||i}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}RL.__CLIENT_LIST__=bB,DB.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},DB.prototype.next=function(e){return this._invoke("next",e)},DB.prototype.throw=function(e){return this._invoke("throw",e)},DB.prototype.return=function(e){return this._invoke("return",e)};let BB=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),GB=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({}),jB=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),WB=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),HB=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),KB=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),YB=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),qB=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),$B=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e}({}),zB=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e}({}),XB=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),JB=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e}({}),QB=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),ZB=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({});class eG extends CO{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,EL)}throw(){super.throw(EL)}}function tG(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw EL.error("Invalid Channel Name ".concat(e)),new eG(yO.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function iG(e){if(!("number"==typeof(t=e)&&Math.floor(t)===t&&0<=t&&t<=4294967295||LO(e,1,255)))throw new eG(yO.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;"string"==typeof e&&EL.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let nG=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming",e}({}),sG=function(e){return e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN",e}({});const rG={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},oG={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function aG(e,t){DO(e.url,"".concat(t,".url"),1,1e3,!1),NO(e.x)||bO(e.x,"".concat(t,".x"),0,1e4),NO(e.y)||bO(e.y,"".concat(t,".y"),0,1e4),NO(e.width)||bO(e.width,"".concat(t,".width"),0,1e4),NO(e.height)||bO(e.height,"".concat(t,".height"),0,1e4),NO(e.zOrder)||bO(e.zOrder,"".concat(t,".zOrder"),0,255),NO(e.alpha)||bO(e.alpha,"".concat(t,".alpha"),0,1,!1)}const cG={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},dG={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};let lG=function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e}({}),hG=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({}),uG=function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e}({});function pG(e){if(!e.channelName)throw new eG(yO.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new eG(yO.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&DO(e.token,"info.token",1,2047),iG(e.uid),tG(e.channelName),!0}let fG=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),mG=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),EG=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),_G=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),gG=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),TG=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal",e}({}),SG=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),vG=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),RG=function(e){return e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel",e}({}),yG=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});const CG=[yG.AFRICA,yG.ASIA,yG.CHINA,yG.EUROPE,yG.GLOBAL,yG.INDIA,yG.JAPAN,yG.NORTH_AMERICA,yG.OCEANIA,yG.OVERSEA,yG.SOUTH_AMERICA];let IG=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});const AG={CHINA:{},ASIA:{CODE:IG.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:IG.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:IG.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:IG.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:IG.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:IG.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:IG.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:IG.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:IG.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:IG.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:IG.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:IG.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:IG.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};YN&&(AG.CHINA={CODE:IG.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let bG=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e}({});class wG extends GO{constructor(e,t){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0}}class DG extends wG{constructor(e,t){super(e,t),this.establishPromise=void 0}}let OG=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),NG=function(e){return e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY",e}({}),LG=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({}),PG=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),kG=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),MG=function(e){return e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e}({}),UG=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),xG=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),FG=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),VG=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),BG=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e}({}),GG=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),jG=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),WG=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),HG=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),KG=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),YG=function(e){return e.ABORT="abort",e}({}),qG=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),$G=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});const zG={[jB.ACCESS_POINT]:{[KB.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[KB.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[KB.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[KB.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[KB.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[KB.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[KB.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[jB.UNILBS]:{[HB.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[HB.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[HB.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[HB.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[HB.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[HB.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[HB.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[HB.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[HB.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[HB.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[HB.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[HB.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[jB.STRING_UID_ALLOCATOR]:{[WB.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[WB.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[WB.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function XG(e){const t=zG[Math.floor(e/1e4)];if(!t)return{desc:"unkonw error",retry:!1};const i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===jB.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const JG={[YB.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[YB.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[YB.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[YB.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[YB.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[YB.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[YB.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[YB.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[YB.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[YB.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[YB.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[YB.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[YB.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[YB.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[YB.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[YB.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[YB.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[YB.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[YB.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[YB.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[YB.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[YB.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[YB.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[YB.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[YB.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[YB.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[YB.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[YB.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[YB.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[YB.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[YB.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[YB.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[YB.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[YB.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[YB.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[YB.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[YB.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[YB.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[YB.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[YB.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[YB.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[YB.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[YB.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[YB.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[YB.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[YB.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[YB.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[YB.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[YB.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[YB.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[YB.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[YB.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[YB.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[YB.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[YB.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[YB.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[YB.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[YB.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[YB.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[YB.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[YB.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[YB.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[YB.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function QG(e){return JG[e]||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function ZG(e){return e.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING))}function ej(e,t){if("string"==typeof e)return e;const{proxy:i,host:n,port:s}=e;if(t){const e=JN("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(n,"/ws/?p=").concat(Number(s)+150):"wss://".concat(n,":").concat(e,"/ws/?p=").concat(Number(s)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(s):"wss://".concat(n,":").concat(s)}const tj=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,ij=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,nj=/wss:\/\/(.+):([0-9]+)\/?/,sj=/wss:\/\/(.[^\/]+)\/?/;let rj=0;class oj{constructor(e,t){this.id=0,this.store=void 0,this.recordIndex=void 0,this.websockets=[],this.try443PortDuration=2e3,this.forceCloseWSDuration=5e3,this.try443PortTimeout=null,this.forceCloseTimeout=null,this.isTry443PortFailed=!1,this.isNormalPortFailed=!1,this.useDoubleDomain=!1,this.useProxy=!1,this.startTime=Date.now(),this.id=++rj,this.try443PortDuration=JN("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const t=Date.now()-this.startTime;for(var i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];EL.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(t,"ms:"),...n)}createWebSocket(e,t,i){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:i});const n=JN("GATEWAY_DOMAINS"),s=Date.now(),r=[],o=n.find((t=>e.host.includes(t)));o||(this.useDoubleDomain=!1);const a=[];if(this.useDoubleDomain)n.forEach((i=>{a.push(ej(UB(UB({},e),{},{host:e.host.replace(o,i)}),t))}));else{const i=UB({},e);if(t&&o){const e=n.find((e=>e!==o));e&&(i.host=i.host.replace(o,e))}a.push(ej(i,t))}try{a.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",r.push(t),this.logger("ws is connecting:",t.url)}))}catch(n){if(this.logger("ws create failed"),r.forEach((e=>e.close())),r.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,i);if(!t&&443!==Number(e.port))return this.createWebSocket(e,!0,i);throw new eG(yO.WS_ERR,"init websocket failed! Error: ".concat(n.toString()))}const c=$D();return this.store&&this.store.recordJoinChannelService({urls:r.map((e=>e.url)),service:"gateway"},this.recordIndex),r.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=i=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(e.readyState)),t?this.isTry443PortFailed=ZG(r):this.isNormalPortFailed=ZG(r),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(t&&this.isTry443PortFailed||!t&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(i.reason)),c.reject({code:i.code,reason:SG.A_ROUND_WS_FAILED}))},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...r),i||(()=>{const i=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))};if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",c.isResolved),c.isResolved)return i();sO().os===ZD.MAC_OS&&lO()&&i(),this.createWebSocket(e,!0,!0).then((e=>c.resolve(e))).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(e,t,i,n){return this.useDoubleDomain=!!t,"string"==typeof e&&(e=function(e){let t,i,n;return[,t,i,n]=e.match(tj)||[],t||([,i,n]=e.match(ij)||[]),i&&n||([,i,n]=e.match(nj)||[]),i&&n||([,i]=e.match(sj)||[]),i||EL.warning("un-destructible url: ",e),{proxy:t,host:i,port:n||"443"}}(e)),this.recordIndex=n,this.useProxy=!!e.proxy,i&&this.useProxy&&(EL.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(e,!!i,!1).finally((()=>this.clearTimeout()))}}class aj extends GO{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(ZB.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(ZB.CONNECTED):"closed"===this._state?this.emit(ZB.CLOSED):"failed"===this._state&&this.emit(ZB.FAILED))}resetReconnectCount(e){EL.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new PN("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=r,this.name=e,this.retryConfig=UB({},t),this.useCompress=i,this.tryDoubleDomain=n,this.use443PortOnly=s;const{timeout:o,timeoutFactor:a}=t,c=Math.max(300,Math.floor(3*o/5)),d=Math.max(1.2,Math.floor(8*a)/10);ZO.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),rN.on(eN.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===ZO.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=o,this.retryConfig.timeoutFactor=a))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=$D(),t=this.urls[this.currentURLIndex];this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(ZB.CLOSED,(()=>{e.reject(new CO(yO.WS_DISCONNECT))})),this.once(ZB.CONNECTED,e.resolve),await e.promise}catch(e){}finally{i()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,t){if(!this.websocket)return void EL.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),EL.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(t)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:t})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new CO(yO.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new CO(yO.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var t;const i=$D();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const n=e=>{var t;null===(t=this.store)||void 0===t||t.signalChannelOpen(),EL.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},s=async e=>{var t;if(EL.debug("[".concat(this.name,"] websocket close ").concat(null===(t=this.websocket)||void 0===t?void 0:t.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new CO(yO.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const t=nN(this,ZB.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,n=await this.reconnectWithAction(t);if("closed"===this.state)return void EL.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!n)return i.reject(new CO(yO.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);i.resolve()}},r=e=>{this.emit(ZB.ON_MESSAGE,e)},o=e=>{EL.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),JN("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=JN("GATEWAY_WSS_ADDRESS")),EL.debug("[".concat(this.name,"] start connect, url:"),e);const a=null===(t=this.store)||void 0===t?void 0:t.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var c;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,n&&n(this.websocket.url),this.websocket.onclose=s,this.websocket.onmessage=r,this.websocket.onerror=o,null===(c=this.store)||void 0===c||c.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this.joinGatewayRecordIndex=a}catch(e){const t="closed"===this.state,n=e instanceof CO,r=n&&e.code===yO.WS_ABORT,o=n&&e.code===yO.WS_ERR,c=n?e.message:e&&(e.reason||e.toString());EL.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(c)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:r?"aborted":"error",errors:[e]},a),t||o?(i.reject(t?new CO(yO.WS_DISCONNECT,"websocket is closed: ".concat(c)):new CO(yO.WS_ERR,"init websocket failed: ".concat(c))),o&&EL.error("[".concat(this.name,"] init websocket failed: ").concat(c))):s&&s(e)}return i.promise}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;EL.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||rN.isOnline||!rN.onlineWaiter||(this.onlineReconnectListener=rN.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let i=!0;if(this.reconnectInterrupter=()=>i=!1,t){const t=UN(this.reconnectCount,this.retryConfig);EL.debug("[".concat(this.name,"] wait ").concat(t,"ms to reconnect websocket, mode: ").concat(e)),await Promise.race([RN(t),this.onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this._state||!i)return!1;this.reconnectCount+=1;const n=async(e,t)=>{this.emit(ZB.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(ZB.RECONNECT_WAITTING_FINISH,e),await n(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);EL.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(ZB.RECONNECT_WAITTING_FINISH,e),await n(this.urls[this.currentURLIndex],e)}else"recover"===e&&(EL.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(ZB.RECONNECT_WAITTING_FINISH,e),this.urls=await tN(this,ZB.REQUEST_NEW_URLS),this.currentURLIndex=0,await n(this.urls[this.currentURLIndex],e))}catch(i){var s;EL.error("[".concat(this.name,"] reconnect failed ").concat(i&&i.toString()));const n=null==i||null===(s=i.data)||void 0===s?void 0:s.desc;return Array.isArray(n)&&n.includes("dynamic key expired")?(this.emit(ZB.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,t)}return!0}}class cj extends aj{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){const i=$D(),n=(s=this.forceCloseTimeout,r=this.store,new oj(s,r));var s,r;this.closeEstablishingWs=()=>{EL.debug("[choose-best-ws] close establishing websockets"),n.closeAllWebsockets(),i.reject(new CO(yO.WS_ABORT,"choose best websocket aborted"))};const o=JN("GATEWAY_DOMAINS");return EL.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),n.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,t).then(i.resolve).catch(i.reject),i.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class dj extends aj{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,t){return new Promise(((i,n)=>{let s=!1;const r=[];this.closeEstablishingWs=()=>{EL.debug("[choose-best-ws] close establishing websockets"),r.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),n(new CO(yO.WS_ABORT,"choose best websocket aborted"))};const o=JN("GATEWAY_DOMAINS");let a;const c=e.indexOf("?h="),d=o.find((t=>-1!==c?e.includes(t,c):e.includes(t)));EL.debug("[choose-best-ws] currentDomain: ",d,", domains: ",o);let l=!this.tryDoubleDomain||!d;if(!l&&d){var h;const u=Date.now();try{o.forEach((t=>{const i=-1===c?e.replace(d,t):e.substr(0,c)+e.substr(c).replace(d,t),n=new WebSocket(i);n.binaryType="arraybuffer",r.push(n),EL.debug("[choose-best-ws] ws is connecting:",n.url)}))}catch(e){for(EL.debug("[choose-best-ws] ws create failed, fallback to single url"),r.forEach((e=>e.close()));r.length;)r.pop();l=!0}null===(h=this.store)||void 0===h||h.recordJoinChannelService({urls:r.map((e=>e.url)),service:"gateway"},t),r.forEach((e=>{e.onopen=()=>{if(s)return;const t=Date.now()-u;EL.debug("[choose-best-ws] ws open cost ".concat(t,"ms")),r.filter((t=>t!==e)).forEach((e=>{EL.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),s=!0,i(e)},e.onclose=e=>{a=e,s||r.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(EL.debug("[choose-best-ws] all websocket is closed"),s=!0,n(a))},e.onmessage=t=>{EL.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(t.data))}})),RN(this.forceCloseTimeout).then((()=>{r.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(l){var u;let s;EL.debug("[choose-best-ws] use single url: ",e),null===(u=this.store)||void 0===u||u.recordJoinChannelService({urls:[e],service:"gateway"},t);try{s=new WebSocket(e),r.push(s),s.binaryType="arraybuffer"}catch(e){const t=new CO(yO.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return EL.error("[".concat(this.name,"]").concat(t)),void n(t)}s.onopen=()=>{i(s)},s.onclose=e=>{n(e)},s.onmessage=e=>{EL.debug("[choose-best-ws]".concat(s.url," onmessage: ").concat(e.data))},RN(this.forceCloseTimeout).then((()=>{s&&s.readyState!==WebSocket.OPEN&&s.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}class lj extends GO{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===qB.CONNECTED?this.emit($B.WS_CONNECTED):e===qB.RECONNECTING?this.emit($B.WS_RECONNECTING,this._websocketReconnectReason):e===qB.CLOSED&&this.emit($B.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=qB.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new VN(5),this.pingpongTimer=void 0,this.wsInflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit($B.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===JB.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===JB.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(qO.UID_BANNED);break;case 15:this.close(qO.IP_BANNED);break;case 16:this.close(qO.CHANNEL_BANNED)}if(t._type===JB.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case YB.ERR_LICENSE_MISSING:this.close(qO.LICENSE_MISSING);break;case YB.ERR_LICENSE_EXPIRED:this.close(qO.LICENSE_EXPIRED);break;case YB.ERR_LICENSE_MINUTES_EXCEEDED:this.close(qO.LICENSE_MINUTES_EXCEEDED);break;case YB.ERR_LICENSE_PERIOD_INVALID:this.close(qO.LICENSE_PERIOD_INVALID);break;case YB.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(qO.LICENSE_MULTIPLE_SDK_SERVICE);break;case YB.ERR_LICENSE_ILLEGAL:this.close(qO.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new cj("gateway-".concat(this.clientId),this.spec.retryConfig,!0,JN("JOIN_GATEWAY_USE_DUAL_DOMAIN"),JN("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===qB.CONNECTED&&this.reconnect("retry",QO.OFFLINE)}))}async request(e,t,i,n){const s=yN(6,""),r={_id:s,_type:e,_message:t},o=this.websocket.connectionID,a=()=>new Promise(((t,i)=>{if(this.connectionState===qB.CONNECTED)return t();const n=()=>{this.off($B.WS_CLOSED,s),t()},s=()=>{this.off($B.WS_CONNECTED,n),i(new eG(yO.WS_ABORT))};this.once($B.WS_CONNECTED,n),this.once($B.WS_CLOSED,s),e!==zB.PUBLISH&&e!==zB.PUBLISH_DATASTREAM&&e!==zB.SUBSCRIBE&&e!==zB.SUBSCRIBE_DATASTREAM&&e!==zB.UNSUBSCRIBE&&e!==zB.UNSUBSCRIBE_DATASTREAM&&e!==zB.UNPUBLISH&&e!==zB.UNPUBLISH_DATASTREAM&&e!==zB.CONTROL&&e!==zB.RESTART_ICE||this.once($B.DISCONNECT_P2P,(()=>{i(new eG(yO.DISCONNECT_P2P))})),e!==zB.PUBLISH&&e!==zB.RESTART_ICE||this.once($B.ABORT_P2P_EXECUTION,(()=>{i(new eG(yO.DISCONNECT_P2P))}))}));if(this.connectionState!==qB.CONNECTING&&this.connectionState!==qB.RECONNECTING||e===zB.JOIN||e===zB.REJOIN||await a(),this.websocket.sendMessage(r,!0),n)return;const c=new Promise(((i,n)=>{let r=!1;const a=(n,s)=>{r=!0,i({isSuccess:"success"===n,message:s||{}}),this.off($B.WS_CLOSED,c),this.off($B.WS_RECONNECTING,c),this.emit($B.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(s),a);const c=()=>{n(new eG(yO.WS_ABORT,"type: ".concat(e))),this.off($B.WS_CLOSED,c),this.off($B.WS_RECONNECTING,c),this.off("res-@".concat(s),a)};this.once($B.WS_CLOSED,c),this.once($B.WS_RECONNECTING,c),RN(JN("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==o||r||(EL.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit($B.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(n){if(this.connectionState===qB.CLOSED||e===zB.LEAVE)throw new eG(yO.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():e===zB.JOIN||e===zB.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=QG(l),u=new eG(yO.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===h.action?d.message:(EL.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===YB.ERR_TOO_MANY_BROADCASTERS?e===zB.JOIN||e===zB.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===YB.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,EL.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",QO.MULTI_IP)):this.reconnect(h.action,QO.SERVER_ERROR),e===zB.JOIN||e===zB.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Promise((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void EL.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(XB.WRTC_STATS,t)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=JN("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==qB.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),JN("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((t,i)=>{this.once($B.WS_CONNECTED,(()=>t(this.joinResponse))),this.once($B.WS_CLOSED,(()=>i(this.initError||new eG(yO.WS_ABORT)))),this.connectionState=qB.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||qO.LEAVE,this.connectionState=qB.CLOSED,EL.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===qO.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new cj("gateway-".concat(this.clientId),this.spec.retryConfig,!0,JN("JOIN_GATEWAY_USE_DUAL_DOMAIN"),JN("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit($B.ABORT_P2P_EXECUTION);const e=await tN(this,$B.REQUEST_JOIN_INFO),t=await this.request(zB.JOIN,e);if(!t)return this.emit($B.REPORT_JOIN_GATEWAY,SG.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit($B.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=qB.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new eG(yO.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=sN(this,$B.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(zB.REJOIN,e);return!!t&&(this.connectionState=qB.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(JB.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(JB.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(JB.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(JB.MUTE_AUDIO,{uid:e.uid}):this.emit(JB.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(JB.MUTE_VIDEO,{uid:e.uid}):this.emit(JB.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(JB.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(JB.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(JB.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(JB.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(JB.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){EL.debug("[".concat(this.clientId,"] receive notification: "),e);const t=QG(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(qO.UID_BANNED),void this.close()):void this.reconnect(t.action,QO.SERVER_ERROR);EL.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=JN("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(EL.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>JN("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",QO.TIMEOUT):this.request(zB.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),JN("REPORT_STATS")&&this.send(zB.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(XB.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(ZB.RECONNECT_WAITTING_FINISH,(e=>{this.emit($B.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(ZB.RECONNECT_CREATE_CONNECTION,(e=>{this.emit($B.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(ZB.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ZB.CLOSED,(()=>{this.connectionState=qB.CLOSED})),this.websocket.on(ZB.FAILED,(()=>{this._disconnectedReason=qO.NETWORK_ERROR,this.connectionState=qB.CLOSED})),this.websocket.on(ZB.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===qB.CONNECTED?this.connectionState=qB.RECONNECTING:this.connectionState=qB.CONNECTING})),this.websocket.on(ZB.WILL_RECONNECT,((e,t,i)=>{const n=sN(this,$B.IS_P2P_DISCONNECTED),s=n||"retry"!==e;n&&"retry"===e&&(EL.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",t=SG.P2P_DISCONNECTED),s&&(EL.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit($B.REPORT_JOIN_GATEWAY,t||SG.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit($B.NEED_RENEW_SESSION),this.emit($B.DISCONNECT_P2P)),i(e)})),this.websocket.on(ZB.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{EL.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",QO.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit($B.REPORT_JOIN_GATEWAY,e.message||e.code||SG.UNKNOWN_REASON,this.url||""),e instanceof eG&&e.code===yO.UNEXPECTED_RESPONSE&&e.data.code===YB.ERR_NO_AUTHORIZED)return EL.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",QO.SERVER_ERROR);EL.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",QO.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(ZB.REQUEST_NEW_URLS,((e,t)=>{tN(this,$B.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(ZB.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(JB.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}let hj=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function uj(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(JN("TURN_DOMAIN")):(EL.info("Unidentified as ip: ".concat(e,", use as host")),e)}function pj(e,t){e.addresses||(e.addresses=[]);const i=function(e,t){if(JN("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return e.map((e=>{let{ip:t,port:i}=e;return{address:"".concat(t,":").concat(i)}}));const i=JN("GATEWAY_DOMAINS");let n=i[1]&&t.includes(i[1])?1:0;return e.map((e=>{let{domain_prefix:t,port:s,ip:r}=e;if(t)return{address:"".concat(t,".").concat(i[n++%i.length],":").concat(s)};const o=/^[\.\:\d]+$/.test(r),a=o?"".concat(r.replace(/[^\d]/g,"-"),".").concat(i[n++%i.length],":").concat(s):"".concat(r,":").concat(s);return o||EL.info("Unidentified as ip: ".concat(r,", use as host")),{ip:r,port:s,address:a}}))}(e.addresses,t),n=Array.isArray(e.detail)&&e.detail[18];if(n&&"string"==typeof n){const e=n.split(";");for(let t=0;t<e.length;t++){const n=e[t].trim();i[t]&&n&&(i[t].ip6=n)}}return{gatewayAddrs:i,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function fj(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function mj(e){const t=e._encoderConfig;if(!t)return{};const i={resolution:t.width&&t.height?"".concat(fj(t.width),"x").concat(fj(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function Ej(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function _j(e,t){let i,n,s;switch(t){case hj.CHOOSE_SERVER:n=4096,s="choose server";break;case hj.CLOUD_PROXY:n=1048576,s="proxy";break;case hj.CLOUD_PROXY_5:n=4194304,s="proxy5";break;case hj.CLOUD_PROXY_FALLBACK:n=4194310,s="proxy fallback";break;default:throw new eG(yO.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===n&&(i={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>UB(UB({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:UB(UB({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!i)throw new eG(yO.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(s," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return i}async function gj(e,t){return await Promise.all(e.addresses.map((async e=>({address:uj(e.ip),tcpport:e.port,udpport:e.port,username:t&&JN("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():IB.username,password:t&&JN("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await BO(t.toString()):IB.password}))))}function Tj(e,t){const i=t._videoHeight||t.getMediaStreamTrack(!0).getSettings().height;return i?Math.max(i/fj(e.height),1):(EL.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Sj(e){let{candidateType:t,relayProtocol:i,type:n,address:s,port:r,protocol:o}=e;return"local-candidate"===n?{candidateType:t,relayProtocol:i,protocol:o}:{candidateType:t,relayProtocol:i,address:s,port:r,protocol:o}}class vj extends GO{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){["tryNext","recover"].includes(e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(BG.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(BG.CONNECTED):"closed"===this._state?this.emit(BG.CLOSED):"failed"===this._state&&this.emit(BG.FAILED))}constructor(e,t,i,n){super(),this.connectionID=0,this.currentURLIndex=0,this.reconnectReason=void 0,this._reconnectMode="tryNext",this._initMutex=void 0,this._name=void 0,this._state="closed",this._reconnectInterrupter=void 0,this._url=void 0,this._retryConfig=void 0,this._reconnectCount=0,this._forceCloseTimeout=5e3,this._onlineReconnectListener=void 0,this._closeEstablishingTransmitter=()=>{},this._store=void 0,this._joinChannelServiceRecordIndex=void 0,this._transmitter=void 0,this._useCompress=void 0,this._inflateLength=0,this._deflateLength=0,this._store=n,this._name=e,this._retryConfig=UB({},t),this._useCompress=i}resetReconnectCount(e){EL.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,t){if(!this._transmitter)return void EL.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;void 0!==e&&(this.reconnectMode=e),EL.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex&&(null===(i=this._store)||void 0===i||i.recordJoinChannelService({status:"error",errors:[new Error(t)]},this._joinChannelServiceRecordIndex));const n=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),n&&n.bind(this._transmitter)({code:9999,reason:t})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let Rj=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class yj{constructor(e,t,i){this.version=1,this.initialRTO=void 0,this.maxBatchAckCount=void 0,this.maxRTO=void 0,this.initialRTT=void 0,this.ID=void 0,this.rtt=void 0,this.packetNumber=1,this.rtoRatioMap=new Map,this.timeoutMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer=void 0,this.sendImpl=void 0,this.receiveImpl=void 0,this.sendImpl=e,this.receiveImpl=t,this.ID=yN(7,"transmitter-"),this.initialRTO=void 0!==(null==i?void 0:i.initialRTO)?i.initialRTO:JN("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:JN("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:JN("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==i?void 0:i.maxBatchAckCount)?i.maxBatchAckCount:JN("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==i?void 0:i.maxRTO)?i.maxRTO:JN("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:Rj.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case Rj.Default:{let t;t="string"==typeof e.payload?(new TextEncoder).encode(e.payload):e.payload;const i=new ArrayBuffer(t.length+15),n=new DataView(i);return n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.packetNumber),kO(n,7,BigInt(e.sendTs)),new Uint8Array(n.buffer).set(t,15),i}case Rj.Ack:{const t=new ArrayBuffer(16),i=new DataView(t);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),kO(i,8,BigInt(e.ackSendTs)),t}}}deserialize(e){const t=new DataView(e),i=t.getUint16(0),n=t.getUint8(2);switch(n){case Rj.Default:{const s=t.getUint32(3),r=PO(t,7),o=e.slice(15),a=(new TextDecoder).decode(o);return{version:i,type:n,packetNumber:s,sendTs:Number(r),payload:a}}case Rj.Ack:{const e=t.getUint32(3),s=t.getUint8(7),r=PO(t,8);return{version:i,type:n,maxAckPacketNumber:e,shift:s,ackSendTs:Number(r)}}default:throw EL.error("[".concat(this.ID,"] Unrecognized packet type ").concat(n)),new Error("Unrecognized packet type ".concat(n))}}sendMessage(e){const t=this.packetize(e,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(t),n=window.setTimeout((()=>{this.resendMessage(t)}),i);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}onData(e){const t=this.deserialize(e);t.type===Rj.Default?this.ack(t):t.type===Rj.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,i]=e;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const t=this.calculateRTO(e),i=window.setTimeout((()=>{this.resendMessage(e)}),t);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,t){const i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:Rj.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:Rj.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Rj.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===Rj.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class Cj extends vj{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),this._initMutex=void 0,this._reconnectInterrupter=void 0,this._url=void 0,this._transmitter=void 0,this._addresses=void 0,this._reliableTransmission=void 0,this._initMutex=new PN("datachannel");const{timeout:i,timeoutFactor:n}=t,s=Math.max(300,Math.floor(3*i/5)),r=Math.max(1.2,Math.floor(8*n)/10);ZO.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=r),rN.on(eN.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===ZO.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=r):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=n))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const i=(t,i)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||JN("FINGERPRINT")));const n=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(n).then(t).catch(i),this.once(BG.CLOSED,(()=>i(new eG(yO.WS_DISCONNECT)))),this.once(BG.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new Promise(((e,t)=>{i(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new eG(yO.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(e){throw new eG(yO.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new Promise(((t,i)=>{var n;const s=()=>{EL.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),t()},r=async e=>{var n;if(null===(n=this._closeEstablishingTransmitter)||void 0===n||n.call(this),EL.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const n=nN(this,BG.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,s=await this.reconnectWithAction(n);if("closed"===this.state)return void EL.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!s)return i(new eG(yO.WS_DISCONNECT,"datachannel reconnect failed: ".concat(e.code))),void this.close(!0);t()}else i(new eG(yO.WS_DISCONNECT,"datachannel close: ".concat(e.code))),this.close()},o=e=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),EL.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const a=null===(n=this._store)||void 0===n?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),c=Date.now();tN(this,BG.TO_CONNECT_DATACHANNEL,e).then((e=>{var t,i;if(!e)throw new Error("transmissonInfo not exist yet");const{transmitter:n,close:d}=e;this._transmitter=n,null===(t=this._store)||void 0===t||t.signalChannelOpen();const l=Date.now()-c;EL.debug("[choose dc] dc open cost ".concat(l,"ms")),this._reliableTransmission=new yj((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{"string"==typeof e&&this.emit(BG.ON_MESSAGE,e)})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,d()},s&&s(),n.onclose=r,n.onmessage=o,null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:"success"},a),this._joinChannelServiceRecordIndex=a})).catch((e=>{var t;if(null===(t=this._store)||void 0===t||t.recordJoinChannelService({endTs:Date.now(),status:e instanceof eG&&e.code===yO.WS_ABORT?"aborted":"error",errors:[e]},a),"closed"!==this.state){if(e instanceof eG&&e.code===yO.WS_ERR){const t=new eG(yO.WS_ERR,"init datachannel failed! Error: ".concat(e.toString()));return EL.error("[".concat(this._name,"]").concat(t)),void i(t)}r&&r(e)}else i(new eG(yO.WS_DISCONNECT,"datachannel is closed: ".concat(e.toString())))}))}))}async reconnectWithAction(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||rN.networkState!==ZO.OFFLINE||(this._onlineReconnectListener=rN.onlineWaiter&&rN.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},t){const t=UN(this._reconnectCount,this._retryConfig);EL.debug("[".concat(this._name,"] wait ").concat(t,"ms to reconnect datachannel, mode: ").concat(e)),await Promise.race([RN(t),this._onlineReconnectListener||new Promise((()=>{}))])}if("closed"===this.state||!i)return!1;this._reconnectCount+=1;const n=async(e,t)=>{this.emit(BG.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===e){const t=this._addresses[this.currentURLIndex];this.emit(BG.RECONNECT_WAITTING_FINISH,e),await n(t,e)}else if("tryNext"===e){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||JN("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return EL.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);EL.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const t=this._addresses[this.currentURLIndex];this.emit(BG.RECONNECT_WAITTING_FINISH,e),await n(t,e)}else"recover"===e&&(EL.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(BG.RECONNECT_WAITTING_FINISH,e),this.emit(BG.FAILBACK));return!0}catch(i){var s;return EL.error("[".concat(this._name,"] reconnect failed"),i.toString()),null!=i&&null!==(s=i.data)&&void 0!==s&&s.desc&&Array.isArray(i.data.desc)&&i.data.desc.length&&i.data.desc.includes("dynamic key expired")?(this.emit(BG.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,t)}}}class Ij extends GO{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===qB.CONNECTED?this.emit($B.WS_CONNECTED):e===qB.RECONNECTING?this.emit($B.WS_RECONNECTING,this._websocketReconnectReason):e===qB.CLOSED&&this.emit($B.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=qB.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new VN(5),this.pingpongTimer=void 0,this.inflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e instanceof ArrayBuffer)return void this.emit($B.ON_BINARY_DATA,e);const t=JSON.parse(e);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")&&(this.emit(t._type,t._message),t._type===JB.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===JB.ON_USER_BANNED))switch(t._message.error_code){case 14:this.close(qO.UID_BANNED);break;case 15:this.close(qO.IP_BANNED);break;case 16:this.close(qO.CHANNEL_BANNED)}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new Cj("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===qB.CONNECTED&&this.reconnect("retry",VG.OFFLINE)}))}async request(e,t,i,n){const s=yN(6,""),r={_id:s,_type:e,_message:t},o=this.websocket.connectionID,a=()=>new Promise(((t,i)=>{if(this.connectionState===qB.CONNECTED)return t();const n=()=>{this.off($B.WS_CLOSED,s),t()},s=()=>{this.off($B.WS_CONNECTED,n),i(new eG(yO.WS_ABORT))};this.once($B.WS_CONNECTED,n),this.once($B.WS_CLOSED,s),e!==zB.PUBLISH&&e!==zB.SUBSCRIBE&&e!==zB.UNSUBSCRIBE&&e!==zB.UNPUBLISH&&e!==zB.CONTROL&&e!==zB.RESTART_ICE||this.once($B.DISCONNECT_P2P,(()=>{i(new eG(yO.DISCONNECT_P2P))})),e!==zB.PUBLISH&&e!==zB.RESTART_ICE||this.once($B.ABORT_P2P_EXECUTION,(()=>{i(new eG(yO.DISCONNECT_P2P))}))}));if(this.connectionState!==qB.CONNECTING&&this.connectionState!==qB.RECONNECTING||e===zB.JOIN||e===zB.REJOIN||await a(),e===zB.LEAVE&&(this.websocket.unbindDcCloseEventListener(),n=!0),this.websocket.sendMessage(r,!0,!1),n)return;const c=new Promise(((i,n)=>{let r=!1;const a=(n,s)=>{r=!0,i({isSuccess:"success"===n,message:s||{}}),this.off($B.WS_CLOSED,c),this.off($B.WS_RECONNECTING,c),this.emit($B.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(s),a);const c=()=>{n(new eG(yO.WS_ABORT,"type: ".concat(e))),this.off($B.WS_CLOSED,c),this.off($B.WS_RECONNECTING,c),this.off("res-@".concat(s),a)};this.once($B.WS_CLOSED,c),this.once($B.WS_RECONNECTING,c),RN(JN("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==o||r||(EL.warning("dc request timeout, type: ".concat(e)),this.emit($B.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(n){if(this.connectionState===qB.CLOSED||e===zB.LEAVE)throw new eG(yO.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():e===zB.JOIN||e===zB.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=QG(l),u=new eG(yO.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===h.action?d.message:(EL.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===YB.ERR_TOO_MANY_BROADCASTERS?e===zB.JOIN||e===zB.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===YB.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,EL.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",VG.MULTI_IP)):this.reconnect(h.action,VG.SERVER_ERROR),e===zB.JOIN||e===zB.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Promise((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void EL.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(XB.WRTC_STATS,t)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=JN("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==qB.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),JN("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((i,n)=>{this.once($B.WS_CONNECTED,(()=>i(this.joinResponse))),this.once($B.WS_CLOSED,(()=>n(this.initError||new eG(yO.WS_ABORT)))),this.connectionState=qB.CONNECTING,this.websocket.init(e).catch(n),this.websocket.once(BG.FAILBACK,(()=>{void 0===this.openConnectionTime&&n(new eG(yO.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{t&&void 0===this.openConnectionTime&&(EL.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),n(new eG(yO.INIT_DATACHANNEL_TIMEOUT)))}),JN("DC_JOIN_WITH_FAILBACK"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||qO.LEAVE,this.connectionState=qB.CLOSED,EL.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===qO.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Cj("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit($B.ABORT_P2P_EXECUTION);const e=await tN(this,$B.DATACHANNEL_CONNECTING),t=await this.request(zB.JOIN,e);if(!t)return this.emit($B.REPORT_JOIN_GATEWAY,yO.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit($B.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=qB.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new eG(yO.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=sN(this,$B.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(zB.REJOIN,e);return!!t&&(this.connectionState=qB.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(JB.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(JB.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(JB.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(JB.MUTE_AUDIO,{uid:e.uid}):this.emit(JB.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(JB.MUTE_VIDEO,{uid:e.uid}):this.emit(JB.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(JB.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(JB.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(JB.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(JB.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(JB.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){EL.debug("[".concat(this.clientId,"] receive notification: "),e);const t=QG(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(qO.UID_BANNED),void this.close()):void this.reconnect(t.action,VG.SERVER_ERROR);EL.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=JN("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(EL.warning("PINGPONG Timeout. Last Socket Message: ".concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>JN("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",VG.TIMEOUT):this.request(zB.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),JN("REPORT_STATS")&&this.send(zB.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(XB.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(BG.RECONNECT_WAITTING_FINISH,(e=>{this.emit($B.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(BG.RECONNECT_CREATE_CONNECTION,(e=>{this.emit($B.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(BG.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(BG.CLOSED,(()=>{this.connectionState=qB.CLOSED})),this.websocket.on(BG.FAILED,(()=>{this._disconnectedReason=qO.NETWORK_ERROR,this.connectionState=qB.CLOSED})),this.websocket.on(BG.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===qB.CONNECTED?this.connectionState=qB.RECONNECTING:this.connectionState=qB.CONNECTING})),this.websocket.on(BG.WILL_RECONNECT,((e,t)=>{if(sN(this,$B.IS_P2P_DISCONNECTED)&&"retry"===e)return EL.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit($B.NEED_RENEW_SESSION),this.emit($B.DISCONNECT_P2P),t("tryNext");"retry"!==e&&(EL.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit($B.NEED_RENEW_SESSION),this.emit($B.DISCONNECT_P2P)),t(e)})),this.websocket.on(BG.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{EL.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",VG.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit($B.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof eG&&e.code===yO.UNEXPECTED_RESPONSE&&e.data.code===YB.ERR_NO_AUTHORIZED)return EL.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",VG.SERVER_ERROR);EL.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",VG.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(BG.REQUEST_NEW_URLS,((e,t)=>{tN(this,$B.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(BG.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(JB.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(BG.TO_CONNECT_DATACHANNEL,(async(e,t,i)=>tN(this,$B.DATACHANNEL_PRECONNECT,e).then(t).catch(i))),this.websocket.on(BG.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit($B.DATACHANNEL_FAILBACK)}))}}class Aj extends GO{constructor(e,t){super(),this.signal=void 0,this.token=void 0,this.tokenTimeout=void 0,this.tokenInterval=void 0,this._sequence=0,this.userMap=new Map,this.encoder=new TextEncoder,this.signal=e,this.token=t;const i=()=>{this.signal.connectionState===qB.CONNECTED&&this.check(),0===this.userMap.size?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*JN("P2P_TOKEN_INTERVAL"))};i()}async send(e,t,i,n,s){var r,o;if(0===this.userMap.size)return;const a=Array.from(this.userMap.values())[0].token;"string"!=typeof t&&(t=JSON.stringify(t)),n=null!==(r=n)&&void 0!==r?r:yN(6,""),s=null!==(o=s)&&void 0!==o?o:this._sequence++;const c={_id:n,_type:e,_seq:s,_message:t,token:"".concat(this.token,"_").concat(a)};JN("SHOW_P2P_LOG")&&EL.debug("send message",c,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(c)).forEach((e=>{this.signal.request(zB.DATA_STREAM,{payload:_N(this.encoder.encode(e))})}));const d=new Promise(((t,s)=>{const r=window.setTimeout((()=>{this.off("res-@".concat(n,"_ack"),o),this.off("res-@".concat(n),d),this.off(YG.ABORT,a),EL.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(n)),0===this.userMap.size?s(new CO(yO.INVALID_REMOTE_USER)):s(new CO(yO.TIMEOUT))}),JN("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),o=()=>{r&&window.clearTimeout(r),this.off(YG.ABORT,a),i&&t()},a=()=>{r&&window.clearTimeout(r),this.off("res-@".concat(n,"_ack"),o),this.off("res-@".concat(n),d),s(new CO(yO.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(n)))};this.once(YG.ABORT,a),this.once("res-@".concat(n,"_ack"),o);const d=(i,c)=>{l=!0,r&&window.clearTimeout(r),this.off("res-@".concat(n,"_ack"),o),this.off(YG.ABORT,a),"success"===i?t(c):s(new CO(yO.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(n)))};let l=!1;i||(this.once("res-@".concat(n),d),RN(JN("SIGNAL_REQUEST_TIMEOUT")).then((()=>{l||EL.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(n,", ").concat(c))})))}));try{return await d}catch(r){if(r.code===yO.TIMEOUT)return await this.send(e,t,i,n,s);throw r}}onMessage(e){const{_uid:t}=e;let i,n=this.userMap.get(t);if(n)i=n.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==KG.CHECK)return;const{token:s}=e;i=new Map,n={uid:t,isStart:!0,token:s,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(t,n),this.signal.emit(JB.ON_USER_ONLINE,{uid:t}),this.handleUserOnline()}if("id"in e&&"total"in e){var s;const{id:n,total:r}=e,o=null!==(s=i.get(n))&&void 0!==s?s:[];if(o.push(e),i.has(n)||i.set(n,o),o.length!==r)return;{const s=o.sort(((e,t)=>e.index-t.index)).map((e=>e.payload)).join("");i.delete(n),(e=JSON.parse(s))._uid=t}}const{_type:r,token:o}=e;if([KG.ACK,KG.CHECK].includes(r))return r===KG.CHECK&&this.handleCheckToken(n,o),void this.receiveMessage(e);o==="".concat(n.token,"_").concat(this.token)?this.handleReceivedMessage(e):EL.debug('Receive unexpected message", '.concat(o,", cur_token: ").concat(n.token,"_").concat(this.token),e)}check(){const e={_id:yN(6,""),token:this.token,_type:KG.CHECK};JN("SHOW_P2P_LOG")&&EL.debug("send message",e),this.signal.request(zB.DATA_STREAM,{payload:_N(this.encoder.encode(JSON.stringify(e)))})}ack(e){const t={_id:e,_type:KG.ACK,token:this.token};JN("SHOW_P2P_LOG")&&EL.debug("send message",t),this.signal.request(zB.DATA_STREAM,{payload:_N(this.encoder.encode(JSON.stringify(t)))})}response(e,t,i){this.send(KG.RESPONSE,JSON.stringify({success:!i,message:t}),!0,e)}handleReceivedMessage(e){const t=()=>{this.userMap.forEach((e=>{const{receivedMessagesMap:t,nextExpectedSequenceNumber:i}=e;for(;t.has(i);){const n=t.get(i);t.delete(i),this.receiveMessage(n),e.nextExpectedSequenceNumber++}}))};if(!e)return void t();const{_uid:i,_seq:n}=e,s=this.userMap.get(i),{receivedMessagesMap:r,isStart:o,nextExpectedSequenceNumber:a}=s;if(n<a)return this.ack(e._id),void EL.debug("[external-signal] receive old message, seq: ".concat(n,", ").concat(e._message));r.set(n,e),o&&n===a&&(this.receiveMessage(e),r.delete(a),s.nextExpectedSequenceNumber++,t())}receiveMessage(e){const{_id:t,_type:i,_message:n,_uid:s}=e;if(JN("SHOW_P2P_LOG")&&EL.debug("receive message",e),t){let r;switch(e._type!==KG.ACK&&(n&&(r=JSON.parse(n)),this.ack(e._id)),e._type){case KG.CANDIDATE:case KG.CONTROL:this.signal.emit(i,r,s);break;case KG.PUBLISH:case KG.UNPUBLISH:case KG.RESTART_ICE:case KG.CALL:r.uid=s,tN(this.signal,i,r).then((t=>{this.response(e._id,t)})).catch((()=>{this.response(e._id,void 0,!0)}));break;case KG.ACK:this.getListeners("res-@".concat(t,"_ack")).length>0&&this.emit("res-@".concat(t,"_ack"));break;case KG.RESPONSE:{const{success:e,message:i}=r;this.emit("res-@".concat(t),e?"success":"failed",i);break}}}}splitMessage(e){if(e.length<Aj.MAX_MESSAGE_SIZE)return[e];const t=[],{remoteToken:i}=JSON.parse(e),n=yN(6,"");let s=0,r=800;const o=Math.ceil(e.length/r);for(;e.length>0;){s++;const a={id:n,index:s,total:o,payload:e.slice(0,r),token:"".concat(this.token,"_").concat(i)};JSON.stringify(a).length>Aj.MAX_MESSAGE_SIZE?r-=50:(t.push(a),e=e.slice(r))}return t.map((e=>JSON.stringify(e)))}handleCheckToken(e,t){return e.token!==t?(EL.debug("token changed, from ".concat(e.token," to ").concat(t)),this.reset(e.uid,t),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{EL.debug("token timeout, ".concat(t)),this.reset(e.uid)}),JN("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const e=await tN(this.signal,KG.CALL,void 0),t=await this.send(KG.CALL,e);this.signal.emit($B.P2P_CONNECTION,t,!0)}async reset(e,t){const i=this.userMap.get(e);i&&(this.emit(YG.ABORT),this.signal.emit(JB.ON_USER_OFFLINE,{uid:i.uid,reason:$G.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),t||(EL.debug("change local token from ".concat(t," to ").concat(t)),this.token=yN(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(YG.ABORT)}}Aj.MAX_SIZE=1,Aj.MAX_MESSAGE_SIZE=1024;class bj extends GO{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===qB.CONNECTED?this.emit($B.WS_CONNECTED):e===qB.RECONNECTING?this.emit($B.WS_RECONNECTING,this._websocketReconnectReason):e===qB.CLOSED&&this.emit($B.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=qB.CLOSED,this.reconnectToken=void 0,this.p2pToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new VN(5),this.pingpongTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this._external_signal=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit($B.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){switch(t._type){case JB.ON_DATA_STREAM:return void this.handleDataStream(t._message);case JB.MUTE_AUDIO:case JB.MUTE_VIDEO:case JB.ON_P2P_LOST:case JB.ON_USER_ONLINE:return;case JB.ON_USER_OFFLINE:const{uid:e}=t._message;return EL.debug("[".concat(this.clientId,"] user-offline uid: ").concat(e)),void this._external_signal.reset(e)}if(this.emit(t._type,t._message),t._type===JB.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===JB.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(qO.UID_BANNED);break;case 15:this.close(qO.IP_BANNED);break;case 16:this.close(qO.CHANNEL_BANNED)}if(t._type===JB.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case YB.ERR_LICENSE_MISSING:this.close(qO.LICENSE_MISSING);break;case YB.ERR_LICENSE_EXPIRED:this.close(qO.LICENSE_EXPIRED);break;case YB.ERR_LICENSE_MINUTES_EXCEEDED:this.close(qO.LICENSE_MINUTES_EXCEEDED);break;case YB.ERR_LICENSE_PERIOD_INVALID:this.close(qO.LICENSE_PERIOD_INVALID);break;case YB.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(qO.LICENSE_MULTIPLE_SDK_SERVICE);break;case YB.ERR_LICENSE_ILLEGAL:this.close(qO.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new cj("gateway-".concat(this.clientId),this.spec.retryConfig,!0,JN("JOIN_GATEWAY_USE_DUAL_DOMAIN"),JN("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===qB.CONNECTED&&this.reconnect("retry",QO.OFFLINE)})),this.p2pToken=yN(6,""),this._external_signal=new Aj(this,this.p2pToken)}async request(e,t,i,n){const s=yN(6,""),r={_id:s,_type:e,_message:t},o=this.websocket.connectionID,a=()=>new Promise(((e,t)=>{if(this.connectionState===qB.CONNECTED)return e();const i=()=>{this.off($B.WS_CLOSED,n),e()},n=()=>{this.off($B.WS_CONNECTED,i),t(new CO(yO.WS_ABORT))};this.once($B.WS_CONNECTED,i),this.once($B.WS_CLOSED,n)}));if(this.connectionState!==qB.CONNECTING&&this.connectionState!==qB.RECONNECTING||e===zB.JOIN||e===zB.REJOIN||await a(),this.websocket.sendMessage(r,!0),n)return;const c=new Promise(((i,n)=>{let r=!1;const a=(n,s)=>{r=!0,i({isSuccess:"success"===n,message:s||{}}),this.off($B.WS_CLOSED,c),this.off($B.WS_RECONNECTING,c),this.emit($B.REQUEST_SUCCESS,e,t)};this.once("res-@".concat(s),a);const c=()=>{n(new CO(yO.WS_ABORT,"type: ".concat(e))),this.off($B.WS_CLOSED,c),this.off($B.WS_RECONNECTING,c),this.off("res-@".concat(s),a)};this.once($B.WS_CLOSED,c),this.once($B.WS_RECONNECTING,c),RN(JN("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==o||r||(EL.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit($B.REQUEST_TIMEOUT,e,t))}))}));let d=null;try{d=await c}catch(n){if(this.connectionState===qB.CLOSED||e===zB.LEAVE)throw new CO(yO.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?n.throw():e===zB.JOIN||e===zB.REJOIN?null:(await a(),await this.request(e,t))}if(d.isSuccess)return d.message;const l=Number(d.message.error_code||d.message.code),h=QG(l),u=new CO(yO.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(d.message.error_str),{code:l,data:d.message});return"success"===h.action?d.message:(EL.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(l,", message: ").concat(h.desc,", action: ").concat(h.action)),l===YB.ERR_TOO_MANY_BROADCASTERS?e===zB.JOIN||e===zB.REJOIN?(this.initError=u,this.close(),u.throw()):u.throw():"failed"===h.action?u.throw():"quit"===h.action?(this.initError=u,this.close(),u.throw()):(l===YB.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=d.message.option,EL.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",QO.MULTI_IP)):this.reconnect(h.action,QO.SERVER_ERROR),e===zB.JOIN||e===zB.REJOIN?null:await this.request(e,t)))}waitMessage(e,t){return new Promise((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}uploadWRTCStats(e){if(!this.store.sessionId)return void EL.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const t={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(XB.WRTC_STATS,t)}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=JN("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==qB.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),JN("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}async sendExtensionMessage(e,t,i){return await this._external_signal.send(e,t,i)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise(((t,i)=>{this.once($B.WS_CONNECTED,(()=>t(this.joinResponse))),this.once($B.WS_CLOSED,(()=>i(this.initError||new CO(yO.WS_ABORT)))),this.connectionState=qB.CONNECTING,this.websocket.init(e).catch(i)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||qO.LEAVE,this.connectionState=qB.CLOSED,EL.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===qO.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new cj("gateway-".concat(this.clientId),this.spec.retryConfig,!0,JN("JOIN_GATEWAY_USE_DUAL_DOMAIN"),JN("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=yN(6,""),this._external_signal.clear(),this._external_signal=new Aj(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit($B.ABORT_P2P_EXECUTION);const e=await tN(this,$B.REQUEST_JOIN_INFO),t=await this.request(zB.JOIN,e);if(!t)return this.emit($B.REPORT_JOIN_GATEWAY,yO.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit($B.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=qB.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{const t=EN(e.payload),i=(new TextDecoder).decode(t),n=JSON.parse(i);"total"in n&&"id"in n||Object.values(KG).includes(n._type)?(n._uid=e.uid,this._external_signal.onMessage(n)):this.emit(JB.ON_DATA_STREAM,e)}catch(t){this.emit(JB.ON_DATA_STREAM,e)}}handleNotification(e){EL.debug("[".concat(this.clientId,"] receive notification: "),e);const t=QG(e.code);if("success"!==t.action){if("failed"!==t.action)return"quit"===t.action?("ERR_REPEAT_JOIN_CHANNEL"===t.desc&&this.close(qO.UID_BANNED),void this.close()):void this.reconnect(t.action,QO.SERVER_ERROR);EL.error("[".concat(this.clientId,"] ignore error: "),t.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=JN("PING_PONG_TIME_OUT"),t=Date.now();this.pingpongTimeoutCount>=e&&(EL.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(t-this.lastMsgTime,"ms")),t-this.lastMsgTime>JN("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",QO.TIMEOUT):this.request(zB.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-t;this.rttRolling.add(e),JN("REPORT_STATS")&&this.send(zB.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWebsocketEvents(){this.websocket.on(ZB.RECONNECT_WAITTING_FINISH,(e=>{this.emit($B.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(ZB.RECONNECT_CREATE_CONNECTION,(e=>{this.emit($B.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(ZB.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ZB.CLOSED,(()=>{this.connectionState=qB.CLOSED})),this.websocket.on(ZB.FAILED,(()=>{this._disconnectedReason=qO.NETWORK_ERROR,this.connectionState=qB.CLOSED})),this.websocket.on(ZB.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===qB.CONNECTED?this.connectionState=qB.RECONNECTING:this.connectionState=qB.CONNECTING})),this.websocket.on(ZB.WILL_RECONNECT,((e,t,i)=>{"retry"!==e?(EL.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit($B.NEED_RENEW_SESSION)):EL.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(e)})),this.websocket.on(ZB.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((e=>{if(this.emit($B.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof CO&&e.code===yO.UNEXPECTED_RESPONSE&&e.data.code===YB.ERR_NO_AUTHORIZED)return EL.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",QO.SERVER_ERROR);EL.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",QO.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(ZB.REQUEST_NEW_URLS,((e,t)=>{tN(this,$B.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(ZB.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(JB.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}const wj=new Map;class Dj extends GO{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(TG.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(TG.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){EL.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),this.store=void 0,this.joinInfo=void 0,this.key=void 0,this.ntpOffset=0,this.signal=void 0,this.role=void 0,this.inChannelInfo={joinAt:null,duration:0},this.spec=void 0,this._state="DISCONNECTED",this._statsCollector=void 0,this._disconnectedReason=void 0,this.isSignalRecover=!1,this.hasChangeBGPAddress=!1,this.trafficStatsInterval=void 0,this.networkQualityInterval=void 0,this._joinGatewayStartTime=0,this._signalTimeout=!1,this._clientRoleOptions=void 0,this._isProactiveJoin=!1,this.store=e,this.spec=t,this.signal=this.store.useP2P?new bj(UB(UB({},t),{},{retryConfig:t.websocketRetryConfig}),e):this.store.useDataChannel?new Ij(UB(UB({},t),{},{retryConfig:t.websocketRetryConfig}),e):new lj(UB(UB({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,t,i){if(this.signal instanceof Ij){let t=!1;"disabled"!==e.cloudProxyServer?(EL.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),t=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(EL.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),t=!0):e.apResponse.addresses.some((e=>e.fingerprint))||JN("FINGERPRINT")||(EL.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),t=!0),t&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const n=Date.now();let s=wj.get(e.cname);if(s||(s=new Map,wj.set(e.cname,s)),this._isProactiveJoin=!0,s.has(e.uid)){const t=new eG(yO.UID_CONFLICT);throw CL.joinGateway(e.sid,{lts:n,succ:!1,ec:t.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof Ij?"1":"0"}),this._isProactiveJoin=!1,t}s.set(e.uid,!0),this.joinInfo=e,this.key=t;let r=0;this.joinGatewayStartTime=n;const o=e.proxyServer;try{let t;if(EL.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Ij?"datachannel":"websocket"," join uid ").concat(r)),this.signal instanceof Ij)t=await this.signal.init(e.apResponse.addresses,i);else{const n=e.gatewayAddrs.map((t=>{let{address:i}=t;const[n,s]=i.split(":"),r={host:n,port:s};return e.proxyServer&&(r.proxy=e.proxyServer),r}));t=await this.signal.init(n,i)}r=t.uid,EL.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Ij?"datachannel":"websocket"," join uid ").concat(r," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(t){if(t&&t.code===yO.INIT_WEBSOCKET_TIMEOUT)throw EL.warning("[".concat(this.store.clientId,"] User join failed"),t.toString()),t;if(t&&t.code===yO.INIT_DATACHANNEL_TIMEOUT)throw EL.warning("[".concat(this.store.clientId,"] User join datachannel failed"),t.toString()),this.resetSignal(),t;throw EL.error("[".concat(this.store.clientId,"] User join failed"),t.toString()),CL.joinGateway(e.sid,{lts:n,succ:!1,ec:t.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!o,signalChannel:this.signal instanceof Ij?"1":"0"}),this._isProactiveJoin=!1,s.delete(e.uid),this.signal.close(),t}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),EL.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((e=>{EL.warning("[".concat(this.store.clientId,"] get traffic stats error"),e.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(TG.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(TG.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(TG.NETWORK_QUALITY,{uplinkNetworkQuality:Ej(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Ej(this._statsCollector.trafficStats.B_dnq)}):this.emit(TG.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),r}async leave(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){t!==qO.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==qB.CONNECTED||await function(e,t){return t===1/0?e:Promise.race([e,vN(t)])}(this.signal.request(zB.LEAVE,void 0,!0),3e3)}catch(e){EL.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),e)}this.signal.close(t),t!==qO.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,t,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const n={state:"offer",p2p_id:this.store.p2pId,ortc:t,mode:this.spec.mode,extend:JN("PUB_EXTEND"),twcc:!!JN("PUBLISH_TWCC"),rtx:!!JN("USE_PUB_RTX")};try{return(await this.signal.request(zB.PUBLISH,n,!0))._message}catch(n){if(i&&n.data&&n.data.code===YB.ERR_PUBLISH_REQUEST_INVALID)return EL.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),n.toString()),await this.tryUnpubBeforeRepub(e,t),this.publish(e,t,!1);throw n}}async publishDataChannel(e,t,i){var n;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={stream_id:t.streamId,ordered:t.ordered?1:0,max_retrans_times:null!==(n=t.maxRetransmits)&&void 0!==n?n:10,channel_id:t.channelId,metadata:t.metadata};try{await this.signal.request(zB.PUBLISH_DATASTREAM,s,!0)}catch(n){if(i&&n.data&&n.data.code===YB.ERR_PUBLISH_REQUEST_INVALID)return EL.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),n.toString()),await this.tryUnpubDataChannelBeforeRepub(e,t),this.publishDataChannel(e,t,!1);throw n}}async unpublish(e,t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(zB.UNPUBLISH,{stream_id:t,ortc:e},!0)}catch(e){EL.warning("[".concat(this.store.clientId,"] unpublish warning: "),e)}}async unpublishDataChannel(e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Promise.all(e.map((e=>this.signal.request(zB.UNPUBLISH_DATASTREAM,{channel_id:e},!0))))}catch(e){EL.warning("unpublish datachannels warning: ",e)}}async presubscribe(e,t,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const n={stream_id:e,stream_type:t,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!JN("SUBSCRIBE_TWCC"),rtx:!!JN("USE_SUB_RTX")||void 0,extend:JN("SUB_EXTEND"),svc:Array.isArray(JN("SVC"))&&0!==JN("SVC").length?JN("SVC"):void 0};try{return await this.signal.request(zB.PRE_SUBSCRIBE,n,!0)}catch(n){if(i&&n.data&&n.data.code===YB.ERR_SUBSCRIBE_REQUEST_INVALID)return EL.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),n.toString()),this.presubscribe(e,t,!1);throw n}}async subscribe(e,t,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const n={stream_id:e,stream_type:t.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!JN("SUBSCRIBE_TWCC"),rtx:!!JN("USE_SUB_RTX"),extend:JN("SUB_EXTEND"),ssrcId:t.ssrcId,svc:Array.isArray(JN("SVC"))&&0!==JN("SVC").length?JN("SVC"):void 0};try{return(await this.signal.request(zB.SUBSCRIBE,n,!0))._message}catch(n){if(i&&n.data&&n.data.code===YB.ERR_SUBSCRIBE_REQUEST_INVALID)return EL.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),n.toString()),await this.tryUnsubBeforeResub(e,t),await this.subscribe(e,t,!1);throw n}}async subscribeDataChannel(e,t,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const n={uid:e,stream_id:t.id,channel_id:t.datachannelId};try{return void await this.signal.request(zB.SUBSCRIBE_DATASTREAM,n,!0)}catch(n){if(i&&n.data&&n.data.code===YB.ERR_SUBSCRIBE_REQUEST_INVALID)return EL.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),n.toString()),await this.tryUnsubDataChannelBeforeResub(e,t),await this.subscribeDataChannel(e,t,!1);throw n}}async subscribeAll(e,t){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!JN("USE_SUB_RTX")};try{return await this.signal.request(zB.SUBSCRIBE_STREAMS,i,!0)}catch(i){if(t&&i.data&&i.data.code===YB.ERR_SUBSCRIBE_REQUEST_INVALID)return EL.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),i.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw i}}async setVideoProfile(e){const t=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,i=e.width,n=e.height,s=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(s=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(s=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,t||(s=!1)),s?{stream_type:0,width:i,height:n,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(e);if(t)return this.signal.request(zB.SET_VIDEO_PROFILE,t);EL.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,t){try{await this.signal.request(zB.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:t},!0)}catch(e){EL.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),e)}}async unsubscribeDataChannel(e,t){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new eG(yO.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Promise.all(e.map((e=>this.signal.request(zB.UNSUBSCRIBE_DATASTREAM,{stream_id:e,uid:t},!0))))}catch(e){EL.warning("unsubscribeDataChannel warning: ",e)}}async massUnsubscribe(e){try{await this.signal.request(zB.UNSUBSCRIBE_STREAMS,e,!0)}catch(e){EL.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=e;return{gatewayEstablishParams:await this.signal.request(zB.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(zB.GATEWAY_INFO)}async renewToken(e){await this.signal.request(zB.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let i,n=0;"audience"===e?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(zB.SET_CLIENT_ROLE,{role:e,level:n,delay:i,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(zB.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(zB.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(zB.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(zB.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(zB.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,i){if(this.signal instanceof bj)return this.signal.sendExtensionMessage(e,t,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),UB({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(zB.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=wj.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:IB.username,password:IB.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(UB(UB({},IB),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(zB.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),null!=e.ntp_offset&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&hN((()=>{this.emit(TG.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new eG(yO.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let i=JN("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(e){i=void 0}i&&i.length>128&&(i=void 0);const n=UB({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:KN,browser:navigator.userAgent,process_id:JN("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:JN("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:JN("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:JN("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof JN("SUBSCRIBE_AUDIO_FILTER_TOPN")?JN("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof JN("ENABLE_PUBLISH_AUDIO_FILTER")?JN("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof JN("ENABLE_USER_LICENSE_CHECK")?JN("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===JN("USE_PUB_RTX")||!0===JN("USE_SUB_RTX")||void 0,disableFEC:JN("DISABLE_FEC"),enableNTPReport:!!JN("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!JN("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:"boolean"==typeof JN("ENABLE_DATASTREAM_2")?JN("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:"number"==typeof this.joinInfo.rtmFlag?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!JN("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:"boolean"==typeof JN("USE_XR")?JN("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,JN("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new eG(yO.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on($B.WS_RECONNECT_WAITTING_FINISH,(e=>{["tryNext","recover"].includes(e)&&this.joinInfo&&CL.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on($B.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on($B.WS_RECONNECTING,(e=>{this.joinInfo&&CL.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||QO.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",CL.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:"live"===this.spec.mode?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:"audience"===this.role?2:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on($B.WS_CLOSED,(e=>{let t;switch(e){case qO.LEAVE:t=QO.LEAVE;break;case qO.UID_BANNED:case qO.IP_BANNED:case qO.CHANNEL_BANNED:case qO.SERVER_ERROR:t=QO.SERVER_ERROR;break;case qO.FALLBACK:t=QO.FALLBACK;break;case qO.LICENSE_MISSING:case qO.LICENSE_EXPIRED:case qO.LICENSE_MINUTES_EXCEEDED:case qO.LICENSE_PERIOD_INVALID:case qO.LICENSE_MULTIPLE_SDK_SERVICE:case qO.LICENSE_ILLEGAL:case qO.TOKEN_EXPIRE:t=e;break;default:t=QO.NETWORK_ERROR}EL.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(t||"undefined -> "+QO.NETWORK_ERROR)),this.joinInfo&&CL.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===qO.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t}),this._disconnectedReason=e,e!==qO.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on($B.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(EL.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),CL.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Ij?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void EL.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));XN("EVENT_REPORT_DOMAIN",e[1]),XN("EVENT_REPORT_BACKUP_DOMAIN",e[1]),XN("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}})),this.signal.on(JB.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on($B.REQUEST_RECOVER,((e,t,i)=>{if(!this.joinInfo)return i(new eG(yO.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,tN(this,TG.REQUEST_NEW_GATEWAY_LIST).then(t).catch(i)})),this.signal.on($B.REQUEST_JOIN_INFO,(async e=>{var t;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:n,rtpCapabilities:s}=await tN(this,TG.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))})),this.signal.on($B.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on($B.REPORT_JOIN_GATEWAY,((e,t)=>{this.joinInfo&&(CL.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Ij?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on($B.IS_P2P_DISCONNECTED,(e=>{e(sN(this,TG.IS_P2P_DISCONNECTED))})),this.signal.on($B.DISCONNECT_P2P,(()=>{this.emit(TG.DISCONNECT_P2P)})),this.signal.on($B.NEED_RENEW_SESSION,(()=>{this.emit(TG.NEED_RENEW_SESSION)})),this.signal.on($B.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on($B.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on($B.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(TG.JOIN_RESPONSE,e,t)})),this.signal.on($B.DATACHANNEL_PRECONNECT,(async(e,t,i)=>{this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress();return tN(this,TG.DATACHANNEL_PRECONNECT,e,n).then(t).catch(i)})),this.signal.on($B.DATACHANNEL_CONNECTING,(async e=>{const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await tN(this,TG.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n,version:"2"}}))})),this.signal.on($B.DATACHANNEL_FAILBACK,(()=>{EL.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(TG.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(e,t){try{await this.signal.request(zB.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[t]},!0)}catch(e){throw EL.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),e),e}}async tryUnsubDataChannelBeforeResub(e,t){try{await this.signal.request(zB.UNSUBSCRIBE,{stream_id:t.id},!0)}catch(e){throw EL.warning("unsubscribe datachannel warning",e),e}}async tryUnpubBeforeRepub(e,t){try{await this.signal.request(zB.UNPUBLISH,{stream_id:e,ortc:t},!0)}catch(e){throw EL.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),e),e}}async tryUnpubDataChannelBeforeRepub(e,t){try{await this.signal.request(zB.UNPUBLISH_DATASTREAM,{channnel_id:t.channelId},!0)}catch(e){throw EL.warning("unpublish datastream warning: ",e),e}}async tryMassUnsubBeforeResub(e){const t={users:e.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(zB.UNSUBSCRIBE_STREAMS,t,!0)}catch(e){throw EL.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),e),e}}async muteLocal(e,t){const i={action:e.find((e=>e.stream_type===gG.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(zB.CONTROL,i,!0,!0)}catch(e){throw EL.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),e),e}}async unmuteLocal(e,t){const i={action:e.find((e=>e.stream_type===gG.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:t};try{await this.signal.request(zB.CONTROL,i,!0,!0)}catch(e){throw EL.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),e),e}}async muteRemote(e,t){const i={action:e===OG.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(zB.CONTROL,i,!0,!0)}catch(e){throw EL.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),e),e}}async unmuteRemote(e,t){const i={action:e===OG.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:t};try{await this.signal.request(zB.CONTROL,i,!0,!0)}catch(e){throw EL.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),e),e}}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const t={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(zB.RESTART_ICE,t,!0)}catch(e){throw EL.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),e),e}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,QO.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!JN("GATEWAY_WSS_ADDRESS"))return null!==(e=this.joinInfo)&&void 0!==e&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(zB.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(qO.FALLBACK)),this.store.useDataChannel=!1,this.signal=new lj(UB(UB({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(TG.RESET_SIGNAL,RG.websocket)}}let Oj=0,Nj=0;function Lj(e,t,i,n){return new Promise(((s,r)=>{t.timeout=t.timeout||JN("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),Oj+=TN(t.data)):i&&(t.data.size?Oj+=t.data.size:t.data instanceof FormData?Oj+=SN(t.data):Oj+=TN(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,YD.request(t).then((e=>{"string"==typeof e.data?Nj+=TN(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?Nj+=e.data.byteLength:Nj+=TN(JSON.stringify(e.data)),n&&s({data:e.data,headers:e.headers}),s(e.data)})).catch((e=>{YD.isCancel(e)?r(new eG(yO.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?r(new eG(yO.NETWORK_TIMEOUT,e.message)):e.response?r(new eG(yO.NETWORK_RESPONSE_ERROR,e.response.status)):r(new eG(yO.NETWORK_ERROR,e.message))}))}))}const Pj=()=>{const e=JN("AREAS");return 0===e.length&&e.push(yG.GLOBAL),e.reduce(((e,t,i)=>{const n=kj(t);return n?0===i?n:"".concat(e,",").concat(n):e}),"")},kj=e=>e===yG.OVERSEA?"".concat(IG.ASIA,",").concat(IG.EUROPE,",").concat(IG.AFRICA,",").concat(IG.NORTH_AMERICA,",").concat(IG.SOUTH_AMERICA,",").concat(IG.OCEANIA):IG[e],Mj=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const i=AG[e],n=Object.keys(i);n&&n.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(i[e]))}))})),t},Uj={GLOBAL:{ASIA:[yG.CHINA,yG.JAPAN,yG.INDIA,yG.KOREA,yG.HKMC],EUROPE:[],NORTH_AMERICA:[yG.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},xj=Object.keys(Uj[yG.GLOBAL]),Fj=[yG.CHINA,yG.NORTH_AMERICA,yG.EUROPE,yG.ASIA,yG.JAPAN,yG.INDIA,yG.OCEANIA,yG.SOUTH_AMERICA,yG.AFRICA,yG.KOREA,yG.HKMC,yG.US],Vj=function(e,t){let i=[];if(e.includes(yG.GLOBAL)){const r=[yG.GLOBAL,yG.OVERSEA],o=Object.keys(AG);if(t===yG.GLOBAL)throw new eG(yO.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===yG.CHINA)i=[yG.OVERSEA];else if(s=t,xj.includes(s)){const e=(n=t,Uj[yG.GLOBAL][n]||[]),s=[...r,t,...e];i=o.filter((e=>!s.includes(e)))}else if(function(e){let t=!1;return xj.forEach((i=>{Uj[yG.GLOBAL][i].includes(e)&&(t=!0)})),t}(t)){const e=function(e){let t;return xj.forEach((i=>{Uj[yG.GLOBAL][i].includes(e)&&(t=i)})),t}(t),n=[...r,e,t];i=o.filter((e=>!n.includes(e)))}else i=e;i=function(e){const t=[];return Fj.forEach((i=>{e.includes(i)&&t.push(i)})),t.concat(e.filter((e=>!Fj.includes(e))))}(i)}else i=e;var n,s;return i};function Bj(e){if(!e&&JN("AREAS").includes(yG.EXTENSIONS))return EL.debug("update area from ap : reset"),void Gj(CB,!0);if(!JN("AREAS").includes(yG.GLOBAL)||!e)return;let t=AG.EXTENSIONS;t&&(t={CODE:kj(yG.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},EL.debug("update area from ap success: ".concat(e,",config is "),t),XN("AREAS",[yG.EXTENSIONS],!0),Object.keys(t).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){XN(e,t[e][0])}else XN(e,t[e])})))}function Gj(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const i=CL.reportApiInvoke(null,{name:HO.SET_AREA,options:e,tag:KO.TRACER});try{let n=[];if("string"==typeof e&&(n=[e]),Array.isArray(e)&&(e.forEach((e=>{if(!CG.includes(e))throw new eG(yO.INVALID_PARAMS,"invalid area code")})),n=e),"[object Object]"===Object.prototype.toString.call(e)){const{areaCode:t,excludedArea:i}=e;if(!t)throw new eG(yO.INVALID_PARAMS,"area code is needed");let s=t;"string"==typeof t&&(s=[t]),n=i?Vj(s,i):s}if(!t){if(QN.AREAS){const e=new eG(yO.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(e),void EL.warning("setArea is prohibited because of config-distribute")}if(n.includes(yG.GLOBAL)&&JN("AREAS")===yG.EXTENSIONS){const e=new eG(yO.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(e),void EL.warning("setArea is prohibited because of ap extensions")}}XN("AREAS",n,t);const s=Mj(n);Object.keys(s).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){XN(e,s[e][0])}else XN(e,s[e])})),EL.debug("set area success:",n.join(","))}catch(e){throw i.onError(e),e}i.onSuccess()}let jj=1;let Wj=1;function Hj(e,t,i,n){let{url:s,areaCode:r}=e;const o=Date.now();let a;const[c,d]=zj(t,r,[hj.CHOOSE_SERVER]);let l=rN.networkState;return xN((async()=>{l&&rN.networkState===ZO.OFFLINE&&rN.onlineWaiter&&await Promise.race([rN.onlineWaiter,RN(n&&n.maxRetryTimeout||MN.maxRetryTimeout)]),l=rN.networkState;const{data:e,headers:r}=await Lj(s,{data:c,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);a="1"===r.http3?1:-1,CL.reportResourceTiming(s,t.sid),Yj(e,s,t,o,[hj.CHOOSE_SERVER],a);const d=_j(e,hj.CHOOSE_SERVER);return qj(d),pj(d,s)}),(e=>(e&&CL.joinChooseServer(t.sid,{lts:o,succ:!0,csAddr:s,opid:d,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[hj.CHOOSE_SERVER].toString(),isHttp3:a}),!1)),(e=>e.code!==yO.OPERATION_ABORTED&&(e.code===yO.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(CL.joinChooseServer(t.sid,{lts:o,succ:!1,csAddr:s,serverList:null,opid:d,ec:e.code,csIp:e.data&&e.data.csIp,unilbsServerIds:[hj.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:l}),isHttp3:a}),EL.warning("[".concat(t.clientId,"] Choose server network error, retry"),e),!0))),n)}function Kj(e,t,i,n){let s,{url:r,areaCode:o,serviceIds:a}=e;const c=Date.now(),[d,l]=zj(t,o,a);let h;return xN((async()=>{h&&rN.networkState===ZO.OFFLINE&&rN.onlineWaiter&&await Promise.race([rN.onlineWaiter,RN(n&&n.maxRetryTimeout||MN.maxRetryTimeout)]),h=rN.networkState;const{data:e,headers:o}=await Lj(r,{data:d,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);s="1"===o.http3?1:-1,CL.reportResourceTiming(r,t.sid),Yj(e,r,t,c,a,s);const l=_j(e,hj.CHOOSE_SERVER),u=_j(e,"proxy5"===t.cloudProxyServer?hj.CLOUD_PROXY_5:"proxy3"===t.cloudProxyServer||"proxy4"===t.cloudProxyServer?hj.CLOUD_PROXY:hj.CLOUD_PROXY_FALLBACK);return qj(l),{gatewayInfo:pj(l,r),proxyInfo:u,url:r}}),(e=>(e.gatewayInfo&&CL.joinChooseServer(t.sid,{lts:c,succ:!0,csAddr:r,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:l,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:s}),e.proxyInfo&&CL.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:r,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1)),(e=>e.code!==yO.OPERATION_ABORTED&&(e.code===yO.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(CL.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:r,turnServerAddrList:null,errorCode:e.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:h})}),EL.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),e),!0))),n)}const Yj=(e,t,i,n,s,r)=>{const o=[],a=o=>{4096===o.flag?CL.joinChooseServer(i.sid,{lts:n,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:o.error.message,csIp:o.error.data&&o.error.data.csIp,unilbsServerIds:s.toString(),isHttp3:r}):1048576!==o.flag&&4194304!==o.flag&&4194310!==o.flag||CL.joinWebProxyAP(i.sid,{lts:n,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:o.error.code,eventType:i.cloudProxyServer,unilbsServerIds:s.toString()})};if(e.response_body.forEach((t=>{const i=t.buffer.code;if(23===t.uri&&0===i&&!t.buffer.edges_services)if(4194310===t.buffer.flag)EL.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),t.buffer.edges_services=[];else{const i={error:new eG(yO.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:t.buffer.flag};o.push(i),a(i)}if(0!==i){const n=XG(i),s={error:new eG(yO.CAN_NOT_GET_GATEWAY_SERVER,n.desc,{desc:n.desc,retry:n.retry,csIp:e.detail[502]}),flag:t.buffer.flag};4194310===t.buffer.flag?EL.warning(s.error.toString()):o.push(s),a(s)}})),o.length)throw EL.warning("[".concat(i.clientId,"] multi unilbs ").concat(t," failed, ").concat(o.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new eG(yO.CAN_NOT_GET_GATEWAY_SERVER,o.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!o.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(o.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})},qj=e=>{var t,i,n,s;if(e.addresses&&0===e.addresses.length&&0===e.code)throw new eG(yO.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(JN("AP_AREA")&&(null!==(n=e.detail)&&void 0!==n&&n[23]&&"string"==typeof(null===(s=e.detail)||void 0===s?void 0:s[23])?Bj(e.detail[23].toLowerCase()):Bj()),null!==(t=e.detail)&&void 0!==t&&t[19]&&"string"==typeof(null===(i=e.detail)||void 0===i?void 0:i[19])){const t=e.detail[19],i=null==t?void 0:t.split(";");for(let t=0;t<i.length;t++){const n=i[t].trim();e.addresses[t]&&i&&(e.addresses[t].fingerprint=n)}}if(JN("GATEWAY_ADDRESS")&&JN("GATEWAY_ADDRESS").length>0){EL.debug("assign gateway address to",JN("GATEWAY_ADDRESS"));const t=JN("GATEWAY_ADDRESS").map((t=>{var i,n;const s=null!==(i=null===(n=e.addresses.find((e=>e.ip===t.ip&&e.port===t.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:t.ip,port:t.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:s}}));e.addresses=t}},$j=(e,t)=>{if(e.response_body&&e.response_body.length){const t=e.response_body[0];if(0!==t.buffer.code){const e=XG(t.buffer.code);throw new eG(yO.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(e.desc),{retry:e.retry})}return t.buffer.ticket}throw EL.debug("update ticket request received ap response without response body:",t),new eG(yO.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},zj=(e,t,i)=>{const n=Math.floor(Math.random()*10**12),s={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:UB({6:e.stringUid,11:t,12:JN("USE_NEW_TOKEN")?"1":void 0,22:t},e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:i,uid:e.uid||0}}]};s.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const r=new FormData;return r.append("request",JSON.stringify(s)),[r,n]},Xj=(e,t)=>{const i=Math.floor(Math.random()*10**12),n={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,i]};let Jj=0;function Qj(e){return Promise.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}const Zj=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:n,allFailedhandler:s,promisesCollector:r}=e,o=0;const a=t;let c,d=0;const l=async()=>{const e=(()=>{const e=o*a,t=e+a;return i.slice(e,t).map(n)})();r&&r.push(...e);try{c=await Qj(e)}catch(e){if(d+=a,o++,!(d>=i.length))return void await l();s(e)}e.forEach((e=>e.cancel()))};return await l(),c};async function eW(e,t,i,n){const s=async function(e,t,i,n){let s=null;const r=[],o=async()=>{const s=JN("WEBCS_DOMAIN").slice(0,JN("AJAX_REQUEST_CONCURRENT")).map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:Pj()}))),o=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((e=>e.url))}),a=await Zj({fragementLength:JN("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>(EL.debug("[".concat(e.clientId,"] Connect to choose_server:"),n.url),Hj(n,e,t,i)),allFailedhandler:e=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},o),e[0]},promisesCollector:r});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},o),a},a=async()=>{if(await RN(1e3),null!==s)return s;const o=JN("WEBCS_DOMAIN_BACKUP_LIST").map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:Pj()}))),a=n.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),c=await Zj({fragementLength:JN("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:n=>(EL.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),n.url),Hj(n,e,t,i)),allFailedhandler:e=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:r});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c};try{return s=await Qj([o(),a()]),r.length&&r.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),s}catch(e){throw e[0]}}(e,t,i,n);return{gatewayInfo:await s}}async function tW(e,t,i,n,s){const r=e.cloudProxyServer;if("disabled"===r){if(!n)return;if(e.useLocalAccessPoint)return await eW(e,t,i,s);if(JN("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:n,proxyInfo:r}=await nW(e,t,i,s);if(e.turnServer&&"auto"!==e.turnServer.mode)return{gatewayInfo:n};const a=r.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||IB.tcpport,udpport:e.udpport||IB.udpport,username:e.username||IB.username,password:e.password||IB.password,forceturn:!1,security:!0})));if(s.useP2P){var o;const t=null!==(o=e.uid)&&void 0!==o?o:n.uid,i="glb:".concat(t.toString()),s=await BO(i),c=r.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||IB.tcpport,udpport:e.udpport||IB.udpport,username:i,password:s,forceturn:!1,security:!0})));a.push(...c)}return e.turnServer={mode:"manual",servers:a},{gatewayInfo:n}}return await eW(e,t,i,s)}const{proxyInfo:a,gatewayInfo:c}=await nW(e,t,i,s),d={gatewayInfo:c},l=a.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===r?void 0:e.tcpport?e.tcpport:IB.tcpport,udpport:"proxy4"===r?void 0:e.udpport?e.udpport:IB.udpport,username:e.username||IB.username,password:e.password||IB.password,forceturn:"proxy4"!==r,security:"proxy5"===r})));if(s.useP2P){var h;const t=null!==(h=e.uid)&&void 0!==h?h:c.uid,i="glb:".concat(t.toString()),n=await BO(i),s=a.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===r?void 0:e.tcpport||IB.tcpport,udpport:"proxy4"===r?void 0:e.udpport||IB.udpport,username:i,password:n,forceturn:"proxy4"!==r,security:"proxy5"===r})));l.push(...s)}return e.turnServer={mode:"manual",servers:l},EL.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(r)),d}async function iW(e,t,i,n,s){const r=JN("ACCOUNT_REGISTER").slice(0,JN("AJAX_REQUEST_CONCURRENT"));let o=[];o=t.proxyServer?r.map((e=>"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):r.map((e=>"https://".concat(e,"/api/v1")));const a=null==s?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const r=await async function(e,t,i,n,s){const r=Date.now(),o={sid:i.sid,opid:10,appid:i.appId,string_uid:t};let a=e[0];const c=await xN((()=>Lj(a+"".concat(-1===a.indexOf("?")?"?":"&","action=stringuid"),{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((i,n)=>{if(0===i.code){if(i.uid<=0||i.uid>=Math.pow(2,32))throw EL.error("Invalid Uint Uid ".concat(t," => ").concat(i.uid),i),CL.reqUserAccount(o.sid,{lts:r,success:!1,serverAddr:a,stringUid:o.string_uid,uid:i.uid,errorCode:yO.INVALID_UINT_UID_FROM_STRING_UID,extend:o}),new eG(yO.INVALID_UINT_UID_FROM_STRING_UID);return CL.reqUserAccount(o.sid,{lts:r,success:!0,serverAddr:a,stringUid:o.string_uid,uid:i.uid,errorCode:null,extend:o}),!1}const s=XG(i.code);return s.retry&&(a=e[(n+1)%e.length]),CL.reqUserAccount(o.sid,{lts:r,success:!1,serverAddr:a,stringUid:o.string_uid,uid:i.uid,errorCode:s.desc,extend:o}),s.retry}),((t,i)=>t.code!==yO.OPERATION_ABORTED&&(CL.reqUserAccount(o.sid,{lts:r,success:!1,serverAddr:a,stringUid:o.string_uid,uid:null,errorCode:t.code,extend:o}),a=e[(i+1)%e.length],!0)),s);if(0!==c.code){const e=XG(c.code);throw new eG(yO.UNEXPECTED_RESPONSE,e.desc)}return c}(o,e,t,i,n);return null==s||s.recordJoinChannelService({status:"success",endTs:Date.now()},a),r.uid}catch(e){throw null==s||s.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},a),e}}async function nW(e,t,i,n){const s=JN("PROXY_SERVER_TYPE3"),r=(e,t,i)=>{let n=i||s;return Array.isArray(n)&&(n=t%2==0?s[1]:s[0]),"https://".concat(n,"/ap/?url=").concat(e)};let o=null;const a=[],c=async()=>{const s=JN("WEBCS_DOMAIN").slice(0,JN("AJAX_REQUEST_CONCURRENT")).map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:Pj(),serviceIds:[hj.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?hj.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?hj.CLOUD_PROXY:hj.CLOUD_PROXY_FALLBACK]}})),o=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((e=>e.url))}),c=await Zj({fragementLength:JN("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>(EL.debug("[".concat(e.clientId,"] Connect to choose_server:"),n.url),Kj(n,e,t,i)),allFailedhandler:e=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},o),e[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},o),c},d=async()=>{if(await RN(1e3),null!==o)return o;const s=JN("WEBCS_DOMAIN_BACKUP_LIST").map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):r("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:Pj(),serviceIds:[hj.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?hj.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?hj.CLOUD_PROXY:hj.CLOUD_PROXY_FALLBACK]}})),c=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:s.map((e=>e.url))}),d=await Zj({fragementLength:JN("FRAGEMENT_LENGTH"),referenceList:s,asyncMapHandler:n=>(EL.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),n.url),Kj(n,e,t,i)),allFailedhandler:e=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};let l,h,u;try{({gatewayInfo:l,proxyInfo:h,url:u}=await Qj([c(),d()]))}catch(e){throw e[0]}if(a.length&&a.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!l||!h)throw new eG(yO.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=u,"disabled"!==e.cloudProxyServer&&Array.isArray(s)&&u){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(u)[1];s.includes(t)&&(e.proxyServer=t,EL.setProxyServer(t),CL.setProxyServer(t))}return o={gatewayInfo:l,proxyInfo:await gj(h,l.uid)},o}async function sW(e,t,i,n){const s=JN("UAP_AP").slice(0,JN("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await function(e,t,i,n,s){jj+=1;const r={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:jj,requestId:jj,version:KN,cname:i.cname},o={service_name:t,json_body:JSON.stringify(r)};let a,c,d=e[0];return xN((async()=>{a=Date.now();const e=await Lj(d,{data:o,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,0!==e.code){const t=new eG(yO.UNEXPECTED_RESPONSE,"live streaming ap error, code"+e.code,{retry:!0,responseTime:c});throw EL.error(t.toString()),t}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new eG(yO.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:c});throw EL.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new eG(yO.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:i.code,responseTime:c});throw EL.error(e.toString()),e}const s=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(JN("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(i,t);return JN("LIVE_STREAMING_ADDRESS")&&(s.addressList=JN("LIVE_STREAMING_ADDRESS")instanceof Array?JN("LIVE_STREAMING_ADDRESS"):[JN("LIVE_STREAMING_ADDRESS")]),UB(UB({},s),{},{responseTime:c})}),((n,s)=>(CL.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(n.addressList),firstSuccess:0===s,responseTime:c,serverIp:e[s%e.length]}),!1)),((n,s)=>(CL.apworkerEvent(i.sid,{success:!1,sc:n.data&&n.data.code||200,serviceName:t,responseTime:c,serverIp:e[s%e.length]}),!!(n.code!==yO.OPERATION_ABORTED&&n.code!==yO.UNEXPECTED_RESPONSE||n.data&&n.data.retry)&&(d=e[(s+1)%e.length],!0))),s)}(s,e,t,i,n)}class rW extends GO{get isSuccess(){return!!this.configs}constructor(){super(),this.configs=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.retryConfig={timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4},this.interval=void 0,this.mutex=new PN("config-distribute"),this.mutableParamsRead=!1}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),JN("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),JN("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,CL.reportApiInvoke(null,{options:void 0,name:HO.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:KO.TRACER}).onSuccess(JSON.stringify(QN))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void EL.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const t=await this.mutex.lock();try{e=await async function(e,t,i){const n=JN("CDS_AP").slice(0,JN("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))).map((n=>function(e,t,i,n){const s=sO(),r={flag:64,cipher_method:0,features:{device:s.name,system:s.os,system_general:navigator.userAgent,vendor:t.appId,version:KN,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return xN((()=>Lj(e,{data:r,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==yO.OPERATION_ABORTED),n)}(n,e,t,i)));let s=null,r=null,o={};try{s=await Qj(n)}catch(e){if(e.code===yO.OPERATION_ABORTED)throw e;r=e}if(n.forEach((e=>e.cancel())),CL.reportApiInvoke(e.sid,{name:HO.REQUEST_CONFIG_DISTRIBUTE,options:{error:r,res:s}}).onSuccess(),s&&s.test_tags)try{o=function(e){if(!e.test_tags)return{};const t=e.test_tags,i=Object.keys(t),n={};return i.forEach((e=>{const i=e.slice(4).trim(),s=JSON.parse(t[e])[1];n[i]=s})),n}(s)}catch(e){}return o}(this.joinInfo,this.cancelToken,this.retryConfig),EL.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(e){const t=new eG(yO.NETWORK_RESPONSE_ERROR,e);EL.warning("[config-distribute] ".concat(t.toString()))}finally{t()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(bG.UPDATE_BITRATE_LIMIT,e):this.emit(bG.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&UB({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){const t=Object.keys(e).filter((e=>/^webrtc_ng_global_parameter/.test(e))).sort();for(let i=0;i<t.length;i++)for(let n=t.length-1;n>i;n--){const i=t[n];if("number"==typeof e[i].__priority){const s=e[i].__priority,r=t[n-1];if("number"==typeof e[r].__priority){if(!(s>e[r].__priority))continue;{const e=i;t[n]=t[n-1],t[n-1]=e}}else{const e=i;t[n]=t[n-1],t[n-1]=e}}}const i={};t.forEach((t=>{const n=e[t],s=n.__expires;Object.keys(n).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(i,e)||(i[e]=UB({value:n[e]},s&&{expires:s}))}))}));try{!function(e){try{const t=Date.now();Object.keys(e).forEach((i=>{switch(i){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(zN,i)){const{value:n,expires:s}=e[i];if(s&&s<=t)return;QN[i]=n,zN[i]=n,EL.debug("Update global parameters from config distribute",i,n)}}}))}catch(t){EL.error("Error update config immediately: ".concat(e),t.message)}}(i);const e=JSON.stringify(i),t=window.btoa(e);window.localStorage.setItem("websdk_ng_global_parameter",t),EL.debug("Caching global parameters ".concat(e))}catch(e){EL.error("Error caching global parameters:",e.message)}}}class oW extends GO{constructor(){super(...arguments),this.resultStorage=new Map}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,t){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){if(JN("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(e);if(n&&(n.result.push(i),n.result.length>=5)){const i=n.result.includes(!0);n.isPrevNormal&&!i&&this.emit("exception",aW[e],e,t),!n.isPrevNormal&&i&&this.emit("exception",aW[e]+2e3,e+"_RECOVER",t),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof oV&&!t.isActive||!!t.muted||0!==e.sendVolumeLevel}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=fj(t._encoderConfig.frameRate));const n=e.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof oV&&!t.isActive||!!t.muted||0!==e.sendBitrate}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const aW={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},cW=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}};var dW=(()=>{var e={8:(e,t,i)=>{i.r(t),i.d(t,{Parser:()=>R,Printer:()=>b,parse:()=>N,print:()=>L});const n="\n",s="".concat("\r").concat(n),r=" ";let o;function a(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function d(e){return c(e)||e>="Â"&&e<="Ã¿"}function l(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function h(e){return e>="1"&&e<="9"}function u(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function f(e){return e>""&&e<"\t"||e>"\v"&&e<"\f"||e>""&&e<"Ã¿"}function m(e){return u(e)||a(e)||"+"===e||"/"===e}function E(e){return a(e)||u(e)||"+"===e||"/"===e||"-"===e||"_"===e}function _(e){return u(e)||a(e)||"+"===e||"/"===e}function g(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function T(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?g(Object(i),!0).forEach((function(t){S(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):g(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function S(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(o||(o={}));class v{consumeText(e,t){let i=t;for(;i<e.length;){const t=e[i];if("\0"===t||"\r"===t||t===n)break;i+=1}if(i-t==0)throw new Error("Invalid text, at ".concat(e));return i}consumeUnicastAddress(e,t,i){return this.consumeTill(e,t,r)}consumeOneOrMore(e,t,i){let n=t;for(;i(e[n]);)n++;if(n-t==0)throw new Error("Invalid rule at ".concat(t,"."));return n}consumeSpace(e,t){if(e[t]===r)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let i=t;for(let t=0;t<4;t++)if(i=this.consumeDecimalUChar(e,i),3!==t){if("."!==e[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(e,t){let i=t;for(let t=0;t<3&&a(e[i]);t++,i++);if(i-t==0)throw new Error("Invalid decimal uchar.");const n=parseInt(e.slice(t,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let i=this.consumeHexpart(e,t);return":"===e[i]?(i+=1,i=this.consumeIP4Address(e,i),i):i}consumeHexpart(e,t){let i=t;if(":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}if(i=this.consumeHexseq(e,i),":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}return i}consumeHexseq(e,t){let i=t;for(;i=this.consumeHex4(e,i),":"===e[i]&&":"!==e[i+1];)i+=1;return i}consumeHex4(e,t){let i=0;for(;i<4;i++)if(!((n=e[t+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return t+i}consumeFQDN(e,t){let i=t;for(;a(e[i])||u(e[i])||"-"===e[i]||"."===e[i];)i+=1;if(i-t<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,d)}consumeMulticastAddress(e,t,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(i){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const i=this.consumeHexpart(e,t);return"/"===e[i]?this.consumeInteger(e,i+1):i}consumeIP4MulticastAddress(e,t){let i=t+3;const n=e.slice(t,i),s=parseInt(n);if(s<224||s>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let t=0;t<3;t++){if("."!==e[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(e,i)}return"/"===e[i]&&(i+=1),i=this.consumeTTL(e,i),"/"===e[i]&&(i=this.consumeInteger(e,i)),i}consumeInteger(e,t){if(!h(e[t]))throw new Error("Invalid integer.");for(t+=1;a(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!h(e[t]))throw new Error("Invalid TTL.");t+=1;for(let i=0;i<2&&a(e[t]);i++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,l)}consumeTime(e,t){let i=t;if("0"===e[i])return i+1;for(h(e[i])&&(i+=1);a(e[i]);)i++;if(i-t<10)throw new Error("Invalid time");return i}consumeAddress(e,t){return this.consumeTill(e,t,r)}consumeTypedTime(e,t){let i=t;return i=this.consumeOneOrMore(e,i,a),p(e[i])?i+1:i}consumeRepeatInterval(e,t){if(!h(e[t]))throw new Error("Invalid repeat interval");for(t+=1;a(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,a)}consume(e,t,i){for(let n=0;n<i.length;n++){if(t+n>=e.length)throw new Error("consume exceeding value length");if(e[t+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return t+i.length}consumeTill(e,t,i){let n=t;for(;n<e.length&&("string"!=typeof i||e[n]!==i)&&("function"!=typeof i||!i(e[n]));)n++;return n}}class R extends v{constructor(){super(),S(this,"records",[]),S(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!e.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),s=this.parseSessionName(),r=this.parseInformation(),o=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),l=this.parseBandWidth(),h=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),f=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:s,information:r,uri:o,emails:a,phones:c,connection:d,bandwidths:l,timeFields:h,key:u,attributes:p,mediaDescriptions:f}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===n)return"\r"===e[t-1]?s:n;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new C;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==o.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(e=>l(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,f)),e.parse(i),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new I(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==o.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(e=>l(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,f)),t.parse(i),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===o.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===o.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const i=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let n=!1;"-"===e.value[e.cur]&&(n=!0,e.cur+=1);const s=this.extract(e,this.consumeTypedTime);t.push({time:i,typedTime:s,back:n})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==o.REPEAT)break;{const i=this.extract(t,this.consumeRepeatInterval),n=this.parseTypedTime(t);e.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:i}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==o.BANDWIDTH)break;{const i=this.extractOneOrMore(t,l);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const n=this.extractOneOrMore(t,a);e.push({bwtype:i,bandwidth:n}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==o.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,a));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==o.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const s=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const r=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:i,sessVersion:n,nettype:s,addrtype:r,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===o.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==o.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===o.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==o.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==o.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===o.CONNECTION){const t=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:i,address:n}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let i=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,i+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const n=[];for(n.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,n.push(this.extract(e,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const s=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:i,protos:n,fmts:s}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===o.TIME;){const t=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();e.push({time:t,repeats:i,zones:n})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===o.MEDIA;){const t=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),s=this.parseBandWidth(),r=this.parseKey(),o=this.parseMediaAttributes(t);e.push({media:t,information:i,connections:n,bandwidths:s,key:r,attributes:o})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===o.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t,...i){const n=t.call(this,e.value,e.cur,...i),s=e.value.slice(e.cur,n);return e.cur=n,s}extractOneOrMore(e,t){const i=this.consumeOneOrMore(e.value,e.cur,t),n=e.value.slice(e.cur,i);return e.cur=i,n}consumeSpaceForRecord(e){if(e.value[e.cur]!==r)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class y extends v{constructor(...e){super(...e),S(this,"attributes",void 0),S(this,"digested",!1)}extractOneOrMore(e,t,i){const n=this.consumeOneOrMore(e.attValue,e._cur,t),s=e.attValue.slice(e._cur,n),[r,o]=i||[];if("number"==typeof r&&s.length<r)throw new Error("error in length, should be more or equal than ".concat(r," characters."));if("number"==typeof o&&s.length>o)throw new Error("error in length, should be less or equal than ".concat(o," characters."));return e._cur=n,s}consumeAttributeSpace(e){if(e.attValue[e._cur]!==r)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t,...i){if(!e.attValue)throw new Error("Nothing to extract from attValue.");const n=t.call(this,e.attValue,e._cur,...i),s=e.attValue.slice(e._cur,n);return e._cur=n,s}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let i=0;i<t.length;i++)if(t[i]!==e.attValue[e._cur+i])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,m,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,m,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,m));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:i})}parseExtmap(e){const t=this.extractOneOrMore(e,a);let i;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),i=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,r),s=T(T({entry:parseInt(t,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(e)===r&&(this.consumeAttributeSpace(e),s.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(s)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class C extends y{constructor(...e){super(...e),S(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===r;)this.consumeAttributeSpace(e),i.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,E)}parseIdentity(e){const t=this.extractOneOrMore(e,_),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===r;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const n=this.extractOneOrMore(e,(e=>e!==r&&f(e)));i.push({name:t,value:n})}this.attributes.identities.push({assertionValue:t,extensions:i})}parseMsidSemantic(e){this.peekChar(e)===r&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const i=this.extract(e,this.consumeTill,r);t.identifierList.push(i)}}this.attributes.msidSemantic=t}}class I extends y{constructor(e){super(),S(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,m,[1,32]);this.consumeAttributeSpace(e);const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const s=this.extractOneOrMore(e,a,[1,10]);this.consumeAttributeSpace(e);const o=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const d=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const l={foundation:t,componentId:i,transport:n,priority:s,connectionAddress:o,port:d,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),l.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),l.relPort=this.extract(e,this.consumePort));this.peekChar(e)===r;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),l.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(l)}parseRemoteCandidate(e){const t=[];for(;;){const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const s=this.extract(e,this.consumePort);t.push({componentId:i,connectionAddress:n,port:s});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(e,a)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),n.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,a);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,":");let n;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),n=this.extract(e,this.consumeTill));const s=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));s?s.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[i]:n}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,r);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill),n={};i.split(";").forEach((e=>{let[t,i]=e.split("=");t=t.trim();const s="string"==typeof i?i.trim():null;"string"==typeof t&&t.length>0&&(n[t]=s)}));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(e){const t={},i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");for(t[i]=n;";"===e.attValue[e._cur];){const i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");t[i]=n}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,r),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,r);let n;if("trr-int"===i)n={type:i,interval:this.extract(e,this.consumeTill)};else{const t={type:i};this.peekChar(e)===r&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===r&&(t.additional=this.extract(e,this.consumeTill))),n=t}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(n);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===r&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,l,[1,64])};this.peekChar(e)===r&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,l,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>u(e)||a(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const i={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===r){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const i=this.extract(e,this.consumeToken);t.push(i);try{this.extract(e,this.consume,",")}catch(e){break}}i.payloads=t,this.peekChar(e)===r&&this.extract(e,this.consume,r)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const n={type:t,rids:this.extract(e,this.consume,"=").split(",")};i.params.push(n);break}default:{const n={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),n.val=this.extract(e,this.consumeTill,";")),i.params.push(n)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(i)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,a,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);i.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:i})}}function A(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class b{constructor(){A(this,"eol",s)}print(e,t){let i="";return t&&(this.eol=t),i+=this.printVersion(e.version),i+=this.printOrigin(e.origin),i+=this.printSessionName(e.sessionName),i+=this.printInformation(e.information),i+=this.printUri(e.uri),i+=this.printEmail(e.emails),i+=this.printPhone(e.phones),i+=this.printConnection(e.connection),i+=this.printBandwidth(e.bandwidths),i+=this.printTimeFields(e.timeFields),i+=this.printKey(e.key),i+=this.printSessionAttributes(e.attributes),i+=this.printMediaDescription(e.mediaDescriptions),i}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printPhone(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const i of e)t+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const i of e){t+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const e of i.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(t+="z=",t+="z=".concat(i.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const i of e)t+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const i of e)t+=this.printMedia(i.media),t+=this.printInformation(i.information),t+=this.printConnections(i.connections),t+=this.printBandwidth(i.bandwidths),t+=this.printKey(i.key),t+=this.printMediaAttributes(i);return t}printConnections(e){let t="";for(const i of e)t+=this.printConnection(i);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new D(this.eol).print(e)}printMediaAttributes(e){return new O(this.eol).print(e)}}class w{constructor(e){A(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(r)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(r).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(r).concat(e.extensionName).concat(e.extensionAttributes?"".concat(r).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class D extends w{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(r).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(r).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(r,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(r).concat(e)))),t+this.eol}}class O extends w{print(e){const t=e.attributes;let i="";return i+=this.printRTCP(t.rtcp),i+=this.printIceUfrag(t.iceUfrag),i+=this.printIcePwd(t.icePwd),i+=this.printIceOptions(t.iceOptions),i+=this.printCandidates(t.candidates),i+=this.printRemoteCandidatesList(t.remoteCandidatesList),i+=this.printEndOfCandidates(t.endOfCandidates),i+=this.printFingerprints(t.fingerprints),i+=this.printSetup(t.setup),i+=this.printMid(t.mid),i+=this.printExtmap(t.extmaps),i+=this.printRTPRelated(t),i+=this.printPtime(t.ptime),i+=this.printMaxPtime(t.maxPtime),i+=this.printDirection(t.direction),i+=this.printSSRCGroups(t.ssrcGroups),i+=this.printSSRC(t.ssrcs),i+=this.printRTCPMux(t.rtcpMux),i+=this.printRTCPMuxOnly(t.rtcpMuxOnly),i+=this.printRTCPRsize(t.rtcpRsize),i+=this.printMSId(t.msids),i+=this.printImageattr(t.imageattr),i+=this.printRid(t.rids),i+=this.printSimulcast(t.simulcast),i+=this.printSCTPPort(t.sctpPort),i+=this.printMaxMessageSize(t.maxMessageSize),i+=this.printUnrecognized(t.unrecognized),i}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(r).concat(e.componentId).concat(r).concat(e.transport).concat(r).concat(e.priority).concat(r).concat(e.connectionAddress).concat(r).concat(e.port).concat(r,"typ").concat(r).concat(e.type).concat(e.relAddr?"".concat(r,"raddr").concat(r).concat(e.relAddr):"").concat(e.relPort?"".concat(r,"rport").concat(r).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(r).concat(t).concat(r).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(r)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let i="";i+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const e of t)i+=this.printRtpMap(e.payloadType,e.rtpMap),i+=this.printFmtp(e.payloadType,e.fmtp),i+=e.rtcpFeedbacks.map((t=>this.printRTCPFeedback(e.payloadType,t))).join("");return i}printFmtp(e,t){if(!t)return"";const i=Object.keys(t.parameters);return 1===i.length&&null===t.parameters[i[0]]?"a=fmtp:".concat(e).concat(r).concat(i[0]).concat(this.eol):"a=fmtp:".concat(e).concat(r).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(r).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let i="a=rtcp-fb:".concat(e).concat(r),n=t;return"trr-int"===n.type?i+="ttr-int".concat(r).concat(n.interval):(i+="".concat(n.type),n.parameter&&(i+="".concat(r).concat(n.parameter),n.additional&&(i+="".concat(r).concat(n.additional)))),i+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(r).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(r).concat(e.netType)),e.addressType&&(t+="".concat(r).concat(e.addressType)),e.address&&(t+="".concat(r).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(r).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(r).concat(e.direction);return e.payloads&&(t+="".concat(r,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(r).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(r).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function N(e){return(new R).parse(e)}function L(e,t){return(new b).print(e,t)}}},t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}return i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(8)})();function lW(e){if(Array.isArray(e))return e.map((e=>e));if(!hW(e))return e;const t={};for(const i in e){const n=e[i];hW(n)||Array.isArray(n)?t[i]=lW(n):t[i]=n}return t}function hW(e){return!("object"!=typeof e||Array.isArray(e)||!e)}class uW{constructor(e){this.input=[],this.size=void 0,this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const pW={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},fW={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:pW,remoteCandidate:pW}},mW={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},EW={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},_W={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},gW={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};class TW{constructor(e,t){this.onFirstVideoReceived=void 0,this.onFirstVideoDecoded=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onFirstAudioDecoded=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.videoIsReady=!1,this.videoIsReady2={},this.pc=void 0,this.options=void 0,this.intervalTimer=void 0,this.stats=lW(fW),this.isFirstVideoReceived={},this.isFirstVideoDecoded={},this.isFirstAudioReceived={},this.isFirstAudioDecoded={},this.isFirstVideoDecodedTimeout={},this.lossRateWindowStats=[],this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Promise((e=>{e({local:UB({},pW),remote:UB({},pW)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,s=0,r=0,o=0;for(const a of i)e[a].forEach(((e,i)=>{if(!this.lossRateWindowStats[t-1][a][i]||!this.lossRateWindowStats[0][a][i])return;const c=this.lossRateWindowStats[t-1][a][i].packets-this.lossRateWindowStats[0][a][i].packets,d=this.lossRateWindowStats[t-1][a][i].packetsLost-this.lossRateWindowStats[0][a][i].packetsLost;"videoSend"===a||"audioSend"===a?(n+=c,r+=d):(s+=c,o+=d),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||d<=0?0:d/(c+d)}));e.sendPacketLossRate=n<=0||r<=0?0:r/(n+r),e.recvPacketLossRate=s<=0||o<=0?0:o/(s+o)}}class SW extends TW{constructor(){super(...arguments),this._stats=fW,this.lastDecodeVideoReceiverStats=new Map}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=lW(fW);const i=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(i);const n=t.find((e=>"VideoBwe"===e.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{const t=e.id.includes("send");switch("".concat(e.mediaType,"_").concat(t?"send":"recv")){case"video_send":{const t=lW(EW);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=lW(mW),i=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),i){const n=i.stats,s=Date.now()-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:UB({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=lW(gW);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=lW(_W);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new Promise(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t.push(i)})),t}}class vW extends TW{constructor(){super(...arguments),this._stats=fW,this.report=void 0,this.lastDecodeVideoReceiverStats=new Map,this.lastVideoFramesRecv=new Map,this.lastVideoFramesSent=new Map,this.lastVideoFramesDecode=new Map,this.lastVideoJBDelay=new Map,this.lastAudioJBDelay=new Map,this.mediaBytesSent=new Map,this.mediaBytesRetransmit=new Map,this.mediaBytesTargetEncode=new Map,this.lastEncoderMs=new Map}async updateStats(){this.report=await this.pc.getStats(),this._stats=lW(fW),this.report.forEach((e=>{switch(e.type){case GB.OUTBOUND:case GB.INBOUND:{const t=e.mediaType||e.kind,i=!t&&"frameWidth"in e,n=!t&&!("frameWidth"in e);e.type===GB.OUTBOUND?"audio"===t||n?this.processAudioOutboundStats(e):("video"===t||i)&&this.processVideoOutboundStats(e):e.type===GB.INBOUND&&("audio"===t||n?this.processAudioInboundStats(e):("video"===t||i)&&this.processVideoInboundStats(e));break}case GB.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case GB.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:UB({},pW),remote:UB({},pW)};return e.forEach((i=>{let n;if(i.type===GB.TRANSPORT&&(n=e.get(i.selectedCandidatePairId)),i.type===GB.CANDIDATE_PAIR&&i.selected&&(n=i),n){const i=(e,t)=>{e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol)};if(n.localCandidateId){const s=e.get(n.localCandidateId);s&&i(t.local,s)}if(n.remoteCandidateId){const s=e.get(n.remoteCandidateId);s&&i(t.remote,s)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===GB.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===GB.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===GB.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(UB({},t),UB({},this.stats.selectedCandidatePair.localCandidate)),e.type===GB.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(UB({},t),UB({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=lW(gW),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=lW(mW),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const i=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),s=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,i=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,i),this.isFirstVideoDecoded[t.ssrc]=!0}if(i){const n=i.stats,r=s-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&r>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=r,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}n&&s-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((s-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:0}),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:UB({},t),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=lW(EW),this._stats.videoSend.push(t));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const t=new uW(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new uW(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new uW(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const n=e.framesEncoded-i.lastFrameCount,s=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*s/n}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,GB.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=lW(_W),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,GB.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}findRemoteStatsId(e,t){const i=Array.from(this.report.values()).find((i=>i.type===t&&i.ssrc===e));return i?i.id:null}processVideoMediaSource(e,t){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(t.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,t){const i=this.report.get(e);i&&(t.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,t,i){var n,s,r,o;const a=t?this.report.get(t):void 0,c=null!==(n=null==a?void 0:a.framesSent)&&void 0!==n?n:e.framesSent;if("number"!=typeof c)return;let d=null!==(s=null==a?void 0:a.frameWidth)&&void 0!==s?s:e.frameWidth,l=null!==(r=null==a?void 0:a.frameHeight)&&void 0!==r?r:e.frameHeight,h=null!==(o=null==a?void 0:a.framesPerSecond)&&void 0!==o?o:e.framesPerSecond;if("number"==typeof d&&"number"==typeof l||(d=0,l=0),null==h){const e=Date.now(),t=this.lastVideoFramesSent.get(i.ssrc);t&&e-t.lts>=800?(h=Math.round((c-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:h})):t?h=t.rate:this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:0})}i.sentFrame={width:d,height:l,frameRate:Math.max(0,h)}}processVideoTrackReceiverStats(e,t,i){var n,s,r,o,a;const c=t?this.report.get(t):void 0,d=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:e.framesReceived,l=null!==(s=null==c?void 0:c.frameWidth)&&void 0!==s?s:e.frameWidth,h=null!==(r=null==c?void 0:c.frameHeight)&&void 0!==r?r:e.frameHeight,u=null!==(o=null==c?void 0:c.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount;if("number"==typeof d){const e=this.lastVideoFramesRecv.get(i.ssrc),t=Date.now();i.framesReceivedCount=d;let n=0;e&&t-e.lts>=800?(n=Math.round((d-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:n})):e?n=e.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:0}),i.receivedFrame={width:l||0,height:h||0,frameRate:n||0},i.decodedFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0}}if(u&&p){const e=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=p-e.jitterBufferEmittedCount;n>0&&(t=1e3*(u-e.jitterBufferDelay)/n),i.jitterBufferMs=t,i.currentDelayMs=Math.round(t),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(e,t,i){var n,s,r,o;const a=t?this.report.get(t):void 0,c=null!==(n=null!==(s=null==a?void 0:a.echoReturnLoss)&&void 0!==s?s:e.echoReturnLoss)&&void 0!==n?n:0,d=null!==(r=null!==(o=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==o?o:e.echoReturnLossEnhancement)&&void 0!==r?r:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,i){var n,s,r,o,a,c,d;const l=t?this.report.get(t):void 0,h=null!==(n=null==l?void 0:l.removedSamplesForAcceleration)&&void 0!==n?n:e.removedSamplesForAcceleration,u=null!==(s=null==l?void 0:l.totalSamplesReceived)&&void 0!==s?s:e.totalSamplesReceived,p=null!==(r=null==l?void 0:l.jitterBufferDelay)&&void 0!==r?r:e.jitterBufferDelay,f=null!==(o=null==l?void 0:l.jitterBufferEmittedCount)&&void 0!==o?o:e.jitterBufferEmittedCount,m=null!==(a=null==l?void 0:l.audioLevel)&&void 0!==a?a:null==e?void 0:e.audioLevel,E=null!==(c=null==l?void 0:l.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,_=null!==(d=null==l?void 0:l.concealedSamples)&&void 0!==d?d:e.concealedSamples;if(h&&u&&(i.accelerateRate=h/u),p&&f){const e=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=f-e.jitterBufferEmittedCount;n>0&&(t=1e3*(p-e.jitterBufferDelay)/n),i.jitterBufferMs=Math.round(t),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:f,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=m;let g=1920;E&&u&&(g=u/E/50,i.receivedFrames=Math.round(u/g)),_&&(i.droppedFrames=Math.round(_/g))}processRemoteInboundStats(e,t){const i=this.report.get(e);i&&(t.packetsLost=i.packetsLost,i.roundTripTime&&(t.rttMs=1e3*i.roundTripTime),i.jitter&&(t.jitterMs=1e3*i.jitter),i.timestamp&&(t.timestamp=i.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const i=t.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,t=null,i=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{i=null===i?e.diffMean():i+e.diffMean()}));const n=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class RW extends TW{updateStats(){return Promise.resolve()}}function yW(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const r=function(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}();return r?r<76?new SW(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new vW(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):function(e){return!!window.RTCStatsReport&&e.getStats()instanceof Promise}(e)?new vW(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new RW(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s})}function CW(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:s,filterVideoFec:r,filterAudioFec:o,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:d}=i;let l=[],h=[],u=[],p=[],f=!1,m=!1;if(dW.parse(e).mediaDescriptions.forEach((e=>{n&&n!==e.attributes.direction||("video"!==e.media.mediaType||f||(h=e.attributes.payloads,p=e.attributes.extmaps,f=!0),"audio"!==e.media.mediaType||m||(l=e.attributes.payloads,u=e.attributes.extmaps,m=!0))})),!p||0===h.length)throw new Error("Cannot get video capabilities from SDP.");if(!u||0===l.length)throw new Error("Cannot get audio capabilities from SDP.");h.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),l.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),s&&(l=l.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),h=h.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),r&&(h=h.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),o&&(l=l.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),a&&(null==a?void 0:a.length)>0&&(l=l.filter((e=>{var t;return a.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0&&(h=h.filter((e=>{var t;return c.includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")})));const E=JN("UNSUPPORTED_VIDEO_CODEC");return E&&E.length>0&&(h=h.filter((e=>!(e.rtpMap&&E.includes(e.rtpMap.encodingName.toLowerCase()))))),{audioCodecs:l,videoCodecs:h,audioExtensions:u,videoExtensions:p}}function IW(e){const t=dW.parse(e);let i,n;for(const e of t.mediaDescriptions){if(!i){const t=e.attributes.iceUfrag,n=e.attributes.icePwd;if(!t||!n)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:t,icePwd:n}}if(!n){const t=e.attributes.fingerprints;t.length>0&&(n={fingerprints:t})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function AW(e,t){const i=[],n=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),s=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),r=e.attributes.ssrcs;if(s)s.ssrcIds.forEach((e=>{var s;const r=null===(s=n.find((t=>t.ssrcIds[0]===e)))||void 0===s?void 0:s.ssrcIds[1];i.push({ssrcId:e,rtx:t?r:void 0})}));else if(n.length>0){const e=n[0].ssrcIds[0],s=n[0].ssrcIds[1];i.push({ssrcId:e,rtx:t?s:void 0})}else{if(0===r.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:r[0].ssrcId})}return i}function bW(e,t){const{cname:i}=e;let n;t&&t.ip&&"number"==typeof t.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],EL.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),EL.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):n=e.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}})));const s={fingerprints:e.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},r={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let o;switch(e.dtlsParameters.role){case"server":o="passive";break;case"client":o="active";break;case"auto":o="actpass"}return{dtlsParameters:s,iceParameters:r,candidates:n,rtpCapabilities:FW(e.rtpCapabilities),setup:o,cname:i}}function wW(e,t,i){const n=[],s=[];return e.forEach((e=>{let{ssrcId:r,rtx:o}=e;const a=yN(8,"track-"),c={ssrcId:r,attributes:UB({label:a,mslabel:i=i||yN(10,""),msid:"".concat(i," ").concat(a)},t&&{cname:t})};if(n.push(c),void 0!==o){const e={ssrcId:o,attributes:UB({label:a,mslabel:i,msid:"".concat(i," ").concat(a)},t&&{cname:t})};n.push(e),s.push({semantic:"FID",ssrcIds:[r,o]})}})),e.length>1&&s.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:n,ssrcGroups:s}}function DW(e,t){t instanceof sV&&e.attributes.payloads.forEach((e=>{var i;const n=null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(s.bitrate&&!lO()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function OW(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function NW(e,t){if(!(t instanceof XV&&t._encoderConfig&&-1===t._hints.indexOf(fx.SCREEN_TRACK)))return;const i=t._encoderConfig;nx().supportMinBitrate&&i.bitrateMin&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),nx().supportMinBitrate&&!t._hints.includes(fx.LOW_STREAM)&&i.bitrateMax&&e.attributes.payloads.forEach((e=>{var t;["h264","h265","vp8","vp9","av1"].includes((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(JN("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function LW(e){if("video"!==e.media.mediaType)return;const t=sO();if(t.name!==eO.SAFARI&&t.os!==ZD.IOS)return;const i=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==i&&e.attributes.extmaps.splice(i,1)}function PW(e,t,i){if(!t)return;let n,s;if("video"===e.media.mediaType?(n=i.videoExtensions,s=i.videoCodecs):(n=i.audioExtensions,s=i.audioCodecs),!0===t.twcc){const t=n.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=n.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function kW(e,t,i){if(lO())return;if("video"!==e.media.mediaType)return;if(!(t instanceof XV))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!JN("SIMULCAST"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const n="vp8"===i?2:t._scalabilityMode.numSpatialLayers,s=e.attributes.ssrcs[0],r=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===s.ssrcId)),o={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let t=1;t<n;t++)e.attributes.ssrcs.push({ssrcId:s.ssrcId+t,attributes:uN(s.attributes)}),o.ssrcIds.push(s.ssrcId+t),r&&(e.attributes.ssrcs.push({ssrcId:r.ssrcIds[1]+t,attributes:uN(s.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+t,r.ssrcIds[1]+t]}));e.attributes.ssrcGroups.unshift(o)}async function MW(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});const n=(await i.createOffer()).sdp,{send:s,recv:r,sendrecv:o}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2?arguments[2]:void 0;const n=CW(i,e,t,"sendonly"),s=CW(i,e,t,"recvonly"),r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},a={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(xW(n,s,"videoExtensions",r,o,a),xW(n,s,"videoCodecs",r,o,a),xW(n,s,"audioExtensions",r,o,a),xW(n,s,"audioCodecs",r,o,a),JN("RAISE_H264_BASELINE_PRIORITY")){const e=a.videoCodecs.findIndex((e=>{var t,i;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==e){const t=a.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(t<e){EL.debug("raising H264 baseline profile priority");const i=a.videoCodecs[e];a.videoCodecs.splice(e,1),a.videoCodecs.splice(t,0,i)}-1!==t&&(o.videoCodecs=o.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==t&&JN("FILTER_SEND_H264_BASELINE")&&(r.videoCodecs=r.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}return{send:r,recv:o,sendrecv:a}}(e,t,n);try{i.close()}catch(e){}return{send:s,recv:r,sendrecv:o}}function UW(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=CW(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"recvonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(xW(e,t,"videoExtensions",i,n,s),xW(e,t,"videoCodecs",i,n,s),xW(e,t,"audioExtensions",i,n,s),xW(e,t,"audioCodecs",i,n,s),JN("RAISE_H264_BASELINE_PRIORITY")){const e=s.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const t=s.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(t<e){EL.debug("raising H264 baseline profile priority");const i=s.videoCodecs[e];s.videoCodecs.splice(e,1),s.videoCodecs.splice(t,0,i)}-1!==t&&(n.videoCodecs=n.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:i,recv:n,sendrecv:s}}function xW(e,t,i,n,s,r){if("videoExtensions"===i||"audioExtensions"===i){const o=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return o.push(i),!0}))?r[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===o.indexOf(t)&&s[i].push(e)}))}if("videoCodecs"===i||"audioCodecs"===i){const o=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return o.push(i),!0}))?r[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===o.indexOf(t)&&s[i].push(e)}))}}function FW(e){const{send:t,recv:i,sendrecv:n}=e;if(!n){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let s,r;return t?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...t.audioCodecs,...n.audioCodecs],s.videoCodecs=[...t.videoCodecs,...n.videoCodecs],s.audioExtensions=[...t.audioExtensions,...n.audioExtensions],s.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):s=n,i?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...i.audioCodecs,...n.audioCodecs],r.videoCodecs=[...i.videoCodecs,...n.videoCodecs],r.audioExtensions=[...i.audioExtensions,...n.audioExtensions],r.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):r=n,{send:s,recv:r}}function VW(e){"audio"===e.media.mediaType&&e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function BW(e){e.mediaDescriptions.forEach((e=>{"video"!==e.media.mediaType&&"audio"!==e.media.mediaType||e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))}))}function GW(e,t,i,n){let s=[];if(e===OG.VIDEO){if(JN("H264_PROFILE_LEVEL_ID")&&"h264"===n&&(s=t.videoCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(n)&&e&&e.fmtp&&e.fmtp.parameters["profile-level-id"]===JN("H264_PROFILE_LEVEL_ID")))),!Array.isArray(s)||0===s.length){let e=[];const r=[],o=[];i.videoCodecs.forEach((t=>{(t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").includes(n)&&e.push(t),(t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").includes("vp8")&&r.push(t),(t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").includes("h264")&&o.push(t)})),0===e.length&&(0!==r.length?(e=r,EL.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: vp8"))):0!==o.length&&(e=o,EL.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: h264")))),0!==e.length&&(s=t.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(JN("USE_PUB_RTX")){const e=s.map((e=>e.payloadType.toString())),i=t.videoCodecs.filter((t=>t.rtpMap&&"rtx"===t.rtpMap.encodingName&&e.includes(t.fmtp&&t.fmtp.parameters.apt||"")));s=[...s,...i]}0===s.length&&(EL.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),s=t.videoCodecs)}else s=t.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(n))),0===s.length&&(EL.warning("codec ".concat(n," not included in rtpCapabilities, fallback to opus")),s=t.audioCodecs.filter((e=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes("opus"))));return s}let jW=class{get localCapabilities(){return uN(this._localCapabilities)}get rtpCapabilities(){return uN(this._rtpCapabilities)}get candidates(){return uN(this._candidates)}get iceParameters(){return uN(this._iceParameters)}get dtlsParameters(){return uN(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname="o/i14u9pJrxRKAsu",this.firefoxSsrcMidMap=new Map,e=uN(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,localCapabilities:r,direction:o,setup:a,videoCodec:c,audioCodec:d}=e;let l;this.setup=a,l=o===QB.RECEIVE_ONLY?dW.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"):dW.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=extmap-allow-mixed\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=recvonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n"),this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=r;const h=o===QB.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,u=o===QB.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=o===QB.RECEIVE_ONLY?s.send.videoCodecs:GW(OG.VIDEO,h,u,c),f=o===QB.RECEIVE_ONLY?s.send.audioCodecs:GW(OG.AUDIO,h,u,d);for(const e of l.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=p.map((e=>e.payloadType.toString(10))),e.attributes.payloads=p,e.attributes.extmaps=h.videoExtensions,JN("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=wW([{ssrcId:4e4,rtx:JN("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=f.map((e=>e.payloadType.toString(10))),e.attributes.payloads=f,e.attributes.extmaps=h.audioExtensions,VW(e),JN("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=wW([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return dW.print(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((e=>this.hasMid(e))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,i,n,s){i=i.replace(/ /g,"-");const{ssrcs:r,ssrcGroups:o}=wW(t,this.cname,JN("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(r);if(a){if(lO()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,a.attributes.mid),s&&(s.twcc||s.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(a,s),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,r,n);let i;return-1===t?(i=this.createOrRecycleSendMedia(e,r,o,"sendonly",n,s),this.updateBundleMids()):(i=uN(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=r,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,s)),lO()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,i.attributes.mid),{needExchangeSDP:!0,mid:i.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{e.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,i){const n=[];return e.forEach((e=>{const s=e._mediaStreamTrack.kind,r=this.findAvailableRecvMediaIndex(s);let o,a=!1;-1===r?(a=!0,o=this.createOrRecycleRecvMedia(e,[],"recvonly",t,i),this.updateBundleMids()):(o=uN(this.sessionDesc.mediaDescriptions[r]),o.attributes.direction="recvonly"),n.push({mid:o.attributes.mid,needCreateTransceiver:a})})),n}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:i,address:n,port:s,type:r,relatedAddress:o,relatedPort:a,priority:c}=new RTCIceCandidate(e),d={foundation:null!=t?t:"",componentId:"1",transport:null!=i?i:"",priority:c?c+"":"",connectionAddress:null!=n?n:"",port:s?s+"":"",type:r?r+"":"",relAddr:null!=o?o:"",relPort:a?a+"":"",extension:{}};this.candidates.some((e=>e.priority===d.priority&&e.connectionAddress===d.connectionAddress&&e.port===d.port))||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach((e=>{e.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,i,n,s){const r=e._mediaStreamTrack.kind,o=this.rtpCapabilities.recv,a=GW(r,o,this.localCapabilities.send,r===OG.AUDIO?s:n),c=r===OG.VIDEO?o.videoExtensions:o.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:r,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,e);const h=this.findFirstClosedMedia(r);if(h){const e=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[e]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,i){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const s=n.media.mediaType===e&&"0"!==n.media.port&&("sendonly"===n.attributes.direction||"sendrecv"===n.attributes.direction)&&0===n.attributes.ssrcs.length;if(lO()){if(s){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==n.attributes.mid&&"1"!==n.attributes.mid)||!(!e||e!==n.attributes.mid)}return!1}return s&&n.attributes.mid===i}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const i=t.media.mediaType===e&&"0"!==t.media.port&&("recvonly"===t.attributes.direction||"sendrecv"===t.attributes.direction);return"0"!==t.attributes.mid&&"1"!==t.attributes.mid&&i}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}restartICE(e){e=uN(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,i,n,s,r){const o=this.rtpCapabilities.send,a=e===OG.VIDEO?o.videoCodecs:o.audioCodecs,c=e===OG.VIDEO?o.videoExtensions:o.audioExtensions;lO()&&(s="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:s}};d=this.mungSendMediaDesc(d,r);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,i){const n=uN(e);return OW(n),DW(n,t),NW(n,t),LW(n),PW(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=uN(e);return PW(i,t,this.localCapabilities.recv),VW(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>lO()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}};const WW=["sdp"];var HW;let KW=(HW=class e extends wG{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(t,i,n){super(t,i),this.direction=void 0,this.name=void 0,this.store=void 0,this.spec=void 0,this.peerConnection=void 0,this.initialOffer=void 0,this.transport=void 0,this.statsFilter=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.localCandidateAddress=null,this.useXR=JN("USE_XR"),this.filter={filterRTX:!JN("USE_PUB_RTX")&&!JN("USE_SUB_RTX"),filterVideoFec:JN("FILTER_VIDEO_FEC"),filterAudioFec:JN("FILTER_AUDIO_FEC")},this.extension={useXR:this.useXR},this._isInRestartIce=!1,this.mutex=new PN("P2PConnection-mutex"),this.onLocalCandidate=void 0,this.remoteSDP=void 0,this.pendingCandidates=[],this.localCapabilities=void 0,this.isReady=!1,this.restartCnt=0,this.curTurnServerIndex=0,this.store=i,this.spec=t,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=null!=n?n:QB.SEND_ONLY,this.name=this.direction===QB.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=yW(this.peerConnection,JN("STATS_UPDATE_INTERVAL"),void 0,lO()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{const t=await MW(this.filter,this.extension);if(this.localCapabilities=FW(t),e){const{sdp:t}=e,i=function(e,t){if(null==e)return{};var i,n,s=function(e,t){if(null==e)return{};var i,n,s={},r=Object.keys(e);for(n=0;n<r.length;n++)i=r[n],t.indexOf(i)>=0||(s[i]=e[i]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)i=r[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(s[i]=e[i])}return s}(e,WW),n=function(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=CW(arguments.length>2?arguments[2]:void 0,arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},"sendonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(xW(t,e,"videoExtensions",i,n,s),xW(t,e,"videoCodecs",i,n,s),xW(t,e,"audioExtensions",i,n,s),xW(t,e,"audioCodecs",i,n,s),JN("RAISE_H264_BASELINE_PRIORITY")){const e=s.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"===e.fmtp.parameters["profile-level-id"]));if(-1!==e){const t=s.videoCodecs.findIndex((e=>e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()));if(t<e){EL.debug("raising H264 baseline profile priority");const i=s.videoCodecs[e];s.videoCodecs.splice(e,1),s.videoCodecs.splice(t,0,i)}-1!==t&&JN("FILTER_SEND_H264_BASELINE")&&(i.videoCodecs=i.videoCodecs.filter((e=>!(e.rtpMap&&"h264"===e.rtpMap.encodingName.toLocaleLowerCase()&&e.fmtp&&"42001f"!==e.fmtp.parameters["profile-level-id"]))))}}return{send:i,recv:n,sendrecv:s}}(this.filter,this.extension,t);this.remoteSDP=new jW({remoteIceParameters:i.iceParameters,remoteDtlsParameters:i.dtlsParameters,candidates:[],remoteRTPCapabilities:n,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const r=IW(s.sdp);await this.peerConnection.setLocalDescription(s);const o=await UW(this.filter,this.extension,s.sdp);this.localCapabilities=FW(o);const a=this.peerConnection.getTransceivers()[0];return null!=a&&a.receiver&&a.receiver.transport&&this.tryBindTransportEvents(a.receiver.transport),UB(UB({},r),{},{sdp:s.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=IW(e.sdp);return this.initialOffer=e,UB(UB({},t),{},{sdp:e.sdp})}}catch(e){throw new CO(yO.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:t,iceParameters:i,dtlsParameters:n}=e,s=await UW(this.filter,this.extension,t);this.remoteSDP=new jW({remoteIceParameters:i,remoteDtlsParameters:n,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const r=this.peerConnection.getTransceivers()[0];null!=r&&r.sender&&r.sender.transport&&this.tryBindTransportEvents(r.sender.transport)}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(e){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((e=>{this.peerConnection.addIceCandidate(e)})),this.pendingCandidates=[])}catch(e){throw new CO(yO.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return xB((function*(){const s=yield kB(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const r=[],o=n.remoteSDP.receive(e,t,i);e.forEach(((e,t)=>{if(o[t].needCreateTransceiver){const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});r.push(t),e._updateRtpTransceiver(t)}else{const i=n.peerConnection.getTransceivers().find((e=>e.mid===o[t].mid));if(!i)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(o[t].mid));r.push(i),e._updateRtpTransceiver(i)}})),lO()&&!0===JN("SIMULCAST")&&(yield kB(n.applySimulcastForFirefox(r,e)));const a=o.map((e=>e.mid)),c=yield kB(n.peerConnection.createOffer()),d=n.mungSendOfferSDP(c.sdp,e,a),l=dW.parse(d),h=a.map((e=>{const t=l.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return AW(t,JN("USE_PUB_RTX"))})),u=r.map(((e,t)=>{const i=a[t];return{localSSRC:h[t],id:i}}));yield kB(n.peerConnection.setLocalDescription({type:"offer",sdp:d}));try{yield u}catch(e){const t=n.remoteSDP.toString();throw yield kB(n.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield kB(n.peerConnection.setRemoteDescription({type:"answer",sdp:t})),yield kB(n.stopSending(a,!0)),e}yield kB(n.applySimulcastEncodings(r,e)),yield kB(n.applySendEncodings(r,e));const p=n.remoteSDP.toString(),f=n.logSDPExchange(d,"offer","local","send");return null==f||f(p),yield kB(n.setRemoteDescription({type:"answer",sdp:p})),r.map(((e,t)=>{const i=a[t];return{localSSRC:h[t],id:i}}))}catch(e){throw e instanceof CO?e:new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length (".concat(t.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==s||s(r),await this.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:r}=this.remoteSDP.send(e,t,i,n);if(r){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(n.sdp,s,e);null==i||i(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),EL.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else EL.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const o=this.peerConnection.getTransceivers().find((e=>e.mid===s));if(!o||null===o.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,mid:o.mid,transceiver:o}}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async mockReceive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:r}=this.remoteSDP.send(e,t,i,n);if(r){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(n.sdp,s,e);null==i||i(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),EL.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else EL.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===qN.Auto&&(this.store.p2pTransport=qN.SdRtn,nx().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,nx().supportPCSetConfiguration&&this.peerConnection.setConfiguration(e.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:t}=IW(e.sdp);return this.store.descriptionStart(),this.direction===QB.SEND_ONLY&&await this.peerConnection.setLocalDescription(e),t}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===QB.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const e=await this.peerConnection.createAnswer();if(!e.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:t}=IW(e.sdp);return await this.peerConnection.setLocalDescription(e),t}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==r||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?lO()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:UB(UB({},pW),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:UB(UB({},pW),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;["connected","completed"].includes(this.peerConnection.iceConnectionState)&&(this.isReady=!1),null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;"connected"===this.peerConnection.connectionState&&(this.restartCnt=0),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{var t;e.candidate?(e.candidate.candidate&&(this.localCandidateAddress=e.candidate.address,null===(t=this.onLocalCandidate)||void 0===t||t.call(this,e.candidate.toJSON())),this.localCandidateCount+=1):(this.allCandidatesReceived=!0,EL.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,i){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const s={iceServers:[]};return t.iceServers?s.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&($O(t.turnServer.servers)?s.iceServers=t.turnServer.servers:(s.iceServers&&s.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers,i,n)),JN("USE_TURN_SERVER_OF_GATEWAY")&&s.iceServers&&t.turnServer.serversFromGateway&&s.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway,i,n)),[qN.Relay,qN.SdRtn].includes(i)&&(s.iceTransportPolicy="relay"),JN("FORCE_TURN_TCP")?s.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(s.iceTransportPolicy="relay")})))),JN("ENABLE_ENCODED_TRANSFORM")&&nx().supportWebRTCEncodedTransform&&(s.encodedInsertableStreams=!0),EL.debug("P2PConnection p2pTransport is ".concat(i)),s}static turnServerConfigToIceServers(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const n=[],s=e.filter((e=>e.tcpport));EL.debug("P2PConnection turnServers is ".concat(s,", current index is ").concat(i));const r=s.length>i?s[i]:s[0];switch(t){case qN.SdRtn:const t=e.filter((e=>e.username.includes("glb:")&&e.turnServerURL==e.turnServerURL)),s=t.length>i?t[i]:t[0];s&&(n.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(uj(s.turnServerURL),":").concat(s.tcpport,"?transport=udp")}),n.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(uj(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;case qN.Relay:r&&(n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=udp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(uj(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}));break;default:r&&(n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=udp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(uj(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"stun:".concat(r.turnServerURL,":").concat(r.tcpport)}))}return n}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var t;null!=e&&e.state&&(null===(t=this.onDTLSTransportStateChange)||void 0===t||t.call(this,e.state))},e.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const t=e.iceTransport;t&&(t.onstatechange=()=>{const t=null==e?void 0:e.iceTransport.state;var i;t&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,t))},t.getSelectedCandidatePair&&(t.onselectedcandidatepairchange=()=>{if(t.getSelectedCandidatePair()){const{local:e,remote:i}=t.getSelectedCandidatePair();EL.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var i;if(t||(t=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))),!t)return EL.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return EL.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!nx().supportSetRtpSenderParameters)return EL.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const n={},s={};switch(e._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(e._encoderConfig){const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(s.maxBitrate=1e3*t),e._hints.includes(fx.LOW_STREAM)&&(i&&(s.maxFramerate=fj(i)),n&&n>=1&&(s.scaleResolutionDownBy=n))}if(JN("DSCP_TYPE")&&SO()){const e=JN("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(s.networkPriority=e)}const r=t.getParameters(),o=null===(i=r.encodings)||void 0===i?void 0:i[0];lO()&&!o&&(n.encodings=[s]),o&&Object.assign(o,s),Object.assign(r,n),EL.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(r.encodings))),await t.setParameters(r)}async applySendEncodings(e,t){try{if(!nx().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let i=0;i<e.length;i++){const n=e[i],s=t[i];s instanceof XV&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){EL.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=dW.parse(e);return t.forEach(((e,t)=>{const s=i[t],r=n.mediaDescriptions.find((e=>e.attributes.mid===s));r&&(DW(r,e),kW(r,e,this.store.codec))})),dW.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let o=0;o<e.length;o++){var i,n,s,r;const a=e[o],c=t[o];if(c instanceof XV&&!c._hints.includes(fx.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(r=c._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=a.sender.getParameters();await a.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!lO()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof XV&&this.isVP8Simulcast(n)){const t=e[i],s={},r={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:r.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:r.medium,scaleResolutionDownBy:4}];const o=t.sender.getParameters();await t.sender.setParameters(Object.assign(o,s))}}}isVP8Simulcast(e){var t,i,n,s;return!!(e instanceof XV&&JN("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(fx.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabilityMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,t,i,n){if(JN("SDP_LOGGING"))return EL.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(t," SDP during P2PConnection.").concat(n,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",n)}:void 0}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async e=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}async getRemoteSSRC(e,t){var i,n;if(t=null!==(i=t)&&void 0!==i?i:null===(n=this.currentRemoteDescription)||void 0===n?void 0:n.sdp){var s;const i=null===(s=dW.parse(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===s?void 0:s.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}async setRemoteDescription(e){await this.peerConnection.setRemoteDescription(e),["connected","completed"].includes(this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(e,t,i){const n=dW.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&(i===OG.AUDIO&&"audio"===s.media.mediaType&&VW(s),this.useXR&&BW(n)),dW.print(n)}},VB(HW.prototype,"establish",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"establish"),HW.prototype),VB(HW.prototype,"connect",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"connect"),HW.prototype),VB(HW.prototype,"receive",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"receive"),HW.prototype),VB(HW.prototype,"mockReceive",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"mockReceive"),HW.prototype),VB(HW.prototype,"stopReceiving",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"stopReceiving"),HW.prototype),VB(HW.prototype,"restartICE",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"restartICE"),HW.prototype),VB(HW.prototype,"close",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"close"),HW.prototype),VB(HW.prototype,"updateEncoderConfig",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"updateEncoderConfig"),HW.prototype),VB(HW.prototype,"updateSendParameters",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"updateSendParameters"),HW.prototype),VB(HW.prototype,"replaceTrack",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"replaceTrack"),HW.prototype),VB(HW.prototype,"muteLocal",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"muteLocal"),HW.prototype),VB(HW.prototype,"unmuteLocal",[YW],Object.getOwnPropertyDescriptor(HW.prototype,"unmuteLocal"),HW.prototype),HW);function YW(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,r=new Array(s),o=0;o<s;o++)r[o]=arguments[o];return await n.apply(this,r)}finally{i()}},i}function qW(e,t){let i=document.createElement("video"),n=document.createElement("canvas");i.setAttribute("style","display:none"),n.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),n.width=fj(t.width),n.height=fj(t.height);const s=fj(t.framerate||15);document.body.append(i),document.body.append(n);let r=e._mediaStreamTrack;i.srcObject=new MediaStream([r]),i.play();const o=n.getContext("2d");if(!o)throw new eG(yO.UNEXPECTED_ERROR,"can not get canvas context");const a=nx(),c=n.captureStream(a.supportRequestFrame?0:s).getVideoTracks()[0];c.canvas||(c.canvas=n),n.startCapture=()=>{if(!i)return n.stopCapture&&n.stopCapture();if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){const e=i.videoWidth,t=i.videoHeight/e,s=n.width*t;Math.abs(s-n.height)>=2&&(EL.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(s)),n.height=s)}o.drawImage(i,0,0,n.width,n.height),c.requestFrame&&c.requestFrame(),r!==e._mediaStreamTrack&&(r=e._mediaStreamTrack,i.srcObject=new MediaStream([r]))},n.stopCapture=Kx((()=>n.startCapture&&n.startCapture()),s);const d=c.stop;return c.stop=()=>{d.call(c),i&&(i.remove(),i.srcObject=null,i=null),n&&(n.width=0,n.remove(),n.stopCapture&&n.stopCapture(),n.startCapture=void 0,n.stopCapture=void 0,n=null),EL.debug("clean low stream renderer")},c}var $W=function(e){return e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH",e}($W||{}),zW=function(e){return e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM",e}(zW||{}),XW=function(e){return e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH",e}(XW||{}),JW=function(e){return e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY",e}(JW||{}),QW=function(e){return e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",e}(QW||{}),ZW=function(e){return e[e.PCM_LEVEL=2104]="PCM_LEVEL",e}(ZW||{}),eH=function(e){return e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED",e}(eH||{}),tH=function(e){return e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",e}(tH||{}),iH=function(e){return e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL",e}(iH||{}),nH=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e}(nH||{});const sH=1e3;function rH(e,t,i){null!=i&&Number.isFinite(i)&&(e[t]=Math.round(Math.max(0,i)))}function oH(e){const t={[nH.CONN_TYPE]:0,[nH.RTT]:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(t[nH.CONN_TYPE]=1),"tcp"===i&&(t[nH.CONN_TYPE]=3),"tls"===i&&(t[nH.CONN_TYPE]=4);break}case"srflx":t[nH.CONN_TYPE]=2}return t}class aH extends GO{constructor(e){super(),this.store=void 0,this.uploadWRTCStatsTimer=void 0,this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer=void 0,this.uploadExtUsageStatsTimer=void 0,this.uploadInboundExtStatsTimer=void 0,this.requestStats=void 0,this.requestTransportStats=void 0,this.requestLocalMedia=void 0,this.requestRemoteMedia=void 0,this.requestAllTracks=void 0,this.requestVideoIsReady=void 0,this.requestUploadStats=void 0,this.requestUpload=void 0,this.uploadOutboundStarted=!1,this.uploadInboundStarted=!1,this.uploadTransportStarted=!1,this.uploadExtensionUsageStarted=!1,this.lastRecvStats=void 0,this.lastSendStats=void 0,this.lastFullRecvStats=void 0,this.lastFullSendStats=void 0,this.needUploadRenderFreezeTime=!0,this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let t,i;if(this.uploadTransportStarted&&(t=this.requestStats(),this.store.useP2P&&(i=this.requestStats(!0))),!t&&this.uploadOutboundStarted&&(t=this.requestStats()),!i&&this.uploadInboundStarted&&(i=this.requestStats(!0)),t||i){const n={};if(this.uploadTransportStarted&&t){const s=this.getTransportStats(t,i,e);s&&(n.misc=[s])}if(this.uploadOutboundStarted&&t){const i=this.getOutboundStats(t,e?this.lastSendStats:this.lastFullSendStats,e);i&&(n.outbound=[i])}if(this.uploadInboundStarted&&i){const t=this.getInboundStats(i,e?this.lastRecvStats:this.lastFullRecvStats,e);t&&(n.inbound=t)}this.requestUploadStats(n)}this.lastRecvStats=i,this.lastSendStats=t,e||(this.lastFullRecvStats=i,this.lastFullSendStats=t)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let e=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(3!==e),4==++e&&(e=1)}),sH)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(e,t,i){if(!this.requestStats)return;if(i)return null==e.rtt?void 0:{addition:{[nH.RTT]:e.rtt,[nH.CONN_TYPE]:void 0}};const n=oH(e);if(this.store.useP2P){if(t){const e=oH(t);n[nH.CONN_TYPE]+=e[nH.CONN_TYPE]<<3}n[nH.CONN_TYPE]+=110}else n[nH.CONN_TYPE]+=100;return{addition:n}}getOutboundStats(e,t,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const n=this.requestLocalMedia();if(!n||0===n.length)return;let s,r,o;return n.forEach((n=>{let[a,{track:c,ssrcs:d}]=n;switch(a){case PG.LocalVideoLowTrack:case PG.LocalVideoTrack:if(a===PG.LocalVideoTrack){const n=function(e,t,i,n,s){const r=t.videoSend.find((t=>t.ssrc===e));if(!r)return;const o={},{sentFrame:a,inputFrame:c}=r;if(c&&a){const e=c.frameRate,t=a.frameRate;o[zW.FREEZE]=function(e,t){let i=!0;return i=!(e<=5)&&(e<=10?t<3:e<=20?t<4:t<5),i}(e,t)?1:0}if(rH(o,zW.QP_SUM,r.qpSumPerFrame),s)return o;switch(a&&(rH(o,zW.HEIGHT,a.height),rH(o,zW.WIDTH,a.width),rH(o,zW.FRAME_RATE,a.frameRate)),o[zW.DISABLED]=n._originMediaStreamTrack&&!n._originMediaStreamTrack.enabled||n._mediaStreamTrack&&!n._mediaStreamTrack.enabled?1:0,r.adaptionChangeReason){case"none":o[zW.ADAPTATION]=0;break;case"cpu":o[zW.ADAPTATION]=1;break;case"bandwidth":o[zW.ADAPTATION]=2;break;case"other":o[zW.ADAPTATION]=3}o[zW.PLAYER_STATUS]=Nx[n._player?n._player.videoElementStatus:"uninit"],rH(o,zW.NACKS,r.nacksCount),rH(o,zW.PLIS,r.plisCount),rH(o,zW.FIRS,r.firsCount),rH(o,zW.AVG_ENCODE,r.avgEncodeMs);const d=i&&i.videoSend.find((t=>t.ssrc===e));if(d){let e=s?sH:3e3;d.timestamp&&r.timestamp&&(e=r.timestamp-d.timestamp),null!=d.packets&&null!=r.packets&&rH(o,zW.PACKAGE_RATE,1e3*(r.packets-d.packets)/e),null!=r.packetsLost&&null!=d.packetsLost&&rH(o,zW.PACKAGE_LOST,r.packetsLost-d.packetsLost),null!=d.bytes&&null!=r.bytes&&rH(o,zW.BITRATE,8*(r.bytes-d.bytes)/e)}return o}(d[0].ssrcId,e,t,c,i),s=i?null:function(e,t,i){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return null;const s={},r=n.inputFrame,o=r&&r.height||i&&i._videoHeight||0,a=r&&r.width||i&&i._videoWidth||0,c=r&&r.frameRate||0;return rH(s,$W.HEIGHT,o),rH(s,$W.WIDTH,a),rH(s,$W.FRAME_RATE,c),s}(d[0].ssrcId,e,c),o=i?null:function(e){const t={};return rH(t,zW.RETRANSMIT,e.bitrate.retransmit),rH(t,zW.TARGET_ENCODED,e.bitrate.targetEncoded),rH(t,zW.ACTUAL_ENCODED,e.bitrate.actualEncoded),rH(t,zW.TRANSMIT,e.bitrate.transmit),rH(t,zW.BANDWIDTH,e.sendBandwidth),t}(e);r=Object.assign({},n,s,o)}else o=i?void 0:function(e,t,i){const n=t.videoSend.find((t=>t.ssrc===e));if(!n)return;const s={},r=n.sentFrame;if(r&&(rH(s,XW.HEIGHT,r.height),rH(s,XW.WIDTH,r.width),rH(s,XW.FRAME_RATE,r.frameRate)),i){const t=i.videoSend.find((t=>t.ssrc===e));if(t){let e=3e3;t.timestamp&&n.timestamp&&(e=n.timestamp-t.timestamp),null!=t.packets&&null!=n.packets&&rH(s,XW.PACKAGE_RATE,1e3*(n.packets-t.packets)/e),null!=n.packetsLost&&null!=t.packetsLost&&rH(s,XW.PACKAGE_LOST,n.packetsLost-t.packetsLost),null!=t.bytes&&null!=n.bytes&&rH(s,XW.BITRATE,8*(n.bytes-t.bytes)/e)}}return s}(d[0].ssrcId,e,t);break;case PG.LocalAudioTrack:s=i?void 0:function(e,t,i,n){const s=t.audioSend.find((t=>t.ssrc===e));if(!s)return;const r={};r[eH.DISABLED]=n._originMediaStreamTrack&&!n._originMediaStreamTrack.enabled||n._mediaStreamTrack&&!n._mediaStreamTrack.enabled?1:0;const o=n._source.getAccurateVolumeLevel(),a=s.inputLevel;rH(r,eH.LEVEL,100*(null==a?o:a)),rH(r,ZW.PCM_LEVEL,100*o),rH(r,eH.AEC_RETURN_LOSS,s.aecReturnLoss),rH(r,eH.AEC_RETURN_LOSS_ENH,s.aecReturnLossEnhancement),r[eH.FREEZE]=0;const c=i&&i.audioSend.find((t=>t.ssrc===e));if(c){let e=3e3;c.timestamp&&s.timestamp&&(e=s.timestamp-c.timestamp),null!=c.bytes&&null!=s.bytes&&rH(r,eH.BITRATE,8*(s.bytes-c.bytes)/e),null!=c.packets&&null!=s.packets&&rH(r,eH.PACKAGE_RATE,1e3*(s.packets-c.packets)/e)}return r}(d[0].ssrcId,e,t,c)}})),{high:r,low:o,audio:s}}getInboundStats(e,t,i){if(!this.requestRemoteMedia)return;const n=this.requestRemoteMedia()||[],s=[];return n.forEach((n=>{let[r,o]=n;const a={peer:r.uid};if(o.has(OG.VIDEO)&&r.videoTrack){const n=r._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(r._videoSSRC)||!1,s=r.videoTrack?function(e,t,i,n,s,r,o){const a=t.videoRecv.find((t=>t.ssrc===e));if(!a)return;const c={},{receivedFrame:d,outputFrame:l,decodeFrameRate:h}=a,u=i&&i.videoRecv.find((t=>t.ssrc===e));if(c[JW.FREEZE]=s&&bH.isRemoteVideoFreeze(n,a,u)?1:0,rH(c,QW.FRAME_RATE_DECODE,h),rH(c,JW.QP_SUM,a.qpSumPerFrame),a.framesRateFirefox&&rH(c,JW.FRAME_RATE,a.framesRateFirefox),d&&rH(c,JW.FRAME_RATE,d.frameRate),u){const e=t.timestamp-i.timestamp||(o?sH:3e3);null!=a.packetsLost&&null!=u.packetsLost&&rH(c,JW.PACKAGE_LOST,a.packetsLost-u.packetsLost),null!=u.bytes&&null!=a.bytes&&rH(c,JW.BITRATE,8*(a.bytes-u.bytes)/e),null!=u.packets&&null!=a.packets&&rH(c,JW.PACKAGE_RATE,1e3*(a.packets-u.packets)/e)}if(o)return c;if(d?(rH(c,JW.HEIGHT,d.height),rH(c,JW.WIDTH,d.width)):n&&(rH(c,JW.HEIGHT,n._videoHeight||0),rH(c,JW.WIDTH,n._videoWidth||0)),l&&rH(c,QW.FRAME_RATE_RENDER,l.frameRate),rH(c,JW.JITTER_BUFFER,a.jitterBufferMs),rH(c,JW.CURRENT_DELAY,a.currentDelayMs),rH(c,JW.FIRS,a.firsCount),rH(c,JW.NACKS,a.nacksCount),rH(c,JW.PLIS,a.plisCount),n){c[JW.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1;const e=n._player;if(e){const{freezeTimeCounterList:t,renderFreezeAccTime:i}=e;if(t&&t.length>0&&rH(c,QW.FREEZE_TIME,t.splice(0,1)[0]),r&&"visible"===uB.visibility){const t=Math.min(6e3,i);e.renderFreezeAccTime=Math.max(0,i-t),rH(c,QW.FREEZE_TIME_RENDER,t)}}}if(c[JW.PLAYER_STATUS]=Nx[n._player?n._player.videoElementStatus:"uninit"],u&&void 0!==a.totalInterFrameDelay&&void 0!==a.totalSquaredInterFrameDelay&&void 0!==u.totalInterFrameDelay&&void 0!==u.totalSquaredInterFrameDelay){const e=a.totalInterFrameDelay-u.totalInterFrameDelay,t=a.totalSquaredInterFrameDelay-u.totalSquaredInterFrameDelay,i=a.framesDecodeCount-u.framesDecodeCount,n=e/i*1e3,s=Math.round(1e3*Math.sqrt((t-Math.pow(e,2)/i)/i));!isNaN(s)&&n+s>Math.max(3*n,n+150)&&(c[JW.I_FRAME_DELAY]=s)}return c}(r._videoSSRC,e,t,r.videoTrack,!0===n,this.needUploadRenderFreezeTime,i):void 0;s&&(a.video=s)}if(o.has(OG.AUDIO)&&r.audioTrack){const n=r.audioTrack?function(e,t,i,n,s){const r=t.audioRecv.find((t=>t.ssrc===e));if(!r)return;const o={},a=i&&i.audioRecv.find((t=>t.ssrc===e)),{receivedFrames:c,droppedFrames:d}=r;var l;if(rH(o,tH.JITTER,r.jitterMs),null!=c&&null!=d&&(o[tH.FREEZE]=0===(l=c)||100*d/l>20?1:0),a){const e=t.timestamp-i.timestamp||(s?sH:3e3);null!=r.packets&&null!=a.packets&&rH(o,tH.PACKAGE_RATE,1e3*(r.packets-a.packets)/e),null!=a.bytes&&null!=r.bytes&&rH(o,tH.BITRATE,8*(r.bytes-a.bytes)/e),null!=r.packetsLost&&null!=a.packetsLost&&rH(o,tH.PACKAGE_LOST,r.packetsLost-a.packetsLost)}if(s)return o;const h=n._source.getAccurateVolumeLevel(),u=r.outputLevel;if(rH(o,iH.LEVEL,100*(null==u?h:u)),rH(o,tH.PCM_LEVEL,100*h),n&&(o[tH.DISABLED]=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?0:1),rH(o,tH.JITTER_BUFFER,r.jitterBufferMs),rH(o,tH.CURRENT_DELAY,r.jitterBufferMs),o[tH.PLAYER_STATUS]=Nx[lF.getPlayerState(n.getTrackId())],a){const e=r.concealedSamples-a.concealedSamples;e>0&&rH(o,tH.CONCEALED_SAMPLES,e)}return o}(r._audioSSRC,e,t,r.audioTrack,i):void 0;n&&(a.audio=n)}(a.video||a.audio)&&s.push(a)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const e=(this.requestAllTracks()||[]).find((e=>e instanceof rV));if(e&&e._external.getDenoiserStats){const t=e._external.getDenoiserStats();t&&this.requestUpload(XB.DENOISER_STATS,t)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{this.requestAllTracks&&this.requestUpload&&this.requestAllTracks().forEach((e=>{e.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{this.requestUpload&&this.requestRemoteMedia&&(this.requestRemoteMedia()||[]).forEach((e=>{let[t,i]=e;i.has(OG.VIDEO)&&t.videoTrack&&t.videoTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)})),i.has(OG.AUDIO)&&t.audioTrack&&t.audioTrack.getProcessorStats().forEach((e=>{this.requestUpload&&this.requestUpload(e.type,e.stats)}))}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const e=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const t=Date.now(),i={connectionInterval:JN("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:t};let n=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const e of s)!e.muted&&e.enabled&&(n=n.concat(await e.getProcessorUsage()));const r=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[e,t]of r)t.has(OG.VIDEO)&&e.videoTrack&&(n=n.concat(await e.videoTrack.getProcessorUsage())),t.has(OG.AUDIO)&&e.audioTrack&&(n=n.concat(await e.audioTrack.getProcessorUsage()));if(0===n.length)return;i.details=function(e,t){const i={};for(const{id:o,value:a,level:c,direction:d}of e){var n;const e=null!==(n=t.get(o))&&void 0!==n?n:0,l=2===a?e+JN("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var s,r;t.set(o,l),i[o]?(2===a&&(i[o].value=a),c>i[o].level&&(i[o].level=c),"remote"===d&&(i[o].remoteUidCount+=1),i[o].totalTs=null!==(s=t.get(o))&&void 0!==s?s:0):i[o]={value:a,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(r=t.get(o))&&void 0!==r?r:0}}return Object.keys(i).map((e=>{const{level:t,value:n,totalTs:s}=i[e];return{id:e,level:t,value:n,totalTs:s}}))}(n,e);const o=Date.now(),a=o>t?o:t+1;this.requestUpload&&this.requestUpload(XB.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:a})}),JN("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class cH{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){this.uid=void 0,this._uintid=void 0,this._trust_in_room_=!0,this._trust_audio_enabled_state_=!0,this._trust_video_enabled_state_=!0,this._trust_audio_mute_state_=!0,this._trust_video_mute_state_=!0,this._audio_muted_=!1,this._video_muted_=!1,this._audio_enabled_=!0,this._video_enabled_=!0,this._audio_added_=!1,this._video_added_=!1,this._is_pre_created=!1,this._video_pre_subscribed=!1,this._audio_pre_subscribed=!1,this._trust_video_stream_added_state_=!0,this._trust_audio_stream_added_state_=!0,this._audioTrack=void 0,this._videoTrack=void 0,this._dataChannels=[],this._audioSSRC=void 0,this._videoSSRC=void 0,this._audioOrtc=void 0,this._videoOrtc=void 0,this._cname=void 0,this._rtxSsrcId=void 0,this._videoMid=void 0,this._audioMid=void 0,this.uid=e,this._uintid=t}}let dH=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});function lH(e,t){let i;switch(t){case PG.LocalAudioTrack:i=gG.Audio;break;case PG.LocalVideoTrack:i=e._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High;break;case PG.LocalVideoLowTrack:i=gG.Low}return i}function hH(e){const t=nx();if(e.some((e=>e._bypassWebAudio)))throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function uH(e,t){hH(e);const i=t||new oV;return e.forEach((e=>i.addAudioTrack(e))),i}var pH,fH,mH,EH,_H,gH,TH,SH,vH,RH,yH,CH;let IH=(pH=AH(dH.SEND_ONLY),fH=AH(dH.SEND_ONLY),mH=AH(),EH=AH(dH.RECEIVE_ONLY),_H=AH(dH.RECEIVE_ONLY),gH=AH(dH.RECEIVE_ONLY),TH=AH(dH.RECEIVE_ONLY),SH=AH(dH.RECEIVE_ONLY),vH=AH(dH.RECEIVE_ONLY),RH=AH(),yH=AH(dH.RECEIVE_ONLY),VB((CH=class extends GO{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(MG.StateChange,t,this._state)}constructor(e,t){super(),this.store=void 0,this.statsUploader=void 0,this.sendConnection=void 0,this.recvConnection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.statsCollector=void 0,this.dtlsFailedCount=0,this.sendMutex=new PN("P2PChannel2-send-mutex"),this.recvMutex=new PN("P2PChannel2-recv-mutex"),this._state=kG.Disconnected,this._restartStates=["disconnected","failed"],this.reconnectInterval=void 0,this.uploadUnplinkStarted=!1,this.uploadDownlinkStarted=!1,this.uplinkStateUploadInterval=void 0,this.downlinkStatsUploadInterval=void 0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==kG.Connected)return void i(new CO(yO.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const o=this.filterTobeMutedTracks(e);if(0===o.length)return void t();const a=o.find((e=>"videoLowTrack"===e[0]));a&&a[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(o.map((e=>{let[,{id:t}]=e;return t})));let c=!1;var s,r;c="video"===e.trackMediaType?!(null===(s=this.localTrackMap.get(PG.LocalAudioTrack))||void 0===s||!s.track._muted):void 0===(null===(r=this.localTrackMap.get(PG.LocalVideoTrack))||void 0===r?void 0:r.id);const d=this.createMuteMessage(o);await iN(this,MG.RequestMuteLocal,d);const l="video"===e.trackMediaType?qG.MUTE_LOCAL_VIDEO:qG.MUTE_LOCAL_AUDIO;await iN(this,MG.RequestP2PMuteLocal,{action:l,message:d,isMuteAll:c}),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==kG.Connected)return void i(new CO(yO.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const s=this.filterTobeUnmutedTracks(e);if(0===s.length)return void t();await this.sendConnection.unmuteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const r=this.createUnmuteMessage(s),o="video"===e.trackMediaType?qG.UNMUTE_LOCAL_VIDEO:qG.UNMUTE_LOCAL_AUDIO;await iN(this,MG.RequestP2PMuteLocal,{action:o,message:r}),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const i=this.localTrackMap.get(PG.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==kG.Connected)return void t();const{id:s,track:r}=i;s&&(await this.sendConnection.updateSendParameters(s,r),await this.sendConnection.updateEncoderConfig(s,r),this.emit(MG.UpdateVideoEncoder,r)),t()}catch(e){i(e)}finally{n()}},this.handleSetOptimizationMode=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const i=this.localTrackMap.get(PG.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==kG.Connected)return;const{id:s,track:r}=i;s&&await this.sendConnection.updateSendParameters(s,r),t()}catch(e){i(e)}finally{n()}},this.handleReplaceTrack=async(e,t,i,n)=>{let s;EL.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof n&&n||(s=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var r;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.sendConnection||!i||void 0===i[1].id||this.state!==kG.Connected)return void t();if(await(null===(r=this.sendConnection)||void 0===r?void 0:r.replaceTrack(e,i[1].id)),i[0]===PG.LocalVideoTrack&&nx().supportDualStreamEncoding){const t=this.localTrackMap.get(PG.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}t()}catch(e){i(e)}finally{var o;null===(o=s)||void 0===o||o()}},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new aH(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((e=>{e&&("disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))}))}),JN("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new CO(yO.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,i,n,s,r){throw new CO(yO.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let i;try{if(t){this.recvConnection&&(EL.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),i=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new KW(e,this.store,QB.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const n=await this.recvConnection.establish(t);return{iceParameters:n.iceParameters,dtlsParameters:n.dtlsParameters,sdp:n.sdp}}{this.state=kG.New,this.sendConnection&&(EL.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),i=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new KW(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const t=await this.sendConnection.establish();return{iceParameters:t.iceParameters,dtlsParameters:t.dtlsParameters,sdp:t.sdp}}}finally{i&&i()}}async p2pConnect(e){if(!this.sendConnection)throw new CO(yO.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kG.Connected}async addRemoteCandidate(e,t){if(t===QB.RECEIVE_ONLY){if(!this.sendConnection)throw new CO(yO.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new CO(yO.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,i){var n=this;return xB((function*(){const s=yield kB(n.sendMutex.lock("From P2PChannel.publish"));try{if(!n.sendConnection||n.state!==kG.Connected){n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,cW.markPublishStart(n.store.clientId,n.store.pubId);const r=n.filterTobePublishedTracks(e,t,i);if(0===r.length)return void(yield kB(n.tryToUnmuteAudio(e)));r.forEach((e=>{let{track:t,type:i}=e;const s=Date.now();n.store.publish(t.getTrackId(),i===PG.LocalAudioTrack?"audio":"video",s)})),n.bindLocalTrackEvents(r);const o=yield kB(n.sendConnection.send(r.map((e=>{let{track:t}=e;return t})),n.store.codec,n.store.audioCodec)),a=(yield kB(o.next())).value,c=n.createGatewayPublishMessage(r,a);try{yield c}catch(e){throw o.throw(e),(null==e?void 0:e.code)===yO.WS_ABORT&&r.forEach((e=>{let{track:t}=e;-1===n.pendingLocalTracks.indexOf(t)&&n.pendingLocalTracks.push(t)})),n.unbindLocalTrackEvents(r),e}yield kB(o.next()),r.forEach((e=>{let{type:t}=e;n.statsCollector.addLocalStats(t)})),n.statsUploader.startUploadOutboundStats(),n.assignLocalTracks(r,a),r.forEach((e=>{let{track:t,type:i}=e;const s=Date.now();n.store.publish(t.getTrackId(),i===PG.LocalAudioTrack?"audio":"video",void 0,s)})),n.startUploadUplinkState()}finally{s()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==kG.Connected)return void(0===e.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((t=>!e.includes(t))));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));i&&i[1].track.close();const n=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===kG.Connected)return i&&i[1].track.close(),n;e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const e=[],t=[];Array.from(this.localTrackMap.entries()).forEach((i=>{let[n,{track:s,ssrcs:r}]=i;const o={stream_type:lH(s,n),ssrcs:r};s._muted||!s._enabled?e.push(o):t.push(o)})),e.length>0&&e.forEach((e=>{iN(this,MG.RequestMuteLocal,[e])})),t.length>0&&t.forEach((e=>{iN(this,MG.RequestUnmuteLocal,[e])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return xB((function*(){throw new CO(yO.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(EL.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await tN(this,MG.RequestRePublish,this.pendingLocalTracks),this.emit(MG.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new CO(yO.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,i,n){var s;if(!this.recvConnection)throw new CO(yO.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(s=this.remoteUserMap.get(e))&&void 0!==s&&s.has(t))return;const{track:r,mid:o,transceiver:a}=await this.recvConnection.receive(t,[{ssrcId:i}],String(e.uid),n);t===OG.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(r):(e._audioTrack=new hB(r,e.uid,e._uintid,this.store),EL.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),a&&e._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=i,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(r):(e._videoTrack=new lB(r,e.uid,e._uintid,this.store),EL.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),a&&e._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._videoTrack));const c=this.remoteUserMap.get(e);c?c.set(t,o):this.remoteUserMap.set(e,new Map([[t,o]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex((i=>{let{user:n,kind:s}=i;return n.uid===e.uid&&t===s}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(MG.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,i,n){if(!this.recvConnection)throw new CO(yO.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:i}],String(e.uid),n)}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.recvConnection||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===OG.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===OG.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const s=this.filterTobeUnSubscribedTracks(e,t);0!==s.length&&(await this.recvConnection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),s.forEach((e=>{let[t,{kind:n}]=e;var s,r;if(n===OG.VIDEO&&t._videoSSRC&&(null===(s=this.recvConnection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),n===OG.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(r=t._videoTrack)||void 0===r||r._destroy(),t._videoTrack=void 0);else if(n===OG.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),i||(null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0)}})),s.forEach((e=>{let[,{kind:t}]=e;iN(this,MG.RequestP2PMuteRemote,t)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((e=>{let[,t]=e;[OG.VIDEO,OG.AUDIO].forEach((e=>{t.has(e)?iN(this,MG.RequestP2PUnmuteRemote,e):iN(this,MG.RequestP2PMuteRemote,e)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new CO(yO.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new CO(yO.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new CO(yO.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new CO(yO.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const i=this.remoteUserMap.get(e);if(!i)return void EL.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!i.get(t))return void EL.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const n=t===OG.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==n&&this.recvConnection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const i=this.remoteUserMap.get(e);i?i.get(t)||EL.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,".")):EL.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."))}getAllTracks(e){const t=this.localTrackMap.get(PG.LocalAudioTrack);if((null==t?void 0:t.track)instanceof oV){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==PG.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===PG.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===PG.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(e,t,i,n,s){if(e){const i=this.localTrackMap.get(PG.LocalAudioTrack),r=n?this.localTrackMap.get(PG.LocalVideoLowTrack):this.localTrackMap.get(PG.LocalVideoTrack);CL.publish(this.store.sessionId,{eventElapse:cW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==i?void 0:i.track.getTrackLabel(),videoName:null==r?void 0:r.track.getTrackLabel(),screenshare:-1!==(null==r?void 0:r.track._hints.indexOf(fx.SCREEN_TRACK)),audio:!!i,video:!!r,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}else{var r;i||(i=[]);const o=i.find((e=>e instanceof sV)),a=n?null===(r=this.localTrackMap.get(PG.LocalVideoTrack))||void 0===r?void 0:r.track:i.find((e=>e instanceof XV));CL.publish(this.store.sessionId,{eventElapse:cW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==o?void 0:o.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(fx.SCREEN_TRACK)),audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}}reportSubscribeEvent(e,t,i,n){const s=n===OG.VIDEO?i._videoSSRC:i._audioSSRC;s&&CL.subscribe(this.store.sessionId,{succ:e,ec:t,video:n===OG.VIDEO,audio:n===OG.AUDIO,peerid:i.uid,subscribeRequestid:n===OG.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:cW.measureFromSubscribeStart(this.store.clientId,s)})}reset(){EL.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new PN("P2PChannel2-send-mutex"),this.sendMutex=new PN("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(PG.LocalAudioTrack);if((null==e?void 0:e.track)instanceof oV){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=kG.Disconnected}getStats(e){var t,i;return e?null===(i=this.recvConnection)||void 0===i?void 0:i.getStats():null===(t=this.sendConnection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.recvConnection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(PG.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(PG.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof XV||t&&t.track instanceof sV?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find((t=>t.uid===e));return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(PG.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort(((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(EL.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=kG.Reconnecting,JN("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;switch(t){case PG.LocalVideoTrack:i._hints.includes(fx.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case PG.LocalAudioTrack:i instanceof oV?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case PG.LocalVideoLowTrack:}})),this.emit(MG.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(MG.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),EL.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof cH?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let i,n;if(e===QB.SEND_ONLY){if(!this.sendConnection)throw new CO(yO.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection}else{if(!this.recvConnection)throw new CO(yO.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection}try{if(t){const e=await n.restartICE(t);return n.isInRestartIce=!1,e}{const e=await n.restartICE();if(e){const t=await tN(this,MG.RequestP2PRestartICE,{direction:QB.RECEIVE_ONLY,iceParameter:e});await n.restartICE(t),n.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(PG.LocalVideoTrack),i=this.localTrackMap.get(PG.LocalAudioTrack),n=e.videoSend.find((e=>{var i;return e.ssrc===(null==t||null===(i=t.ssrcs)||void 0===i?void 0:i[0].ssrcId)})),s=e.audioSend.find((e=>{var t;return e.ssrc===(null==i||null===(t=i.ssrcs)||void 0===t?void 0:t[0].ssrcId)}));if(!n||!s)return 1;const r=nN(this,MG.NeedSignalRTT),o=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&r?(c+r)/2:c||r)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(fx.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return AB[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,r=n._videoSSRC,o=e.audioRecv.find((e=>e.ssrc===s)),a=e.videoRecv.find((e=>e.ssrc===r));if(!o&&!a)return void(t+=1);const c=nN(this,MG.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=o?o.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],s=nx(),r=this.getAllTracks();e=lN(e=e.filter((e=>-1===r.indexOf(e))));let o=!1,a=!1;for(const r of e){if(r instanceof XV&&(this.localTrackMap.has(PG.LocalVideoTrack)||o?new CO(yO.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:r,type:PG.LocalVideoTrack}),o=!0),t)){const e=this.getLowVideoTrack(r,i);n.push({track:e,type:PG.LocalVideoLowTrack})}if(r instanceof sV){const e=this.localTrackMap.get(PG.LocalAudioTrack);if(e){if(!(e.track instanceof oV))throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(r._bypassWebAudio)throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(r),this.bindLocalAudioTrackEvents(r,!0)}else if(a){const e=n.find((e=>{let{type:t}=e;return t===PG.LocalAudioTrack}));if(!(e.track instanceof oV))throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(r._bypassWebAudio)throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(r)}else{if(!s.webAudioMediaStreamDest||r instanceof oV||r._bypassWebAudio)n.push({track:r,type:PG.LocalAudioTrack});else{const e=new oV;e.addAudioTrack(r),n.push({track:e,type:PG.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=lN(e=e.filter((e=>-1!==i.indexOf(e))));for(const i of e){if(i instanceof sV){const e=this.localTrackMap.get(PG.LocalAudioTrack);if(!e)continue;e.track instanceof oV?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([PG.LocalAudioTrack,e]),e.track.close())):t.push([PG.LocalAudioTrack,e])}if(i instanceof XV){const e=this.localTrackMap.get(PG.LocalVideoTrack);if(!e)continue;t.push([PG.LocalVideoTrack,e]);const i=this.localTrackMap.get(PG.LocalVideoLowTrack);i&&t.push([PG.LocalVideoLowTrack,i])}}return t}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case PG.LocalVideoTrack:t.addListener(px.GET_STATS,this.handleGetLocalVideoStats),t.addListener(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(px.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(px.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(px.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case PG.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case PG.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof oV?e.trackList.forEach((e=>{e.addListener(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(px.GET_STATS,this.handleGetLocalAudioStats),e.addListener(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(px.GET_STATS,this.handleGetLocalAudioStats),e.addListener(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(px.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case PG.LocalVideoTrack:t.off(px.GET_STATS,this.handleGetLocalVideoStats),t.off(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(px.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(px.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(px.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case PG.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case PG.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof oV?e.trackList.forEach((e=>{e.off(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(px.GET_STATS,this.handleGetLocalAudioStats),e.off(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(px.GET_STATS,this.handleGetLocalAudioStats),e.off(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(px.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof lB&&t.addListener(px.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof hB&&t.addListener(px.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(px.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(OG.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(OG.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{let n,{track:s,type:r}=e;switch(r){case PG.LocalAudioTrack:n=gG.Audio;break;case PG.LocalVideoTrack:n=s._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High;break;case PG.LocalVideoLowTrack:n=gG.Low}return{kind:r===PG.LocalAudioTrack?OG.AUDIO:OG.VIDEO,stream_type:n,mid:t[i].id,ssrcs:t[i].localSSRC,isMuted:s.muted||!s.enabled}}))}createGatewayUnpublishMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:r}]=e;switch(i){case PG.LocalVideoTrack:t=n._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High;break;case PG.LocalAudioTrack:t=gG.Audio;break;case PG.LocalVideoLowTrack:t=gG.Low}return{stream_type:t,ssrcs:s,mid:r}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(MG.PeerConnectionStateChange,t),"connected"!==t||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===t&&(e.isInRestartIce=!1),this._restartStates.includes(t)&&!e.isInRestartIce&&("disconnected"===t&&await RN(800),"disconnected"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),CL.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:KO.TRACER}).onSuccess(),this.emit(MG.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));var i;t&&(this.store.subscribe(t.uid,"audio",void 0,void 0,void 0,Date.now()),null===(i=t.audioTrack)||void 0===i||i.emit(gx.FIRST_FRAME_DECODED),CL.firstRemoteFrame(this.store.sessionId,SL.FIRST_AUDIO_DECODE,vL.FIRST_AUDIO_DECODE,{peer:t._uintid,subscribeElapse:cW.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));t&&CL.firstRemoteFrame(this.store.sessionId,SL.FIRST_AUDIO_RECEIVED,vL.FIRST_AUDIO_RECEIVED,{peer:t._uintid,subscribeElapse:cW.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));t&&CL.firstRemoteFrame(this.store.sessionId,SL.FIRST_VIDEO_RECEIVED,vL.FIRST_VIDEO_RECEIVED,{peer:t._uintid,subscribeElapse:cW.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,t)=>{const i="relay"===e.candidateType,n="relay"===t.candidateType;"unknown"!==t.candidateType&&i===n||this.emit(MG.ConnectionTypeChange,i),EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Sj(t))," -> ").concat(JSON.stringify(Sj(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,t)=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Sj(t))," -> ").concat(JSON.stringify(Sj(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(MG.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===QB.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,EL.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===QB.SEND_ONLY?this.restartICE(e):tN(this,MG.RequestP2PRestartICE,{direction:QB.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(PG.LocalAudioTrack);if(e instanceof sV&&(null==i?void 0:i.track)instanceof oV)return i.track.isActive||t.push([PG.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===PG.LocalVideoTrack)){const e=this.localTrackMap.get(PG.LocalVideoLowTrack);e&&t.push([PG.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(PG.LocalAudioTrack);if(e instanceof sV&&(null==i?void 0:i.track)instanceof oV)return i.track.isActive&&t.push([PG.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===PG.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(PG.LocalVideoLowTrack);e&&t.push([PG.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:r}]=e;switch(i){case PG.LocalAudioTrack:t=gG.Audio;break;case PG.LocalVideoTrack:t=n._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High;break;case PG.LocalVideoLowTrack:t=gG.Low}return{stream_type:t,ssrcs:s,mid:r}}))}createUnmuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:r}]=e;switch(i){case PG.LocalAudioTrack:t=gG.Audio;break;case PG.LocalVideoTrack:t=n._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High;break;case PG.LocalVideoLowTrack:t=gG.Low}return{stream_type:t,ssrcs:s,mid:r}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case OG.VIDEO:return void(i._videoSSRC&&t.push({stream_type:OG.VIDEO,ssrcId:i._videoSSRC}));case OG.AUDIO:return void(i._audioSSRC&&t.push({stream_type:OG.AUDIO,ssrcId:i._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(PG.LocalVideoTrack),i=this.localTrackMap.get(PG.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return"connected"!==e&&"connected"!==t}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof sV){const i=this.filterTobeUnmutedTracks(e[t]);if(0===i.length)continue;const n=this.createUnmuteMessage(i);return void await iN(this,MG.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.recvConnection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(MG.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(MG.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await RN(UN(this.dtlsFailedCount,MN)),this.emit(MG.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(PG.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof XV))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof XV)).length>1)throw new CO(yO.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof sV)).length>1&&(e.some((e=>e instanceof sV&&e._bypassWebAudio))||!nx().webAudioMediaStreamDest))throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof XV&&this.pendingLocalTracks.some((e=>e instanceof XV)))throw new CO(yO.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof sV&&this.pendingLocalTracks.some((e=>e instanceof sV))&&(!nx().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof sV&&e._bypassWebAudio))))throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!JN("DISABLE_DUAL_STREAM_USE_ENCODING")&&nx().supportDualStreamEncoding,n=UB(UB({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():qW(e,n);const r=yN(8,"track-low-"),o=new XV(s,UB(UB({},i&&{scaleResolutionDownBy:Tj(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,r);return o.on(Ex.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,mx.LOW_STREAM)})),o._hints.push(fx.LOW_STREAM),e.addListener(px.NEED_CLOSE,(()=>{o.close()})),o}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,i,n){const s=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));if(s){n||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const r=this.store.keyMetrics,o=r.subscribe.find((e=>e.userId===s.uid&&"video"===e.type));CL.firstRemoteVideoDecode(this.store.sessionId,SL.FIRST_VIDEO_DECODE,vL.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:i,subscribeElapse:cW.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:r.requestAPEnd||0,apStart:r.requestAPStart||0,joinGwEnd:r.joinGatewayEnd||0,joinGwStart:r.joinGatewayStart||0,pcEnd:r.peerConnectionEnd||0,pcStart:r.peerConnectionStart||0,subscriberEnd:(null==o?void 0:o.subscribeEnd)||0,subscriberStart:(null==o?void 0:o.subscribeStart)||0,videoAddNotify:(null==o?void 0:o.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.recvConnection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const r=await this.recvConnection.getRemoteSSRC(s);return void 0!==r&&r!==i}resetConnection(e){EL.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===kG.Connected?(EL.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new CO(yO.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new CO(yO.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new CO(yO.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new CO(yO.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new CO(yO.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new CO(yO.NOT_SUPPORTED)}async preConnect(e,t,i,n,s,r){throw new CO(yO.NOT_SUPPORTED)}getEstablishParams(){throw new CO(yO.NOT_SUPPORTED)}async reSubscribe(e){throw new CO(yO.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new CO(yO.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===PG.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,mx.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}}).prototype,"p2pConnect",[pH],Object.getOwnPropertyDescriptor(CH.prototype,"p2pConnect"),CH.prototype),VB(CH.prototype,"unpublish",[fH],Object.getOwnPropertyDescriptor(CH.prototype,"unpublish"),CH.prototype),VB(CH.prototype,"unpublishLowStream",[mH],Object.getOwnPropertyDescriptor(CH.prototype,"unpublishLowStream"),CH.prototype),VB(CH.prototype,"subscribe",[EH],Object.getOwnPropertyDescriptor(CH.prototype,"subscribe"),CH.prototype),VB(CH.prototype,"mockSubscribe",[_H],Object.getOwnPropertyDescriptor(CH.prototype,"mockSubscribe"),CH.prototype),VB(CH.prototype,"unsubscribe",[gH],Object.getOwnPropertyDescriptor(CH.prototype,"unsubscribe"),CH.prototype),VB(CH.prototype,"muteRemote",[TH],Object.getOwnPropertyDescriptor(CH.prototype,"muteRemote"),CH.prototype),VB(CH.prototype,"unmuteRemote",[SH],Object.getOwnPropertyDescriptor(CH.prototype,"unmuteRemote"),CH.prototype),VB(CH.prototype,"hasRemoteMediaWithLock",[vH],Object.getOwnPropertyDescriptor(CH.prototype,"hasRemoteMediaWithLock"),CH.prototype),VB(CH.prototype,"disconnectForReconnect",[RH],Object.getOwnPropertyDescriptor(CH.prototype,"disconnectForReconnect"),CH.prototype),VB(CH.prototype,"remoteMediaSsrcChanged",[yH],Object.getOwnPropertyDescriptor(CH.prototype,"remoteMediaSsrcChanged"),CH.prototype),CH);function AH(e){return function(t,i,n){const s=t[i];if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];switch(e){case dH.SEND_ONLY:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}case dH.RECEIVE_ONLY:{const e=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}default:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i)),t=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e(),t()}}}},n}}class bH{constructor(e){this.store=void 0,this.onStatsException=void 0,this.onUploadPublishDuration=void 0,this.onStatsChanged=void 0,this.localStats=new Map,this.remoteStats=new Map,this.updateStatsInterval=void 0,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0,this.exceptionMonitor=void 0,this.p2pChannel=void 0,this.scalabilityMode=BB.L1T1,this.updateStats=()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))},this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new oW,this.exceptionMonitor.on("exception",((e,t,i)=>{this.onStatsException&&this.onStatsException(e,t,i)}))}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(PG.LocalAudioTrack)||UB({},Sx)}getLocalVideoTrackStats(){return this.localStats.get(PG.LocalVideoTrack)||UB({},vx)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.audioStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{audioStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRemoteNetworkQualityStats(e){const t={};if(e){var i;const n=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.networkStats;n&&(t[e]=n)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{networkStats:n}]=e;n&&(t[i]=n)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.videoStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{videoStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRTCStats(){let e=0,t=0,i=0,n=0;const s=this.localStats.get(PG.LocalAudioTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate);const r=this.localStats.get(PG.LocalVideoTrack);r&&(e+=r.sendBytes,t+=r.sendBitrate);const o=this.localStats.get(PG.LocalVideoLowTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:s}=e;t&&(i+=t.receiveBytes,n+=t.receiveBitrate),s&&(i+=s.receiveBytes,n+=s.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd)),e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const i=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),n=null!=i&&i.videoSSRC?cW.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?cW.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,n>s?n:s),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&EL.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;const n=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||t.framesDecodeCount>i.framesDecodeCount;return n||!s}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((t=>{let[i,n]=t;switch(i){case PG.LocalVideoTrack:case PG.LocalVideoLowTrack:{const t=n,r=UB({},vx),o=e.getStats(),a=e.getLocalMedia(i);if(o){const i=o.videoSend.find((e=>e.ssrc===(null==a?void 0:a.ssrcs[0].ssrcId)));if(i){const n=e.getLocalVideoSize(),s=e.getEncoderConfig(PG.LocalVideoTrack);"H264"!==i.codec&&"H265"!==i.codec&&"VP8"!==i.codec&&"VP9"!==i.codec&&"AV1X"!==i.codec&&"AV1"!==i.codec||(r.codecType=i.codec),r.sendBytes=i.bytes,r.sendBitrate=t?8*Math.max(0,r.sendBytes-t.sendBytes):0,i.inputFrame?(r.captureFrameRate=i.inputFrame.frameRate,r.captureResolutionHeight=i.inputFrame.height,r.captureResolutionWidth=i.inputFrame.width):n&&(r.captureResolutionWidth=n.width,r.captureResolutionHeight=n.height),i.sentFrame?(r.sendFrameRate=i.sentFrame.frameRate,r.sendResolutionHeight=i.sentFrame.height,r.sendResolutionWidth=i.sentFrame.width):n&&(r.sendResolutionWidth=n.width,r.sendResolutionHeight=n.height),i.avgEncodeMs&&(r.encodeDelay=i.avgEncodeMs),s&&s.bitrateMax&&(r.targetSendBitrate=1e3*s.bitrateMax),r.sendPackets=i.packets,r.sendPacketsLost=i.packetsLost,r.sendJitterMs=i.jitterMs,r.sendRttMs=i.rttMs,r.totalDuration=t?t.totalDuration+1:1,r.totalFreezeTime=t?t.totalFreezeTime:0,this.isLocalVideoFreeze(i)&&(r.totalFreezeTime+=1),i.scalabilityMode&&this.scalabilityMode!==i.scalabilityMode&&(EL.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(i.scalabilityMode)),this.scalabilityMode=i.scalabilityMode)}this.trafficStats&&(r.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var s;this.localStats.set(i,r),((null==t?void 0:t.sendResolutionWidth)!==r.sendResolutionWidth||(null==t?void 0:t.sendResolutionHeight)!==r.sendResolutionHeight)&&(null===(s=this.onStatsChanged)||void 0===s||s.call(this,"resolution",{width:r.sendResolutionWidth,height:r.sendResolutionHeight})),r&&a&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,a.track,r);break}case PG.LocalAudioTrack:{const t=n,s=UB({},Sx),r=e.getStats(),o=e.getLocalMedia(i);if(r){const i=r.audioSend.find((e=>e.ssrc===(null==o?void 0:o.ssrcs[0].ssrcId)));if(i){if("opus"!==i.codec&&"aac"!==i.codec&&"PCMU"!==i.codec&&"PCMA"!==i.codec&&"G722"!==i.codec||(s.codecType=i.codec),i.inputLevel)s.sendVolumeLevel=Math.round(32767*i.inputLevel);else{const t=e.getLocalAudioVolume();t&&(s.sendVolumeLevel=Math.round(32767*t))}s.sendBytes=i.bytes,s.sendPackets=i.packets,s.sendPacketsLost=i.packetsLost,s.sendJitterMs=i.jitterMs,s.sendRttMs=i.rttMs,s.sendBitrate=t?8*Math.max(0,s.sendBytes-t.sendBytes):0}}this.trafficStats&&(s.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(PG.LocalAudioTrack,s),s&&o&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,o.track,s);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{var i,n;let[s,{videoStats:r,audioStats:o,videoPcStats:a}]=t;const c=o,d=r,l=a,h=UB({},Rx),u=UB({},Cx),p=UB({},yx),{audioTrack:f,videoTrack:m,audioSSRC:E,videoSSRC:_}=e.getRemoteMedia(s);let g;g=e instanceof IH?e.getStats(!0):e.getStats();const T=null===(i=g)||void 0===i?void 0:i.audioRecv.find((e=>e.ssrc===E)),S=null===(n=g)||void 0===n?void 0:n.videoRecv.find((e=>e.ssrc===_)),v=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===s));if(T&&("opus"!==T.codec&&"aac"!==T.codec&&"PCMU"!==T.codec&&"PCMA"!==T.codec&&"G722"!==T.codec||(h.codecType=T.codec),T.outputLevel?h.receiveLevel=Math.round(32767*T.outputLevel):f&&(h.receiveLevel=Math.round(32767*f.getVolumeLevel())),h.receiveBytes=T.bytes,h.receivePackets=T.packets,h.receivePacketsLost=T.packetsLost,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=c?8*Math.max(0,h.receiveBytes-c.receiveBytes):0,h.totalDuration=c?c.totalDuration+1:1,h.totalFreezeTime=c?c.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=T.jitterBufferMs,h.totalDuration>10&&bH.isRemoteAudioFreeze(f)&&(h.totalFreezeTime+=1)),S){"H264"!==S.codec&&"H265"!==S.codec&&"VP8"!==S.codec&&"VP9"!==S.codec&&"AV1X"!==S.codec&&"AV1"!==S.codec||(u.codecType=S.codec),u.receiveBytes=S.bytes,u.receiveBitrate=d?8*Math.max(0,u.receiveBytes-d.receiveBytes):0,u.decodeFrameRate=S.decodeFrameRate<0?0:S.decodeFrameRate,u.renderFrameRate=S.decodeFrameRate<0?0:S.decodeFrameRate,S.outputFrame&&(u.renderFrameRate=S.outputFrame.frameRate),S.receivedFrame?(u.receiveFrameRate=S.receivedFrame.frameRate,u.receiveResolutionHeight=S.receivedFrame.height,u.receiveResolutionWidth=S.receivedFrame.width):m&&(u.receiveResolutionHeight=m._videoHeight||0,u.receiveResolutionWidth=m._videoWidth||0),void 0!==S.framesRateFirefox&&(u.receiveFrameRate=Math.round(S.framesRateFirefox)),u.receivePackets=S.packets,u.receivePacketsLost=S.packetsLost,u.packetLossRate=u.receivePacketsLost/(u.receivePackets+u.receivePacketsLost),u.totalDuration=d?d.totalDuration+1:1,u.totalFreezeTime=d?d.totalFreezeTime:0,u.receiveDelay=S.jitterBufferMs||0;const t=!!_&&e.getRemoteVideoIsReady(_);m&&t&&bH.isRemoteVideoFreeze(m,S,l)&&(u.totalFreezeTime+=1),u.freezeRate=u.totalFreezeTime/u.totalDuration}v&&(h.end2EndDelay=v.B_ad,u.end2EndDelay=v.B_vd,h.transportDelay=v.B_ed,u.transportDelay=v.B_ed,h.currentPacketLossRate=v.B_ealr4/100,u.currentPacketLossRate=v.B_evlr4/100,p.uplinkNetworkQuality=v.B_punq?v.B_punq:0,p.downlinkNetworkQuality=v.B_pdnq?v.B_pdnq:0),this.remoteStats.set(s,{audioStats:h,videoStats:u,videoPcStats:S,networkStats:p}),f&&this.exceptionMonitor.setRemoteAudioStats(f,h),m&&this.exceptionMonitor.setRemoteVideoStats(m,u)}))}}class wH extends GO{constructor(e,t,i,n){super(),this.spec=void 0,this.token=void 0,this.websocket=void 0,this.pingpongTimer=void 0,this.reconnectMode="retry",this.serviceMode=void 0,this.reqId=0,this.commandReqId=0,this.handleWebSocketOpen=()=>{this.reconnectMode="retry",this.startPingPong()},this.handleWebSocketMessage=e=>{if(!e.data)return;const t=JSON.parse(e.data);t.requestId?this.emit("@".concat(t.requestId,"-").concat(t.sid),t):this.serviceMode===nG.INJECT?this.emit(lG.INJECT_STREAM_STATUS,t):(CL.workerEvent(this.spec.sid,{actionType:"status",serverCode:t.code,workerType:this.serviceMode===nG.TRANSCODE?1:2}),this.emit(lG.PUBLISH_STREAM_STATUS,t))},this.spec=t,this.token=e,this.serviceMode=n,this.websocket=new dj("live-streaming",i),this.websocket.on(ZB.CONNECTED,this.handleWebSocketOpen),this.websocket.on(ZB.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(ZB.REQUEST_NEW_URLS,((e,t)=>{tN(this,lG.REQUEST_NEW_ADDRESS).then(e).catch(t)})),this.websocket.on(ZB.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,t,i,n){this.reqId+=1,"request"===e&&(this.commandReqId+=1);const s=this.commandReqId,r=this.reqId;if(!r||!this.websocket)throw new eG(yO.UNEXPECTED_ERROR);const o=UB({command:e,sdkVersion:"4.20.2"===KN?"0.0.1":KN,seq:r,requestId:r,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if("closed"===this.websocket.state)throw new eG(yO.WS_DISCONNECT);const a=()=>new Promise(((e,t)=>{this.websocket.once(ZB.CLOSED,(()=>t(new eG(yO.WS_ABORT)))),this.websocket.once(ZB.CONNECTED,e)}));"connected"!==this.websocket.state&&await a(),o.clientRequest&&(o.clientRequest.workerToken=this.token);const c=new Promise(((e,t)=>{const i=()=>{t(new eG(yO.WS_ABORT))};this.websocket.once(ZB.RECONNECTING,i),this.websocket.once(ZB.CLOSED,i),this.once("@".concat(r,"-").concat(this.spec.sid),(t=>{e(t)}))}));n&&CL.workerEvent(this.spec.sid,UB(UB({},n),{},{requestId:s,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));const d=Date.now();this.websocket.sendMessage(o);let l=null;try{l=await c}catch(n){if("closed"===this.websocket.state)throw n;return await a(),await this.request(e,t,i)}return n&&CL.workerEvent(this.spec.sid,UB(UB({},n),{},{requestId:s,actionType:"response",payload:JSON.stringify(l.serverResponse),serverCode:l.code,success:200===l.code,responseTime:Date.now()-d})),200!==l.code&&this.handleResponseError(l),l}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.20.2"===KN?"0.0.1":KN;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case uG.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void EL.warning("live stream response already exists stream");case uG.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case uG.LIVE_STREAM_RESPONSE_BAD_STREAM:case uG.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new eG(yO.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case uG.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new eG(yO.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case uG.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new eG(yO.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case uG.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new eG(yO.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(lG.WARNING,t,e.serverResponse.url)}case uG.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const t=new eG(yO.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(lG.WARNING,t,e.serverResponse.url)}case uG.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new eG(yO.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case uG.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new eG(yO.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case uG.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const t=new eG(yO.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(lG.WARNING,t,e.serverResponse.url)}case uG.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new eG(yO.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case uG.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new eG(yO.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case uG.LIVE_STREAM_RESPONSE_WORKER_LOST:case uG.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new eG(yO.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case uG.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;if("UpdateTranscoding"===e.serverResponse.command||"ControlStream"===e.serverResponse.command)return new eG(yO.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new eG(yO.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case uG.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case uG.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case uG.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case uG.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new eG(yO.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch(IN)}),6e3)}}class DH extends GO{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:MN,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:MN;super(),this.onLiveStreamWarning=void 0,this.onLiveStreamError=void 0,this.onInjectStatusChange=void 0,this.spec=void 0,this.retryTimeout=1e4,this.connection=void 0,this.httpRetryConfig=void 0,this.wsRetryConfig=void 0,this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.taskMutex=new PN("live-streaming"),this.cancelToken=YD.CancelToken.source(),this.transcodingConfig=void 0,this.injectConfig=UB({},dG),this.injectLoopTimes=0,this.uapResponse=void 0,this.lastTaskId=1,this.statusError=new Map,this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=t}async setTranscodingConfig(e){const t=UB(UB({},cG),e);66!==t.videoCodecProfile&&77!==t.videoCodecProfile&&100!==t.videoCodecProfile&&(EL.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(t.videoCodecProfile," -> 100")),t.videoCodecProfile=100),t.transcodingUsers||(t.transcodingUsers=t.userConfigs),t.transcodingUsers&&(t.transcodingUsers=t.transcodingUsers.map((e=>UB(UB(UB({},rG),e),{},{zOrder:e.zOrder?e.zOrder+1:1})))),function(e){NO(e.width)||bO(e.width,"config.width",0,1e4),NO(e.height)||bO(e.height,"config.height",0,1e4),NO(e.videoBitrate)||bO(e.videoBitrate,"config.videoBitrate",1,1e6),NO(e.videoFrameRate)||bO(e.videoFrameRate,"config.videoFrameRate"),NO(e.lowLatency)||IO(e.lowLatency,"config.lowLatency"),NO(e.audioSampleRate)||AO(e.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),NO(e.audioBitrate)||bO(e.audioBitrate,"config.audioBitrate",1,128),NO(e.audioChannels)||AO(e.audioChannels,"config.audioChannels",[1,2,3,4,5]),NO(e.videoGop)||bO(e.videoGop,"config.videoGop"),NO(e.videoCodecProfile)||AO(e.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),NO(e.userCount)||bO(e.userCount,"config.userCount",0,17),NO(e.backgroundColor)||bO(e.backgroundColor,"config.backgroundColor",0,16777215),NO(e.userConfigExtraInfo)||DO(e.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),e.transcodingUsers&&!NO(e.transcodingUsers)&&(OO(e.transcodingUsers,"config.transcodingUsers"),e.transcodingUsers.forEach(((e,t)=>{iG(e.uid),NO(e.x)||bO(e.x,"transcodingUser[".concat(t,"].x"),0,1e4),NO(e.y)||bO(e.y,"transcodingUser[".concat(t,"].y"),0,1e4),NO(e.width)||bO(e.width,"transcodingUser[".concat(t,"].width"),0,1e4),NO(e.height)||bO(e.height,"transcodingUser[".concat(t,"].height"),0,1e4),NO(e.zOrder)||bO(e.zOrder-1,"transcodingUser[".concat(t,"].zOrder"),0,100),NO(e.alpha)||bO(e.alpha,"transcodingUser[".concat(t,"].alpha"),0,1,!1)}))),NO(e.watermark)||aG(e.watermark,"watermark"),NO(e.backgroundImage)||aG(e.backgroundImage,"backgroundImage"),e.images&&!NO(e.images)&&(OO(e.images,"config.images"),e.images.forEach(((e,t)=>{aG(e,"images[".concat(t,"]"))})))}(t);const i=[];t.images&&i.push(...t.images.map((e=>UB(UB(UB({},oG),e),{},{zOrder:255})))),t.backgroundImage&&(i.push(UB(UB(UB({},oG),t.backgroundImage),{},{zOrder:0})),delete t.backgroundImage),t.watermark&&(i.push(UB(UB(UB({},oG),t.watermark),{},{zOrder:255})),delete t.watermark),t.images=i,t.transcodingUsers&&(t.userConfigs=t.transcodingUsers.map((e=>UB({},e))),t.userCount=t.transcodingUsers.length,delete t.transcodingUsers);const n=(t.userConfigs||[]).map((e=>"number"==typeof e.uid?Promise.resolve(e.uid):iW(e.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await Promise.all(n)).forEach(((e,i)=>{t.userConfigs&&t.userConfigs[i]&&(t.userConfigs[i].uid=e)})),this.transcodingConfig=t,this.connection)try{const e=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(this.streamingTasks.values()).map((e=>e.taskId)).join("#")});EL.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(e.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(e){if(!e.data||!e.data.retry)throw e;e.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((t=>{EL.warning("[".concat(this.spec.clientId,"] live streaming receive error"),e.toString(),"try to republish",t.url),this.startLiveStreamingTask(t.url,t.mode,e).then((()=>{EL.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(t.url," success"))})).catch((e=>{EL.error("[".concat(this.spec.clientId,"] live streaming republish failed"),t.url,e.toString()),this.onLiveStreamError&&this.onLiveStreamError(t.url,e)}))}))}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(e,t,i){if(Array.from(this.streamingTasks.values()).find((e=>e.mode===nG.INJECT))&&t===nG.INJECT)return new eG(yO.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&t===nG.TRANSCODE)throw new eG(yO.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let n={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};EL.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(t));const s=await this.taskMutex.lock();if(!this.connection&&i)return void s();if(this.streamingTasks.get(e)&&!i)return s(),new eG(yO.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(t))}catch(e){throw s(),e}switch(t){case nG.TRANSCODE:n.transcodingConfig=UB({},this.transcodingConfig);break;case nG.RAW:break;case nG.INJECT:n={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(n.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const r=this.lastTaskId++;try{const o=new Promise(((t,n)=>{RN(this.retryTimeout).then((()=>{if(i)return n(i);const t=this.statusError.get(e);return t?(this.statusError.delete(e),n(t)):void 0}))})),a=await Promise.race([this.connection.request("request",{clientRequest:n},!0,{url:e,command:"PublishStream",workerType:t===nG.TRANSCODE?1:2,requestByUser:!i,tid:r.toString()}),o]);this.isStartingStreamingTask=!1,EL.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(a.code)),this.streamingTasks.set(e,{clientRequest:n,mode:t,url:e,taskId:r}),s()}catch(n){if(s(),this.isStartingStreamingTask=!1,!n.data||!n.data.retry||i)throw n;return n.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,t,n)):await this.startLiveStreamingTask(e,t,n)}}stopLiveStreamingTask(e){return new Promise(((t,i)=>{const n=this.streamingTasks.get(e);if(!n||!this.connection)return new eG(yO.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=n.mode;n.abortTask=()=>{EL.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),t()},this.connection.request("request",{clientRequest:{command:s===nG.INJECT?"UninjectStream":"UnpublishStream",url:n.url}},!1,{url:e,command:"UnPublishStream",workerType:s===nG.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((i=>{EL.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(i.code)),this.streamingTasks.delete(e),0===this.streamingTasks.size&&s!==nG.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),t(),s===nG.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(sG.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)})).catch(i)}))}async controlInjectStream(e,t,i,n){const s=this.streamingTasks.get(e);if(!s||!this.connection||s.mode!==nG.INJECT)throw new eG(yO.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:i,position:n}})).serverResponse}resetAllTask(){const e=Array.from(this.streamingTasks.values());this.terminate();for(const t of e)this.startLiveStreamingTask(t.url,t.mode).catch((e=>{this.onLiveStreamError&&this.onLiveStreamError(t.url,e)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=YD.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new eG(yO.UNEXPECTED_ERROR,"live streaming connection has already connected");const t=await tN(this,hG.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new wH(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(lG.WARNING,((e,t)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e))),this.connection.on(lG.PUBLISH_STREAM_STATUS,(e=>this.handlePublishStreamServer(e))),this.connection.on(lG.INJECT_STREAM_STATUS,(e=>this.handleInjectStreamServerStatus(e))),this.connection.on(lG.REQUEST_NEW_ADDRESS,((t,i)=>{if(!this.connection)return i(new eG(yO.UNEXPECTED_ERROR,"can not get new live streaming address list"));tN(this,hG.REQUEST_WORKER_MANAGER_LIST,e).then((e=>{this.uapResponse=e,t(e.addressList)})).catch(i)})),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){const t=e.serverStatus&&e.serverStatus.url||"empty_url",i=this.streamingTasks.get(t),n=e.reason;switch(e.code){case uG.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case uG.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case uG.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case uG.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const n=new eG(yO.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(i)return EL.error(n.toString()),this.onLiveStreamError&&this.onLiveStreamError(t,n);if(!this.isStartingStreamingTask)return;this.statusError.set(t,n)}case uG.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new eG(yO.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,n);return this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e)}case uG.LIVE_STREAM_RESPONSE_WORKER_LOST:case uG.LIVE_STREAM_RESPONSE_WORKER_QUIT:{if(!this.connection)return;this.connection.tryNextAddress();const t=Array.from(this.streamingTasks.values());for(const i of t)i.abortTask?i.abortTask():(EL.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",i.url),this.startLiveStreamingTask(i.url,i.mode,new eG(yO.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then((()=>{EL.debug("[".concat(this.spec.clientId,"] republish live stream success"),i.url)})).catch((e=>{EL.error(e.toString()),this.onLiveStreamError&&this.onLiveStreamError(i.url,e)})));return}}}handleInjectStreamServerStatus(e){const t=Number(e.uid),i=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(sG.INJECT_STREAM_STATUS_START_SUCCESS,t,i));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(sG.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,t,i),void this.streamingTasks.delete(i);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(sG.INJECT_STREAM_STATUS_START_UNAUTHORIZED,t,i),void this.streamingTasks.delete(i);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(sG.INJECT_STREAM_STATUS_BROKEN,t,i),void this.streamingTasks.delete(i);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(sG.INJECT_STREAM_STATUS_START_TIMEOUT,t,i),void this.streamingTasks.delete(i);default:return void EL.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class OH{constructor(){this.destChannelMediaInfos=new Map,this.srcChannelMediaInfo=void 0}setSrcChannelInfo(e){pG(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){pG(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){tG(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function NH(e){if(!(e instanceof OH))return new eG(yO.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();return t?0===i.size?new eG(yO.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw():void 0:new eG(yO.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}class LH extends GO{constructor(e,t,i){super(),this.ws=void 0,this.requestId=1,this.heartBeatTimer=void 0,this.joinInfo=void 0,this.clientId=void 0,this.onOpen=()=>{this.emit("open"),this.startHeartBeatCheck()},this.onClose=e=>{this.emit("close"),this.dispose()},this.onMessage=e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)},this.joinInfo=e,this.clientId=t,this.ws=new dj("cross-channel-".concat(this.clientId),i),this.ws.on(ZB.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(ZB.CONNECTED,this.onOpen),this.ws.on(ZB.ON_MESSAGE,this.onMessage),this.ws.on(ZB.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new Promise(((t,i)=>{const n=window.setTimeout((()=>{i(new eG(yO.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(s=>{window.clearTimeout(n),s.state&&0!==s.state?i(new eG(yO.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(n),i(new eG(yO.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new eG(yO.WS_DISCONNECT);"connected"!==this.ws.state&&await(()=>new Promise(((e,t)=>{this.ws.once(ZB.CLOSED,(()=>t(new eG(yO.WS_ABORT)))),this.ws.once(ZB.CONNECTED,e)})))();const t=this.sendMessage(e),i=new Promise(((e,i)=>{const n=()=>{i(new eG(yO.WS_ABORT))};this.ws.once(ZB.RECONNECTING,n),this.ws.once(ZB.CLOSED,n),this.once("req_".concat(t),e),RN(3e3).then((()=>{this.removeAllListeners("req_".concat(t)),this.ws.off(ZB.RECONNECTING,n),this.ws.off(ZB.CLOSED,n),i(new eG(yO.TIMEOUT,"cross channel ws request timeout"))}))})),n=await i;if(!n||200!==n.code)throw new eG(yO.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(n)));return n}async connect(e){this.ws.removeAllListeners(ZB.REQUEST_NEW_URLS),this.ws.on(ZB.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class PH extends GO{set state(e){e!==this._state&&(e!==EG.RELAY_STATE_FAILURE&&(this.errorCode=_G.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,t,i,n,s){super(),this.joinInfo=void 0,this.sid=void 0,this.clientId=void 0,this.cancelToken=YD.CancelToken.source(),this.workerToken=void 0,this.requestId=0,this.signal=void 0,this.prevChannelMediaConfig=void 0,this.httpRetryConfig=void 0,this._resolution=void 0,this._state=EG.RELAY_STATE_IDLE,this.errorCode=_G.RELAY_OK,this.onStatus=e=>{EL.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(e))),e&&e.command&&("onAudioPacketReceived"===e.command&&this.emit("event",mG.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===e.command&&this.emit("event",mG.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===e.command&&(this.errorCode=_G.SRC_TOKEN_EXPIRED,this.state=EG.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===e.command&&(this.errorCode=_G.DEST_TOKEN_EXPIRED,this.state=EG.RELAY_STATE_FAILURE))},this.onReconnect=async()=>{EL.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",mG.NETWORK_DISCONNECTED),this.state=EG.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((e=>{this.state!==EG.RELAY_STATE_IDLE&&(EL.error("auto restart channel media relay failed",e.toString()),this.errorCode=_G.SERVER_CONNECTION_LOST,this.state=EG.RELAY_STATE_FAILURE)}))},this.joinInfo=e,this.clientId=t,this.sid=CN(),this.signal=new LH(this.joinInfo,this.clientId,i),this.httpRetryConfig=n,this._resolution=s}async startChannelMediaRelay(e){if(this.state!==EG.RELAY_STATE_IDLE)throw new eG(yO.INVALID_OPERATION);this.state=EG.RELAY_STATE_CONNECTING,await this.connect(),EL.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new eG(yO.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new eG(yO.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new eG(yO.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==EG.RELAY_STATE_RUNNING)throw new eG(yO.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==EG.RELAY_STATE_RUNNING)throw new eG(yO.INVALID_OPERATION);const t=this.genMessage(fG.SetVideoProfile);await this.signal.request(t),EL.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),EL.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=EG.RELAY_STATE_IDLE,this.dispose()}dispose(){EL.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=YD.CancelToken.source(),this.state=EG.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await async function(e,t,i){const n=JN("UAP_AP").slice(0,JN("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap"))).map((n=>function(e,t,i,n){const s={command:"convergeAllocateEdge",sid:t.sid,appId:t.appId,token:t.token,ts:Date.now(),version:KN,cname:t.cname,uid:t.uid.toString(),requestId:Wj,seq:Wj};Wj+=1;const r={service_name:"tele_channel",json_body:JSON.stringify(s)};return xN((async()=>{const t=await Lj(e,{data:r,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==t.code){const e=new eG(yO.UNEXPECTED_RESPONSE,"cross channel ap error, code"+t.code,{retry:!0});throw EL.error(e.toString()),e}const n=JSON.parse(t.json_body);if(200!==n.code){const e=new eG(yO.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(n.code,", reason: ").concat(n.reason));throw EL.error(e.toString()),e}if(!n.servers||0===n.servers.length){const e=new eG(yO.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw EL.error(e.toString()),e}return{vid:n.vid,workerToken:n.workerToken,addressList:(JN("CHANNEL_MEDIA_RELAY_SERVERS")||n.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(JN("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==yO.OPERATION_ABORTED&&e.code!==yO.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),n)}(n,e,t,i)));try{const e=await Qj(n);return n.forEach((e=>e.cancel())),e}catch(e){throw e[0]}}(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",mG.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const t=this.genMessage(fG.StopPacketTransfer);await this.signal.request(t),await this.signal.waitStatus("Normal Quit"),EL.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const i=this.genMessage(fG.SetSdkProfile,e);await this.signal.request(i),EL.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const n=this.genMessage(fG.SetSourceChannel,e);await this.signal.request(n),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",mG.PACKET_JOINED_SRC_CHANNEL),EL.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const s=this.genMessage(fG.SetSourceUserId,e);await this.signal.request(s),EL.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const r=this.genMessage(fG.SetDestChannel,e);await this.signal.request(r),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",mG.PACKET_JOINED_DEST_CHANNEL),EL.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const o=this.genMessage(fG.StartPacketTransfer,e);await this.signal.request(o),this.emit("event",mG.PACKET_SENT_TO_DEST_CHANNEL),this.state=EG.RELAY_STATE_RUNNING,EL.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const t=this.genMessage(fG.UpdateDestChannel,e);await this.signal.request(t),this.emit("event",mG.PACKET_UPDATE_DEST_CHANNEL),EL.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(fG.StopPacketTransfer);await this.signal.request(e),EL.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const i=[],n=[],s=[];this.requestId+=1;const r={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:KN,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.20.2"===r.sdkVersion&&(r.sdkVersion="0.0.1");let o=null,a=null;switch(e){case fG.SetSdkProfile:return r.clientRequest={command:"SetSdkProfile",type:"multi_channel"},r;case fG.SetSourceChannel:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new eG(yO.UNEXPECTED_ERROR,"can not find source config");return r.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},r;case fG.SetSourceUserId:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new eG(yO.UNEXPECTED_ERROR,"can not find source config");return r.clientRequest={command:"SetSourceUserId",uid:a.uid+""},r;case fG.SetDestChannel:if(o=t&&t.getDestChannelMediaInfo(),!o)throw new eG(yO.UNEXPECTED_ERROR,"can not find dest config");return o.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),r.clientRequest={command:"SetDestChannel",channelName:i,uid:n,token:s},r;case fG.StartPacketTransfer:return r.clientRequest={command:"StartPacketTransfer"},r;case fG.Reconnect:return r.clientRequest={command:"Reconnect"},r;case fG.StopPacketTransfer:return r.clientRequest={command:"StopPacketTransfer"},r;case fG.UpdateDestChannel:if(o=t&&t.getDestChannelMediaInfo(),!o)throw new eG(yO.UNEXPECTED_ERROR,"can not find dest config");return o.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),r.clientRequest={command:"UpdateDestChannel",channelName:i,uid:n,token:s},r;case fG.SetVideoProfile:r.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return r}}var kH;let MH=(kH=class e extends DG{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(eL).includes(e))))]}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.statsFilter=void 0,this.useRTX=!1,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.establishPromise=void 0,this.mutex=new PN("P2PConnection-mutex"),this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=yW(this.peerConnection,JN("STATS_UPDATE_INTERVAL"),void 0,lO()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=IW(e.sdp),i=CW(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:JN("FILTER_VIDEO_FEC"),filterAudioFec:JN("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,UB(UB({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new CO(yO.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,r){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(e){this.sessionDesc=void 0,this.localCapabilities=void 0,this.rtpCapabilities=void 0,this.candidates=void 0,this.iceParameters=void 0,this.dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,e=uN(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:r,localCapabilities:o,sdkCodec:a,cname:c}=e,d=dW.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=s,this.candidates=n,this.iceParameters=t,this.dtlsParameters=i,this.setup=r,this.localCapabilities=o,this.cname=c;for(let e=0;e<d.mediaDescriptions.length;e++){const o=d.mediaDescriptions[e];if(o.attributes.iceUfrag=t.iceUfrag,o.attributes.icePwd=t.icePwd,o.attributes.fingerprints=i.fingerprints,o.attributes.candidates=n,o.attributes.setup=r,"video"===o.media.mediaType){o.media.fmts=s.videoCodecs.map((e=>e.payloadType.toString(10)));let e=s.videoCodecs.filter((e=>{var t;return null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase().includes(a)}));0===e.length&&(e=s.videoCodecs),o.attributes.payloads=e,o.attributes.extmaps=s.videoExtensions}"audio"===o.media.mediaType&&(o.media.fmts=s.audioCodecs.map((e=>e.payloadType.toString(10))),o.attributes.payloads=s.audioCodecs,o.attributes.extmaps=s.audioExtensions),d.mediaDescriptions[e]=this.mungMediaDesc(o)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return dW.print(this.sessionDesc)}send(e,t,i){const{ssrcs:n,ssrcGroups:s}=wW(t,this.cname),r=this.sessionDesc.mediaDescriptions.find((t=>e===OG.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),o=n[0].attributes.label,a=n[0].attributes.mslabel;return r.attributes.ssrcs=r.attributes.ssrcs.concat(n),r.attributes.ssrcGroups=r.attributes.ssrcGroups.concat(s),{id:o,mslabel:a}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:i}=e;return this.send(t,i,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const i=[],n=[],s=[];t.attributes.ssrcs.forEach((t=>{e.includes(t.attributes.label||"")?s.push(t):i.push(t)})),t.attributes.ssrcGroups.forEach((e=>{s.map((e=>e.ssrcId)).includes(e.ssrcIds[0])||n.push(e)})),t.attributes.ssrcs=i,t.attributes.ssrcGroups=n}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,i){e.forEach(((e,t)=>{const i=e._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===i.kind)),s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=s}))}stopReceiving(e){}updateCandidates(e){e===NG.TCP?this.candidates.forEach((e=>{-1===this.candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this.candidates.push(UB(UB({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this.candidates=this.candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=uN(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}mungRecvMediaDsec(e,t){const i=uN(e);return DW(i,t),NW(i,t),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,i){const n=this.sessionDesc.mediaDescriptions.find((t=>e===OG.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(n){const e=n.attributes.ssrcs.find((e=>e.attributes.label===t));var s;e&&(e.attributes.label=i,null===(s=e.attributes.msid)||void 0===s||s.replace(t,i))}}mungMediaDesc(e){const t=uN(e);return OW(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const i of t.attributes.ssrcs)if(i.attributes.label===e)return[i]}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n.send,remoteSetup:s,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:r});const o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){throw new CO(yO.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(e,t){var i=this;return xB((function*(){const n=yield kB(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=e.map((e=>i.peerConnection.addTrack(e._mediaStreamTrack))),r=yield kB(i.peerConnection.createOffer()),o=dW.parse(r.sdp),a=e.map((e=>{const t=e._mediaStreamTrack,n=o.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,i){const n=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),s=e.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(s&&n.length>1){const e=s.find((e=>-1!==e.ssrcIds.indexOf(n[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:i?e.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,t.id,i.useRTX)}));let c;try{c=yield a}catch(e){throw s.forEach((e=>{dO()&&e.replaceTrack(null),i.peerConnection.removeTrack(e)})),e}const d=i.mungSendOfferSDP(r.sdp,e);i.remoteSDP.receive(e,t,c);const l=i.remoteSDP.toString();return yield kB(i.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield kB(i.applySendEncodings(s,e)),yield kB(i.peerConnection.setRemoteDescription({type:"answer",sdp:l})),e.map(((e,t)=>{const i=e._mediaStreamTrack.id;return{localSSRC:a[t],id:i}}))}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{dO()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:i,mslabel:s}=this.remoteSDP.send(e,t,n),r=new Promise(((t,n)=>{const r=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),o=n=>{const a=sO();if(("Safari"===a.name&&11===Number(a.version)||hO())&&n.track.id!==i&&n.streams[0].id===s){var c;const s=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,i,n.track.id),this.peerConnection.removeEventListener("track",o),clearTimeout(r),void t(s)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",o),clearTimeout(r),void t(n.track)};this.peerConnection.addEventListener("track",o)})),o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const a=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(a),{track:await r,id:i}}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(dO()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(dO()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return xB((function*(){const i=yield kB(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(nx().supportPCSetConfiguration){const i=t.peerConnection.getConfiguration(),n=e===NG.RELAY?"relay":"all";i.iceTransportPolicy!==n&&(EL.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,t.peerConnection.setConfiguration(i))}else if(e===NG.RELAY)return;e!==NG.RELAY&&t.remoteSDP.updateCandidates(e);const n=yield kB(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=IW(n.sdp),{remoteIceParameters:r}=yield s.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString();yield kB(t.peerConnection.setLocalDescription(n)),yield kB(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){EL.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),e)}finally{i()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getSenders().filter((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));1===i.length&&await this.applySendEncodings(i,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new CO(yO.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new CO(yO.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,EL.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,EL.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),JN("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&($O(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),JN("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async updateRtpSenderEncodings(e,t){var i;if(t||(t=this.peerConnection.getSenders().find((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e._mediaStreamTrack.id}))),!t)return EL.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!nx().supportSetRtpSenderParameters)return EL.warn("Browser not support set rtp-sender parameters");const n={},s={};if(e instanceof XV)switch(e._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(JN("DSCP_TYPE")&&SO()){const e=JN("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(s.networkPriority=e)}const r=t.getParameters(),o=null===(i=r.encodings)||void 0===i?void 0:i[0];o&&Object.assign(o,s),Object.assign(r,n),EL.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(r.encodings))),await t.setParameters(r)}async applySendEncodings(e,t){try{if(!nx().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let i=0;i<e.length;i++){const n=e[i],s=t[i];n&&s&&await this.updateRtpSenderEncodings(s,n)}}catch(e){EL.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){const i=dW.parse(e);return t.forEach(((e,t)=>{const n=e._mediaStreamTrack,s=i.mediaDescriptions.find((e=>e.attributes.mid===n.kind));s&&DW(s,e)})),dW.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,i)=>{let{id:n,mslabel:s}=t;const{kind:r}=e[i];return new Promise(((e,t)=>{const i=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(n)))}),1e4),o=t=>{const a=sO();if("Safari"===a.name&&11===Number(a.version)&&t.track.id!==n&&t.streams[0].id===s){var c;const s=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(r,n,t.track.id),this.peerConnection.removeEventListener("track",o),clearTimeout(i),void e({track:s,id:n})}if(t.track.id===n)return this.peerConnection.removeEventListener("track",o),clearTimeout(i),void e({track:t.track,id:n})};this.peerConnection.addEventListener("track",o)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await Promise.all(t)}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(nx().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},VB(kH.prototype,"connect",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"connect"),kH.prototype),VB(kH.prototype,"stopSending",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"stopSending"),kH.prototype),VB(kH.prototype,"receive",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"receive"),kH.prototype),VB(kH.prototype,"stopReceiving",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"stopReceiving"),kH.prototype),VB(kH.prototype,"muteRemote",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"muteRemote"),kH.prototype),VB(kH.prototype,"unmuteRemote",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"unmuteRemote"),kH.prototype),VB(kH.prototype,"muteLocal",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"muteLocal"),kH.prototype),VB(kH.prototype,"unmuteLocal",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"unmuteLocal"),kH.prototype),VB(kH.prototype,"close",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"close"),kH.prototype),VB(kH.prototype,"updateEncoderConfig",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"updateEncoderConfig"),kH.prototype),VB(kH.prototype,"updateSendParameters",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"updateSendParameters"),kH.prototype),VB(kH.prototype,"replaceTrack",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"replaceTrack"),kH.prototype),VB(kH.prototype,"getRemoteSSRC",[UH],Object.getOwnPropertyDescriptor(kH.prototype,"getRemoteSSRC"),kH.prototype),kH);function UH(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("Locking from P2PConnection.".concat(t));try{for(var s=arguments.length,r=new Array(s),o=0;o<s;o++)r[o]=arguments[o];return await n.apply(this,r)}finally{i()}},i}const xH="9";var FH;let VH=(FH=class e extends DG{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(eL).includes(e))))]}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=JN("USE_XR"),this.localCapabilities=void 0,this.remoteCodecs=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.recoveredDataChannelIds=[],this.currentDataChannelId=1,this.mutex=new PN("P2PConnection-mutex"),this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=yW(this.peerConnection,JN("STATS_UPDATE_INTERVAL"),void 0,lO()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const i=this.remoteSDP.toString();null==t||t(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else EL.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else EL.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t))}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=IW(e.sdp),i=await MW({filterRTX:!JN("USE_PUB_RTX")&&!JN("USE_SUB_RTX"),filterVideoFec:JN("FILTER_VIDEO_FEC"),filterAudioFec:JN("FILTER_AUDIO_FEC"),filterVideoCodec:JN("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=FW(i),this.initialOffer=e,UB(UB({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new CO(yO.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,r){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return uN(this._localCapabilities)}get rtpCapabilities(){return uN(this._rtpCapabilities)}get candidates(){return uN(this._candidates)}get iceParameters(){return uN(this._iceParameters)}get dtlsParameters(){return uN(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=uN(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:r,localCapabilities:o,cname:a}=e,c=dW.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o,this.setup=r,this.cname=a;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=r,"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,JN("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=wW([{ssrcId:4e4,rtx:JN("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,VW(e),JN("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=wW([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const e=JN("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let r=1;r<e;r++){const e=2*r+2e4,o=2*r+4e4,{ssrcs:a,ssrcGroups:c}=wW([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=wW([{ssrcId:o,rtx:JN("USE_SUB_RTX")?o+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:xH,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*r)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:xH,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*r+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return dW.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:r}=wW(t,this.cname,JN("SYNC_GROUP")?i:void 0),o=this.findPreloadMediaDesc(s);if(o){if(lO()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,o.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(o,n),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||1===t&&(dO()||pO())||0===t&&JN("USE_SUB_RTX")||fO()?(i=this.createOrRecycleSendMedia(e,s,r,"sendonly",n),this.updateBundleMids()):(i=uN(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=r,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),lO()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||lO()||fO()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){const t=this._candidates.filter((e=>"udp"===e.transport));if(e===NG.TCP){if(0===t.length)return;if(JN("TCP_CANDIDATE_ONLY")){const e=this._candidates.filter((e=>"tcp"===e.transport));t.forEach((t=>{-1===e.findIndex((e=>e.connectionAddress===t.connectionAddress))&&e.push(UB(UB({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=e}else{const e=[];t.forEach((t=>{e.push(UB(UB({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=[...t,...e]}}else if(e===NG.RELAY){if(0!==t.length)return;{const e=this._candidates.filter((e=>"tcp"===e.transport));e.forEach((e=>{t.push(UB(UB({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=[...t,...e]}}else 0===t.length?(this._candidates.filter((e=>"tcp"===e.transport)).forEach((e=>{t.push(UB(UB({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=t):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=uN(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(lO()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleDataChannel(){for(const e of this.sessionDesc.mediaDescriptions)if("application"===e.media.mediaType)return{mediaDesc:e,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:xH,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,i,n,s,r){const o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=GW(o,a,this.localCapabilities.send,o===OG.VIDEO?n:s),d=o===OG.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:o,port:xH,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,e,r);const u=this.findFirstClosedMedia(o);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(e,t,i){const n=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(eL).includes(e))))],s=new Set(t);if(n.every((e=>s.has(e))))return EL.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const r=this._rtpCapabilities.recv.videoCodecs.filter((e=>t.some((t=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(t)))));if(0===r.length)return EL.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(n," codecs: ").concat(t)),!1;const o=[...new Set(r.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let a;if(EL.debug("updateRemoteCodec, from ".concat(n," to ").concat(o)),0===e.length)a=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&e.includes(t.attributes.mid)&&"recvonly"===t.attributes.direction)),a.length!==e.length)return EL.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;this._rtpCapabilities.recv.videoCodecs=r;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=GW(OG.VIDEO,d,c,i);return a.forEach((e=>{const t=l.map((e=>e.payloadType.toString(10)));EL.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(l)),e.attributes.payloads=l,e.media.fmts=t})),!0}createOrRecycleSendMedia(e,t,i,n,s){const r=this.rtpCapabilities.send,o=e===OG.VIDEO?r.videoCodecs:r.audioCodecs,a=e===OG.VIDEO?r.videoExtensions:r.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:xH,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=uN(e);return OW(n),DW(n,t),NW(n,t),LW(n),PW(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=uN(e);return PW(i,t,this.localCapabilities.recv),VW(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>lO()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:this.localCapabilities,cname:r}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const o=this.remoteSDP.toString(),a=dW.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&VW(c),this.useXR&&BW(a);const d=dW.print(a),l=this.logSDPExchange(d||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o});const h=this.peerConnection.getTransceivers()[0];if(null!=h&&h.receiver&&this.tryBindTransportEvents(h.receiver),JN("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return xB((function*(){const s=yield kB(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const r=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});r.push(t),e._updateRtpTransceiver(t)})),lO()&&!0===JN("SIMULCAST")&&(yield kB(n.applySimulcastForFirefox(r,e)));const o=yield kB(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(o.sdp,e,a),d=dW.parse(c),l=a.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return AW(t,JN("USE_PUB_RTX"))}));let h;try{h=yield l}catch(s){h=[],n.remoteSDP.receive(e,t,i,h);const r=n.remoteSDP.toString();throw yield kB(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield kB(n.peerConnection.setRemoteDescription({type:"answer",sdp:r})),yield kB(n.stopSending(a,!0)),s}n.remoteSDP.receive(e,t,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield kB(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield kB(n.applySimulcastEncodings(r,e)),yield kB(n.applySendEncodings(r,e)),null==p||p(u),yield kB(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),r.map(((e,t)=>{const i=a[t];return{localSSRC:l[t],id:i,transceiver:e}}))}catch(e){throw e instanceof CO?e:new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);if(i&&"open"===i.readyState)EL.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const t=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if("number"!=typeof t)throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:t,negotiated:!0,ordered:!1,maxRetransmits:JN("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)}t.forEach((e=>{e._updateOriginDataChannel(i)}));const{needExchangeSDP:n}=this.remoteSDP.sendDataChannel();if(n){const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t),EL.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else EL.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof CO?e:new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return t&&(t.id&&this.recoveredDataChannelIds.push(t.id),t.close()),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof CO?e:new CO(yO.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==s||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:r}=this.remoteSDP.send(e,t,i,n);if(r){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(n.sdp,s,e);null==i||i(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),EL.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else EL.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const o=this.peerConnection.getTransceivers().find((e=>e.mid===s));if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:s,transceiver:o}}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:i}=this.remoteSDP.batchSend(e);if(i){const e=this.remoteSDP.toString(),t=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();null==t||t(i.sdp||""),await this.peerConnection.setLocalDescription(i),EL.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else EL.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return xB((function*(){const i=yield kB(t.mutex.lock("From P2PConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(nx().supportPCSetConfiguration){const i=t.peerConnection.getConfiguration(),n=e===NG.RELAY?"relay":"all";i.iceTransportPolicy!==n&&(EL.debug("[".concat(t.store.clientId,"] restartICE change iceTransportPolicy from [").concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,t.peerConnection.setConfiguration(i))}else if(e===NG.RELAY)return;t.remoteSDP.updateCandidates(e);const n=yield kB(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=IW(n.sdp),{remoteIceParameters:r}=yield s.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString(),a=t.logSDPExchange(n.sdp||"","offer","local","restartICE");t.store.descriptionStart(),yield kB(t.peerConnection.setLocalDescription(n)),null==a||a(o),yield kB(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){EL.warning("[".concat(t.store.clientId,"] restart ICE failed, abort operation"),e)}finally{i()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==r||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new CO(yO.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?lO()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:UB(UB({},pW),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:UB(UB({},pW),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,EL.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,EL.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),JN("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&($O(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),JN("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),JN("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),JN("ENABLE_ENCODED_TRANSFORM")&&nx().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(uj(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!JN("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(e){const t=e.transport;if(t){this.transportEventReceiver=e,t.onstatechange=()=>{var e;null!=t&&t.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,t.state))},t.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const i=t.iceTransport;i&&(i.onstatechange=()=>{const e=null==t?void 0:t.iceTransport.state;var i;e&&(null===(i=this.onICETransportStateChange)||void 0===i||i.call(this,e))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:e,remote:t}=i.getSelectedCandidatePair();EL.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:t.type,protocol:t.protocol,address:t.address,port:t.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,t){var i;if(t||(t=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))),!t)return EL.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return EL.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!nx().supportSetRtpSenderParameters)return EL.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const n={},s={};switch(e._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(e._encoderConfig){const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(s.maxBitrate=1e3*t),(e._hints.includes(fx.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(i&&(s.maxFramerate=fj(i)),n&&n>=1&&(s.scaleResolutionDownBy=n))}if(JN("DSCP_TYPE")&&SO()){const e=JN("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(s.networkPriority=e)}const r=t.getParameters(),o=null===(i=r.encodings)||void 0===i?void 0:i[0];lO()&&!o&&(n.encodings=[s]),o&&Object.assign(o,s),Object.assign(r,n),EL.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(r.encodings))),await t.setParameters(r)}async applySendEncodings(e,t){try{if(!nx().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let i=0;i<e.length;i++){const n=e[i],s=t[i];s instanceof XV&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){EL.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=dW.parse(e);return t.forEach(((e,t)=>{const s=i[t],r=n.mediaDescriptions.find((e=>e.attributes.mid===s));r&&(DW(r,e),kW(r,e,this.store.codec))})),dW.print(n)}mungReceiveAnswerSDP(e,t,i){const n=dW.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&(i===OG.AUDIO&&"audio"===s.media.mediaType&&VW(s),this.useXR&&BW(n)),dW.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let o=0;o<e.length;o++){var i,n,s,r;const a=e[o],c=t[o];if(c instanceof XV&&!c._hints.includes(fx.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(r=c._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=a.sender.getParameters();await a.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!lO()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof XV&&this.isVP8Simulcast(n)){const t=e[i],s={},r={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:r.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:r.medium,scaleResolutionDownBy:4}];const o=t.sender.getParameters();await t.sender.setParameters(Object.assign(o,s))}}}isVP8Simulcast(e){var t,i,n,s;return!!(e instanceof XV&&JN("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(fx.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabilityMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,t,i,n){if(JN("SDP_LOGGING"))return EL.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(t," SDP during P2PConnection.").concat(n,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",n)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(nx().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},VB(FH.prototype,"updateRemoteRTPCapabilities",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"updateRemoteRTPCapabilities"),FH.prototype),VB(FH.prototype,"connect",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"connect"),FH.prototype),VB(FH.prototype,"createDataChannels",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"createDataChannels"),FH.prototype),VB(FH.prototype,"receive",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"receive"),FH.prototype),VB(FH.prototype,"batchReceive",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"batchReceive"),FH.prototype),VB(FH.prototype,"stopReceiving",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"stopReceiving"),FH.prototype),VB(FH.prototype,"muteRemote",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"muteRemote"),FH.prototype),VB(FH.prototype,"unmuteRemote",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"unmuteRemote"),FH.prototype),VB(FH.prototype,"muteLocal",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"muteLocal"),FH.prototype),VB(FH.prototype,"unmuteLocal",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"unmuteLocal"),FH.prototype),VB(FH.prototype,"close",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"close"),FH.prototype),VB(FH.prototype,"updateEncoderConfig",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"updateEncoderConfig"),FH.prototype),VB(FH.prototype,"updateSendParameters",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"updateSendParameters"),FH.prototype),VB(FH.prototype,"replaceTrack",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"replaceTrack"),FH.prototype),VB(FH.prototype,"getRemoteSSRC",[BH],Object.getOwnPropertyDescriptor(FH.prototype,"getRemoteSSRC"),FH.prototype),FH);function BH(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,r=new Array(s),o=0;o<s;o++)r[o]=arguments[o];return await n.apply(this,r)}finally{i()}},i}const GH="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",jH="9",WH=2e4,HH=4e4;class KH{get localCapabilities(){return uN(this._localCapabilities)}get rtpCapabilities(){return uN(this._rtpCapabilities)}get candidates(){return uN(this._candidates)}get iceParameters(){return uN(this._iceParameters)}get dtlsParameters(){return uN(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=uN(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:r,localCapabilities:o,cname:a}=e,c=dW.parse(GH);this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o,this.setup=r,this.cname=a;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=r,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,JN("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=wW([{ssrcId:HH,rtx:JN("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,VW(e),JN("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=wW([{ssrcId:WH}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const t=dW.parse(GH);this._rtpCapabilities=e;const i=this.rtpCapabilities.send;for(const e of t.mediaDescriptions){if(e.attributes.iceUfrag=this._iceParameters.iceUfrag,e.attributes.icePwd=this._iceParameters.icePwd,e.attributes.fingerprints=this._dtlsParameters.fingerprints,e.attributes.candidates=this._candidates,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=i.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.videoCodecs,e.attributes.extmaps=i.videoExtensions,JN("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=wW([{ssrcId:HH,rtx:JN("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=i.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.audioCodecs,e.attributes.extmaps=i.audioExtensions,JN("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=wW([{ssrcId:WH}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let r=1;r<e;r++){const e=2*r+WH,o=2*r+HH,{ssrcs:a,ssrcGroups:c}=wW([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=wW([{ssrcId:o,rtx:JN("USE_SUB_RTX")?o+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:jH,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*r-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:jH,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*r)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return dW.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:r}=wW(t,this.cname,JN("SYNC_GROUP")?i:void 0),o=this.findPreloadMediaDesc(s);if(o){if(lO()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,o.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(o,n),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||dO()||hO()||pO()||0===t&&JN("USE_SUB_RTX")?(i=this.createOrRecycleSendMedia(e,s,r,"sendonly",n),this.updateBundleMids()):(i=uN(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=r,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),lO()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||lO()||dO()||hO()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>e.includes(t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){e===NG.TCP?this._candidates.forEach((e=>{-1===this._candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this._candidates.push(UB(UB({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=uN(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(lO()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(e,t,i,n,s,r){const o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=GW(o,a,this.localCapabilities.send,o===OG.VIDEO?n:s),d=o===OG.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let h={media:{mediaType:o,port:jH,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};h=this.mungRecvMediaDsec(h,e,r);const u=this.findFirstClosedMedia(o);if(u){const e=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[e]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(e,t,i){const n=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(eL).includes(e))))],s=new Set(t);if(n.every((e=>s.has(e))))return EL.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const r=this._rtpCapabilities.recv.videoCodecs.filter((e=>t.some((t=>(e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").includes(t)))));if(0===r.length)return EL.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(n," codecs: ").concat(t)),!1;const o=[...new Set(r.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")))];let a;if(EL.debug("updateRemoteCodec, from ".concat(n," to ").concat(o)),0===e.length)a=this.sessionDesc.mediaDescriptions.filter((e=>"video"===e.media.mediaType&&"recvonly"===e.attributes.direction));else if(a=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&e.includes(t.attributes.mid)&&"recvonly"===t.attributes.direction)),a.length!==e.length)return EL.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;this._rtpCapabilities.recv.videoCodecs=r;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=GW(OG.VIDEO,d,c,i);return a.forEach((e=>{const t=l.map((e=>e.payloadType.toString(10)));EL.debug("updateRemoteCodec mid: ".concat(e.attributes.mid,", from ").concat(e.attributes.payloads," to ").concat(l)),e.attributes.payloads=l,e.media.fmts=t})),!0}createOrRecycleSendMedia(e,t,i,n,s){const r=this.rtpCapabilities.send,o=e===OG.VIDEO?r.videoCodecs:r.audioCodecs,a=e===OG.VIDEO?r.videoExtensions:r.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:jH,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=uN(e);return OW(n),DW(n,t),NW(n,t),LW(n),PW(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=uN(e);return PW(i,t,this.localCapabilities.recv),VW(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>lO()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}var YH;let qH=(YH=class e extends DG{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let e;return this.localCapabilities&&(e=FW(this.localCapabilities)),[...new Set(e&&e.send.videoCodecs.map((e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"")).filter((e=>Object.keys(eL).includes(e))))]}constructor(e,t,i){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=JN("USE_XR"),this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.remoteCodecs=void 0,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new PN("NVExtentionsConnection-mutex"),this.rtcMedia=void 0,this.store=t,this.peerConnection=i,this.statsFilter=yW(this.peerConnection,JN("STATS_UPDATE_INTERVAL"),void 0,lO()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=IW(e.sdp),i=await MW({filterRTX:!JN("USE_PUB_RTX")&&!JN("USE_SUB_RTX"),filterVideoFec:JN("FILTER_VIDEO_FEC"),filterAudioFec:JN("FILTER_AUDIO_FEC"),filterVideoCodec:JN("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=i,this.initialOffer=e,UB(UB({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new eG(yO.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,r){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new KH({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:FW(this.localCapabilities),cname:r});const o=this.remoteSDP.toString(),a=dW.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&VW(c),this.useXR&&BW(a);const d=dW.print(a),l=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(e.toString()))}}async updateRemoteRTPCapabilities(e,t){if(this.remoteCodecs=t,this.remoteSDP)if(this.remoteSDP.updateRemoteCodec(e,t,this.store.codec)){const e=await this.peerConnection.createOffer(),t=this.logSDPExchange(e.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(e);const i=this.remoteSDP.toString();null==t||t(i),await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}else EL.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.");else EL.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(t))}async updateRemoteConnect(e){var t,i,n,s;null===(t=this.remoteSDP)||void 0===t||t.updateRemoteRTPCapabilities(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&(null===(s=this.remoteSDP)||void 0===s||s.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),null===(i=this.remoteSDP)||void 0===i||i.preloadRemoteMedia(2);const r=null===(n=this.remoteSDP)||void 0===n?void 0:n.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),EL.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,i){var n=this;return xB((function*(){const s=yield kB(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const r=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});r.push(t)})),lO()&&!0===JN("SIMULCAST")&&(yield kB(n.applySimulcastForFirefox(r,e)));const o=yield kB(n.peerConnection.createOffer()),a=n.remoteSDP.predictReceivingMids(e.length),c=n.mungSendOfferSDP(o.sdp,e,a),d=dW.parse(c),l=a.map((e=>{const t=d.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return AW(t,JN("USE_PUB_RTX"))}));let h;try{h=yield l}catch(s){h=[],n.remoteSDP.receive(e,t,i,h);const r=n.remoteSDP.toString();throw yield kB(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield kB(n.peerConnection.setRemoteDescription({type:"answer",sdp:r})),yield kB(n.stopSending(a,!0)),s}n.remoteSDP.receive(e,t,i,h);const u=n.remoteSDP.toString(),p=n.logSDPExchange(c,"offer","local","send");return yield kB(n.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield kB(n.applySimulcastEncodings(r,e)),yield kB(n.applySendEncodings(r,e)),null==p||p(u),yield kB(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),r.map(((e,t)=>{const i=a[t];return{localSSRC:l[t],id:i,transceiver:e}}))}catch(e){throw e instanceof eG?e:new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const n=await this.peerConnection.createOffer(),s=this.logSDPExchange(n.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);const r=this.remoteSDP.toString();null==s||s(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async createDataChannels(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(e);return i&&"open"===i.readyState?EL.debug("[P2PConnection] Channels are already available and can be reused directly."):(i=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:JN("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,i)),void t.forEach((e=>{e._updateOriginDataChannel(i)}))}catch(e){throw e instanceof eG?e:new eG(yO.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof eG?e:new eG(yO.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:s,needExchangeSDP:r}=this.remoteSDP.send(e,t,i,n);if(r){const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(n.sdp,s,e);null==i||i(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),EL.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else EL.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const o=this.peerConnection.getTransceivers().find((e=>e.mid===s));if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:s}}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:t,needExchangeSDP:i}=this.remoteSDP.batchSend(e);if(i){const e=this.remoteSDP.toString(),t=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();null==t||t(i.sdp||""),await this.peerConnection.setLocalDescription(i),EL.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else EL.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return t.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var t=this;return xB((function*(){const i=yield kB(t.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!t.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(nx().supportPCSetConfiguration){const i=t.peerConnection.getConfiguration(),n=e===NG.RELAY?"relay":"all";i.iceTransportPolicy!==n&&(EL.debug("restartICE change iceTransportPolicy from [".concat(i.iceTransportPolicy,"] to [").concat(n,"]")),i.iceTransportPolicy=n,t.peerConnection.setConfiguration(i))}else if(e===NG.RELAY)return;e!==NG.RELAY&&t.remoteSDP.updateCandidates(e);const n=yield kB(t.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=IW(n.sdp),{remoteIceParameters:r}=yield s.iceParameters;t.remoteSDP.restartICE(r);const o=t.remoteSDP.toString(),a=t.logSDPExchange(n.sdp||"","offer","local","restartICE");yield kB(t.peerConnection.setLocalDescription(n)),null==a||a(o),yield kB(t.peerConnection.setRemoteDescription({type:"answer",sdp:o}))}catch(e){EL.warning("restart ICE failed, abort operation",e)}finally{i()}}))()}close(){var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==r||r(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new eG(yO.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?lO()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if(null===(e=this.peerConnection.currentLocalDescription)||void 0===e||!e.sdp||!this.localCapabilities)throw new Error;return UB(UB({},IW(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,EL.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,EL.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),JN("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&($O(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),JN("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),JN("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(uj(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!JN("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(e,t){try{if(!nx().supportSetRtpSenderParameters)return;if(e.length!==t.length)return;for(let c=0;c<e.length;c++){const d=e[c],l=t[c];if(l&&l instanceof XV){var i,n;if(this.isVP8Simulcast(l))continue;const e={},t={};switch(l._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var s,r,o,a;if(null!==(i=l._encoderConfig)&&void 0!==i&&i.bitrateMax&&(t.maxBitrate=1e3*(null===(s=l._encoderConfig)||void 0===s?void 0:s.bitrateMax)),l._hints.includes(fx.LOW_STREAM)&&(null!==(r=l._encoderConfig)&&void 0!==r&&r.frameRate&&(t.maxFramerate=fj(l._encoderConfig.frameRate)),null!==(o=l._encoderConfig)&&void 0!==o&&o.scaleResolutionDownBy&&(null===(a=l._encoderConfig)||void 0===a?void 0:a.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=l._encoderConfig.scaleResolutionDownBy)),JN("DSCP_TYPE")&&SO()){const e=JN("DSCP_TYPE");["very-low","low","medium","high"].includes(e)&&(t.networkPriority=e)}const c=d.sender.getParameters(),h=null===(n=c.encodings)||void 0===n?void 0:n[0];lO()&&!h&&(e.encodings=[t]),h&&Object.assign(h,t),Object.assign(c,e),await d.sender.setParameters(c)}}}catch(e){EL.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,i){const n=dW.parse(e);return t.forEach(((e,t)=>{const s=i[t],r=n.mediaDescriptions.find((e=>e.attributes.mid===s));r&&(DW(r,e),kW(r,e,this.store.codec))})),dW.print(n)}mungReceiveAnswerSDP(e,t,i){const n=dW.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&i===OG.AUDIO&&"audio"===s.media.mediaType&&VW(s),this.useXR&&BW(n),dW.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let o=0;o<e.length;o++){var i,n,s,r;const a=e[o],c=t[o];if(c instanceof XV&&!c._hints.includes(fx.LOW_STREAM)&&null!==(i=c._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=c._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=c._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(r=c._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(c._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=a.sender.getParameters();await a.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!lO()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof XV&&this.isVP8Simulcast(n)){const t=e[i],s={},r={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:r.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:r.medium,scaleResolutionDownBy:4}];const o=t.sender.getParameters();await t.sender.setParameters(Object.assign(o,s))}}}isVP8Simulcast(e){var t,i,n,s;return!!(e instanceof XV&&JN("SIMULCAST")&&"vp8"===this.store.codec&&!e._hints.includes(fx.LOW_STREAM)&&null!==(t=e._encoderConfig)&&void 0!==t&&t.bitrateMax&&(null===(i=e._encoderConfig)||void 0===i?void 0:i.bitrateMax)>200&&null!==(n=e._scalabilityMode)&&void 0!==n&&n.numSpatialLayers&&(null===(s=e._scalabilityMode)||void 0===s?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,t,i,n){if(JN("SDP_LOGGING"))return EL.upload("exchanging ".concat(i," ").concat(t," SDP during NVExtentionsConnection.").concat(n,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",n)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(nx().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},VB(YH.prototype,"connect",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"connect"),YH.prototype),VB(YH.prototype,"updateRemoteRTPCapabilities",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"updateRemoteRTPCapabilities"),YH.prototype),VB(YH.prototype,"updateRemoteConnect",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"updateRemoteConnect"),YH.prototype),VB(YH.prototype,"createDataChannels",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"createDataChannels"),YH.prototype),VB(YH.prototype,"receive",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"receive"),YH.prototype),VB(YH.prototype,"batchReceive",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"batchReceive"),YH.prototype),VB(YH.prototype,"stopReceiving",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"stopReceiving"),YH.prototype),VB(YH.prototype,"muteRemote",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"muteRemote"),YH.prototype),VB(YH.prototype,"unmuteRemote",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"unmuteRemote"),YH.prototype),VB(YH.prototype,"muteLocal",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"muteLocal"),YH.prototype),VB(YH.prototype,"unmuteLocal",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"unmuteLocal"),YH.prototype),VB(YH.prototype,"close",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"close"),YH.prototype),VB(YH.prototype,"updateEncoderConfig",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"updateEncoderConfig"),YH.prototype),VB(YH.prototype,"updateSendParameters",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"updateSendParameters"),YH.prototype),VB(YH.prototype,"replaceTrack",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"replaceTrack"),YH.prototype),VB(YH.prototype,"getRemoteSSRC",[$H],Object.getOwnPropertyDescriptor(YH.prototype,"getRemoteSSRC"),YH.prototype),YH);function $H(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From NVExtentionsConnection.".concat(t));try{for(var s=arguments.length,r=new Array(s),o=0;o<s;o++)r[o]=arguments[o];return await n.apply(this,r)}finally{i()}},i}var zH;let XH=(zH=class e extends DG{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.cname=void 0,this.mutex=new PN("DataChannelConnection-mutex"),this.dataChannel=void 0,this._p2pConnection=void 0,this.establishPromise=void 0,this._nvMedia=void 0,this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new qH(t,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const t=null===(e=this._nvMedia)||void 0===e?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,i,n,s,r){return this.cname=r,await this._p2pConnection.connect(e,t,i,n,s,r),await new Promise(((e,t)=>{const n=setTimeout((()=>{this.closeSignal(),t(new eG(yO.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(n),void e()},this.dataChannel.onerror=e=>{this.closeSignal(),t(e)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(e,t){return this._p2pConnection.updateRemoteRTPCapabilities(e,t)}send(e,t,i){var n=this;return xB((function*(){const s=yield kB(n.mutex.lock("From DataChannelConnection.send"));try{return yield*NB(LB(n._p2pConnection.send(e,t,i)))}finally{s()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,t,i,n){return this._nvMedia?(EL.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,t,this.cname)):(EL.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,t,i,n))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return xB((function*(){return yield*NB(LB(t._p2pConnection.restartICE(e)))}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,t,i,n){if(JN("SDP_LOGGING"))return EL.upload("exchanging ".concat(i," ").concat(t," SDP during DataChannelConnection.").concat(n,"\n"),e),"offer"===t?e=>{this.logSDPExchange(e,"answer","local"===i?"remote":"local",n)}:void 0}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&($O(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),JN("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),JN("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(uj(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!JN("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,i)=>{var n;return null===(n=this.onFirstVideoDecoded)||void 0===n?void 0:n.call(this,e,t,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedLocalCandidateChanged)||void 0===i?void 0:i.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i?void 0:i.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}},VB(zH.prototype,"connect",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"connect"),zH.prototype),VB(zH.prototype,"updateRemoteRTPCapabilities",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"updateRemoteRTPCapabilities"),zH.prototype),VB(zH.prototype,"createDataChannels",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"createDataChannels"),zH.prototype),VB(zH.prototype,"receive",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"receive"),zH.prototype),VB(zH.prototype,"stopReceiving",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"stopReceiving"),zH.prototype),VB(zH.prototype,"muteRemote",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"muteRemote"),zH.prototype),VB(zH.prototype,"unmuteRemote",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"unmuteRemote"),zH.prototype),VB(zH.prototype,"muteLocal",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"muteLocal"),zH.prototype),VB(zH.prototype,"unmuteLocal",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"unmuteLocal"),zH.prototype),VB(zH.prototype,"close",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"close"),zH.prototype),VB(zH.prototype,"updateEncoderConfig",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"updateEncoderConfig"),zH.prototype),VB(zH.prototype,"updateSendParameters",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"updateSendParameters"),zH.prototype),VB(zH.prototype,"replaceTrack",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"replaceTrack"),zH.prototype),VB(zH.prototype,"getRemoteSSRC",[JH],Object.getOwnPropertyDescriptor(zH.prototype,"getRemoteSSRC"),zH.prototype),zH);function JH(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From DataChannelConnection.".concat(t));try{for(var s=arguments.length,r=new Array(s),o=0;o<s;o++)r[o]=arguments[o];return await n.apply(this,r)}finally{i()}},i}var QH;let ZH=(VB((QH=class extends GO{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(MG.StateChange,t,this._state)}constructor(e,t){super(),this.store=void 0,this.statsUploader=void 0,this.connection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.remoteDataChannelMap=new Map,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.statsCollector=void 0,this.isPlanB=!1,this.shouldForwardP2PCreation=void 0,this.iceFailedCount=0,this.dtlsFailedCount=0,this.mutex=new PN("P2PChannel-mutex"),this._state=kG.Disconnected,this._pcStatsUploadType=JN("NEW_ICE_RESTART")?LG.FIRST_CONNECTION:LG.OLD_FIRST_CONNECTION,this._isInRestartIce=!1,this._isStartRestartIce=!1,this._restartStates=["disconnected","failed"],this._restartTimer=void 0,this._isFirstConnected=!0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==kG.Connected)return void i(new CO(yO.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(e);if(0===s.length)return void t();const r=s.find((e=>"videoLowTrack"===e[0]));r&&r[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createMuteMessage(s);await iN(this,MG.RequestMuteLocal,o),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==kG.Connected)return void i(new CO(yO.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(e);if(0===s.length)return void t();const r=s.find((e=>"videoLowTrack"===e[0]));if(r){const t=r[1];if(t.track._originMediaStreamTrack.stop(),!JN("DISABLE_DUAL_STREAM_USE_ENCODING")&&nx().supportDualStreamEncoding){const i=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}else{const i=qW(e,sN(this,MG.RequestLowStreamParameter));t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}await this.connection.unmuteLocal(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(s);await iN(this,MG.RequestUnmuteLocal,o),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(PG.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==kG.Connected)return void t();const{id:s,track:r}=i;await this.connection.updateSendParameters(s,r),await this.connection.updateEncoderConfig(s,r),this.emit(MG.UpdateVideoEncoder,r),t()}catch(e){i(e)}finally{n()}},this.handleSetOptimizationMode=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const i=this.localTrackMap.get(PG.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==kG.Connected)return;const{id:s,track:r}=i;await this.connection.updateSendParameters(s,r),t()}catch(e){i(e)}finally{n()}},this.handleReplaceMixingTrack=async(e,t,i,n)=>{if(!this.connection||this.state!==kG.Connected)return void t();const s=uH([e]);let r;EL.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(s.getTrackId(),"]")),"boolean"==typeof n&&n||(r=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(e,s),t()}catch(e){i(e)}finally{var o;null===(o=r)||void 0===o||o()}},this.handleReplaceTrack=async(e,t,i,n)=>{let s;EL.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof n&&n||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var r;const i=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.connection||!i||this.state!==kG.Connected)return void t();if(await(null===(r=this.connection)||void 0===r?void 0:r.replaceTrack(e,i[1].id)),this.isPlanB){const t=i[1];t.id=e._mediaStreamTrack.id,this.localTrackMap.set(i[0],t)}if(i[0]===PG.LocalVideoTrack&&!JN("DISABLE_DUAL_STREAM_USE_ENCODING")&&nx().supportDualStreamEncoding){const t=this.localTrackMap.get(PG.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}t()}catch(e){i(e)}finally{var o;null===(o=s)||void 0===o||o()}},this.handleGetRTCStats=e=>{e(this.statsCollector.getRTCStats())},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new aH(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!nx().supportUnifiedPlan||JN("CHROME_FORCE_PLAN_B")&&SO(),this.shouldForwardP2PCreation=JN("FORWARD_P2P_CREATION")&&nx().supportPCSetConfiguration&&function(){const e=rO();return e===ZD.ANDROID||e===ZD.IOS||e===ZD.HARMONY_OS}(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new XH({},this.store):this.isPlanB?new MH({},this.store):new VH({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var i;this.state=kG.New;const n=this.shouldForwardP2PCreation&&"closed"===(null===(i=this.connection)||void 0===i?void 0:i.peerConnectionState);if(this.shouldForwardP2PCreation&&!n||(n&&this.connection&&(EL.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new XH(e,this.store):this.isPlanB?new MH(e,this.store):new VH(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new CO(yO.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=JN("NEW_ICE_RESTART")?LG.FIRST_CONNECTION:LG.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,i,n,s,r){if(!this.connection)throw new CO(yO.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof XH?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(e,t,i,n,s,r),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kG.Connected)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return[PG.LocalVideoLowTrack,PG.LocalVideoTrack].includes(t)})),i=t.map((e=>{let[,{id:t}]=e;return t})),n=t.map((e=>{let[t]=e;return t}));if(this.connection instanceof VH){if(CL.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(n),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!e.includes(this.store.codec)){const t=["vp8","h264"].find((t=>e.includes(t)));t&&(this.store.codec=t,EL.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(t,".")))}this.connection.updateRemoteRTPCapabilities(i,e)}}async preConnect(e,t,i,n,s,r){if(!this.connection)throw new CO(yO.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const o=await this.connection.connect(e,t,i,n,s,r);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=kG.Connected,o}getEstablishParams(){if(this.connection instanceof XH)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection||this.state!==kG.Connected){if(this.state===kG.Disconnected)throw new CO(yO.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void e.forEach((e=>{this.pendingLocalDataChannels.includes(e)||this.pendingLocalDataChannels.push(e)}))}const t=this.filterTobePublishedDataChannels(e);0!==t.length&&(t.forEach((e=>{const t=Date.now();this.store.publish(e.id.toString(),"datachannel",t)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((e=>{this.localDataChannels.push(e);const t=Date.now();this.store.publish(e.id+"","datachannel",void 0,t)})))}publish(e,t,i){var n=this;return xB((function*(){const s=yield kB(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==kG.Connected){if(n.state===kG.Disconnected)throw new CO(yO.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,cW.markPublishStart(n.store.clientId,n.store.pubId);const r=n.filterTobePublishedTracks(e,t,i);if(0===r.length)return void(yield kB(n.tryToUnmuteAudio(e)));yield*NB(LB(n.doPublish(n.connection,r)))}finally{s()}}))()}doPublish(e,t){var i=this;return xB((function*(){t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===PG.LocalAudioTrack?"audio":"video",s)})),i.bindLocalTrackEvents(t);const n=t.map((e=>{let{track:t}=e;return t})),s=yield kB(e.send(t.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),r=(yield kB(s.next())).value,o=i.createGatewayPublishMessage(t,r);let a;try{a=yield o}catch(e){throw s.throw(e),(null==e?void 0:e.code)===yO.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(t),e}const c=i.mapPubResToRemoteConfig(o,a),d=(yield kB(s.next(c))).value,l=JN("ENABLE_VIDEO_SEI");n.forEach((async e=>{const t=e.getRTCRtpTransceiver();t&&l&&(e.trackMediaType===OG.VIDEO?await vB(t.sender,e):e.trackMediaType===OG.AUDIO&&await async function(e){if(!nx().supportWebRTCEncodedTransform)return void EL.warning("browser not support audio encoded transform");if(gB.has(e))return;if(!e.track)return;const t={track:e.track};if(cO()){if(!e.createEncodedStreams)return void EL.warning("browser not support createEncodedStreams() API");let n=null;try{n=e.createEncodedStreams()}catch(e){return void EL.error("create audio-encoded-streams error",e&&e.message)}const s=new TransformStream({transform(n,s){t.controller||(t.controller=s),e.track&&e.track.id!==t.track.id&&(EL.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",i),t.track=e.track,t.track.addEventListener("ended",i)),s.enqueue(n)}});n.readable.pipeThrough(s).pipeTo(n.writable)}else if(dO()){if("undefined"==typeof RTCRtpScriptTransform)return void EL.warning("browser not support RTCRtpScriptTransform");const n=_B(),s=new MessageChannel;await new Promise((e=>n.onmessage=t=>{"registered"===t.data&&e(void 0)}));const r=new RTCRtpScriptTransform(n,{name:"tx",port:s.port2},[s.port2]);e.transform=r,await new Promise((e=>n.onmessage=t=>{"started"===t.data&&e(void 0)})),s.port1.onmessage=n=>{var s;n.data.transformed&&e.track&&(null===(s=e.track)||void 0===s?void 0:s.id)!==t.track.id&&(EL.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",i),t.track=e.track,t.track.addEventListener("ended",i))},t.worker=n}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}const t=gB.get(e);if(t){gB.delete(e);try{var n,s;null===(n=t.controller)||void 0===n||n.terminate(),null===(s=t.worker)||void 0===s||s.terminate()}catch(e){EL.warning(e&&e.message)}}}gB.set(e,t),e.track.addEventListener("ended",i)}(t.sender))})),t.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.assignLocalTracks(t,d),i.statsUploader.startUploadOutboundStats(),t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===PG.LocalAudioTrack?"audio":"video",void 0,s)}))}))()}async updateVideoStreamParameter(e,t){const i=this.localTrackMap.get(t);if(!i)return;if(!(i.track instanceof XV))return EL.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof VH||this.connection instanceof MH))return EL.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:n}=i,s=function(e,t){const i={};return e.height&&e.width&&(i.scaleResolutionDownBy=Tj(e,t)),i.maxFramerate=e.framerate?fj(e.framerate):void 0,i.maxBitrate=e.bitrate?1e3*e.bitrate:void 0,i}(e,n);if(n._encoderConfig||(n._encoderConfig={}),t!==PG.LocalVideoLowTrack||!JN("DISABLE_DUAL_STREAM_USE_ENCODING")&&nx().supportDualStreamEncoding)null!=s.scaleResolutionDownBy&&(n._encoderConfig.scaleResolutionDownBy=s.scaleResolutionDownBy);else{const t=n._originMediaStreamTrack;if(!t.canvas)return EL.warn("[".concat(n.getTrackId(),"] no canvas on track"));!function(e,t){const i=e.canvas;t.width&&(i.width=fj(t.width)),t.height&&(i.height=fj(t.height)),t.framerate&&(i.stopCapture&&i.stopCapture(),i.stopCapture=Kx((()=>{!i.startCapture&&i.stopCapture&&i.stopCapture(),i.startCapture&&i.startCapture()}),fj(t.framerate)))}(t,e)}null!=s.maxBitrate&&(n._encoderConfig.bitrateMax=s.maxBitrate/1e3),null!=s.maxFramerate&&(n._encoderConfig.frameRate&&"object"==typeof n._encoderConfig.frameRate?n._encoderConfig.frameRate.max=s.maxFramerate:n._encoderConfig.frameRate={max:s.maxFramerate}),EL.debug("[".concat(n.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(n._encoderConfig))),await this.connection.updateRtpSenderEncodings(n)}publishLowStream(e){var t=this;return xB((function*(){if(!t.connection||t.state!==kG.Connected)return;const i=yield kB(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const s=t.localTrackMap.get(PG.LocalVideoTrack);if(!s)throw new CO(yO.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(PG.LocalVideoLowTrack))throw new CO(yO.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const r=[{track:t.getLowVideoTrack(s.track,e),type:PG.LocalVideoLowTrack}];if(yield*NB(LB(t.doPublish(t.connection,r))),s.track.muted||!s.track.enabled){var n;const e=null===(n=t.localTrackMap.get(PG.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==e&&(yield kB(t.connection.muteLocal([e])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&(EL.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await tN(this,MG.RequestRePublish,this.pendingLocalTracks),this.emit(MG.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(EL.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await tN(this,MG.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:t,kind:i}=this.pendingRemoteTracks[e];(i!==OG.AUDIO||t._audio_added_&&t._audioSSRC)&&(i!==OG.VIDEO||t._video_added_&&t._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(e)await tN(this,MG.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:t}of this.pendingRemoteTracks)await this.subscribe(e,t,t===OG.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(MG.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==kG.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));return i&&i[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==kG.Connected)return void e.forEach((e=>{const t=this.pendingLocalDataChannels.indexOf(e);-1!==t&&this.pendingLocalDataChannels.splice(t,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return 0!==t.length?(t.forEach((e=>{const t=this.localDataChannels.indexOf(e);-1!==t&&this.localDataChannels.splice(t,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),t.map((e=>e.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==kG.Connected)return;const e=this.localTrackMap.get(PG.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[PG.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadOutboundStats(),i}async subscribeDataChannel(e,t){if(!this.connection||this.state!==kG.Connected)throw new CO(yO.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=t.filter((t=>{var i;return!(null!==(i=this.remoteDataChannelMap.get(e))&&void 0!==i&&i.get(t.id))}));if(0!==i.length)return await this.connection.createDataChannels(e.uid,i),i.forEach((t=>{var i;this.remoteDataChannelMap.has(e)?null===(i=this.remoteDataChannelMap.get(e))||void 0===i||i.set(t.id,t):this.remoteDataChannelMap.set(e,new Map([[t.id,t]]));const n=this.pendingRemoteDataChannels.findIndex((i=>{let{user:n,id:s}=i;return n.uid===e.uid&&s===t.id}));-1!==n&&this.pendingRemoteDataChannels.splice(n,1)})),i.map((e=>e.id))}async subscribe(e,t,i,n,s){var r;if(!this.connection||this.state!==kG.Connected)throw new CO(yO.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(r=this.remoteUserMap.get(e))&&void 0!==r&&r.has(t))return;let o,a,c;if(s){const i=s.find((e=>{let{stream_type:i}=e;return i===t}));if(!i)throw new CO(yO.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const n=await this.connection.receive(t,i.ssrcs,String(e._uintid),i.attributes);this.connection instanceof VH&&(c=n.transceiver),o=n.track,a=n.id}else{const s=await this.connection.receive(t,[{ssrcId:i,rtx:n}],String(e._uintid),void 0);this.connection instanceof VH&&(c=s.transceiver),o=s.track,a=s.id}t===OG.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new hB(o,e.uid,e._uintid,this.store),EL.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new lB(o,e.uid,e._uintid,this.store),EL.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack)),JN("ENABLE_VIDEO_SEI")&&c&&(t==OG.VIDEO?await yB(c.receiver,{onSei:t=>{var i;null===(i=e._videoTrack)||void 0===i||i._onSei(t)}}):t==OG.AUDIO&&await async function(e){if(!nx().supportWebRTCEncodedTransform)return void EL.warning("browser not support audio encoded transform");if(TB.has(e))return;const t={track:e.track};if(cO()){if(!e.createEncodedStreams)return void EL.warning("browser not support createEncodedStreams() API");let n=null;try{n=e.createEncodedStreams()}catch(e){return void EL.error("create audio-encoded-streams error",e&&e.message)}const s=new TransformStream({transform(n,s){t.controller||(t.controller=s),e.track&&e.track.id!==t.track.id&&(EL.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",i),t.track=e.track,t.track.addEventListener("ended",i)),s.enqueue(n)}});n.readable.pipeThrough(s).pipeTo(n.writable)}else if(dO()){if("undefined"==typeof RTCRtpScriptTransform)return void EL.warning("browser not support RTCRtpScriptTransform");const n=_B(),s=new MessageChannel;await new Promise((e=>n.onmessage=t=>{"registered"===t.data&&e(void 0)}));const r=new RTCRtpScriptTransform(n,{name:"rx",port:s.port2},[s.port2]);e.transform=r,await new Promise((e=>n.onmessage=t=>{"started"===t.data&&e(void 0)})),s.port1.onmessage=n=>{var s;n.data.transformed&&e.track&&(null===(s=e.track)||void 0===s?void 0:s.id)!==t.track.id&&(EL.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",i),t.track=e.track,t.track.addEventListener("ended",i))},t.worker=n}function i(){e.track.removeEventListener("ended",i),function(e){const t=TB.get(e);if(t){TB.delete(e);try{var i,n;null===(i=t.controller)||void 0===i||i.terminate(),null===(n=t.worker)||void 0===n||n.terminate()}catch(e){EL.warning(e&&e.message)}}}(e)}TB.set(e,t),e.track.addEventListener("ended",i)}(c.receiver));const d=this.remoteUserMap.get(e);d?d.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const l=this.pendingRemoteTracks.findIndex((i=>{let{user:n,kind:s}=i;return n.uid===e.uid&&t===s}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(MG.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==kG.Connected)throw new CO(yO.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((e=>{var t;let{user:i,mediaType:n}=e;return!(null!==(t=this.remoteUserMap.get(i))&&void 0!==t&&t.has(n))}));const t=await this.connection.batchReceive(e.map((e=>{let{user:t,mediaType:i,ssrcId:n,rtxSsrcId:s}=e;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:s}],mslabel:String(t._uintid)}})));e.forEach(((e,i)=>{let{user:n,mediaType:s}=e;const{track:r,id:o,transceiver:a}=t[i];s===OG.AUDIO?(n._audioTrack?n._audioTrack._updateOriginMediaStreamTrack(r):(n._audioTrack=new hB(r,n.uid,n._uintid,this.store),EL.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(n._audioTrack.getTrackId()))),a&&n._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(n,n._audioTrack)):(n._videoTrack?n._videoTrack._updateOriginMediaStreamTrack(r):(n._videoTrack=new lB(r,n.uid,n._uintid,this.store),EL.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(n._videoTrack.getTrackId()))),a&&n._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(n,n._videoTrack));const c=this.remoteUserMap.get(n);c?c.set(s,o):this.remoteUserMap.set(n,new Map([[s,o]])),this.statsCollector.addRemoteStats(n.uid),this.statsUploader.startUploadInboundStats();const d=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:i}=e;return t.uid===n.uid&&s===i}));-1!==d&&(this.pendingRemoteTracks.splice(d,1),this.emit(MG.MediaReconnectEnd,n.uid))}))}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===kG.Connected||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===OG.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===OG.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==kG.Connected)return;const s=this.filterTobeUnSubscribedTracks(e,t);if(0===s.length)return;await this.connection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t})));const r=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),s.forEach((e=>{let[t,{kind:n}]=e;var s,r;if(n===OG.VIDEO&&t._videoSSRC&&(null===(s=this.connection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),n===OG.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(r=t._videoTrack)||void 0===r||r._destroy(),t._videoTrack=void 0);else if(n===OG.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),i||(null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0)}})),r}async unsubscribeDataChannel(e,t){if(t.forEach((e=>{const t=this.pendingRemoteDataChannels.findIndex((t=>t.id===e.id));-1!==t&&this.pendingRemoteDataChannels.splice(t,1)})),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(e,t);if(0===i.length)return;t.forEach((e=>{e._close()}));const n=this.remoteDataChannelMap.get(e);return i.forEach((e=>{n&&n.delete(e.id)})),n&&0===n.size&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),i.map((e=>e.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:i,mediaType:n}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:s}=e;return void 0!==n?t.uid===i.uid&&n===s:t.uid===i.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==kG.Connected)return void t.forEach((e=>{let{user:t,kind:i}=e;var n;if(i===OG.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===OG.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}}));const i=e.reduce(((e,t)=>{let{user:i,mediaType:n}=t;const s=this.filterTobeUnSubscribedTracks(i,n);return e.concat(s)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((e=>{let[,{id:t}]=e;return t})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadInboundStats(),i.forEach((e=>{let[t,{kind:i}]=e;var n,s;if(i===OG.VIDEO&&t._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(t._videoSSRC,!1)),i===OG.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0;else if(i===OG.AUDIO){var r;this.unbindRemoteTrackEvents(t._audioTrack),null===(r=t._audioTrack)||void 0===r||r._destroy(),t._audioTrack=void 0}})),n}async muteRemote(e,t){if(!this.connection)return;const i=this.remoteUserMap.get(e);if(!i)return void EL.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!i.get(t))return void EL.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const n=t===OG.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==n&&this.connection.setStatsRemoteVideoIsReady(n,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const i=this.remoteUserMap.get(e);i?i.get(t)||EL.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,".")):EL.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."))}getAllTracks(e){const t=this.localTrackMap.get(PG.LocalAudioTrack);if((null==t?void 0:t.track)instanceof oV){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==PG.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===PG.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===PG.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,i,n,s){if(e){const i=this.localTrackMap.get(PG.LocalAudioTrack),r=n?this.localTrackMap.get(PG.LocalVideoLowTrack):this.localTrackMap.get(PG.LocalVideoTrack);CL.publish(this.store.sessionId,{eventElapse:cW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==i?void 0:i.track.getTrackLabel(),videoName:null==r?void 0:r.track.getTrackLabel(),screenshare:-1!==(null==r?void 0:r.track._hints.indexOf(fx.SCREEN_TRACK)),audio:!!i,video:!!r,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}else{var r;i||(i=[]);const o=i.find((e=>e instanceof sV)),a=n?null===(r=this.localTrackMap.get(PG.LocalVideoTrack))||void 0===r?void 0:r.track:i.find((e=>e instanceof XV));CL.publish(this.store.sessionId,{eventElapse:cW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==o?void 0:o.getTrackLabel(),videoName:null==a?void 0:a.getTrackLabel(),screenshare:-1!==(null==a?void 0:a._hints.indexOf(fx.SCREEN_TRACK)),audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:s})}}reportSubscribeEvent(e,t,i,n){const s=n===OG.VIDEO?i._videoSSRC:i._audioSSRC;s&&CL.subscribe(this.store.sessionId,{succ:e,ec:t,video:n===OG.VIDEO,audio:n===OG.AUDIO,peerid:i.uid,subscribeRequestid:n===OG.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:cW.measureFromSubscribeStart(this.store.clientId,s)})}reset(){EL.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new PN("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new XH({},this.store):this.isPlanB?new MH({},this.store):new VH({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(PG.LocalAudioTrack);if((null==e?void 0:e.track)instanceof oV){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=kG.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(PG.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(PG.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof XV||t&&t.track instanceof sV?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find((t=>t.uid===e));return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(PG.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort(((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(EL.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=kG.Reconnecting,JN("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new XH({},this.store):this.isPlanB?new MH({},this.store):new VH({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;switch(t){case PG.LocalVideoTrack:i._hints.includes(fx.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case PG.LocalAudioTrack:i instanceof oV?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case PG.LocalVideoLowTrack:}})),this.emit(MG.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(MG.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,i]=e;Array.from(i.keys()).forEach((e=>{this.setPendingRemoteDataChannel(t,e)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),EL.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const i of this.pendingRemoteDataChannels){const{user:n,id:s}=i;if((e instanceof cH?e.uid:e)===n.uid&&s===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof cH?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return xB((function*(){if(!t.connection||t.state!==kG.Connected||t.connection instanceof XH)return;const i=yield kB(t.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield kB(t.connection.restartICE(e));const s=yield kB(n.next());if(s.done)return;const r=s.value,o=yield r;switch(t.reportPCDisconnectedOrFailed(e),e){case NG.TCP:t._pcStatsUploadType=LG.TCP_RESTART;break;case NG.RELAY:t._pcStatsUploadType=LG.RELAY_RESTART;break;default:t._pcStatsUploadType=LG.OLD_RESTART}t._isInRestartIce=!0,n.next(o)}catch(e){var s;null===(s=n)||void 0===s||s.throw(e)}finally{i()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(PG.LocalVideoTrack),i=this.localTrackMap.get(PG.LocalAudioTrack),n=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),s=e.audioSend.find((e=>e.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!s)return 1;const r=nN(this,MG.NeedSignalRTT),o=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&r?(c+r)/2:c||r)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(fx.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return AB[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,r=n._videoSSRC,o=e.audioRecv.find((e=>e.ssrc===s)),a=e.videoRecv.find((e=>e.ssrc===r));if(!o&&!a)return void(t+=1);const c=nN(this,MG.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=o?o.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}async replaceTrack(e,t){var i;if(EL.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==kG.Connected)return;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!n)return;const s=n[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:s}]),this.bindLocalTrackEvents([{track:t,type:s}]),n[1].track=t),await(null===(i=this.connection)||void 0===i?void 0:i.replaceTrack(t,n[1].id)),this.isPlanB){const e=n[1];e.id=t._mediaStreamTrack.id,this.localTrackMap.set(s,e)}if(s===PG.LocalVideoTrack&&!JN("DISABLE_DUAL_STREAM_USE_ENCODING")&&nx().supportDualStreamEncoding){const t=this.localTrackMap.get(PG.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new Promise(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}}filterTobePublishedTracks(e,t,i){const n=[],s=this.getAllTracks();e=lN(e=e.filter((e=>-1===s.indexOf(e))));let r,o=!1;const a=this.localTrackMap.get(PG.LocalAudioTrack);for(const s of e){if(s instanceof XV&&(this.localTrackMap.has(PG.LocalVideoTrack)||o?new CO(yO.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:s,type:PG.LocalVideoTrack}),o=!0),t)){const e=this.getLowVideoTrack(s,i);n.push({track:e,type:PG.LocalVideoLowTrack})}if(s instanceof sV)if(a){const e=a.track;if(e instanceof oV)hH([s]),e.addAudioTrack(s),this.bindLocalAudioTrackEvents(s,!0);else{const t=uH([e,s]);EL.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(t.getTrackId(),"]")),this.replaceTrack(e,t)}}else r instanceof oV?(hH([s]),r.addAudioTrack(s)):r=r||!s._useAudioElement&&nx().webAudioMediaStreamDest&&!s._bypassWebAudio?uH(r?[s,r]:[s]):s}return r&&(EL.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(r.getTrackId(),"]")),n.push({track:r,type:PG.LocalAudioTrack})),n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=lN(e=e.filter((e=>-1!==i.indexOf(e))));for(const i of e){if(i instanceof sV){const e=this.localTrackMap.get(PG.LocalAudioTrack);if(!e)continue;e.track instanceof oV?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([PG.LocalAudioTrack,e]),e.track.close())):t.push([PG.LocalAudioTrack,e])}if(i instanceof XV){const e=this.localTrackMap.get(PG.LocalVideoTrack);if(!e)continue;t.push([PG.LocalVideoTrack,e]);const i=this.localTrackMap.get(PG.LocalVideoLowTrack);i&&t.push([PG.LocalVideoLowTrack,i])}}return t}filterTobePublishedDataChannels(e){return(e=lN(e)).filter((e=>-1===this.localDataChannels.findIndex((t=>t.id===e.id))))}filterTobeUnpublishedDataChannels(e){return(e=(e=lN(e)).filter((e=>-1!==this.localDataChannels.indexOf(e)))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case PG.LocalVideoTrack:t.addListener(px.GET_STATS,this.handleGetLocalVideoStats),t.addListener(px.GET_RTC_STATS,this.handleGetRTCStats),t.addListener(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(px.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(px.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(px.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case PG.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case PG.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof oV?e.trackList.forEach((e=>{e.addListener(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(px.GET_STATS,this.handleGetLocalAudioStats),e.addListener(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(px.GET_STATS,this.handleGetLocalAudioStats),e.addListener(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(px.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(px.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case PG.LocalVideoTrack:t.off(px.GET_STATS,this.handleGetLocalVideoStats),t.off(px.GET_RTC_STATS,this.handleGetRTCStats),t.off(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(px.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(px.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(px.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case PG.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case PG.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof oV?e.trackList.forEach((e=>{e.off(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(px.GET_STATS,this.handleGetLocalAudioStats),e.off(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(px.GET_STATS,this.handleGetLocalAudioStats),e.off(px.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(px.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(px.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(px.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(px.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(px.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof lB&&t.addListener(px.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof hB&&t.addListener(px.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(px.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(OG.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(OG.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{let n,s,{track:r,type:o}=e;switch(o){case PG.LocalAudioTrack:n=gG.Audio,s={dtx:r instanceof rV&&r._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case PG.LocalVideoTrack:n=r._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High,s=UB(UB({},mj(r)),{},{codec:this.store.codec});break;case PG.LocalVideoLowTrack:n=gG.Low,s=UB(UB({},mj(r)),{},{codec:this.store.codec})}return{stream_type:n,attributes:s,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:r}]=e;switch(i){case PG.LocalVideoTrack:t=n._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High;break;case PG.LocalAudioTrack:t=gG.Audio;break;case PG.LocalVideoLowTrack:t=gG.Low}return{stream_type:t,ssrcs:s,mid:r}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(MG.PeerConnectionStateChange,t),"connected"!==t||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===t&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),JN("NEW_ICE_RESTART")){if(this._restartStates.includes(t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const t=t=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(EL.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(t)),"CONNECTED"===nN(this,MG.QueryClientConnectionState)&&this.emit(MG.RequestRestartICE,t))},i=()=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),EL.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(MG.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},n=JN("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(JN("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&nx().supportPCSetConfiguration)t(NG.RELAY),this._restartTimer=window.setTimeout(i,n);else if(lO())t(NG.UDP),this._restartTimer=window.setTimeout(i,4e3);else{if(t(NG.TCP),nx().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{t(NG.RELAY),this._restartTimer=window.setTimeout(i,n)}),n));this._restartTimer=window.setTimeout(i,n)}}),800))}}else{if("disconnected"===t&&"disconnected"===e.iceConnectionState)return setTimeout((()=>{"disconnected"===e.iceConnectionState&&JN("ICE_RESTART")&&"CONNECTED"===nN(this,MG.QueryClientConnectionState)&&this.emit(MG.RequestRestartICE)}),800),void setTimeout((()=>{"disconnected"===e.peerConnectionState&&(EL.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(MG.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===t&&(EL.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(MG.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),CL.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:KO.TRACER}).onSuccess(),this.emit(MG.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));var i;t&&(this.store.subscribe(t.uid,"audio",void 0,void 0,void 0,Date.now()),null===(i=t.audioTrack)||void 0===i||i.emit(gx.FIRST_FRAME_DECODED),CL.firstRemoteFrame(this.store.sessionId,SL.FIRST_AUDIO_DECODE,vL.FIRST_AUDIO_DECODE,{peer:t._uintid,subscribeElapse:cW.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._audioSSRC===e));t&&CL.firstRemoteFrame(this.store.sessionId,SL.FIRST_AUDIO_RECEIVED,vL.FIRST_AUDIO_RECEIVED,{peer:t._uintid,subscribeElapse:cW.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{const t=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));t&&CL.firstRemoteFrame(this.store.sessionId,SL.FIRST_VIDEO_RECEIVED,vL.FIRST_VIDEO_RECEIVED,{peer:t._uintid,subscribeElapse:cW.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,t)=>{const i="relay"===e.candidateType,n="relay"===t.candidateType;"unknown"!==t.candidateType&&i===n||this.emit(MG.ConnectionTypeChange,i),EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Sj(t))," -> ").concat(JSON.stringify(Sj(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,t)=>{EL.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Sj(t))," -> ").concat(JSON.stringify(Sj(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(PG.LocalAudioTrack);if(e instanceof sV&&(null==i?void 0:i.track)instanceof oV)return i.track.isActive||t.push([PG.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===PG.LocalVideoTrack)){const e=this.localTrackMap.get(PG.LocalVideoLowTrack);e&&t.push([PG.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(PG.LocalAudioTrack);if(e instanceof sV&&(null==i?void 0:i.track)instanceof oV)return i.track.isActive&&t.push([PG.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===PG.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(PG.LocalVideoLowTrack);e&&t.push([PG.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:r}]=e;switch(i){case PG.LocalAudioTrack:t=gG.Audio;break;case PG.LocalVideoTrack:t=n._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High;break;case PG.LocalVideoLowTrack:t=gG.Low}return{stream_type:t,ssrcs:s,mid:r}}))}createUnmuteMessage(e){return e.map((e=>{let t,[i,{track:n,ssrcs:s,id:r}]=e;switch(i){case PG.LocalAudioTrack:t=gG.Audio;break;case PG.LocalVideoTrack:t=n._hints.includes(fx.SCREEN_TRACK)?gG.Screen:gG.High;break;case PG.LocalVideoLowTrack:t=gG.Low}return{stream_type:t,ssrcs:s,mid:r}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}filterTobeUnSubscribedDataChannels(e,t){const i=[];return t.forEach((t=>{var n;null!==(n=this.remoteDataChannelMap.get(e))&&void 0!==n&&n.has(t.id)&&i.push(t)})),i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case OG.VIDEO:return void(i._videoSSRC&&t.push({stream_type:OG.VIDEO,ssrcId:i._videoSSRC}));case OG.AUDIO:return void(i._audioSSRC&&t.push({stream_type:OG.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[i,{kind:n}]=e;if(t.has(i)){let e=t.get(i);n===OG.VIDEO?e|=vG.Video:e|=vG.Audio,t.set(i,e)}else n===OG.VIDEO?t.set(i,vG.Video):t.set(i,vG.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,i]=e;return{stream_id:t.uid,stream_type:i}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(PG.LocalVideoTrack),i=this.localTrackMap.get(PG.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return!this.connection||"connected"!==this.connection.peerConnectionState}mapPubResToRemoteConfig(e,t){return e.map(((e,i)=>{var n;let{stream_type:s}=e;return null===(n=t.find((e=>{let{stream_type:t}=e;return s===t})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof sV){var t;const n=this.filterTobeUnmutedTracks(e[i]);if(0===n.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t}))));const s=this.createUnmuteMessage(n);return void await iN(this,MG.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(MG.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(MG.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await RN(UN(this.dtlsFailedCount,MN)),this.emit(MG.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await tN(this,MG.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(MG.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(PG.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof XV))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof XV)).length>1)throw new CO(yO.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof sV)).length>1&&(e.some((e=>e instanceof sV&&e._bypassWebAudio))||!nx().webAudioMediaStreamDest))throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof XV&&this.pendingLocalTracks.some((e=>e instanceof XV)))throw new CO(yO.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof sV&&this.pendingLocalTracks.some((e=>e instanceof sV))&&(!nx().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof sV&&e._bypassWebAudio))))throw new CO(yO.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!JN("DISABLE_DUAL_STREAM_USE_ENCODING")&&nx().supportDualStreamEncoding,n=UB(UB({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():qW(e,n);const r=yN(8,"track-low-"),o=new XV(s,UB(UB({},i&&{scaleResolutionDownBy:Tj(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,r);return o.on(Ex.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,mx.LOW_STREAM)})),o._hints.push(fx.LOW_STREAM),e.on("sei-to-send",(e=>{o.emit("sei-to-send",e)})),e.addListener(px.NEED_CLOSE,(()=>{o.close()})),o}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,i){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof VH){var s,r,o,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:h}=this.connection,{local:u,remote:p}=await this.connection.getSelectedCandidatePair();CL.pcStats(this.store.sessionId,{startTime:c,eventElapse:e-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:h,intSucc:t?1:2,error:n,selectedLocalCandidateProtocol:null!==(s=null==u?void 0:u.protocol)&&void 0!==s?s:"",selectedLocalCandidateType:null!==(r=u.candidateType)&&void 0!==r?r:"",selectedLocalCandidateAddress:"".concat(u.address,":").concat(u.port),selectedRemoteCandidateProtocol:null!==(o=p.protocol)&&void 0!==o?o:"",selectedRemoteCandidateType:null!==(a=p.candidateType)&&void 0!==a?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:i})}}reportVideoFirstFrameDecoded(e,t,i,n){const s=Array.from(this.remoteUserMap.keys()).find((t=>t._videoSSRC===e));if(s){n||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const r=this.store.keyMetrics,o=r.subscribe.find((e=>e.userId===s.uid&&"video"===e.type));CL.firstRemoteVideoDecode(this.store.sessionId,SL.FIRST_VIDEO_DECODE,vL.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:i,subscribeElapse:cW.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:r.requestAPEnd||0,apStart:r.requestAPStart||0,joinGwEnd:r.joinGatewayEnd||0,joinGwStart:r.joinGatewayStart||0,pcEnd:r.peerConnectionEnd||0,pcStart:r.peerConnectionStart||0,subscriberEnd:(null==o?void 0:o.subscribeEnd)||0,subscriberStart:(null==o?void 0:o.subscribeStart)||0,videoAddNotify:(null==o?void 0:o.streamAdded)||0,state:n?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const r=await this.connection.getRemoteSSRC(s);return void 0!==r&&r!==i}resetConnection(e){EL.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===kG.Connected?(EL.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===RG.datachannel?new XH({},this.store):this.isPlanB?new MH({},this.store):new VH({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===PG.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,mx.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof VH&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===LG.TCP_RESTART&&e===NG.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,LG.DISCONNECTED_OR_FAILED)))}}).prototype,"startP2PConnection",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"startP2PConnection"),QH.prototype),VB(QH.prototype,"connect",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"connect"),QH.prototype),VB(QH.prototype,"updateRemoteRTPCapabilities",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"updateRemoteRTPCapabilities"),QH.prototype),VB(QH.prototype,"preConnect",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"preConnect"),QH.prototype),VB(QH.prototype,"publishDataChannel",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"publishDataChannel"),QH.prototype),VB(QH.prototype,"unpublish",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"unpublish"),QH.prototype),VB(QH.prototype,"unpublishDataChannel",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"unpublishDataChannel"),QH.prototype),VB(QH.prototype,"unpublishLowStream",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"unpublishLowStream"),QH.prototype),VB(QH.prototype,"subscribeDataChannel",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"subscribeDataChannel"),QH.prototype),VB(QH.prototype,"subscribe",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"subscribe"),QH.prototype),VB(QH.prototype,"massSubscribe",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"massSubscribe"),QH.prototype),VB(QH.prototype,"unsubscribe",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"unsubscribe"),QH.prototype),VB(QH.prototype,"unsubscribeDataChannel",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"unsubscribeDataChannel"),QH.prototype),VB(QH.prototype,"massUnsubscribe",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"massUnsubscribe"),QH.prototype),VB(QH.prototype,"muteRemote",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"muteRemote"),QH.prototype),VB(QH.prototype,"unmuteRemote",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"unmuteRemote"),QH.prototype),VB(QH.prototype,"hasRemoteMediaWithLock",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"hasRemoteMediaWithLock"),QH.prototype),VB(QH.prototype,"disconnectForReconnect",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"disconnectForReconnect"),QH.prototype),VB(QH.prototype,"updateBitrateLimit",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"updateBitrateLimit"),QH.prototype),VB(QH.prototype,"remoteMediaSsrcChanged",[eK],Object.getOwnPropertyDescriptor(QH.prototype,"remoteMediaSsrcChanged"),QH.prototype),QH);function eK(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PChannel.".concat(t));try{for(var s=arguments.length,r=new Array(s),o=0;o<s;o++)r[o]=arguments[o];return await n.apply(this,r)}finally{i()}},i}function tK(e){let t={};e:for(;!pK(e);){let i=yK(e);switch(i>>>3){case 0:break e;case 1:t.requestId=EK(e,yK(e));break;case 2:t.requestType=yK(e)>>>0;break;case 3:t.scorePorn=vK(e);break;case 4:t.scoreSexy=vK(e);break;case 5:t.scoreNeutral=vK(e);break;case 6:t.requestScene=yK(e)>>>0;break;case 7:t.scene=yK(e)>>>0;break;default:sK(e,7&i)}}return t}function iK(e,t){let i=e.service;void 0!==i&&(CK(t,8),CK(t,i));let n=e.vendor;void 0!==n&&(CK(t,16),CK(t,n));let s=e.token;void 0!==s&&(CK(t,26),_K(t,s));let r=e.callbackUrl;void 0!==r&&(CK(t,34),_K(t,r))}function nK(e){let t=yK(e),i=e.limit;return e.limit=e.offset+t,i}function sK(e,t){switch(t){case 0:for(;128&TK(e););break;case 2:uK(e,yK(e));break;case 5:uK(e,4);break;case 1:uK(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let rK=new Float32Array(1);new Uint8Array(rK.buffer);let oK=new Float64Array(1),aK=new Uint8Array(oK.buffer);function cK(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let dK=[];function lK(){const e=dK.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function hK(e){dK.push(e)}function uK(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function pK(e){return e.offset>=e.limit}function fK(e,t){let i=e.bytes,n=e.offset,s=e.limit,r=n+t;if(r>i.length){let t=new Uint8Array(2*r);t.set(i),e.bytes=t}return e.offset=r,r>s&&(e.limit=r),n}function mK(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function EK(e,t){let i=mK(e,t),n=String.fromCharCode,s=e.bytes,r="ï¿½",o="";for(let e=0;e<t;e++){let a,c,d,l,h=s[e+i];0==(128&h)?o+=n(h):192==(224&h)?e+1>=t?o+=r:(a=s[e+i+1],128!=(192&a)?o+=r:(l=(31&h)<<6|63&a,l<128?o+=r:(o+=n(l),e++))):224==(240&h)?e+2>=t?o+=r:(a=s[e+i+1],c=s[e+i+2],32896!=(49344&(a|c<<8))?o+=r:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?o+=r:(o+=n(l),e+=2))):240==(248&h)?e+3>=t?o+=r:(a=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(a|c<<8|d<<16))?o+=r:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?o+=r:(l-=65536,o+=n(55296+(l>>10),56320+(1023&l)),e+=3))):o+=r}return o}function _K(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}CK(e,n);let s=fK(e,n),r=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?r[s++]=n:(n<2048?r[s++]=n>>6&31|192:(n<65536?r[s++]=n>>12&15|224:(r[s++]=n>>18&7|240,r[s++]=n>>12&63|128),r[s++]=n>>6&63|128),r[s++]=63&n|128)}}function gK(e,t){let i=fK(e,t.limit),n=e.bytes,s=t.bytes;for(let e=0,r=t.limit;e<r;e++)n[e+i]=s[e]}function TK(e){return e.bytes[mK(e,1)]}function SK(e,t){let i=fK(e,1);e.bytes[i]=t}function vK(e){let t=mK(e,8),i=e.bytes;return aK[0]=i[t++],aK[1]=i[t++],aK[2]=i[t++],aK[3]=i[t++],aK[4]=i[t++],aK[5]=i[t++],aK[6]=i[t++],aK[7]=i[t++],oK[0]}function RK(e,t){let i=fK(e,8),n=e.bytes;oK[0]=t,n[i++]=aK[0],n[i++]=aK[1],n[i++]=aK[2],n[i++]=aK[3],n[i++]=aK[4],n[i++]=aK[5],n[i++]=aK[6],n[i++]=aK[7]}function yK(e){let t,i=0,n=0;do{t=TK(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function CK(e,t){for(t>>>=0;t>=128;)SK(e,127&t|128),t>>>=7;SK(e,t)}function IK(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,r=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,o=fK(e,r),a=e.bytes;switch(r){case 10:a[o+9]=s>>>7&1;case 9:a[o+8]=9!==r?128|s:127&s;case 8:a[o+7]=8!==r?n>>>21|128:n>>>21&127;case 7:a[o+6]=7!==r?n>>>14|128:n>>>14&127;case 6:a[o+5]=6!==r?n>>>7|128:n>>>7&127;case 5:a[o+4]=5!==r?128|n:127&n;case 4:a[o+3]=4!==r?i>>>21|128:i>>>21&127;case 3:a[o+2]=3!==r?i>>>14|128:i>>>14&127;case 2:a[o+1]=2!==r?i>>>7|128:i>>>7&127;case 1:a[o]=1!==r?128|i:127&i}}const AK=new Map([["moderation",1],["supervise",2]]);class bK extends GO{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(FG.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){this._inspectMode=e.map((e=>AK.get(e)||0)).reduce(((e,t)=>e+t)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(e){super(),this.name="AgoraRTCVideoContentInspect",this._connectionState=UG.CONNECTING,this._innerConnectionState=void 0,this.sequence=0,this.inspectStartTime=void 0,this.workerManagerConnection=void 0,this.workerConnection=void 0,this.workerMessageLengthLimit=void 0,this.inspectIntervalMinimum=void 0,this.qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=YD.CancelToken.source(),this._retryConfig=void 0,this.wmSequence=0,this.inspectInterval=void 0,this.inspectTimer=null,this.ossFilePrefix=void 0,this.extraInfo=void 0,this._inspectType=void 0,this._inspectMode=void 0,this._quality=1,this.qualityTimer=null,this._inspectId=void 0,this._needWorkUrlOnly=!1,this.inspectImage=()=>{if(this.connectionState!==UG.CONNECTED)throw new eG(yO.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===UG.CONNECTED?this.requestToInspectImage():EL.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()},this._inspectId=yN(5,"inspect-"),this.workerMessageLengthLimit=JN("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=JN("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=JN("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new dj("worker-manager-"+this._inspectId,MN),this.on(FG.STATE_CHANGE,((e,t)=>{this._innerConnectionState=e,EL.debug("[".concat(this._inspectId,"] Inspect operation :").concat(xG[e]," ").concat(t||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new dj("worker-"+this._inspectId,MN),this.handleWorkerEvents()}async init(e,t){this.emit(FG.STATE_CHANGE,xG.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new Promise(((n,s)=>{this.on(FG.CONNECTION_STATE_CHANGE,((e,t)=>{t===UG.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorkerManager(e)})).catch((e=>{s(e)}))}))}async requestAP(e,t,i){const n=JN("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),s=await function(e,t,i,n){let{appId:s,areaCode:r,cname:o,sid:a,token:c,uid:d}=t;Jj++;const l="image_moderation_api",h={service_name:l,json_body:JSON.stringify({appId:s,areaCode:r,cname:o,command:"allocateEdge",requestId:Jj,seq:Jj,sid:a,token:c,ts:Date.now(),uid:d+""})};let u,p,f=e[0];return xN((async()=>{u=Date.now();const e=await Lj(f,{data:h,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-u,0!==e.code){const t=new eG(yO.UNEXPECTED_RESPONSE,"image inspect ap error, code"+e.code,{retry:!0,responseTime:p});throw EL.error(t.toString()),t}const t=JSON.parse(e.json_body);if(200!==t.code){const e=new eG(yO.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(t.code,", reason: ").concat(t.reason),{code:t.code,responseTime:p});throw EL.error(e.toString()),e}if(!t.servers||!Array.isArray(t.servers)||0===t.servers.length){const e=new eG(yO.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:t.code,responseTime:p});throw EL.error(e.toString()),e}const n=JN("VIDEO_INSPECT_WORKER_MANAGER_HOST"),s=JN("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:t.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(s||i)})).filter((e=>!!e)),workerToken:t.workerToken,vid:t.vid,responseTime:p}}),((t,i)=>(CL.apworkerEvent(a,{success:!0,sc:200,serviceName:l,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===i,responseTime:p,serverIp:e[i%e.length]}),!1)),((t,i)=>(CL.apworkerEvent(a,{success:!1,sc:t.data&&t.data.code||200,serviceName:l,responseTime:p,serverIp:e[i%e.length]}),!!(t.code!==yO.OPERATION_ABORTED&&t.code!==yO.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(i+1)%e.length],!0))),n)}(n,e,t,i);this.emit(FG.STATE_CHANGE,xG.AP_CONNECTED);const{addressList:r}=s;return this.wmSequence++,r}async connectWorkerManager(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=t,this.emit(FG.STATE_CHANGE,xG.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(ZB.CONNECTED,(async()=>{this.emit(FG.STATE_CHANGE,xG.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.20.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(ZB.CLOSED,(()=>{this._innerConnectionState<xG.GET_WORKER_MANAGER_RESPONSE&&EL.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(ZB.FAILED,(()=>{this._innerConnectionState<xG.GET_WORKER_MANAGER_RESPONSE&&EL.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(ZB.RECONNECTING,(()=>{this._innerConnectionState<xG.GET_WORKER_MANAGER_RESPONSE&&EL.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(ZB.ON_MESSAGE,(async e=>{this.emit(FG.STATE_CHANGE,xG.GET_WORKER_MANAGER_RESPONSE);const t=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(e.data);if(200!==i.code)throw EL.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new eG(yO.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&t))throw EL.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new eG(yO.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const e=JN("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,n=t.replace(/:\d+\/?$/,":".concat(e));this.emit(FG.STATE_CHANGE,xG.CONNECT_WORKER,n),this._needWorkUrlOnly?this.emit(FG.REQUEST_NEW_WORKER_URL,n):await this.connectWorker(n)}})),this.workerManagerConnection.on(ZB.WILL_RECONNECT,((e,t,i)=>{i(e)})),this.workerManagerConnection.on(ZB.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}handleWorkerEvents(){this.workerConnection.on(ZB.CONNECTED,(async()=>{this.emit(FG.STATE_CHANGE,xG.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=UG.CONNECTED})),this.workerConnection.on(ZB.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const t=function(e){return function(e){let t={};e:for(;!pK(e);){let i=yK(e);switch(i>>>3){case 0:break e;case 1:t.code=yK(e);break;case 2:t.msg=EK(e,yK(e));break;case 3:{let i=nK(e);t.data=tK(e),e.limit=i;break}default:sK(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}(new Uint8Array(e.data));if(JN("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&EL.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(t)),200===t.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(FG.INSPECT_RESULT,void 0,void 0);if(t.data&&t.data.scorePorn&&t.data.scoreSexy&&t.data.scoreNeutral){const e={porn:t.data.scorePorn,sexy:t.data.scoreSexy,neutral:t.data.scoreNeutral},i=Object.keys(e).reduce(((t,i)=>e[t]>e[i]?t:i),"porn"),n=Object.keys(e).find((e=>e===i));this.emit(FG.INSPECT_RESULT,n)}else this.emit(FG.INSPECT_RESULT,void 0,new eG(yO.UNEXPECTED_RESPONSE,t.code+"","There is an unexpected data on message"))}else this.emit(FG.INSPECT_RESULT,void 0,new eG(yO.UNEXPECTED_RESPONSE,t.code+"",t.msg))}else EL.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(FG.INSPECT_RESULT,void 0,new eG(yO.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(ZB.CLOSED,(()=>{this.connectionState=UG.CLOSED})),this.workerConnection.on(ZB.FAILED,(()=>{this.connectionState=UG.CLOSED})),this.workerConnection.on(ZB.RECONNECTING,(()=>{this.connectionState=this.connectionState===UG.CONNECTED?UG.RECONNECTING:UG.CONNECTING})),this.workerConnection.on(ZB.WILL_RECONNECT,((e,t,i)=>{"recover"===e&&i(e),i("tryNext")})),this.workerConnection.on(ZB.REQUEST_NEW_URLS,((e,t)=>{this.workerManagerConnection.close(),this.once(FG.REQUEST_NEW_WORKER_URL,(t=>{e([t])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((e=>{this.connectWorkerManager(e,!0)})).catch((e=>{t(e)}))}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=nN(this,FG.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(FG.INSPECT_RESULT,void 0,new eG(yO.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(e,t);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(FG.INSPECT_RESULT,void 0,new eG(yO.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,t){let{appId:i,cname:n,cid:s,vid:r,sid:o,uid:a}=t;const c=Date.now(),d=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await fV(d,i,n),h=this.sequence+"-"+s+"-"+a+"-"+c+"-"+yN(12,""),u={appId:i,cid:s,cname:n,deviceId:"",elapse:bK.intToLong(Number(c-this.inspectStartTime)),fileSize:l.byteLength,jpgEncryption:2,height:d.height,width:d.width,jpg:l,networkType:6,osType:7,requestId:h,sdkVersion:"4.20.2",sequence:this.sequence,sid:o,timestamp:bK.intToLong(c),uid:a,vid:r,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete u.callbackData,void 0===this.ossFilePrefix&&delete u.ossFilePrefix;const p=function(e){let t=lK();return function(e,t){let i=e.appId;void 0!==i&&(CK(t,10),_K(t,i));let n=e.cid;void 0!==n&&(CK(t,16),CK(t,n));let s=e.cname;void 0!==s&&(CK(t,26),_K(t,s));let r=e.deviceId;void 0!==r&&(CK(t,34),_K(t,r));let o=e.elapse;void 0!==o&&(CK(t,40),IK(t,o));let a=e.fileSize;void 0!==a&&(CK(t,48),IK(t,cK(a)));let c=e.height;void 0!==c&&(CK(t,56),IK(t,cK(c)));let d=e.jpg;void 0!==d&&(CK(t,66),CK(t,d.length),function(e,t){let i=fK(e,t.length);e.bytes.set(t,i)}(t,d));let l=e.networkType;void 0!==l&&(CK(t,72),IK(t,cK(l)));let h=e.osType;void 0!==h&&(CK(t,80),IK(t,cK(h)));let u=e.requestId;void 0!==u&&(CK(t,90),_K(t,u));let p=e.sdkVersion;void 0!==p&&(CK(t,98),_K(t,p));let f=e.sequence;void 0!==f&&(CK(t,104),IK(t,cK(f)));let m=e.sid;void 0!==m&&(CK(t,114),_K(t,m));let E=e.timestamp;void 0!==E&&(CK(t,120),IK(t,E));let _=e.uid;void 0!==_&&(CK(t,128),CK(t,_));let g=e.vid;void 0!==g&&(CK(t,136),CK(t,g));let T=e.width;void 0!==T&&(CK(t,144),IK(t,cK(T)));let S=e.service;void 0!==S&&(CK(t,152),CK(t,S));let v=e.callbackData;void 0!==v&&(CK(t,162),_K(t,v));let R=e.jpgEncryption;void 0!==R&&(CK(t,168),CK(t,R));let y=e.requestType;void 0!==y&&(CK(t,176),CK(t,y));let C=e.scorePorn;void 0!==C&&(CK(t,185),RK(t,C));let I=e.scoreSexy;void 0!==I&&(CK(t,193),RK(t,I));let A=e.scoreNeutral;void 0!==A&&(CK(t,201),RK(t,A));let b=e.scene;void 0!==b&&(CK(t,208),CK(t,b));let w=e.ossFilePrefix;void 0!==w&&(CK(t,218),_K(t,w));let D=e.serviceVendor;if(void 0!==D)for(let e of D){CK(t,226);let i=lK();iK(e,i),CK(t,i.limit),gK(t,i),hK(i)}}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}(u);if(p.byteLength<this.workerMessageLengthLimit){if(JN("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const e=UB({},u);delete e.jpg,EL.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(e))}return p}{const t=this.quality*this.qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:i,cname:n,cid:s,vid:r,sid:o,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=YD.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=UG.CLOSED,this.emit(FG.STATE_CHANGE,xG.CLOSED)}}function wK(e,t){switch(t){case 0:for(;128&FK(e););break;case 2:NK(e,BK(e));break;case 5:NK(e,4);break;case 1:NK(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function DK(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let OK=[];function NK(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function LK(e){return e.offset>=e.limit}function PK(e,t){let i=e.bytes,n=e.offset,s=e.limit,r=n+t;if(r>i.length){let t=new Uint8Array(2*r);t.set(i),e.bytes=t}return e.offset=r,r>s&&(e.limit=r),n}function kK(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function MK(e,t){let i=PK(e,t.length);e.bytes.set(t,i)}function UK(e,t){let i=kK(e,t),n=String.fromCharCode,s=e.bytes,r="ï¿½",o="";for(let e=0;e<t;e++){let a,c,d,l,h=s[e+i];0==(128&h)?o+=n(h):192==(224&h)?e+1>=t?o+=r:(a=s[e+i+1],128!=(192&a)?o+=r:(l=(31&h)<<6|63&a,l<128?o+=r:(o+=n(l),e++))):224==(240&h)?e+2>=t?o+=r:(a=s[e+i+1],c=s[e+i+2],32896!=(49344&(a|c<<8))?o+=r:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?o+=r:(o+=n(l),e+=2))):240==(248&h)?e+3>=t?o+=r:(a=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(a|c<<8|d<<16))?o+=r:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?o+=r:(l-=65536,o+=n(55296+(l>>10),56320+(1023&l)),e+=3))):o+=r}return o}function xK(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}GK(e,n);let s=PK(e,n),r=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?r[s++]=n:(n<2048?r[s++]=n>>6&31|192:(n<65536?r[s++]=n>>12&15|224:(r[s++]=n>>18&7|240,r[s++]=n>>12&63|128),r[s++]=n>>6&63|128),r[s++]=63&n|128)}}function FK(e){return e.bytes[kK(e,1)]}function VK(e,t){let i=PK(e,1);e.bytes[i]=t}function BK(e){let t,i=0,n=0;do{t=FK(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function GK(e,t){for(t>>>=0;t>=128;)VK(e,127&t|128),t>>>=7;VK(e,t)}function jK(e,t){let i,n=0,s=0,r=0;return i=FK(e),n=127&i,128&i&&(i=FK(e),n|=(127&i)<<7,128&i&&(i=FK(e),n|=(127&i)<<14,128&i&&(i=FK(e),n|=(127&i)<<21,128&i&&(i=FK(e),s=127&i,128&i&&(i=FK(e),s|=(127&i)<<7,128&i&&(i=FK(e),s|=(127&i)<<14,128&i&&(i=FK(e),s|=(127&i)<<21,128&i&&(i=FK(e),r=127&i,128&i&&(i=FK(e),r|=(127&i)<<7))))))))),{low:n|s<<28,high:s>>>4|r<<24,unsigned:t}}function WK(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,r=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,o=PK(e,r),a=e.bytes;switch(r){case 10:a[o+9]=s>>>7&1;case 9:a[o+8]=9!==r?128|s:127&s;case 8:a[o+7]=8!==r?n>>>21|128:n>>>21&127;case 7:a[o+6]=7!==r?n>>>14|128:n>>>14&127;case 6:a[o+5]=6!==r?n>>>7|128:n>>>7&127;case 5:a[o+4]=5!==r?128|n:127&n;case 4:a[o+3]=4!==r?i>>>21|128:i>>>21&127;case 3:a[o+2]=3!==r?i>>>14|128:i>>>14&127;case 2:a[o+1]=2!==r?i>>>7|128:i>>>7&127;case 1:a[o]=1!==r?128|i:127&i}}const HK={},KK={},YK=4294967296,qK=YK*YK,$K=qK/2,zK=eY(0,!0),XK=eY(0),JK=tY(0,-2147483648,!1),QK=tY(-1,2147483647,!1),ZK=tY(-1,-1,!0);function eY(e,t){let i,n,s;return t?(s=0<=(e>>>=0)&&e<256)&&(n=KK[e],n)?n:(i=tY(e,0,!0),s&&(KK[e]=i),i):(s=-128<=(e|=0)&&e<128)&&(n=HK[e],n)?n:(i=tY(e,e<0?-1:0,!1),s&&(HK[e]=i),i)}function tY(e,t,i){return{low:0|e,high:0|t,unsigned:!!i}}function iY(e,t){if(isNaN(e))return t?zK:XK;if(t){if(e<0)return zK;if(e>=qK)return ZK}else{if(e<=-$K)return JK;if(e+1>=$K)return QK}return e<0?t?zK:XK:tY(e%YK|0,e/YK|0,t)}class nY extends GO{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(WG.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(e){var t;super(),this.name="AgoraRTCImageModeration",this._connectionState=jG.CONNECTING,this._sequence=0,this._moderationStartTime=void 0,this._workerConnection=void 0,this._workerMessageLengthLimit=void 0,this._qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=YD.CancelToken.source(),this._retryConfig=void 0,this._moderationInterval=void 0,this._moderationTimer=null,this._moderationMode=1,this._quality=1,this._qualityTimer=null,this._ticket=void 0,this._moderationIntervalMinimum=void 0,this._uploadFailedNum=0,this._uploadNum=0,this._uploadTimer=null,this._extraInfo=void 0,this._vendor="",this._encoder=new TextEncoder,this._moderationId=void 0,this.inspectImage=()=>{if(this.connectionState!==jG.CONNECTED)throw new eG(yO.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===jG.CONNECTED?this.requestToInspectImage():EL.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()},this._moderationId=yN(5,"image-moderation-"),this._workerMessageLengthLimit=JN("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=JN("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(t=e.interval)&&void 0!==t?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=JN("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new dj("worker-"+this._moderationId,MN),this.on(WG.STATE_CHANGE,((e,t)=>{EL.debug("[".concat(this._moderationId,"] Moderation operation :").concat(HG[e]," ").concat(t||""))})),this.handleWorkerEvents()}async init(e,t){this.emit(WG.STATE_CHANGE,HG.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new Promise(((n,s)=>{this.on(WG.CONNECTION_STATE_CHANGE,((e,t)=>{e===jG.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorker(e)})).catch((e=>{s(e)}))}))}updateConfig(e){var t;this._moderationInterval=null!==(t=e.interval)&&void 0!==t?t:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),EL.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===jG.CONNECTED&&this.inspectImage()}async requestAP(e,t,i){const n=JN("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),s=await function(e,t,i,n){let{appId:s,areaCode:r,cname:o,sid:a,token:c,uid:d}=t;Jj++;const l="moderation_plugin",h={service_name:l,json_body:JSON.stringify({appId:s,areaCode:r,cname:o,command:"allocateEdge",requestId:Jj,seq:Jj,sid:a,appToken:c,ts:Date.now(),uid:d+""})};let u,p,f=e[0];return xN((async()=>{u=Date.now();const e=await Lj(f,{data:h,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(p=Date.now()-u,0!==e.code){const t=new eG(yO.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+e.code,{retry:!0,responseTime:p});throw EL.error(t.toString()),t}const t=JSON.parse(e.json_body);if(200!==t.code){const e=new eG(yO.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(t.code,", reason: ").concat(t.reason),{code:t.code,responseTime:p});throw EL.error(e.toString()),e}if(!t.servers||!Array.isArray(t.servers)||0===t.servers.length){const e=new eG(yO.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:t.code,responseTime:p});throw EL.error(e.toString()),e}if(!t.servers.some((e=>!!e.wss))){const e=new eG(yO.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:t.code,responseTime:p});throw EL.error(e.toString()),e}const n=JN("IMAGE_MODERATION_WORKER_HOST");return{addressList:t.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(i,"/moderation")})).filter((e=>!!e)),workerToken:t.workerToken,vid:t.vid,ticket:t.appTicket,responseTime:p}}),((t,i)=>(CL.apworkerEvent(a,{success:!0,sc:200,serviceName:l,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===i,responseTime:p,serverIp:e[i%e.length]}),!1)),((t,i)=>(CL.apworkerEvent(a,{success:!1,sc:t.data&&t.data.code||200,serviceName:l,responseTime:p,serverIp:e[i%e.length]}),!!(t.code!==yO.OPERATION_ABORTED&&t.code!==yO.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(i+1)%e.length],!0))),n)}(n,e,t,i);this.emit(WG.STATE_CHANGE,HG.AP_CONNECTED);const{addressList:r,ticket:o}=s;return this._ticket=o,r}async connectWorker(e){this.emit(WG.STATE_CHANGE,HG.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(ZB.CONNECTED,(async()=>{this.emit(WG.STATE_CHANGE,HG.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=jG.CONNECTED})),this._workerConnection.on(ZB.CLOSED,(()=>{this.connectionState=jG.CLOSED})),this._workerConnection.on(ZB.FAILED,(()=>{this.connectionState=jG.CLOSED})),this._workerConnection.on(ZB.RECONNECTING,(()=>{this.connectionState=this.connectionState===jG.CONNECTED?jG.RECONNECTING:jG.CONNECTING})),this._workerConnection.on(ZB.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const t=function(e){return function(e){let t={};e:for(;!LK(e);){let i=BK(e);switch(i>>>3){case 0:break e;case 1:t.code=BK(e);break;case 2:t.msg=UK(e,BK(e));break;case 3:t.requestId=UK(e,BK(e));break;case 4:t.timestamp=jK(e,!1);break;default:wK(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}(new Uint8Array(e.data));JN("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&EL.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(t)),this._uploadNum++,void 0===t.code||0===t.code||(this._uploadFailedNum++,EL.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(t.code,", msg is ").concat(t.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{CL.reportApiInvoke(this._connectInfo.sid||null,{name:HO.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,t.code],tag:KO.TRACER}).onError(new eG(yO.IMAGE_MODERATION_UPLOAD_FAILED,t.msg)),this._uploadTimer=null}),JN("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else EL.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(ZB.WILL_RECONNECT,((e,t,i)=>{"recover"===e&&i(e),i("tryNext")})),this._workerConnection.on(ZB.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=nN(this,WG.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(JN("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&EL.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(e,t);this._workerConnection.sendMessage(i,!0,!0)}else JN("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&EL.debug("Only the track being published can be inspected")}async generateRequestData(e,t){let{appId:i,cname:n,cid:s,vid:r,sid:o,uid:a}=t;const c=Date.now(),d=await e.getCurrentFrameImage("image/jpeg",this.quality),l=await fV(d,i,n),h=this._sequence+"-"+s+"-"+a+"-"+c+"-"+yN(12,""),u={appId:i,cid:s,cname:n,deviceId:"",elapse:nY.intToLong(Number(c-this._moderationStartTime)),fileSize:d.buffer.byteLength,height:d.height,width:d.width,jpg:l,networkType:6,osType:7,requestId:h,sdkVersion:"4.20.2",sequence:this._sequence,sid:o,timestamp:iY(c),uid:a,vid:r,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};void 0===this._extraInfo&&delete u.callbackData;const p=function(e){let t=function(){const e=OK.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,t){let i=e.appId;void 0!==i&&(GK(t,10),xK(t,i));let n=e.cid;void 0!==n&&(GK(t,16),GK(t,n));let s=e.cname;void 0!==s&&(GK(t,26),xK(t,s));let r=e.deviceId;void 0!==r&&(GK(t,34),xK(t,r));let o=e.elapse;void 0!==o&&(GK(t,40),WK(t,o));let a=e.fileSize;void 0!==a&&(GK(t,48),WK(t,DK(a)));let c=e.height;void 0!==c&&(GK(t,56),WK(t,DK(c)));let d=e.jpg;void 0!==d&&(GK(t,66),GK(t,d.length),MK(t,d));let l=e.networkType;void 0!==l&&(GK(t,72),WK(t,DK(l)));let h=e.osType;void 0!==h&&(GK(t,80),WK(t,DK(h)));let u=e.requestId;void 0!==u&&(GK(t,90),xK(t,u));let p=e.sdkVersion;void 0!==p&&(GK(t,98),xK(t,p));let f=e.sequence;void 0!==f&&(GK(t,104),WK(t,DK(f)));let m=e.sid;void 0!==m&&(GK(t,114),xK(t,m));let E=e.timestamp;void 0!==E&&(GK(t,120),WK(t,E));let _=e.uid;void 0!==_&&(GK(t,128),GK(t,_));let g=e.vid;void 0!==g&&(GK(t,136),GK(t,g));let T=e.width;void 0!==T&&(GK(t,144),WK(t,DK(T)));let S=e.service;void 0!==S&&(GK(t,152),GK(t,S));let v=e.callbackData;void 0!==v&&(GK(t,162),GK(t,v.length),MK(t,v));let R=e.ticket;void 0!==R&&(GK(t,170),xK(t,R));let y=e.vendorConfigs;void 0!==y&&(GK(t,178),xK(t,y))}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}(u);if(p.byteLength<this._workerMessageLengthLimit){if(JN("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const e=UB({},u);delete e.jpg,EL.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(e))}return p}{const t=this.quality*this._qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:i,cname:n,cid:s,vid:r,sid:o,uid:a})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=YD.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=jG.CLOSED,this.emit(WG.STATE_CHANGE,HG.CLOSED)}}const sY=Date.now(),rY=20,oY=new Map,aY=new Map;async function cY(e){const t=oY.get(e),i=Array.isArray(t)&&t[t.length-1],n=aY.get(e);if(!i)return void(n.isSyncing=!1);const s={uid:i.uid,payload:i.payload};0===n.firstRecvTs&&(n.firstRecvTs=i.recvTs,n.firstSendTs=i.sendTs);const r=i.sendTs-n.firstSendTs,o=r-(Date.now()-n.firstRecvTs);o>0&&(n.firstRecvTs=Date.now()-r);let a=i.mediaDelay+o;a<=0?(t.pop(),dY(i.context,s),a=0):a=Math.min(a,rY),setTimeout((()=>t.length&&cY(e)),a)}function dY(e,t){e.safeEmit(JO.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function lY(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return dY(i,{uid:e.uid,payload:e.payload});const n="".concat(i.id,"-").concat(e.uid),s=oY.get(n)||[],r=s.findIndex((t=>e.sendTs>=t.sendTs)),o=UB(UB({},e),{},{context:i,mediaDelay:t,recvTs:Date.now()});-1===r?s.push(o):s.splice(r,0,o),oY.set(n,s);let a=!1;var c;aY.has(n)?a=!(null===(c=aY.get(n))||void 0===c||!c.isSyncing):aY.set(n,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||cY(n)}var hY,uY,pY,fY,mY,EY,_Y,gY,TY,SY,vY,RY,yY,CY,IY,AY,bY,wY,DY,OY,NY,LY,PY,kY,MY,UY,xY,FY,VY,BY,GY,jY,WY,HY,KY,YY,qY,$Y,zY,XY,JY,QY,ZY;sO().name,PN.setLogger(EL);let eq=(hY=yL(),uY=yL({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof Fx))return[t];t=[t]}return t.map((e=>e?Object(e).toString():"null"))}}),pY=yL({argsMap:(e,t)=>(t||(t=[]),t instanceof EB?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId()))))}),fY=yL({argsMap:(e,t,i,n)=>[t.uid,i,n]}),mY=yL({argsMap:(e,t,i)=>[t,i]}),EY=yL({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return[null==t?void 0:t.uid,i]}))}),_Y=yL({argsMap:(e,t,i,n)=>[t.uid,i,n]}),gY=yL({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return{uid:null==t?void 0:t.uid,mediaType:i}}))}),TY=yL(),SY=yL(),vY=yL(),RY=yL(),yY=yL(),CY=yL(),IY=yL(),AY=yL(),bY=yL(),wY=yL(),DY=yL(),OY=yL(),NY=yL(),LY=yL(),PY=yL({argsMap:(e,t)=>[t]}),kY=yL(),MY=yL(),UY=yL(),xY=yL(),FY=yL(),VY=yL(),BY=yL(),GY=yL(),jY=yL(),WY=yL(),HY=yL({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),KY=yL(),YY=yL(),qY=yL(),$Y=yL(),zY=yL(),XY=yL(),JY=yL({reportResult:!0}),QY=yL(),VB((ZY=class extends GO{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return(null===(e=this._config)||void 0===e?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let t;if(super(),this.store=void 0,this._uid=void 0,this._channelName=void 0,this._uintUid=void 0,this._users=[],this._config=void 0,this._clientId=void 0,this._appId=void 0,this._sessionId=null,this._key=void 0,this._rtmConfig={},this._joinInfo=void 0,this._gateway=void 0,this._statsCollector=void 0,this._configDistribute=void 0,this._leaveMutex=new PN("client-leave"),this._publishMutex=new PN("client-publish"),this._renewTokenMutex=new PN("client-renewtoken"),this._subscribeMutex=new PN("client-subscribe"),this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStream=!1,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._proxyServer=void 0,this._turnServer={servers:[],mode:"auto"},this._cloudProxyServerMode="disabled",this._isDualStreamEnabled=!1,this._defaultStreamFallbackType=void 0,this._lowStreamParameter=void 0,this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._axiosCancelSource=YD.CancelToken.source(),this._audioVolumeIndicationInterval=void 0,this._networkQualityInterval=void 0,this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0,this._injectStreamingClient=void 0,this._liveTranscodeStreamingClient=void 0,this._liveRawStreamingClient=void 0,this._channelMediaRelayClient=void 0,this._networkQualitySensitivity="normal",this._p2pChannel=void 0,this._useLocalAccessPoint=!1,this._setLocalAPVersion=void 0,this._joinAndNotLeaveYet=!1,this._numberOfJoinCount=0,this._remoteDefaultVideoStreamType=void 0,this._inspect=void 0,this._moderation=void 0,this._license=void 0,this._pendingPublishedUsers=[],this.ntpAlignErrorCount=0,this.remoteInboundOffset=0,this._handleLocalTrackEnable=(e,t,i)=>{this.publish(e,!1).then(t).catch(i)},this._handleLocalTrackDisable=(e,t,i)=>{this.unpublish(e).then(t).catch(i)},this._handleUserOnline=e=>{if(JN("BLOCK_LOCAL_CLIENT")&&wB(e.uid,this.channelName))return void EL.debug("[".concat(e.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof e.uid&&EL.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const t=this._users.find((t=>t.uid===e.uid));if(t)t._trust_in_room_=!0,t._is_pre_created&&(t._is_pre_created=!1,this.safeEmit(JO.USER_JOINED,t));else{const t=new cH(e.uid,e.uint_id||e.uid);this._users.push(t),EL.debug("[".concat(this._clientId,"] user online"),e.uid),this.safeEmit(JO.USER_JOINED,t)}},this._handleUserOffline=e=>{if(JN("BLOCK_LOCAL_CLIENT")&&wB(e.uid,this.channelName))return;const t=this._users.find((t=>t.uid===e.uid));t&&(this._handleRemoveStream(e),this._handleRemoveDataChannels(e),t._audio_pre_subscribed||t._video_pre_subscribed?t._is_pre_created=!0:dN(this._users,t),this._remoteStreamTypeCacheMap.delete(t.uid),this._streamFallbackTypeCacheMap.delete(t.uid),EL.debug("[".concat(this._clientId,"] user offline"),e.uid,"reason:",e.reason),this.safeEmit(JO.USER_LEAVED,t,e.reason))},this._handleAddAudioOrVideoStream=(e,t,i,n,s,r,o)=>{if(JN("BLOCK_LOCAL_CLIENT")&&wB(t,this.channelName))return;const a=this._users.find((e=>e.uid===t));if(!a)return void EL.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));EL.debug("[".concat(this._clientId,"] stream added with uid ").concat(t,", type ").concat(e)),this.store.subscribe(a.uid,e,void 0,void 0,void 0,Date.now());const c="audio"===e?a.hasAudio:a.hasVideo;a._uintid||(a._uintid=s||t),"audio"===e?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,"audio"===e?(a._audio_added_=!0,void 0!==i&&(a._audioSSRC=i),void 0!==n&&(a._cname=n),r&&(a._audioOrtc=r)):(a._video_added_=!0,void 0!==i&&(a._videoSSRC=i),void 0!==n&&(a._cname=n),void 0!==o&&(a._rtxSsrcId=o),r&&(a._videoOrtc=r)),("audio"===e?a.hasAudio:a.hasVideo)&&!c&&(EL.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(e)),this.safeEmit(JO.USER_PUBLISHED,a,e)),"video"===e?CL.onGatewayStream(this._sessionId,SL.ON_ADD_VIDEO_STREAM,vL.ON_ADD_VIDEO_STREAM,{peer:s||t,ssrc:a._videoSSRC}):CL.onGatewayStream(this._sessionId,SL.ON_ADD_AUDIO_STREAM,vL.ON_ADD_AUDIO_STREAM,{peer:s||t,ssrc:a._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(a,e,i).then((t=>{if(t&&(EL.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(a.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof ZH))return this._p2pChannel.unsubscribe(a,e,!0).then((()=>this._subscribe(a,e,!0).catch((e=>{EL.error("[".concat(this._clientId,"] resubscribe error"),e.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(a,e)&&(EL.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,e,!0).catch((e=>{EL.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._handleRemoveStream=e=>{if(JN("BLOCK_LOCAL_CLIENT")&&wB(e.uid,this.channelName))return;const t=this._users.find((t=>t.uid===e.uid));if(!t)return void EL.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));EL.debug("[".concat(this._clientId,"] stream removed with uid ").concat(e.uid));let i=()=>{};t.hasAudio&&t.hasVideo?i=()=>{EL.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished audio track")),this.safeEmit(JO.USER_UNPUBLISHED,t,"audio"),EL.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished video track")),this.safeEmit(JO.USER_UNPUBLISHED,t,"video")}:t.hasVideo?i=()=>{EL.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished video track")),this.safeEmit(JO.USER_UNPUBLISHED,t,"video")}:t.hasAudio&&(i=()=>{EL.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished audio track")),this.safeEmit(JO.USER_UNPUBLISHED,t,"audio")}),t._video_pre_subscribed||t._audio_pre_subscribed||(t._trust_audio_stream_added_state_=!0,t._trust_video_stream_added_state_=!0,t._audio_added_=!1,t._video_added_=!1,this._p2pChannel instanceof ZH&&this._p2pChannel.unsubscribe(t).then((e=>{if(e)return this._gateway.unsubscribe(e,t.uid)})),t._audioSSRC=void 0,t._videoSSRC=void 0,t._audioOrtc=void 0,t._videoOrtc=void 0,t._rtxSsrcId=void 0),CL.onGatewayStream(this._sessionId,SL.ON_REMOVE_STREAM,vL.ON_REMOVE_STREAM,{peer:e.uint_id||e.uid}),i()},this._handleSetStreamLocalEnable=(e,t,i)=>{if(JN("BLOCK_LOCAL_CLIENT")&&wB(t,this.channelName))return;const n=this._users.find((e=>e.uid===t));if(!n)return void EL.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));EL.debug("[".concat(this._clientId,"] local ").concat(e," ").concat(i?"enabled":"disabled"," with uid ").concat(t));const s="audio"===e?n.hasAudio:n.hasVideo;if("audio"===e){n._trust_audio_enabled_state_=!0;const e=n._audio_enabled_;if(n._audio_enabled_=i,n._audio_enabled_===e)return;{const e=n._audio_enabled_?"enable-local-audio":"disable-local-audio";EL.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(JO.USER_INFO_UPDATED,t,e)}}else{n._trust_video_enabled_state_=!0;const e=n._video_enabled_;if(n._video_enabled_=i,n._video_enabled_===e)return;{const e=n._video_enabled_?"enable-local-video":"disable-local-video";EL.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(t,", msg: ").concat(e)),this.safeEmit(JO.USER_INFO_UPDATED,t,e)}}const r="audio"===e?n.hasAudio:n.hasVideo;return s!==r?!s&&r?(EL.info("[".concat(this._clientId,"] remote user ").concat(t," published ").concat(e)),void this.safeEmit(JO.USER_PUBLISHED,n,e)):("video"===e&&n._videoTrack&&n._videoTrack._destroy(),"audio"===e&&n._audioTrack,this._p2pChannel.muteRemote(n,e),EL.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished ").concat(e)),void this.safeEmit(JO.USER_UNPUBLISHED,n,e)):void 0},this._handleMuteStream=(e,t,i)=>{if(JN("BLOCK_LOCAL_CLIENT")&&wB(e,this.channelName))return;EL.debug("[".concat(this._clientId,"] receive mute message"),e,t,i);const n=this._users.find((t=>t.uid===e));if(!n)return void EL.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(e));const s="audio"===t?n.hasAudio:n.hasVideo;if("audio"===t){n._trust_audio_mute_state_=!0;const t=n._audio_muted_;if(n._audio_muted_=i,n._audio_muted_===t)return;{const t=n._audio_muted_?"mute-audio":"unmute-audio";EL.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(JO.USER_INFO_UPDATED,e,t)}}else{n._trust_video_mute_state_=!0;const t=n._video_muted_;if(n._video_muted_=i,n._video_muted_===t)return;{const t=n._video_muted_?"mute-video":"unmute-video";EL.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(t)),this.safeEmit(JO.USER_INFO_UPDATED,e,t)}}const r="audio"===t?n.hasAudio:n.hasVideo;if(s!==r){if(!s&&r)return("audio"===t?n._audioSSRC:n._videoSSRC)?(EL.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(t)),void this.safeEmit(JO.USER_PUBLISHED,n,t)):void EL.warning("[".concat(this._clientId,"] remote user ").concat(e," receive ").concat(t," unmute message  before add stream message, ").concat(t," SSRC doesn't exist yet."));"video"===t&&n._videoTrack&&!n._video_pre_subscribed&&n._videoTrack._destroy(),"audio"===t&&n._audioTrack,this._p2pChannel.muteRemote(n,t),EL.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(t)),this.safeEmit(JO.USER_UNPUBLISHED,n,t)}},this._handleP2PLost=async e=>{EL.debug("[".concat(this._clientId,"] receive p2p lost"),e),parseInt(e.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():EL.warning("[".concat(this._clientId,"] P2PLost stream not found"),e)},this._handleTokenWillExpire=()=>{EL.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(JO.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)},this._handleBeforeUnload=e=>{"beforeunload"===e.type&&void 0!==e.returnValue&&""!==e.returnValue||(this.leave(),EL.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))},this._handleUpdateNetworkQuality=()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(JO.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(JO.NETWORK_QUALITY,e)},this._handleP2PAddAudioOrVideoStream=(e,t,i,n)=>{const s=this._users.find((e=>e.uid===t));if(!s)return void EL.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));EL.debug("[".concat(this._clientId,"] stream added with uid ").concat(t,", type ").concat(e)),this.store.subscribe(s.uid,e,void 0,void 0,void 0,Date.now());const r="audio"===e?s.hasAudio:s.hasVideo;"audio"===e?s._trust_audio_stream_added_state_=!0:s._trust_video_stream_added_state_=!0,"audio"===e?(s._audio_added_=!0,void 0!==i&&(s._audioSSRC=i),void 0!==n&&(s._audioMid=n)):(s._video_added_=!0,void 0!==i&&(s._videoSSRC=i),void 0!==n&&(s._videoMid=n)),("audio"===e?s.hasAudio:s.hasVideo)&&!r&&(EL.info("[".concat(this._clientId,"] remote user ").concat(s.uid," published ").concat(e)),this.safeEmit(JO.USER_PUBLISHED,s,e)),this._p2pChannel.hasPendingRemoteMedia(s,e)&&(EL.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(s.uid," after reconnect.")),this._subscribe(s,e,!0).catch((e=>{EL.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._config=e,this._clientId=yN(5,"client-"),this.store=new class{constructor(e,t,i,n){this.state=void 0,this.state={codec:e,audioCodec:t,mode:i,clientId:n,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:qN.Default}}dispatch(e){this.state=function(e,t){switch(t.type){case ZN.SET_SESSION_ID:return aN(aN({},e),{},{sessionId:t.sessionId});case ZN.SET_P2P_ID:return aN(aN({},e),{},{p2pId:t.p2pId});case ZN.SET_UID:return aN(aN({},e),{},{uid:t.uid});case ZN.SET_INT_UID:return aN(aN({},e),{},{intUid:t.intUid});case ZN.SET_PUB_ID:return aN(aN({},e),{},{pubId:t.pubId});case ZN.KEY_METRIC_CLIENT_CREATED:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{clientCreated:t.metric})});case ZN.KEY_METRIC_JOIN_START:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{joinStart:t.metric})});case ZN.AVOID_JOIN_START:return aN(aN({},e),{},{avoidJoinStart:t.avoidJoinStart});case ZN.KEY_METRIC_JOIN_END:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{joinEnd:t.metric})});case ZN.KEY_METRIC_REQUEST_AP_START:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{requestAPStart:t.metric})});case ZN.KEY_METRIC_REQUEST_AP_END:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{requestAPEnd:t.metric})});case ZN.KEY_METRIC_JOIN_GATEWAY_START:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{joinGatewayStart:t.metric})});case ZN.KEY_METRIC_JOIN_GATEWAY_END:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{joinGatewayEnd:t.metric})});case ZN.KEY_METRIC_PEER_CONNECTION_START:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{peerConnectionStart:t.metric})});case ZN.KEY_METRIC_PEER_CONNECTION_END:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{peerConnectionEnd:t.metric})});case ZN.KEY_METRIC_DESCRIPTION_START:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{descriptionStart:t.metric})});case ZN.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{signalChannelOpen:t.metric})});case ZN.KEY_METRIC_ICE_CONNECTION_END:return aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{iceConnectionEnd:t.metric})});case ZN.KEY_METRIC_PUBLISH:{const i=e.keyMetrics.publish,n=i.findIndex((e=>e.trackId===t.metric.trackId));return-1!==n?(i[n]=aN(aN({},i[n]),t.metric),aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{publish:[...i]})})):aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{publish:[...e.keyMetrics.publish,t.metric]})})}case ZN.KEY_METRIC_SUBSCRIBE:{const i=e.keyMetrics.subscribe,n=i.findIndex((e=>e.userId===t.metric.userId&&e.type===t.metric.type));return-1!==n?(i[n]=aN(aN({},i[n]),t.metric),aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{subscribe:[...i]})})):aN(aN({},e),{},{keyMetrics:aN(aN({},e.keyMetrics),{},{subscribe:[...e.keyMetrics.subscribe,t.metric]})})}case ZN.SET_CLOUD_PROXY_SERVER_MODE:return e.cloudProxyServerMode=t.mode,e;case ZN.RECORD_JOIN_CHANNEL_SERVICE:return"number"!=typeof t.index?e.joinChannelServiceRecords=[...e.joinChannelServiceRecords,t.record]:(e.joinChannelServiceRecords[t.index]=aN(aN({},e.joinChannelServiceRecords[t.index]),t.record),e.joinChannelServiceRecords=[...e.joinChannelServiceRecords]),e;case ZN.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return e.joinChannelServiceRecords=[],e;case ZN.RESET_KEY_METRICS:return e.keyMetrics={publish:[],subscribe:[]},e;case ZN.SET_USE_DATACHANNEL:return aN(aN({},e),{},{useDataChannel:t.val});case ZN.SET_USE_P2P:return aN(aN({},e),{},{useP2P:t.val});case ZN.SET_TRANSPORT_TYPE:return aN(aN({},e),{},{p2pTransport:t.val});default:return e}}(this.state,e)}set sessionId(e){this.dispatch({type:ZN.SET_SESSION_ID,sessionId:e})}get sessionId(){return this.state.sessionId}set codec(e){this.state.codec=e}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(e){this.dispatch({type:ZN.SET_P2P_ID,p2pId:e})}get p2pId(){return this.state.p2pId}set dcId(e){this.dispatch({type:ZN.SET_DC_ID,dcId:e})}get dcId(){return this.state.dcId}set uid(e){this.dispatch({type:ZN.SET_UID,uid:e})}get uid(){return this.state.uid}set intUid(e){this.dispatch({type:ZN.SET_INT_UID,intUid:e})}get intUid(){return this.state.intUid}set pubId(e){this.dispatch({type:ZN.SET_PUB_ID,pubId:e})}get pubId(){return this.state.pubId}set cloudProxyServerMode(e){this.dispatch({type:ZN.SET_CLOUD_PROXY_SERVER_MODE,mode:e})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(e){this.dispatch({type:ZN.SET_USE_DATACHANNEL,val:e})}get useDataChannel(){return this.state.useDataChannel}set useP2P(e){this.dispatch({type:ZN.SET_USE_P2P,val:e})}get useP2P(){return this.state.useP2P}set p2pTransport(e){this.dispatch({type:ZN.SET_TRANSPORT_TYPE,val:e})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:ZN.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:ZN.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:ZN.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:ZN.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:ZN.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:ZN.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:ZN.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:ZN.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:ZN.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:ZN.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:ZN.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:ZN.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(e,t,i,n){this.dispatch({type:ZN.KEY_METRIC_PUBLISH,metric:aN(aN({trackId:e,type:t},i&&{publishStart:i}),n&&{publishEnd:n})})}subscribe(e,t,i,n,s,r,o){this.dispatch({type:ZN.KEY_METRIC_SUBSCRIBE,metric:aN(aN(aN(aN(aN({userId:e,type:t},i&&{subscribeStart:i}),n&&{subscribeEnd:n}),s&&{firstFrame:s}),r&&{streamAdded:r}),o&&{firstDecoded:o})})}massSubscribe(e,t,i,n){e.forEach((e=>{this.dispatch({type:ZN.KEY_METRIC_SUBSCRIBE,metric:aN(aN(aN({userId:e.userId,type:e.type},t&&{subscribeStart:t}),i&&{subscribeEnd:i}),n&&{firstFrame:n})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(e,t){"gateway"===e.service&&Array.isArray(e.urls)&&(e.urls=e.urls.map((e=>e.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return"number"!=typeof t?(this.dispatch({type:ZN.RECORD_JOIN_CHANNEL_SERVICE,record:aN(aN({},e),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(t<0||t>=this.state.joinChannelServiceRecords.length||this.dispatch({type:ZN.RECORD_JOIN_CHANNEL_SERVICE,record:e,index:t}),t)}catch(e){return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:ZN.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:ZN.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch(e){return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(e){this.dispatch({type:ZN.AVOID_JOIN_START,avoidJoinStart:e})}}(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),EL.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(KN," build: ").concat($N,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{XO(e.clientRoleOptions),t=Object.assign({},e.clientRoleOptions)}catch(e){EL.warning("[".concat(this._clientId,"] ").concat(e.toString()))}this._statsCollector=new bH(this.store),this._statsCollector.onStatsException=(e,t,i)=>{EL.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(e,", msg: ").concat(t,", uid: ").concat(i)),this.safeEmit(JO.EXCEPTION,{code:e,msg:t,uid:i})},this._statsCollector.onUploadPublishDuration=(e,t,i,n)=>{const s=this._users.find((t=>t.uid===e));s&&CL.peerPublishStatus(this._sessionId,{subscribeElapse:n,audioPublishDuration:t,videoPublishDuration:i,peer:s._uintid})},this.store.useDataChannel=nx().supportDataChannel&&JN("SIGNAL_CHANNEL"),this.store.useP2P="p2p"===e.mode,this._gateway=new Dj(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||MN,httpRetryConfig:e.httpRetryConfig||MN,forceWaitGatewayResponse:void 0===e.forceWaitGatewayResponse||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:t}),this._configDistribute=new rW,this.store.useP2P?(this._p2pChannel=new IH(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new ZH(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,i,n,s){let r=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=arguments.length>6&&void 0!==arguments[6]&&arguments[6];XN("JOIN_GATEWAY_USE_443PORT_ONLY",r),XN("JOIN_GATEWAY_USE_DUAL_DOMAIN",o);const a=this._gateway.signal.websocket;return a instanceof cj&&(a.use443PortOnly=r,a.tryDoubleDomain=o),QD("client.join",JN("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,i,n,s)}async join(e,t,i,n,s){const r=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);const o="HTTPS"===(FN||FN||(FN=(window.location.protocol.split(":")[0]||"").toUpperCase(),FN)),a=HN()?window.isSecureContext:"Browser Not Support";if(!HN()&&!o||!window.isSecureContext){const e="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";EL.warning(e)}const c=CN();"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),EL.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const d=CL.reportApiInvoke(c,{name:HO.JOIN,options:[e,t,i,n],states:{isHttps:o,isSecureContext:a},tag:KO.TRACER});CL.setAppId(e);try{if(!i&&null!==i)throw new eG(yO.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&DO(i,"token",1,2047),DO(e,"appid",1,2047),tG(t),n&&iG(n),s&&DO(s,"optionalInfo",1,2047)}catch(e){throw d.onError(e),e}if(EL.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(r)),this._leaveMutex.isLocked&&(EL.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),EL.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const e=new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw d.onError(e),e}this._sessionId||(this._sessionId=c,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const l=UB(UB({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:"string"!=typeof n?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:s,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(l.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof n&&(l.stringUid=n,this._uintUid?(l.uid=this._uintUid,this._uintUid=void 0):l.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(l.aesmode=this._encryptionMode,l.aespassword=await(async e=>{const t=function(e){const t=window.atob("MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu\nSTM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+\nHvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy\nxQiYDz3vqa6bP29adwIDAQAB"),i=new Uint8Array(new ArrayBuffer(t.length));for(let e=0;e<t.length;e+=1)i[e]=t.charCodeAt(e);return i}(),i=await window.crypto.subtle.importKey("spki",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),n=FO(e),s=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},i,n);return function(e){let t="";for(let i=0;i<e.length;i+=1)t+=String.fromCharCode(e[i]);return window.btoa(t)}(new Uint8Array(s))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(l.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&("aes-128-gcm2"===this._encryptionMode||"aes-256-gcm2"===this._encryptionMode))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const e=new TextEncoder,t=JN("USE_PURE_ENCRYPTION_MASTER_KEY")?e.encode(l.appId+this._encryptionSecret+this._encryptionSecret):e.encode(l.appId+l.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(e,t,i){const n=await window.crypto.subtle.importKey("raw",t,"PBKDF2",!1,["deriveBits","deriveKey"]),s="aes-128-gcm2"===e?128:256,r=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:nL,hash:"SHA-256",salt:i},n,s+iL);return new Uint8Array(r).subarray(s/8)}(this._encryptionMode,t,EN(this._encryptionSalt)),this._encryptDataStreamKey=await async function(e,t,i){const n=await window.crypto.subtle.importKey("raw",t,"PBKDF2",!1,["deriveBits","deriveKey"]),s="aes-128-gcm2"===e?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:nL,hash:"SHA-256",salt:i},n,{name:"AES-GCM",length:s},!0,["encrypt","decrypt"])}(this._encryptionMode,t,EN(this._encryptionSalt))}else a?EL.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):EL.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,EL.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:l.stringUid});const h=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&h===this._sessionId&&CL.joinChannelTimeout(this._sessionId,5)}),5e3);try{let n;const s=l.cloudProxyServer;if(["proxy3","proxy4","proxy5"].includes(s)){const e=JN("PROXY_SERVER_TYPE3");Array.isArray(e)?l.proxyServer=e[0]:l.proxyServer=e}if(CL.setProxyServer(l.proxyServer),EL.setProxyServer(l.proxyServer),this.store.requestAPStart(),l.stringUid&&!l.uid){let e;[e,n]=await Promise.all([iW(l.stringUid,l,this._axiosCancelSource.token,this._config.httpRetryConfig||MN,this.store),tW(l,this._axiosCancelSource.token,this._config.httpRetryConfig||MN,!0,this.store)]),EL.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(l.stringUid," => ").concat(e)),l.uid=e,n.gatewayInfo.uid=e,n.gatewayInfo.res.uid=e}else n=await tW(l,this._axiosCancelSource.token,this._config.httpRetryConfig||MN,!0,this.store);if(!this._joinAndNotLeaveYet)throw new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(l,this._axiosCancelSource.token),this._configDistribute.on(bG.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=i||e;const r=n.gatewayInfo,o=l.uid?l.uid:r.uid;this._joinInfo=UB(UB({},l),{},{cid:r.cid,uid:o,vid:r.vid,apResponse:r.res,uni_lbs_ip:r.uni_lbs_ip,gatewayAddrs:r.gatewayAddrs}),this.store.intUid=o;const a=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));d.onSuccess(a),this._appId=e,this._channelName=l.cname,this._uid=a,this.store.uid=a,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(dO()?"beforeunload":"pagehide",this._handleBeforeUnload)}),0);const c=l.stringUid?"string uid: ".concat(l.stringUid,",uid: ").concat(l.uid):"uid: ".concat(this._uid);return EL.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(c)),setTimeout((()=>{EL.startUpload()}),5e3),this.store.joinEnd(),this,bB.includes(this)||bB.push(this),a}catch(e){const t=Array.isArray(e)?e[0]:e;throw t&&t.code===yO.OPERATION_ABORTED?EL.warning("[".concat(this._clientId,"] join number: ").concat(r,", Joining channel failed, rollback"),t):EL.error("[".concat(this._clientId,"] join number: ").concat(r,", Joining channel failed, rollback"),t),t.code!==yO.OPERATION_ABORTED&&this._numberOfJoinCount===r&&(this._gateway.state="DISCONNECTED",this._reset()),d.onError(t),t}}_joinGateway(){if(!this._joinInfo||!this._key)throw new eG(yO.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!JN("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((e=>e)).catch((e=>{if(e.code===yO.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,qO.FALLBACK),e;if(e.code===yO.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,qO.FALLBACK),e;throw e})).then((e=>{if(e instanceof eG){if(e.code===yO.INIT_WEBSOCKET_TIMEOUT){if(EL.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new eG(yO.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=JN("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),i=t.slice(t.length-2).join(".");e.forEach((e=>{this._joinInfo&&e.includes(i)&&(this._joinInfo.proxyServer=e)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const t=JN("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return t&&t[1]&&"443"!==t[1]&&EL.setProxyServer(this._joinInfo.proxyServer),"443"!==JN("STATS_COLLECTOR_PORT").toString()&&CL.setProxyServer(this._joinInfo.proxyServer),CL.reportApiInvoke(this._sessionId,{name:HO.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:KO.TRACER}).onSuccess(),this.safeEmit(JO.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),JN("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((e=>{"forceturn"in e&&(e.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(EL.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new eG(yO.INVALID_OPERATION);return CL.reportApiInvoke(this._sessionId,{name:HO.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:KO.TRACER}).onSuccess(),this._joinGateway()}return e})).then((e=>e))}async leave(){EL.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(dO()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=bB.indexOf(e);-1!==t&&bB.splice(t,1)}(this);const e=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return EL.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave("CONNECTED"!==this.connectionState),EL.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(e)){if(!(e instanceof Fx))return this._publishDataChannel(e);e=[e]}if(0===e.length)throw new eG(yO.INVALID_PARAMS,"param list is empty");const i=e;if("audience"===this._gateway.role)throw new eG(yO.INVALID_OPERATION,"audience can not publish stream");for(const e of i){if(!(e instanceof Fx))throw new eG(yO.INVALID_PARAMS,"parameter is not local track");if(!e._enabled&&t)throw new eG(yO.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(e.getTrackId()))}EL.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(i.map((e=>"".concat(e.getTrackId()," ")))));const n=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&i.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof XV&&t&&e.setBitrateLimit(t.uplink)}));try{await this._publishHighStream(i),EL.info("[".concat(this._clientId,"] Publish success, id ").concat(i.map((e=>"".concat(e.getTrackId()," ")))))}catch(e){throw EL.error("[".concat(this._clientId,"] publish error"),e.toString()),e}finally{n()}}async _publishDataChannel(e){bO(e.id,"id",0,65535,!0),IO(e.ordered,"ordered"),DO(e.metadata,"metadata",0,512),EL.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((t=>t.id===e.id)))throw new eG(yO.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new eG(yO.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&JN("FORCE_TURN")&&!JN("TURN_ENABLE_TCP")&&!JN("TURN_ENABLE_UDP"))throw new eG(yO.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const i=new EB(e);if(await this._p2pChannel.publishDataChannel([i]),!this._p2pChannel.isP2PDisconnected()){if("number"!=typeof i._originDataChannelId)throw EL.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new eG(yO.CREATE_DATACHANNEL_ERROR);try{const t={streamId:e.id,ordered:e.ordered,maxRetransmits:JN("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:i._originDataChannelId};await this._gateway.publishDataChannel(this._uid,t,!0),await i._waitTillOpen()}catch(e){if(e.code!==yO.DISCONNECT_P2P)throw e}}return EL.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(e){throw EL.error("[".concat(this._clientId,"] publish datachannels error"),e.toString()),e}finally{t()}}async unpublish(e){if(!this._joinInfo||void 0===this._uid)throw new eG(yO.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof Fx))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);EL.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map((e=>"".concat(e.getTrackId()," ")))," "));const i=await this._publishMutex.lock();try{if(this._p2pChannel instanceof IH){const e=await this._p2pChannel.unpublish(t);e&&await this._gateway.sendExtensionMessage(KG.UNPUBLISH,{unpubMsg:e},!0)}else{const e=await this._p2pChannel.unpublish(t);e&&await this._gateway.unpublish(e,this._uid),EL.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map((e=>"".concat(e.getTrackId())))))}}catch(e){throw EL.error("[".concat(this._clientId,"] unpublish error"),e.toString()),e}finally{i&&i()}}async _unpublishDataChannel(e){void 0!==e&&0!==e.length||(e=this._p2pChannel.getAllDataChannels()),EL.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((e=>"".concat(e.id," ")))," "));const t=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublishDataChannel(e);i&&await this._gateway.unpublishDataChannel(i),EL.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((e=>"".concat(e.id)))))}catch(e){throw EL.error("[".concat(this._clientId,"] unpublish dataChannel error"),e.toString()),e}finally{t&&t()}}async subscribe(e,t,i){return"datachannel"===t?this._subscribeDataChannel(e,i):this._subscribe(e,t)}async presubscribe(e,t){if(AO(t,"mediaType",["audio","video"]),this._p2pChannel instanceof IH)throw new eG(yO.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"can't presub when not join");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const i=t===OG.AUDIO,n=t===OG.VIDEO,s=await this._subscribeMutex.lock();try{const{ssrcId:r,ortc:o,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(e,t,!0);if(null==r)throw new eG(yO.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find((t=>t.uid===e));l||(l=new cH(e,d||e),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||e),i&&(l._audioSSRC=r,l._audio_pre_subscribed=!0,o&&(l._audioOrtc=o)),n&&(l._videoSSRC=r,l._video_pre_subscribed=!0,o&&(l._videoOrtc=o),null!=a&&(l._rtxSsrcId=a)),EL.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(r)),await this._p2pChannel.subscribe(l,t,r,a,o);const h=i?l._audioTrack:l._videoTrack;if(!h)throw new eG(yO.UNEXPECTED_ERROR,"can not find remote track in user");return i&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),n&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),h}catch(t){throw EL.error("[".concat(this._clientId,"] presub user ").concat(e," error"),t),t}finally{s()}}async _subscribeDataChannel(e,t){var i;if(bO(t,"channelId",0,65535,!0),!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e)))throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new eG(yO.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&0===e._dataChannels.length)throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new eG(yO.INVALID_REMOTE_USER,"user is not published");const n=null===(i=e._dataChannels)||void 0===i?void 0:i.find((e=>e.id===t));if(!n)throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new eG(yO.REMOTE_USER_IS_NOT_PUBLISHED);const s=await this._subscribeMutex.lock();EL.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const t=await this._p2pChannel.subscribeDataChannel(e,[n]);if(t&&t.includes(n.id))try{var r;if("number"!=typeof n._originDataChannelId)throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new eG(yO.CREATE_DATACHANNEL_ERROR);const t={id:n.id,datachannelId:n._originDataChannelId,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:null!==(r=n.metadata)&&void 0!==r?r:""};await this._gateway.subscribeDataChannel(e.uid,t,!0),await n._waitTillOpen()}catch(t){if((null==t?void 0:t.code)!==yO.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[n]),t;await this._p2pChannel.unsubscribeDataChannel(e,[n]),this._p2pChannel.setPendingRemoteDataChannel(e,n.id)}return EL.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),n}finally{s()}}async _p2pSubscribe(e,t,i){if(AO(t,"mediaType",["audio","video"]),!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const t=new eG(yO.INVALID_REMOTE_USER,"user is not in the channel");throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),t}if(!e.hasAudio&&!e.hasVideo){const t=new eG(yO.INVALID_REMOTE_USER,"user is not published");throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),t}if(!i&&("audio"===t&&!e.hasAudio||"video"===t&&!e.hasVideo)){const i=new eG(yO.REMOTE_USER_IS_NOT_PUBLISHED);throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),i}const n=await this._subscribeMutex.lock();EL.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const i="audio"===t?e._audioSSRC:e._videoSSRC,n="audio"===t?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this._p2pChannel instanceof IH&&await this._p2pChannel.subscribe(e,t,i,n)}catch(e){throw e}EL.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{EL.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const i="audio"===t?e._audioTrack:e._videoTrack;if(!i)throw new eG(yO.UNEXPECTED_ERROR,"can not find remote track in user object");return i}catch(t){throw EL.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),t),t}finally{n()}}async _subscribe(e,t,i){if(this._p2pChannel instanceof IH)return this._p2pSubscribe(e,t);if(AO(t,"mediaType",["audio","video"]),!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const t=new eG(yO.INVALID_REMOTE_USER,"user is not in the channel");throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),t}if(!e.hasAudio&&!e.hasVideo){const t=new eG(yO.INVALID_REMOTE_USER,"user is not published");throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),t}if(!(i||("audio"!==t||e.hasAudio&&void 0!==e._audioSSRC)&&("video"!==t||e.hasVideo&&void 0!==e._videoSSRC))){const i=new eG(yO.REMOTE_USER_IS_NOT_PUBLISHED);throw EL.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),i}let n="audio"===t?e._audioSSRC:e._videoSSRC,s="audio"===t?e._audioOrtc:e._videoOrtc,r="video"===t?e._rtxSsrcId:void 0,o={stream_type:"audio"===t?OG.AUDIO:OG.VIDEO,ssrcId:n};const a=await this._subscribeMutex.lock();EL.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const i="audio"===t?e._audioSSRC:e._videoSSRC;void 0!==i&&i!==n&&(n=i,s="audio"===t?e._audioOrtc:e._videoOrtc,r="video"===t?e._rtxSsrcId:void 0,o={stream_type:"audio"===t?OG.AUDIO:OG.VIDEO,ssrcId:n}),cW.markSubscribeStart(this.store.clientId,n),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,n,r,s);try{await this._gateway.subscribe(e.uid,o,!0)}catch(i){if((null==i?void 0:i.code)!==yO.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),i;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(i){throw this._p2pChannel.reportSubscribeEvent(!1,null==i?void 0:i.code,e,t),i}EL.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{EL.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const i="audio"===t?e._audioTrack:e._videoTrack;if(!i)throw new eG(yO.UNEXPECTED_ERROR,"can not find remote track in user object");return i}catch(t){throw EL.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),t),t}finally{a()}}async massSubscribe(e){if(OO(e,"subscribeList"),!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),i=new Map,n=await this._subscribeMutex.lock();EL.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; ")));const s=(e=[...e]).map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i}})),r=await this._p2pChannel.globalLock();try{for(let t=e.length-1;t>=0;t--){const n=e[t],{user:r,mediaType:o}=n;if(AO(o,"mediaType",["audio","video"]),!r){const e=new eG(yO.INVALID_PARAMS,"user property does not exist in subscribeList item");throw EL.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),e}if(!this._users.find((e=>e===r))){const i=new eG(yO.INVALID_REMOTE_USER,"user is not in the channel");EL.error("[".concat(this._clientId,"] can not massSubscribe ").concat(r.uid,", this user is not in the channel")),s[t].error=i,e.splice(t,1);continue}if("audio"===o&&(!r.hasAudio||void 0===r._audioSSRC)||"video"===o&&(!r.hasVideo||void 0===r._videoSSRC)){const i=new eG(yO.REMOTE_USER_IS_NOT_PUBLISHED);EL.error("[".concat(this._clientId,"] can not subscribe ").concat(r.uid," with mediaType ").concat(o,", remote user is not published")),s[t].error=i,e.splice(t,1);continue}const a=vG.Video|vG.LwoVideo,c=i.get(r);if(c){if("video"===o?c&a:c&vG.Audio){e.splice(t,1),EL.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(r.uid,", mediaType:").concat(o," twice"));continue}i.set(r,c|("video"===o?a:vG.Audio))}else i.set(r,"video"===o?a:vG.Audio)}for(let t=e.length-1;t>=0;t--){const n=e[t],{user:s,mediaType:r}=n,o=vG.Video|vG.LwoVideo;if(this._p2pChannel.hasRemoteMedia(s,r)){await this._p2pChannel.unmuteRemoteNoLock(s,r);const n=i.get(s);i.set(s,"video"===r?n^o:n^vG.Audio),e.splice(t,1)}}this.store.massSubscribe(e.map((e=>({userId:e.user.uid,type:e.mediaType}))),t);const o=Array.from(i.entries()).reduce(((e,t)=>{let[i,n]=t;if(0===n)return e;const s={stream_id:i.uid,stream_type:n};return n&vG.Audio&&(s.audio_ssrc=i._audioSSRC),n&vG.Video&&(s.video_ssrc=i._videoSSRC),e.push(s),e}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i,ssrcId:i===OG.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:i===OG.VIDEO?t._rtxSsrcId:void 0}})));const i=new Map;if(o.length>0){const e=await this._gateway.subscribeAll(o,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:n,audio_error_code:s,error_code:r}=e;(n||s||r)&&i.set(t,{video_error_code:n,audio_error_code:s,error_code:r})}))}if(Array.from(i.entries()).length>0){const e=[];Array.from(i.entries()).forEach((t=>{let[i,n]=t;const s=this.remoteUsers.find((e=>e.uid===i));if(s){let t;n.error_code||n.video_error_code&&n.audio_error_code?t=void 0:n.video_error_code?t=OG.VIDEO:n.audio_error_code&&(t=OG.AUDIO),e.push({user:s,mediaType:t})}})),e.length>0&&await this._p2pChannel.massUnsubscribeNoLock(e)}for(const e of s){const t=i.get(e.user.uid);if(t){const i=t.error_code||"audio"===e.mediaType&&t.audio_error_code||"video"===e.mediaType&&t.video_error_code;if(i){const t=QG(i);EL.error("user:".concat(e.user.uid," mediaType:").concat(e.mediaType," has massSubscribe error ").concat(t.desc)),e.error=new eG(yO.SUBSCRIBE_FAILED,"code ".concat(i,": ").concat(t.desc))}}e.error||("video"===e.mediaType?e.track=e.user.videoTrack:e.track=e.user.audioTrack)}return this.store.massSubscribe(s.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),s.forEach((e=>{var i;CL.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(i=e.error)||void 0===i?void 0:i.code)||null,video:e.mediaType===OG.VIDEO,audio:e.mediaType===OG.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===OG.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t)},!0)})),EL.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; "))),s}catch(t){throw await this._p2pChannel.massUnsubscribeNoLock(e),t}}finally{r(),n()}}async unsubscribe(e,t,i){if(t||this.store.useP2P){if("datachannel"===t)return this._unsubscribeDataChannel(e,i)}else await this._unsubscribeDataChannel(e,i);if(t&&AO(t,"mediaType",["audio","video"]),!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((t=>t===e))){const t=new eG(yO.INVALID_REMOTE_USER,"user is not in the channel");throw EL.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),t}EL.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const n=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof IH)await this._p2pChannel.unsubscribe(e,t);else{const i=await this._p2pChannel.unsubscribe(e,t);i&&await this._gateway.unsubscribe(i,e.uid),t&&"audio"!==t||(e._audio_pre_subscribed=!1),t&&"video"!==t||(e._video_pre_subscribed=!1),e._is_pre_created&&dN(this._users,e),EL.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(t){if(t.code===yO.DISCONNECT_P2P)return void EL.warning("disconnecting p2p, abort unsubscribe request.");throw EL.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),t.toString()),t}finally{n()}}async _unsubscribeDataChannel(e,t){if(t&&bO(t,"id",0,65535,!0),!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((t=>t===e))){const t=new eG(yO.INVALID_REMOTE_USER,"user is not in the channel");throw EL.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),t}let i;if("number"==typeof t){const n=e._dataChannels.find((e=>e.id===t));n&&(i=[n])}else i=e._dataChannels;if(void 0===i){const i=new eG(yO.REMOTE_USER_IS_NOT_PUBLISHED);throw EL.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),i}EL.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i.map((e=>e.id))));try{const t=await this._p2pChannel.unsubscribeDataChannel(e,i);t&&await this._gateway.unsubscribeDataChannel(t,e.uid),EL.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(t))}catch(t){if(t.code===yO.DISCONNECT_P2P)return void EL.warning("disconnecting p2p, abort unsubscribe request.");throw EL.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),t.toString()),t}}async massUnsubscribe(e){if(OO(e,"unsubscribeList"),!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");EL.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join())),e=[...e];const t=new Map;for(let i=e.length-1;i>=0;i--){const{user:n,mediaType:s}=e[i];if(!n){const e=new eG(yO.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw EL.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),e}if(AO(s,"mediaType",["video","audio",void 0]),!this._users.find((e=>e===n))){EL.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),e.splice(i,1);continue}const r=vG.Video|vG.LwoVideo;if(t.has(n)){const o=t.get(n);let a;switch(s){case"video":a=o&r;break;case"audio":a=o&vG.Audio;break;default:a=o&(vG.Audio|r)}if(a){EL.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(n.uid,",mediaType:").concat(s," twice.")),e.splice(i,1);continue}s?"audio"===s?t.set(n,o|vG.Audio):"video"===s&&t.set(n,o|r):t.set(n,o|vG.Audio|r)}else s?"audio"===s?t.set(n,vG.Audio):"video"===s&&t.set(n,r):t.set(n,vG.Audio|r)}try{const t=await this._p2pChannel.massUnsubscribe(e);t&&await this._gateway.massUnsubscribe(t),EL.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join()))}catch(e){if(e.code===yO.DISCONNECT_P2P)return void EL.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw EL.error("[".concat(this._clientId,"] massUnsubscribe error"),e.toString()),e}}async setLowStreamParameter(e){(function(e){if(!e)throw new CO(yO.INVALID_PARAMS);NO(e.width)||wO(e.width,"streamParameter.width"),NO(e.height)||wO(e.height,"streamParameter.height"),NO(e.framerate)||wO(e.framerate,"streamParameter.framerate"),NO(e.bitrate)||bO(e.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&EL.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),EL.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,PG.LocalVideoLowTrack)}async enableDualStream(){if(!nx().supportDualStream)throw CL.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new eG(yO.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new eG(yO.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw CL.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,CL.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),EL.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(PG.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw CL.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,CL.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),EL.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(e){AO(e,"role",["audience","host"])}(e),t&&XO(t),"rtc"===this.mode||"p2p"===this.mode)throw EL.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new eG(yO.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&"host"===e)throw new eG(yO.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===e&&this._p2pChannel.hasLocalMedia())throw new eG(yO.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,t),this._config.role=e,EL.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level))}getRemoteInboundOffset(){var e;const t=null===(e=this._p2pChannel.getStats())||void 0===e?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const i=t.timestamp-Date.now();return Math.abs(i)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(DO(e,"proxyServer"),!t){if("DISCONNECTED"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new eG(yO.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,CL.setProxyServer(this._proxyServer),EL.setProxyServer(this._proxyServer),EL.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if("DISCONNECTED"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new eG(yO.INVALID_OPERATION,"You have already set the proxy")}if($O(e))return this._turnServer={servers:e,mode:"original-manual"},void EL.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map((e=>e.urls)).join(","),"."));e.forEach((e=>zO(e))),this._turnServer={servers:e,mode:"manual"},EL.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if("DISCONNECTED"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"you should set license before join channel");if(DO(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new eG(yO.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,EL.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if("DISCONNECTED"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new eG(yO.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let i;switch(void 0===e&&(e=3),e){case 1:case 2:throw new eG(yO.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new eG(yO.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,EL.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"Stop proxy server after leave channel");CL.setProxyServer(),EL.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",EL.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new eG(yO.INVALID_PARAMS,"accessPoints is required.");OO(e.accessPoints.serverList,"accessPoints.serverList"),DO(e.accessPoints.domain,"accessPoints.domain");const t=(e,t)=>{bO(e,t,0,65535,!0)};let i=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),i=e.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new eG(yO.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");JN("CLOSE_AFB_FOR_LOCAL_AP")&&(XN("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),XN("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,s=e.accessPoints.domain,r=e.accessPoints.serverList.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(s):e)),o=r.map((e=>"".concat(e,":").concat(i)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,XN("WEBCS_DOMAIN",o),XN("WEBCS_DOMAIN_BACKUP_LIST",o),XN("GATEWAY_DOMAINS",[s]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(OO(e.report.hostname,"report.hostname"),XN("EVENT_REPORT_DOMAIN",e.report.hostname[0]),XN("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(XN("EVENT_REPORT_DOMAIN",r[0]),XN("EVENT_REPORT_BACKUP_DOMAIN",r[1]||r[0]));let a=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),a=e.report.port),XN("STATS_COLLECTOR_PORT",a),e.report?XN("ENABLE_EVENT_REPORT",!0):XN("ENABLE_EVENT_REPORT",!1);let c="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(OO(e.log.hostname,"log.hostname"),c=e.log.hostname[0]):c=r[0];let d=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),d=e.log.port),XN("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(OO(e.cds.hostname,"cds.hostname"),l=e.cds.hostname):l=r;let h=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),h=e.cds.port),XN("CDS_AP",l.map((e=>"".concat(e,":").concat(h)))),e.cds?XN("ENABLE_CONFIG_DISTRIBUTE",!0):XN("ENABLE_CONFIG_DISTRIBUTE",!1),EL.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(OO(e,"serverList"),DO(t,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new eG(yO.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((e=>i.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(t):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,XN("WEBCS_DOMAIN",e),XN("WEBCS_DOMAIN_BACKUP_LIST",e),XN("GATEWAY_DOMAINS",[t]),XN("EVENT_REPORT_DOMAIN",e[0]),XN("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),XN("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),EL.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(AO(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw EL.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else EL.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){AO(t,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout((()=>{const t=this._users.find((t=>t.uid===e));t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(e){throw EL.error("[".concat(this._clientId,"] set remote video stream type error"),e.toString()),e}EL.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){AO(t,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(e){throw EL.error("[".concat(this._clientId,"] set stream fallback option"),e.toString()),e}EL.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,i,n){(function(e){AO(e,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),DO(t,"secret");const s=["aes-128-gcm2","aes-256-gcm2"];if(s.includes(e)){if(!i||!(i instanceof Uint8Array&&32===i.length))throw new eG(yO.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new eG(yO.INVALID_PARAMS,"current encrypt mode does not need salt");if(n){if(IO(n,"encryptDataStream"),!s.includes(e))throw new eG(yO.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(t)||EL.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=e,this._encryptionSecret=t,i&&(this._encryptionSalt=_N(i))}async renewToken(e){if(DO(e,"token",1,2047),!this._key||!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const i=await this._renewTokenMutex.lock();try{if(JN("USE_NEW_TOKEN")){EL.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const t=await async function(e,t,i){let n=null;const s=[],r=async r=>{const o=JN(r?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2")));return r&&(await RN(1e3),null!==n)?n:await Zj({fragementLength:JN("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:n=>(EL.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(r?"backup":""," choose_server:"),n),function(e,t,i,n){const[s]=Xj(t,[hj.CHOOSE_SERVER]);let r=rN.networkState;return xN((async()=>{r&&rN.networkState===ZO.OFFLINE&&rN.onlineWaiter&&await Promise.race([rN.onlineWaiter,RN(n&&n.maxRetryTimeout||MN.maxRetryTimeout)]),r=rN.networkState;const t=await Lj(e,{data:s,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0);return $j(t,e)}),(()=>!1),(e=>e.code!==yO.OPERATION_ABORTED&&(e.code===yO.UPDATE_TICKET_FAILED?e.data.retry:(EL.warning("[".concat(t.clientId,"] update ticket network error, retry"),e),!0))),n)}(n,e,t,i)),allFailedhandler:e=>{throw e[0]},promisesCollector:s})};try{return n=await Qj([r(!1),r(!0)]),s.length&&s.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),n}catch(e){throw e[0]}}(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||MN);EL.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:t})}else EL.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});EL.debug("[".concat(this._clientId,"] renewToken success"))}catch(e){throw this._key=t,this._joinInfo.token=t,EL.error("[".concat(this._clientId,"] renewToken failed"),e.toString()),e}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?EL.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(JO.VOLUME_INDICATOR,e)}),JN("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this.codec)throw new eG(yO.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new eG(yO.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new eG(yO.LIVE_STREAMING_TASK_CONFLICT);const i=t?nG.TRANSCODE:nG.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(nG.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new eG(yO.INVALID_PARAMS,"can not find live streaming url to stop");await Promise.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(nG.INJECT);i.setInjectStreamConfig(t,0),await i.startLiveStreamingTask(e,nG.INJECT)}async removeInjectStreamUrl(){const e=this._createLiveStreamingClient(nG.INJECT),t=Array.from(e.streamingTasks.values()).find((e=>e.mode===nG.INJECT));if(!this._joinInfo||!t)throw new eG(yO.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(t.url)}async startChannelMediaRelay(e){NH(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){NH(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof e||e instanceof Uint8Array)&&(e={payload:e}),"string"==typeof e.payload){const t=new TextEncoder;e.payload=t.encode(e.payload)}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&["aes-128-gcm2","aes-256-gcm2"].includes(this._encryptionMode)&&(i=!0,e.payload=await async function(e,t,i){const n=Array.from(i).reduce(((e,t)=>e+t),0),s={serverTs:0,seq:rL++,length:i.length,checkSum:n},r=new Uint8Array(ON(n,2)),o=new ArrayBuffer(sL),a=new DataView(o);a.setUint32(0,s.serverTs),a.setUint16(4,s.seq),a.setUint16(6,s.length),a.setUint16(8,s.checkSum);const c=16-i.length%16;i=gN(i,new Uint8Array(c));const d=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:e,tagLength:tL,additionalData:r},t,i);return gN(new Uint8Array(o),new Uint8Array(d))}(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new eG(yO.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(zB.DATA_STREAM,{payload:_N(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-sY},!t)}sendMetadata(e){if(!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new eG(yO.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(zB.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:_N(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(gL),!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"can not send custom report, not joined");await CL.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,t){AO(t.spatialLayer,"spatialLayer",[0,1,2,3]),AO(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(e){throw EL.error("[".concat(this._clientId,"] pick SVC layer failed"),e.toString()),e}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:i}=e;if(IO(t,"apRTM"),bO(i,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=i,EL.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),("CONNECTED"===this.connectionState||"RECONNECTING"===this.connectionState)&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=i,this._gateway.setRTM2Flag(i)}_reset(){if(EL.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=YD.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((e=>e._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new PN("client-publish"),this._subscribeMutex=new PN("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}if(this._moderation)try{this.setImageModeration(!1)}catch(e){}}_startSession(e,t){var i;const n=e||CN();e?EL.debug("[".concat(this._clientId,"] new Session ").concat(n)):EL.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(n));const s=e?"":this._sessionId||"";this._sessionId=n,this.store.sessionId=n;const r={lts:(new Date).getTime(),mode:this.mode,stringUid:(null==t?void 0:t.stringUid)||(null===(i=this._joinInfo)||void 0===i?void 0:i.stringUid),channelProfile:"live"===this.mode?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:s,clientRole:"audience"===this.role?2:1};t?CL.sessionInit(this._sessionId,UB({cname:t.channel,appid:t.appId},r)):this._joinInfo?CL.sessionInit(this._sessionId,UB({cname:this._joinInfo.cname,appid:this._joinInfo.appId},r)):this._gateway.joinInfo&&CL.sessionInit(this._sessionId,UB({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},r)),this._joinInfo&&(this._joinInfo.sid=n),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=n)}async _publishHighStream(e){if(!this._joinInfo||void 0===this._uid)throw new eG(yO.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&JN("FORCE_TURN")&&!JN("TURN_ENABLE_TCP")&&!JN("TURN_ENABLE_UDP"))throw new eG(yO.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");EL.debug("[".concat(this._clientId,"] publish high stream"));try{const i=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof IH){const t=(await i.next()).value;if(t){try{await this._gateway.sendExtensionMessage(KG.PUBLISH,t,!0)}catch(e){throw i.throw(e),e}await i.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const n=(await i.next()).value;if(n){var t;let s;try{s=await this._gateway.publish(this._uid,n,!0)}catch(e){if(e.code!==yO.DISCONNECT_P2P)throw i.throw(e),e}await i.next((null===(t=s)||void 0===t?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const t of e)t instanceof XV&&t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig),!t.muted&&t.enabled||await this._p2pChannel.muteLocalTrack(t)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,e),(null==t?void 0:t.code)===yO.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new eG(yO.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new eG(yO.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));EL.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await e.next()).value;if(i){var t;let n;try{n=await this._gateway.publish(this._uid,i,!0)}catch(t){if(t.code!==yO.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(t=n)||void 0===t?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===yO.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new eG(yO.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const t=()=>new DH(this._joinInfo,this._config.websocketRetryConfig||MN,this._config.httpRetryConfig||MN),i=e=>{e.onLiveStreamError=(e,t)=>{CL.reportApiInvoke(this._sessionId,{name:HO.ON_LIVE_STREAM_ERROR,options:[e,t],tag:KO.TRACER}).onSuccess(),this.safeEmit(JO.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{CL.reportApiInvoke(this._sessionId,{name:HO.ON_LIVE_STREAM_WARNING,options:[e,t],tag:KO.TRACER}).onSuccess(),this.safeEmit(JO.LIVE_STREAMING_WARNING,e,t)},e.on(hG.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new eG(yO.INVALID_OPERATION,"can not find join info to get worker manager"));sW(e,this._joinInfo,this._axiosCancelSource.token,MN).then(t).catch(i)}))};switch(e){case nG.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),i(this._liveRawStreamingClient)),this._liveRawStreamingClient;case nG.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),i(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case nG.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(hG.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new eG(yO.INVALID_OPERATION,"can not find join info to get worker manager"));sW(e,this._joinInfo,this._axiosCancelSource.token,MN).then(t).catch(i)})),this._injectStreamingClient.onInjectStatusChange=(e,t,i)=>{this.safeEmit(JO.INJECT_STREAM_STATUS,e,t,i)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new eG(yO.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),i={width:e,height:t};this._channelMediaRelayClient=new PH(this._joinInfo,this._clientId,this._config.websocketRetryConfig||MN,this._config.httpRetryConfig||MN,i),this._channelMediaRelayClient.on("state",(e=>{e===EG.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(JO.CHANNEL_MEDIA_RELAY_STATE,e)})),this._channelMediaRelayClient.on("event",(e=>{this.safeEmit(JO.CHANNEL_MEDIA_RELAY_EVENT,e)})),this._statsCollector.onStatsChanged=(e,t)=>{var i;"resolution"===e&&(null===(i=this._channelMediaRelayClient)||void 0===i||i.setVideoProfile(t))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:i,deleted:n}=e;Array.isArray(i)&&i.length>0&&i.forEach((e=>{const{uid:i,stream_id:n,ordered:s,max_retrans_times:r,metadata:o}=e,a=this._users.find((e=>e._uintid===i));if(a){if(EL.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(i)),a._uintid||(a._uintid=i),-1===a._dataChannels.findIndex((t=>t.id===e.stream_id))){const e={id:n,ordered:!!s,maxRetransmits:r,metadata:o},i=new mB(e);a._dataChannels.push(i),EL.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published datachannel")),t||this.safeEmit(JO.USER_PUBLISHED,a,"datachannel",e)}this._p2pChannel.hasPendingRemoteDataChannel(a,e.stream_id)&&(EL.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(a.uid," after reconnect.")),this._subscribeDataChannel(a,e.stream_id).catch((e=>{EL.error("[".concat(this._clientId,"] resubscribe datachannel error"),e.toString())})))}else EL.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"))})),t&&(this.safeEmit(JO.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(n)&&n.length>0&&n.forEach((e=>{const{uid:t,stream_id:i}=e,n=this._users.find((e=>e._uintid===t));if(!n)return void EL.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const s=n._dataChannels.find((t=>t.id===e.stream_id));s&&(EL.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(t)),this._p2pChannel.unsubscribeDataChannel(n,[s]).then((e=>{if(n._dataChannels=n._dataChannels.filter((e=>e!==s)),e)return this._gateway.unsubscribeDataChannel(e,n.uid)})),EL.info("[".concat(this._clientId,"] remote user ").concat(t," unpublished datachannel ,id:").concat(s.id)),this.safeEmit(JO.USER_UNPUBLISHED,n,"datachannel",s._config))}))}_handleRemoveDataChannels(e){const t=this._users.find((t=>t.uid===e.uid));if(t){if(void 0!==t._dataChannels&&t._dataChannels.length>0){EL.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const i=()=>{EL.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach((e=>{this.safeEmit(JO.USER_UNPUBLISHED,t,"datachannel",e._config)}))};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then((e=>{if(e)return this._gateway.unsubscribeDataChannel(e,t.uid)})),i()}}else EL.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(TG.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(TG.CONNECTION_STATE_CHANGE,((e,t,i)=>{var n;if(i===qO.FALLBACK)return;const s=()=>{this.safeEmit(JO.CONNECTION_STATE_CHANGE,e,t,i)};if(CL.reportApiInvoke(this._sessionId||(null===(n=this._gateway.joinInfo)||void 0===n?void 0:n.sid)||null,{name:HO.CONNECTION_STATE_CHANGE,options:[e,t,i],tag:KO.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:i})),EL.info("[".concat(this._clientId,"] connection state change: ").concat(t," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void s();if("RECONNECTING"===e)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._is_pre_created||(e._audio_pre_subscribed||(e._audioSSRC=void 0,e._audioOrtc=void 0),e._video_pre_subscribed||(e._videoSSRC=void 0,e._videoOrtc=void 0,e._rtxSsrcId=void 0),e._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var r;this._streamFallbackTypeCacheMap.forEach(((e,t)=>{this._gateway.setStreamFallbackOption(t,e).catch((e=>{EL.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),e)}))})),this._remoteStreamTypeCacheMap.forEach(((e,t)=>{this._gateway.setRemoteVideoStreamType(t,e).catch((e=>{EL.warning("[".concat(this._clientId,"] auto set remote stream type failed"),e)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(r=this._joinInfo)||void 0===r?void 0:r.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{EL.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((e=>{EL.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(e))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._userOfflineTimeout=void 0,this._users.filter((e=>!e._trust_in_room_)).forEach((e=>{EL.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(e.uid)),this._handleUserOffline({uid:e.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((e=>{e._trust_audio_mute_state_||(EL.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,OG.AUDIO,!1)),e._trust_video_mute_state_||(EL.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,OG.VIDEO,!1)),e._trust_audio_enabled_state_||(EL.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(e.uid)),this._handleSetStreamLocalEnable("audio",e.uid,!0)),e._trust_video_enabled_state_||(EL.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(e.uid)),this._handleSetStreamLocalEnable("video",e.uid,!0)),e._trust_video_stream_added_state_||(EL.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(e.uid)),this._handleResetAddStream(e,"video")),e._trust_audio_stream_added_state_||(EL.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(e.uid)),this._handleResetAddStream(e,"audio")),e._video_added_||e._audio_added_||(EL.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(e.uid)),this._handleRemoveStream({uid:e.uid,uint_id:e._uintid}))})))}),1e3))}s()})),this._gateway.on(TG.REQUEST_NEW_GATEWAY_LIST,((e,t)=>{if(!this._joinInfo)return t(new eG(yO.UNEXPECTED_ERROR,"can not recover, no join info"));eW(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||MN,this.store).then((t=>{this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);const i=[];t.gatewayInfo.gatewayAddrs.forEach((e=>{let{address:t}=e;const[n,s]=t.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:n,port:s}):i.push({host:n,port:s})})),e(i)})).catch(t)})),this._gateway.on(TG.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(JO.NETWORK_QUALITY,e)})),this._gateway.on(TG.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(JO.STREAM_TYPE_CHANGED,e,t),CL.reportApiInvoke(this._sessionId,{name:HO.STREAM_TYPE_CHANGE,options:[e,t],tag:KO.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(TG.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(TG.NEED_RENEW_SESSION,(()=>{this._startSession()})),this._gateway.on(TG.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,i)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(e){i(e)}})),this._gateway.on(TG.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;const{dtlsParameters:i,iceParameters:n,candidates:s,rtpCapabilities:r,setup:o,cname:a}=bW(e.ortc,t);this._p2pChannel.connect(n,i,s,r,o,a)})),this._gateway.on(TG.REQUEST_DC_CONNECTION_PARAMS,(e=>{e(this._p2pChannel.getEstablishParams())})),this._gateway.on(TG.RESET_SIGNAL,(e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()})),this._gateway.on(TG.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(TG.DATACHANNEL_PRECONNECT,(async(e,t,i,n)=>{var s,r,o,a,c,d;await this._p2pChannel.startP2PConnection({turnServer:null===(s=this._joinInfo)||void 0===s?void 0:s.turnServer},!0);const l=function(e,t){let i;return t&&t.ip&&"number"==typeof t.port?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],EL.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),EL.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],i}(e,t);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(r=this._joinInfo)||void 0===r?void 0:r.apResponse.cid,"_").concat(null===(o=this._joinInfo)||void 0===o?void 0:o.apResponse.cert),icePwd:"".concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cid,"_").concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(d=JN("FINGERPRINT"))&&void 0!==d?d:e.fingerprint}]},l,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(i).catch(n)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(JB.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(JB.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(JB.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(JB.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(JB.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(JB.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)})),this._gateway.signal.on(JB.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(JB.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(JB.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,OG.AUDIO,!0))),this._gateway.signal.on(JB.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,OG.AUDIO,!1))),this._gateway.signal.on(JB.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,OG.VIDEO,!0))),this._gateway.signal.on(JB.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,OG.VIDEO,!1))),this._gateway.signal.on(JB.RECEIVE_METADATA,(e=>{const t=EN(e.metadata);this.safeEmit(JO.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(JB.ON_DATA_STREAM,(async e=>{if(!e)return;let t=EN(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&["aes-128-gcm2","aes-256-gcm2"].includes(this._encryptionMode)){if(e.payload.length<sL)throw new eG(yO.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(sL));t=await async function(e,t,i){const n=i.subarray(0,sL),s=n.slice(8,sL),r=(s[0]<<8)+s[1],o=(n[6]<<8)+n[7],a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:e,tagLength:tL,additionalData:new Uint8Array(ON(r,2))},t,i.subarray(sL));return new Uint8Array(a).subarray(0,o)}(this._encryptDataStreamIv,this._encryptDataStreamKey,t)}let i=0;if(e.ordered||e.syncWithAudio){const t=this._p2pChannel.getStats(),n=this.remoteUsers.find((t=>t.uid===e.uid)),s=null==t?void 0:t.audioRecv.find((e=>e.ssrc===(null==n?void 0:n._audioSSRC)));i=null==s?void 0:s.jitterBufferMs}null==i&&(i=0),lY(UB(UB({},e),{},{payload:t}),i,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(JB.ON_CRYPT_ERROR,(()=>{mN((()=>{EL.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(JO.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(JB.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(JB.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{EL.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,qO.TOKEN_EXPIRE),this.safeEmit(JO.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(JB.ON_STREAM_FALLBACK_UPDATE,(e=>{EL.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(JO.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")})),this._gateway.signal.on(JB.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),EL.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(JB.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(JB.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on($B.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case zB.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var i,n;const s=e.some((e=>{let{stream_type:t}=e;return t===gG.Audio})),r=e.some((e=>{let{stream_type:t}=e;return t!==gG.Audio})),o=e.some((e=>{let{stream_type:t}=e;return t===gG.Screen||t===gG.ScreenLow}));"offer"===t.state&&CL.publish(this._joinInfo.sid,{eventElapse:cW.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:yO.TIMEOUT,audio:s,video:r,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:o,audioName:s?null===(i=e.find((e=>{let{stream_type:t}=e;return t===gG.Audio})))||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId.toString():void 0,videoName:r?null===(n=e.find((e=>{let{stream_type:t}=e;return t!==gG.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0})}break}case zB.SUBSCRIBE:t&&CL.subscribe(this._joinInfo.sid,{succ:!1,ec:yO.TIMEOUT,audio:t.stream_type===OG.AUDIO,video:t.stream_type===OG.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:cW.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}})),this._gateway.signal.on(JB.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(JB.ON_PUBLISHED_USER_LIST,(e=>{if(null==e||!e.users)return;JN("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((e=>!wB(e.string_id||e.stream_id,this.channelName))));const t=[],i=[];for(const n of e.users){let e=this._users.find((e=>e._uintid===n.stream_id));e?e._trust_in_room_=!0:(e=new cH(n.string_id||n.stream_id,n.stream_id),this._users.push(e),0===this.getListeners(JO.PUBLISHED_USER_LIST).length&&(EL.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.safeEmit(JO.USER_JOINED,e)));const s=vG.Audio&n.stream_type,r=(vG.Video|vG.LwoVideo)&n.stream_type,o=0!=(65280&n.stream_type),a=s&&e.hasAudio,c=r&&e.hasVideo;r&&(e._trust_video_stream_added_state_=!0,e._video_added_=!0,e._videoSSRC=n.video_ssrc,e._rtxSsrcId=n.video_rtx),s&&(e._trust_audio_stream_added_state_=!0,e._audio_added_=!0,e._audioSSRC=n.audio_ssrc),s&&!a&&0===this.getListeners(JO.PUBLISHED_USER_LIST).length&&(EL.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published audio")),this.safeEmit(JO.USER_PUBLISHED,e,"audio")),r&&!c&&0===this.getListeners(JO.PUBLISHED_USER_LIST).length&&(EL.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published video")),this.safeEmit(JO.USER_PUBLISHED,e,"video")),(s&&!a||r&&!c||o)&&t.push(e),r&&this._p2pChannel.hasPendingRemoteMedia(e,"video")&&i.push({user:e,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(e,"audio")&&i.push({user:e,mediaType:"audio"})}i.length>0&&(EL.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(i).catch((e=>{EL.error("[".concat(this._clientId,"] mass resubscribe error"),e.toString())}))),this.getListeners(JO.PUBLISHED_USER_LIST).length>0?JN("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(EL.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map((e=>e.uid)).join(", "))),this.safeEmit(JO.PUBLISHED_USER_LIST,t)):EL.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map((e=>e.uid)).join(", ")))})),this._gateway.signal.on(JB.ON_RTP_CAPABILITY_CHANGE,(e=>{const{video_codec:t}=e;this._p2pChannel instanceof ZH&&this._p2pChannel.updateRemoteRTPCapabilities(t.map((e=>e.toLowerCase())).filter((e=>Object.keys(eL).includes(e))))}))}_handleP2PEvents(){this._gateway.signal.on(JB.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(KG.PUBLISH,((e,t,i)=>{const{uid:n}=e;e.forEach((e=>{const{kind:s,ssrcs:r,mid:o,isMuted:a}=e;this._handleP2PAddAudioOrVideoStream(s,n,r[0].ssrcId,o);const c=this._users.find((e=>e.uid===n));return c&&this._p2pChannel instanceof IH?this._p2pChannel.mockSubscribe(c,s,r[0].ssrcId,o).then((()=>{t()})).catch(i):t(),this._handleMuteStream(n,s,!!a)}))})),this._gateway.signal.on(KG.CALL,(async(e,t,i)=>{if(this._p2pChannel instanceof IH)try{var n;t(await this._p2pChannel.startP2P({turnServer:null===(n=this._joinInfo)||void 0===n?void 0:n.turnServer},e))}catch(e){i(e)}})),this._gateway.signal.on($B.P2P_CONNECTION,(async e=>{this._p2pChannel instanceof IH&&await this._p2pChannel.p2pConnect(e)})),this._gateway.signal.on(KG.UNPUBLISH,(async(e,t,i)=>{if(this._p2pChannel instanceof IH){const{unpubMsg:n,uid:s}=e,r=this._users.find((e=>e.uid===s));if(!r)return EL.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(s)),void t();try{n.forEach((async e=>{let{stream_type:t}=e;const i=t===gG.Audio?OG.AUDIO:OG.VIDEO;await this._p2pChannel.unsubscribe(r,i),this._handleMuteStream(s,i,!0)})),t()}catch(e){i(e)}}})),this._gateway.signal.on(KG.CONTROL,(async(e,t)=>{const{action:i}=e;switch(i){case qG.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,OG.VIDEO,!0);break;case qG.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,OG.AUDIO,!0);break;case qG.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,OG.VIDEO,!1);break;case qG.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,OG.AUDIO,!1)}})),this._gateway.signal.on(KG.RESTART_ICE,(async(e,t,i)=>{if(this._p2pChannel instanceof IH)try{const{direction:i,iceParameter:n}=e;i!==QB.SEND_ONLY||n?t(await this._p2pChannel.restartICE(i,n)):(this._p2pChannel.handleDisconnect(i),t())}catch(e){i(e)}})),this._gateway.signal.on(KG.CANDIDATE,(e=>{if(this._p2pChannel instanceof IH){const{candidate:t,direction:i}=e;this._p2pChannel.addRemoteCandidate(t,i)}})),this._p2pChannel.on(MG.RequestP2PRestartICE,(async(e,t,i)=>{try{const{direction:i}=e;t(await this._gateway.sendExtensionMessage(KG.RESTART_ICE,e,i===QB.SEND_ONLY))}catch(e){i(e)}})),this._p2pChannel.on(MG.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(KG.CANDIDATE,JSON.stringify(e),!0)})),this._p2pChannel.on(MG.RequestP2PMuteLocal,(async(e,t,i)=>{try{await this._gateway.sendExtensionMessage(KG.CONTROL,e,!0),t()}catch(e){i(e)}})),this._p2pChannel.on(MG.RequestP2PUnmuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===yO.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(MG.RequestP2PMuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===yO.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(MG.StateChange,((e,t)=>{t===kG.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(MG.RequestMuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===yO.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(MG.RequestUnmuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===yO.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(MG.RequestRePublish,((e,t,i)=>{this.publish(e,!1).then(t).catch(i)})),this._p2pChannel.on(MG.RequestRePublishDataChannel,((e,t,i)=>{Promise.all(e.map((async e=>{await this._p2pChannel.publishDataChannel([e]);const t={streamId:e.id,ordered:e.ordered,maxRetransmits:e.maxRetransmits,metadata:e.metadata,channelId:e._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==yO.DISCONNECT_P2P)throw e}}))).then(t).catch(i)})),this._p2pChannel.on(MG.RequestReSubscribe,(async(e,t,i)=>{try{for(const{user:t,kind:i}of e)i===OG.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){i(e)}})),this._p2pChannel.on(MG.RequestUpload,((e,t)=>{this._gateway.upload(e,t)})),this._p2pChannel.on(MG.RequestUploadStats,(e=>{this._gateway.uploadWRTCStats(e)})),this._p2pChannel.on(MG.MediaReconnectStart,(e=>{this.safeEmit(JO.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(MG.MediaReconnectEnd,(e=>{this.safeEmit(JO.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(MG.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(MG.RequestRestartICE,(async e=>{if(this._p2pChannel instanceof IH)return;const t=await this._p2pChannel.restartICE(e),i=await t.next();if(i.done)return;const n=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:n})}catch(e){return void t.throw(e)}const{iceParameters:r}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(s);await t.next({remoteIceParameters:r})})),this._p2pChannel.on(MG.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(MG.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:s,gatewayAddress:r}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:o,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:h}=bW(s,r);await this._p2pChannel.connect(a,o,c,d,l,h),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(MG.RequestUnpublishForReconnectPC,(async(e,t,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):i()})),this._p2pChannel.on(MG.P2PLost,(()=>{this.safeEmit(JO.P2P_LOST,this.store.uid)})),this._p2pChannel.on(MG.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(MG.ConnectionTypeChange,(e=>{this.safeEmit(JO.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(MG.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(MG.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new eG(yO.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new eG(yO.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach((e=>{if(!["supervise","moderation"].includes(e))throw new eG(yO.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(e," is not a valid inspect type."))})),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new eG(yO.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new bK(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},MN)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(IO(e,"enabled"),e){if(!t)throw new eG(yO.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(bO(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new eG(yO.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(t&&t.vendor&&t.vendor.length>1024)throw new eG(yO.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);const e=new nY(t);this._moderation=e,this.handleImageModerationEvents(this._moderation),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},MN)}catch(e){throw Array.isArray(e)?e[0]:e}}else{if(!this._moderation)throw new eG(yO.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}}setP2PTransport(e){if(function(e){AO(e,"transport",["default","auto","relay","sd-rtn"])}(e),"p2p"!==this.mode)throw new eG(yO.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,EL.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(WG.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(JO.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,i),t===jG.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new eG(yO.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(WG.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}handleVideoInspectEvents(e){e.on(FG.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(JO.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,i),i===UG.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(JO.CONTENT_INSPECT_ERROR,new eG(yO.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(FG.INSPECT_RESULT,((e,t)=>{var i;if((null==t?void 0:t.code)===yO.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return EL.debug("Stop inspect content because that has left channel"),null==this||null===(i=this._inspect)||void 0===i||i.close(),void(this._inspect=void 0);this.safeEmit(JO.CONTENT_INSPECT_RESULT,e,t)})),e.on(FG.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return EL.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){IO(e,"enabled"),XN("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}).prototype,"leave",[hY],Object.getOwnPropertyDescriptor(ZY.prototype,"leave"),ZY.prototype),VB(ZY.prototype,"publish",[uY],Object.getOwnPropertyDescriptor(ZY.prototype,"publish"),ZY.prototype),VB(ZY.prototype,"unpublish",[pY],Object.getOwnPropertyDescriptor(ZY.prototype,"unpublish"),ZY.prototype),VB(ZY.prototype,"subscribe",[fY],Object.getOwnPropertyDescriptor(ZY.prototype,"subscribe"),ZY.prototype),VB(ZY.prototype,"presubscribe",[mY],Object.getOwnPropertyDescriptor(ZY.prototype,"presubscribe"),ZY.prototype),VB(ZY.prototype,"massSubscribe",[EY],Object.getOwnPropertyDescriptor(ZY.prototype,"massSubscribe"),ZY.prototype),VB(ZY.prototype,"unsubscribe",[_Y],Object.getOwnPropertyDescriptor(ZY.prototype,"unsubscribe"),ZY.prototype),VB(ZY.prototype,"massUnsubscribe",[gY],Object.getOwnPropertyDescriptor(ZY.prototype,"massUnsubscribe"),ZY.prototype),VB(ZY.prototype,"setLowStreamParameter",[TY],Object.getOwnPropertyDescriptor(ZY.prototype,"setLowStreamParameter"),ZY.prototype),VB(ZY.prototype,"enableDualStream",[SY],Object.getOwnPropertyDescriptor(ZY.prototype,"enableDualStream"),ZY.prototype),VB(ZY.prototype,"disableDualStream",[vY],Object.getOwnPropertyDescriptor(ZY.prototype,"disableDualStream"),ZY.prototype),VB(ZY.prototype,"setClientRole",[RY],Object.getOwnPropertyDescriptor(ZY.prototype,"setClientRole"),ZY.prototype),VB(ZY.prototype,"setProxyServer",[yY],Object.getOwnPropertyDescriptor(ZY.prototype,"setProxyServer"),ZY.prototype),VB(ZY.prototype,"setTurnServer",[CY],Object.getOwnPropertyDescriptor(ZY.prototype,"setTurnServer"),ZY.prototype),VB(ZY.prototype,"setLicense",[IY],Object.getOwnPropertyDescriptor(ZY.prototype,"setLicense"),ZY.prototype),VB(ZY.prototype,"startProxyServer",[AY],Object.getOwnPropertyDescriptor(ZY.prototype,"startProxyServer"),ZY.prototype),VB(ZY.prototype,"stopProxyServer",[bY],Object.getOwnPropertyDescriptor(ZY.prototype,"stopProxyServer"),ZY.prototype),VB(ZY.prototype,"setLocalAccessPointsV2",[wY],Object.getOwnPropertyDescriptor(ZY.prototype,"setLocalAccessPointsV2"),ZY.prototype),VB(ZY.prototype,"setLocalAccessPoints",[DY],Object.getOwnPropertyDescriptor(ZY.prototype,"setLocalAccessPoints"),ZY.prototype),VB(ZY.prototype,"setRemoteDefaultVideoStreamType",[OY],Object.getOwnPropertyDescriptor(ZY.prototype,"setRemoteDefaultVideoStreamType"),ZY.prototype),VB(ZY.prototype,"setRemoteVideoStreamType",[NY],Object.getOwnPropertyDescriptor(ZY.prototype,"setRemoteVideoStreamType"),ZY.prototype),VB(ZY.prototype,"setStreamFallbackOption",[LY],Object.getOwnPropertyDescriptor(ZY.prototype,"setStreamFallbackOption"),ZY.prototype),VB(ZY.prototype,"setEncryptionConfig",[PY],Object.getOwnPropertyDescriptor(ZY.prototype,"setEncryptionConfig"),ZY.prototype),VB(ZY.prototype,"renewToken",[kY],Object.getOwnPropertyDescriptor(ZY.prototype,"renewToken"),ZY.prototype),VB(ZY.prototype,"enableAudioVolumeIndicator",[MY],Object.getOwnPropertyDescriptor(ZY.prototype,"enableAudioVolumeIndicator"),ZY.prototype),VB(ZY.prototype,"startLiveStreaming",[UY],Object.getOwnPropertyDescriptor(ZY.prototype,"startLiveStreaming"),ZY.prototype),VB(ZY.prototype,"setLiveTranscoding",[xY],Object.getOwnPropertyDescriptor(ZY.prototype,"setLiveTranscoding"),ZY.prototype),VB(ZY.prototype,"stopLiveStreaming",[FY],Object.getOwnPropertyDescriptor(ZY.prototype,"stopLiveStreaming"),ZY.prototype),VB(ZY.prototype,"addInjectStreamUrl",[VY],Object.getOwnPropertyDescriptor(ZY.prototype,"addInjectStreamUrl"),ZY.prototype),VB(ZY.prototype,"removeInjectStreamUrl",[BY],Object.getOwnPropertyDescriptor(ZY.prototype,"removeInjectStreamUrl"),ZY.prototype),VB(ZY.prototype,"startChannelMediaRelay",[GY],Object.getOwnPropertyDescriptor(ZY.prototype,"startChannelMediaRelay"),ZY.prototype),VB(ZY.prototype,"updateChannelMediaRelay",[jY],Object.getOwnPropertyDescriptor(ZY.prototype,"updateChannelMediaRelay"),ZY.prototype),VB(ZY.prototype,"stopChannelMediaRelay",[WY],Object.getOwnPropertyDescriptor(ZY.prototype,"stopChannelMediaRelay"),ZY.prototype),VB(ZY.prototype,"sendCustomReportMessage",[HY],Object.getOwnPropertyDescriptor(ZY.prototype,"sendCustomReportMessage"),ZY.prototype),VB(ZY.prototype,"pickSVCLayer",[KY],Object.getOwnPropertyDescriptor(ZY.prototype,"pickSVCLayer"),ZY.prototype),VB(ZY.prototype,"setRTMConfig",[YY],Object.getOwnPropertyDescriptor(ZY.prototype,"setRTMConfig"),ZY.prototype),VB(ZY.prototype,"enableContentInspect",[qY],Object.getOwnPropertyDescriptor(ZY.prototype,"enableContentInspect"),ZY.prototype),VB(ZY.prototype,"disableContentInspect",[$Y],Object.getOwnPropertyDescriptor(ZY.prototype,"disableContentInspect"),ZY.prototype),VB(ZY.prototype,"setImageModeration",[zY],Object.getOwnPropertyDescriptor(ZY.prototype,"setImageModeration"),ZY.prototype),VB(ZY.prototype,"setP2PTransport",[XY],Object.getOwnPropertyDescriptor(ZY.prototype,"setP2PTransport"),ZY.prototype),VB(ZY.prototype,"getJoinChannelServiceRecords",[JY],Object.getOwnPropertyDescriptor(ZY.prototype,"getJoinChannelServiceRecords"),ZY.prototype),VB(ZY.prototype,"setPublishAudioFilterEnabled",[QY],Object.getOwnPropertyDescriptor(ZY.prototype,"setPublishAudioFilterEnabled"),ZY.prototype),ZY);function tq(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const t=CL.reportApiInvoke(null,{name:HO.CREATE_CLIENT,options:[e],tag:KO.TRACER});try{!function(e){AO(e.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),AO(e.mode,"config.mode",["rtc","live","p2p"]),void 0!==e.audioCodec&&AO(e.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),void 0!==e.proxyServer&&DO(e.proxyServer,"config.proxyServer",1,1e4),void 0!==e.turnServer&&zO(e.turnServer),void 0!==e.httpRetryConfig&&YO(e.httpRetryConfig),void 0!==e.websocketRetryConfig&&YO(e.websocketRetryConfig)}(e)}catch(e){throw t.onError(e),e}return(uO(16,0,!0)||function(e,t,i){const n=sO();if(n.name!==eO.SAFARI||!n.osVersion)return!1;const s=n.version.split(".");return i?t&&Number(s[0])===e&&Number(s[1])<t||Number(s[0])<e:t?Number(s[0])===e&&Number(s[1])<=t||Number(s[0])<e:Number(s[0])<=e}(16,0,!0))&&("vp9"===e.codec&&(e.codec="vp8",EL.debug("browser not support vp9, force use vp8")),XN("UNSUPPORTED_VIDEO_CODEC",["vp9"])),void 0===e.audioCodec&&(e.audioCodec="opus"),t.onSuccess(),new eq(UB(UB({forceWaitGatewayResponse:!0},e),{},{role:["rtc","p2p"].includes(e.mode)?"host":e.role||"audience"}))}function iq(){const e=CL.reportApiInvoke(null,{name:HO.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:KO.TRACER});let t=!1;try{const e=window.RTCPeerConnection,i=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,n=window.WebSocket;t=!!(e&&i&&n)}catch(e){return EL.error("check system requirement failed: ",e),!1}let i=!1;const n=sO();n.name===eO.CHROME&&Number(n.version)>=58&&(!("WebKit"===iO.engine.name)||function(){const e=sO();if(aO()){if(e.os===ZD.MAC_OS)return!0;if(e.os===ZD.IOS){const e=iO.os.version&&iO.os.version.split(".");if(e&&14===Number(e[0])&&e[1]&&Number(e[1])>=3)return!0;if(e&&Number(e[0])>14)return!0}}return!1}())&&(i=!0),n.name===eO.FIREFOX&&Number(n.version)>=56&&(i=!0),n.name===eO.OPERA&&Number(n.version)>=45&&(i=!0),n.name===eO.SAFARI&&Number(n.version)>=11&&(i=!0),(TO()||sO().name===eO.QQ)&&(i=!0),EL.debug("checkSystemRequirements, api:",t,"browser",i);const s=t&&i;return e.onSuccess(s),s}class nq{constructor(e,t){this.id=0,this.element=void 0,this.peerPair=void 0,this.context=void 0,this.audioPlayerElement=void 0,this.audioTrack=void 0,nq.count+=1,this.id=nq.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const i="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(i),"complete"===e.iceGatheringState?e.localDescription:new Promise((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const i=await e(this.peerPair[0],"offer");await t(this.peerPair[1],i);const n=await e(this.peerPair[1],"answer");await t(this.peerPair[0],n)}catch(e){throw new eG(yO.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(t)}catch(e){throw new eG(yO.LOCAL_AEC_ERROR,e.toString()).print()}if(!t)throw new eG(yO.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=t.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){EL.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var sq,rq;nq.count=0;const oq=window.AudioContext||window.webkitAudioContext;new(sq=yL({report:CL}),VB((rq=class{constructor(){this.units=[],this.context=void 0}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return EL.debug("the system does not need to process local aec"),-1;this.context||(this.context=new oq);let t=this.units.find((t=>t&&t.getElement()===e));return t||(t=new nq(e,this.context),this.units.push(t)),t.startEchoCancellation(),EL.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return sO().name!==eO.SAFARI}}).prototype,"processExternalMediaAEC",[sq],Object.getOwnPropertyDescriptor(rq.prototype,"processExternalMediaAEC"),rq.prototype),rq);const aq=window||document;function cq(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!aq)return;const i=dq._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);const n=e=>{if(!(e&&e.blockedURI&&(dq.onSecurityPolicyViolation||dq.getListeners(GG.SECURITY_POLICY_VIOLATION).length>0)))return;const t=e.blockedURI;JN("CSP_DETECTED_HOSTNAME_LIST").some((e=>t.includes(e)))&&(dq.onSecurityPolicyViolation&&"function"==typeof dq.onSecurityPolicyViolation&&dq.onSecurityPolicyViolation(e),dq.getListeners(GG.SECURITY_POLICY_VIOLATION).length>0&&dq.safeEmit(GG.SECURITY_POLICY_VIOLATION,e))};i&&aq.removeEventListener("securitypolicyviolation",i),(t||e&&"function"==typeof e||dq.getListeners(GG.SECURITY_POLICY_VIOLATION).length>0)&&aq.addEventListener("securitypolicyviolation",n),dq._cspEventHandlerPointer=n}XN("PROCESS_ID","process-".concat(yN(8,""),"-").concat(yN(4,""),"-").concat(yN(4,""),"-").concat(yN(4,""),"-").concat(yN(12,""))),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void EL.error("Error loading sdk config",e.message)}if(e)try{const t=JSON.parse(window.atob(e)),i=Date.now();EL.debug("Loading global parameters from cache",t),Object.keys(t).forEach((e=>{if(Object.prototype.hasOwnProperty.call(zN,e)){const{value:n,expires:s}=t[e];if(s&&s<=i)return;QN[e]=n,zN[e]=n}}))}catch(t){EL.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(QN.AREAS)&&QN.AREAS.length>0&&Gj(QN.AREAS,!0);const dq=function(e){const t=new GO,i={},n={getListeners:t.getListeners.bind(t),on:(e,i)=>(function(e,t){e===GG.SECURITY_POLICY_VIOLATION&&cq(t,!0)}(e,i),t.on.bind(t)(e,i)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return UB(UB({},i),n)}();Object.defineProperties(dq,{onAudioAutoplayFailed:{get:()=>oF.onAudioAutoplayFailed,set:function(e){oF.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>oF.onAutoplayFailed,set:function(e){oF.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>dq._onSecurityPolicyViolation,set(e){dq._onSecurityPolicyViolation=e,cq(e)}},__CLIENT_LIST__:{get:()=>JN("SHOW_GLOBAL_CLIENT_LIST")?bB:[]}}),sF.on(wx.CAMERA_DEVICE_CHANGED,(e=>{EL.info("camera device changed",JSON.stringify(e)),dq.onCameraChanged&&dq.onCameraChanged(e),dq.safeEmit(GG.CAMERA_CHANGED,e)})),sF.on(wx.RECORDING_DEVICE_CHANGED,(e=>{EL.info("microphone device changed",JSON.stringify(e)),dq.onMicrophoneChanged&&dq.onMicrophoneChanged(e),dq.safeEmit(GG.MICROPHONE_CHANGED,e)})),sF.on(wx.PLAYOUT_DEVICE_CHANGED,(e=>{EL.debug("playout device changed",JSON.stringify(e)),dq.onPlaybackDeviceChanged&&dq.onPlaybackDeviceChanged(e),dq.safeEmit(GG.PLAYBACK_DEVICE_CHANGED,e)})),lF.onAutoplayFailed=()=>{EL.info("detect audio element autoplay failed"),oF.onAudioAutoplayFailed&&oF.onAudioAutoplayFailed()},Gx.on("autoplay-failed",(()=>{EL.info("detect webaudio autoplay failed"),oF.onAudioAutoplayFailed&&oF.onAudioAutoplayFailed(),dq.safeEmit(GG.AUTOPLAY_FAILED)})),Gx.on(sx.STATE_CHANGE,((e,t)=>{EL.info("audio context state changed: ".concat(t," => ").concat(e)),dq.onAudioContextStateChanged&&dq.onAudioContextStateChanged(e,t),dq.safeEmit(GG.AUDIO_CONTEXT_STATE_CHANGED,e,t)})),window&&(window.__ARTC__={ESM_BUNDLER:!0,ESM:!1,UMD:!1,DEV:!1,AgoraRTC:dq,__TRACK_LIST__:hx}),rN.on(eN.NETWORK_STATE_CHANGE,((e,t)=>{EL.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))}));var lq=function(e){var t=e?[e]:[];return{debug:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return EL.debug.apply(EL,fg(t).call(t,i))},info:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return EL.info.apply(EL,fg(t).call(t,i))},warning:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return EL.warn.apply(EL,fg(t).call(t,i))},warn:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return EL.warn.apply(EL,fg(t).call(t,i))},error:function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return EL.error.apply(EL,fg(t).call(t,i))},log:function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];return EL[e].apply(EL,fg(t).call(t,n))}}}("LivePlayer");function hq(){return!!document.createElement("video").canPlayType("application/vnd.apple.mpegurl")}function uq(){return Jb.isSupported()}function pq(){return uq()||hq()}function fq(){return!(!window||!window.RTCPeerConnection)&&iq()}function mq(e,t){var i=gg(e);if(Tg){var n=Tg(e);t&&(n=Ag(n).call(n,(function(t){return Mg(e,t).enumerable}))),i.push.apply(i,n)}return i}function Eq(e){var t=function(){if("undefined"==typeof Reflect||!Us)return!1;if(Us.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Us(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=XE(e);if(t){var s=XE(this).constructor;i=Us(n,arguments,s)}else i=n.apply(this,arguments);return HE(this,i)}}lq.info("current fls.js: ","0.0.1(2024/4/11 17:00:11)");var _q=Jb.Events,gq=Jb.ErrorTypes,Tq=function(t){WE(c,t);var i,n,s,r,o,a=Eq(c);function c(t,i,n){var s;return Ru(this,c),(s=a.call(this)).mode=e.MediaSource.HLS,s.url=void 0,s.element=void 0,s.hls=void 0,s.recoverTimes=0,s.url=t,s.element=i,s.element.muted=!1,hq()&&!uq()?(s.element.src=t,s.bindElementEvents(),HE(s)):(n=n||{},s.hls=new Jb(function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?mq(Object(i),!0).forEach((function(t){var n,s,r;n=e,s=t,r=i[t],(s=CE(s))in n?Ou(n,s,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[s]=r})):Bg?Object.defineProperties(e,Bg(i)):mq(Object(i)).forEach((function(t){Object.defineProperty(e,t,Mg(i,t))}))}return e}({},n)),s.bindEvents(),s.hls.loadSource(t),s.hls.attachMedia(i),pq()||(s.destroy(),setTimeout((function(){s.safeEmit(Qb.UNRECOVERABLE_ERROR,"not supported")}))),s)}return AE(c,[{key:"bindElementEvents",value:function(){var e=this;this.element.onsuspend=function(){return e.safeEmit(Qb.READY_FOR_PLAY)},this.element.oncanplay=function(){return e.safeEmit(Qb.READY_FOR_PLAY)},this.element.onerror=function(){return e.safeEmit(Qb.ERROR)}}},{key:"bindEvents",value:function(){var e=this;this.hls&&(this.hls.on(_q.MEDIA_ATTACHED,(function(){e.recoverTimes=0,lq.debug("media attached"),e.element.muted=!1,e.safeEmit(Qb.READY_FOR_PLAY)})),this.hls.on(_q.MANIFEST_PARSED,(function(e,t){lq.debug("manifest loaded, quality level: ".concat(t.levels.length))})),this.hls.on(_q.ERROR,(function(t,i){var n;if(i.fatal)switch(lq.warn(fg(n="hls media source error: ".concat(i.type," ")).call(n,i.details)),i.type){case gq.MEDIA_ERROR:if(2===e.recoverTimes){e.destroy(),e.safeEmit(Qb.UNRECOVERABLE_ERROR,i);break}1===e.recoverTimes&&e.hls&&e.hls.swapAudioCodec(),e.hls&&e.hls.recoverMediaError(),e.recoverTimes++;break;case gq.NETWORK_ERROR:e.safeEmit(Qb.ERROR,i);break;default:e.destroy(),e.safeEmit(Qb.UNRECOVERABLE_ERROR,i)}})))}},{key:"play",value:(o=vu(cg.mark((function e(){var t;return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.element.play();case 3:e.next=9;break;case 5:e.prev=5,e.t0=e.catch(0),lq.warn(fg(t="play error: ".concat(e.t0.name," ")).call(t,e.t0.message)),"NotAllowedError"===e.t0.name&&this.safeEmit(Qb.AUTOPLAY_PREVENTED);case 9:this.hls&&(this.hls.started||this.hls.startLoad(),this.hls.resumeBuffering());case 10:case"end":return e.stop()}}),e,this,[[0,5]])}))),function(){return o.apply(this,arguments)})},{key:"pause",value:(r=vu(cg.mark((function e(t){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.element.pause(),this.hls&&(t?this.hls.stopLoad():this.hls.pauseBuffering());case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"retry",value:(s=vu(cg.mark((function e(){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.switch(this.url);case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"switch",value:(n=vu(cg.mark((function e(t){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.url=t,this.hls?this.hls.loadSource(t):(this.element.src=t,lO()&&this.element.load());case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"setVolume",value:function(e){this.element.muted=e<=0,this.element.volume=e}},{key:"getVolume",value:function(){return this.element.volume}},{key:"destroy",value:(i=vu(cg.mark((function e(){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.hls?(this.recoverTimes=0,this.hls.destroy()):(this.element.src="",this.element.oncanplay=null,this.element.onsuspend=null,this.element.onerror=null);case 1:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})}]),c}(DS),Sq=Vn.includes;Di({target:"Array",proto:!0,forced:o((function(){return!Array(1).includes()}))},{includes:function(e){return Sq(this,e,arguments.length>1?arguments[1]:void 0)}});var vq=ME("Array").includes,Rq=te,yq=v,Cq=pt("match"),Iq=function(e){var t;return Rq(e)&&(void 0!==(t=e[Cq])?!!t:"RegExp"==yq(e))},Aq=TypeError,bq=pt("match"),wq=Di,Dq=function(e){if(Iq(e))throw Aq("The method doesn't accept regular expressions");return e},Oq=z,Nq=po,Lq=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[bq]=!1,"/./"[e](t)}catch(e){}}return!1},Pq=_("".indexOf);wq({target:"String",proto:!0,forced:!Lq("includes")},{includes:function(e){return!!~Pq(Nq(Oq(this)),Nq(Dq(e)),arguments.length>1?arguments[1]:void 0)}});var kq=ME("String").includes,Mq=ce,Uq=vq,xq=kq,Fq=Array.prototype,Vq=String.prototype,Bq=function(e){var t=e.includes;return e===Fq||Mq(Fq,e)&&t===Fq.includes?Uq:"string"==typeof e||e===Vq||Mq(Vq,e)&&t===Vq.includes?xq:t},Gq=n(Bq),jq=function(){};function Wq(){var e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:jq};return e.promise=new mg((function(t,i){e.resolve=function(i){e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(i),e.value=i)},e.reject=function(t){e.isFinished||(e.isRejected=!0,e.isFinished=!0,i(t))}})),e}function Hq(e){var t=Wq();return t.resolve(e),t}Di({target:"Array",stat:!0},{isArray:Lu});var Kq=n(ie.Array.isArray);var Yq=n(Fr);var qq=ni,$q=zr,zq=Jt,Xq=P,Jq=Xe,Qq=function(e,t,i,n){try{return n?t(qq(i)[0],i[1]):t(i)}catch(t){$q(e,"throw",t)}},Zq=Lr,e$=En,t$=kn,i$=Fu,n$=Kr,s$=Fr,r$=Array,o$=function(e){var t=Jq(e),i=e$(this),n=arguments.length,s=n>1?arguments[1]:void 0,r=void 0!==s;r&&(s=zq(s,n>2?arguments[2]:void 0));var o,a,c,d,l,h,u=s$(t),p=0;if(!u||this===r$&&Zq(u))for(o=t$(t),a=i?new this(o):r$(o);o>p;p++)h=r?s(t[p],p):t[p],i$(a,p,h);else for(l=(d=n$(t,u)).next,a=i?new this:[];!(c=Xq(l,d)).done;p++)h=r?Qq(d,s,[c.value,p],!0):c.value,i$(a,p,h);return a.length=p,a};Di({target:"Array",stat:!0,forced:!$l((function(e){Array.from(e)}))},{from:o$});var a$=ie.Array.from,c$=n(a$);function d$(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function l$(e,t){return function(e){if(Kq(e))return e}(e)||function(e,t){var i=null==e?null:void 0!==TE&&Yq(e)||e["@@iterator"];if(null!=i){var n,s,r,o,a=[],c=!0,d=!1;try{if(r=(i=i.call(e)).next,0===t){if(Object(i)!==i)return;c=!1}else for(;!(c=(n=r.call(i)).done)&&(w_(a).call(a,n.value),a.length!==t);c=!0);}catch(e){d=!0,s=e}finally{try{if(!c&&null!=i.return&&(o=i.return(),Object(o)!==o))return}finally{if(d)throw s}}return a}}(e,t)||function(e,t){var i;if(e){if("string"==typeof e)return d$(e,t);var n=rg(i=Object.prototype.toString.call(e)).call(i,8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?c$(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?d$(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var h$=n(a$),u$={CDN_DOMAIN:"agorartcfob.sd-rtn.com",CDN_BACKUP_DOMAIN:"agorartcfoa.agoraio.cn"};function p$(e){return u$[e]}var f$=/^rte:\/\/([^\/^\?]+)\/([^\/^\?]+)\/([^\/\?]+)(\?[^\?]+)?/,m$=/^rte:\/\/([^\/^\?]+)\/([^\/\?]+)(\?[^\?]+)?/,E$=/^https?:\/\/([^\/^\?]+)\/([^\/^\?]+)\/([^\/\|\?]+)\|([^\/]+)\.m3u8(\?[^\?]+)?/,_$=/^https?:\/\/([^\/^\?]+)\/([^\/^\?]+)\/([^\/\|\?]+)\.m3u8(\?[^\?]+)?/;function g$(e){if(y$(e))return S$(e);if(C$(e))return v$(e);throw new Error("unknown url: ".concat(e))}function T$(e){for(var t=/([^\/\?&]+)=([^\?&]+)/g,i={token:null,uid:null},n=[];(n=h$(t.exec(e)||[])).length>0;){var s=l$(n,3),r=s[1],o=s[2];"token"===r&&(i[r]=o),"userUid"!==r&&"uid"!==r||(i.uid=Number(o)||o)}return"null"===i.token&&(i.token=null),"null"===i.uid&&(i.uid=null),i}function S$(e){var t,i,n,s;if(f$.test(e)){var r=l$(h$(e.match(f$)||[]),5);t=r[1],i=r[2],n=r[3],s=r[4]}else{var o=l$(h$(e.match(m$)||[]),4);t=o[1],n=o[2],s=o[3]}var a={appid:t,appname:i,steamname:n,token:null,uid:null,cdnDomain:p$("CDN_DOMAIN")};if(!t||!i&&!n)throw new Error("Invalid rtc url: ".concat(e));var c=T$(s);return a.token=c.token,a.uid=c.uid,a}function v$(e){var t,i,n,s,r;if(E$.test(e)){var o=l$(h$(e.match(E$)||[]),6);t=o[1],i=o[2],n=o[3],s=o[4],r=o[5]}else{var a=l$(h$(e.match(_$)||[]),5);t=a[1],i=a[2],s=a[3],r=a[4]}var c={cdnDomain:t,appid:i,appname:n,steamname:s,token:null,uid:null};if(!t||!i||!n&&!s)throw new Error("Invalid hls url: ".concat(e));var d=T$(r);return c.token=d.token,c.uid=d.uid,c}function R$(e){var t,i,n,s;if("string"==typeof e){if(y$(e))return e;e=v$(e)}var r=e.appname?fg(t="".concat(e.appname,"/")).call(t,e.steamname):e.steamname;return fg(i=fg(n=fg(s="rte://".concat(e.appid,"/")).call(s,r,"?token=")).call(n,e.token,"&uid=")).call(i,e.uid)}function y$(e){return/^rte:\/\//.test(e)}function C$(e){return/^https?:\/\/.+\.m3u8/.test(e)}function I$(e){var t,i,n,s,r,o=e.appname?fg(t="".concat(e.appname,"|")).call(t,e.steamname):e.steamname;return fg(i=fg(n=fg(s=fg(r="https://".concat(e.cdnDomain,"/")).call(r,e.appid,"/")).call(s,o,".m3u8?token=")).call(n,e.token||e.appid,"&userUid=")).call(i,e.uid)}function A$(e){var t=function(){if("undefined"==typeof Reflect||!Us)return!1;if(Us.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Us(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=XE(e);if(t){var s=XE(this).constructor;i=Us(n,arguments,s)}else i=n.apply(this,arguments);return HE(this,i)}}var b$,w$,D$=function(t){WE(E,t);var i,n,s,r,o,a,c,d,l,h,u,p,f,m=A$(E);function E(t,i,n){var s;return Ru(this,E),(s=m.call(this)).mode=e.MediaSource.RTC,s.url=void 0,s.element=void 0,s.rtcConfig={mode:"live",codec:"h264"},s.rtc=void 0,s.host=void 0,s.channel=void 0,s.uid=void 0,s.state=e.RtcSourceState.CREATING,s.videoState=e.RtcMediaState.EMPTY,s.audioState=e.RtcMediaState.EMPTY,s.pendingRemoteUsers=[],s.videoTrack=void 0,s.audioTrack=void 0,s.audioDefer=void 0,s.videoDefer=void 0,s.onAutoplayFailed=function(){s.safeEmit(e.RtcSourceEvent.AUTOPLAY_PREVENTED)},s.onUserJoined=function(){var t=vu(cg.mark((function t(i){return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s.host){t.next=5;break}return t.next=3,s.playRemoteUser(i);case 3:t.next=6;break;case 5:s.pendingRemoteUsers.push(i);case 6:s.safeEmit(e.RtcSourceEvent.USER_STATE_CHANGED,{state:e.RtcUserState.JOINED,user:i,isHost:s.host&&s.host.uid===i.uid});case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),s.onUserLeft=function(){var t=vu(cg.mark((function t(i){var n,r,o,a,c,d,l,h;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(s.safeEmit(e.RtcSourceEvent.USER_STATE_CHANGED,{state:e.RtcUserState.LEFT,user:i,isHost:s.host&&s.host.uid===i.uid}),a=wS(n=s.pendingRemoteUsers).call(n,(function(e){return e.uid===i.uid})),-1===a){t.next=4;break}return t.abrupt("return",gS(c=s.pendingRemoteUsers).call(c,a,1));case 4:s.host&&s.host.uid===i.uid&&(s.audioDefer&&s.audioDefer.reject("user left"),s.videoDefer&&s.videoDefer.reject("user left")),d=wS(r=s.pendingRemoteUsers).call(r,(function(e){return e.hasVideo}))||wS(o=s.pendingRemoteUsers).call(o,(function(e){return e.hasVideo}))||0,s.pendingRemoteUsers.length>0&&(l=s.pendingRemoteUsers[d],gS(h=s.pendingRemoteUsers).call(h,d,1)),s.playRemoteUser(l);case 8:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),s.onUserUnpublished=function(){var t=vu(cg.mark((function t(i,n){var r;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r=s.host&&s.host.uid===i.uid,s.safeEmit(e.RtcSourceEvent.USER_STATE_CHANGED,{state:e.RtcUserState.UNPUBLISHED,user:i,mediaType:n,isHost:r}),"video"===n&&r&&(s.videoTrack=void 0,s.setVideoState(e.RtcMediaState.STOPPED),s.videoDefer=Wq(),s.playVideo().catch((function(){}))),"audio"===n&&r&&(s.audioTrack=void 0,s.setAudioState(e.RtcMediaState.STOPPED),s.audioDefer=Wq(),s.playAudio().catch((function(){})));case 4:case"end":return t.stop()}}),t)})));return function(e,i){return t.apply(this,arguments)}}(),s.onUserPublished=function(){var t=vu(cg.mark((function t(i,n){var r;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r=s.host&&s.host.uid===i.uid,s.safeEmit(e.RtcSourceEvent.USER_STATE_CHANGED,{state:e.RtcUserState.PUBLISHED,user:i,mediaType:n,isHost:r}),r){t.next=4;break}return t.abrupt("return");case 4:"video"===n&&s.videoDefer&&s.videoDefer.resolve(),"audio"===n&&s.audioDefer&&s.audioDefer.resolve();case 6:case"end":return t.stop()}}),t)})));return function(e,i){return t.apply(this,arguments)}}(),null!=n&&(s.rtcConfig=n),s.url=t,s.element=i,s.create(),dq.onAutoplayFailed=s.onAutoplayFailed,fq()||(s.destroy(),setTimeout((function(){s.safeEmit(Qb.UNRECOVERABLE_ERROR,"not supported")}))),s}return AE(E,[{key:"setState",value:function(t){this.state!==t&&(this.state=t,this.safeEmit(e.RtcSourceEvent.STATE_CHANGED,t))}},{key:"setVideoState",value:function(t){this.videoState!==t&&(this.videoState=t,this.safeEmit(e.RtcSourceEvent.VIDEO_STATE_CHANGED,t))}},{key:"setAudioState",value:function(t){this.audioState!==t&&(this.audioState=t,this.safeEmit(e.RtcSourceEvent.AUDIO_STATE_CHANGED,t))}},{key:"join",value:(f=vu(cg.mark((function t(){var i,n,s;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.setState(e.RtcSourceState.CONNECTING),n=S$(this.url),this.channel=n.appname?fg(i="".concat(n.appname,"|")).call(i,n.steamname):n.steamname,t.prev=3,t.next=6,this.rtc.join(n.appid,this.channel,n.token,n.uid);case 6:s=t.sent,this.uid="number"==typeof s?s:this.rtc.store.intUid,this.setState(e.RtcSourceState.CONNECTED),t.next=17;break;case 11:if(t.prev=11,t.t0=t.catch(3),this.setState(e.RtcSourceState.CONNECT_FAILED),this.onRtcError(t.t0)){t.next=17;break}throw t.t0;case 17:return this.state===e.RtcSourceState.CONNECTED&&this.bindEvents(),t.abrupt("return",this.state===e.RtcSourceState.CONNECTED);case 19:case"end":return t.stop()}}),t,this,[[3,11]])}))),function(){return f.apply(this,arguments)})},{key:"reset",value:function(t){EL.debug("reset rtc for ".concat(t)),this.audioDefer&&!this.audioDefer.isFinished&&(this.audioDefer.reject(t),this.audioDefer=void 0),this.videoDefer&&!this.videoDefer.isFinished&&(this.videoDefer.reject(t),this.videoDefer=void 0),this.videoTrack&&(this.videoTrack.stop(),this.videoTrack=void 0,this.host&&this.rtc.unsubscribe(this.host,"video"),this.setVideoState(e.RtcMediaState.EMPTY)),this.audioTrack&&(this.audioTrack.stop(),this.audioTrack=void 0,this.host&&this.rtc.unsubscribe(this.host,"audio"),this.setAudioState(e.RtcMediaState.EMPTY)),this.host=void 0,this.pendingRemoteUsers=[],this.unbindEvent()}},{key:"recreate",value:(p=vu(cg.mark((function e(){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.reset("switch url"),this.rtc&&this.rtc.leave(),e.abrupt("return",this.create());case 3:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)})},{key:"setVolume",value:function(e){return e=Math.min(e,1),this.audioTrack?(this.audioTrack.setVolume(100*e),e):-1}},{key:"getVolume",value:function(){return this.audioTrack?this.audioTrack.getVolumeLevel():-1}},{key:"playAudio",value:(u=vu(cg.mark((function t(){var i;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.host||this.host.hasAudio){t.next=4;break}return this.audioDefer&&!this.audioDefer.isFinished||(this.audioDefer=Wq()),t.next=4,this.audioDefer.promise;case 4:if(this.host){t.next=6;break}return t.abrupt("return");case 6:return t.prev=6,t.next=9,this.rtc.subscribe(this.host,"audio");case 9:i=t.sent,this.host&&this.host.hasAudio&&(this.audioTrack=i,this.audioTrack.play(),this.setAudioState(e.RtcMediaState.PLAYING)),t.next=18;break;case 13:if(t.prev=13,t.t0=t.catch(6),this.onRtcError(t.t0)){t.next=18;break}throw t.t0;case 18:case"end":return t.stop()}}),t,this,[[6,13]])}))),function(){return u.apply(this,arguments)})},{key:"playVideo",value:(h=vu(cg.mark((function t(){var i;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.host||this.host.hasVideo){t.next=4;break}return this.videoDefer&&!this.videoDefer.isFinished||(this.videoDefer=Wq()),t.next=4,this.videoDefer.promise;case 4:if(this.host){t.next=6;break}return t.abrupt("return");case 6:return t.prev=6,t.next=9,this.rtc.subscribe(this.host,"video");case 9:i=t.sent,this.host&&this.host.hasVideo&&(this.videoTrack=i,this.videoTrack.play(this.element,{fit:this.element.style.objectFit}),this.setVideoState(e.RtcMediaState.PLAYING)),t.next=18;break;case 13:if(t.prev=13,t.t0=t.catch(6),this.onRtcError(t.t0)){t.next=18;break}throw t.t0;case 18:case"end":return t.stop()}}),t,this,[[6,13]])}))),function(){return h.apply(this,arguments)})},{key:"pauseAudio",value:(l=vu(cg.mark((function t(i){var n,s;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=this.audioState===e.RtcMediaState.PLAYING,s=this.audioState===e.RtcMediaState.PAUSED,!this.audioTrack||!this.host||!n&&!s){t.next=9;break}if(n&&this.audioTrack.stop(),i){t.next=6;break}return t.abrupt("return",this.setAudioState(e.RtcMediaState.PAUSED));case 6:return t.next=8,this.rtc.unsubscribe(this.host,"audio");case 8:return t.abrupt("return",this.setAudioState(e.RtcMediaState.STOPPED));case 9:case"end":return t.stop()}}),t,this)}))),function(e){return l.apply(this,arguments)})},{key:"pauseVideo",value:(d=vu(cg.mark((function t(i){var n,s;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=this.videoState===e.RtcMediaState.PLAYING,s=this.videoState===e.RtcMediaState.PAUSED,!this.videoTrack||!this.host||!n&&!s){t.next=9;break}if(n&&this.videoTrack.stop(),i){t.next=6;break}return t.abrupt("return",this.setVideoState(e.RtcMediaState.PAUSED));case 6:return t.next=8,this.rtc.unsubscribe(this.host,"video");case 8:return t.abrupt("return",this.setVideoState(e.RtcMediaState.STOPPED));case 9:case"end":return t.stop()}}),t,this)}))),function(e){return d.apply(this,arguments)})},{key:"playRemoteUser",value:(c=vu(cg.mark((function t(i){return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:(!this.host||!i||this.host.uid!==i.uid)&&this.safeEmit(e.RtcSourceEvent.HOST_CHANGED,this.host,i),this.host=i,this.host&&this.safeEmit(Qb.READY_FOR_PLAY);case 4:case"end":return t.stop()}}),t,this)}))),function(e){return c.apply(this,arguments)})},{key:"bindEvents",value:function(){this.rtc.on("user-published",this.onUserPublished),this.rtc.on("user-unpublished",this.onUserUnpublished),this.rtc.on("user-joined",this.onUserJoined),this.rtc.on("user-left",this.onUserLeft)}},{key:"unbindEvent",value:function(){this.rtc.off("user-published",this.onUserPublished),this.rtc.off("user-unpublished",this.onUserUnpublished),this.rtc.off("user-joined",this.onUserJoined),this.rtc.off("user-left",this.onUserLeft)}},{key:"onRtcError",value:function(e){var t,i=e&&Gq(t=["INVALID_OPERATION","UNEXPECTED_ERROR","NO_ACTIVE_STATUS","INVALID_UINT_UID_FROM_STRING_UID","CAN_NOT_GET_GATEWAY_SERVER","UNEXPECTED_RESPONSE"]).call(t,e.code);return"UNEXPECTED_ERROR"===e.code&&"can not find remote track in user object"===e.message&&(i=!1),i&&this.safeEmit(Qb.UNRECOVERABLE_ERROR,e),i}},{key:"retry",value:(a=vu(cg.mark((function e(){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.reset("retry"),this.rtc.leave(),e.abrupt("return",this.join());case 3:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"pause",value:(o=vu(cg.mark((function e(t){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mg.all([this.pauseAudio(t),this.pauseVideo(t)]);case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"play",value:(r=vu(cg.mark((function t(){var i,n;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.videoTrack&&this.videoState===e.RtcMediaState.PAUSED&&(this.videoTrack.play(this.element),this.setVideoState(e.RtcMediaState.PLAYING)),this.audioTrack&&this.audioState===e.RtcMediaState.PAUSED&&(this.audioTrack.play(),this.setAudioState(e.RtcMediaState.PLAYING)),this.videoState!==e.RtcMediaState.PLAYING&&this.audioState!==e.RtcMediaState.PLAYING){t.next=6;break}return t.abrupt("return");case 6:if(this.state!==e.RtcSourceState.CONNECT_FAILED){t.next=9;break}return t.next=9,this.join();case 9:if(this.state!==e.RtcSourceState.CONNECT_FAILED){t.next=15;break}throw i="play failed: ".concat(this.host?"join failed":"no host"),EL.warn(i),n=new Error(i),this.safeEmit(Qb.ERROR,n),n;case 15:if(!this.host){t.next=18;break}return t.next=18,this.playRemoteUser(this.host);case 18:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"switch",value:(s=vu(cg.mark((function e(t){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t===this.url){e.next=4;break}return this.url=t,e.next=4,this.recreate();case 4:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"create",value:(n=vu(cg.mark((function t(){return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.setState(e.RtcSourceState.CREATING),this.setAudioState(e.RtcMediaState.EMPTY),this.setVideoState(e.RtcMediaState.EMPTY),this.rtc=tq(this.rtcConfig),this.setState(e.RtcSourceState.CREATED),t.next=7,this.join();case 7:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"getStats",value:function(){if(this.rtc&&this.host)return{audio:this.rtc.getRemoteAudioStats()[this.host.uid],video:this.rtc.getRemoteVideoStats()[this.host.uid]}}},{key:"destroy",value:(i=vu(cg.mark((function t(){return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(dq.off("autoplay-failed",this.onAutoplayFailed),this.reset("destroy"),this.setState(e.RtcSourceState.DESTROYED),!this.rtc){t.next=6;break}return t.next=6,this.rtc.leave().catch((function(e){EL.warn("leave rtc failed: ".concat(e))}));case 6:case"end":return t.stop()}}),t,this)}))),function(){return i.apply(this,arguments)})}]),E}(DS);function O$(e){var t=function(){if("undefined"==typeof Reflect||!Us)return!1;if(Us.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Us(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,n=XE(e);if(t){var s=XE(this).constructor;i=Us(n,arguments,s)}else i=n.apply(this,arguments);return HE(this,i)}}function N$(e){var t=e.el,i=e.width,n=e.height,s=e.aspectRatio,r=e.objectFit,o="string"==typeof t?document.getElementById(t):t||document.createElement("video");if(!o||"VIDEO"!==o.tagName)throw new Error("Invalid video element: ".concat(t));return null!=i&&(o.style.width="".concat(i,"px")),null!=n&&(o.style.height="".concat(n,"px")),null!=s&&(o.style.aspectRatio="".concat(s)),o.setAttribute("playsinline","true"),o.setAttribute("webkit-playsinline","true"),o.setAttribute("x5-playsinline","true"),o.setAttribute("mediatype","video"),o.style.objectFit=r||"cover",o}e.MediaPlayState=void 0,(b$=e.MediaPlayState||(e.MediaPlayState={})).PENDING="pending",b$.PLAYING="playing",b$.PAUSED="paused",b$.STOPPED="stopped",e.PlayerEvent=void 0,(w$=e.PlayerEvent||(e.PlayerEvent={})).RTC_USER_STATE_CHANGED="rtc-user-state-changed",w$.RTC_SOURCE_STATE_CHANGED="rtc-source-state-changed",w$.RTC_HOST_CHANGED="rtc-host-changed",w$.RTC_MEDIA_CHANGED="rtc-media-changed",w$.PLAY_STATE_CHANGED="play-state-changed",w$.MEDIA_SOURCE_CHANGED="media-source-changed",w$.AUTOPLAY_PREVENTED="autoplay-prevented",w$.ERROR="error",w$.REQUEST_SWITCH_MEDIA_SOURCE="request-switch-media-source";var L$=function(t){WE(d,t);var i,n,s,r,o,a,c=O$(d);function d(t){var i,n;if(Ru(this,d),(n=c.call(this)).source=void 0,n.element=void 0,n.options=void 0,n.urlInfo=void 0,n.autoSwitchHLS=!0,n.isMirror=!1,n.playDefer=Hq(!1),n.pauseDefer=Hq(!1),n.retryDefer=Hq(!1),n.switchUrlDefer=Hq(!1),n.switchSourceDefer=Hq(!1),n._playState=e.MediaPlayState.STOPPED,lq.info(fg(i="compatibility: rtc ".concat(fq(),", hls: ")).call(i,pq())),!fq()&&!pq())throw new Error("Not support RTC and HLS!");!fq()&&t.autoSwitchHLS&&(lq.warn("Not support RTC, auto fallback to HLS."),t.defaultUseHLS=!0),n.options=t,null!=t.autoSwitchHLS&&(n.autoSwitchHLS=!!t.autoSwitchHLS),t.autoplay&&(n.playState=e.MediaPlayState.PENDING),n.element=N$(t);var s=t.url;if(n.urlInfo=g$(s),n.urlInfo.cdnDomain=u$.CDN_DOMAIN,t.defaultUseHLS&&!n.urlInfo.uid)throw new Error("Invalid url: uid is required when use hls as default.");return n.source=t.defaultUseHLS||C$(s)?new Tq(I$(n.urlInfo),n.element,t.hlsConfig):new D$(R$(n.urlInfo),n.element,t.rtcConfig),n.mirror(!!t.mirror),n.bindMediaEvents(),n}return AE(d,[{key:"playState",get:function(){return this._playState},set:function(t){var i;t!==this._playState&&(lq.debug(fg(i="play state change: ".concat(this._playState," => ")).call(i,t)),this.safeEmit(e.PlayerEvent.PLAY_STATE_CHANGED,t,this._playState),this._playState=t)}},{key:"isPlaying",get:function(){return this.playState===e.MediaPlayState.PLAYING}},{key:"isPaused",get:function(){return this.playState===e.MediaPlayState.PAUSED}},{key:"isStopped",get:function(){return this.playState===e.MediaPlayState.STOPPED}},{key:"bindMediaEvents",value:function(){var t=this;"rtc"===this.source.mode&&(this.source.on(e.RtcSourceEvent.AUDIO_STATE_CHANGED,(function(i){t.safeEmit(e.PlayerEvent.RTC_MEDIA_CHANGED,{type:"audio",state:i})})),this.source.on(e.RtcSourceEvent.VIDEO_STATE_CHANGED,(function(i){t.safeEmit(e.PlayerEvent.RTC_MEDIA_CHANGED,{type:"video",state:i})})),this.source.on(e.RtcSourceEvent.AUTOPLAY_PREVENTED,(function(){t.safeEmit(e.PlayerEvent.AUTOPLAY_PREVENTED)})),this.source.on(e.RtcSourceEvent.STATE_CHANGED,(function(i){i===e.RtcSourceState.CONNECTED&&(t.urlInfo.uid=t.source.uid||t.urlInfo.uid),t.safeEmit(e.PlayerEvent.RTC_SOURCE_STATE_CHANGED,i)})),this.source.on(e.RtcSourceEvent.HOST_CHANGED,(function(i,n){t.safeEmit(e.PlayerEvent.RTC_HOST_CHANGED,n,i)})),this.source.on(e.RtcSourceEvent.USER_STATE_CHANGED,(function(i){t.safeEmit(e.PlayerEvent.RTC_USER_STATE_CHANGED,i)}))),"hls"===this.source.mode&&this.source.on(Qb.AUTOPLAY_PREVENTED,(function(){t.safeEmit(e.PlayerEvent.AUTOPLAY_PREVENTED)})),this.source.on(Qb.ERROR,(function(i){var n;if(lq.warning(fg(n="error: ".concat(i.message||i.details," at ")).call(n,t.source.mode," mode.")),"hls"===t.source.mode&&t.urlInfo.cdnDomain!==u$.CDN_BACKUP_DOMAIN)return t.urlInfo.cdnDomain=u$.CDN_BACKUP_DOMAIN,t.switchURL(I$(t.urlInfo));t.safeEmit(e.PlayerEvent.ERROR,i)})),this.source.on(Qb.READY_FOR_PLAY,(function(){lq.info("ready for play, current play state: ".concat(t._playState)),t.isPaused||t.isStopped||("rtc"===t.source.mode?mg.all([t.source.playAudio(),t.source.playVideo()]).then((function(){t.playState=e.MediaPlayState.PLAYING})).catch((function(e){lq.warning("play abort: ".concat(e," at rtc mode."))})):(t.source.play(),t.playState=e.MediaPlayState.PLAYING))})),this.source.on(Qb.UNRECOVERABLE_ERROR,(function(i){var n;lq.warning(fg(n="unrecoverable error: ".concat(i.message||i.details||i," at ")).call(n,t.source.mode," mode."));var s="rtc"===t.source.mode,r="hls"===t.source.mode,o=s?e.MediaSource.HLS:e.MediaSource.RTC;s&&t.autoSwitchHLS&&pq()?t.switchMediaSource(o):r&&t.urlInfo.cdnDomain!==u$.CDN_BACKUP_DOMAIN&&pq()?(t.urlInfo.cdnDomain=u$.CDN_BACKUP_DOMAIN,t.unbindMediaEvents(),t.source=new Tq(I$(t.urlInfo),t.element,t.options.hlsConfig),t.bindMediaEvents()):t.safeEmit(e.PlayerEvent.REQUEST_SWITCH_MEDIA_SOURCE,o)}))}},{key:"unbindMediaEvents",value:function(){"rtc"===this.source.mode&&(this.source.removeAllListeners(e.RtcSourceEvent.AUDIO_STATE_CHANGED),this.source.removeAllListeners(e.RtcSourceEvent.VIDEO_STATE_CHANGED),this.source.removeAllListeners(e.RtcSourceEvent.AUTOPLAY_PREVENTED),this.source.removeAllListeners(e.RtcSourceEvent.STATE_CHANGED),this.source.removeAllListeners(e.RtcSourceEvent.HOST_CHANGED),this.source.removeAllListeners(e.RtcSourceEvent.USER_STATE_CHANGED)),this.source.mode,this.source.removeAllListeners(Qb.ERROR),this.source.removeAllListeners(Qb.READY_FOR_PLAY),this.source.removeAllListeners(Qb.UNRECOVERABLE_ERROR)}},{key:"play",value:(a=vu(cg.mark((function t(){var i;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,mg.all([this.playDefer.promise,this.switchUrlDefer.promise,this.pauseDefer.promise]);case 2:return this.playDefer=Wq(),i=this.playState,t.prev=4,this.playState=e.MediaPlayState.PENDING,t.next=8,this.source.play();case 8:this.playState=e.MediaPlayState.PLAYING,t.next=16;break;case 11:throw t.prev=11,t.t0=t.catch(4),lq.warn("play error: ".concat(t.t0)),this.playState=i,t.t0;case 16:return t.prev=16,this.playDefer.resolve(!0),t.finish(16);case 19:case"end":return t.stop()}}),t,this,[[4,11,16,19]])}))),function(){return a.apply(this,arguments)})},{key:"pause",value:(o=vu(cg.mark((function t(i){return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,mg.all([this.switchUrlDefer.promise,this.pauseDefer.promise,this.playDefer.promise]);case 2:if(!(this.isPaused&&!i||this.isStopped)){t.next=4;break}return t.abrupt("return");case 4:return this.pauseDefer=Wq(),t.prev=5,t.next=8,this.source.pause(i);case 8:this.playState=this.playState===e.MediaPlayState.STOPPED||i?e.MediaPlayState.STOPPED:e.MediaPlayState.PAUSED,t.next=14;break;case 11:t.prev=11,t.t0=t.catch(5),lq.warn("pause error: ".concat(t.t0));case 14:return t.prev=14,this.pauseDefer.resolve(!0),t.finish(14);case 17:case"end":return t.stop()}}),t,this,[[5,11,14,17]])}))),function(e){return o.apply(this,arguments)})},{key:"retry",value:(r=vu(cg.mark((function e(){return cg.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,mg.all([this.playDefer.promise,this.pauseDefer.promise,this.switchUrlDefer.promise,this.retryDefer.promise]);case 2:return this.retryDefer=Wq(),e.prev=3,lq.info("retry at ".concat(this.source.mode," mode")),e.next=7,this.source.retry();case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),lq.warn("retry error: ".concat(e.t0));case 12:return e.prev=12,this.retryDefer.resolve(!0),e.finish(12);case 15:case"end":return e.stop()}}),e,this,[[3,9,12,15]])}))),function(){return r.apply(this,arguments)})},{key:"switchURL",value:(s=vu(cg.mark((function t(i){var n;return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.switchUrlDefer.promise;case 2:if(i!==this.options.url){t.next=4;break}return t.abrupt("return");case 4:if(this.switchUrlDefer=Wq(),t.prev=5,lq.info("switch url to ".concat(i)),this.options.url=i,this.urlInfo=g$(i),"rtc"!==this.source.mode||!y$(i)){t.next=14;break}return t.next=12,this.source.switch(R$(this.urlInfo));case 12:t.next=20;break;case 14:if("hls"!==this.source.mode||!C$(i)){t.next=19;break}return t.next=17,this.source.switch(I$(this.urlInfo));case 17:t.next=20;break;case 19:y$(i)?this.switchMediaSource(e.MediaSource.RTC):C$(i)?this.switchMediaSource(e.MediaSource.HLS):lq.warn("unknown url: ".concat(i));case 20:t.next=25;break;case 22:t.prev=22,t.t0=t.catch(5),lq.warn(fg(n="switchURL error: ".concat(t.t0,", url: ")).call(n,i));case 25:return t.prev=25,this.switchUrlDefer.resolve(!0),t.finish(25);case 28:case"end":return t.stop()}}),t,this,[[5,22,25,28]])}))),function(e){return s.apply(this,arguments)})},{key:"switchMediaSource",value:(n=vu(cg.mark((function t(i){return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.source.mode!==i){t.next=2;break}return t.abrupt("return");case 2:return this.unbindMediaEvents(),t.next=5,this.source.destroy();case 5:"hls"===i?(uO(14,6,!0)&&this.replaceNewVideoElement(),this.source=new Tq(I$(this.urlInfo),this.element,this.options.hlsConfig)):this.source=new D$(R$(this.urlInfo),this.element,this.options.rtcConfig),this.bindMediaEvents(),lq.debug("media source change to ".concat(this.source.mode)),this.safeEmit(e.PlayerEvent.MEDIA_SOURCE_CHANGED,this.source.mode);case 9:case"end":return t.stop()}}),t,this)}))),function(e){return n.apply(this,arguments)})},{key:"mirror",value:function(e){this.isMirror=null!=e?e:!this.isMirror,this.element.style.transform="rotateY(".concat(this.isMirror?180:0,"deg)")}},{key:"destroy",value:(i=vu(cg.mark((function t(){return cg.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.source.destroy();case 2:this.unbindMediaEvents(),this.playState=e.MediaPlayState.STOPPED,!this.playDefer.isFinished&&this.playDefer.reject(!1),!this.pauseDefer.isFinished&&this.pauseDefer.reject(!1),!this.retryDefer.isFinished&&this.retryDefer.reject(!1),!this.switchUrlDefer.isFinished&&this.switchUrlDefer.reject(!1),!this.switchSourceDefer.isFinished&&this.switchSourceDefer.reject(!1),this.pauseDefer=Hq(!1),this.retryDefer=Hq(!1),this.playDefer=Hq(!1),this.switchUrlDefer=Hq(!1);case 13:case"end":return t.stop()}}),t,this)}))),function(){return i.apply(this,arguments)})},{key:"setVolume",value:function(e){e>1&&(e=1),e<0&&(e=0),this.source.setVolume(e)}},{key:"getVolume",value:function(){return this.source.getVolume()}},{key:"replaceNewVideoElement",value:function(){lq.info("replace video element");var e=document.createElement("video");this.options.el=e,this.element.replaceWith(e),this.element=N$(this.options)}}]),d}(DS);L$.isHlsSupported=pq,L$.isRtcSupported=fq,e.LivePlayer=L$,e.disableLogUpload=function(){JN("USE_NEW_LOG")?XN("UPLOAD_LOG",!1):EL.disableLogUpload()},e.enableLogUpload=function(){JN("USE_NEW_LOG")?XN("UPLOAD_LOG",!0):EL.enableLogUpload()},e.enableNewNetworkConfig=function(){XN("WEBCS_DOMAIN",["webrtc2-2.ap.sd-rtn.com"]),XN("WEBCS_DOMAIN_BACKUP_LIST",["webrtc2-4.ap.sd-rtn.com"]),XN("CDS_AP",["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"]),XN("ACCOUNT_REGISTER",["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"]),XN("EVENT_REPORT_DOMAIN","web-2.statscollector.sd-rtn.com"),XN("EVENT_REPORT_BACKUP_DOMAIN","statscollector-1.agora.io"),XN("GATEWAY_DOMAINS",["edge.sd-rtn.com"])},e.getParameters=p$,e.setLogLevel=function(e){EL.setLogLevel(e)},e.setParameters=function(e,t){var i;EL.info(fg(i="set ".concat(e," to ")).call(i,t)),u$[e]=t},e.setRTCParameters=function(e,t){XN(e,t)}}));
