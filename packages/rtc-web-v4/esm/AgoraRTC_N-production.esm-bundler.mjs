/**
 * AgoraWebSDK_N-v4.19.0-0-gd4901fde-dirty Copyright AgoraInc.
 */

import"webrtc-adapter";import{AgoraRTCEventReport as e,logger as t,report as i,AgoraRTCEvent as n,AgoraRTCEventUploadType as s,apiInvoke as o,isEventCustomReportParams as r}from"@agora-js/report";import{IS_GLOBAL_VERSION as a,MUTABLE_PARAMS as c,MUTABLE_PARAMS_LOCAL_CACHE as d,AgoraRTCError as l,AgoraRTCErrorCode as h,isValidString as u,isEmpty as p,checkValidNumber as _,checkValidBoolean as E,checkValidEnum as m,checkValidString as f,checkValidArray as S,EventEmitter as g,getParameter as T,createDefer as C,isMacOS as R,isFirefox as I,PromiseMutex as v,NETWORK_STATE as y,networkIndicator as A,NETWORK_INDICATOR_EVENTS as w,getRetryWaitTime as O,wait as N,emitAsPromise as b,emitAsInvokerNoResponse as D,Rolling as P,ConnectionDisconnectedReason as L,WebSocketQuitReason as k,getRandomString as M,emitAsInvoker as U,SHA256 as V,setBigUint64 as x,getBigUint64 as F,uint8ArrayToBase64 as j,base64ToUint8Array as B,withTimeout as G,nextTick as W,VERSION as H,setParameter as K,getUTF8StringByteLength as q,getMultiUnilbsFormDataByteLength as Y,AgoraAPIName as J,AgoraAPITag as X,retryable as z,getBrowserInfo as Q,DEFAULT_RETRY_CONFIG as Z,noop as $,generateSessionID as ee,jsonClone as te,BrowserName as ie,BrowserOS as ne,isSafari as se,isIOS as oe,isRTCIceServerList as re,isChromeKernel as ae,isChromeBelow90 as ce,isBelowIOS14_6 as de,emitAsPromiseNoResponse as le,isSupportedMobile as he,getUniqueList as ue,ClientEvents as pe,isClientConfig as _e,removeItemFromList as Ee,SDKStore as me,BUILD as fe,isClientRoleOptions as Se,concurrent as ge,isHttpsEnv as Te,supportIsSecureContext as Ce,encryptRSA as Re,isClientRole as Ie,isTurnServerConfig as ve,isEncryptionMode as ye,runOnce as Ae,isWebKit as we,isSupportedWkWebview as Oe,isWechatBrowser as Ne,isQQBrowser as be,isWkWebview as De,generateProcessID as Pe}from"@agora-js/shared";export{AudienceLatencyLevelType,BUILD,ConnectionDisconnectedReason,VERSION,getParameter}from"@agora-js/shared";import{MixingAudioTrack as Le,DEFAULT_LOCAL_AUDIO_TRACK_STATS as ke,DEFAULT_LOCAL_VIDEO_TRACK_STATS as Me,DEFAULT_REMOTE_AUDIO_TRACK_STATS as Ue,DEFAULT_REMOTE_VIDEO_TRACK_STATS as Ve,DEFAULT_NETWORK_QUALITY_STATS as xe,MediaElementNumStatus as Fe,visibilityWatcher as je,audioElementPlayCenter as Be,LocalAudioTrack as Ge,LocalVideoTrack as We,TrackHint as He,getCompatibility as Ke,LocalTrack as qe,audioTimerLoop as Ye,MicrophoneAudioTrack as Je,RemoteAudioTrack as Xe,RemoteVideoTrack as ze,TrackInternalEvent as Qe,RemoteTrackEvents as Ze,TrackEvents as $e,StreamType as et,frameData2CryptoBuffer as tt,LocalDataChannel as it,RemoteStreamType as nt,isLowStreamParameter as st,RemoteDataChannel as ot,updateAgoraRTCCompatibility as rt,autoPlayGestureEventEmitter as at,deviceManager as ct,DeviceManagerEvent as dt,audioContextState as lt,__TRACK_LIST__ as ht}from"@agora-js/media";export{RemoteStreamFallbackType,RemoteStreamType,__TRACK_LIST__,audioElementPlayCenter,createBufferSourceAudioTrack,createCameraVideoTrack,createCustomAudioTrack,createCustomVideoTrack,createMicrophoneAndCameraTracks,createMicrophoneAudioTrack,createScreenVideoTrack,getElectronScreenSources}from"@agora-js/media";import ut from"axios";import"formdata-polyfill";var pt="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function _t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Et=function(e){try{return!!e()}catch(e){return!0}},mt=!Et((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")})),ft=mt,St=Function.prototype,gt=St.call,Tt=ft&&St.bind.bind(gt,gt),Ct=ft?Tt:function(e){return function(){return gt.apply(e,arguments)}},Rt=Ct({}.isPrototypeOf),It=function(e){return e&&e.Math==Math&&e},vt=It("object"==typeof globalThis&&globalThis)||It("object"==typeof window&&window)||It("object"==typeof self&&self)||It("object"==typeof pt&&pt)||function(){return this}()||pt||Function("return this")(),yt=mt,At=Function.prototype,wt=At.apply,Ot=At.call,Nt="object"==typeof Reflect&&Reflect.apply||(yt?Ot.bind(wt):function(){return Ot.apply(wt,arguments)}),bt=Ct,Dt=bt({}.toString),Pt=bt("".slice),Lt=function(e){return Pt(Dt(e),8,-1)},kt=Lt,Mt=Ct,Ut=function(e){if("Function"===kt(e))return Mt(e)},Vt="object"==typeof document&&document.all,xt={all:Vt,IS_HTMLDDA:void 0===Vt&&void 0!==Vt},Ft=xt.all,jt=xt.IS_HTMLDDA?function(e){return"function"==typeof e||e===Ft}:function(e){return"function"==typeof e},Bt={},Gt=!Et((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),Wt=mt,Ht=Function.prototype.call,Kt=Wt?Ht.bind(Ht):function(){return Ht.apply(Ht,arguments)},qt={},Yt={}.propertyIsEnumerable,Jt=Object.getOwnPropertyDescriptor,Xt=Jt&&!Yt.call({1:2},1);qt.f=Xt?function(e){var t=Jt(this,e);return!!t&&t.enumerable}:Yt;var zt,Qt,Zt=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},$t=Et,ei=Lt,ti=Object,ii=Ct("".split),ni=$t((function(){return!ti("z").propertyIsEnumerable(0)}))?function(e){return"String"==ei(e)?ii(e,""):ti(e)}:ti,si=function(e){return null==e},oi=si,ri=TypeError,ai=function(e){if(oi(e))throw ri("Can't call method on "+e);return e},ci=ni,di=ai,li=function(e){return ci(di(e))},hi=jt,ui=xt.all,pi=xt.IS_HTMLDDA?function(e){return"object"==typeof e?null!==e:hi(e)||e===ui}:function(e){return"object"==typeof e?null!==e:hi(e)},_i={},Ei=_i,mi=vt,fi=jt,Si=function(e){return fi(e)?e:void 0},gi=function(e,t){return arguments.length<2?Si(Ei[e])||Si(mi[e]):Ei[e]&&Ei[e][t]||mi[e]&&mi[e][t]},Ti="undefined"!=typeof navigator&&String(navigator.userAgent)||"",Ci=vt,Ri=Ti,Ii=Ci.process,vi=Ci.Deno,yi=Ii&&Ii.versions||vi&&vi.version,Ai=yi&&yi.v8;Ai&&(Qt=(zt=Ai.split("."))[0]>0&&zt[0]<4?1:+(zt[0]+zt[1])),!Qt&&Ri&&(!(zt=Ri.match(/Edge\/(\d+)/))||zt[1]>=74)&&(zt=Ri.match(/Chrome\/(\d+)/))&&(Qt=+zt[1]);var wi=Qt,Oi=wi,Ni=Et,bi=vt.String,Di=!!Object.getOwnPropertySymbols&&!Ni((function(){var e=Symbol();return!bi(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Oi&&Oi<41})),Pi=Di&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,Li=gi,ki=jt,Mi=Rt,Ui=Object,Vi=Pi?function(e){return"symbol"==typeof e}:function(e){var t=Li("Symbol");return ki(t)&&Mi(t.prototype,Ui(e))},xi=String,Fi=function(e){try{return xi(e)}catch(e){return"Object"}},ji=jt,Bi=Fi,Gi=TypeError,Wi=function(e){if(ji(e))return e;throw Gi(Bi(e)+" is not a function")},Hi=Wi,Ki=si,qi=function(e,t){var i=e[t];return Ki(i)?void 0:Hi(i)},Yi=Kt,Ji=jt,Xi=pi,zi=TypeError,Qi={exports:{}},Zi=vt,$i=Object.defineProperty,en=function(e,t){try{$i(Zi,e,{value:t,configurable:!0,writable:!0})}catch(i){Zi[e]=t}return t},tn="__core-js_shared__",nn=vt[tn]||en(tn,{}),sn=nn;(Qi.exports=function(e,t){return sn[e]||(sn[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"Â© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var on=Qi.exports,rn=ai,an=Object,cn=function(e){return an(rn(e))},dn=cn,ln=Ct({}.hasOwnProperty),hn=Object.hasOwn||function(e,t){return ln(dn(e),t)},un=Ct,pn=0,_n=Math.random(),En=un(1..toString),mn=function(e){return"Symbol("+(void 0===e?"":e)+")_"+En(++pn+_n,36)},fn=on,Sn=hn,gn=mn,Tn=Di,Cn=Pi,Rn=vt.Symbol,In=fn("wks"),vn=Cn?Rn.for||Rn:Rn&&Rn.withoutSetter||gn,yn=function(e){return Sn(In,e)||(In[e]=Tn&&Sn(Rn,e)?Rn[e]:vn("Symbol."+e)),In[e]},An=Kt,wn=pi,On=Vi,Nn=qi,bn=function(e,t){var i,n;if("string"===t&&Ji(i=e.toString)&&!Xi(n=Yi(i,e)))return n;if(Ji(i=e.valueOf)&&!Xi(n=Yi(i,e)))return n;if("string"!==t&&Ji(i=e.toString)&&!Xi(n=Yi(i,e)))return n;throw zi("Can't convert object to primitive value")},Dn=TypeError,Pn=yn("toPrimitive"),Ln=function(e,t){if(!wn(e)||On(e))return e;var i,n=Nn(e,Pn);if(n){if(void 0===t&&(t="default"),i=An(n,e,t),!wn(i)||On(i))return i;throw Dn("Can't convert object to primitive value")}return void 0===t&&(t="number"),bn(e,t)},kn=Vi,Mn=function(e){var t=Ln(e,"string");return kn(t)?t:t+""},Un=pi,Vn=vt.document,xn=Un(Vn)&&Un(Vn.createElement),Fn=function(e){return xn?Vn.createElement(e):{}},jn=Fn,Bn=!Gt&&!Et((function(){return 7!=Object.defineProperty(jn("div"),"a",{get:function(){return 7}}).a})),Gn=Gt,Wn=Kt,Hn=qt,Kn=Zt,qn=li,Yn=Mn,Jn=hn,Xn=Bn,zn=Object.getOwnPropertyDescriptor;Bt.f=Gn?zn:function(e,t){if(e=qn(e),t=Yn(t),Xn)try{return zn(e,t)}catch(e){}if(Jn(e,t))return Kn(!Wn(Hn.f,e,t),e[t])};var Qn=Et,Zn=jt,$n=/#|\.prototype\./,es=function(e,t){var i=is[ts(e)];return i==ss||i!=ns&&(Zn(t)?Qn(t):!!t)},ts=es.normalize=function(e){return String(e).replace($n,".").toLowerCase()},is=es.data={},ns=es.NATIVE="N",ss=es.POLYFILL="P",os=es,rs=Wi,as=mt,cs=Ut(Ut.bind),ds=function(e,t){return rs(e),void 0===t?e:as?cs(e,t):function(){return e.apply(t,arguments)}},ls={},hs=Gt&&Et((function(){return 42!=Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype})),us=pi,ps=String,_s=TypeError,Es=function(e){if(us(e))return e;throw _s(ps(e)+" is not an object")},ms=Gt,fs=Bn,Ss=hs,gs=Es,Ts=Mn,Cs=TypeError,Rs=Object.defineProperty,Is=Object.getOwnPropertyDescriptor,vs="enumerable",ys="configurable",As="writable";ls.f=ms?Ss?function(e,t,i){if(gs(e),t=Ts(t),gs(i),"function"==typeof e&&"prototype"===t&&"value"in i&&As in i&&!i[As]){var n=Is(e,t);n&&n[As]&&(e[t]=i.value,i={configurable:ys in i?i[ys]:n[ys],enumerable:vs in i?i[vs]:n[vs],writable:!1})}return Rs(e,t,i)}:Rs:function(e,t,i){if(gs(e),t=Ts(t),gs(i),fs)try{return Rs(e,t,i)}catch(e){}if("get"in i||"set"in i)throw Cs("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var ws=ls,Os=Zt,Ns=Gt?function(e,t,i){return ws.f(e,t,Os(1,i))}:function(e,t,i){return e[t]=i,e},bs=vt,Ds=Nt,Ps=Ut,Ls=jt,ks=Bt.f,Ms=os,Us=_i,Vs=ds,xs=Ns,Fs=hn,js=function(e){var t=function(i,n,s){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,n)}return new e(i,n,s)}return Ds(e,this,arguments)};return t.prototype=e.prototype,t},Bs=function(e,t){var i,n,s,o,r,a,c,d,l,h=e.target,u=e.global,p=e.stat,_=e.proto,E=u?bs:p?bs[h]:(bs[h]||{}).prototype,m=u?Us:Us[h]||xs(Us,h,{})[h],f=m.prototype;for(o in t)n=!(i=Ms(u?o:h+(p?".":"#")+o,e.forced))&&E&&Fs(E,o),a=m[o],n&&(c=e.dontCallGetSet?(l=ks(E,o))&&l.value:E[o]),r=n&&c?c:t[o],n&&typeof a==typeof r||(d=e.bind&&n?Vs(r,bs):e.wrap&&n?js(r):_&&Ls(r)?Ps(r):r,(e.sham||r&&r.sham||a&&a.sham)&&xs(d,"sham",!0),xs(m,o,d),_&&(Fs(Us,s=h+"Prototype")||xs(Us,s,{}),xs(Us[s],o,r),e.real&&f&&(i||!f[o])&&xs(f,o,r)))},Gs=Math.ceil,Ws=Math.floor,Hs=Math.trunc||function(e){var t=+e;return(t>0?Ws:Gs)(t)},Ks=function(e){var t=+e;return t!=t||0===t?0:Hs(t)},qs=Ks,Ys=Math.max,Js=Math.min,Xs=function(e,t){var i=qs(e);return i<0?Ys(i+t,0):Js(i,t)},zs=Ks,Qs=Math.min,Zs=function(e){return e>0?Qs(zs(e),9007199254740991):0},$s=function(e){return Zs(e.length)},eo=li,to=Xs,io=$s,no=function(e){return function(t,i,n){var s,o=eo(t),r=io(o),a=to(n,r);if(e&&i!=i){for(;r>a;)if((s=o[a++])!=s)return!0}else for(;r>a;a++)if((e||a in o)&&o[a]===i)return e||a||0;return!e&&-1}},so={includes:no(!0),indexOf:no(!1)},oo=so.includes;Bs({target:"Array",proto:!0,forced:Et((function(){return!Array(1).includes()}))},{includes:function(e){return oo(this,e,arguments.length>1?arguments[1]:void 0)}});var ro=_i,ao=function(e){return ro[e+"Prototype"]},co=ao("Array").includes,lo=pi,ho=Lt,uo=yn("match"),po=function(e){var t;return lo(e)&&(void 0!==(t=e[uo])?!!t:"RegExp"==ho(e))},_o=TypeError,Eo={};Eo[yn("toStringTag")]="z";var mo="[object z]"===String(Eo),fo=mo,So=jt,go=Lt,To=yn("toStringTag"),Co=Object,Ro="Arguments"==go(function(){return arguments}()),Io=fo?go:function(e){var t,i,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(i=function(e,t){try{return e[t]}catch(e){}}(t=Co(e),To))?i:Ro?go(t):"Object"==(n=go(t))&&So(t.callee)?"Arguments":n},vo=Io,yo=String,Ao=function(e){if("Symbol"===vo(e))throw TypeError("Cannot convert a Symbol value to a string");return yo(e)},wo=yn("match"),Oo=Bs,No=function(e){if(po(e))throw _o("The method doesn't accept regular expressions");return e},bo=ai,Do=Ao,Po=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[wo]=!1,"/./"[e](t)}catch(e){}}return!1},Lo=Ct("".indexOf);Oo({target:"String",proto:!0,forced:!Po("includes")},{includes:function(e){return!!~Lo(Do(bo(this)),Do(No(e)),arguments.length>1?arguments[1]:void 0)}});var ko=ao("String").includes,Mo=Rt,Uo=co,Vo=ko,xo=Array.prototype,Fo=String.prototype,jo=_t((function(e){var t=e.includes;return e===xo||Mo(xo,e)&&t===xo.includes?Uo:"string"==typeof e||e===Fo||Mo(Fo,e)&&t===Fo.includes?Vo:t}));const Bo=!0,Go=!1,Wo=!1,Ho=!1,Ko=["CHINA","GLOBAL"],qo=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");const n=i.join(""),s=[];for(let e=0;e<6;e++)s.push("1");const o=s.join(""),r={};return r[e]=n,r[t]=o,Object.assign(r,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=qo,a||(c.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],c.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],c.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],c.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],c.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],c.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],c.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",c.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",c.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",c.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",c.AREAS=["NORTH_AMERICA","OVERSEA"]);const Yo=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Jo=[];function Xo(e,t){return!!t&&Jo.some((i=>i.uid===e&&i.channelName===t))}e.__CLIENT_LIST__=Jo;var zo={exports:{}},Qo=Bs,Zo=Gt,$o=ls.f;Qo({target:"Object",stat:!0,forced:Object.defineProperty!==$o,sham:!Zo},{defineProperty:$o});var er=_i.Object,tr=zo.exports=function(e,t,i){return er.defineProperty(e,t,i)};er.defineProperty.sham&&(tr.sham=!0);var ir=_t(zo.exports),nr=Lt,sr=Array.isArray||function(e){return"Array"==nr(e)},or=TypeError,rr=Mn,ar=ls,cr=Zt,dr=function(e,t,i){var n=rr(t);n in e?ar.f(e,n,cr(0,i)):e[n]=i},lr=jt,hr=nn,ur=Ct(Function.toString);lr(hr.inspectSource)||(hr.inspectSource=function(e){return ur(e)});var pr=hr.inspectSource,_r=Ct,Er=Et,mr=jt,fr=Io,Sr=pr,gr=function(){},Tr=[],Cr=gi("Reflect","construct"),Rr=/^\s*(?:class|function)\b/,Ir=_r(Rr.exec),vr=!Rr.exec(gr),yr=function(e){if(!mr(e))return!1;try{return Cr(gr,Tr,e),!0}catch(e){return!1}},Ar=function(e){if(!mr(e))return!1;switch(fr(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return vr||!!Ir(Rr,Sr(e))}catch(e){return!0}};Ar.sham=!0;var wr=!Cr||Er((function(){var e;return yr(yr.call)||!yr(Object)||!yr((function(){e=!0}))||e}))?Ar:yr,Or=sr,Nr=wr,br=pi,Dr=yn("species"),Pr=Array,Lr=function(e){var t;return Or(e)&&(t=e.constructor,(Nr(t)&&(t===Pr||Or(t.prototype))||br(t)&&null===(t=t[Dr]))&&(t=void 0)),void 0===t?Pr:t},kr=function(e,t){return new(Lr(e))(0===t?0:t)},Mr=Et,Ur=wi,Vr=yn("species"),xr=Bs,Fr=Et,jr=sr,Br=pi,Gr=cn,Wr=$s,Hr=function(e){if(e>9007199254740991)throw or("Maximum allowed index exceeded");return e},Kr=dr,qr=kr,Yr=function(e){return Ur>=51||!Mr((function(){var t=[];return(t.constructor={})[Vr]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Jr=wi,Xr=yn("isConcatSpreadable"),zr=Jr>=51||!Fr((function(){var e=[];return e[Xr]=!1,e.concat()[0]!==e})),Qr=function(e){if(!Br(e))return!1;var t=e[Xr];return void 0!==t?!!t:jr(e)};xr({target:"Array",proto:!0,arity:1,forced:!zr||!Yr("concat")},{concat:function(e){var t,i,n,s,o,r=Gr(this),a=qr(r,0),c=0;for(t=-1,n=arguments.length;t<n;t++)if(Qr(o=-1===t?r:arguments[t]))for(s=Wr(o),Hr(c+s),i=0;i<s;i++,c++)i in o&&Kr(a,c,o[i]);else Hr(c+1),Kr(a,c++,o);return a.length=c,a}});var Zr={},$r={},ea=hn,ta=li,ia=so.indexOf,na=$r,sa=Ct([].push),oa=function(e,t){var i,n=ta(e),s=0,o=[];for(i in n)!ea(na,i)&&ea(n,i)&&sa(o,i);for(;t.length>s;)ea(n,i=t[s++])&&(~ia(o,i)||sa(o,i));return o},ra=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],aa=oa,ca=ra,da=Object.keys||function(e){return aa(e,ca)},la=Gt,ha=hs,ua=ls,pa=Es,_a=li,Ea=da;Zr.f=la&&!ha?Object.defineProperties:function(e,t){pa(e);for(var i,n=_a(t),s=Ea(t),o=s.length,r=0;o>r;)ua.f(e,i=s[r++],n[i]);return e};var ma,fa=gi("document","documentElement"),Sa=mn,ga=on("keys"),Ta=function(e){return ga[e]||(ga[e]=Sa(e))},Ca=Es,Ra=Zr,Ia=ra,va=$r,ya=fa,Aa=Fn,wa="prototype",Oa="script",Na=Ta("IE_PROTO"),ba=function(){},Da=function(e){return"<"+Oa+">"+e+"</"+Oa+">"},Pa=function(e){e.write(Da("")),e.close();var t=e.parentWindow.Object;return e=null,t},La=function(){try{ma=new ActiveXObject("htmlfile")}catch(e){}var e,t,i;La="undefined"!=typeof document?document.domain&&ma?Pa(ma):(t=Aa("iframe"),i="java"+Oa+":",t.style.display="none",ya.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(Da("document.F=Object")),e.close(),e.F):Pa(ma);for(var n=Ia.length;n--;)delete La[wa][Ia[n]];return La()};va[Na]=!0;var ka=Object.create||function(e,t){var i;return null!==e?(ba[wa]=Ca(e),i=new ba,ba[wa]=null,i[Na]=e):i=La(),void 0===t?i:Ra.f(i,t)},Ma={},Ua=oa,Va=ra.concat("length","prototype");Ma.f=Object.getOwnPropertyNames||function(e){return Ua(e,Va)};var xa={},Fa=Xs,ja=$s,Ba=dr,Ga=Array,Wa=Math.max,Ha=function(e,t,i){for(var n=ja(e),s=Fa(t,n),o=Fa(void 0===i?n:i,n),r=Ga(Wa(o-s,0)),a=0;s<o;s++,a++)Ba(r,a,e[s]);return r.length=a,r},Ka=Lt,qa=li,Ya=Ma.f,Ja=Ha,Xa="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];xa.f=function(e){return Xa&&"Window"==Ka(e)?function(e){try{return Ya(e)}catch(e){return Ja(Xa)}}(e):Ya(qa(e))};var za={};za.f=Object.getOwnPropertySymbols;var Qa=Ns,Za=function(e,t,i,n){return n&&n.enumerable?e[t]=i:Qa(e,t,i),e},$a=ls,ec=function(e,t,i){return $a.f(e,t,i)},tc={},ic=yn;tc.f=ic;var nc,sc,oc,rc=_i,ac=hn,cc=tc,dc=ls.f,lc=function(e){var t=rc.Symbol||(rc.Symbol={});ac(t,e)||dc(t,e,{value:cc.f(e)})},hc=Kt,uc=gi,pc=yn,_c=Za,Ec=function(){var e=uc("Symbol"),t=e&&e.prototype,i=t&&t.valueOf,n=pc("toPrimitive");t&&!t[n]&&_c(t,n,(function(e){return hc(i,this)}),{arity:1})},mc=Io,fc=mo?{}.toString:function(){return"[object "+mc(this)+"]"},Sc=mo,gc=ls.f,Tc=Ns,Cc=hn,Rc=fc,Ic=yn("toStringTag"),vc=function(e,t,i,n){if(e){var s=i?e:e.prototype;Cc(s,Ic)||gc(s,Ic,{configurable:!0,value:t}),n&&!Sc&&Tc(s,"toString",Rc)}},yc=jt,Ac=vt.WeakMap,wc=yc(Ac)&&/native code/.test(String(Ac)),Oc=vt,Nc=pi,bc=Ns,Dc=hn,Pc=nn,Lc=Ta,kc=$r,Mc="Object already initialized",Uc=Oc.TypeError,Vc=Oc.WeakMap;if(wc||Pc.state){var xc=Pc.state||(Pc.state=new Vc);xc.get=xc.get,xc.has=xc.has,xc.set=xc.set,nc=function(e,t){if(xc.has(e))throw Uc(Mc);return t.facade=e,xc.set(e,t),t},sc=function(e){return xc.get(e)||{}},oc=function(e){return xc.has(e)}}else{var Fc=Lc("state");kc[Fc]=!0,nc=function(e,t){if(Dc(e,Fc))throw Uc(Mc);return t.facade=e,bc(e,Fc,t),t},sc=function(e){return Dc(e,Fc)?e[Fc]:{}},oc=function(e){return Dc(e,Fc)}}var jc={set:nc,get:sc,has:oc,enforce:function(e){return oc(e)?sc(e):nc(e,{})},getterFor:function(e){return function(t){var i;if(!Nc(t)||(i=sc(t)).type!==e)throw Uc("Incompatible receiver, "+e+" required");return i}}},Bc=ds,Gc=ni,Wc=cn,Hc=$s,Kc=kr,qc=Ct([].push),Yc=function(e){var t=1==e,i=2==e,n=3==e,s=4==e,o=6==e,r=7==e,a=5==e||o;return function(c,d,l,h){for(var u,p,_=Wc(c),E=Gc(_),m=Bc(d,l),f=Hc(E),S=0,g=h||Kc,T=t?g(c,f):i||r?g(c,0):void 0;f>S;S++)if((a||S in E)&&(p=m(u=E[S],S,_),e))if(t)T[S]=p;else if(p)switch(e){case 3:return!0;case 5:return u;case 6:return S;case 2:qc(T,u)}else switch(e){case 4:return!1;case 7:qc(T,u)}return o?-1:n||s?s:T}},Jc={forEach:Yc(0),map:Yc(1),filter:Yc(2),some:Yc(3),every:Yc(4),find:Yc(5),findIndex:Yc(6),filterReject:Yc(7)},Xc=Bs,zc=vt,Qc=Kt,Zc=Ct,$c=Gt,ed=Di,td=Et,id=hn,nd=Rt,sd=Es,od=li,rd=Mn,ad=Ao,cd=Zt,dd=ka,ld=da,hd=Ma,ud=xa,pd=za,_d=Bt,Ed=ls,md=Zr,fd=qt,Sd=Za,gd=ec,Td=on,Cd=$r,Rd=mn,Id=yn,vd=tc,yd=lc,Ad=Ec,wd=vc,Od=jc,Nd=Jc.forEach,bd=Ta("hidden"),Dd="Symbol",Pd="prototype",Ld=Od.set,kd=Od.getterFor(Dd),Md=Object[Pd],Ud=zc.Symbol,Vd=Ud&&Ud[Pd],xd=zc.TypeError,Fd=zc.QObject,jd=_d.f,Bd=Ed.f,Gd=ud.f,Wd=fd.f,Hd=Zc([].push),Kd=Td("symbols"),qd=Td("op-symbols"),Yd=Td("wks"),Jd=!Fd||!Fd[Pd]||!Fd[Pd].findChild,Xd=$c&&td((function(){return 7!=dd(Bd({},"a",{get:function(){return Bd(this,"a",{value:7}).a}})).a}))?function(e,t,i){var n=jd(Md,t);n&&delete Md[t],Bd(e,t,i),n&&e!==Md&&Bd(Md,t,n)}:Bd,zd=function(e,t){var i=Kd[e]=dd(Vd);return Ld(i,{type:Dd,tag:e,description:t}),$c||(i.description=t),i},Qd=function(e,t,i){e===Md&&Qd(qd,t,i),sd(e);var n=rd(t);return sd(i),id(Kd,n)?(i.enumerable?(id(e,bd)&&e[bd][n]&&(e[bd][n]=!1),i=dd(i,{enumerable:cd(0,!1)})):(id(e,bd)||Bd(e,bd,cd(1,{})),e[bd][n]=!0),Xd(e,n,i)):Bd(e,n,i)},Zd=function(e,t){sd(e);var i=od(t),n=ld(i).concat(il(i));return Nd(n,(function(t){$c&&!Qc($d,i,t)||Qd(e,t,i[t])})),e},$d=function(e){var t=rd(e),i=Qc(Wd,this,t);return!(this===Md&&id(Kd,t)&&!id(qd,t))&&(!(i||!id(this,t)||!id(Kd,t)||id(this,bd)&&this[bd][t])||i)},el=function(e,t){var i=od(e),n=rd(t);if(i!==Md||!id(Kd,n)||id(qd,n)){var s=jd(i,n);return!s||!id(Kd,n)||id(i,bd)&&i[bd][n]||(s.enumerable=!0),s}},tl=function(e){var t=Gd(od(e)),i=[];return Nd(t,(function(e){id(Kd,e)||id(Cd,e)||Hd(i,e)})),i},il=function(e){var t=e===Md,i=Gd(t?qd:od(e)),n=[];return Nd(i,(function(e){!id(Kd,e)||t&&!id(Md,e)||Hd(n,Kd[e])})),n};ed||(Sd(Vd=(Ud=function(){if(nd(Vd,this))throw xd("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?ad(arguments[0]):void 0,t=Rd(e),i=function(e){this===Md&&Qc(i,qd,e),id(this,bd)&&id(this[bd],t)&&(this[bd][t]=!1),Xd(this,t,cd(1,e))};return $c&&Jd&&Xd(Md,t,{configurable:!0,set:i}),zd(t,e)})[Pd],"toString",(function(){return kd(this).tag})),Sd(Ud,"withoutSetter",(function(e){return zd(Rd(e),e)})),fd.f=$d,Ed.f=Qd,md.f=Zd,_d.f=el,hd.f=ud.f=tl,pd.f=il,vd.f=function(e){return zd(Id(e),e)},$c&&gd(Vd,"description",{configurable:!0,get:function(){return kd(this).description}})),Xc({global:!0,constructor:!0,wrap:!0,forced:!ed,sham:!ed},{Symbol:Ud}),Nd(ld(Yd),(function(e){yd(e)})),Xc({target:Dd,stat:!0,forced:!ed},{useSetter:function(){Jd=!0},useSimple:function(){Jd=!1}}),Xc({target:"Object",stat:!0,forced:!ed,sham:!$c},{create:function(e,t){return void 0===t?dd(e):Zd(dd(e),t)},defineProperty:Qd,defineProperties:Zd,getOwnPropertyDescriptor:el}),Xc({target:"Object",stat:!0,forced:!ed},{getOwnPropertyNames:tl}),Ad(),wd(Ud,Dd),Cd[bd]=!0;var nl=Di&&!!Symbol.for&&!!Symbol.keyFor,sl=Bs,ol=gi,rl=hn,al=Ao,cl=on,dl=nl,ll=cl("string-to-symbol-registry"),hl=cl("symbol-to-string-registry");sl({target:"Symbol",stat:!0,forced:!dl},{for:function(e){var t=al(e);if(rl(ll,t))return ll[t];var i=ol("Symbol")(t);return ll[t]=i,hl[i]=t,i}});var ul=Bs,pl=hn,_l=Vi,El=Fi,ml=nl,fl=on("symbol-to-string-registry");ul({target:"Symbol",stat:!0,forced:!ml},{keyFor:function(e){if(!_l(e))throw TypeError(El(e)+" is not a symbol");if(pl(fl,e))return fl[e]}});var Sl=Ct([].slice),gl=sr,Tl=jt,Cl=Lt,Rl=Ao,Il=Ct([].push),vl=Bs,yl=gi,Al=Nt,wl=Kt,Ol=Ct,Nl=Et,bl=jt,Dl=Vi,Pl=Sl,Ll=function(e){if(Tl(e))return e;if(gl(e)){for(var t=e.length,i=[],n=0;n<t;n++){var s=e[n];"string"==typeof s?Il(i,s):"number"!=typeof s&&"Number"!=Cl(s)&&"String"!=Cl(s)||Il(i,Rl(s))}var o=i.length,r=!0;return function(e,t){if(r)return r=!1,t;if(gl(this))return t;for(var n=0;n<o;n++)if(i[n]===e)return t}}},kl=Di,Ml=String,Ul=yl("JSON","stringify"),Vl=Ol(/./.exec),xl=Ol("".charAt),Fl=Ol("".charCodeAt),jl=Ol("".replace),Bl=Ol(1..toString),Gl=/[\uD800-\uDFFF]/g,Wl=/^[\uD800-\uDBFF]$/,Hl=/^[\uDC00-\uDFFF]$/,Kl=!kl||Nl((function(){var e=yl("Symbol")();return"[null]"!=Ul([e])||"{}"!=Ul({a:e})||"{}"!=Ul(Object(e))})),ql=Nl((function(){return'"\\udf06\\ud834"'!==Ul("\udf06\ud834")||'"\\udead"'!==Ul("\udead")})),Yl=function(e,t){var i=Pl(arguments),n=Ll(t);if(bl(n)||void 0!==e&&!Dl(e))return i[1]=function(e,t){if(bl(n)&&(t=wl(n,this,Ml(e),t)),!Dl(t))return t},Al(Ul,null,i)},Jl=function(e,t,i){var n=xl(i,t-1),s=xl(i,t+1);return Vl(Wl,e)&&!Vl(Hl,s)||Vl(Hl,e)&&!Vl(Wl,n)?"\\u"+Bl(Fl(e,0),16):e};Ul&&vl({target:"JSON",stat:!0,arity:3,forced:Kl||ql},{stringify:function(e,t,i){var n=Pl(arguments),s=Al(Kl?Yl:Ul,null,n);return ql&&"string"==typeof s?jl(s,Gl,Jl):s}});var Xl=za,zl=cn;Bs({target:"Object",stat:!0,forced:!Di||Et((function(){Xl.f(1)}))},{getOwnPropertySymbols:function(e){var t=Xl.f;return t?t(zl(e)):[]}}),lc("asyncIterator"),lc("hasInstance"),lc("isConcatSpreadable"),lc("iterator"),lc("match"),lc("matchAll"),lc("replace"),lc("search"),lc("species"),lc("split");var Ql=Ec;lc("toPrimitive"),Ql();var Zl=gi,$l=vc;lc("toStringTag"),$l(Zl("Symbol"),"Symbol"),lc("unscopables"),vc(vt.JSON,"JSON",!0);var eh,th,ih,nh=_i.Symbol,sh={},oh=Gt,rh=hn,ah=Function.prototype,ch=oh&&Object.getOwnPropertyDescriptor,dh=rh(ah,"name"),lh={EXISTS:dh,PROPER:dh&&"something"===function(){}.name,CONFIGURABLE:dh&&(!oh||oh&&ch(ah,"name").configurable)},hh=!Et((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),uh=hn,ph=jt,_h=cn,Eh=hh,mh=Ta("IE_PROTO"),fh=Object,Sh=fh.prototype,gh=Eh?fh.getPrototypeOf:function(e){var t=_h(e);if(uh(t,mh))return t[mh];var i=t.constructor;return ph(i)&&t instanceof i?i.prototype:t instanceof fh?Sh:null},Th=Et,Ch=jt,Rh=pi,Ih=ka,vh=gh,yh=Za,Ah=yn("iterator"),wh=!1;[].keys&&("next"in(ih=[].keys())?(th=vh(vh(ih)))!==Object.prototype&&(eh=th):wh=!0);var Oh=!Rh(eh)||Th((function(){var e={};return eh[Ah].call(e)!==e}));Ch((eh=Oh?{}:Ih(eh))[Ah])||yh(eh,Ah,(function(){return this}));var Nh={IteratorPrototype:eh,BUGGY_SAFARI_ITERATORS:wh},bh=Nh.IteratorPrototype,Dh=ka,Ph=Zt,Lh=vc,kh=sh,Mh=function(){return this},Uh=Ct,Vh=Wi,xh=jt,Fh=String,jh=TypeError,Bh=function(e,t,i){try{return Uh(Vh(Object.getOwnPropertyDescriptor(e,t)[i]))}catch(e){}},Gh=Es,Wh=function(e){if("object"==typeof e||xh(e))return e;throw jh("Can't set "+Fh(e)+" as a prototype")},Hh=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=Bh(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch(e){}return function(i,n){return Gh(i),Wh(n),t?e(i,n):i.__proto__=n,i}}():void 0),Kh=Bs,qh=Kt,Yh=lh,Jh=function(e,t,i,n){var s=t+" Iterator";return e.prototype=Dh(bh,{next:Ph(+!n,i)}),Lh(e,s,!1,!0),kh[s]=Mh,e},Xh=gh,zh=vc,Qh=Za,Zh=sh,$h=Nh,eu=Yh.PROPER,tu=$h.BUGGY_SAFARI_ITERATORS,iu=yn("iterator"),nu="keys",su="values",ou="entries",ru=function(){return this},au=function(e,t,i,n,s,o,r){Jh(i,t,n);var a,c,d,l=function(e){if(e===s&&E)return E;if(!tu&&e in p)return p[e];switch(e){case nu:case su:case ou:return function(){return new i(this,e)}}return function(){return new i(this)}},h=t+" Iterator",u=!1,p=e.prototype,_=p[iu]||p["@@iterator"]||s&&p[s],E=!tu&&_||l(s),m="Array"==t&&p.entries||_;if(m&&(a=Xh(m.call(new e)))!==Object.prototype&&a.next&&(zh(a,h,!0,!0),Zh[h]=ru),eu&&s==su&&_&&_.name!==su&&(u=!0,E=function(){return qh(_,this)}),s)if(c={values:l(su),keys:o?E:l(nu),entries:l(ou)},r)for(d in c)(tu||u||!(d in p))&&Qh(p,d,c[d]);else Kh({target:t,proto:!0,forced:tu||u},c);return r&&p[iu]!==E&&Qh(p,iu,E,{name:s}),Zh[t]=E,c},cu=function(e,t){return{value:e,done:t}},du=li,lu=sh,hu=jc;ls.f;var uu=au,pu=cu,_u="Array Iterator",Eu=hu.set,mu=hu.getterFor(_u);uu(Array,"Array",(function(e,t){Eu(this,{type:_u,target:du(e),index:0,kind:t})}),(function(){var e=mu(this),t=e.target,i=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,pu(void 0,!0)):pu("keys"==i?n:"values"==i?t[n]:[n,t[n]],!1)}),"values"),lu.Arguments=lu.Array;var fu={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Su=vt,gu=Io,Tu=Ns,Cu=sh,Ru=yn("toStringTag");for(var Iu in fu){var vu=Su[Iu],yu=vu&&vu.prototype;yu&&gu(yu)!==Ru&&Tu(yu,Ru,Iu),Cu[Iu]=Cu.Array}var Au=nh,wu=yn,Ou=ls.f,Nu=wu("metadata"),bu=Function.prototype;void 0===bu[Nu]&&Ou(bu,Nu,{value:null}),lc("dispose"),lc("metadata");var Du=Au;lc("asyncDispose");var Pu=Ct,Lu=gi("Symbol"),ku=Lu.keyFor,Mu=Pu(Lu.prototype.valueOf),Uu=Lu.isRegisteredSymbol||function(e){try{return void 0!==ku(Mu(e))}catch(e){return!1}};Bs({target:"Symbol",stat:!0},{isRegisteredSymbol:Uu});for(var Vu=on,xu=gi,Fu=Ct,ju=Vi,Bu=yn,Gu=xu("Symbol"),Wu=Gu.isWellKnownSymbol,Hu=xu("Object","getOwnPropertyNames"),Ku=Fu(Gu.prototype.valueOf),qu=Vu("wks"),Yu=0,Ju=Hu(Gu),Xu=Ju.length;Yu<Xu;Yu++)try{var zu=Ju[Yu];ju(Gu[zu])&&Bu(zu)}catch(e){}var Qu=function(e){if(Wu&&Wu(e))return!0;try{for(var t=Ku(e),i=0,n=Hu(qu),s=n.length;i<s;i++)if(qu[n[i]]==t)return!0}catch(e){}return!1};Bs({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:Qu}),lc("matcher"),lc("observable"),Bs({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:Uu}),Bs({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:Qu}),lc("metadataKey"),lc("patternMatch"),lc("replaceAll");var Zu=_t(Du),$u=Ct,ep=Ks,tp=Ao,ip=ai,np=$u("".charAt),sp=$u("".charCodeAt),op=$u("".slice),rp=function(e){return function(t,i){var n,s,o=tp(ip(t)),r=ep(i),a=o.length;return r<0||r>=a?e?"":void 0:(n=sp(o,r))<55296||n>56319||r+1===a||(s=sp(o,r+1))<56320||s>57343?e?np(o,r):n:e?op(o,r,r+2):s-56320+(n-55296<<10)+65536}},ap={codeAt:rp(!1),charAt:rp(!0)}.charAt,cp=Ao,dp=jc,lp=au,hp=cu,up="String Iterator",pp=dp.set,_p=dp.getterFor(up);lp(String,"String",(function(e){pp(this,{type:up,string:cp(e),index:0})}),(function(){var e,t=_p(this),i=t.string,n=t.index;return n>=i.length?hp(void 0,!0):(e=ap(i,n),t.index+=e.length,hp(e,!1))}));var Ep=_t(tc.f("iterator"));function mp(e){return mp="function"==typeof Zu&&"symbol"==typeof Ep?function(e){return typeof e}:function(e){return e&&"function"==typeof Zu&&e.constructor===Zu&&e!==Zu.prototype?"symbol":typeof e},mp(e)}var fp=_t(tc.f("toPrimitive"));function Sp(e){var t=function(e,t){if("object"!==mp(e)||null===e)return e;var i=e[fp];if(void 0!==i){var n=i.call(e,t||"default");if("object"!==mp(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"===mp(t)?t:String(t)}function gp(e,t,i){return(t=Sp(t))in e?ir(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Tp=Wi,Cp=cn,Rp=ni,Ip=$s,vp=TypeError,yp=function(e){return function(t,i,n,s){Tp(i);var o=Cp(t),r=Rp(o),a=Ip(o),c=e?a-1:0,d=e?-1:1;if(n<2)for(;;){if(c in r){s=r[c],c+=d;break}if(c+=d,e?c<0:a<=c)throw vp("Reduce of empty array with no initial value")}for(;e?c>=0:a>c;c+=d)c in r&&(s=i(s,r[c],c,o));return s}},Ap={left:yp(!1),right:yp(!0)},wp=Et,Op=function(e,t){var i=[][e];return!!i&&wp((function(){i.call(null,t||function(){return 1},1)}))},Np="undefined"!=typeof process&&"process"==Lt(process),bp=Ap.left;Bs({target:"Array",proto:!0,forced:!Np&&wi>79&&wi<83||!Op("reduce")},{reduce:function(e){var t=arguments.length;return bp(this,e,t,t>1?arguments[1]:void 0)}});var Dp=ao("Array").reduce,Pp=Rt,Lp=Dp,kp=Array.prototype,Mp=_t((function(e){var t=e.reduce;return e===kp||Pp(kp,e)&&t===kp.reduce?Lp:t})),Up=gi,Vp=Ma,xp=za,Fp=Es,jp=Ct([].concat),Bp=Up("Reflect","ownKeys")||function(e){var t=Vp.f(Fp(e)),i=xp.f;return i?jp(t,i(e)):t},Gp=hn,Wp=Bp,Hp=Bt,Kp=ls,qp=pi,Yp=Ns,Jp=Error,Xp=Ct("".replace),zp=String(Jp("zxcasd").stack),Qp=/\n\s*at [^:]*:[^\n]*/,Zp=Qp.test(zp),$p=Zt,e_=!Et((function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",$p(1,7)),7!==e.stack)})),t_=Ns,i_=function(e,t){if(Zp&&"string"==typeof e&&!Jp.prepareStackTrace)for(;t--;)e=Xp(e,Qp,"");return e},n_=e_,s_=Error.captureStackTrace,o_=sh,r_=yn("iterator"),a_=Array.prototype,c_=Io,d_=qi,l_=si,h_=sh,u_=yn("iterator"),p_=function(e){if(!l_(e))return d_(e,u_)||d_(e,"@@iterator")||h_[c_(e)]},__=Kt,E_=Wi,m_=Es,f_=Fi,S_=p_,g_=TypeError,T_=Kt,C_=Es,R_=qi,I_=ds,v_=Kt,y_=Es,A_=Fi,w_=function(e){return void 0!==e&&(o_.Array===e||a_[r_]===e)},O_=$s,N_=Rt,b_=function(e,t){var i=arguments.length<2?S_(e):t;if(E_(i))return m_(__(i,e));throw g_(f_(e)+" is not iterable")},D_=p_,P_=function(e,t,i){var n,s;C_(e);try{if(!(n=R_(e,"return"))){if("throw"===t)throw i;return i}n=T_(n,e)}catch(e){s=!0,n=e}if("throw"===t)throw i;if(s)throw n;return C_(n),i},L_=TypeError,k_=function(e,t){this.stopped=e,this.result=t},M_=k_.prototype,U_=function(e,t,i){var n,s,o,r,a,c,d,l=i&&i.that,h=!(!i||!i.AS_ENTRIES),u=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),_=!(!i||!i.INTERRUPTED),E=I_(t,l),m=function(e){return n&&P_(n,"normal",e),new k_(!0,e)},f=function(e){return h?(y_(e),_?E(e[0],e[1],m):E(e[0],e[1])):_?E(e,m):E(e)};if(u)n=e.iterator;else if(p)n=e;else{if(!(s=D_(e)))throw L_(A_(e)+" is not iterable");if(w_(s)){for(o=0,r=O_(e);r>o;o++)if((a=f(e[o]))&&N_(M_,a))return a;return new k_(!1)}n=b_(e,s)}for(c=u?e.next:n.next;!(d=v_(c,n)).done;){try{a=f(d.value)}catch(e){P_(n,"throw",e)}if("object"==typeof a&&a&&N_(M_,a))return a}return new k_(!1)},V_=Ao,x_=Bs,F_=Rt,j_=gh,B_=Hh,G_=function(e,t,i){for(var n=Wp(t),s=Kp.f,o=Hp.f,r=0;r<n.length;r++){var a=n[r];Gp(e,a)||i&&Gp(i,a)||s(e,a,o(t,a))}},W_=ka,H_=Ns,K_=Zt,q_=function(e,t){qp(t)&&"cause"in t&&Yp(e,"cause",t.cause)},Y_=function(e,t,i,n){n_&&(s_?s_(e,t):t_(e,"stack",i_(i,n)))},J_=U_,X_=function(e,t){return void 0===e?arguments.length<2?"":t:V_(e)},z_=yn("toStringTag"),Q_=Error,Z_=[].push,$_=function(e,t){var i,n=F_(eE,this);B_?i=B_(Q_(),n?j_(this):eE):(i=n?this:W_(eE),H_(i,z_,"Error")),void 0!==t&&H_(i,"message",X_(t)),Y_(i,$_,i.stack,1),arguments.length>2&&q_(i,arguments[2]);var s=[];return J_(e,Z_,{that:s}),H_(i,"errors",s),i};B_?B_($_,Q_):G_($_,Q_,{name:!0});var eE=$_.prototype=W_(Q_.prototype,{constructor:K_(1,$_),message:K_(1,""),name:K_(1,"AggregateError")});x_({global:!0,constructor:!0,arity:2},{AggregateError:$_});var tE,iE,nE,sE,oE=gi,rE=ec,aE=Gt,cE=yn("species"),dE=Rt,lE=TypeError,hE=wr,uE=Fi,pE=TypeError,_E=Es,EE=function(e){if(hE(e))return e;throw pE(uE(e)+" is not a constructor")},mE=si,fE=yn("species"),SE=function(e,t){var i,n=_E(e).constructor;return void 0===n||mE(i=_E(n)[fE])?t:EE(i)},gE=TypeError,TE=/(?:ipad|iphone|ipod).*applewebkit/i.test(Ti),CE=vt,RE=Nt,IE=ds,vE=jt,yE=hn,AE=Et,wE=fa,OE=Sl,NE=Fn,bE=function(e,t){if(e<t)throw gE("Not enough arguments");return e},DE=TE,PE=Np,LE=CE.setImmediate,kE=CE.clearImmediate,ME=CE.process,UE=CE.Dispatch,VE=CE.Function,xE=CE.MessageChannel,FE=CE.String,jE=0,BE={},GE="onreadystatechange";AE((function(){tE=CE.location}));var WE=function(e){if(yE(BE,e)){var t=BE[e];delete BE[e],t()}},HE=function(e){return function(){WE(e)}},KE=function(e){WE(e.data)},qE=function(e){CE.postMessage(FE(e),tE.protocol+"//"+tE.host)};LE&&kE||(LE=function(e){bE(arguments.length,1);var t=vE(e)?e:VE(e),i=OE(arguments,1);return BE[++jE]=function(){RE(t,void 0,i)},iE(jE),jE},kE=function(e){delete BE[e]},PE?iE=function(e){ME.nextTick(HE(e))}:UE&&UE.now?iE=function(e){UE.now(HE(e))}:xE&&!DE?(sE=(nE=new xE).port2,nE.port1.onmessage=KE,iE=IE(sE.postMessage,sE)):CE.addEventListener&&vE(CE.postMessage)&&!CE.importScripts&&tE&&"file:"!==tE.protocol&&!AE(qE)?(iE=qE,CE.addEventListener("message",KE,!1)):iE=GE in NE("script")?function(e){wE.appendChild(NE("script"))[GE]=function(){wE.removeChild(this),WE(e)}}:function(e){setTimeout(HE(e),0)});var YE={set:LE,clear:kE},JE=function(){this.head=null,this.tail=null};JE.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return null===(this.head=e.next)&&(this.tail=null),e.item}};var XE,zE,QE,ZE,$E,em=JE,tm=/ipad|iphone|ipod/i.test(Ti)&&"undefined"!=typeof Pebble,im=/web0s(?!.*chrome)/i.test(Ti),nm=vt,sm=ds,om=Bt.f,rm=YE.set,am=em,cm=TE,dm=tm,lm=im,hm=Np,um=nm.MutationObserver||nm.WebKitMutationObserver,pm=nm.document,_m=nm.process,Em=nm.Promise,mm=om(nm,"queueMicrotask"),fm=mm&&mm.value;if(!fm){var Sm=new am,gm=function(){var e,t;for(hm&&(e=_m.domain)&&e.exit();t=Sm.get();)try{t()}catch(e){throw Sm.head&&XE(),e}e&&e.enter()};cm||hm||lm||!um||!pm?!dm&&Em&&Em.resolve?((ZE=Em.resolve(void 0)).constructor=Em,$E=sm(ZE.then,ZE),XE=function(){$E(gm)}):hm?XE=function(){_m.nextTick(gm)}:(rm=sm(rm,nm),XE=function(){rm(gm)}):(zE=!0,QE=pm.createTextNode(""),new um(gm).observe(QE,{characterData:!0}),XE=function(){QE.data=zE=!zE}),fm=function(e){Sm.head||XE(),Sm.add(e)}}var Tm=fm,Cm=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},Rm=vt.Promise,Im="object"==typeof Deno&&Deno&&"object"==typeof Deno.version,vm=!Im&&!Np&&"object"==typeof window&&"object"==typeof document,ym=vt,Am=Rm,wm=jt,Om=os,Nm=pr,bm=yn,Dm=vm,Pm=Im,Lm=wi,km=Am&&Am.prototype,Mm=bm("species"),Um=!1,Vm=wm(ym.PromiseRejectionEvent),xm=Om("Promise",(function(){var e=Nm(Am),t=e!==String(Am);if(!t&&66===Lm)return!0;if(!km.catch||!km.finally)return!0;if(!Lm||Lm<51||!/native code/.test(e)){var i=new Am((function(e){e(1)})),n=function(e){e((function(){}),(function(){}))};if((i.constructor={})[Mm]=n,!(Um=i.then((function(){}))instanceof n))return!0}return!t&&(Dm||Pm)&&!Vm})),Fm={CONSTRUCTOR:xm,REJECTION_EVENT:Vm,SUBCLASSING:Um},jm={},Bm=Wi,Gm=TypeError,Wm=function(e){var t,i;this.promise=new e((function(e,n){if(void 0!==t||void 0!==i)throw Gm("Bad Promise constructor");t=e,i=n})),this.resolve=Bm(t),this.reject=Bm(i)};jm.f=function(e){return new Wm(e)};var Hm,Km,qm=Bs,Ym=Np,Jm=vt,Xm=Kt,zm=Za,Qm=vc,Zm=function(e){var t=oE(e);aE&&t&&!t[cE]&&rE(t,cE,{configurable:!0,get:function(){return this}})},$m=Wi,ef=jt,tf=pi,nf=function(e,t){if(dE(t,e))return e;throw lE("Incorrect invocation")},sf=SE,of=YE.set,rf=Tm,af=function(e,t){try{1==arguments.length?console.error(e):console.error(e,t)}catch(e){}},cf=Cm,df=em,lf=jc,hf=Rm,uf=Fm,pf=jm,_f="Promise",Ef=uf.CONSTRUCTOR,mf=uf.REJECTION_EVENT,ff=lf.getterFor(_f),Sf=lf.set,gf=hf&&hf.prototype,Tf=hf,Cf=gf,Rf=Jm.TypeError,If=Jm.document,vf=Jm.process,yf=pf.f,Af=yf,wf=!!(If&&If.createEvent&&Jm.dispatchEvent),Of="unhandledrejection",Nf=function(e){var t;return!(!tf(e)||!ef(t=e.then))&&t},bf=function(e,t){var i,n,s,o=t.value,r=1==t.state,a=r?e.ok:e.fail,c=e.resolve,d=e.reject,l=e.domain;try{a?(r||(2===t.rejection&&Mf(t),t.rejection=1),!0===a?i=o:(l&&l.enter(),i=a(o),l&&(l.exit(),s=!0)),i===e.promise?d(Rf("Promise-chain cycle")):(n=Nf(i))?Xm(n,i,c,d):c(i)):d(o)}catch(e){l&&!s&&l.exit(),d(e)}},Df=function(e,t){e.notified||(e.notified=!0,rf((function(){for(var i,n=e.reactions;i=n.get();)bf(i,e);e.notified=!1,t&&!e.rejection&&Lf(e)})))},Pf=function(e,t,i){var n,s;wf?((n=If.createEvent("Event")).promise=t,n.reason=i,n.initEvent(e,!1,!0),Jm.dispatchEvent(n)):n={promise:t,reason:i},!mf&&(s=Jm["on"+e])?s(n):e===Of&&af("Unhandled promise rejection",i)},Lf=function(e){Xm(of,Jm,(function(){var t,i=e.facade,n=e.value;if(kf(e)&&(t=cf((function(){Ym?vf.emit("unhandledRejection",n,i):Pf(Of,i,n)})),e.rejection=Ym||kf(e)?2:1,t.error))throw t.value}))},kf=function(e){return 1!==e.rejection&&!e.parent},Mf=function(e){Xm(of,Jm,(function(){var t=e.facade;Ym?vf.emit("rejectionHandled",t):Pf("rejectionhandled",t,e.value)}))},Uf=function(e,t,i){return function(n){e(t,n,i)}},Vf=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,Df(e,!0))},xf=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw Rf("Promise can't be resolved itself");var n=Nf(t);n?rf((function(){var i={done:!1};try{Xm(n,t,Uf(xf,i,e),Uf(Vf,i,e))}catch(t){Vf(i,t,e)}})):(e.value=t,e.state=1,Df(e,!1))}catch(t){Vf({done:!1},t,e)}}};Ef&&(Cf=(Tf=function(e){nf(this,Cf),$m(e),Xm(Hm,this);var t=ff(this);try{e(Uf(xf,t),Uf(Vf,t))}catch(e){Vf(t,e)}}).prototype,(Hm=function(e){Sf(this,{type:_f,done:!1,notified:!1,parent:!1,reactions:new df,rejection:!1,state:0,value:void 0})}).prototype=zm(Cf,"then",(function(e,t){var i=ff(this),n=yf(sf(this,Tf));return i.parent=!0,n.ok=!ef(e)||e,n.fail=ef(t)&&t,n.domain=Ym?vf.domain:void 0,0==i.state?i.reactions.add(n):rf((function(){bf(n,i)})),n.promise})),Km=function(){var e=new Hm,t=ff(e);this.promise=e,this.resolve=Uf(xf,t),this.reject=Uf(Vf,t)},pf.f=yf=function(e){return e===Tf||undefined===e?new Km(e):Af(e)}),qm({global:!0,constructor:!0,wrap:!0,forced:Ef},{Promise:Tf}),Qm(Tf,_f,!1,!0),Zm(_f);var Ff=yn("iterator"),jf=!1;try{var Bf=0,Gf={next:function(){return{done:!!Bf++}},return:function(){jf=!0}};Gf[Ff]=function(){return this},Array.from(Gf,(function(){throw 2}))}catch(e){}var Wf=Rm,Hf=function(e,t){if(!t&&!jf)return!1;var i=!1;try{var n={};n[Ff]=function(){return{next:function(){return{done:i=!0}}}},e(n)}catch(e){}return i},Kf=Fm.CONSTRUCTOR||!Hf((function(e){Wf.all(e).then(void 0,(function(){}))})),qf=Kt,Yf=Wi,Jf=jm,Xf=Cm,zf=U_;Bs({target:"Promise",stat:!0,forced:Kf},{all:function(e){var t=this,i=Jf.f(t),n=i.resolve,s=i.reject,o=Xf((function(){var i=Yf(t.resolve),o=[],r=0,a=1;zf(e,(function(e){var c=r++,d=!1;a++,qf(i,t,e).then((function(e){d||(d=!0,o[c]=e,--a||n(o))}),s)})),--a||n(o)}));return o.error&&s(o.value),i.promise}});var Qf=Bs,Zf=Fm.CONSTRUCTOR;Rm&&Rm.prototype,Qf({target:"Promise",proto:!0,forced:Zf,real:!0},{catch:function(e){return this.then(void 0,e)}});var $f=Kt,eS=Wi,tS=jm,iS=Cm,nS=U_;Bs({target:"Promise",stat:!0,forced:Kf},{race:function(e){var t=this,i=tS.f(t),n=i.reject,s=iS((function(){var s=eS(t.resolve);nS(e,(function(e){$f(s,t,e).then(i.resolve,n)}))}));return s.error&&n(s.value),i.promise}});var sS=Kt,oS=jm;Bs({target:"Promise",stat:!0,forced:Fm.CONSTRUCTOR},{reject:function(e){var t=oS.f(this);return sS(t.reject,void 0,e),t.promise}});var rS=Es,aS=pi,cS=jm,dS=function(e,t){if(rS(e),aS(t)&&t.constructor===e)return t;var i=cS.f(e);return(0,i.resolve)(t),i.promise},lS=Bs,hS=Rm,uS=Fm.CONSTRUCTOR,pS=dS,_S=gi("Promise"),ES=!uS;lS({target:"Promise",stat:!0,forced:true},{resolve:function(e){return pS(ES&&this===_S?hS:this,e)}});var mS=Kt,fS=Wi,SS=jm,gS=Cm,TS=U_;Bs({target:"Promise",stat:!0,forced:Kf},{allSettled:function(e){var t=this,i=SS.f(t),n=i.resolve,s=i.reject,o=gS((function(){var i=fS(t.resolve),s=[],o=0,r=1;TS(e,(function(e){var a=o++,c=!1;r++,mS(i,t,e).then((function(e){c||(c=!0,s[a]={status:"fulfilled",value:e},--r||n(s))}),(function(e){c||(c=!0,s[a]={status:"rejected",reason:e},--r||n(s))}))})),--r||n(s)}));return o.error&&s(o.value),i.promise}});var CS=Kt,RS=Wi,IS=gi,vS=jm,yS=Cm,AS=U_,wS="No one promise resolved";Bs({target:"Promise",stat:!0,forced:Kf},{any:function(e){var t=this,i=IS("AggregateError"),n=vS.f(t),s=n.resolve,o=n.reject,r=yS((function(){var n=RS(t.resolve),r=[],a=0,c=1,d=!1;AS(e,(function(e){var l=a++,h=!1;c++,CS(n,t,e).then((function(e){h||d||(d=!0,s(e))}),(function(e){h||d||(h=!0,r[l]=e,--c||o(new i(r,wS)))}))})),--c||o(new i(r,wS))}));return r.error&&o(r.value),n.promise}});var OS=Bs,NS=Rm,bS=Et,DS=gi,PS=jt,LS=SE,kS=dS,MS=NS&&NS.prototype;OS({target:"Promise",proto:!0,real:!0,forced:!!NS&&bS((function(){MS.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=LS(this,DS("Promise")),i=PS(e);return this.then(i?function(i){return kS(t,e()).then((function(){return i}))}:e,i?function(i){return kS(t,e()).then((function(){throw i}))}:e)}});var US,VS,xS,FS,jS,BS,GS,WS,HS,KS,qS,YS,JS,XS,zS,QS,ZS,$S=_i.Promise,eg=_t($S),tg=ao("Array").values,ig=Io,ng=hn,sg=Rt,og=tg,rg=Array.prototype,ag={DOMTokenList:!0,NodeList:!0},cg=_t((function(e){var t=e.values;return e===rg||sg(rg,e)&&t===rg.values||ng(ag,ig(e))?og:t}));function dg(e,t,i,n){var s,o=arguments.length,r=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,i,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(r=(o<3?s(r):o>3?s(t,i,r):s(t,i))||r);return o>3&&r&&Object.defineProperty(t,i,r),r}function lg(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}!function(e){e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY"}(US||(US={})),function(e){e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver"}(VS||(VS={})),function(e){e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR"}(xS||(xS={})),function(e){e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR"}(FS||(FS={})),function(e){e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND"}(jS||(jS={})),function(e){e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV"}(BS||(BS={})),function(e){e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY"}(GS||(GS={})),function(e){e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed"}(WS||(WS={})),function(e){e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_START="p2p_start",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream"}(HS||(HS={})),function(e){e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag"}(KS||(KS={})),function(e){e.PUBLISH_STATS="publish_stats",e.PUBLISH_RELATED_STATS="publish_related_stats",e.SUBSCRIBE_STATS="subscribe_stats",e.SUBSCRIBE_RELATED_STATS="subscribe_related_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.TRANSPORT_STATS="transport_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats"}(qS||(qS={})),function(e){e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list"}(YS||(YS={})),function(e){e.CONNECTION_STATE_CHANGE="CONNECTION_STATE_CHANGE",e.NEED_ANSWER="NEED_ANSWER",e.NEED_RENEGOTIATE="NEED_RENEGOTIATE",e.P2P_LOST="P2P_LOST",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NEED_UNPUB="NEED_UNPUB",e.NEED_UNSUB="NEED_UNSUB",e.NEED_UPLOAD="NEED_UPLOAD",e.NEED_CONTROL="NEED_CONTROL",e.START_RECONNECT="START_RECONNECT",e.END_RECONNECT="END_RECONNECT",e.NEED_SIGNAL_RTT="NEED_SIGNAL_RTT"}(JS||(JS={})),function(e){e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY"}(XS||(XS={})),function(e){e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire"}(zS||(zS={}));class hg extends l{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"error";return super.print(e,t)}throw(){super.throw(t)}}function ug(e){if("string"!=typeof e||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw t.error("Invalid Channel Name ".concat(e)),new hg(h.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function pg(e){if(!(i=e,"number"==typeof i&&Math.floor(i)===i&&0<=i&&i<=4294967295||u(e,1,255)))throw new hg(h.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var i;"string"==typeof e&&t.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}!function(e){e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming"}(QS||(QS={})),function(e){e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN"}(ZS||(ZS={}));const _g={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Eg={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function mg(e,t){f(e.url,"".concat(t,".url"),1,1e3,!1),p(e.x)||_(e.x,"".concat(t,".x"),0,1e4),p(e.y)||_(e.y,"".concat(t,".y"),0,1e4),p(e.width)||_(e.width,"".concat(t,".width"),0,1e4),p(e.height)||_(e.height,"".concat(t,".height"),0,1e4),p(e.zOrder)||_(e.zOrder,"".concat(t,".zOrder"),0,255),p(e.alpha)||_(e.alpha,"".concat(t,".alpha"),0,1,!1)}const fg={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Sg={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};var gg,Tg,Cg,Rg,Ig,vg,yg,Ag,wg,Og,Ng,bg,Dg,Pg;function Lg(e){if(!e.channelName)throw new hg(h.INVALID_PARAMS,"invalid channelName in info");if("number"!=typeof e.uid)throw new hg(h.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&f(e.token,"info.token",1,2047),pg(e.uid),ug(e.channelName),!0}!function(e){e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address"}(gg||(gg={})),function(e){e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager"}(Tg||(Tg={})),function(e){e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN"}(Cg||(Cg={})),function(e){e.CONNECT_FAILED="connect failed",e.CONNECT_TIMEOUT="connect timeout",e.WS_DISCONNECTED="websocket disconnected",e.REQUEST_TIMEOUT="request timeout",e.REQUEST_FAILED="request failed",e.WAIT_STATUS_TIMEOUT="wait status timeout",e.WAIT_STATUS_ERROR="wait status error",e.BAD_STATE="bad state",e.WS_ABORT="ws abort",e.AP_REQUEST_TIMEOUT="AP request timeout",e.AP_JSON_PARSE_ERROR="AP json parse error",e.AP_REQUEST_ERROR="AP request error",e.AP_REQUEST_ABORT="AP request abort"}(Rg||(Rg={})),function(e){e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile"}(Ig||(Ig={})),function(e){e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE"}(vg||(vg={})),function(e){e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE"}(yg||(yg={})),function(e){e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED"}(Ag||(Ag={})),function(e){e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low"}(wg||(wg={})),function(e){e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal"}(Og||(Og={})),function(e){e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON"}(Ng||(Ng={})),function(e){e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7"}(bg||(bg={})),function(e){e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel"}(Dg||(Dg={})),function(e){e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS"}(Pg||(Pg={}));const kg=[Pg.AFRICA,Pg.ASIA,Pg.CHINA,Pg.EUROPE,Pg.GLOBAL,Pg.INDIA,Pg.JAPAN,Pg.NORTH_AMERICA,Pg.OCEANIA,Pg.OVERSEA,Pg.SOUTH_AMERICA];var Mg;!function(e){e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL"}(Mg||(Mg={}));const Ug={CHINA:{},ASIA:{CODE:Mg.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Mg.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Mg.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Mg.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","\tuap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Mg.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Mg.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Mg.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Mg.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Mg.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Mg.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Mg.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Mg.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Mg.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};var Vg,xg,Fg,jg,Bg,Gg,Wg,Hg,Kg,qg,Yg,Jg,Xg,zg,Qg,Zg,$g,eT,tT,iT,nT,sT;a&&(Ug.CHINA={CODE:Mg.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]}),function(e){e.UPDATE_BITRATE_LIMIT="update_bitrate_limit"}(Vg||(Vg={}));class oT extends g{constructor(e,t){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0}}class rT extends oT{constructor(e,t){super(e,t)}}!function(e){e.SEND="sendonly",e.RECV="recvonly",e.SENDRECV="sendrecv",e.INACTIVE="inactive"}(xg||(xg={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(Fg||(Fg={})),function(e){e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY"}(jg||(jg={})),function(e){e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED"}(Bg||(Bg={})),function(e){e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack"}(Gg||(Gg={})),function(e){e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected"}(Wg||(Wg={})),function(e){e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PPublish="RequestP2PPublish",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE"}(Hg||(Hg={})),function(e){e.MUTE_LOCAL_VIDEO="mute_local_video",e.MUTE_LOCAL_AUDIO="mute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.MUTE_REMOTE_VIDEO="mute_remote_video",e.MUTE_REMOTE_AUDIO="mute_remote_audio",e.UNMUTE_REMOTE_VIDEO="unmute_remote_video",e.UNMUTE_REMOTE_AUDIO="unmute_remote_audio"}(Kg||(Kg={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}(qg||(qg={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(Yg||(Yg={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(Jg||(Jg={})),function(e){e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK"}(Xg||(Xg={})),function(e){e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback"}(zg||(zg={})),function(e){e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.SECURITY_POLICY_VIOLATION="security-policy-violation"}(Qg||(Qg={})),function(e){e[e.APP_TYPE_INVALID_VALUE=-1]="APP_TYPE_INVALID_VALUE",e[e.APP_TYPE_NATIVE=0]="APP_TYPE_NATIVE",e[e.APP_TYPE_NATIVE_COCOS=1]="APP_TYPE_NATIVE_COCOS",e[e.APP_TYPE_NATIVE_UNITY=2]="APP_TYPE_NATIVE_UNITY",e[e.APP_TYPE_NATIVE_ELECTRON=3]="APP_TYPE_NATIVE_ELECTRON",e[e.APP_TYPE_NATIVE_FLUTTER=4]="APP_TYPE_NATIVE_FLUTTER",e[e.APP_TYPE_NATIVE_UNREAL=5]="APP_TYPE_NATIVE_UNREAL",e[e.APP_TYPE_NATIVE_XAMARIN=6]="APP_TYPE_NATIVE_XAMARIN",e[e.APP_TYPE_NATIVE_API_CLOUD=7]="APP_TYPE_NATIVE_API_CLOUD",e[e.APP_TYPE_NATIVE_REACT_NATIVE=8]="APP_TYPE_NATIVE_REACT_NATIVE",e[e.APP_TYPE_NATIVE_PYTHON=9]="APP_TYPE_NATIVE_PYTHON",e[e.APP_TYPE_NATIVE_COCOS_CREATOR=10]="APP_TYPE_NATIVE_COCOS_CREATOR",e[e.APP_TYPE_NATIVE_RUST=11]="APP_TYPE_NATIVE_RUST",e[e.APP_TYPE_NATIVE_C_SHARP=12]="APP_TYPE_NATIVE_C_SHARP",e[e.APP_TYPE_NATIVE_CEF=13]="APP_TYPE_NATIVE_CEF",e[e.APP_TYPE_NATIVE_UNI_APP=14]="APP_TYPE_NATIVE_UNI_APP",e[e.APP_TYPE_WEBRTC=1e3]="APP_TYPE_WEBRTC",e[e.APP_TYPE_WEBRTC_REACT=1001]="APP_TYPE_WEBRTC_REACT",e[e.APP_TYPE_WEBRTC_VUE=1002]="APP_TYPE_WEBRTC_VUE",e[e.APP_TYPE_WEBRTC_ANGULAR=1003]="APP_TYPE_WEBRTC_ANGULAR"}(Zg||(Zg={})),function(e){e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED"}($g||($g={})),function(e){e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url"}(eT||(eT={})),function(e){e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED"}(tT||(tT={})),function(e){e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.SUBSCRIBE="subscribe",e.UNSUBSCRIBE="unsubscribe",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.JOIN="join",e.EXCHANGE_SDP="exchange_sdp",e.DO_SUBSCRIBE="do_subscribe",e.DO_UNSUBSCRIBE="do_unsubscribe"}(iT||(iT={})),function(e){e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video"}(nT||(nT={})),function(e){e[e.SUCCESS=1]="SUCCESS",e[e.FAILED=0]="FAILED"}(sT||(sT={}));const aT={[xS.ACCESS_POINT]:{[BS.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[BS.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[BS.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[BS.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[BS.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[BS.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[BS.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[xS.UNILBS]:{[jS.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[jS.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[jS.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[jS.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[jS.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[jS.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[jS.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[jS.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[jS.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[jS.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[jS.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[jS.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[xS.STRING_UID_ALLOCATOR]:{[FS.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[FS.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[FS.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function cT(e){const t=aT[Math.floor(e/1e4)];if(!t)return{desc:"unkonw error",retry:!1};const i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===xS.ACCESS_POINT){const t=e%1e4;if("1"===t.toString()[0])return{desc:e.toString(),retry:!1};if("2"===t.toString()[0])return{desc:e.toString(),retry:!0}}return{desc:"unkonw error",retry:!1}}return i}const dT={[GS.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[GS.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[GS.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[GS.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[GS.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[GS.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[GS.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[GS.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[GS.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[GS.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[GS.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[GS.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[GS.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[GS.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[GS.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[GS.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[GS.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[GS.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[GS.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[GS.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[GS.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[GS.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[GS.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[GS.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[GS.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[GS.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[GS.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[GS.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[GS.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[GS.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[GS.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[GS.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[GS.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[GS.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[GS.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[GS.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[GS.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[GS.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[GS.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[GS.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[GS.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[GS.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[GS.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[GS.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[GS.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[GS.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[GS.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[GS.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[GS.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[GS.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[GS.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[GS.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[GS.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[GS.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[GS.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[GS.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[GS.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[GS.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[GS.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[GS.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[GS.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[GS.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[GS.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function lT(e){const t=dT[e];return t||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function hT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function uT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?hT(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):hT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function pT(e){return e.every((e=>e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING))}function _T(e,t){if("string"==typeof e)return e;const{proxy:i,host:n,port:s}=e;if(t){const e=T("JOIN_GATEWAY_FALLBACK_PORT")||443;return 443===e?"wss://".concat(n,"/ws/?p=").concat(Number(s)+150):"wss://".concat(n,":").concat(e,"/ws/?p=").concat(Number(s)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(s):"wss://".concat(n,":").concat(s)}const ET=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,mT=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,fT=/wss:\/\/(.+):([0-9]+)\/?/,ST=/wss:\/\/(.[^\/]+)\/?/;let gT=0;class TT{constructor(e,t){this.id=0,this.store=void 0,this.recordIndex=void 0,this.websockets=[],this.try443PortDuration=2e3,this.forceCloseWSDuration=5e3,this.try443PortTimeout=null,this.forceCloseTimeout=null,this.isTry443PortFailed=!1,this.isNormalPortFailed=!1,this.useDoubleDomain=!1,this.useProxy=!1,this.startTime=Date.now(),this.id=++gT,this.try443PortDuration=T("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=t}closeAllWebsockets(){this.websockets.forEach((e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var e;const i=Date.now()-this.startTime;for(var n=arguments.length,s=new Array(n),o=0;o<n;o++)s[o]=arguments[o];t.debug("[choose-best-ws ".concat(null===(e=this.store)||void 0===e?void 0:e.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...s)}createWebSocket(e,t,i){this.logger("createWebSocket:",e,{isTry443Port:t,hasTimeoutDetection:i});const n=T("GATEWAY_DOMAINS"),s=Date.now(),o=[],r=n.find((t=>{var i;return jo(i=e.host).call(i,t)}));r||(this.useDoubleDomain=!1);const a=[];if(this.useDoubleDomain)n.forEach((i=>{a.push(_T(uT(uT({},e),{},{host:e.host.replace(r,i)}),t))}));else{const i=uT({},e);if(t&&r){const e=n.find((e=>e!==r));e&&(i.host=i.host.replace(r,e))}a.push(_T(i,t))}try{a.forEach((e=>{const t=new WebSocket(e);t.binaryType="arraybuffer",o.push(t),this.logger("ws is connecting:",t.url)}))}catch(n){if(this.logger("ws create failed"),o.forEach((e=>e.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,t,i);if(!t&&443!==Number(e.port))return this.createWebSocket(e,!0,i);throw new hg(h.WS_ERR,"init websocket failed! Error: ".concat(n.toString()))}const c=C();this.store&&this.store.recordJoinChannelService({urls:o.map((e=>e.url)),service:"gateway"},this.recordIndex),o.forEach((e=>{e.onopen=()=>{this.logger("onopen: ws ".concat(e.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((t=>{t!==e&&(t.onopen=null,t.onclose=null,t.onmessage=null,t.close(),this.logger("close backup websocket: ".concat(t.url)))})),this.websockets.length=0,c.resolve(e)},e.onclose=i=>{this.logger("onclose: ws ".concat(e.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(e.readyState)),t?this.isTry443PortFailed=pT(o):this.isNormalPortFailed=pT(o),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(t&&this.isTry443PortFailed||!t&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(i.reason)),c.reject({code:i.code,reason:Ng.A_ROUND_WS_FAILED}))},e.onmessage=t=>this.logger("".concat(e.url," onmessage: ").concat(t.data))})),this.websockets.push(...o);return i||(()=>{const i=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",c.isResolved),this.websockets.forEach((e=>e.readyState!==WebSocket.OPEN&&e.close()))};if(t||this.useProxy)return this.logger("add 5s timeout at ".concat(t?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{if(this.logger("2s timeout, isWebsocket created: ",c.isResolved),c.isResolved)return i();R()&&I()&&i(),this.createWebSocket(e,!0,!0).then((e=>c.resolve(e))).catch((e=>{this.isNormalPortFailed&&c.reject(e),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout(i,this.forceCloseWSDuration)}),this.try443PortDuration)})(),c.promise}chooseBestWebsocket(e,i,n,s){return this.useDoubleDomain=!!i,"string"==typeof e&&(e=function(e){let i,n,s;return[,i,n,s]=e.match(ET)||[],i||([,n,s]=e.match(mT)||[]),n&&s||([,n,s]=e.match(fT)||[]),n&&s||([,n]=e.match(ST)||[]),n||t.warning("un-destructible url: ",e),{proxy:i,host:n,port:s||"443"}}(e)),this.recordIndex=s,this.useProxy=!!e.proxy,n&&this.useProxy&&(t.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(e,!!n,!1).finally((()=>this.clearTimeout()))}}function CT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class RT extends g{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;jo(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(zS.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(zS.CONNECTED):"closed"===this._state?this.emit(zS.CLOSED):"failed"===this._state&&this.emit(zS.FAILED))}resetReconnectCount(e){t.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,t){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new v("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=o,this.name=e,this.retryConfig=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?CT(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):CT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t),this.useCompress=i,this.tryDoubleDomain=n,this.use443PortOnly=s;const{timeout:r,timeoutFactor:a}=t,c=Math.max(300,Math.floor(3*r/5)),d=Math.max(1.2,Math.floor(8*a)/10);y.ONLINE&&(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d),A.on(w.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===y.ONLINE?(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=d):(this.retryConfig.timeout=r,this.retryConfig.timeoutFactor=a))}))}getConnection(){return this.websocket||void 0}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=t,this.urls=e,this.state="connecting";try{const e=C(),t=this.urls[this.currentURLIndex];this.createWebSocketConnection(t).then(e.resolve).catch(e.reject),this.once(zS.CLOSED,(()=>{e.reject(new l(h.WS_DISCONNECT))})),this.once(zS.CONNECTED,e.resolve),await e.promise}catch(e){}finally{i()}}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const e=this.websocket;t?setTimeout((()=>e.close()),500):e.close(),this.websocket=void 0}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,i){if(!this.websocket)return void t.warning("[".concat(this.name,"] can not reconnect, no websocket"));void 0!==e&&(this.reconnectMode=e),t.debug("[".concat(this.name,"] reconnect is triggered initiative")),"number"==typeof this.joinGatewayRecordIndex&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);const n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new l(h.WS_ABORT,"websocket is not ready");try{t||(e=JSON.stringify(e)),this.websocket.send(e)}catch(e){throw new l(h.WS_ERR,"send websocket message error"+e.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){const e=this.wsInflateLength,t=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:t}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(e){var i;const n=C();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const s=e=>{var i;null===(i=this.store)||void 0===i||i.signalChannelOpen(),t.debug("[".concat(this.name,"] websocket opened:"),e),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},o=async e=>{var i;if(t.debug("[".concat(this.name,"] websocket close ").concat(null===(i=this.websocket)||void 0===i?void 0:i.url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new l(h.WS_DISCONNECT,"websocket close: ".concat(e.code))),this.close();else{"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const i=D(this,zS.WILL_RECONNECT,this.reconnectMode,e.reason)||this.reconnectMode,s=await this.reconnectWithAction(i);if("closed"===this.state)return void t.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!s)return n.reject(new l(h.WS_DISCONNECT,"websocket reconnect failed: ".concat(e.code))),this.close(!0);n.resolve()}},r=e=>{this.emit(zS.ON_MESSAGE,e)},a=e=>{t.warn("[".concat(this.connectionID,"] ws open error ").concat(e))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),T("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=T("GATEWAY_WSS_ADDRESS")),t.debug("[".concat(this.name,"] start connect, url:"),e);const c=null===(i=this.store)||void 0===i?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const t=await this.chooseBestWebsocketConnection(e);this.websocket=t,s&&s(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=r,this.websocket.onerror=a,null===(d=this.store)||void 0===d||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(e){const i="closed"===this.state,s=e instanceof l,r=s&&e.code===h.WS_ABORT,a=s&&e.code===h.WS_ERR,d=s?e.message:e&&(e.reason||e.toString());t.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(d)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:r?"aborted":"error",errors:[e]},c),i||a?(n.reject(i?new l(h.WS_DISCONNECT,"websocket is closed: ".concat(d)):new l(h.WS_ERR,"init websocket failed: ".concat(d))),a&&t.error("[".concat(this.name,"] init websocket failed: ").concat(d))):o&&o(e)}return n.promise}async reconnectWithAction(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount)return!1;if(0===this.urls.length)return!1;if("closed"===this.state)return!1;t.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||A.isOnline||!A.onlineWaiter||(this.onlineReconnectListener=A.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let n=!0;if(this.reconnectInterrupter=()=>n=!1,i){const i=O(this.reconnectCount,this.retryConfig);t.debug("[".concat(this.name,"] wait ").concat(i,"ms to reconnect websocket, mode: ").concat(e)),await eg.race([N(i),this.onlineReconnectListener||new eg((()=>{}))])}if("closed"===this._state||!n)return!1;this.reconnectCount+=1;const s=async(e,t)=>{this.emit(zS.RECONNECT_CREATE_CONNECTION,t),await this.createWebSocketConnection(e)};try{if("retry"===e)this.emit(zS.RECONNECT_WAITTING_FINISH,e),await s(this.urls[this.currentURLIndex],e);else if("tryNext"===e){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);t.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(zS.RECONNECT_WAITTING_FINISH,e),await s(this.urls[this.currentURLIndex],e)}else"recover"===e&&(t.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(zS.RECONNECT_WAITTING_FINISH,e),this.urls=await b(this,zS.REQUEST_NEW_URLS),this.currentURLIndex=0,await s(this.urls[this.currentURLIndex],e))}catch(n){var o;t.error("[".concat(this.name,"] reconnect failed ").concat(n&&n.toString()));const s=null==n||null===(o=n.data)||void 0===o?void 0:o.desc;return Array.isArray(s)&&jo(s).call(s,"dynamic key expired")?(this.emit(zS.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,i)}return!0}}class IT extends RT{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){const n=C(),s=function(e,t){return new TT(e,t)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{t.debug("[choose-best-ws] close establishing websockets"),s.closeAllWebsockets(),n.reject(new l(h.WS_ABORT,"choose best websocket aborted"))};const o=T("GATEWAY_DOMAINS");return t.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),s.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,i).then(n.resolve).catch(n.reject),n.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class vT extends RT{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3],arguments.length>4&&void 0!==arguments[4]&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(e,i){return new eg(((n,s)=>{let o=!1;const r=[];this.closeEstablishingWs=()=>{t.debug("[choose-best-ws] close establishing websockets"),r.forEach((e=>{e.onclose=null,e.onopen=null,e.onmessage=null,e.close()})),s(new l(h.WS_ABORT,"choose best websocket aborted"))};const a=T("GATEWAY_DOMAINS");let c;const d=e.indexOf("?h="),u=a.find((t=>-1!==d?jo(e).call(e,t,d):jo(e).call(e,t)));t.debug("[choose-best-ws] currentDomain: ",u,", domains: ",a);let p=!this.tryDoubleDomain||!u;if(!p&&u){var _;const l=Date.now();try{a.forEach((i=>{const n=-1===d?e.replace(u,i):e.substr(0,d)+e.substr(d).replace(u,i),s=new WebSocket(n);s.binaryType="arraybuffer",r.push(s),t.debug("[choose-best-ws] ws is connecting:",s.url)}))}catch(e){for(t.debug("[choose-best-ws] ws create failed, fallback to single url"),r.forEach((e=>e.close()));r.length;)r.pop();p=!0}null===(_=this.store)||void 0===_||_.recordJoinChannelService({urls:r.map((e=>e.url)),service:"gateway"},i),r.forEach((e=>{e.onopen=()=>{if(o)return;const i=Date.now()-l;t.debug("[choose-best-ws] ws open cost ".concat(i,"ms")),r.filter((t=>t!==e)).forEach((e=>{t.debug("[choose-best-ws]close backup websocket: ".concat(e.url)),e.close()})),o=!0,n(e)},e.onclose=e=>{if(c=e,o)return;r.find((e=>!(e.readyState===WebSocket.CLOSED||e.readyState===WebSocket.CLOSING)))||(t.debug("[choose-best-ws] all websocket is closed"),o=!0,s(c))},e.onmessage=i=>{t.debug("[choose-best-ws]".concat(e.url," onmessage: ").concat(i.data))}})),N(this.forceCloseTimeout).then((()=>{r.forEach((e=>{e.readyState!==WebSocket.OPEN&&e.close()}))}))}if(p){var E;let o;t.debug("[choose-best-ws] use single url: ",e),null===(E=this.store)||void 0===E||E.recordJoinChannelService({urls:[e],service:"gateway"},i);try{o=new WebSocket(e),r.push(o),o.binaryType="arraybuffer"}catch(e){const i=new l(h.WS_ERR,"init websocket failed! Error: ".concat(e.toString()));return t.error("[".concat(this.name,"]").concat(i)),void s(i)}o.onopen=()=>{n(o)},o.onclose=e=>{s(e)},o.onmessage=e=>{t.debug("[choose-best-ws]".concat(o.url," onmessage: ").concat(e.data))},N(this.forceCloseTimeout).then((()=>{o&&o.readyState!==WebSocket.OPEN&&o.close()}))}})).then((e=>(this.closeEstablishingWs=void 0,e))).catch((e=>{throw this.closeEstablishingWs=void 0,e}))}}class yT extends g{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===WS.CONNECTED?this.emit(HS.WS_CONNECTED):e===WS.RECONNECTING?this.emit(HS.WS_RECONNECTING,this._websocketReconnectReason):e===WS.CLOSED&&this.emit(HS.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=WS.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new P(5),this.pingpongTimer=void 0,this.wsInflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(HS.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){if(this.emit(t._type,t._message),t._type===YS.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===YS.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}if(t._type===YS.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case GS.ERR_LICENSE_MISSING:this.close(L.LICENSE_MISSING);break;case GS.ERR_LICENSE_EXPIRED:this.close(L.LICENSE_EXPIRED);break;case GS.ERR_LICENSE_MINUTES_EXCEEDED:this.close(L.LICENSE_MINUTES_EXCEEDED);break;case GS.ERR_LICENSE_PERIOD_INVALID:this.close(L.LICENSE_PERIOD_INVALID);break;case GS.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(L.LICENSE_MULTIPLE_SDK_SERVICE);break;case GS.ERR_LICENSE_ILLEGAL:this.close(L.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new IT("gateway-".concat(this.clientId),this.spec.retryConfig,!0,T("JOIN_GATEWAY_USE_DUAL_DOMAIN"),T("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===WS.CONNECTED&&this.reconnect("retry",k.OFFLINE)}))}async request(e,i,n,s){const o=M(6,""),r={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new eg(((t,i)=>{if(this.connectionState===WS.CONNECTED)return t();const n=()=>{this.off(HS.WS_CLOSED,s),t()},s=()=>{this.off(HS.WS_CONNECTED,n),i(new hg(h.WS_ABORT))};this.once(HS.WS_CONNECTED,n),this.once(HS.WS_CLOSED,s),e!==KS.PUBLISH&&e!==KS.SUBSCRIBE&&e!==KS.UNSUBSCRIBE&&e!==KS.UNPUBLISH&&e!==KS.CONTROL&&e!==KS.RESTART_ICE||this.once(HS.DISCONNECT_P2P,(()=>{i(new hg(h.DISCONNECT_P2P))})),e!==KS.PUBLISH&&e!==KS.RESTART_ICE||this.once(HS.ABORT_P2P_EXECUTION,(()=>{i(new hg(h.DISCONNECT_P2P))}))}));if(this.connectionState!==WS.CONNECTING&&this.connectionState!==WS.RECONNECTING||e===KS.JOIN||e===KS.REJOIN||await c(),this.websocket.sendMessage(r,!0),s)return;const d=new eg(((n,s)=>{let r=!1;const c=(t,s)=>{r=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(HS.WS_CLOSED,d),this.off(HS.WS_RECONNECTING,d),this.emit(HS.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new hg(h.WS_ABORT,"type: ".concat(e))),this.off(HS.WS_CLOSED,d),this.off(HS.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(HS.WS_CLOSED,d),this.once(HS.WS_RECONNECTING,d),N(T("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||r||(t.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(HS.REQUEST_TIMEOUT,e,i))}))}));let l=null;try{l=await d}catch(t){if(this.connectionState===WS.CLOSED||e===KS.LEAVE)throw new hg(h.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===KS.JOIN||e===KS.REJOIN?null:(await c(),await this.request(e,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=lT(u),_=new hg(h.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return"success"===p.action?l.message:(t.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===GS.ERR_TOO_MANY_BROADCASTERS?e===KS.JOIN||e===KS.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===GS.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",k.MULTI_IP)):this.reconnect(p.action,k.SERVER_ERROR),e===KS.JOIN||e===KS.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new eg((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=T("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==WS.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),T("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new eg(((t,i)=>{this.once(HS.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(HS.WS_CLOSED,(()=>i(this.initError||new hg(h.WS_ABORT)))),this.connectionState=WS.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||L.LEAVE,this.connectionState=WS.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new IT("gateway-".concat(this.clientId),this.spec.retryConfig,!0,T("JOIN_GATEWAY_USE_DUAL_DOMAIN"),T("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(HS.ABORT_P2P_EXECUTION);const e=await b(this,HS.REQUEST_JOIN_INFO),t=await this.request(KS.JOIN,e);if(!t)return this.emit(HS.REPORT_JOIN_GATEWAY,Ng.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(HS.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=WS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new hg(h.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=U(this,HS.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(KS.REJOIN,e);return!!t&&(this.connectionState=WS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(YS.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(YS.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(YS.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(YS.MUTE_AUDIO,{uid:e.uid}):this.emit(YS.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(YS.MUTE_VIDEO,{uid:e.uid}):this.emit(YS.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(YS.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(YS.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(YS.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(YS.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(YS.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=lT(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,k.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=T("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>T("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",k.TIMEOUT):this.request(KS.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),T("REPORT_STATS")&&this.send(KS.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(qS.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(zS.RECONNECT_WAITTING_FINISH,(e=>{this.emit(HS.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(zS.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(HS.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(zS.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(zS.CLOSED,(()=>{this.connectionState=WS.CLOSED})),this.websocket.on(zS.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=WS.CLOSED})),this.websocket.on(zS.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===WS.CONNECTED?this.connectionState=WS.RECONNECTING:this.connectionState=WS.CONNECTING})),this.websocket.on(zS.WILL_RECONNECT,((e,i,n)=>{const s=U(this,HS.IS_P2P_DISCONNECTED),o=s||"retry"!==e;s&&"retry"===e&&(t.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",i=Ng.P2P_DISCONNECTED),o&&(t.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(HS.REPORT_JOIN_GATEWAY,i||Ng.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(HS.NEED_RENEW_SESSION),this.emit(HS.DISCONNECT_P2P)),n(e)})),this.websocket.on(zS.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{t.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",k.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(HS.REPORT_JOIN_GATEWAY,e.message||e.code||Ng.UNKNOWN_REASON,this.url||""),e instanceof hg&&e.code===h.UNEXPECTED_RESPONSE&&e.data.code===GS.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",k.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",k.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(zS.REQUEST_NEW_URLS,((e,t)=>{b(this,HS.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(zS.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(YS.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}var AT="\t\n\v\f\r Â áââââââââââââ¯âã\u2028\u2029\ufeff",wT=ai,OT=Ao,NT=AT,bT=Ct("".replace),DT=RegExp("^["+NT+"]+"),PT=RegExp("(^|[^"+NT+"])["+NT+"]+$"),LT=function(e){return function(t){var i=OT(wT(t));return 1&e&&(i=bT(i,DT,"")),2&e&&(i=bT(i,PT,"$1")),i}},kT={start:LT(1),end:LT(2),trim:LT(3)},MT=lh.PROPER,UT=Et,VT=AT,xT=kT.trim;Bs({target:"String",proto:!0,forced:function(e){return UT((function(){return!!VT[e]()||"âÂá "!=="âÂá "[e]()||MT&&VT[e].name!==e}))}("trim")},{trim:function(){return xT(this)}});var FT,jT=ao("String").trim,BT=Rt,GT=jT,WT=String.prototype,HT=_t((function(e){var t=e.trim;return"string"==typeof e||e===WT||BT(WT,e)&&t===WT.trim?GT:t}));!function(e){e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK"}(FT||(FT={}));class KT extends g{constructor(){super(...arguments),this.resultStorage=new Map}setLocalAudioStats(e,t,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(i,t)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(i,t))}setLocalVideoStats(e,t,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(i,t)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(i,t)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(i))}setRemoteAudioStats(e,t){const i=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(t))}setRemoteVideoStats(e,t){const i=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(t))}record(e,t,i){if(T("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});const n=this.resultStorage.get(e);if(n&&(n.result.push(i),n.result.length>=5)){var s;const i=jo(s=n.result).call(s,!0);n.isPrevNormal&&!i&&this.emit("exception",qT[e],e,t),!n.isPrevNormal&&i&&this.emit("exception",qT[e]+2e3,e+"_RECOVER",t),n.isPrevNormal=i,n.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&0===e.receiveLevel)}checkAudioInputLevel(e,t){return t instanceof Le&&!t.isActive||(!!t.muted||0!==e.sendVolumeLevel)}checkFramerateInput(e,t){let i=null;t._encoderConfig&&t._encoderConfig.frameRate&&(i=tC(t._encoderConfig.frameRate));const n=e.captureFrameRate;return!i||!n||!(i>10&&n<5||i<10&&i>=5&&n<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,t){return!!t.muted||0!==e.sendBitrate}checkSendAudioBitrate(e,t){return t instanceof Le&&!t.isActive||(!!t.muted||0!==e.sendBitrate)}checkVideoDecode(e){return 0===e.receiveBitrate||0!==e.decodeFrameRate}}const qT={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003};const YT=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}measureFromPublishStart(e,t){const i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){const e=i[i.length-1];return Math.round(performance.now()-e.startTime)}return 0}};function JT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function XT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?JT(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):JT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class zT{constructor(e){this.store=void 0,this.onStatsException=void 0,this.onUploadPublishDuration=void 0,this.onStatsChanged=void 0,this.localStats=new Map,this.remoteStats=new Map,this.updateStatsInterval=void 0,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0,this.exceptionMonitor=void 0,this.p2pChannel=void 0,this.scalabilityMode=US.L1T1,this.updateStats=()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))},this.store=e,this.updateStatsInterval=window.setInterval(this.updateStats,1e3),this.exceptionMonitor=new KT,this.exceptionMonitor.on("exception",((e,t,i)=>{this.onStatsException&&this.onStatsException(e,t,i)}))}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Gg.LocalAudioTrack)||XT({},ke)}getLocalVideoTrackStats(){return this.localStats.get(Gg.LocalVideoTrack)||XT({},Me)}getRemoteAudioTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppad+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.audioStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{audioStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRemoteNetworkQualityStats(e){const t={};if(e){var i;const n=null===(i=this.remoteStats.get(e))||void 0===i?void 0:i.networkStats;n&&(t[e]=n)}else Array.from(this.remoteStats.entries()).forEach((e=>{let[i,{networkStats:n}]=e;n&&(t[i]=n)}));return t}getRemoteVideoTrackStats(e){const t=(e,t)=>{if(!this.trafficStats)return t;const i=this.trafficStats.peer_delay.find((t=>t.peer_uid===e));return i&&(t.publishDuration=i.B_ppvd+(Date.now()-this.trafficStats.timestamp)),t},i={};if(e){var n;const s=null===(n=this.remoteStats.get(e))||void 0===n?void 0:n.videoStats;s&&(i[e]=t(e,s))}else Array.from(this.remoteStats.entries()).forEach((e=>{let[n,{videoStats:s}]=e;s&&(i[n]=t(n,s))}));return i}getRTCStats(){let e=0,t=0,i=0,n=0;const s=this.localStats.get(Gg.LocalAudioTrack);s&&(e+=s.sendBytes,t+=s.sendBitrate);const o=this.localStats.get(Gg.LocalVideoTrack);o&&(e+=o.sendBytes,t+=o.sendBitrate);const r=this.localStats.get(Gg.LocalVideoLowTrack);r&&(e+=r.sendBytes,t+=r.sendBitrate),this.remoteStats.forEach((e=>{let{audioStats:t,videoStats:s}=e;t&&(i+=t.receiveBytes,n+=t.receiveBitrate),s&&(i+=s.receiveBytes,n+=s.receiveBitrate)}));let a=1;return this.trafficStats&&(a+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:a,SendBitrate:t,SendBytes:e,RecvBytes:i,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter((e=>void 0!==e.B_ppad||void 0!==e.B_ppvd));e.peer_delay.filter((e=>-1===this.trafficStatsPeerList.indexOf(e.peer_uid))).forEach((e=>{var t;const i=null===(t=this.p2pChannel)||void 0===t?void 0:t.getRemoteMedia(e.peer_uid),n=null!=i&&i.videoSSRC?YT.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=null!=i&&i.audioSSRC?YT.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;void 0!==e.B_ppad&&void 0!==e.B_ppvd&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(e.peer_uid,e.B_ppad,e.B_ppvd,n>s?n:s),this.trafficStatsPeerList.push(e.peer_uid))})),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&t.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,t,i){if(!e)return!1;const n=!!i&&t.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||t.framesDecodeCount>i.framesDecodeCount;return n||!s}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&(e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3)}updateLocalStats(e){Array.from(this.localStats.entries()).forEach((i=>{let[n,s]=i;switch(n){case Gg.LocalVideoTrack:case Gg.LocalVideoLowTrack:{const i=s,r=XT({},Me),a=e.getStats(),c=e.getLocalMedia(n);if(a){const n=a.videoSend.find((e=>e.ssrc===(null==c?void 0:c.ssrcs[0].ssrcId)));if(n){const s=e.getLocalVideoSize(),o=e.getEncoderConfig(Gg.LocalVideoTrack);"H264"!==n.codec&&"H265"!==n.codec&&"VP8"!==n.codec&&"VP9"!==n.codec&&"AV1X"!==n.codec&&"AV1"!==n.codec||(r.codecType=n.codec),r.sendBytes=n.bytes,r.sendBitrate=i?8*Math.max(0,r.sendBytes-i.sendBytes):0,n.inputFrame?(r.captureFrameRate=n.inputFrame.frameRate,r.captureResolutionHeight=n.inputFrame.height,r.captureResolutionWidth=n.inputFrame.width):s&&(r.captureResolutionWidth=s.width,r.captureResolutionHeight=s.height),n.sentFrame?(r.sendFrameRate=n.sentFrame.frameRate,r.sendResolutionHeight=n.sentFrame.height,r.sendResolutionWidth=n.sentFrame.width):s&&(r.sendResolutionWidth=s.width,r.sendResolutionHeight=s.height),n.avgEncodeMs&&(r.encodeDelay=n.avgEncodeMs),o&&o.bitrateMax&&(r.targetSendBitrate=1e3*o.bitrateMax),r.sendPackets=n.packets,r.sendPacketsLost=n.packetsLost,r.sendJitterMs=n.jitterMs,r.sendRttMs=n.rttMs,r.totalDuration=i?i.totalDuration+1:1,r.totalFreezeTime=i?i.totalFreezeTime:0,this.isLocalVideoFreeze(n)&&(r.totalFreezeTime+=1),n.scalabilityMode&&this.scalabilityMode!==n.scalabilityMode&&(t.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(n.scalabilityMode)),this.scalabilityMode=n.scalabilityMode)}this.trafficStats&&(r.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;if(this.localStats.set(n,r),(null==i?void 0:i.sendResolutionWidth)!==r.sendResolutionWidth||(null==i?void 0:i.sendResolutionHeight)!==r.sendResolutionHeight)null===(o=this.onStatsChanged)||void 0===o||o.call(this,"resolution",{width:r.sendResolutionWidth,height:r.sendResolutionHeight});r&&c&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,c.track,r);break}case Gg.LocalAudioTrack:{const t=s,i=XT({},ke),o=e.getStats(),r=e.getLocalMedia(n);if(o){const n=o.audioSend.find((e=>e.ssrc===(null==r?void 0:r.ssrcs[0].ssrcId)));if(n){if("opus"!==n.codec&&"aac"!==n.codec&&"PCMU"!==n.codec&&"PCMA"!==n.codec&&"G722"!==n.codec||(i.codecType=n.codec),n.inputLevel)i.sendVolumeLevel=Math.round(32767*n.inputLevel);else{const t=e.getLocalAudioVolume();t&&(i.sendVolumeLevel=Math.round(32767*t))}i.sendBytes=n.bytes,i.sendPackets=n.packets,i.sendPacketsLost=n.packetsLost,i.sendJitterMs=n.jitterMs,i.sendRttMs=n.rttMs,i.sendBitrate=t?8*Math.max(0,i.sendBytes-t.sendBytes):0}}this.trafficStats&&(i.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(Gg.LocalAudioTrack,i),i&&r&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,r.track,i);break}}}))}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach((t=>{let[i,{videoStats:n,audioStats:s,videoPcStats:o}]=t;const r=s,a=n,c=o,d=XT({},Ue),l=XT({},Ve),h=XT({},xe),{audioTrack:u,videoTrack:p,audioSSRC:_,videoSSRC:E}=e.getRemoteMedia(i),m=e.getStats(),f=null==m?void 0:m.audioRecv.find((e=>e.ssrc===_)),S=null==m?void 0:m.videoRecv.find((e=>e.ssrc===E)),g=this.trafficStats&&this.trafficStats.peer_delay.find((e=>e.peer_uid===i));if(f&&("opus"!==f.codec&&"aac"!==f.codec&&"PCMU"!==f.codec&&"PCMA"!==f.codec&&"G722"!==f.codec||(d.codecType=f.codec),f.outputLevel?d.receiveLevel=Math.round(32767*f.outputLevel):u&&(d.receiveLevel=Math.round(32767*u.getVolumeLevel())),d.receiveBytes=f.bytes,d.receivePackets=f.packets,d.receivePacketsLost=f.packetsLost,d.packetLossRate=d.receivePacketsLost/(d.receivePackets+d.receivePacketsLost),d.receiveBitrate=r?8*Math.max(0,d.receiveBytes-r.receiveBytes):0,d.totalDuration=r?r.totalDuration+1:1,d.totalFreezeTime=r?r.totalFreezeTime:0,d.freezeRate=d.totalFreezeTime/d.totalDuration,d.receiveDelay=f.jitterBufferMs,d.totalDuration>10&&zT.isRemoteAudioFreeze(u)&&(d.totalFreezeTime+=1)),S){"H264"!==S.codec&&"H265"!==S.codec&&"VP8"!==S.codec&&"VP9"!==S.codec&&"AV1X"!==S.codec&&"AV1"!==S.codec||(l.codecType=S.codec),l.receiveBytes=S.bytes,l.receiveBitrate=a?8*Math.max(0,l.receiveBytes-a.receiveBytes):0,l.decodeFrameRate=S.decodeFrameRate<0?0:S.decodeFrameRate,l.renderFrameRate=S.decodeFrameRate<0?0:S.decodeFrameRate,S.outputFrame&&(l.renderFrameRate=S.outputFrame.frameRate),S.receivedFrame?(l.receiveFrameRate=S.receivedFrame.frameRate,l.receiveResolutionHeight=S.receivedFrame.height,l.receiveResolutionWidth=S.receivedFrame.width):p&&(l.receiveResolutionHeight=p._videoHeight||0,l.receiveResolutionWidth=p._videoWidth||0),void 0!==S.framesRateFirefox&&(l.receiveFrameRate=Math.round(S.framesRateFirefox)),l.receivePackets=S.packets,l.receivePacketsLost=S.packetsLost,l.packetLossRate=l.receivePacketsLost/(l.receivePackets+l.receivePacketsLost),l.totalDuration=a?a.totalDuration+1:1,l.totalFreezeTime=a?a.totalFreezeTime:0,l.receiveDelay=S.jitterBufferMs||0;const t=!!E&&e.getRemoteVideoIsReady(E);p&&t&&zT.isRemoteVideoFreeze(p,S,c)&&(l.totalFreezeTime+=1),l.freezeRate=l.totalFreezeTime/l.totalDuration}g&&(d.end2EndDelay=g.B_ad,l.end2EndDelay=g.B_vd,d.transportDelay=g.B_ed,l.transportDelay=g.B_ed,d.currentPacketLossRate=g.B_ealr4/100,l.currentPacketLossRate=g.B_evlr4/100,h.uplinkNetworkQuality=g.B_punq?g.B_punq:0,h.downlinkNetworkQuality=g.B_pdnq?g.B_pdnq:0),this.remoteStats.set(i,{audioStats:d,videoStats:l,videoPcStats:S,networkStats:h}),u&&this.exceptionMonitor.setRemoteAudioStats(u,d),p&&this.exceptionMonitor.setRemoteVideoStats(p,l)}))}}function QT(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ZT(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?QT(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):QT(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function $T(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(T("TURN_DOMAIN")):(t.info("Cannot recognized as IP address ".concat(e,". Used As Host instead")),e)}function eC(e,i){var n,s;const o=T("GATEWAY_DOMAINS");let r=o[1]&&-1!==i.indexOf(o[1])?1:0;e.addresses=e.addresses||[];const a=e.addresses.map((e=>e.domain_prefix?{address:"".concat(e.domain_prefix,".").concat(o[r++%o.length],":").concat(e.port)}:e.ip.match(/^[\.\:\d]+$/)?{ip:e.ip,port:e.port,address:"".concat(e.ip.replace(/[^\d]/g,"-"),".").concat(o[r++%o.length],":").concat(e.port)}:(t.info("Cannot recognized as IP address ".concat(e.ip,". Used As Host instead")),{ip:e.ip,port:e.port,address:"".concat(e.ip,":").concat(e.port)})));if(null!==(n=e.detail)&&void 0!==n&&n[18]&&"string"==typeof(null===(s=e.detail)||void 0===s?void 0:s[18])){const t=e.detail[18],i=null==t?void 0:t.split(";");for(let e=0;e<i.length;e++){var c;const t=HT(c=i[e]).call(c);a[e]&&t&&(a[e].ip6=t)}}return{gatewayAddrs:a,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function tC(e){return"number"==typeof e?e:e.exact||e.ideal||e.max||e.min||0}function iC(e){const t=e._encoderConfig;if(!t)return{};const i={resolution:t.width&&t.height?"".concat(tC(t.width),"x").concat(tC(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return"number"==typeof t.frameRate?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function nC(e){const t={connectionType:0,googRtt:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const i=e.selectedCandidatePair.localCandidate.relayProtocol;"udp"===i&&(t.connectionType=1),"tcp"===i&&(t.connectionType=3),"tls"===i&&(t.connectionType=4);break}case"srflx":t.connectionType=2}return t}function sC(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function oC(e,t){let i,n,s;switch(t){case FT.CHOOSE_SERVER:n=4096,s="choose server";break;case FT.CLOUD_PROXY:n=1048576,s="proxy";break;case FT.CLOUD_PROXY_5:n=4194304,s="proxy5";break;case FT.CLOUD_PROXY_FALLBACK:n=4194310,s="proxy fallback";break;default:throw new hg(h.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((t=>{t.buffer&&t.buffer.flag===n&&(i={code:t.buffer.code,addresses:(t.buffer.edges_services||[]).map((e=>ZT(ZT({},e),{},{ticket:t.buffer.cert}))),server_ts:e.enter_ts,uid:t.buffer.uid,cid:t.buffer.cid,cname:t.buffer.cname,detail:ZT(ZT({},t.buffer.detail),e.detail),flag:t.buffer.flag,opid:e.opid,cert:t.buffer.cert})})),!i)throw new hg(h.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(s," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return i}async function rC(e,t){return await eg.all(e.addresses.map((async e=>({address:$T(e.ip),tcpport:e.port,udpport:e.port,username:t&&T("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():qo.username,password:t&&T("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await V(t.toString()):qo.password}))))}function aC(e,i){const n=i._videoHeight||i.getMediaStreamTrack(!0).getSettings().height;return n?Math.max(n/tC(e.height),1):(t.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function cC(e){let{candidateType:t,relayProtocol:i,type:n,address:s,port:o,protocol:r}=e;return"local-candidate"===n?{candidateType:t,relayProtocol:i,protocol:r}:{candidateType:t,relayProtocol:i,address:s,port:o,protocol:r}}function dC(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class lC extends g{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var t;jo(t=["tryNext","recover"]).call(t,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,"reconnecting"===this._state?this.emit(zg.RECONNECTING,this.reconnectReason):"connected"===this._state?this.emit(zg.CONNECTED):"closed"===this._state?this.emit(zg.CLOSED):"failed"===this._state&&this.emit(zg.FAILED))}constructor(e,t,i,n){super(),this.connectionID=0,this.currentURLIndex=0,this.reconnectReason=void 0,this._reconnectMode="tryNext",this._name=void 0,this._state="closed",this._retryConfig=void 0,this._reconnectCount=0,this._forceCloseTimeout=5e3,this._onlineReconnectListener=void 0,this._closeEstablishingTransmitter=()=>{},this._store=void 0,this._joinChannelServiceRecordIndex=void 0,this._useCompress=void 0,this._inflateLength=0,this._deflateLength=0,this._store=n,this._name=e,this._retryConfig=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?dC(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):dC(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},t),this._useCompress=i}resetReconnectCount(e){t.debug("".concat(this._name," reset reconnect count, reason: ").concat(e)),this._reconnectCount=0}close(e,t){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const e=this._transmitter;t?setTimeout((()=>e.close()),500):e.close(),this._transmitter=void 0}this.state=e?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(e,i){if(!this._transmitter)return void t.warning("[".concat(this._name,"] can not reconnect, no websocket"));var n;(void 0!==e&&(this.reconnectMode=e),t.debug("[".concat(this._name,"] reconnect is triggered initiative")),"number"==typeof this._joinChannelServiceRecordIndex)&&(null===(n=this._store)||void 0===n||n.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));const s=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),s&&s.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){const e=this._inflateLength,t=this._deflateLength;return this.clearInflateData(),{inflateLength:e,deflateLength:t}}setInflateData(e){this._deflateLength=this._deflateLength+e.originLength,this._inflateLength=this._inflateLength+e.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}var hC;!function(e){e[e.Default=0]="Default",e[e.Ack=1]="Ack"}(hC||(hC={}));class uC{constructor(e,t,i){this.version=1,this.initialRTO=void 0,this.maxBatchAckCount=void 0,this.maxRTO=void 0,this.initialRTT=void 0,this.ID=void 0,this.rtt=void 0,this.packetNumber=1,this.rtoRatioMap=new Map,this.timeoutMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer=void 0,this.sendImpl=void 0,this.receiveImpl=void 0,this.sendImpl=e,this.receiveImpl=t,this.ID=M(7,"transmitter-"),this.initialRTO=void 0!==(null==i?void 0:i.initialRTO)?i.initialRTO:T("TRANSMITTER_INITIAL_RTO"),this.initialRTT=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:T("TRANSMITTER_INITIAL_RTT"),this.rtt=void 0!==(null==i?void 0:i.initialRTT)?i.initialRTT:T("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=void 0!==(null==i?void 0:i.maxBatchAckCount)?i.maxBatchAckCount:T("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=void 0!==(null==i?void 0:i.maxRTO)?i.maxRTO:T("TRANSMITTER_MAX_RTO")}packetize(e,t){return{type:hC.Default,version:this.version,packetNumber:t,payload:e}}serialize(e){switch(e.type){case hC.Default:{let t;if("string"==typeof e.payload){t=(new TextEncoder).encode(e.payload)}else t=e.payload;const i=new ArrayBuffer(t.length+15),n=new DataView(i);n.setUint16(0,e.version),n.setUint8(2,e.type),n.setUint32(3,e.packetNumber),x(n,7,BigInt(e.sendTs));return new Uint8Array(n.buffer).set(t,15),i}case hC.Ack:{const t=new ArrayBuffer(16),i=new DataView(t);return i.setUint16(0,e.version),i.setUint8(2,e.type),i.setUint32(3,e.maxAckPacketNumber),i.setUint8(7,e.shift),x(i,8,BigInt(e.ackSendTs)),t}}}deserialize(e){const i=new DataView(e),n=i.getUint16(0),s=i.getUint8(2);switch(s){case hC.Default:{const t=i.getUint32(3),o=F(i,7),r=e.slice(15),a=(new TextDecoder).decode(r);return{version:n,type:s,packetNumber:t,sendTs:Number(o),payload:a}}case hC.Ack:{const e=i.getUint32(3),t=i.getUint8(7),o=F(i,8);return{version:n,type:s,maxAckPacketNumber:e,shift:t,ackSendTs:Number(o)}}default:throw t.error("[".concat(this.ID,"] Unrecognized packet type ").concat(s)),new Error("Unrecognized packet type ".concat(s))}}sendMessage(e){const t=this.packetize(e,this.packetNumber);this.packetNumber=4294967295===this.packetNumber?1:this.packetNumber+1;const i=this.calculateRTO(t),n=window.setTimeout((()=>{this.resendMessage(t)}),i);this.timeoutMap.set(t.packetNumber,n),this.sendPacket(t)}onData(e){const t=this.deserialize(e);t.type===hC.Default?this.ack(t):t.type===hC.Ack&&(this.updateRTT(t,Math.round(performance.now())),this.clearRTO(t))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((e=>{let[t,i]=e;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,void 0!==this.batchAckTimer&&window.clearTimeout(this.batchAckTimer)}resendMessage(e){const t=this.calculateRTO(e),i=window.setTimeout((()=>{this.resendMessage(e)}),t);this.timeoutMap.set(e.packetNumber,i),this.sendPacket(e)}calculateRTO(e){const t=this.rtoRatioMap.get(e.packetNumber);if(void 0===t)return this.rtoRatioMap.set(e.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*t;return this.rtoRatioMap.set(e.packetNumber,t+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(e,t){const i=e.ackSendTs;this.rtt=this.rtt*(7/8)+(t-i-this.rtt)/8}ack(e){if(e.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(e):(this.batchAckPacketQueue.push(e),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(e.payload);;){const e=this.unorderedPacketQueue[0];if(!e){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(e.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(e.packetNumber<=this.lastOrderedPacketNumber){const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:hC.Ack,version:this.version};this.sendPacket(t)}else if(e.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[e.packetNumber-this.lastOrderedPacketNumber-2]=e;const t={ackSendTs:e.sendTs,maxAckPacketNumber:e.packetNumber,shift:0,type:hC.Ack,version:this.version};this.sendPacket(t)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const e={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:hC.Ack,version:this.version};this.sendPacket(e),this.batchAckPacketQueue=[]}sendPacket(e){e.type===hC.Default&&(e.sendTs=Math.round(performance.now()));const t=this.serialize(e);this.sendImpl(t)}clearRTO(e){for(let t=e.maxAckPacketNumber-e.shift;t<=e.maxAckPacketNumber;t++){const e=this.timeoutMap.get(t);void 0!==e&&window.clearTimeout(e),this.timeoutMap.delete(t),this.rtoRatioMap.delete(t)}}}class pC extends lC{constructor(e,t){super(e,t,arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3?arguments[3]:void 0),this._initMutex=void 0,this._reconnectInterrupter=void 0,this._url=void 0,this._transmitter=void 0,this._addresses=void 0,this._reliableTransmission=void 0,this._initMutex=new v("datachannel");const{timeout:i,timeoutFactor:n}=t,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*n)/10);y.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),A.on(w.NETWORK_STATE_CHANGE,((e,t)=>{e!==t&&(this.resetReconnectCount("network state change: ".concat(t," -> ").concat(e)),e===y.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=n))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;this._forceCloseTimeout=t;const i=(t,i)=>{this._addresses=e,this.currentURLIndex=this._addresses.findIndex((e=>e.fingerprint||T("FINGERPRINT")));const n=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(n).then(t).catch(i),this.once(zg.CLOSED,(()=>i(new hg(h.WS_DISCONNECT)))),this.once(zg.CONNECTED,(()=>t()))};return this._initMutex.lock().then((e=>new eg(((e,t)=>{i(e,t)})).then((()=>{e()})).catch((()=>{e()}))))}sendMessage(e){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new hg(h.WS_ABORT,"datachannel is not ready");try{t||(e=JSON.stringify(e)),this._reliableTransmission.sendMessage(e)}catch(e){throw new hg(h.WS_ERR,"send datachannel signal message error"+e.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(e){const t=JSON.stringify(e);return{compressed:t,compressedLength:t.length,origin:e}}sendMessageWithUint8Array(e){return{compressed:e,compressedLength:e.byteLength,origin:e}}createTransmitterConnection(e){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(e.ip,":").concat(e.port),new eg(((i,n)=>{var s;const o=()=>{t.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},r=async e=>{var s;if(null===(s=this._closeEstablishingTransmitter)||void 0===s||s.call(this),t.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(e.code,", reason: ").concat(e.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){"connected"===this.state&&(this.reconnectReason=e.reason,this.state="reconnecting");const s=D(this,zg.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,o=await this.reconnectWithAction(s);if("closed"===this.state)return void t.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!o)return n(new hg(h.WS_DISCONNECT,"datachannel reconnect failed: ".concat(e.code))),void this.close(!0);i()}else n(new hg(h.WS_DISCONNECT,"datachannel close: ".concat(e.code))),this.close()},a=e=>{var t;null===(t=this._reliableTransmission)||void 0===t||t.onData(e.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),t.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(e)));const c=null===(s=this._store)||void 0===s?void 0:s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();b(this,zg.TO_CONNECT_DATACHANNEL,e).then((e=>{var i,n;if(!e)throw new Error("transmissonInfo not exist yet");const{transmitter:s,close:l}=e;this._transmitter=s,null===(i=this._store)||void 0===i||i.signalChannelOpen();const h=Date.now()-d;t.debug("[choose dc] dc open cost ".concat(h,"ms"));this._reliableTransmission=new uC((e=>{var t;this._transmitter&&"open"===this._transmitter.readyState&&(null===(t=this._transmitter)||void 0===t||t.send(e))}),(e=>{"string"==typeof e&&this.emit(zg.ON_MESSAGE,e)})),this._closeEstablishingTransmitter=()=>{var e;null===(e=this._reliableTransmission)||void 0===e||e.close(),this._reliableTransmission=void 0,l()},o&&o(),s.onclose=r,s.onmessage=a,null===(n=this._store)||void 0===n||n.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c})).catch((e=>{var i;if(null===(i=this._store)||void 0===i||i.recordJoinChannelService({endTs:Date.now(),status:e instanceof hg&&e.code===h.WS_ABORT?"aborted":"error",errors:[e]},c),"closed"!==this.state){if(e instanceof hg&&e.code===h.WS_ERR){const i=new hg(h.WS_ERR,"init datachannel failed! Error: ".concat(e.toString()));return t.error("[".concat(this._name,"]").concat(i)),void n(i)}r&&r(e)}else n(new hg(h.WS_DISCONNECT,"datachannel is closed: ".concat(e.toString())))}))}))}async reconnectWithAction(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount)return!1;if(!this._addresses)return!1;if("closed"===this.state)return!1;this._onlineReconnectListener||A.networkState!==y.OFFLINE||(this._onlineReconnectListener=A.onlineWaiter&&A.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let n=!0;if(this._reconnectInterrupter=()=>{n=!1},i){const i=O(this._reconnectCount,this._retryConfig);t.debug("[".concat(this._name,"] wait ").concat(i,"ms to reconnect datachannel, mode: ").concat(e)),await eg.race([N(i),this._onlineReconnectListener||new eg((()=>{}))])}if("closed"===this.state||!n)return!1;this._reconnectCount+=1;const s=async(e,t)=>{this.emit(zg.RECONNECT_CREATE_CONNECTION,t),await this.createTransmitterConnection(e)};try{if("retry"===e){const t=this._addresses[this.currentURLIndex];this.emit(zg.RECONNECT_WAITTING_FINISH,e),await s(t,e)}else if("tryNext"===e){this.currentURLIndex+=1;for(let e=this.currentURLIndex;e<this._addresses.length;e++){if(this._addresses[e].fingerprint||T("FINGERPRINT")){this.currentURLIndex=e;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return t.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);t.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const i=this._addresses[this.currentURLIndex];this.emit(zg.RECONNECT_WAITTING_FINISH,e),await s(i,e)}else"recover"===e&&(t.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(zg.RECONNECT_WAITTING_FINISH,e),this.emit(zg.FAILBACK));return!0}catch(n){var o,r;return t.error("[".concat(this._name,"] reconnect failed"),n.toString()),null!=n&&null!==(o=n.data)&&void 0!==o&&o.desc&&Array.isArray(n.data.desc)&&n.data.desc.length&&jo(r=n.data.desc).call(r,"dynamic key expired")?(this.emit(zg.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(e,i)}}}class _C extends g{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===WS.CONNECTED?this.emit(HS.WS_CONNECTED):e===WS.RECONNECTING?this.emit(HS.WS_RECONNECTING,this._websocketReconnectReason):e===WS.CLOSED&&this.emit(HS.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=WS.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new P(5),this.pingpongTimer=void 0,this.inflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=e=>{if(e instanceof ArrayBuffer)return void this.emit(HS.ON_BINARY_DATA,e);const t=JSON.parse(e);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")&&(this.emit(t._type,t._message),t._type===YS.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===YS.ON_USER_BANNED))switch(t._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new pC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===WS.CONNECTED&&this.reconnect("retry",Xg.OFFLINE)}))}async request(e,i,n,s){const o=M(6,""),r={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new eg(((t,i)=>{if(this.connectionState===WS.CONNECTED)return t();const n=()=>{this.off(HS.WS_CLOSED,s),t()},s=()=>{this.off(HS.WS_CONNECTED,n),i(new hg(h.WS_ABORT))};this.once(HS.WS_CONNECTED,n),this.once(HS.WS_CLOSED,s),e!==KS.PUBLISH&&e!==KS.SUBSCRIBE&&e!==KS.UNSUBSCRIBE&&e!==KS.UNPUBLISH&&e!==KS.CONTROL&&e!==KS.RESTART_ICE||this.once(HS.DISCONNECT_P2P,(()=>{i(new hg(h.DISCONNECT_P2P))})),e!==KS.PUBLISH&&e!==KS.RESTART_ICE||this.once(HS.ABORT_P2P_EXECUTION,(()=>{i(new hg(h.DISCONNECT_P2P))}))}));if(this.connectionState!==WS.CONNECTING&&this.connectionState!==WS.RECONNECTING||e===KS.JOIN||e===KS.REJOIN||await c(),e===KS.LEAVE&&(this.websocket.unbindDcCloseEventListener(),s=!0),this.websocket.sendMessage(r,!0,!1),s)return;const d=new eg(((n,s)=>{let r=!1;const c=(t,s)=>{r=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(HS.WS_CLOSED,d),this.off(HS.WS_RECONNECTING,d),this.emit(HS.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new hg(h.WS_ABORT,"type: ".concat(e))),this.off(HS.WS_CLOSED,d),this.off(HS.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(HS.WS_CLOSED,d),this.once(HS.WS_RECONNECTING,d),N(T("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||r||(t.warning("dc request timeout, type: ".concat(e)),this.emit(HS.REQUEST_TIMEOUT,e,i))}))}));let l=null;try{l=await d}catch(t){if(this.connectionState===WS.CLOSED||e===KS.LEAVE)throw new hg(h.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===KS.JOIN||e===KS.REJOIN?null:(await c(),await this.request(e,i))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),p=lT(u),_=new hg(h.UNEXPECTED_RESPONSE,"".concat(p.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return"success"===p.action?l.message:(t.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(p.desc,", action: ").concat(p.action)),u===GS.ERR_TOO_MANY_BROADCASTERS?e===KS.JOIN||e===KS.REJOIN?(this.initError=_,this.close(),_.throw()):_.throw():"failed"===p.action?_.throw():"quit"===p.action?(this.initError=_,this.close(),_.throw()):(u===GS.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Xg.MULTI_IP)):this.reconnect(p.action,Xg.SERVER_ERROR),e===KS.JOIN||e===KS.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new eg((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=T("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==WS.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),T("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}init(e,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new eg(((n,s)=>{this.once(HS.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(HS.WS_CLOSED,(()=>s(this.initError||new hg(h.WS_ABORT)))),this.connectionState=WS.CONNECTING,this.websocket.init(e).catch(s),this.websocket.once(zg.FAILBACK,(()=>{void 0===this.openConnectionTime&&s(new hg(h.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{i&&void 0===this.openConnectionTime&&(t.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),s(new hg(h.INIT_DATACHANNEL_TIMEOUT)))}),T("DC_JOIN_WITH_FAILBACK"))}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||L.LEAVE,this.connectionState=WS.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new pC("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(HS.ABORT_P2P_EXECUTION);const e=await b(this,HS.DATACHANNEL_CONNECTING),t=await this.request(KS.JOIN,e);if(!t)return this.emit(HS.REPORT_JOIN_GATEWAY,h.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(HS.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=WS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new hg(h.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=U(this,HS.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;const t=await this.request(KS.REJOIN,e);return!!t&&(this.connectionState=WS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),t.peers&&t.peers.forEach((e=>{this.emit(YS.ON_USER_ONLINE,{uid:e.uid}),e.audio&&this.emit(YS.ON_ADD_AUDIO_STREAM,{uid:e.uid,uint_id:e.uint_id,audio:!0,ssrcId:e.audio_ssrc}),e.video&&this.emit(YS.ON_ADD_VIDEO_STREAM,{uid:e.uid,uint_id:e.uint_id,video:!0,ssrcId:e.video_ssrc}),e.audio_mute?this.emit(YS.MUTE_AUDIO,{uid:e.uid}):this.emit(YS.UNMUTE_AUDIO,{uid:e.uid}),e.video_mute?this.emit(YS.MUTE_VIDEO,{uid:e.uid}):this.emit(YS.UNMUTE_VIDEO,{uid:e.uid}),e.audio_enable_local?this.emit(YS.ENABLE_LOCAL_AUDIO,{uid:e.uid}):this.emit(YS.DISABLE_LOCAL_AUDIO,{uid:e.uid}),e.video_enable_local?this.emit(YS.ENABLE_LOCAL_VIDEO,{uid:e.uid}):this.emit(YS.DISABLE_LOCAL_VIDEO,{uid:e.uid}),e.audio||e.video||this.emit(YS.ON_REMOVE_STREAM,{uid:e.uid,uint_id:e.uint_id})})),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=lT(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,Xg.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=T("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>T("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Xg.TIMEOUT):this.request(KS.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),T("REPORT_STATS")&&this.send(KS.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleInflateData(){const{inflateLength:e,deflateLength:t}=this.websocket.getInflateData();0!==e&&0!==t&&this.upload(qS.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(zg.RECONNECT_WAITTING_FINISH,(e=>{this.emit(HS.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(zg.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(HS.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(zg.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(zg.CLOSED,(()=>{this.connectionState=WS.CLOSED})),this.websocket.on(zg.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=WS.CLOSED})),this.websocket.on(zg.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===WS.CONNECTED?this.connectionState=WS.RECONNECTING:this.connectionState=WS.CONNECTING})),this.websocket.on(zg.WILL_RECONNECT,((e,i)=>{if(U(this,HS.IS_P2P_DISCONNECTED)&&"retry"===e)return t.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(HS.NEED_RENEW_SESSION),this.emit(HS.DISCONNECT_P2P),i("tryNext");"retry"!==e&&(t.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(HS.NEED_RENEW_SESSION),this.emit(HS.DISCONNECT_P2P)),i(e)})),this.websocket.on(zg.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{t.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Xg.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(HS.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof hg&&e.code===h.UNEXPECTED_RESPONSE&&e.data.code===GS.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Xg.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Xg.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(zg.REQUEST_NEW_URLS,((e,t)=>{b(this,HS.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(zg.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(YS.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(zg.TO_CONNECT_DATACHANNEL,(async(e,t,i)=>b(this,HS.DATACHANNEL_PRECONNECT,e).then(t).catch(i))),this.websocket.on(zg.FAILBACK,(()=>{void 0!==this.openConnectionTime&&this.emit(HS.DATACHANNEL_FAILBACK)}))}}var EC=Fi,mC=TypeError,fC=Ha,SC=Math.floor,gC=function(e,t){var i=e.length,n=SC(i/2);return i<8?TC(e,t):CC(e,gC(fC(e,0,n),t),gC(fC(e,n),t),t)},TC=function(e,t){for(var i,n,s=e.length,o=1;o<s;){for(n=o,i=e[o];n&&t(e[n-1],i)>0;)e[n]=e[--n];n!==o++&&(e[n]=i)}return e},CC=function(e,t,i,n){for(var s=t.length,o=i.length,r=0,a=0;r<s||a<o;)e[r+a]=r<s&&a<o?n(t[r],i[a])<=0?t[r++]:i[a++]:r<s?t[r++]:i[a++];return e},RC=gC,IC=Ti.match(/firefox\/(\d+)/i),vC=!!IC&&+IC[1],yC=/MSIE|Trident/.test(Ti),AC=Ti.match(/AppleWebKit\/(\d+)\./),wC=!!AC&&+AC[1],OC=Bs,NC=Ct,bC=Wi,DC=cn,PC=$s,LC=function(e,t){if(!delete e[t])throw mC("Cannot delete property "+EC(t)+" of "+EC(e))},kC=Ao,MC=Et,UC=RC,VC=Op,xC=vC,FC=yC,jC=wi,BC=wC,GC=[],WC=NC(GC.sort),HC=NC(GC.push),KC=MC((function(){GC.sort(void 0)})),qC=MC((function(){GC.sort(null)})),YC=VC("sort"),JC=!MC((function(){if(jC)return jC<70;if(!(xC&&xC>3)){if(FC)return!0;if(BC)return BC<603;var e,t,i,n,s="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)GC.push({k:t+n,v:i})}for(GC.sort((function(e,t){return t.v-e.v})),n=0;n<GC.length;n++)t=GC[n].k.charAt(0),s.charAt(s.length-1)!==t&&(s+=t);return"DGBEFHACIJK"!==s}}));OC({target:"Array",proto:!0,forced:KC||!qC||!YC||!JC},{sort:function(e){void 0!==e&&bC(e);var t=DC(this);if(JC)return void 0===e?WC(t):WC(t,e);var i,n,s=[],o=PC(t);for(n=0;n<o;n++)n in t&&HC(s,t[n]);for(UC(s,function(e){return function(t,i){return void 0===i?-1:void 0===t?1:void 0!==e?+e(t,i)||0:kC(t)>kC(i)?1:-1}}(e)),i=PC(s),n=0;n<i;)t[n]=s[n++];for(;n<o;)LC(t,n++);return t}});var XC=ao("Array").sort,zC=Rt,QC=XC,ZC=Array.prototype,$C=_t((function(e){var t=e.sort;return e===ZC||zC(ZC,e)&&t===ZC.sort?QC:t}));class eR extends g{constructor(e){super(),this._signal=void 0,this._sequence=0,this._userMap=new Map,this._encoder=new TextEncoder,this._signal=e}async send(e,i,n,s,o){var r,a,c;"string"!=typeof i&&(i=JSON.stringify(i)),s=null!==(r=s)&&void 0!==r?r:M(6,""),o=null!==(a=o)&&void 0!==a?a:this._sequence++;const d={_id:s,_type:e,_seq:null!==(c=o)&&void 0!==c?c:this._sequence++,_message:i};if(T("SHOW_P2P_LOG")&&t.debug("send message",d),this.sendStreamMessage(JSON.stringify(d)),n)return;const u=new eg(((i,n)=>{const o=window.setTimeout((()=>{this.off("res-@".concat(s),r),t.warning("[external-signal] request timeout, type: ".concat(e)),0===this._userMap.size?n(new l(h.INVALID_REMOTE_USER)):n(new l(h.TIMEOUT))}),T("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),r=(e,t)=>{o&&window.clearTimeout(o),"success"===e?i({isSuccess:!0,message:t}):n(new l(h.UNEXPECTED_ERROR,t))};this.once("res-@".concat(s),r)}));let p;try{p=await u}catch(t){if(t.code===h.TIMEOUT)return await this.send(e,i,!1,s,o);throw t}return p.isSuccess?p.message:void 0}sendStreamMessage(e){this._splitMessage(e).forEach((e=>{this._signal.request(KS.DATA_STREAM,{payload:j(this._encoder.encode(e))})}))}onMessage(e){const{_uid:t}=e;let i;const n=this._userMap.get(t);if(n?i=n.splitMessageMap:(i=new Map,this._userMap.set(t,{isStart:!1,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map})),"id"in e&&"total"in e){var s;const{id:n,total:o}=e,r=null!==(s=i.get(n))&&void 0!==s?s:[];if(r.push(e),i.has(n)||i.set(n,r),r.length!==o)return;{const s=$C(r).call(r,((e,t)=>e.index-t.index)).map((e=>e.payload)).join("");i.delete(n),(e=JSON.parse(s))._uid=t}}this.handleReceivedMessage(e)}setStart(e){this._userMap.has(e)?this._userMap.get(e).isStart=!0:this._userMap.set(e,{isStart:!0,splitMessageMap:new Map,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map}),this.handleReceivedMessage()}setEnd(e){return this._userMap.delete(e),0===this._userMap.size}ack(e,t,i){this.send(iT.ACK,JSON.stringify({success:!i,message:t}),!0,e)}handleReceivedMessage(e){const i=()=>{this._userMap.forEach((e=>{const{receivedMessagesMap:t,nextExpectedSequenceNumber:i}=e;for(;t.has(i);){const n=t.get(i);t.delete(i),this.receiveMessage(n),e.nextExpectedSequenceNumber++}}))};if(!e)return void i();const{_uid:n,_seq:s}=e,o=this._userMap.get(n),{receivedMessagesMap:r,isStart:a,nextExpectedSequenceNumber:c}=o;s<c?t.debug("[external-signal] receive old message, seq: ".concat(s)):(r.set(s,e),a&&s===c&&(this.receiveMessage(e),r.delete(c),o.nextExpectedSequenceNumber++,i()))}receiveMessage(e){const{_id:i,_type:n,_message:s,_uid:o}=e;if(T("SHOW_P2P_LOG")&&t.debug("æ¶å°æ¶æ¯",e),i)switch(e._type){case iT.PUBLISH:const t=JSON.parse(s);this._signal.emit(n,t,o),this.ack(e._id);break;case iT.CONTROL:case iT.UNPUBLISH:case iT.DO_SUBSCRIBE:case iT.DO_UNSUBSCRIBE:{const t=JSON.parse(s);t.uid=o,b(this._signal,n,t).then((t=>{this.ack(e._id,t)})).catch((t=>{this.ack(e._id,void 0,!0)}));break}case iT.ACK:{const{success:e,message:t}=JSON.parse(s);this.emit("res-@".concat(i),e?"success":"failed",t);break}case iT.CALL:b(this,n,s).then((e=>{this.ack(i,e)}));break;case iT.RESTART_ICE:case iT.EXCHANGE_SDP:case iT.SUBSCRIBE:case iT.UNSUBSCRIBE:b(this._signal,n,s).then((e=>{this.ack(i,e)})).catch((t=>{this.ack(e._id,void 0,!0)}));break;case iT.CANDIDATE:this._signal.emit(n,s),this.ack(i);break;case iT.JOIN:this.emit(n,JSON.parse(s));break;default:this.emit(n,s),this.ack(i)}}_splitMessage(e){if(e.length<eR.MAX_MESSAGE_SIZE)return[e];const t=[],i=M(6,"");let n=0;const s=Math.ceil(e.length/800);for(;e.length>0;){n++;const o=e.slice(0,800);t.push({id:i,index:n,total:s,payload:o}),e=e.slice(800)}return t.map((e=>JSON.stringify(e)))}clear(){this._sequence=0,this._userMap.clear()}}eR.MAX_MESSAGE_SIZE=1024;class tR extends g{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===WS.CONNECTED?this.emit(HS.WS_CONNECTED):e===WS.RECONNECTING?this.emit(HS.WS_RECONNECTING,this._websocketReconnectReason):e===WS.CLOSED&&this.emit(HS.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,t){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=WS.CLOSED,this.reconnectToken=void 0,this._userInRoom=!1,this._userOnlineTime=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new P(5),this.pingpongTimer=void 0,this.wsInflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this._external_signal=void 0,this.onWebsocketMessage=e=>{if(e.data instanceof ArrayBuffer)return void this.emit(HS.ON_BINARY_DATA,e.data);const t=JSON.parse(e.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(t,"_id")){const e="res-@".concat(t._id);this.emit(e,t._result,t._message)}else if(Object.prototype.hasOwnProperty.call(t,"_type")){switch(t._type){case YS.ON_DATA_STREAM:return void this.handleDataStream(t._message);case YS.MUTE_AUDIO:case YS.MUTE_VIDEO:case YS.ON_P2P_LOST:return;case YS.ON_USER_ONLINE:this.emit(t._type,t._message);const{uid:e}=t._message;return this._external_signal.setStart(e),void this._external_signal.send(iT.JOIN,{onlineTime:this._userOnlineTime},!0)}if(this.emit(t._type,t._message),t._type===YS.ON_NOTIFICATION&&this.handleNotification(t._message),t._type===YS.ON_USER_BANNED)switch(t._message.error_code){case 14:this.close(L.UID_BANNED);break;case 15:this.close(L.IP_BANNED);break;case 16:this.close(L.CHANNEL_BANNED)}if(t._type===YS.ON_USER_LICENSE_BANNED)switch(t._message.error_code){case GS.ERR_LICENSE_MISSING:this.close(L.LICENSE_MISSING);break;case GS.ERR_LICENSE_EXPIRED:this.close(L.LICENSE_EXPIRED);break;case GS.ERR_LICENSE_MINUTES_EXCEEDED:this.close(L.LICENSE_MINUTES_EXCEEDED);break;case GS.ERR_LICENSE_PERIOD_INVALID:this.close(L.LICENSE_PERIOD_INVALID);break;case GS.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(L.LICENSE_MULTIPLE_SDK_SERVICE);break;case GS.ERR_LICENSE_ILLEGAL:this.close(L.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=e.clientId,this.spec=e,this.store=t,this.websocket=new IT("gateway-".concat(this.clientId),this.spec.retryConfig,!0,T("JOIN_GATEWAY_USE_DUAL_DOMAIN"),T("JOIN_GATEWAY_USE_443PORT_ONLY"),t),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===WS.CONNECTED&&this.reconnect("retry",k.OFFLINE)})),this._external_signal=new eR(this),this._handleSignalP2PEvents()}async request(e,i,n,s){const o=M(6,""),r={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new eg(((t,i)=>{if(this.connectionState===WS.CONNECTED)return t();const n=()=>{this.off(HS.WS_CLOSED,s),t()},s=()=>{this.off(HS.WS_CONNECTED,n),i(new l(h.WS_ABORT))};this.once(HS.WS_CONNECTED,n),this.once(HS.WS_CLOSED,s),e!==KS.PUBLISH&&e!==KS.SUBSCRIBE&&e!==KS.UNSUBSCRIBE&&e!==KS.UNPUBLISH&&e!==KS.CONTROL&&e!==KS.RESTART_ICE||this.once(HS.DISCONNECT_P2P,(()=>{i(new l(h.DISCONNECT_P2P))})),e!==KS.PUBLISH&&e!==KS.RESTART_ICE||this.once(HS.ABORT_P2P_EXECUTION,(()=>{i(new l(h.DISCONNECT_P2P))}))}));if(this.connectionState!==WS.CONNECTING&&this.connectionState!==WS.RECONNECTING||e===KS.JOIN||e===KS.REJOIN||await c(),this.websocket.sendMessage(r,!0),s)return;const d=new eg(((n,s)=>{let r=!1;const c=(t,s)=>{r=!0,n({isSuccess:"success"===t,message:s||{}}),this.off(HS.WS_CLOSED,d),this.off(HS.WS_RECONNECTING,d),this.emit(HS.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),c);const d=()=>{s(new l(h.WS_ABORT,"type: ".concat(e))),this.off(HS.WS_CLOSED,d),this.off(HS.WS_RECONNECTING,d),this.off("res-@".concat(o),c)};this.once(HS.WS_CLOSED,d),this.once(HS.WS_RECONNECTING,d),N(T("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||r||(t.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(HS.REQUEST_TIMEOUT,e,i))}))}));let u=null;try{u=await d}catch(t){if(this.connectionState===WS.CLOSED||e===KS.LEAVE)throw new l(h.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?t.throw():e===KS.JOIN||e===KS.REJOIN?null:(await c(),await this.request(e,i))}if(u.isSuccess)return u.message;const p=Number(u.message.error_code||u.message.code),_=lT(p),E=new l(h.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(u.message.error_str),{code:p,data:u.message});return"success"===_.action?u.message:(t.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(p,", message: ").concat(_.desc,", action: ").concat(_.action)),p===GS.ERR_TOO_MANY_BROADCASTERS?e===KS.JOIN||e===KS.REJOIN?(this.initError=E,this.close(),E.throw()):E.throw():"failed"===_.action?E.throw():"quit"===_.action?(this.initError=E,this.close(),E.throw()):(p===GS.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=u.message.option,t.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",k.MULTI_IP)):this.reconnect(_.action,k.SERVER_ERROR),e===KS.JOIN||e===KS.REJOIN?null:await this.request(e,i)))}waitMessage(e,t){return new eg((i=>{const n=s=>{(!t||t(s))&&(this.off(e,n),i(s))};this.on(e,n)}))}upload(e,t){const i={_type:e,_message:t};try{this.websocket.sendMessage(i)}catch(e){const t=T("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>t&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==WS.CONNECTED)return;const e=this.uploadCache.splice(0,1)[0];0===this.uploadCache.length&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(e._type,e._message)}),T("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,t){const i={_type:e,_message:t};this.websocket.sendMessage(i)}async sendExtensionMessage(e,t,i){return await this.waitTillUserOnline(),await this._external_signal.send(e,t,i)}init(e,t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new eg(((t,i)=>{this.once(HS.WS_CONNECTED,(()=>t(this.joinResponse))),this.once(HS.WS_CLOSED,(()=>i(this.initError||new l(h.WS_ABORT)))),this.connectionState=WS.CONNECTING,this.websocket.init(e).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||L.LEAVE,this.connectionState=WS.CLOSED,t.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),e===L.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new IT("gateway-".concat(this.clientId),this.spec.retryConfig,!0,T("JOIN_GATEWAY_USE_DUAL_DOMAIN"),T("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(HS.ABORT_P2P_EXECUTION);const e=await b(this,HS.REQUEST_JOIN_INFO),t=await this.request(KS.JOIN,e);if(!t)return this.emit(HS.REPORT_JOIN_GATEWAY,h.TIMEOUT,this.url||""),!1;this.joinResponse=t,this.emit(HS.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=WS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),this._userOnlineTime=(new Date).getTime(),this._external_signal.clear(),!0}async rejoin(){if(!this.reconnectToken)throw new l(h.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const e=U(this,HS.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;return!!await this.request(KS.REJOIN,e)&&(this.connectionState=WS.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0)}reconnect(e,t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,t)}handleDataStream(e){try{var t;const i=B(e.payload),n=(new TextDecoder).decode(i),s=JSON.parse(n);"total"in s&&"id"in s||jo(t=Object.values(iT)).call(t,s._type)?(e.seq&&delete e.seq,s._uid=e.uid,this._external_signal.onMessage(s)):this.emit(YS.ON_DATA_STREAM,e)}catch(e){}}handleNotification(e){t.debug("[".concat(this.clientId,"] receive notification: "),e);const i=lT(e.code);if("success"!==i.action){if("failed"!==i.action)return"quit"===i.action?("ERR_REPEAT_JOIN_CHANNEL"===i.desc&&this.close(L.UID_BANNED),void this.close()):void this.reconnect(i.action,k.SERVER_ERROR);t.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||"connected"!==this.websocket.state)return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const e=T("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(t.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>T("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",k.TIMEOUT):this.request(KS.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const e=Date.now()-i;this.rttRolling.add(e),T("REPORT_STATS")&&this.send(KS.PING_BACK,{pingpongElapse:e})})).catch((e=>{}))}handleWsInflateData(){const{wsInflateLength:e,wsDeflateLength:t}=this.websocket.getWsInflateData();0!==e&&0!==t&&this.upload(qS.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:t,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(zS.RECONNECT_WAITTING_FINISH,(e=>{this.emit(HS.WS_RECONNECT_WAITTING_FINISH,e)})),this.websocket.on(zS.RECONNECT_CREATE_CONNECTION,(e=>{this.emit(HS.WS_RECONNECT_CREATE_CONNECTION,e)})),this.websocket.on(zS.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(zS.CLOSED,(()=>{this.connectionState=WS.CLOSED})),this.websocket.on(zS.FAILED,(()=>{this._disconnectedReason=L.NETWORK_ERROR,this.connectionState=WS.CLOSED})),this.websocket.on(zS.RECONNECTING,(e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===WS.CONNECTED?this.connectionState=WS.RECONNECTING:this.connectionState=WS.CONNECTING})),this.websocket.on(zS.WILL_RECONNECT,((e,i,n)=>{if(U(this,HS.IS_P2P_DISCONNECTED)&&"retry"===e)return t.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(HS.NEED_RENEW_SESSION),this.emit(HS.DISCONNECT_P2P),n("tryNext");"retry"!==e&&(t.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0,this.emit(HS.NEED_RENEW_SESSION),this.emit(HS.DISCONNECT_P2P)),n(e)})),this.websocket.on(zS.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((e=>{t.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",k.SERVER_ERROR)})):this.join().catch((e=>{if(this.emit(HS.REPORT_JOIN_GATEWAY,e.message||e.code,this.url||""),e instanceof l&&e.code===h.UNEXPECTED_RESPONSE&&e.data.code===GS.ERR_NO_AUTHORIZED)return t.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",k.SERVER_ERROR);t.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",k.SERVER_ERROR):(this.initError=e,this.close())}))})),this.websocket.on(zS.REQUEST_NEW_URLS,((e,t)=>{b(this,HS.REQUEST_RECOVER,this.multiIpOption).then(e).catch(t)})),this.websocket.on(zS.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(YS.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}_handleSignalP2PEvents(){this._external_signal.on(iT.JOIN,(async e=>{if(this._userOnlineTime&&this._userOnlineTime<e.onlineTime){const e=await b(this,HS.P2P_START,void 0),t=await this._external_signal.send(iT.CALL,e);this.emit(HS.P2P_CONNECTION,t,!0)}this._userInRoom=!0,this.emit("user-online")})),this.on(YS.ON_USER_OFFLINE,(async e=>{this._external_signal.clear(),this._userInRoom=!1})),this._external_signal.on(iT.CALL,(async(e,t,i)=>{this._userInRoom=!0,this.emit("user-online");try{t(await b(this,HS.P2P_START,e))}catch(e){i(e)}}))}async waitTillUserOnline(){return new eg((e=>{if(this._userInRoom)e();else{const t=()=>{this.off("user-online",t),e()};this.on("user-online",t)}}))}}function iR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function nR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?iR(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):iR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const sR=new Map;class oR extends g{get state(){return this._state}set state(e){if(e===this._state)return;const t=this._state;this._state=e,"DISCONNECTED"===e&&this._disconnectedReason?this.emit(Og.CONNECTION_STATE_CHANGE,e,t,this._disconnectedReason):this.emit(Og.CONNECTION_STATE_CHANGE,e,t)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){t.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,t){super(),this.store=void 0,this.joinInfo=void 0,this.key=void 0,this.ntpOffset=0,this.signal=void 0,this.role=void 0,this.inChannelInfo={joinAt:null,duration:0},this.spec=void 0,this._state="DISCONNECTED",this._statsCollector=void 0,this._disconnectedReason=void 0,this.isSignalRecover=!1,this.hasChangeBGPAddress=!1,this.trafficStatsInterval=void 0,this.networkQualityInterval=void 0,this._joinGatewayStartTime=0,this._signalTimeout=!1,this._clientRoleOptions=void 0,this._isProactiveJoin=!1,this.store=e,this.spec=t,this.signal=this.store.useP2P?new tR(nR(nR({},t),{},{retryConfig:t.websocketRetryConfig}),e):this.store.useDataChannel?new _C(nR(nR({},t),{},{retryConfig:t.websocketRetryConfig}),e):new yT(nR(nR({},t),{},{retryConfig:t.websocketRetryConfig}),e),this._statsCollector=t.statsCollector,this.role=t.role||"audience",this._clientRoleOptions=t.clientRoleOptions,this.handleSignalEvents()}async join(e,n,s){if(this.signal instanceof _C){let i=!1;"disabled"!==e.cloudProxyServer?(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(e.cloudProxyServer,")")),i=!0):"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length>255||"".concat(e.apResponse.cid,"_").concat(e.apResponse.cert).length<22?(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),i=!0):e.apResponse.addresses.some((e=>e.fingerprint))||T("FINGERPRINT")||(t.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),i=!0),i&&this.resetSignal()}this.store.joinGatewayStart(),"disabled"!==e.cloudProxyServer&&(this.hasChangeBGPAddress=!0);const o=Date.now();let r=sR.get(e.cname);if(r||(r=new Map,sR.set(e.cname,r)),this._isProactiveJoin=!0,r.has(e.uid)){const t=new hg(h.UID_CONFLICT);throw i.joinGateway(e.sid,{lts:o,succ:!1,ec:t.message,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!e.proxyServer,signalChannel:this.signal instanceof _C?"1":"0"}),this._isProactiveJoin=!1,t}r.set(e.uid,!0),this.joinInfo=e,this.key=n;let a=0;this.joinGatewayStartTime=o;const c=e.proxyServer;try{let i;if(t.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof _C?"datachannel":"websocket"," join uid ").concat(a)),this.signal instanceof _C)i=await this.signal.init(e.apResponse.addresses,s);else{const t=e.gatewayAddrs.map((t=>{let{address:i}=t;const[n,s]=i.split(":"),o={host:n,port:s};return e.proxyServer&&(o.proxy=e.proxyServer),o}));i=await this.signal.init(t,s)}a=i.uid,t.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof _C?"datachannel":"websocket"," join uid ").concat(a," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(n){if(n&&n.code===h.INIT_WEBSOCKET_TIMEOUT)throw t.warning("[".concat(this.store.clientId,"] User join failed"),n.toString()),n;if(n&&n.code===h.INIT_DATACHANNEL_TIMEOUT)throw t.warning("[".concat(this.store.clientId,"] User join datachannel failed"),n.toString()),this.resetSignal(),n;throw t.error("[".concat(this.store.clientId,"] User join failed"),n.toString()),i.joinGateway(e.sid,{lts:o,succ:!1,ec:n.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!c,signalChannel:this.signal instanceof _C?"1":"0"}),this._isProactiveJoin=!1,r.delete(e.uid),this.signal.close(),n}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),t.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((e=>{t.warning("[".concat(this.store.clientId,"] get traffic stats error"),e.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&void 0!==navigator.onLine&&!navigator.onLine?this.emit(Og.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Og.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):"CONNECTED"===this.state&&this._statsCollector.trafficStats?this.emit(Og.NETWORK_QUALITY,{uplinkNetworkQuality:sC(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:sC(this._statsCollector.trafficStats.B_dnq)}):this.emit(Og.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),a}async leave(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if("DISCONNECTED"!==this.state){i!==L.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==WS.CONNECTED||await G(this.signal.request(KS.LEAVE,void 0,!0),3e3)}catch(e){t.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),e)}this.signal.close(i),i!==L.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new hg(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:T("PUB_EXTEND"),twcc:!!T("PUBLISH_TWCC"),rtx:!!T("USE_PUB_RTX")};try{return(await this.signal.request(KS.PUBLISH,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===GS.ERR_PUBLISH_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(e,i),this.publish(e,i,!1);throw s}}async publishDataChannel(e,i,n){var s;if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new hg(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:null!==(s=i.maxRetransmits)&&void 0!==s?s:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(KS.PUBLISH_DATASTREAM,o,!0)}catch(s){if(n&&s.data&&s.data.code===GS.ERR_PUBLISH_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(e,i),this.publishDataChannel(e,i,!1);throw s}}async unpublish(e,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new hg(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(KS.UNPUBLISH,{stream_id:i,ortc:e},!0)}catch(e){t.warning("[".concat(this.store.clientId,"] unpublish warning: "),e)}}async unpublishDataChannel(e){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new hg(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await eg.all(e.map((e=>this.signal.request(KS.UNPUBLISH_DATASTREAM,{channel_id:e},!0))))}catch(e){t.warning("unpublish datachannels warning: ",e)}}async subscribe(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new hg(h.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const s={stream_id:e,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!T("SUBSCRIBE_TWCC"),rtx:!!T("USE_SUB_RTX"),extend:T("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(T("SVC"))&&0!==T("SVC").length?T("SVC"):void 0};try{return(await this.signal.request(KS.SUBSCRIBE,s,!0))._message}catch(s){if(n&&s.data&&s.data.code===GS.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(e,i),await this.subscribe(e,i,!1);throw s}}async subscribeDataChannel(e,i,n){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new hg(h.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const s={uid:e,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(KS.SUBSCRIBE_DATASTREAM,s,!0)}catch(s){if(n&&s.data&&s.data.code===GS.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(e,i),await this.subscribeDataChannel(e,i,!1);throw s}}async subscribeAll(e,i){if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new hg(h.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const n={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!T("USE_SUB_RTX")};try{return await this.signal.request(KS.SUBSCRIBE_STREAMS,n,!0)}catch(n){if(i&&n.data&&n.data.code===GS.ERR_SUBSCRIBE_REQUEST_INVALID)return t.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(e),await this.subscribeAll(e,!1);throw n}}async setVideoProfile(e){const i=function(e){if(!(e.bitrateMax&&e.bitrateMin&&e.frameRate&&e.height&&e.width))return;let t=e.frameRate,i=e.width,n=e.height,s=!0;return"number"!=typeof t&&(t=t.exact||t.ideal||t.max||t.min||0,t||(s=!1)),"number"!=typeof i&&(i=i.exact||i.ideal||i.max||i.min||0,i||(s=!1)),"number"!=typeof n&&(n=n.exact||n.ideal||n.max||n.min||0,t||(s=!1)),s?{stream_type:0,width:i,height:n,fps:t,start_bps:1e3*e.bitrateMax,min_bps:1e3*e.bitrateMin,target_bps:1e3*e.bitrateMax}:void 0}(e);if(i)return this.signal.request(KS.SET_VIDEO_PROFILE,i);t.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(e,i){try{await this.signal.request(KS.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:i},!0)}catch(e){t.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),e)}}async unsubscribeDataChannel(e,i){try{if("CONNECTED"!==this.state&&"RECONNECTING"!==this.state)throw new hg(h.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await eg.all(e.map((e=>this.signal.request(KS.UNSUBSCRIBE_DATASTREAM,{stream_id:e,uid:i},!0))))}catch(e){t.warning("unsubscribeDataChannel warning: ",e)}}async massUnsubscribe(e){try{await this.signal.request(KS.UNSUBSCRIBE_STREAMS,e,!0)}catch(e){t.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),e)}}async reconnectPC(e){const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=e;return{gatewayEstablishParams:await this.signal.request(KS.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(KS.GATEWAY_INFO)}async renewToken(e){await this.signal.request(KS.RENEW_TOKEN,e),this.key=e.token}async setClientRole(e,t){if(t&&(this._clientRoleOptions=Object.assign({},t)),"CONNECTED"!==this.state)return void(this.role=e);let i,n=0;"audience"===e?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(KS.SET_CLIENT_ROLE,{role:e,level:n,delay:i,client_ts:Date.now()}),this.role=e}async setRemoteVideoStreamType(e,t){await this.signal.request(KS.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:t})}async setDefaultRemoteVideoStreamType(e){await this.signal.request(KS.DEFAULT_VIDEO_STREAM,{stream_type:e})}async setStreamFallbackOption(e,t){await this.signal.request(KS.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:t})}async pickSVCLayer(e,t){await this.signal.request(KS.PICK_SVC_LAYER,{stream_id:e,spatial_layer:t.spatialLayer,temporal_layer:t.temporalLayer})}async setRTM2Flag(e){await this.signal.request(KS.SET_RTM2_FLAG,{rtm2_flag:e})}async sendExtensionMessage(e,t,i){if(this.signal instanceof tR)return this.signal.sendExtensionMessage(e,t,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),nR({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(KS.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const e=sR.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const e=function(e){let t;return t=e.startsWith("dc")?e.match(/(dc\:\/\/)?([^:]+):(\d+)/):e.match(/(wss\:\/\/)?([^:]+):(\d+)/),t?{username:qo.username,password:qo.password,turnServerURL:t[2],tcpport:parseInt(t[3])+30,udpport:parseInt(t[3])+30,forceturn:!1}:null}(("disabled"===this.joinInfo.cloudProxyServer?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&"off"!==this.joinInfo.turnServer.mode&&"disabled"===this.joinInfo.cloudProxyServer&&this.joinInfo.turnServer.serversFromGateway.push(nR(nR({},qo),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if("CONNECTED"!==this.state)return;const e=await this.signal.request(KS.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),null!=e.ntp_offset&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach((e=>{const t=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((t=>t.peer_uid===e.peer_uid));t&&t.B_st!==e.B_st&&W((()=>{this.emit(Og.STREAM_TYPE_CHANGE,e.peer_uid,e.B_st)}))})),this._statsCollector.updateTrafficStats(e)}getJoinMessage(e){if(!this.joinInfo||!this.key)throw new hg(h.UNEXPECTED_ERROR,"can not generate join message, no join info");const t=Object.assign({},this.joinInfo.apResponse);let i=T("REPORT_APP_SCENARIO");if("string"!=typeof i)try{i=JSON.stringify(i)}catch(e){i=void 0}i&&i.length>128&&(i=void 0);const n=nR({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:H,browser:navigator.userAgent,process_id:T("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:t,extend:T("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:"proxy3"===this.joinInfo.cloudProxyServer?"1":"proxy5"===this.joinInfo.cloudProxyServer?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:T("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:T("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:"number"==typeof T("SUBSCRIBE_AUDIO_FILTER_TOPN")?T("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:"boolean"==typeof T("ENABLE_PUBLISH_AUDIO_FILTER")?T("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:"boolean"==typeof T("ENABLE_USER_LICENSE_CHECK")?T("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:!0===T("USE_PUB_RTX")||!0===T("USE_SUB_RTX")||void 0,disableFEC:T("DISABLE_FEC"),enableNTPReport:!!T("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!T("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:"boolean"==typeof T("ENABLE_DATASTREAM_2")?T("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:"number"==typeof T("RTM2_FLAG")?T("RTM2_FLAG"):void 0,enableUserAutoRebalanceCheck:!!T("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:"boolean"==typeof T("USE_XR")?T("USE_XR"):void 0}},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,T("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),t.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=t.addresses[this.signal.websocket.currentURLIndex].ticket,delete t.addresses),void 0!==this.joinInfo.defaultVideoStream&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new hg(h.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(HS.WS_RECONNECT_WAITTING_FINISH,(e=>{var t;jo(t=["tryNext","recover"]).call(t,e)&&this.joinInfo&&i.adjustSessionStartTime(this.joinInfo.sid)})),this.signal.on(HS.WS_RECONNECT_CREATE_CONNECTION,(e=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(HS.WS_RECONNECTING,(e=>{this.joinInfo&&i.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||k.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",i.sessionInit(this.joinInfo.sid,{lts:(new Date).getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(HS.WS_CLOSED,(e=>{let n;switch(e){case L.LEAVE:n=k.LEAVE;break;case L.UID_BANNED:case L.IP_BANNED:case L.CHANNEL_BANNED:case L.SERVER_ERROR:n=k.SERVER_ERROR;break;case L.FALLBACK:n=k.FALLBACK;break;case L.LICENSE_MISSING:case L.LICENSE_EXPIRED:case L.LICENSE_MINUTES_EXCEEDED:case L.LICENSE_PERIOD_INVALID:case L.LICENSE_MULTIPLE_SDK_SERVICE:case L.LICENSE_ILLEGAL:case L.TOKEN_EXPIRE:n=e;break;default:n=k.NETWORK_ERROR}t.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+k.NETWORK_ERROR)),this.joinInfo&&i.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===L.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=e,e!==L.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(HS.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&("audience"===this.role&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(t.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),i.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof _C?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&1===this.joinInfo.setLocalAPVersion)){const e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void t.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));K("EVENT_REPORT_DOMAIN",e[1]),K("EVENT_REPORT_BACKUP_DOMAIN",e[1]),K("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}})),this.signal.on(YS.ON_UPLINK_STATS,(e=>{this._statsCollector.updateUplinkStats(e)})),this.signal.on(HS.REQUEST_RECOVER,((e,t,i)=>{if(!this.joinInfo)return i(new hg(h.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,b(this,Og.REQUEST_NEW_GATEWAY_LIST).then(t).catch(i)})),this.signal.on(HS.REQUEST_JOIN_INFO,(async e=>{var t;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:n,rtpCapabilities:s}=await b(this,Og.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:null===(t=this.joinInfo)||void 0===t?void 0:t.turnServer});e(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:s,version:"2"}}))})),this.signal.on(HS.REQUEST_REJOIN_INFO,(e=>{e(this.getRejoinMessage())})),this.signal.on(HS.REPORT_JOIN_GATEWAY,((e,t)=>{this.joinInfo&&(i.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:e,addr:t,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof _C?"1":"0"}),this._isProactiveJoin=!1)})),this.signal.on(HS.IS_P2P_DISCONNECTED,(e=>{e(U(this,Og.IS_P2P_DISCONNECTED))})),this.signal.on(HS.DISCONNECT_P2P,(()=>{this.emit(Og.DISCONNECT_P2P)})),this.signal.on(HS.NEED_RENEW_SESSION,(()=>{this.emit(Og.NEED_RENEW_SESSION)})),this.signal.on(HS.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(HS.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(HS.JOIN_RESPONSE,(e=>{const t=this.getCurrentGatewayAddress();this.emit(Og.JOIN_RESPONSE,e,t)})),this.signal.on(HS.DATACHANNEL_PRECONNECT,(async(e,t,i)=>{this.updateTurnConfigFromSignal();const n=this.getCurrentGatewayAddress();return b(this,Og.DATACHANNEL_PRECONNECT,e,n).then(t).catch(i)})),this.signal.on(HS.DATACHANNEL_CONNECTING,(async e=>{const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await b(this,Og.REQUEST_DC_CONNECTION_PARAMS);e(this.getJoinMessage({ortc:{iceParameters:t,dtlsParameters:i,rtpCapabilities:n,version:"2"}}))})),this.signal.on(HS.DATACHANNEL_FAILBACK,(()=>{t.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Og.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(e,i){try{await this.signal.request(KS.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[i]},!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),e),e}}async tryUnsubDataChannelBeforeResub(e,i){try{await this.signal.request(KS.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(e){throw t.warning("unsubscribe datachannel warning",e),e}}async tryUnpubBeforeRepub(e,i){try{await this.signal.request(KS.UNPUBLISH,{stream_id:e,ortc:i},!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),e),e}}async tryUnpubDataChannelBeforeRepub(e,i){try{await this.signal.request(KS.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(e){throw t.warning("unpublish datastream warning: ",e),e}}async tryMassUnsubBeforeResub(e){const i={users:e.map((e=>({stream_id:e.stream_id,stream_type:e.stream_type})))};try{await this.signal.request(KS.UNSUBSCRIBE_STREAMS,i,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),e),e}}async muteLocal(e,i){const n={action:e.find((e=>e.stream_type===wg.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(KS.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),e),e}}async unmuteLocal(e,i){const n={action:e.find((e=>e.stream_type===wg.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{await this.signal.request(KS.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),e),e}}async muteRemote(e,i){const n={action:e===Fg.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(KS.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),e),e}}async unmuteRemote(e,i){const n={action:e===Fg.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(KS.CONTROL,n,!0,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),e),e}}uploadStats(e,t){this.signal.upload(e,t)}getSignalRTT(){return this.signal.rtt}async restartICE(e){const i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return await this.signal.request(KS.RESTART_ICE,i,!0)}catch(e){throw t.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),e),e}}reconnect(){"CONNECTED"===this.state&&this.signal.reconnect(void 0,k.P2P_FAILED)}getCurrentGatewayAddress(){var e;if(!T("GATEWAY_WSS_ADDRESS"))return null!==(e=this.joinInfo)&&void 0!==e&&e.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(e){await this.signal.request(KS.SET_PARAMETER,{enablePublishAudioFilter:e})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(L.FALLBACK)),this.store.useDataChannel=!1,this.signal=new yT(nR(nR({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Og.RESET_SIGNAL,Dg.websocket)}}let rR=0,aR=0;function cR(e,t,i,n){return new eg(((s,o)=>{t.timeout=t.timeout||T("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),rR+=q(t.data)):i&&(t.data.size?rR+=t.data.size:t.data instanceof FormData?rR+=Y(t.data):rR+=q(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ut.request(t).then((e=>{"string"==typeof e.data?aR+=q(e.data):e.data instanceof ArrayBuffer||e.data instanceof Uint8Array?aR+=e.data.byteLength:aR+=q(JSON.stringify(e.data)),n&&s({data:e.data,headers:e.headers}),s(e.data)})).catch((e=>{ut.isCancel(e)?o(new hg(h.OPERATION_ABORTED,"cancel token canceled")):"ECONNABORTED"===e.code?o(new hg(h.NETWORK_TIMEOUT,e.message)):e.response?o(new hg(h.NETWORK_RESPONSE_ERROR,e.response.status)):o(new hg(h.NETWORK_ERROR,e.message))}))}))}const dR=()=>{const e=T("AREAS");0===e.length&&e.push(Pg.GLOBAL);return Mp(e).call(e,((e,t,i)=>{const n=lR(t);return n?0===i?n:"".concat(e,",").concat(n):e}),"")},lR=e=>e===Pg.OVERSEA?"".concat(Mg.ASIA,",").concat(Mg.EUROPE,",").concat(Mg.AFRICA,",").concat(Mg.NORTH_AMERICA,",").concat(Mg.SOUTH_AMERICA,",").concat(Mg.OCEANIA):Mg[e],hR=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((e=>{const i=Ug[e],n=Object.keys(i);n&&n.map((e=>{"CODE"!==e&&(t[e]=t[e].concat(i[e]))}))})),t},uR={GLOBAL:{ASIA:[Pg.CHINA,Pg.JAPAN,Pg.INDIA,Pg.KOREA,Pg.HKMC],EUROPE:[],NORTH_AMERICA:[Pg.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},pR=Object.keys(uR[Pg.GLOBAL]),_R=[Pg.CHINA,Pg.NORTH_AMERICA,Pg.EUROPE,Pg.ASIA,Pg.JAPAN,Pg.INDIA,Pg.OCEANIA,Pg.SOUTH_AMERICA,Pg.AFRICA,Pg.KOREA,Pg.HKMC,Pg.US],ER=function(e,t){let i=[];if(jo(e).call(e,Pg.GLOBAL)){const o=[Pg.GLOBAL,Pg.OVERSEA],r=Object.keys(Ug);if(t===Pg.GLOBAL)throw new hg(h.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===Pg.CHINA)i=[Pg.OVERSEA];else if(s=t,jo(pR).call(pR,s)){const e=(n=t,uR[Pg.GLOBAL][n]||[]),s=[...o,t,...e];i=r.filter((e=>!jo(s).call(s,e)))}else if(function(e){let t=!1;return pR.forEach((i=>{var n;jo(n=uR[Pg.GLOBAL][i]).call(n,e)&&(t=!0)})),t}(t)){const e=function(e){let t;return pR.forEach((i=>{var n;jo(n=uR[Pg.GLOBAL][i]).call(n,e)&&(t=i)})),t}(t),n=[...o,e,t];i=r.filter((e=>!jo(n).call(n,e)))}else i=e;i=function(e){const t=[];return _R.forEach((i=>{jo(e).call(e,i)&&t.push(i)})),t.concat(e.filter((e=>!jo(_R).call(_R,e))))}(i)}else i=e;var n,s;return i};function mR(e){var i,n;if(!e&&jo(i=T("AREAS")).call(i,Pg.EXTENSIONS))return t.debug("update area from ap : reset"),void fR(Ko,!0);if(!jo(n=T("AREAS")).call(n,Pg.GLOBAL)||!e)return;let s=Ug.EXTENSIONS;s&&(s={CODE:lR(Pg.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},t.debug("update area from ap success: ".concat(e,",config is "),s),K("AREAS",[Pg.EXTENSIONS],!0),Object.keys(s).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=s[e];K(e,t[0])}else K(e,s[e])})))}function fR(e){let n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const s=i.reportApiInvoke(null,{name:J.SET_AREA,options:e,tag:X.TRACER});try{let i=[];if("string"==typeof e&&(i=[e]),Array.isArray(e)&&(e.forEach((e=>{if(!jo(kg).call(kg,e))throw new hg(h.INVALID_PARAMS,"invalid area code")})),i=e),"[object Object]"===Object.prototype.toString.call(e)){const{areaCode:t,excludedArea:n}=e;if(!t)throw new hg(h.INVALID_PARAMS,"area code is needed");let s=t;"string"==typeof t&&(s=[t]),i=n?ER(s,n):s}if(!n){if(d.AREAS){const e=new hg(h.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return s.onError(e),void t.warning("setArea is prohibited because of config-distribute")}if(jo(i).call(i,Pg.GLOBAL)&&T("AREAS")===Pg.EXTENSIONS){const e=new hg(h.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return s.onError(e),void t.warning("setArea is prohibited because of ap extensions")}}K("AREAS",i,n);const o=hR(i);Object.keys(o).map((e=>{if("LOG_UPLOAD_SERVER"===e||"EVENT_REPORT_DOMAIN"===e||"EVENT_REPORT_BACKUP_DOMAIN"===e||"PROXY_SERVER_TYPE3"===e){const t=o[e];K(e,t[0])}else K(e,o[e])})),t.debug("set area success:",i.join(","))}catch(e){throw s.onError(e),e}s.onSuccess()}function SR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function gR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?SR(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):SR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let TR=1;function CR(e,n,s,o,r){TR+=1;const a={sid:s.sid,command:"convergeAllocateEdge",uid:"666",appId:s.appId,ts:Math.floor(Date.now()/1e3),seq:TR,requestId:TR,version:H,cname:s.cname},c={service_name:n,json_body:JSON.stringify(a)};let d,l,u=e[0];return z((async()=>{d=Date.now();const e=await cR(u,{data:c,cancelToken:o,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(l=Date.now()-d,0!==e.code){const i=new hg(h.UNEXPECTED_RESPONSE,"live streaming ap error, code"+e.code,{retry:!0,responseTime:l});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new hg(h.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:l});throw t.error(e.toString()),e}if(!i.servers||0===i.servers.length){const e=new hg(h.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:i.code,responseTime:l});throw t.error(e.toString()),e}const s=function(e,t){return{addressList:e.servers.map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(T("WORKER_DOMAIN"),":").concat(e.wss,"?serviceName=").concat(encodeURIComponent(t)))),workerToken:e.workerToken,vid:e.vid}}(i,n);return T("LIVE_STREAMING_ADDRESS")&&(s.addressList=T("LIVE_STREAMING_ADDRESS")instanceof Array?T("LIVE_STREAMING_ADDRESS"):[T("LIVE_STREAMING_ADDRESS")]),gR(gR({},s),{},{responseTime:l})}),((t,o)=>(i.apworkerEvent(s.sid,{success:!0,sc:200,serviceName:n,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===o,responseTime:l,serverIp:e[o%e.length]}),!1)),((t,o)=>(i.apworkerEvent(s.sid,{success:!1,sc:t.data&&t.data.code||200,serviceName:n,responseTime:l,serverIp:e[o%e.length]}),!!(t.code!==h.OPERATION_ABORTED&&t.code!==h.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(u=e[(o+1)%e.length],!0))),r)}let RR=1;function IR(e,n,s,o){let{url:r,areaCode:a}=e;const c=Date.now();let d;const[l,u]=OR(n,a,[FT.CHOOSE_SERVER]);let p=A.networkState;return z((async()=>{p&&A.networkState===y.OFFLINE&&A.onlineWaiter&&await eg.race([A.onlineWaiter,N(o&&o.maxRetryTimeout||Z.maxRetryTimeout)]),p=A.networkState;const{data:e,headers:t}=await cR(r,{data:l,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d="1"===t.http3?1:-1,i.reportResourceTiming(r,n.sid),yR(e,r,n,c,[FT.CHOOSE_SERVER],d);const a=oC(e,FT.CHOOSE_SERVER);return AR(a),eC(a,r)}),(e=>(e&&i.joinChooseServer(n.sid,{lts:c,succ:!0,csAddr:r,opid:u,serverList:e.gatewayAddrs.map((e=>e.address)),ec:null,cid:e.cid.toString(),uid:e.uid.toString(),csIp:e.csIp,unilbsServerIds:[FT.CHOOSE_SERVER].toString(),isHttp3:d}),!1)),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(i.joinChooseServer(n.sid,{lts:c,succ:!1,csAddr:r,serverList:null,opid:u,ec:e.code,csIp:e.data&&e.data.csIp,unilbsServerIds:[FT.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:d}),t.warning("[".concat(n.clientId,"] Choose server network error, retry"),e),!0))),o)}function vR(e,n,s,o){let r,{url:a,areaCode:c,serviceIds:d}=e;const l=Date.now(),[u,p]=OR(n,c,d);let _;return z((async()=>{_&&A.networkState===y.OFFLINE&&A.onlineWaiter&&await eg.race([A.onlineWaiter,N(o&&o.maxRetryTimeout||Z.maxRetryTimeout)]),_=A.networkState;const{data:e,headers:t}=await cR(a,{data:u,cancelToken:s,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r="1"===t.http3?1:-1,i.reportResourceTiming(a,n.sid),yR(e,a,n,l,d,r);const c=oC(e,FT.CHOOSE_SERVER),h=oC(e,"proxy5"===n.cloudProxyServer?FT.CLOUD_PROXY_5:"proxy3"===n.cloudProxyServer||"proxy4"===n.cloudProxyServer?FT.CLOUD_PROXY:FT.CLOUD_PROXY_FALLBACK);return AR(c),{gatewayInfo:eC(c,a),proxyInfo:h,url:a}}),(e=>(e.gatewayInfo&&i.joinChooseServer(n.sid,{lts:l,succ:!0,csAddr:a,serverList:e.gatewayInfo.gatewayAddrs.map((e=>e.address)),ec:null,opid:p,cid:e.gatewayInfo.cid.toString(),uid:e.gatewayInfo.uid.toString(),csIp:e.gatewayInfo.csIp,unilbsServerIds:d.toString(),isHttp3:r}),e.proxyInfo&&i.joinWebProxyAP(n.sid,{lts:l,sucess:1,apServerAddr:a,turnServerAddrList:e.proxyInfo.addresses.map((e=>e.ip)).join(","),errorCode:null,eventType:n.cloudProxyServer,unilbsServerIds:d.toString()}),!1)),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.CAN_NOT_GET_GATEWAY_SERVER?e.data.retry:(i.joinWebProxyAP(n.sid,{lts:l,sucess:0,apServerAddr:a,turnServerAddrList:null,errorCode:e.code,eventType:n.cloudProxyServer,unilbsServerIds:d.toString(),extend:JSON.stringify({networkState:_})}),t.warning("[".concat(n.clientId,"] multi unilbs network error, retry"),e),!0))),o)}const yR=(e,n,s,o,r,a)=>{const c=[],d=t=>{4096===t.flag?i.joinChooseServer(s.sid,{lts:o,succ:!1,csAddr:n,opid:e.opid,serverList:null,ec:t.error.message,csIp:t.error.data&&t.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:a}):1048576!==t.flag&&4194304!==t.flag&&4194310!==t.flag||i.joinWebProxyAP(s.sid,{lts:o,sucess:0,apServerAddr:n,turnServerAddrList:null,errorCode:t.error.code,eventType:s.cloudProxyServer,unilbsServerIds:r.toString()})};if(e.response_body.forEach((i=>{const n=i.buffer.code;if(23===i.uri&&0===n&&!i.buffer.edges_services)if(4194310===i.buffer.flag)t.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),i.buffer.edges_services=[];else{const t={error:new hg(h.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:i.buffer.flag};c.push(t),d(t)}if(0!==n){const s=cT(n),o={error:new hg(h.CAN_NOT_GET_GATEWAY_SERVER,s.desc,{desc:s.desc,retry:s.retry,csIp:e.detail[502]}),flag:i.buffer.flag};4194310===i.buffer.flag?t.warning(o.error.toString()):c.push(o),d(o)}})),c.length)throw t.warning("[".concat(s.clientId,"] multi unilbs ").concat(n," failed, ").concat(c.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message,", retry: ").concat(e.error.data.retry))).join(" | "))),new hg(h.CAN_NOT_GET_GATEWAY_SERVER,c.map((e=>"flag: ".concat(e.flag,", message: ").concat(e.error.message))).join(" | "),{retry:!!c.find((e=>e.error.data.retry)),csIp:e.detail[502],desc:[...new Set(c.map((e=>{var t;return null==e||null===(t=e.error)||void 0===t||null===(t=t.data)||void 0===t?void 0:t.desc})).filter((e=>!!e)))]})},AR=e=>{var i,n,s,o;if(e.addresses&&0===e.addresses.length&&0===e.code)throw new hg(h.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});T("AP_AREA")&&(null!==(s=e.detail)&&void 0!==s&&s[23]&&"string"==typeof(null===(o=e.detail)||void 0===o?void 0:o[23])?mR(e.detail[23].toLowerCase()):mR());if(null!==(i=e.detail)&&void 0!==i&&i[19]&&"string"==typeof(null===(n=e.detail)||void 0===n?void 0:n[19])){const t=e.detail[19],i=null==t?void 0:t.split(";");for(let t=0;t<i.length;t++){var r;const n=HT(r=i[t]).call(r);e.addresses[t]&&i&&(e.addresses[t].fingerprint=n)}}if(T("GATEWAY_ADDRESS")&&T("GATEWAY_ADDRESS").length>0){t.debug("assign gateway address to",T("GATEWAY_ADDRESS"));const i=T("GATEWAY_ADDRESS").map((t=>{var i,n;const s=null!==(i=null===(n=e.addresses.find((e=>e.ip===t.ip&&e.port===t.port)))||void 0===n?void 0:n.fingerprint)&&void 0!==i?i:"";return{ip:t.ip,port:t.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:s}}));e.addresses=i}},wR=(e,i)=>{if(e.response_body&&e.response_body.length){const t=e.response_body[0];if(0!==t.buffer.code){const e=cT(t.buffer.code);throw new hg(h.UPDATE_TICKET_FAILED,"[".concat(t.buffer.code,"]: ").concat(e.desc),{retry:e.retry})}return t.buffer.ticket}throw t.debug("update ticket request received ap response without response body:",i),new hg(h.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},OR=(e,t,i)=>{const n=Math.floor(Math.random()*10**12),s={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:gR({6:e.stringUid,11:t,12:T("USE_NEW_TOKEN")?"1":void 0,22:t},T("AP_RTM")?{26:"RTM2"}:{}),key:e.token,service_ids:i,uid:e.uid||0}}]};s.request_bodies.forEach((t=>{e.multiIP&&e.multiIP.gateway_ip&&(t.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,n]},NR=(e,t)=>{const i=Math.floor(Math.random()*10**12),n={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((e=>({ip:e.ip,port:e.port})))}}]},s=new FormData;return s.append("request",JSON.stringify(n)),[s,i]};let bR=0;function DR(e){return eg.all(e.map((e=>e.then((e=>{throw e}),(e=>e))))).then((e=>{throw e}),(e=>e))}const PR=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:n,allFailedhandler:s,promisesCollector:o}=e,r=0;const a=t;let c,d=0;const l=async()=>{const e=(()=>{const e=r*a,t=e+a;return i.slice(e,t).map(n)})();o&&o.push(...e);try{c=await DR(e)}catch(e){if(d+=a,r++,!(d>=i.length))return void await l();s(e)}e.forEach((e=>e.cancel()))};return await l(),c};async function LR(e,i,n,s){const o=async function(e,i,n,s){let o=null;const r=[],a=async()=>{const o=T("WEBCS_DOMAIN").slice(0,T("AJAX_REQUEST_CONCURRENT")).map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:dR()}))),a=s.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:o.map((e=>e.url))}),c=await PR({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:o,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] Connect to choose_server:"),s.url),IR(s,e,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},a),e[0]},promisesCollector:r});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},a),c},c=async()=>{if(await N(1e3),null!==o)return o;const a=T("WEBCS_DOMAIN_BACKUP_LIST").map((t=>({url:e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2"),areaCode:dR()}))),c=s.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:a.map((e=>e.url))}),d=await PR({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),s.url),IR(s,e,i,n)),allFailedhandler:e=>{throw s.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},c),e[0]},promisesCollector:r});return s.recordJoinChannelService({endTs:Date.now(),status:"success"},c),d};try{return o=await DR([a(),c()]),r.length&&r.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),o}catch(e){throw e[0]}}(e,i,n,s);return{gatewayInfo:await o}}async function kR(e,i,n,s,o){const r=e.cloudProxyServer;if("disabled"===r){if(!s)return;if(e.useLocalAccessPoint)return await LR(e,i,n,o);if(T("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:t,proxyInfo:s}=await VR(e,i,n,o);return e.turnServer&&"auto"!==e.turnServer.mode||(e.turnServer={mode:"manual",servers:s.map((e=>({turnServerURL:e.address,tcpport:e.tcpport||qo.tcpport,udpport:e.udpport||qo.udpport,username:e.username||qo.username,password:e.password||qo.password,forceturn:!1,security:!0})))}),{gatewayInfo:t}}return await LR(e,i,n,o)}const{proxyInfo:a,gatewayInfo:c}=await VR(e,i,n,o),d={gatewayInfo:c};return e.turnServer={mode:"manual",servers:a.map((e=>({turnServerURL:e.address,tcpport:"proxy3"===r?void 0:e.tcpport?e.tcpport:qo.tcpport,udpport:"proxy4"===r?void 0:e.udpport?e.udpport:qo.udpport,username:e.username||qo.username,password:e.password||qo.password,forceturn:"proxy4"!==r,security:"proxy5"===r})))},t.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(r)),d}async function MR(e,n,s,o,r){const a=T("ACCOUNT_REGISTER").slice(0,T("AJAX_REQUEST_CONCURRENT"));let c=[];c=n.proxyServer?a.map((e=>"https://".concat(n.proxyServer,"/ap/?url=").concat(e+"/api/v1"))):a.map((e=>"https://".concat(e,"/api/v1")));const d=null==r?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:c});try{const a=await async function(e,n,s,o,r){const a=Date.now(),c={sid:s.sid,opid:10,appid:s.appId,string_uid:n};let d=e[0];const l=await z((()=>cR(d+"".concat(-1===d.indexOf("?")?"?":"&","action=stringuid"),{data:c,cancelToken:o,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((s,o)=>{if(0===s.code){if(s.uid<=0||s.uid>=Math.pow(2,32))throw t.error("Invalid Uint Uid ".concat(n," => ").concat(s.uid),s),i.reqUserAccount(c.sid,{lts:a,success:!1,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:h.INVALID_UINT_UID_FROM_STRING_UID,extend:c}),new hg(h.INVALID_UINT_UID_FROM_STRING_UID);return i.reqUserAccount(c.sid,{lts:a,success:!0,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:null,extend:c}),!1}const r=cT(s.code);return r.retry&&(d=e[(o+1)%e.length]),i.reqUserAccount(c.sid,{lts:a,success:!1,serverAddr:d,stringUid:c.string_uid,uid:s.uid,errorCode:r.desc,extend:c}),r.retry}),((t,n)=>t.code!==h.OPERATION_ABORTED&&(i.reqUserAccount(c.sid,{lts:a,success:!1,serverAddr:d,stringUid:c.string_uid,uid:null,errorCode:t.code,extend:c}),d=e[(n+1)%e.length],!0)),r);if(0!==l.code){const e=cT(l.code);throw new hg(h.UNEXPECTED_RESPONSE,e.desc)}return l}(c,e,n,s,o);return null==r||r.recordJoinChannelService({status:"success",endTs:Date.now()},d),a.uid}catch(e){throw null==r||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[e]},d),e}}async function UR(e,t,n){const s=T("CDS_AP").slice(0,T("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1"):"https://".concat(t,"/api/v1?action=config"))).map((i=>function(e,t,i,n){const s=Q(),o={flag:64,cipher_method:0,features:{device:s.name,system:s.os,system_general:navigator.userAgent,vendor:t.appId,version:H,cname:t.cname,sid:t.sid,session_id:t.sid,detail:"",proxyServer:t.proxyServer}};return z((()=>cR(e,{data:o,timeout:1e3,cancelToken:i,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(e=>e.code!==h.OPERATION_ABORTED),n)}(i,e,t,n)));let o=null,r=null,a={};try{o=await DR(s)}catch(e){if(e.code===h.OPERATION_ABORTED)throw e;r=e}s.forEach((e=>e.cancel()));if(i.reportApiInvoke(e.sid,{name:J.REQUEST_CONFIG_DISTRIBUTE,options:{error:r,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(e){if(!e.test_tags)return{};const t=e.test_tags,i=Object.keys(t),n={};return i.forEach((e=>{var i;const s=HT(i=e.slice(4)).call(i),o=JSON.parse(t[e])[1];n[s]=o})),n}(o)}catch(e){}return a}async function VR(e,n,s,o){const r=T("PROXY_SERVER_TYPE3"),a=(e,t,i)=>{let n=i||r;return Array.isArray(n)&&(n=t%2==0?r[1]:r[0]),"https://".concat(n,"/ap/?url=").concat(e)};let c=null;const d=[],l=async()=>{const i=T("WEBCS_DOMAIN").slice(0,T("AJAX_REQUEST_CONCURRENT")).map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?a("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):a("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:dR(),serviceIds:[FT.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?FT.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?FT.CLOUD_PROXY:FT.CLOUD_PROXY_FALLBACK]}})),r=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:i.map((e=>e.url))}),c=await PR({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:i,asyncMapHandler:i=>(t.debug("[".concat(e.clientId,"] Connect to choose_server:"),i.url),vR(i,e,n,s)),allFailedhandler:e=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},r),e[0]},promisesCollector:d});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},r),c},u=async()=>{if(await N(1e3),null!==c)return c;const i=T("WEBCS_DOMAIN_BACKUP_LIST").map(((t,i)=>{let n;return n="disabled"===e.cloudProxyServer&&e.proxyServer?a("".concat(t,"/api/v2/transpond/webrtc?v=2"),i,e.proxyServer):"disabled"===e.cloudProxyServer||"fallback"===e.cloudProxyServer?"https://".concat(t,"/api/v2/transpond/webrtc?v=2"):a("".concat(t,"/api/v2/transpond/webrtc?v=2"),i),{url:n,areaCode:dR(),serviceIds:[FT.CHOOSE_SERVER,"proxy5"===e.cloudProxyServer?FT.CLOUD_PROXY_5:"proxy3"===e.cloudProxyServer||"proxy4"===e.cloudProxyServer?FT.CLOUD_PROXY:FT.CLOUD_PROXY_FALLBACK]}})),r=o.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:i.map((e=>e.url))}),l=await PR({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:i,asyncMapHandler:i=>(t.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),i.url),vR(i,e,n,s)),allFailedhandler:e=>{throw o.recordJoinChannelService({endTs:Date.now(),status:"error",errors:e},r),e[0]},promisesCollector:d});return o.recordJoinChannelService({endTs:Date.now(),status:"success"},r),l};let p,_,E;try{({gatewayInfo:p,proxyInfo:_,url:E}=await DR([l(),u()]))}catch(e){throw e[0]}if(d.length&&d.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),!p||!_)throw new hg(h.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=E,"disabled"!==e.cloudProxyServer&&Array.isArray(r)&&E){const n=/^https?:\/\/(.+?)(\/.*)?$/.exec(E)[1];jo(r).call(r,n)&&(e.proxyServer=n,t.setProxyServer(n),i.setProxyServer(n))}return c={gatewayInfo:p,proxyInfo:await rC(_,p.uid)},c}async function xR(e,t,i,n){const s=T("UAP_AP").slice(0,T("AJAX_REQUEST_CONCURRENT")).map((e=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(e+"/api/v1?action=uap"):"https://".concat(e,"/api/v1?action=uap")));return await CR(s,e,t,i,n)}async function FR(e,i,n){const s=T("UAP_AP").slice(0,T("AJAX_REQUEST_CONCURRENT")).map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v1?action=uap"):"https://".concat(t,"/api/v1?action=uap"))).map((s=>function(e,i,n,s){const o={command:"convergeAllocateEdge",sid:i.sid,appId:i.appId,token:i.token,ts:Date.now(),version:H,cname:i.cname,uid:i.uid.toString(),requestId:RR,seq:RR};RR+=1;const r={service_name:"tele_channel",json_body:JSON.stringify(o)};return z((async()=>{const i=await cR(e,{data:r,cancelToken:n,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(0!==i.code){const e=new hg(h.UNEXPECTED_RESPONSE,"cross channel ap error, code"+i.code,{retry:!0});throw t.error(e.toString()),e}const s=JSON.parse(i.json_body);if(200!==s.code){const e=new hg(h.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(s.code,", reason: ").concat(s.reason));throw t.error(e.toString()),e}if(!s.servers||0===s.servers.length){const e=new hg(h.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw t.error(e.toString()),e}return{vid:s.vid,workerToken:s.workerToken,addressList:(T("CHANNEL_MEDIA_RELAY_SERVERS")||s.servers).map((e=>"wss://".concat(e.address.replace(/\./g,"-"),".").concat(T("WORKER_DOMAIN"),":").concat(e.wss)))}}),void 0,(e=>!!(e.code!==h.OPERATION_ABORTED&&e.code!==h.UNEXPECTED_RESPONSE||e.data&&e.data.retry)),s)}(s,e,i,n)));try{const e=await DR(s);return s.forEach((e=>e.cancel())),e}catch(e){throw e[0]}}async function jR(e,i,n){let s=null;const o=[],r=async r=>{const a=T(r?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((t=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(t+"/api/v2/transpond/webrtc?v=2"):"https://".concat(t,"/api/v2/transpond/webrtc?v=2")));return r&&(await N(1e3),null!==s)?s:await PR({fragementLength:T("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:s=>(t.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(r?"backup":""," choose_server:"),s),function(e,i,n,s){const[o]=NR(i,[FT.CHOOSE_SERVER]);let r=A.networkState;return z((async()=>{r&&A.networkState===y.OFFLINE&&A.onlineWaiter&&await eg.race([A.onlineWaiter,N(s&&s.maxRetryTimeout||Z.maxRetryTimeout)]),r=A.networkState;const t=await cR(e,{data:o,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0);return wR(t,e)}),(()=>!1),(e=>e.code!==h.OPERATION_ABORTED&&(e.code===h.UPDATE_TICKET_FAILED?e.data.retry:(t.warning("[".concat(i.clientId,"] update ticket network error, retry"),e),!0))),s)}(s,e,i,n)),allFailedhandler:e=>{throw e[0]},promisesCollector:o})};try{return s=await DR([r(!1),r(!0)]),o.length&&o.forEach((e=>e.cancel&&"function"==typeof e.cancel&&e.cancel())),s}catch(e){throw e[0]}}function BR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function GR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?BR(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):BR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class WR extends g{constructor(){super(),this.configs=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.retryConfig={timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4},this.interval=void 0,this.mutex=new v("config-distribute"),this.mutableParamsRead=!1}startGetConfigDistribute(e,t){this.joinInfo=e,this.cancelToken=t,this.interval&&this.stopGetConfigDistribute(),T("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),T("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){if(!this.mutex.isLocked)return;(await this.mutex.lock())()}async updateConfigDistribute(){if(!this.mutableParamsRead){this.mutableParamsRead=!0;i.reportApiInvoke(null,{options:void 0,name:J.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:X.TRACER}).onSuccess(JSON.stringify(d))}if(!this.joinInfo||!this.cancelToken||!this.retryConfig)return void t.debug("[config-distribute] get config distribute interrupted have no joininfo");let e;const n=await this.mutex.lock();try{e=await UR(this.joinInfo,this.cancelToken,this.retryConfig),t.debug("[config-distribute] get config distribute",JSON.stringify(e)),e.limit_bitrate&&this.handleBitrateLimit(e.limit_bitrate),this.cacheGlobalParameterConfig(e),this.configs=e}catch(e){const i=new hg(h.NETWORK_RESPONSE_ERROR,e);t.warning("[config-distribute] ".concat(i.toString()))}finally{n()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(e){var t;(t=e)&&t.uplink&&t.id&&void 0!==t.uplink.max_bitrate&&void 0!==t.uplink.min_bitrate&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==e.id&&this.emit(Vg.UPDATE_BITRATE_LIMIT,e):this.emit(Vg.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&GR({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(e){var i;const n=$C(i=Object.keys(e).filter((e=>/^webrtc_ng_global_parameter/.test(e)))).call(i);for(let t=0;t<n.length;t++)for(let i=n.length-1;i>t;i--){const t=n[i];if("number"==typeof e[t].__priority){const s=e[t].__priority,o=n[i-1];if("number"==typeof e[o].__priority){if(!(s>e[o].__priority))continue;{const e=t;n[i]=n[i-1],n[i-1]=e}}else{const e=t;n[i]=n[i-1],n[i-1]=e}}}const s={};n.forEach((t=>{const i=e[t],n=i.__expires;Object.keys(i).forEach((e=>{"__priority"===e||"__expires"===e||Object.prototype.hasOwnProperty.call(s,e)||(s[e]=GR({value:i[e]},n&&{expires:n}))}))}));try{!function(e){try{const i=Date.now();Object.keys(e).forEach((n=>{switch(n){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":if(Object.prototype.hasOwnProperty.call(c,n)){const{value:s,expires:o}=e[n];if(o&&o<=i)return;d[n]=s,c[n]=s,t.debug("Update global parameters from config distribute",n,s)}}}))}catch(i){t.error("Error update config immediately: ".concat(e),i.message)}}(s);const e=JSON.stringify(s),i=window.btoa(e);window.localStorage.setItem("websdk_ng_global_parameter",i),t.debug("Caching global parameters ".concat(e))}catch(e){t.error("Error caching global parameters:",e.message)}}}function HR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function KR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?HR(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):HR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class qR extends g{constructor(e,t,n,s){super(),this.spec=void 0,this.token=void 0,this.websocket=void 0,this.pingpongTimer=void 0,this.reconnectMode="retry",this.serviceMode=void 0,this.reqId=0,this.commandReqId=0,this.handleWebSocketOpen=()=>{this.reconnectMode="retry",this.startPingPong()},this.handleWebSocketMessage=e=>{if(!e.data)return;const t=JSON.parse(e.data);t.requestId?this.emit("@".concat(t.requestId,"-").concat(t.sid),t):this.serviceMode===QS.INJECT?this.emit(gg.INJECT_STREAM_STATUS,t):(i.workerEvent(this.spec.sid,{actionType:"status",serverCode:t.code,workerType:this.serviceMode===QS.TRANSCODE?1:2}),this.emit(gg.PUBLISH_STREAM_STATUS,t))},this.spec=t,this.token=e,this.serviceMode=s,this.websocket=new vT("live-streaming",n),this.websocket.on(zS.CONNECTED,this.handleWebSocketOpen),this.websocket.on(zS.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(zS.REQUEST_NEW_URLS,((e,t)=>{b(this,gg.REQUEST_NEW_ADDRESS).then(e).catch(t)})),this.websocket.on(zS.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(e){return this.websocket.init(e)}async request(e,t,n,s){this.reqId+=1,"request"===e&&(this.commandReqId+=1);const o=this.commandReqId,r=this.reqId;if(!r||!this.websocket)throw new hg(h.UNEXPECTED_ERROR);const a=KR({command:e,sdkVersion:"4.19.0"===H?"0.0.1":H,seq:r,requestId:r,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},t);if("closed"===this.websocket.state)throw new hg(h.WS_DISCONNECT);const c=()=>new eg(((e,t)=>{this.websocket.once(zS.CLOSED,(()=>t(new hg(h.WS_ABORT)))),this.websocket.once(zS.CONNECTED,e)}));"connected"!==this.websocket.state&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new eg(((e,t)=>{const i=()=>{t(new hg(h.WS_ABORT))};this.websocket.once(zS.RECONNECTING,i),this.websocket.once(zS.CLOSED,i),this.once("@".concat(r,"-").concat(this.spec.sid),(t=>{e(t)}))}));s&&i.workerEvent(this.spec.sid,KR(KR({},s),{},{requestId:o,actionType:"request",payload:JSON.stringify(t.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=await d}catch(i){if("closed"===this.websocket.state)throw i;return await c(),await this.request(e,t,n)}return s&&i.workerEvent(this.spec.sid,KR(KR({},s),{},{requestId:o,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:200===u.code,responseTime:Date.now()-l})),200!==u.code&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const e="4.19.0"===H?"0.0.1":H;this.reqId+=1,"connected"===this.websocket.state?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case Cg.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void t.warning("live stream response already exists stream");case Cg.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Cg.LIVE_STREAM_RESPONSE_BAD_STREAM:case Cg.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new hg(h.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case Cg.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new hg(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Cg.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new hg(h.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case Cg.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const t=new hg(h.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(gg.WARNING,t,e.serverResponse.url)}case Cg.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const t=new hg(h.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(gg.WARNING,t,e.serverResponse.url)}case Cg.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new hg(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Cg.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new hg(h.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case Cg.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const t=new hg(h.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(gg.WARNING,t,e.serverResponse.url)}case Cg.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new hg(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case Cg.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new hg(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Cg.LIVE_STREAM_RESPONSE_WORKER_LOST:case Cg.LIVE_STREAM_RESPONSE_WORKER_QUIT:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;throw new hg(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Cg.ERROR_FAIL_SEND_MESSAGE:if("UnpublishStream"===e.serverResponse.command||"UninjectStream"===e.serverResponse.command)return;if("UpdateTranscoding"===e.serverResponse.command||"ControlStream"===e.serverResponse.command)return new hg(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new hg(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Cg.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Cg.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Cg.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Cg.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new hg(h.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{"connected"===this.websocket.state&&this.request("ping",{}).catch($)}),6e3)}}function YR(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function JR(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?YR(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):YR(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class XR extends g{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Z,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Z;super(),this.onLiveStreamWarning=void 0,this.onLiveStreamError=void 0,this.onInjectStatusChange=void 0,this.spec=void 0,this.retryTimeout=1e4,this.connection=void 0,this.httpRetryConfig=void 0,this.wsRetryConfig=void 0,this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.taskMutex=new v("live-streaming"),this.cancelToken=ut.CancelToken.source(),this.transcodingConfig=void 0,this.injectConfig=JR({},Sg),this.injectLoopTimes=0,this.uapResponse=void 0,this.lastTaskId=1,this.statusError=new Map,this.spec=e,this.httpRetryConfig=i,this.wsRetryConfig=t}async setTranscodingConfig(e){const i=JR(JR({},fg),e);66!==i.videoCodecProfile&&77!==i.videoCodecProfile&&100!==i.videoCodecProfile&&(t.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map((e=>JR(JR(JR({},_g),e),{},{zOrder:e.zOrder?e.zOrder+1:1})))),function(e){p(e.width)||_(e.width,"config.width",0,1e4),p(e.height)||_(e.height,"config.height",0,1e4),p(e.videoBitrate)||_(e.videoBitrate,"config.videoBitrate",1,1e6),p(e.videoFrameRate)||_(e.videoFrameRate,"config.videoFrameRate"),p(e.lowLatency)||E(e.lowLatency,"config.lowLatency"),p(e.audioSampleRate)||m(e.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),p(e.audioBitrate)||_(e.audioBitrate,"config.audioBitrate",1,128),p(e.audioChannels)||m(e.audioChannels,"config.audioChannels",[1,2,3,4,5]),p(e.videoGop)||_(e.videoGop,"config.videoGop"),p(e.videoCodecProfile)||m(e.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),p(e.userCount)||_(e.userCount,"config.userCount",0,17),p(e.backgroundColor)||_(e.backgroundColor,"config.backgroundColor",0,16777215),p(e.userConfigExtraInfo)||f(e.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),e.transcodingUsers&&!p(e.transcodingUsers)&&(S(e.transcodingUsers,"config.transcodingUsers"),e.transcodingUsers.forEach(((e,t)=>{pg(e.uid),p(e.x)||_(e.x,"transcodingUser[".concat(t,"].x"),0,1e4),p(e.y)||_(e.y,"transcodingUser[".concat(t,"].y"),0,1e4),p(e.width)||_(e.width,"transcodingUser[".concat(t,"].width"),0,1e4),p(e.height)||_(e.height,"transcodingUser[".concat(t,"].height"),0,1e4),p(e.zOrder)||_(e.zOrder-1,"transcodingUser[".concat(t,"].zOrder"),0,100),p(e.alpha)||_(e.alpha,"transcodingUser[".concat(t,"].alpha"),0,1,!1)}))),p(e.watermark)||mg(e.watermark,"watermark"),p(e.backgroundImage)||mg(e.backgroundImage,"backgroundImage"),e.images&&!p(e.images)&&(S(e.images,"config.images"),e.images.forEach(((e,t)=>{mg(e,"images[".concat(t,"]"))})))}(i);const n=[];i.images&&n.push(...i.images.map((e=>JR(JR(JR({},Eg),e),{},{zOrder:255})))),i.backgroundImage&&(n.push(JR(JR(JR({},Eg),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(n.push(JR(JR(JR({},Eg),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=n,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map((e=>JR({},e))),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);const s=(i.userConfigs||[]).map((e=>"number"==typeof e.uid?eg.resolve(e.uid):MR(e.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await eg.all(s)).forEach(((e,t)=>{i.userConfigs&&i.userConfigs[t]&&(i.userConfigs[t].uid=e)})),this.transcodingConfig=i,this.connection)try{var o;const e=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(cg(o=this.streamingTasks).call(o)).map((e=>e.taskId)).join("#")});t.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(e.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(e){if(!e.data||!e.data.retry)throw e;e.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((i=>{t.warning("[".concat(this.spec.clientId,"] live streaming receive error"),e.toString(),"try to republish",i.url),this.startLiveStreamingTask(i.url,i.mode,e).then((()=>{t.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(i.url," success"))})).catch((e=>{t.error("[".concat(this.spec.clientId,"] live streaming republish failed"),i.url,e.toString()),this.onLiveStreamError&&this.onLiveStreamError(i.url,e)}))}))}}setInjectStreamConfig(e,t){this.injectConfig=Object.assign({},this.injectConfig,e),this.injectLoopTimes=t}async startLiveStreamingTask(e,i,n){var s;if(Array.from(cg(s=this.streamingTasks).call(s)).find((e=>e.mode===QS.INJECT))&&i===QS.INJECT)return new hg(h.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&i===QS.TRANSCODE)throw new hg(h.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let o={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};t.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(i));const r=await this.taskMutex.lock();if(!this.connection&&n)return void r();if(this.streamingTasks.get(e)&&!n)return r(),new hg(h.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(e){throw r(),e}switch(i){case QS.TRANSCODE:o.transcodingConfig=JR({},this.transcodingConfig);break;case QS.RAW:break;case QS.INJECT:o={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:e,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(o.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const a=this.lastTaskId++;try{const s=new eg(((t,i)=>{N(this.retryTimeout).then((()=>{if(n)return i(n);const t=this.statusError.get(e);return t?(this.statusError.delete(e),i(t)):void 0}))})),c=await eg.race([this.connection.request("request",{clientRequest:o},!0,{url:e,command:"PublishStream",workerType:i===QS.TRANSCODE?1:2,requestByUser:!n,tid:a.toString()}),s]);this.isStartingStreamingTask=!1,t.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(e,{clientRequest:o,mode:i,url:e,taskId:a}),r()}catch(t){if(r(),this.isStartingStreamingTask=!1,!t.data||!t.data.retry||n)throw t;return t.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(e,i,t)):await this.startLiveStreamingTask(e,i,t)}}stopLiveStreamingTask(e){return new eg(((i,n)=>{const s=this.streamingTasks.get(e);if(!s||!this.connection)return new hg(h.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=s.mode;s.abortTask=()=>{t.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),i()},this.connection.request("request",{clientRequest:{command:o===QS.INJECT?"UninjectStream":"UnpublishStream",url:s.url}},!1,{url:e,command:"UnPublishStream",workerType:o===QS.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((n=>{t.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(n.code)),this.streamingTasks.delete(e),0===this.streamingTasks.size&&o!==QS.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),i(),o===QS.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(ZS.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,e)})).catch(n)}))}async controlInjectStream(e,t,i,n){const s=this.streamingTasks.get(e);if(!s||!this.connection||s.mode!==QS.INJECT)throw new hg(h.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:e,control:t,audioVolume:i,position:n}})).serverResponse}resetAllTask(){var e;const t=Array.from(cg(e=this.streamingTasks).call(e));this.terminate();for(const e of t)this.startLiveStreamingTask(e.url,e.mode).catch((t=>{this.onLiveStreamError&&this.onLiveStreamError(e.url,t)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=ut.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(e){if(this.connection)throw new hg(h.UNEXPECTED_ERROR,"live streaming connection has already connected");const t=await b(this,Tg.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=t,this.connection=new qR(t.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(gg.WARNING,((e,t)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(t,e))),this.connection.on(gg.PUBLISH_STREAM_STATUS,(e=>this.handlePublishStreamServer(e))),this.connection.on(gg.INJECT_STREAM_STATUS,(e=>this.handleInjectStreamServerStatus(e))),this.connection.on(gg.REQUEST_NEW_ADDRESS,((t,i)=>{if(!this.connection)return i(new hg(h.UNEXPECTED_ERROR,"can not get new live streaming address list"));b(this,Tg.REQUEST_WORKER_MANAGER_LIST,e).then((e=>{this.uapResponse=e,t(e.addressList)})).catch(i)})),await this.connection.init(t.addressList),this.connection}handlePublishStreamServer(e){const i=e.serverStatus&&e.serverStatus.url||"empty_url",n=this.streamingTasks.get(i),s=e.reason;switch(e.code){case Cg.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Cg.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Cg.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Cg.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const s=new hg(h.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(n)return t.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,s);if(!this.isStartingStreamingTask)return;this.statusError.set(i,s)}case Cg.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const e=new hg(h.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,s);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,e)}case Cg.LIVE_STREAM_RESPONSE_WORKER_LOST:case Cg.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();const i=Array.from(cg(o=this.streamingTasks).call(o));for(const n of i)n.abortTask?n.abortTask():(t.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",n.url),this.startLiveStreamingTask(n.url,n.mode,new hg(h.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then((()=>{t.debug("[".concat(this.spec.clientId,"] republish live stream success"),n.url)})).catch((e=>{t.error(e.toString()),this.onLiveStreamError&&this.onLiveStreamError(n.url,e)})));return}}}handleInjectStreamServerStatus(e){const i=Number(e.uid),n=e.serverStatus&&e.serverStatus.url;switch(e.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(ZS.INJECT_STREAM_STATUS_START_SUCCESS,i,n));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(ZS.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,i,n),void this.streamingTasks.delete(n);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(ZS.INJECT_STREAM_STATUS_START_UNAUTHORIZED,i,n),void this.streamingTasks.delete(n);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(ZS.INJECT_STREAM_STATUS_BROKEN,i,n),void this.streamingTasks.delete(n);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(ZS.INJECT_STREAM_STATUS_START_TIMEOUT,i,n),void this.streamingTasks.delete(n);default:return void t.debug("inject stream server status",e)}}hasUrl(e){return this.streamingTasks.has(e)}}class zR{constructor(){this.destChannelMediaInfos=new Map,this.srcChannelMediaInfo=void 0}setSrcChannelInfo(e){Lg(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){Lg(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){ug(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function QR(e){if(!(e instanceof zR)){return new hg(h.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw()}const t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();if(!t){return new hg(h.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw()}if(0===i.size){return new hg(h.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}}class ZR extends g{constructor(e,t,i){super(),this.ws=void 0,this.requestId=1,this.heartBeatTimer=void 0,this.joinInfo=void 0,this.clientId=void 0,this.onOpen=()=>{this.emit("open"),this.startHeartBeatCheck()},this.onClose=e=>{this.emit("close"),this.dispose()},this.onMessage=e=>{const t=JSON.parse(e.data);if(!t||"serverResponse"!==t.command||!t.requestId)return t&&"serverStatus"===t.command&&t.serverStatus&&t.serverStatus.command?(this.emit("status",t.serverStatus),void this.emit(t.serverStatus.command,t.serverStatus)):void 0;this.emit("req_".concat(t.requestId),t)},this.joinInfo=e,this.clientId=t,this.ws=new vT("cross-channel-".concat(this.clientId),i),this.ws.on(zS.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(zS.CONNECTED,this.onOpen),this.ws.on(zS.ON_MESSAGE,this.onMessage),this.ws.on(zS.CLOSED,this.onClose)}isConnect(){return"connected"===this.ws.state}sendMessage(e){const t=this.requestId++;return e.requestId=t,e.seq=t,this.ws.sendMessage(e),t}waitStatus(e){return new eg(((t,i)=>{const n=window.setTimeout((()=>{i(new hg(h.TIMEOUT,"wait status timeout, status: ".concat(e)))}),5e3);this.once(e,(s=>{window.clearTimeout(n),s.state&&0!==s.state?i(new hg(h.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):t(void 0)})),this.once("dispose",(()=>{window.clearTimeout(n),i(new hg(h.WS_ABORT))}))}))}async request(e){if("closed"===this.ws.state)throw new hg(h.WS_DISCONNECT);const t=()=>new eg(((e,t)=>{this.ws.once(zS.CLOSED,(()=>t(new hg(h.WS_ABORT)))),this.ws.once(zS.CONNECTED,e)}));"connected"!==this.ws.state&&await t();const i=this.sendMessage(e),n=new eg(((e,t)=>{const n=()=>{t(new hg(h.WS_ABORT))};this.ws.once(zS.RECONNECTING,n),this.ws.once(zS.CLOSED,n),this.once("req_".concat(i),e),N(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(zS.RECONNECTING,n),this.ws.off(zS.CLOSED,n),t(new hg(h.TIMEOUT,"cross channel ws request timeout"))}))})),s=await n;if(!s||200!==s.code)throw new hg(h.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(e){this.ws.removeAllListeners(zS.REQUEST_NEW_URLS),this.ws.on(zS.REQUEST_NEW_URLS,(t=>{t(e)})),await this.ws.init(e)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){const t=this.requestId++;return e.requestId=t,this.ws.sendMessage(e),t}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class $R extends g{set state(e){e!==this._state&&(e!==yg.RELAY_STATE_FAILURE&&(this.errorCode=Ag.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,i,n,s,o){super(),this.joinInfo=void 0,this.sid=void 0,this.clientId=void 0,this.cancelToken=ut.CancelToken.source(),this.workerToken=void 0,this.requestId=0,this.signal=void 0,this.prevChannelMediaConfig=void 0,this.httpRetryConfig=void 0,this._resolution=void 0,this._state=yg.RELAY_STATE_IDLE,this.errorCode=Ag.RELAY_OK,this.onStatus=e=>{t.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(e))),e&&e.command&&("onAudioPacketReceived"===e.command&&this.emit("event",vg.PACKET_RECEIVED_AUDIO_FROM_SRC),"onVideoPacketReceived"===e.command&&this.emit("event",vg.PACKET_RECEIVED_VIDEO_FROM_SRC),"onSrcTokenPrivilegeDidExpire"===e.command&&(this.errorCode=Ag.SRC_TOKEN_EXPIRED,this.state=yg.RELAY_STATE_FAILURE),"onDestTokenPrivilegeDidExpire"===e.command&&(this.errorCode=Ag.DEST_TOKEN_EXPIRED,this.state=yg.RELAY_STATE_FAILURE))},this.onReconnect=async()=>{t.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",vg.NETWORK_DISCONNECTED),this.state=yg.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((e=>{this.state!==yg.RELAY_STATE_IDLE&&(t.error("auto restart channel media relay failed",e.toString()),this.errorCode=Ag.SERVER_CONNECTION_LOST,this.state=yg.RELAY_STATE_FAILURE)}))},this.joinInfo=e,this.clientId=i,this.sid=ee(),this.signal=new ZR(this.joinInfo,this.clientId,n),this.httpRetryConfig=s,this._resolution=o}async startChannelMediaRelay(e){if(this.state!==yg.RELAY_STATE_IDLE)throw new hg(h.INVALID_OPERATION);this.state=yg.RELAY_STATE_CONNECTING,await this.connect(),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(e)}catch(e){if(e.data&&e.data.serverResponse&&"SetSourceChannel"===e.data.serverResponse.command)throw new hg(h.CROSS_CHANNEL_FAILED_JOIN_SRC);if(e.data&&e.data.serverResponse&&"SetDestChannelStatus"===e.serverResponse.command)throw new hg(h.CROSS_CHANNEL_FAILED_JOIN_DEST);if(e.data&&e.data.serverResponse&&"StartPacketTransfer"===e.serverResponse.command)throw new hg(h.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST);throw e}this.prevChannelMediaConfig=e}async updateChannelMediaRelay(e){if(this.state!==yg.RELAY_STATE_RUNNING)throw new hg(h.INVALID_OPERATION);await this.sendUpdateMessage(e),this.prevChannelMediaConfig=e}async setVideoProfile(e){if(this._resolution=e,this.state!==yg.RELAY_STATE_RUNNING)throw new hg(h.INVALID_OPERATION);const i=this.genMessage(Ig.SetVideoProfile);await this.signal.request(i),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),t.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=yg.RELAY_STATE_IDLE,this.dispose()}dispose(){t.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=ut.CancelToken.source(),this.state=yg.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const e=await FR(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,await this.signal.connect(e.addressList),this.emit("event",vg.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(e){const i=this.genMessage(Ig.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const n=this.genMessage(Ig.SetSdkProfile,e);await this.signal.request(n),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const s=this.genMessage(Ig.SetSourceChannel,e);await this.signal.request(s),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",vg.PACKET_JOINED_SRC_CHANNEL),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(Ig.SetSourceUserId,e);await this.signal.request(o),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const r=this.genMessage(Ig.SetDestChannel,e);await this.signal.request(r),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",vg.PACKET_JOINED_DEST_CHANNEL),t.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(Ig.StartPacketTransfer,e);await this.signal.request(a),this.emit("event",vg.PACKET_SENT_TO_DEST_CHANNEL),this.state=yg.RELAY_STATE_RUNNING,t.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(e){const i=this.genMessage(Ig.UpdateDestChannel,e);await this.signal.request(i),this.emit("event",vg.PACKET_UPDATE_DEST_CHANNEL),t.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const e=this.genMessage(Ig.StopPacketTransfer);await this.signal.request(e),t.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(e,t){const i=[],n=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:H,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};"4.19.0"===o.sdkVersion&&(o.sdkVersion="0.0.1");let r=null,a=null;switch(e){case Ig.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case Ig.SetSourceChannel:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new hg(h.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:a.channelName,token:a.token||this.joinInfo.appId},o;case Ig.SetSourceUserId:if(a=t&&t.getSrcChannelMediaInfo(),!a)throw new hg(h.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:a.uid+""},o;case Ig.SetDestChannel:if(r=t&&t.getDestChannelMediaInfo(),!r)throw new hg(h.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:n,token:s},o;case Ig.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case Ig.Reconnect:return o.clientRequest={command:"Reconnect"},o;case Ig.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case Ig.UpdateDestChannel:if(r=t&&t.getDestChannelMediaInfo(),!r)throw new hg(h.UNEXPECTED_ERROR,"can not find dest config");return r.forEach((e=>{i.push(e.channelName),n.push(e.uid+""),s.push(e.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:n,token:s},o;case Ig.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}class eI{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio)return this._audioTrack}get videoTrack(){if(this.hasVideo)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,t){this.uid=void 0,this._uintid=void 0,this._trust_in_room_=!0,this._trust_audio_enabled_state_=!0,this._trust_video_enabled_state_=!0,this._trust_audio_mute_state_=!0,this._trust_video_mute_state_=!0,this._audio_muted_=!1,this._video_muted_=!1,this._audio_enabled_=!0,this._video_enabled_=!0,this._audio_added_=!1,this._video_added_=!1,this._trust_video_stream_added_state_=!0,this._trust_audio_stream_added_state_=!0,this._audioTrack=void 0,this._videoTrack=void 0,this._dataChannels=[],this._audioSSRC=void 0,this._videoSSRC=void 0,this._audioOrtc=void 0,this._videoOrtc=void 0,this._cname=void 0,this._rtxSsrcId=void 0,this.uid=e,this._uintid=t}}var tI=$S,iI=jm;Bs({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var e=iI.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var nI=jm,sI=Cm;Bs({target:"Promise",stat:!0,forced:!0},{try:function(e){var t=nI.f(this),i=sI(e);return(i.error?t.reject:t.resolve)(i.value),t.promise}});var oI=_t(tI),rI=tc.f("asyncIterator"),aI=_t(rI);function cI(e,t){this.v=e,this.k=t}function dI(e){var t,i;function n(t,i){try{var o=e[t](i),r=o.value,a=r instanceof cI;oI.resolve(a?r.v:r).then((function(i){if(a){var c="return"===t?"return":"next";if(!r.k||i.done)return n(c,i);i=e[c](i).value}s(o.done?"return":"normal",i)}),(function(e){n("throw",e)}))}catch(e){s("throw",e)}}function s(e,s){switch(e){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?n(t.key,t.arg):i=null}this._invoke=function(e,s){return new oI((function(o,r){var a={key:e,arg:s,resolve:o,reject:r,next:null};i?i=i.next=a:(t=i=a,n(e,s))}))},"function"!=typeof e.return&&(this.return=void 0)}function lI(e){return function(){return new dI(e.apply(this,arguments))}}function hI(e){return new cI(e,0)}function uI(e){var t={},i=!1;function n(t,n){return i=!0,{done:!1,value:new cI(n=new oI((function(i){i(e[t](n))})),1)}}return t[void 0!==Zu&&Ep||"@@iterator"]=function(){return this},t.next=function(e){return i?(i=!1,e):n("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(i)throw i=!1,e;return n("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return i?(i=!1,e):n("return",e)}),t}dI.prototype["function"==typeof Zu&&aI||"@@asyncIterator"]=function(){return this},dI.prototype.next=function(e){return this._invoke("next",e)},dI.prototype.throw=function(e){return this._invoke("throw",e)},dI.prototype.return=function(e){return this._invoke("return",e)};var pI=_t(rI),_I=ao("Array").keys,EI=Io,mI=hn,fI=Rt,SI=_I,gI=Array.prototype,TI={DOMTokenList:!0,NodeList:!0},CI=_t((function(e){var t=e.keys;return e===gI||fI(gI,e)&&t===gI.keys||mI(TI,EI(e))?SI:t})),RI={exports:{}};RI.exports=(()=>{var e={8:(e,t,i)=>{i.r(t),i.d(t,{Parser:()=>R,Printer:()=>w,parse:()=>D,print:()=>P});const n="\n",s="".concat("\r").concat(n),o=" ";let r;function a(e){return e>="0"&&e<="9"}function c(e){return e>="!"&&e<="~"}function d(e){return c(e)||e>="Â"&&e<="Ã¿"}function l(e){return"!"===e||e>="#"&&e<="'"||e>="*"&&e<="+"||e>="-"&&e<="."||e>="0"&&e<="9"||e>="A"&&e<="Z"||e>="^"&&e<="~"}function h(e){return e>="1"&&e<="9"}function u(e){return e>="A"&&e<="Z"||e>="a"&&e<="z"}function p(e){return"d"===e||"h"===e||"m"===e||"s"===e}function _(e){return e>""&&e<"\t"||e>"\v"&&e<"\f"||e>""&&e<"Ã¿"}function E(e){return u(e)||a(e)||"+"===e||"/"===e}function m(e){return a(e)||u(e)||"+"===e||"/"===e||"-"===e||"_"===e}function f(e){return u(e)||a(e)||"+"===e||"/"===e}function S(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function g(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?S(Object(i),!0).forEach((function(t){T(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):S(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function T(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}!function(e){e.VERSION="v",e.ORIGIN="o",e.SESSION_NAME="s",e.INFORMATION="i",e.URI="u",e.EMAIL="e",e.PHONE="p",e.CONNECTION="c",e.BANDWIDTH="b",e.TIME="t",e.REPEAT="r",e.ZONE_ADJUSTMENTS="z",e.KEY="k",e.ATTRIBUTE="a",e.MEDIA="m"}(r||(r={}));class C{consumeText(e,t){let i=t;for(;i<e.length;){const t=e[i];if("\0"===t||"\r"===t||t===n)break;i+=1}if(i-t==0)throw new Error("Invalid text, at ".concat(e));return i}consumeUnicastAddress(e,t,i){return this.consumeTill(e,t,o)}consumeOneOrMore(e,t,i){let n=t;for(;i(e[n]);)n++;if(n-t==0)throw new Error("Invalid rule at ".concat(t,"."));return n}consumeSpace(e,t){if(e[t]===o)return t+1;throw new Error("Invalid space at ".concat(t,"."))}consumeIP4Address(e,t){let i=t;for(let t=0;t<4;t++)if(i=this.consumeDecimalUChar(e,i),3!==t){if("."!==e[i])throw new Error("Invalid IP4 address.");i++}return i}consumeDecimalUChar(e,t){let i=t;for(let t=0;t<3&&a(e[i]);t++,i++);if(i-t==0)throw new Error("Invalid decimal uchar.");const n=parseInt(e.slice(t,i));if(n>=0&&n<=255)return i;throw new Error("Invalid decimal uchar")}consumeIP6Address(e,t){let i=this.consumeHexpart(e,t);return":"===e[i]?(i+=1,i=this.consumeIP4Address(e,i),i):i}consumeHexpart(e,t){let i=t;if(":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}if(i=this.consumeHexseq(e,i),":"===e[i]&&":"===e[i+1]){i+=2;try{i=this.consumeHexseq(e,i)}catch(e){}return i}return i}consumeHexseq(e,t){let i=t;for(;i=this.consumeHex4(e,i),":"===e[i]&&":"!==e[i+1];)i+=1;return i}consumeHex4(e,t){let i=0;for(;i<4;i++)if(!((n=e[t+i])>="0"&&n<="9"||n>="a"&&n<="f"||n>="A"&&n<="F")){if(0===i)throw new Error("Invalid hex 4");break}var n;return t+i}consumeFQDN(e,t){let i=t;for(;a(e[i])||u(e[i])||"-"===e[i]||"."===e[i];)i+=1;if(i-t<4)throw new Error("Invalid FQDN");return i}consumeExtnAddr(e,t){return this.consumeOneOrMore(e,t,d)}consumeMulticastAddress(e,t,i){switch(i){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(e,t);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(e,t);default:try{return this.consumeFQDN(e,t)}catch(i){return this.consumeExtnAddr(e,t)}}}consumeIP6MulticastAddress(e,t){const i=this.consumeHexpart(e,t);return"/"===e[i]?this.consumeInteger(e,i+1):i}consumeIP4MulticastAddress(e,t){let i=t+3;const n=e.slice(t,i),s=parseInt(n);if(s<224||s>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let t=0;t<3;t++){if("."!==e[i])throw new Error("Invalid IP4 multicast address.");i+=1,i=this.consumeDecimalUChar(e,i)}return"/"===e[i]&&(i+=1),i=this.consumeTTL(e,i),"/"===e[i]&&(i=this.consumeInteger(e,i)),i}consumeInteger(e,t){if(!h(e[t]))throw new Error("Invalid integer.");for(t+=1;a(e[t]);)t+=1;return t}consumeTTL(e,t){if("0"===e[t])return t+1;if(!h(e[t]))throw new Error("Invalid TTL.");t+=1;for(let i=0;i<2&&a(e[t]);i++)t+=1;return t}consumeToken(e,t){return this.consumeOneOrMore(e,t,l)}consumeTime(e,t){let i=t;if("0"===e[i])return i+1;for(h(e[i])&&(i+=1);a(e[i]);)i++;if(i-t<10)throw new Error("Invalid time");return i}consumeAddress(e,t){return this.consumeTill(e,t,o)}consumeTypedTime(e,t){let i=t;return i=this.consumeOneOrMore(e,i,a),p(e[i])?i+1:i}consumeRepeatInterval(e,t){if(!h(e[t]))throw new Error("Invalid repeat interval");for(t+=1;a(e[t]);)t+=1;return p(e[t])&&(t+=1),t}consumePort(e,t){return this.consumeOneOrMore(e,t,a)}consume(e,t,i){for(let n=0;n<i.length;n++){if(t+n>=e.length)throw new Error("consume exceeding value length");if(e[t+n]!==i[n])throw new Error("consume ".concat(i," failed at ").concat(n))}return t+i.length}consumeTill(e,t,i){let n=t;for(;n<e.length&&("string"!=typeof i||e[n]!==i)&&("function"!=typeof i||!i(e[n]));)n++;return n}}class R extends C{constructor(){super(),T(this,"records",[]),T(this,"currentLine",0)}parse(e){const t=this.probeEOL(e);this.records=e.split(t).filter((e=>!!e.trim())).map(this.parseLine),this.currentLine=0;const i=this.parseVersion(),n=this.parseOrigin(),s=this.parseSessionName(),o=this.parseInformation(),r=this.parseUri(),a=this.parseEmail(),c=this.parsePhone(),d=this.parseConnection(),l=this.parseBandWidth(),h=this.parseTimeFields(),u=this.parseKey(),p=this.parseSessionAttribute(),_=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:i,origin:n,sessionName:s,information:o,uri:r,emails:a,phones:c,connection:d,bandwidths:l,timeFields:h,key:u,attributes:p,mediaDescriptions:_}}getCurrentRecord(){const e=this.records[this.currentLine];if(!e)throw new Error("Record doesn't exit.");return e}probeEOL(e){for(let t=0;t<e.length;t++)if(e[t]===n)return"\r"===e[t-1]?s:n;throw new Error("Invalid newline character.")}parseLine(e,t){if(e.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const i=e[0];if("="!==e[1])throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:i,value:e.slice(2),line:t,cur:0}}parseSessionAttribute(){const e=new v;for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(t,(e=>l(e)&&":"!==e)),_cur:0};":"===t.value[t.cur]&&(t.cur+=1,i.attValue=this.extractOneOrMore(t,_)),e.parse(i),this.currentLine++}return e.digest()}parseMediaAttributes(e){const t=new y(e);for(;this.currentLine<this.records.length;){const e=this.getCurrentRecord();if(e.type!==r.ATTRIBUTE)break;const i={attField:this.extractOneOrMore(e,(e=>l(e)&&":"!==e)),_cur:0};":"===e.value[e.cur]&&(e.cur+=1,i.attValue=this.extractOneOrMore(e,_)),t.parse(i),this.currentLine++}return t.digest()}parseKey(){const e=this.getCurrentRecord();if(e.type===r.KEY){if("prompt"===e.value||"clear:"===e.value||"base64:"===e.value||"uri:"===e.value)return e.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const e=this.getCurrentRecord();if(e.type===r.ZONE_ADJUSTMENTS){const t=[];for(;;)try{const i=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);let n=!1;"-"===e.value[e.cur]&&(n=!0,e.cur+=1);const s=this.extract(e,this.consumeTypedTime);t.push({time:i,typedTime:s,back:n})}catch(e){break}if(0===t.length)throw new Error("Invalid zone adjustments");return this.currentLine++,t}return[]}parseRepeat(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.REPEAT)break;{const i=this.extract(t,this.consumeRepeatInterval),n=this.parseTypedTime(t);e.push({repeatInterval:i,typedTimes:n}),this.currentLine++}}return e}parseTypedTime(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeTypedTime))}catch(e){break}if(0===t.length)throw new Error("Invalid typed time.");return t}parseTime(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeTime);this.consumeSpaceForRecord(e);const i=this.extract(e,this.consumeTime);return this.currentLine++,{startTime:t,stopTime:i}}parseBandWidth(){const e=[];for(;this.currentLine<this.records.length;){const t=this.getCurrentRecord();if(t.type!==r.BANDWIDTH)break;{const i=this.extractOneOrMore(t,l);if(":"!==t.value[t.cur])throw new Error("Invalid bandwidth field.");t.cur++;const n=this.extractOneOrMore(t,a);e.push({bwtype:i,bandwidth:n}),this.currentLine++}}return e}parseVersion(){const e=this.getCurrentRecord();if(e.type!==r.VERSION)throw new Error("first sdp record must be version");const t=e.value.slice(0,this.consumeOneOrMore(e.value,0,a));if(t.length!==e.value.length)throw new Error('invalid proto version, "v='.concat(e.value,'"'));return this.currentLine++,t}parseOrigin(){const e=this.getCurrentRecord();if(e.type!==r.ORIGIN)throw new Error("second line of sdp must be origin");const t=this.extractOneOrMore(e,d);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const n=this.extractOneOrMore(e,a);this.consumeSpaceForRecord(e);const s=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const o=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const c=this.extract(e,this.consumeUnicastAddress);return this.currentLine++,{username:t,sessId:i,sessVersion:n,nettype:s,addrtype:o,unicastAddress:c}}parseSessionName(){const e=this.getCurrentRecord();if(e.type===r.SESSION_NAME){const t=this.extract(e,this.consumeText);return this.currentLine++,t}}parseInformation(){const e=this.getCurrentRecord();if(e.type!==r.INFORMATION)return;const t=this.extract(e,this.consumeText);return this.currentLine++,t}parseUri(){const e=this.getCurrentRecord();if(e.type===r.URI)return this.currentLine++,e.value}parseEmail(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.EMAIL)break;e.push(t.value),this.currentLine++}return e}parsePhone(){const e=[];for(;;){const t=this.getCurrentRecord();if(t.type!==r.PHONE)break;e.push(t.value),this.currentLine++}return e}parseConnection(){const e=this.getCurrentRecord();if(e.type===r.CONNECTION){const t=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const i=this.extractOneOrMore(e,l);this.consumeSpaceForRecord(e);const n=this.extract(e,this.consumeAddress);return this.currentLine++,{nettype:t,addrtype:i,address:n}}}parseMedia(){const e=this.getCurrentRecord(),t=this.extract(e,this.consumeToken);this.consumeSpaceForRecord(e);let i=this.extract(e,this.consumePort);"/"===e.value[e.cur]&&(e.cur+=1,i+=this.extract(e,this.consumeInteger)),this.consumeSpaceForRecord(e);const n=[];for(n.push(this.extract(e,this.consumeToken));"/"===e.value[e.cur];)e.cur+=1,n.push(this.extract(e,this.consumeToken));if(0===n.length)throw new Error("Invalid proto");const s=this.parseFmt(e);return this.currentLine++,{mediaType:t,port:i,protos:n,fmts:s}}parseTimeFields(){const e=[];for(;this.getCurrentRecord().type===r.TIME;){const t=this.parseTime(),i=this.parseRepeat(),n=this.parseZone();e.push({time:t,repeats:i,zones:n})}return e}parseMediaDescription(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.MEDIA;){const t=this.parseMedia(),i=this.parseInformation(),n=this.parseConnections(),s=this.parseBandWidth(),o=this.parseKey(),r=this.parseMediaAttributes(t);e.push({media:t,information:i,connections:n,bandwidths:s,key:o,attributes:r})}return e}parseConnections(){const e=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===r.CONNECTION;)e.push(this.parseConnection());return e}parseFmt(e){const t=[];for(;;)try{this.consumeSpaceForRecord(e),t.push(this.extract(e,this.consumeToken))}catch(e){break}if(0===t.length)throw new Error("Invalid fmts");return t}extract(e,t,...i){const n=t.call(this,e.value,e.cur,...i),s=e.value.slice(e.cur,n);return e.cur=n,s}extractOneOrMore(e,t){const i=this.consumeOneOrMore(e.value,e.cur,t),n=e.value.slice(e.cur,i);return e.cur=i,n}consumeSpaceForRecord(e){if(e.value[e.cur]!==o)throw new Error("Invalid space at ".concat(e.cur,"."));e.cur+=1}}class I extends C{constructor(...e){super(...e),T(this,"attributes",void 0),T(this,"digested",!1)}extractOneOrMore(e,t,i){const n=this.consumeOneOrMore(e.attValue,e._cur,t),s=e.attValue.slice(e._cur,n),[o,r]=i||[];if("number"==typeof o&&s.length<o)throw new Error("error in length, should be more or equal than ".concat(o," characters."));if("number"==typeof r&&s.length>r)throw new Error("error in length, should be less or equal than ".concat(r," characters."));return e._cur=n,s}consumeAttributeSpace(e){if(e.attValue[e._cur]!==o)throw new Error("Invalid space at ".concat(e._cur,"."));e._cur+=1}extract(e,t,...i){if(!e.attValue)throw new Error("Nothing to extract from attValue.");const n=t.call(this,e.attValue,e._cur,...i),s=e.attValue.slice(e._cur,n);return e._cur=n,s}atEnd(e){if(!e.attValue)throw new Error;return e._cur>=e.attValue.length}peekChar(e){if(!e.attValue)throw new Error;return e.attValue[e._cur]}peek(e,t){if(!e.attValue)throw new Error;for(let i=0;i<t.length;i++)if(t[i]!==e.attValue[e._cur+i])return!1;return!0}parseIceUfrag(e){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(e,E,[4,256])}parseIcePwd(e){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(e,E,[22,256])}parseIceOptions(e){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const t=[];for(;!this.atEnd(e);){t.push(this.extractOneOrMore(e,E));try{this.consumeAttributeSpace(e)}catch(t){if(this.atEnd(e))break;throw t}}this.attributes.iceOptions=t}parseFingerprint(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill);this.attributes.fingerprints.push({hashFunction:t,fingerprint:i})}parseExtmap(e){const t=this.extractOneOrMore(e,a);let i;"/"===this.peekChar(e)&&(this.extract(e,this.consume,"/"),i=this.extract(e,this.consumeToken)),this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeTill,o),s=g(g({entry:parseInt(t,10)},i&&{direction:i}),{},{extensionName:n});this.peekChar(e)===o&&(this.consumeAttributeSpace(e),s.extensionAttributes=this.extract(e,this.consumeTill)),this.attributes.extmaps.push(s)}parseSetup(e){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const t=this.extract(e,this.consumeTill);if("active"!==t&&"passive"!==t&&"actpass"!==t&&"holdconn"!==t)throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=t}}class v extends I{constructor(...e){super(...e),T(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"group":this.parseGroup(e);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"fingerprint":this.parseFingerprint(e);break;case"setup":this.parseSetup(e);break;case"tls-id":this.parseTlsId(e);break;case"identity":this.parseIdentity(e);break;case"extmap":this.parseExtmap(e);break;case"msid-semantic":this.parseMsidSemantic(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing session attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;)this.consumeAttributeSpace(e),i.push(this.extract(e,this.consumeToken));this.attributes.groups.push({semantic:t,identificationTag:i})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(e){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(e,m)}parseIdentity(e){const t=this.extractOneOrMore(e,f),i=[];for(;!this.atEnd(e)&&this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.extract(e,this.consume,"=");const n=this.extractOneOrMore(e,(e=>e!==o&&_(e)));i.push({name:t,value:n})}this.attributes.identities.push({assertionValue:t,extensions:i})}parseMsidSemantic(e){this.peekChar(e)===o&&this.consumeAttributeSpace(e);const t={semantic:this.extract(e,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(e)}catch(e){break}if("*"===this.peekChar(e)){this.extract(e,this.consume,"*"),t.applyForAll=!0;break}{const i=this.extract(e,this.consumeTill,o);t.identifierList.push(i)}}this.attributes.msidSemantic=t}}class y extends I{constructor(e){super(),T(this,"attributes",void 0),-1!==e.protos.indexOf("RTP")||e.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(e){if(this.digested)throw new Error("already digested");try{switch(e.attField){case"extmap":this.parseExtmap(e);break;case"setup":this.parseSetup(e);break;case"ice-ufrag":this.parseIceUfrag(e);break;case"ice-pwd":this.parseIcePwd(e);break;case"ice-options":this.parseIceOptions(e);break;case"candidate":this.parseCandidate(e);break;case"remote-candidate":this.parseRemoteCandidate(e);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(e);break;case"rtpmap":this.parseRtpmap(e);break;case"ptime":this.parsePtime(e);break;case"maxptime":this.parseMaxPtime(e);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(e);break;case"ssrc":this.parseSSRC(e);break;case"fmtp":this.parseFmtp(e);break;case"rtcp-fb":this.parseRtcpFb(e);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(e);break;case"mid":this.parseMid(e);break;case"msid":this.parseMsid(e);break;case"imageattr":this.parseImageAttr(e);break;case"rid":this.parseRid(e);break;case"simulcast":this.parseSimulcast(e);break;case"sctp-port":this.parseSctpPort(e);break;case"max-message-size":this.parseMaxMessageSize(e);break;case"ssrc-group":this.parseSSRCGroup(e);break;default:e.ignored=!0,this.attributes.unrecognized.push(e)}}catch(t){throw console.error("parsing media attribute ".concat(e.attField,' error, "a=').concat(e.attField,":").concat(e.attValue,'"')),t}if(!e.ignored&&e.attValue&&!this.atEnd(e))throw new Error("attribute parsing error")}parseCandidate(e){const t=this.extractOneOrMore(e,E,[1,32]);this.consumeAttributeSpace(e);const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const s=this.extractOneOrMore(e,a,[1,10]);this.consumeAttributeSpace(e);const r=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const d=this.extract(e,this.consumePort);this.consumeAttributeSpace(e),this.extract(e,this.consume,"typ"),this.consumeAttributeSpace(e);const l={foundation:t,componentId:i,transport:n,priority:s,connectionAddress:r,port:d,type:this.extract(e,this.consumeToken),extension:{}};for(this.peek(e," raddr")&&(this.extract(e,this.consume," raddr"),this.consumeAttributeSpace(e),l.relAddr=this.extract(e,this.consumeAddress)),this.peek(e," rport")&&(this.extract(e,this.consume," rport"),this.consumeAttributeSpace(e),l.relPort=this.extract(e,this.consumePort));this.peekChar(e)===o;){this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e),l.extension[t]=this.extractOneOrMore(e,c)}this.attributes.candidates.push(l)}parseRemoteCandidate(e){const t=[];for(;;){const i=this.extractOneOrMore(e,a,[1,5]);this.consumeAttributeSpace(e);const n=this.extract(e,this.consumeAddress);this.consumeAttributeSpace(e);const s=this.extract(e,this.consumePort);t.push({componentId:i,connectionAddress:n,port:s});try{this.consumeAttributeSpace(e)}catch(e){break}}this.attributes.remoteCandidatesList.push(t)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(e){const t=this.extract(e,this.consumeToken);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,"/");this.extract(e,this.consume,"/");const n={encodingName:i,clockRate:this.extractOneOrMore(e,a)};this.atEnd(e)||"/"!==this.peekChar(e)||(this.extract(e,this.consume,"/"),n.encodingParameters=parseInt(this.extract(e,this.consumeTill),10));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.rtpMap=n:this.attributes.payloads.push({payloadType:parseInt(t,10),rtpMap:n,rtcpFeedbacks:[]})}parsePtime(e){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(e,this.consumeTill)}parseMaxPtime(e){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(e,this.consumeTill)}parseDirection(e){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=e.attField}parseSSRC(e){const t=this.extractOneOrMore(e,a);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,":");let n;":"===this.peekChar(e)&&(this.extract(e,this.consume,":"),n=this.extract(e,this.consumeTill));const s=this.attributes.ssrcs.find((e=>e.ssrcId===parseInt(t,10)));s?s.attributes[i]=n:this.attributes.ssrcs.push({ssrcId:parseInt(t,10),attributes:{[i]:n}})}parseFmtp(e){const t=this.extract(e,this.consumeTill,o);this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill),n={};i.split(";").forEach((e=>{let[t,i]=e.split("=");t=t.trim();const s="string"==typeof i?i.trim():null;"string"==typeof t&&t.length>0&&(n[t]=s)}));const s=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));s?s.fmtp={parameters:n}:this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[],fmtp:{parameters:n}})}parseFmtParameters(e){const t={},i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");for(t[i]=n;";"===e.attValue[e._cur];){const i=this.extract(e,this.consumeTill,"=");e._cur++;const n=this.extract(e,this.consumeTill,";");t[i]=n}return t}parseRtcpFb(e){let t="";t="*"===this.peekChar(e)?this.extract(e,this.consume,"*"):this.extract(e,this.consumeTill,o),this.consumeAttributeSpace(e);const i=this.extract(e,this.consumeTill,o);let n;if("trr-int"===i)n={type:i,interval:this.extract(e,this.consumeTill)};else{const t={type:i};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.parameter=this.extract(e,this.consumeToken),this.peekChar(e)===o&&(t.additional=this.extract(e,this.consumeTill))),n=t}if("*"===t)this.attributes.rtcpFeedbackWildcards.push(n);else{const e=this.attributes.payloads.find((e=>e.payloadType===parseInt(t,10)));e?e.rtcpFeedbacks.push(n):this.attributes.payloads.push({payloadType:parseInt(t,10),rtcpFeedbacks:[n]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(e){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const t={port:this.extract(e,this.consumePort)};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.netType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.addressType=this.extractOneOrMore(e,l),this.consumeAttributeSpace(e),t.address=this.extract(e,this.consumeAddress)),this.attributes.rtcp=t}parseMsid(e){const t={id:this.extractOneOrMore(e,l,[1,64])};this.peekChar(e)===o&&(this.consumeAttributeSpace(e),t.appdata=this.extractOneOrMore(e,l,[1,64])),this.attributes.msids.push(t)}parseImageAttr(e){this.attributes.imageattr.push(e.attValue)}parseRid(e){const t=this.extractOneOrMore(e,(e=>u(e)||a(e)||"_"===e||"-"===e));this.consumeAttributeSpace(e);const i={id:t,direction:this.extract(e,this.consumeToken),params:[]};if(this.peekChar(e)===o){if(this.consumeAttributeSpace(e),this.peek(e,"pt=")){this.extract(e,this.consume,"pt=");const t=[];for(;;){const i=this.extract(e,this.consumeToken);t.push(i);try{this.extract(e,this.consume,",")}catch(e){break}}i.payloads=t,this.peekChar(e)===o&&this.extract(e,this.consume,o)}for(;;){const t=this.extract(e,this.consumeToken);switch(t){case"depend":{const n={type:t,rids:this.extract(e,this.consume,"=").split(",")};i.params.push(n);break}default:{const n={type:t};"="===this.peekChar(e)&&(this.extract(e,this.consume,"="),n.val=this.extract(e,this.consumeTill,";")),i.params.push(n)}}try{this.extract(e,this.consume,";")}catch(e){break}}}this.attributes.rids.push(i)}parseSimulcast(e){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=e.attValue,this.extract(e,this.consumeTill)}parseSctpPort(e){this.attributes.sctpPort=this.extractOneOrMore(e,a,[1,5])}parseMaxMessageSize(e){this.attributes.maxMessageSize=this.extractOneOrMore(e,a,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(e){this.attributes.mid=this.extract(e,this.consumeToken)}parseSSRCGroup(e){const t=this.extract(e,this.consumeToken),i=[];for(;;)try{this.consumeAttributeSpace(e);const t=this.extract(e,this.consumeInteger);i.push(parseInt(t,10))}catch(e){break}this.attributes.ssrcGroups.push({semantic:t,ssrcIds:i})}}function A(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class w{constructor(){A(this,"eol",s)}print(e,t){let i="";return t&&(this.eol=t),i+=this.printVersion(e.version),i+=this.printOrigin(e.origin),i+=this.printSessionName(e.sessionName),i+=this.printInformation(e.information),i+=this.printUri(e.uri),i+=this.printEmail(e.emails),i+=this.printPhone(e.phones),i+=this.printConnection(e.connection),i+=this.printBandwidth(e.bandwidths),i+=this.printTimeFields(e.timeFields),i+=this.printKey(e.key),i+=this.printSessionAttributes(e.attributes),i+=this.printMediaDescription(e.mediaDescriptions),i}printVersion(e){return"v=".concat(e).concat(this.eol)}printOrigin(e){return"o=".concat(e.username," ").concat(e.sessId," ").concat(e.sessVersion," ").concat(e.nettype," ").concat(e.addrtype," ").concat(e.unicastAddress).concat(this.eol)}printSessionName(e){return e?"s=".concat(e).concat(this.eol):""}printInformation(e){return e?"i=".concat(e).concat(this.eol):""}printUri(e){return e?"u=".concat(e).concat(this.eol):""}printEmail(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printPhone(e){let t="";for(const i of e)t+="e=".concat(i).concat(this.eol);return t}printConnection(e){return e?"c=".concat(e.nettype," ").concat(e.addrtype," ").concat(e.address).concat(this.eol):""}printBandwidth(e){let t="";for(const i of e)t+="b=".concat(i.bwtype,":").concat(i.bandwidth).concat(this.eol);return t}printTimeFields(e){let t="";for(const i of e){t+="t=".concat(i.time.startTime," ").concat(i.time.startTime).concat(this.eol);for(const e of i.repeats)t+="r=".concat(e.repeatInterval," ").concat(e.typedTimes.join(" ")).concat(this.eol);i.zoneAdjustments&&(t+="z=",t+="z=".concat(i.zoneAdjustments.map((e=>"".concat(e.time," ").concat(e.back?"-":""," ").concat(e.typedTime))).join(" ")).concat(this.eol),t+=this.eol)}return t}printKey(e){return e?"k=".concat(e).concat(this.eol):""}printAttributes(e){let t="";for(const i of e)t+="a=".concat(i.attField).concat(i.attValue?":".concat(i.attValue):"").concat(this.eol);return t}printMediaDescription(e){let t="";for(const i of e)t+=this.printMedia(i.media),t+=this.printInformation(i.information),t+=this.printConnections(i.connections),t+=this.printBandwidth(i.bandwidths),t+=this.printKey(i.key),t+=this.printMediaAttributes(i);return t}printConnections(e){let t="";for(const i of e)t+=this.printConnection(i);return t}printMedia(e){return"m=".concat(e.mediaType," ").concat(e.port," ").concat(e.protos.join("/")," ").concat(e.fmts.join(" ")).concat(this.eol)}printSessionAttributes(e){return new N(this.eol).print(e)}printMediaAttributes(e){return new b(this.eol).print(e)}}class O{constructor(e){A(this,"eol",void 0),this.eol=e}printIceUfrag(e){return void 0===e?"":"a=ice-ufrag:".concat(e).concat(this.eol)}printIcePwd(e){return void 0===e?"":"a=ice-pwd:".concat(e).concat(this.eol)}printIceOptions(e){return void 0===e?"":"a=ice-options:".concat(e.join(o)).concat(this.eol)}printFingerprints(e){return e.length>0?e.map((e=>"a=fingerprint:".concat(e.hashFunction).concat(o).concat(e.fingerprint))).join(this.eol)+this.eol:""}printExtmap(e){return e.map((e=>"a=extmap:".concat(e.entry).concat(e.direction?"/".concat(e.direction):"").concat(o).concat(e.extensionName).concat(e.extensionAttributes?"".concat(o).concat(e.extensionAttributes):"").concat(this.eol))).join("")}printSetup(e){return void 0===e?"":"a=setup:".concat(e).concat(this.eol)}printUnrecognized(e){return e.map((e=>"a=".concat(e.attField).concat(e.attValue?":".concat(e.attValue):"").concat(this.eol))).join("")}}class N extends O{print(e){let t="";return t+=this.printGroups(e.groups),t+=this.printMsidSemantic(e.msidSemantic),t+=this.printIceLite(e.iceLite),t+=this.printIceUfrag(e.iceUfrag),t+=this.printIcePwd(e.icePwd),t+=this.printIceOptions(e.iceOptions),t+=this.printFingerprints(e.fingerprints),t+=this.printSetup(e.setup),t+=this.printTlsId(e.tlsId),t+=this.printIdentity(e.identities),t+=this.printExtmap(e.extmaps),t+=this.printUnrecognized(e.unrecognized),t}printGroups(e){let t="";return e.length>0&&(t+=e.map((e=>"a=group:".concat(e.semantic).concat(e.identificationTag.map((e=>"".concat(o).concat(e))).join("")).concat(this.eol))).join("")),t}printIceLite(e){return void 0===e?"":"a=ice-lite"+this.eol}printTlsId(e){return e?"a=tls-id:".concat(e).concat(this.eol):""}printIdentity(e){return 0===e.length?"":e.map((e=>"a=identity:".concat(e.assertionValue).concat(e.extensions.map((e=>"".concat(o).concat(e.name).concat(e.value?"=".concat(e.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(e){if(!e)return"";let t="a=msid-semantic:".concat(e.semantic);return e.applyForAll?t+="".concat(o,"*"):e.identifierList.length>0&&(t+=e.identifierList.map((e=>"".concat(o).concat(e)))),t+this.eol}}class b extends O{print(e){const t=e.attributes;let i="";return i+=this.printRTCP(t.rtcp),i+=this.printIceUfrag(t.iceUfrag),i+=this.printIcePwd(t.icePwd),i+=this.printIceOptions(t.iceOptions),i+=this.printCandidates(t.candidates),i+=this.printRemoteCandidatesList(t.remoteCandidatesList),i+=this.printEndOfCandidates(t.endOfCandidates),i+=this.printFingerprints(t.fingerprints),i+=this.printSetup(t.setup),i+=this.printMid(t.mid),i+=this.printExtmap(t.extmaps),i+=this.printRTPRelated(t),i+=this.printPtime(t.ptime),i+=this.printMaxPtime(t.maxPtime),i+=this.printDirection(t.direction),i+=this.printSSRCGroups(t.ssrcGroups),i+=this.printSSRC(t.ssrcs),i+=this.printRTCPMux(t.rtcpMux),i+=this.printRTCPMuxOnly(t.rtcpMuxOnly),i+=this.printRTCPRsize(t.rtcpRsize),i+=this.printMSId(t.msids),i+=this.printImageattr(t.imageattr),i+=this.printRid(t.rids),i+=this.printSimulcast(t.simulcast),i+=this.printSCTPPort(t.sctpPort),i+=this.printMaxMessageSize(t.maxMessageSize),i+=this.printUnrecognized(t.unrecognized),i}printCandidates(e){return e.map((e=>"a=candidate:".concat(e.foundation).concat(o).concat(e.componentId).concat(o).concat(e.transport).concat(o).concat(e.priority).concat(o).concat(e.connectionAddress).concat(o).concat(e.port).concat(o,"typ").concat(o).concat(e.type).concat(e.relAddr?"".concat(o,"raddr").concat(o).concat(e.relAddr):"").concat(e.relPort?"".concat(o,"rport").concat(o).concat(e.relPort):"").concat(Object.keys(e.extension).map((t=>"".concat(o).concat(t).concat(o).concat(e.extension[t]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(e){return e.map((e=>"a=remote-candidates:".concat(e.join(o)).concat(this.eol))).join("")}printEndOfCandidates(e){return void 0===e?"":"a=end-of-candidates"+this.eol}printRTPRelated(e){if(!e.payloads)return"";const t=e.payloads;let i="";i+=e.rtcpFeedbackWildcards.map((e=>this.printRTCPFeedback("*",e))).join("");for(const e of t)i+=this.printRtpMap(e.payloadType,e.rtpMap),i+=this.printFmtp(e.payloadType,e.fmtp),i+=e.rtcpFeedbacks.map((t=>this.printRTCPFeedback(e.payloadType,t))).join("");return i}printFmtp(e,t){if(!t)return"";const i=Object.keys(t.parameters);return 1===i.length&&null===t.parameters[i[0]]?"a=fmtp:".concat(e).concat(o).concat(i[0]).concat(this.eol):"a=fmtp:".concat(e).concat(o).concat(Object.keys(t.parameters).map((e=>"".concat(e,"=").concat(t.parameters[e]))).join(";")).concat(this.eol)}printRtpMap(e,t){return t?"a=rtpmap:".concat(e).concat(o).concat(t.encodingName,"/").concat(t.clockRate).concat(t.encodingParameters?"/".concat(t.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(e,t){let i="a=rtcp-fb:".concat(e).concat(o),n=t;return"trr-int"===n.type?i+="ttr-int".concat(o).concat(n.interval):(i+="".concat(n.type),n.parameter&&(i+="".concat(o).concat(n.parameter),n.additional&&(i+="".concat(o).concat(n.additional)))),i+this.eol}printPtime(e){return void 0===e?"":"a=ptime:".concat(e).concat(this.eol)}printMaxPtime(e){return void 0===e?"":"a=maxptime:".concat(e).concat(this.eol)}printDirection(e){return void 0===e?"":"a=".concat(e).concat(this.eol)}printSSRC(e){return e.map((e=>Object.keys(e.attributes).map((t=>"a=ssrc:".concat(e.ssrcId.toString(10)).concat(o).concat(t).concat(e.attributes[t]?":".concat(e.attributes[t]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(e){return void 0===e?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(e){return void 0===e?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(e){return void 0===e?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(e){if(void 0===e)return"";let t="a=rtcp:".concat(e.port);return e.netType&&(t+="".concat(o).concat(e.netType)),e.addressType&&(t+="".concat(o).concat(e.addressType)),e.address&&(t+="".concat(o).concat(e.address)),t+this.eol}printMSId(e){return e.map((e=>"a=msid:".concat(e.id).concat(e.appdata?"".concat(o).concat(e.appdata):"").concat(this.eol))).join("")}printImageattr(e){return e.map((e=>"a=imageattr:".concat(e).concat(this.eol))).join("")}printRid(e){return e.map((e=>{let t="a=rid:".concat(e.id).concat(o).concat(e.direction);return e.payloads&&(t+="".concat(o,"pt=").concat(e.payloads.join(","))),e.params.length>0&&(t+="".concat(o).concat(e.params.map((e=>"depend"===e.type?"depend=".concat(e.rids.join(",")):"".concat(e.type,"=").concat(e.val))).join(";"))),t+this.eol})).join("")}printSimulcast(e){return void 0===e?"":"a=simulcast:".concat(e).concat(this.eol)}printSCTPPort(e){return void 0===e?"":"a=sctp-port:".concat(e).concat(this.eol)}printMaxMessageSize(e){return void 0===e?"":"a=max-message-size:".concat(e).concat(this.eol)}printMid(e){return void 0===e?"":"a=mid:".concat(e).concat(this.eol)}printSSRCGroups(e){return e.map((e=>"a=ssrc-group:".concat(e.semantic).concat(e.ssrcIds.map((e=>"".concat(o).concat(e.toString(10)))).join("")).concat(this.eol))).join("")}}function D(e){return(new R).parse(e)}function P(e,t){return(new w).print(e,t)}}},t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={exports:{}};return e[n](s,s.exports,i),s.exports}return i.d=(e,t)=>{for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i(8)})();var II=RI.exports;function vI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function yI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?vI(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):vI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function AI(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0;const{filterRTX:s,filterVideoFec:o,filterAudioFec:r,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:d}=i;let l=[],h=[],u=[],p=[],_=!1,E=!1;if(II.parse(e).mediaDescriptions.forEach((e=>{n&&n!==e.attributes.direction||("video"!==e.media.mediaType||_||(h=e.attributes.payloads,p=e.attributes.extmaps,_=!0),"audio"!==e.media.mediaType||E||(l=e.attributes.payloads,u=e.attributes.extmaps,E=!0))})),!p||0===h.length)throw new Error("Cannot get video capabilities from SDP.");if(!u||0===l.length)throw new Error("Cannot get audio capabilities from SDP.");return h.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),l.forEach((e=>{var t;null!==(t=e.rtpMap)&&void 0!==t&&t.clockRate&&(e.rtpMap.clockRate=parseInt(e.rtpMap.clockRate)),d&&e.rtcpFeedbacks.push({type:"rrtr"})})),s&&(l=l.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})),h=h.filter((e=>{var t;return"rtx"!==(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())}))),o&&(h=h.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),r&&(l=l.filter((e=>{var t;return!/(red)|(ulpfec)|(flexfec)/i.test((null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName)||"")}))),a&&(null==a?void 0:a.length)>0&&(l=l.filter((e=>{var t;return jo(a).call(a,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),c&&(null==c?void 0:c.length)>0&&(h=h.filter((e=>{var t;return jo(c).call(c,(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())||"")}))),{audioCodecs:l,videoCodecs:h,audioExtensions:u,videoExtensions:p}}function wI(e){const t=II.parse(e);let i,n;for(const e of t.mediaDescriptions){if(!i){const t=e.attributes.iceUfrag,n=e.attributes.icePwd;if(!t||!n)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:t,icePwd:n}}if(!n){const t=e.attributes.fingerprints;t.length>0&&(n={fingerprints:t})}}if(!n&&t.attributes.fingerprints.length>0&&(n={fingerprints:t.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function OI(e,t){const i=[],n=e.attributes.ssrcGroups.filter((e=>"FID"===e.semantic)),s=e.attributes.ssrcGroups.find((e=>"SIM"===e.semantic)),o=e.attributes.ssrcs;if(s)s.ssrcIds.forEach((e=>{var s;const o=null===(s=n.find((t=>t.ssrcIds[0]===e)))||void 0===s?void 0:s.ssrcIds[1];i.push({ssrcId:e,rtx:t?o:void 0})}));else if(n.length>0){const e=n[0].ssrcIds[0],s=n[0].ssrcIds[1];i.push({ssrcId:e,rtx:t?s:void 0})}else{if(0===o.length)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function NI(e,i){const{cname:n}=e;let s;i&&i.ip&&"number"==typeof i.port?(s=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip,port:i.port.toString(),type:"host",extension:{}}],t.debug("Using remote candidate from AP ".concat(i.ip,":").concat(i.port)),i.ip6&&(s.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip6,port:i.port.toString(),type:"host",extension:{}}),t.debug("Using IPV6 remote candidate from AP ".concat(i.ip6,":").concat(i.port)))):s=e.iceParameters.candidates.map((e=>({foundation:e.foundation,componentId:"1",transport:e.protocol,priority:e.priority.toString(),connectionAddress:e.ip,port:e.port.toString(),type:e.type,extension:{}})));const o={fingerprints:e.dtlsParameters.fingerprints.map((e=>({hashFunction:e.algorithm,fingerprint:e.fingerprint})))},r={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let a;switch(e.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}return{dtlsParameters:o,iceParameters:r,candidates:s,rtpCapabilities:FI(e.rtpCapabilities),setup:a,cname:n}}function bI(e,t,i){const n=[],s=[];return e.forEach((e=>{let{ssrcId:o,rtx:r}=e;const a=M(8,"track-"),c={ssrcId:o,attributes:yI({label:a,mslabel:i=i||M(10,""),msid:"".concat(i," ").concat(a)},t&&{cname:t})};if(n.push(c),void 0!==r){const e={ssrcId:r,attributes:yI({label:a,mslabel:i,msid:"".concat(i," ").concat(a)},t&&{cname:t})};n.push(e),s.push({semantic:"FID",ssrcIds:[o,r]})}})),e.length>1&&s.push({semantic:"SIM",ssrcIds:e.map((e=>{let{ssrcId:t}=e;return t}))}),{ssrcs:n,ssrcGroups:s}}function DI(e,t){t instanceof Ge&&e.attributes.payloads.forEach((e=>{var i;const n=null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase();if(!n||-1===["opus","pcmu","pcma","g722"].indexOf(n))return;e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.minptime="10",e.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&"pcmu"!==n&&"pcma"!==n&&"g722"!==n&&(s.bitrate&&!I()&&(e.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(e.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),e.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"))}))}function PI(e){const t=e.attributes.unrecognized.findIndex((e=>"x-google-flag"===e.attField&&"conference"===e.attValue));-1!==t&&e.attributes.unrecognized.splice(t,1)}function LI(e,t){var i;if(!(t instanceof We&&t._encoderConfig&&-1===t._hints.indexOf(He.SCREEN_TRACK)))return;const n=t._encoderConfig;Ke().supportMinBitrate&&n.bitrateMin&&e.attributes.payloads.forEach((e=>{var t,i;jo(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))})),Ke().supportMinBitrate&&!jo(i=t._hints).call(i,He.LOW_STREAM)&&n.bitrateMax&&e.attributes.payloads.forEach((e=>{var t,i;jo(t=["h264","h265","vp8","vp9","av1"]).call(t,(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"")&&(e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters["x-google-start-bitrate"]="".concat(T("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))}))}function kI(e){if("video"!==e.media.mediaType)return;const t=Q();if(t.name!==ie.SAFARI&&t.os!==ne.IOS)return;const i=e.attributes.extmaps.findIndex((e=>/video-orientation/g.test(e.extensionName)));-1!==i&&e.attributes.extmaps.splice(i,1)}function MI(e,t,i){if(!t)return;let n,s;if("video"===e.media.mediaType?(n=i.videoExtensions,s=i.videoCodecs):(n=i.audioExtensions,s=i.audioCodecs),!0===t.twcc){const t=n.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"transport-cc"===e.type))||e.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(!1===t.twcc){const t=e.attributes.extmaps.findIndex((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}if(!0===t.remb){const t=n.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));if(t){e.attributes.extmaps.find((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName))||e.attributes.extmaps.push({entry:t.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"});const i=function(e,t){return t.filter((t=>!!e.find((e=>e.payloadType===t.payloadType&&!!e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))))))}(s,e.attributes.payloads);i.forEach((e=>{e.rtcpFeedbacks.find((e=>"goog-remb"===e.type))||e.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(!1===t.remb){const t=e.attributes.extmaps.findIndex((e=>"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"===e.extensionName));-1!==t&&e.attributes.extmaps.splice(t,1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"goog-remb"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}}function UI(e,t,i){if(I())return;if("video"!==e.media.mediaType)return;if(!(t instanceof We))return;if("vp9"!==i&&"vp8"!==i)return;if("vp8"===i&&!T("SIMULCAST"))return;if(void 0===t._scalabilityMode||t._scalabilityMode.numSpatialLayers<=1)return;const n="vp8"===i?2:t._scalabilityMode.numSpatialLayers,s=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find((e=>"FID"===e.semantic&&e.ssrcIds[0]===s.ssrcId)),r={semantic:"SIM",ssrcIds:[s.ssrcId]};for(let t=1;t<n;t++)e.attributes.ssrcs.push({ssrcId:s.ssrcId+t,attributes:te(s.attributes)}),r.ssrcIds.push(s.ssrcId+t),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+t,attributes:te(s.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[s.ssrcId+t,o.ssrcIds[1]+t]}));e.attributes.ssrcGroups.unshift(r)}async function VI(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{filterRTX:n,filterVideoFec:s,filterAudioFec:o,filterAudioCodec:r,filterVideoCodec:a}=e,{useXR:c}=i,d=new RTCPeerConnection;d.addTransceiver("video",{direction:"sendonly"}),d.addTransceiver("audio",{direction:"sendonly"}),d.addTransceiver("video",{direction:"recvonly"}),d.addTransceiver("audio",{direction:"recvonly"});const l=(await d.createOffer()).sdp,h=AI(l,{filterRTX:n,filterVideoFec:s,filterAudioFec:o,filterAudioCodec:r,filterVideoCodec:a},{useXR:c},"sendonly"),u=AI(l,{filterRTX:n,filterVideoFec:s,filterAudioFec:o,filterAudioCodec:r,filterVideoCodec:a},{useXR:c},"recvonly"),p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},E={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(xI(h,u,"videoExtensions",p,_,E),xI(h,u,"videoCodecs",p,_,E),xI(h,u,"audioExtensions",p,_,E),xI(h,u,"audioCodecs",p,_,E),T("RAISE_H264_BASELINE_PRIORITY")){const e=E.videoCodecs.findIndex((e=>{var t,i;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"===(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"])}));if(-1!==e){const i=E.videoCodecs.findIndex((e=>{var t;return"h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())}));if(i<e){t.debug("raising H264 baseline profile priority");const n=E.videoCodecs[e];E.videoCodecs.splice(e,1),E.videoCodecs.splice(i,0,n)}-1!==i&&(_.videoCodecs=_.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))}))),-1!==i&&T("FILTER_SEND_H264_BASELINE")&&(p.videoCodecs=p.videoCodecs.filter((e=>{var t,i;return!("h264"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLocaleLowerCase())&&"42001f"!==(null===(i=e.fmtp)||void 0===i?void 0:i.parameters["profile-level-id"]))})))}}try{d.close()}catch(e){}return{send:p,recv:_,sendrecv:E}}function xI(e,t,i,n,s,o){if("videoExtensions"===i||"audioExtensions"===i){const r=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.entry===t.entry&&e.extensionName===t.extensionName)return r.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===r.indexOf(t)&&s[i].push(e)}))}if("videoCodecs"===i||"audioCodecs"===i){const r=[];return e[i].forEach((e=>{t[i].some(((t,i)=>{if(e.payloadType===t.payloadType&&JSON.stringify(e)===JSON.stringify(t))return r.push(i),!0}))?o[i].push(e):n[i].push(e)})),void t[i].forEach(((e,t)=>{-1===r.indexOf(t)&&s[i].push(e)}))}}function FI(e){const{send:t,recv:i,sendrecv:n}=e;if(!n){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let s,o;return t?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...t.audioCodecs,...n.audioCodecs],s.videoCodecs=[...t.videoCodecs,...n.videoCodecs],s.audioExtensions=[...t.audioExtensions,...n.audioExtensions],s.videoExtensions=[...t.videoExtensions,...n.videoExtensions]):s=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:s,recv:o}}function jI(e){if("audio"!==e.media.mediaType)return;e.attributes.payloads.filter((e=>{var t;return"opus"===(null===(t=e.rtpMap)||void 0===t?void 0:t.encodingName.toLowerCase())})).forEach((e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"}))}function BI(e){e.mediaDescriptions.forEach((e=>{"video"!==e.media.mediaType&&"audio"!==e.media.mediaType||e.attributes.payloads.forEach((e=>{-1===e.rtcpFeedbacks.findIndex((e=>"rrtr"===e.type))&&e.rtcpFeedbacks.push({type:"rrtr"})}))}))}function GI(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function WI(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?GI(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):GI(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function HI(e){if(Array.isArray(e))return e.map((e=>e));if(!KI(e))return e;const t={};for(const i in e){const n=e[i];KI(n)||Array.isArray(n)?t[i]=HI(n):t[i]=n}return t}function KI(e){return!("object"!=typeof e||Array.isArray(e)||!e)}class qI{constructor(e){this.input=[],this.size=void 0,this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return 0===this.input.length?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const YI={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},JI={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:YI,remoteCandidate:YI}},XI={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0},zI={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},QI={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},ZI={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function $I(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ev(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?$I(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):$I(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class tv{constructor(e,t){this.onFirstVideoReceived=void 0,this.onFirstVideoDecoded=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onFirstAudioDecoded=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.videoIsReady=!1,this.videoIsReady2={},this.pc=void 0,this.options=void 0,this.intervalTimer=void 0,this.stats=HI(JI),this.isFirstVideoReceived={},this.isFirstVideoDecoded={},this.isFirstAudioReceived={},this.isFirstAudioDecoded={},this.isFirstVideoDecodedTimeout={},this.lossRateWindowStats=[],this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new eg((e=>{e({local:ev({},YI),remote:ev({},YI)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let n=0,s=0,o=0,r=0;for(const a of i)e[a].forEach(((e,i)=>{if(!this.lossRateWindowStats[t-1][a][i]||!this.lossRateWindowStats[0][a][i])return;const c=this.lossRateWindowStats[t-1][a][i].packets-this.lossRateWindowStats[0][a][i].packets,d=this.lossRateWindowStats[t-1][a][i].packetsLost-this.lossRateWindowStats[0][a][i].packetsLost;"videoSend"===a||"audioSend"===a?(n+=c,o+=d):(s+=c,r+=d),Number.isNaN(c)||Number.isNaN(c)?e.packetLostRate=0:e.packetLostRate=c<=0||d<=0?0:d/(c+d)}));e.sendPacketLossRate=n<=0||o<=0?0:o/(n+o),e.recvPacketLossRate=s<=0||r<=0?0:r/(s+r)}}function iv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function nv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?iv(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):iv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class sv extends tv{constructor(){super(...arguments),this._stats=JI,this.lastDecodeVideoReceiverStats=new Map}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=HI(JI);const i=t.filter((e=>"ssrc"===e.type));this.processSSRCStats(i);const n=t.find((e=>"VideoBwe"===e.type));n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((e=>{var t;const i=jo(t=e.id).call(t,"send");switch("".concat(e.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const t=HI(zI);t.codec=e.googCodecName,t.adaptionChangeReason="none",e.googCpuLimitedResolution&&(t.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(t.adaptionChangeReason="bandwidth"),t.avgEncodeMs=Number(e.googAvgEncodeMs),t.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},t.firsCount=Number(e.googFirReceived),t.nacksCount=Number(e.googNacksReceived),t.plisCount=Number(e.googPlisReceived),t.frameCount=Number(e.framesEncoded),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(t),this._stats.rtt=t.rttMs;break}case"video_recv":{const t=HI(XI),i=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(t.codec=e.googCodecName,t.targetDelayMs=Number(e.googTargetDelayMs),t.renderDelayMs=Number(e.googRenderDelayMs),t.currentDelayMs=Number(e.googCurrentDelayMs),t.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),t.decodeMs=Number(e.googDecodeMs),t.maxDecodeMs=Number(e.googMaxDecodeMs),t.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},t.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},t.decodeFrameRate=Number(e.googFrameRateDecoded),t.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},t.jitterBufferMs=Number(e.googJitterBufferMs),t.firsCount=Number(e.googFirsSent),t.nacksCount=Number(e.googNacksSent),t.plisCount=Number(e.googPlisSent),t.framesDecodeCount=Number(e.framesDecoded),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,t.decodedFrame.width,t.decodedFrame.height),this.isFirstVideoDecoded[t.ssrc]=!0),i){const n=i.stats,s=Date.now()-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=s,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<i.stats.framesDecodeCount&&(t.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:nv({},t),lts:Date.now()}),this._stats.videoRecv.push(t);break}case"audio_recv":{const t=HI(ZI);t.codec=e.googCodecName,t.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,t.decodingCNG=Number(e.googDecodingCNG),t.decodingCTN=Number(e.googDecodingCTN),t.decodingCTSG=Number(e.googDecodingCTSG),t.decodingNormal=Number(e.googDecodingNormal),t.decodingPLC=Number(e.googDecodingPLC),t.decodingPLCCNG=Number(e.googDecodingPLCCNG),t.expandRate=Number(e.googExpandRate),t.accelerateRate=Number(e.googAccelerateRate),t.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),t.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),t.speechExpandRate=Number(e.googSpeechExpandRate),t.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),t.jitterBufferMs=Number(e.googJitterBufferMs),t.jitterMs=Number(e.googJitterReceived),t.bytes=Number(e.bytesReceived),t.packets=Number(e.packetsReceived),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),t.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.decodingNormal>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),this._stats.audioRecv.push(t);break}case"audio_send":{const t=HI(QI);t.codec=e.googCodecName,t.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,t.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),t.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),t.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),t.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),t.bytes=Number(e.bytesSent),t.packets=Number(e.packetsSent),t.packetsLost=Number(e.packetsLost),t.ssrc=Number(e.ssrc),t.rttMs=Number(e.googRtt||0),this._stats.rtt=t.rttMs,this._stats.audioSend.push(t);break}}}))}_getStats(){return new eg(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp.valueOf().toString(),type:e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t.push(i)})),t}}function ov(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function rv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ov(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ov(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class av extends tv{constructor(){super(...arguments),this._stats=JI,this.report=void 0,this.lastDecodeVideoReceiverStats=new Map,this.lastVideoFramesRecv=new Map,this.lastVideoFramesSent=new Map,this.lastVideoFramesDecode=new Map,this.lastVideoJBDelay=new Map,this.lastAudioJBDelay=new Map,this.mediaBytesSent=new Map,this.mediaBytesRetransmit=new Map,this.mediaBytesTargetEncode=new Map,this.lastEncoderMs=new Map}async updateStats(){this.report=await this.pc.getStats(),this._stats=HI(JI),this.report.forEach((e=>{switch(e.type){case VS.OUTBOUND:case VS.INBOUND:{const t=e.mediaType||e.kind,i=!t&&"frameWidth"in e,n=!t&&!("frameWidth"in e);e.type===VS.OUTBOUND?"audio"===t||n?this.processAudioOutboundStats(e):("video"===t||i)&&this.processVideoOutboundStats(e):e.type===VS.INBOUND&&("audio"===t||n?this.processAudioInboundStats(e):("video"===t||i)&&this.processVideoInboundStats(e));break}case VS.TRANSPORT:{const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case VS.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:rv({},YI),remote:rv({},YI)};return e.forEach((i=>{let n;if(i.type===VS.TRANSPORT&&(n=e.get(i.selectedCandidatePairId)),i.type===VS.CANDIDATE_PAIR&&i.selected&&(n=i),n){const i=(e,t)=>{e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol)};if(n.localCandidateId){const s=e.get(n.localCandidateId);s&&i(t.local,s)}if(n.remoteCandidateId){const s=e.get(n.remoteCandidateId);s&&i(t.remote,s)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===VS.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===VS.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===VS.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(rv({},t),rv({},this.stats.selectedCandidatePair.localCandidate)),e.type===VS.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(rv({},t),rv({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((t=>t.ssrc===e.ssrc));t||(t=HI(ZI),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,this.processAudioTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),"number"==typeof e.concealedSamples&&(t.concealedSamples=e.concealedSamples)}processVideoInboundStats(e){let t=this._stats.videoRecv.find((t=>t.ssrc===e.ssrc));t||(t=HI(XI),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay;const i=this.lastDecodeVideoReceiverStats.get(t.ssrc),n=this.lastVideoFramesDecode.get(t.ssrc),s=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const e=t.decodedFrame?t.decodedFrame.width:0,i=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,e,i),this.isFirstVideoDecoded[t.ssrc]=!0}if(i){const n=i.stats,o=s-i.lts;t.framesDecodeFreezeTime=n.framesDecodeFreezeTime,t.framesDecodeInterval=n.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&o>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>n.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(i.lts=Date.now(),t.framesDecodeInterval=o,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<n.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(i.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-i.qpSum)/(e.framesDecoded-i.stats.framesDecodeCount))}n&&s-n.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-n.count)/((s-n.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:t.decodeFrameRate})):n?t.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:0}),e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:rv({},t),lts:i?i.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((t=>t.ssrc===e.ssrc));t||(t=HI(zI),this._stats.videoSend.push(t));const i=this.mediaBytesSent.get(e.ssrc);if(i)i.add(e.bytesSent);else{const t=new qI(10);t.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,t)}if(void 0!==e.retransmittedBytesSent){const t=this.mediaBytesRetransmit.get(e.ssrc);if(t)t.add(e.retransmittedBytesSent);else{const t=new qI(10);t.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,t)}}if(e.totalEncodedBytesTarget){const t=this.mediaBytesTargetEncode.get(e.ssrc);if(t)t.add(e.totalEncodedBytesTarget);else{const t=new qI(10);t.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,t)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const n=e.framesEncoded-i.lastFrameCount,s=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*s/n}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,VS.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((t=>t.ssrc===e.ssrc));if(t||(t=HI(QI),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,VS.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}findRemoteStatsId(e,t){var i;const n=Array.from(cg(i=this.report).call(i)).find((i=>i.type===t&&i.ssrc===e));return n?n.id:null}processVideoMediaSource(e,t){const i=this.report.get(e);i&&i.width&&i.height&&i.framesPerSecond&&(t.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(e,t){const i=this.report.get(e);i&&(t.inputLevel=i.audioLevel)}processVideoTrackSenderStats(e,t,i){var n,s,o,r;const a=t?this.report.get(t):void 0,c=null!==(n=null==a?void 0:a.framesSent)&&void 0!==n?n:e.framesSent;if("number"!=typeof c)return;let d=null!==(s=null==a?void 0:a.frameWidth)&&void 0!==s?s:e.frameWidth,l=null!==(o=null==a?void 0:a.frameHeight)&&void 0!==o?o:e.frameHeight,h=null!==(r=null==a?void 0:a.framesPerSecond)&&void 0!==r?r:e.framesPerSecond;if("number"==typeof d&&"number"==typeof l||(d=0,l=0),null==h){const e=Date.now(),t=this.lastVideoFramesSent.get(i.ssrc);t&&e-t.lts>=800?(h=Math.round((c-t.count)/((e-t.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:h})):t?h=t.rate:this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:e,rate:0})}i.sentFrame={width:d,height:l,frameRate:Math.max(0,h)}}processVideoTrackReceiverStats(e,t,i){var n,s,o,r,a;const c=t?this.report.get(t):void 0,d=null!==(n=null==c?void 0:c.framesReceived)&&void 0!==n?n:e.framesReceived,l=null!==(s=null==c?void 0:c.frameWidth)&&void 0!==s?s:e.frameWidth,h=null!==(o=null==c?void 0:c.frameHeight)&&void 0!==o?o:e.frameHeight,u=null!==(r=null==c?void 0:c.jitterBufferDelay)&&void 0!==r?r:e.jitterBufferDelay,p=null!==(a=null==c?void 0:c.jitterBufferEmittedCount)&&void 0!==a?a:e.jitterBufferEmittedCount;if("number"==typeof d){const e=this.lastVideoFramesRecv.get(i.ssrc),t=Date.now();i.framesReceivedCount=d;let n=0;e&&t-e.lts>=800?(n=Math.round((d-e.count)/((t-e.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:n})):e?n=e.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:t,rate:0}),i.receivedFrame={width:l||0,height:h||0,frameRate:n||0},i.decodedFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:h||0,frameRate:i.decodeFrameRate||0}}if(u&&p){const e=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=p-e.jitterBufferEmittedCount;n>0&&(t=1e3*(u-e.jitterBufferDelay)/n),i.jitterBufferMs=t,i.currentDelayMs=Math.round(t),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:u,jitterBufferEmittedCount:p,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(e,t,i){var n,s,o,r;const a=t?this.report.get(t):void 0,c=null!==(n=null!==(s=null==a?void 0:a.echoReturnLoss)&&void 0!==s?s:e.echoReturnLoss)&&void 0!==n?n:0,d=null!==(o=null!==(r=null==a?void 0:a.echoReturnLossEnhancement)&&void 0!==r?r:e.echoReturnLossEnhancement)&&void 0!==o?o:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,i){var n,s,o,r,a,c,d;const l=t?this.report.get(t):void 0,h=null!==(n=null==l?void 0:l.removedSamplesForAcceleration)&&void 0!==n?n:e.removedSamplesForAcceleration,u=null!==(s=null==l?void 0:l.totalSamplesReceived)&&void 0!==s?s:e.totalSamplesReceived,p=null!==(o=null==l?void 0:l.jitterBufferDelay)&&void 0!==o?o:e.jitterBufferDelay,_=null!==(r=null==l?void 0:l.jitterBufferEmittedCount)&&void 0!==r?r:e.jitterBufferEmittedCount,E=null!==(a=null==l?void 0:l.audioLevel)&&void 0!==a?a:null==e?void 0:e.audioLevel,m=null!==(c=null==l?void 0:l.totalSamplesDuration)&&void 0!==c?c:null==e?void 0:e.totalSamplesDuration,f=null!==(d=null==l?void 0:l.concealedSamples)&&void 0!==d?d:e.concealedSamples;if(h&&u&&(i.accelerateRate=h/u),p&&_){const e=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let t=e.jitterBufferMs;const n=_-e.jitterBufferEmittedCount;n>0&&(t=1e3*(p-e.jitterBufferDelay)/n),i.jitterBufferMs=Math.round(t),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:_,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=E;let S=1920;m&&u&&(S=u/m/50,i.receivedFrames=Math.round(u/S)),f&&(i.droppedFrames=Math.round(f/S))}processRemoteInboundStats(e,t){const i=this.report.get(e);i&&(t.packetsLost=i.packetsLost,i.roundTripTime&&(t.rttMs=1e3*i.roundTripTime),i.jitter&&(t.jitterMs=1e3*i.jitter),i.timestamp&&(t.timestamp=i.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const i=t.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let e=0,t=null,i=null;this.mediaBytesSent.forEach((t=>{e+=t.diffMean()})),this.mediaBytesRetransmit.forEach((e=>{t=null===t?e.diffMean():t+e.diffMean()})),this.mediaBytesTargetEncode.forEach((e=>{i=null===i?e.diffMean():i+e.diffMean()}));const n=null!==t?e-t:e;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},null!==t&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),null!==i&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class cv extends tv{updateStats(){return eg.resolve()}}function dv(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:250,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:500,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1e4;const o=function(){const e=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return e&&e[0]?Number(e[0].split("/")[1]):null}();return o?o<76?new sv(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new av(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):function(e){return!!window.RTCStatsReport&&e.getStats()instanceof eg}(e)?new av(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s}):new cv(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:s})}function lv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function hv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?lv(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):lv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class uv extends rT{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}constructor(e,t){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.statsFilter=void 0,this.useRTX=!1,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.establishPromise=void 0,this.mutex=new v("P2PConnection-mutex"),this.store=t,this.peerConnection=new RTCPeerConnection(uv.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=dv(this.peerConnection,T("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const e=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=wI(e.sdp),i=AI(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:T("FILTER_VIDEO_FEC"),filterAudioFec:T("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=e,hv(hv({},t),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:e.sdp})}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(e){this.sessionDesc=void 0,this.localCapabilities=void 0,this.rtpCapabilities=void 0,this.candidates=void 0,this.iceParameters=void 0,this.dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,e=te(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,sdkCodec:a,cname:c}=e,d=II.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE audio video\na=msid-semantic: WMS\na=ice-lite\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:audio\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendrecv\na=rtcp-mux\na=rtcp-rsize\na=mid:video\n");this.rtpCapabilities=s,this.candidates=n,this.iceParameters=t,this.dtlsParameters=i,this.setup=o,this.localCapabilities=r,this.cname=c;for(let e=0;e<d.mediaDescriptions.length;e++){const r=d.mediaDescriptions[e];r.attributes.iceUfrag=t.iceUfrag,r.attributes.icePwd=t.icePwd,r.attributes.fingerprints=i.fingerprints,r.attributes.candidates=n,r.attributes.setup=o,"video"===r.media.mediaType&&(r.media.fmts=s.videoCodecs.map((e=>e.payloadType.toString(10))),r.attributes.payloads=s.videoCodecs,r.attributes.extmaps=s.videoExtensions),"audio"===r.media.mediaType&&(r.media.fmts=s.audioCodecs.map((e=>e.payloadType.toString(10))),r.attributes.payloads=s.audioCodecs,r.attributes.extmaps=s.audioExtensions),d.mediaDescriptions[e]=this.mungMediaDesc(r)}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}toString(){return II.print(this.sessionDesc)}send(e,t,i){const{ssrcs:n,ssrcGroups:s}=bI(t,this.cname),o=this.sessionDesc.mediaDescriptions.find((t=>e===Fg.VIDEO?"video"===t.media.mediaType:"audio"===t.media.mediaType)),r=n[0].attributes.label,a=n[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(n),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:r,mslabel:a}}batchSend(e){return e.map((e=>{let{kind:t,ssrcMsg:i}=e;return this.send(t,i,void 0)}))}stopSending(e){this.sessionDesc.mediaDescriptions.forEach((t=>{const i=[],n=[],s=[];t.attributes.ssrcs.forEach((t=>{jo(e).call(e,t.attributes.label||"")?s.push(t):i.push(t)})),t.attributes.ssrcGroups.forEach((e=>{var t;jo(t=s.map((e=>e.ssrcId))).call(t,e.ssrcIds[0])||n.push(e)})),t.attributes.ssrcs=i,t.attributes.ssrcGroups=n}))}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}receive(e,t,i){e.forEach(((e,t)=>{const i=e._mediaStreamTrack,n=this.sessionDesc.mediaDescriptions.findIndex((e=>e.attributes.mid===i.kind)),s=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],e);this.sessionDesc.mediaDescriptions[n]=s}))}stopReceiving(e){}updateCandidates(e){e===jg.TCP?this.candidates.forEach((e=>{-1===this.candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this.candidates.push(WI(WI({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this.candidates=this.candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=te(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}mungRecvMediaDsec(e,t){const i=te(e);return DI(i,t),LI(i,t),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,t,i){const n=this.sessionDesc.mediaDescriptions.find((t=>e===Fg.VIDEO?"video"===t.attributes.mid:"audio"===t.attributes.mid));if(n){const e=n.attributes.ssrcs.find((e=>e.attributes.label===t));var s;e&&(e.attributes.label=i,null===(s=e.attributes.msid)||void 0===s||s.replace(t,i))}}mungMediaDesc(e){const t=te(e);return PI(t),function(e){const t=e.attributes.extmaps.find((e=>"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"===e.extensionName));t&&e.attributes.extmaps.splice(e.attributes.extmaps.indexOf(t),1),e.attributes.payloads.forEach((e=>{const t=e.rtcpFeedbacks.findIndex((e=>"transport-cc"===e.type));-1!==t&&e.rtcpFeedbacks.splice(t,1)}))}(t),t}getSSRC(e){for(const t of this.sessionDesc.mediaDescriptions)for(const i of t.attributes.ssrcs)if(i.attributes.label===e)return[i]}}({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n.send,remoteSetup:s,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:o});const r=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t){var i=this;return lI((function*(){const n=yield hI(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const n=e.map((e=>i.peerConnection.addTrack(e._mediaStreamTrack))),s=yield hI(i.peerConnection.createOffer()),o=II.parse(s.sdp),r=e.map((e=>{const t=e._mediaStreamTrack,n=o.mediaDescriptions.find((e=>e.attributes.mid===t.kind));if(!n)throw new Error("Cannot extract ssrc from mediaDescription.");return function(e,t,i){const n=e.attributes.ssrcs.filter((e=>e.attributes.label===t)),s=e.attributes.ssrcGroups;if(0===n.length)throw new Error("Cannot extract ssrc from plan-b SDP.");if(s&&n.length>1){const e=s.find((e=>-1!==e.ssrcIds.indexOf(n[0].ssrcId)));return e?[{ssrcId:e.ssrcIds[0],rtx:i?e.ssrcIds[1]:void 0}]:[{ssrcId:n[0].ssrcId}]}return[{ssrcId:n[0].ssrcId}]}(n,t.id,i.useRTX)}));let a;try{a=yield r}catch(e){throw n.forEach((e=>{se()&&e.replaceTrack(null),i.peerConnection.removeTrack(e)})),e}const c=i.mungSendOfferSDP(s.sdp,e);i.remoteSDP.receive(e,t,a);const d=i.remoteSDP.toString();return yield hI(i.peerConnection.setLocalDescription({type:"offer",sdp:c})),yield hI(i.applySendEncodings(n,e)),yield hI(i.peerConnection.setRemoteDescription({type:"answer",sdp:d})),e.map(((e,t)=>{const i=e._mediaStreamTrack.id;return{localSSRC:r[t],id:i}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{n()}}))()}async stopSending(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{se()&&e.replaceTrack(null),this.peerConnection.removeTrack(e)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}}async receive(e,t,i,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{id:i,mslabel:s}=this.remoteSDP.send(e,t,n),o=new eg(((t,n)=>{const o=setTimeout((()=>{n(new Error("Cannot receive track, id: ".concat(i)))}),1e4),r=n=>{const a=Q();if(("Safari"===a.name&&11===Number(a.version)||oe())&&n.track.id!==i&&n.streams[0].id===s){var c;const s=n.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(e,i,n.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(o),void t(s)}if(n.track.id===i)return this.peerConnection.removeEventListener("track",r),clearTimeout(o),void t(n.track)};this.peerConnection.addEventListener("track",r)})),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a);return{track:await o,id:i}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){}async unmuteRemote(e){}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("sender' length doesn't match mids' length.");t.map((e=>{if(se()&&e.track)e.track.enabled=!1;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!1)),e.setParameters(t)}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getSenders().filter((t=>{var i;return-1!==e.indexOf((null===(i=t.track)||void 0===i?void 0:i.id)||"")}));if(t.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");t.map((async e=>{if(se()&&e.track)e.track.enabled=!0;else{const t=e.getParameters();t.encodings.forEach((e=>e.active=!0)),await e.setParameters(t)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return lI((function*(){const n=yield hI(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ke().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===jg.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===jg.RELAY)return;e!==jg.RELAY&&i.remoteSDP.updateCandidates(e);const n=yield hI(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=wI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;i.remoteSDP.restartICE(o);const r=i.remoteSDP.toString();yield hI(i.peerConnection.setLocalDescription(n)),yield hI(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){t.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const e=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(e.sdp,[t]);this.remoteSDP.updateRecvMedia(t._mediaStreamTrack.kind,t);const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getSenders().filter((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e}));1===i.length&&await this.applySendEncodings(i,[t])}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getSenders().find((e=>{var i;return(null===(i=e.track)||void 0===i?void 0:i.id)===t}));i&&await i.replaceTrack(e._mediaStreamTrack)}createDataChannels(e,t){throw new l(h.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new l(h.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),T("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(re(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...uv.turnServerConfigToIceServers(e.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...uv.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>{var i;return(null===(i=t.track)||void 0===i?void 0:i.id)===e._mediaStreamTrack.id}))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!Ke().supportSetRtpSenderParameters)return t.warn("Browser not support set rtp-sender parameters");const s={},o={};if(e instanceof We)switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(T("DSCP_TYPE")&&ae()){var r;const e=T("DSCP_TYPE");jo(r=["very-low","low","medium","high"]).call(r,e)&&(o.networkPriority=e)}const a=i.getParameters(),c=null===(n=a.encodings)||void 0===n?void 0:n[0];c&&Object.assign(c,o),Object.assign(a,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await i.setParameters(a)}async applySendEncodings(e,i){try{if(!Ke().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];n&&s&&await this.updateRtpSenderEncodings(s,n)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t){const i=II.parse(e);return t.forEach(((e,t)=>{const n=e._mediaStreamTrack,s=i.mediaDescriptions.find((e=>e.attributes.mid===n.kind));s&&DI(s,e)})),II.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const t=this.remoteSDP.batchSend(e).map(((t,i)=>{let{id:n,mslabel:s}=t;const{kind:o}=e[i];return new eg(((e,t)=>{const i=setTimeout((()=>{t(new Error("Cannot receive track, id: ".concat(n)))}),1e4),r=t=>{const a=Q();if("Safari"===a.name&&11===Number(a.version)&&t.track.id!==n&&t.streams[0].id===s){var c;const s=t.streams[0].getTracks()[0];return null===(c=this.remoteSDP)||void 0===c||c.updateTrackLabel(o,n,t.track.id),this.peerConnection.removeEventListener("track",r),clearTimeout(i),void e({track:s,id:n})}if(t.track.id===n)return this.peerConnection.removeEventListener("track",r),clearTimeout(i),void e({track:t.track,id:n})};this.peerConnection.addEventListener("track",r)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await eg.all(t)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(Ke().supportPCSetConfiguration){const t=uv.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function pv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("Locking from P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function _v(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Ev(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?_v(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):_v(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}dg([pv,lg("design:type",Function),lg("design:paramtypes",[Object,Object,Array,Object,String,String]),lg("design:returntype",eg)],uv.prototype,"connect",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],uv.prototype,"stopSending",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[String,Array,String,Object]),lg("design:returntype",eg)],uv.prototype,"receive",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],uv.prototype,"stopReceiving",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],uv.prototype,"muteRemote",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],uv.prototype,"unmuteRemote",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],uv.prototype,"muteLocal",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],uv.prototype,"unmuteLocal",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",void 0)],uv.prototype,"close",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],uv.prototype,"updateEncoderConfig",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],uv.prototype,"updateSendParameters",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[qe,String]),lg("design:returntype",eg)],uv.prototype,"replaceTrack",null),dg([pv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],uv.prototype,"getRemoteSSRC",null);const mv="9",fv=4e4;function Sv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function gv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Sv(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Sv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}let Tv=class e extends rT{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}constructor(t,i){super(t,i),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=T("USE_XR"),this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new v("P2PConnection-mutex"),this.store=i,this.peerConnection=new RTCPeerConnection(e.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=dv(this.peerConnection,T("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=wI(e.sdp),i=await VI({filterRTX:!T("USE_PUB_RTX")&&!T("USE_SUB_RTX"),filterVideoFec:T("FILTER_VIDEO_FEC"),filterAudioFec:T("FILTER_AUDIO_FEC")},{useXR:this.useXR});return this.localCapabilities=FI(i),this.initialOffer=e,gv(gv({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,i,n,s,o,r){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return te(this._localCapabilities)}get rtpCapabilities(){return te(this._rtpCapabilities)}get candidates(){return te(this._candidates)}get iceParameters(){return te(this._iceParameters)}get dtlsParameters(){return te(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=te(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=e,c=II.parse("v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0 1\na=msid-semantic: WMS\na=ice-lite\nm=video 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:0\nm=audio 9 UDP/TLS/RTP/SAVPF 0\nc=IN IP4 127.0.0.1\na=rtcp:9 IN IP4 0.0.0.0\na=sendonly\na=rtcp-mux\na=rtcp-rsize\na=mid:1\n");this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=o,"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,T("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=bI([{ssrcId:fv,rtx:T("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,jI(e),T("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=bI([{ssrcId:2e4}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}preloadRemoteMedia(){const e=T("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+2e4,r=2*o+fv,{ssrcs:a,ssrcGroups:c}=bI([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=bI([{ssrcId:r,rtx:T("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:mv,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:mv,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return II.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=bI(t,this.cname,T("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||1===t&&(se()||ce())||0===t&&T("USE_SUB_RTX")||de()?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=te(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||I()||de()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>jo(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>jo(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){const t=this._candidates.filter((e=>"udp"===e.transport));if(e===jg.TCP){if(0===t.length)return;if(T("TCP_CANDIDATE_ONLY")){const e=this._candidates.filter((e=>"tcp"===e.transport));t.forEach((t=>{-1===e.findIndex((e=>e.connectionAddress===t.connectionAddress))&&e.push(Ev(Ev({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=e}else{const e=[];t.forEach((t=>{e.push(Ev(Ev({},t),{},{foundation:"tcpcandidate",priority:Number(t.priority)-1+"",transport:"tcp",port:Number(t.port)+90+""}))})),this._candidates=[...t,...e]}}else if(e===jg.RELAY){if(0!==t.length)return;{const e=this._candidates.filter((e=>"tcp"===e.transport));e.forEach((e=>{t.push(Ev(Ev({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=[...t,...e]}}else 0===t.length?(this._candidates.filter((e=>"tcp"===e.transport)).forEach((e=>{t.push(Ev(Ev({},e),{},{foundation:"udpcandidate",priority:Number(e.priority)+1+"",transport:"udp",port:Number(e.port)-90+""}))})),this._candidates=t):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=te(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(I()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleDataChannel(){for(const e of this.sessionDesc.mediaDescriptions)if("application"===e.media.mediaType)return{mediaDesc:e,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:mv,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,i,n,s,o,r){const a=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=this.localCapabilities.send;let l=[];if(a===Fg.VIDEO){var h,u;if(T("H264_PROFILE_LEVEL_ID")&&"h264"===s&&(l=c.videoCodecs.filter((e=>{var t,i,n;return jo(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,s)&&(null==e||null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"])===T("H264_PROFILE_LEVEL_ID")}))),!l||0===(null===(h=l)||void 0===h?void 0:h.length)){const e=d.videoCodecs.filter((e=>{var t,i;return jo(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,s)}));0!==e.length&&(l=c.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(T("USE_PUB_RTX")){const e=l.map((e=>e.payloadType.toString())),t=c.videoCodecs.filter((t=>{var i,n;return"rtx"===(null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName)&&jo(e).call(e,(null===(n=t.fmtp)||void 0===n?void 0:n.parameters.apt)||"")}));l=[...l,...t]}0===l.length&&(t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(null===(u=c.videoCodecs[0].rtpMap)||void 0===u?void 0:u.encodingName)),l=c.videoCodecs)}else l=c.audioCodecs.filter((e=>{var t,i;return jo(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,o)})),0===l.length&&(t.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),l=c.audioCodecs.filter((e=>{var t,i;return jo(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,"opus")})));const p=a===Fg.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const _="".concat(this.currentMidIndex);let E={media:{mediaType:a,port:mv,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:p,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(_)}};E=this.mungRecvMediaDsec(E,e,r);const m=this.findFirstClosedMedia(a);if(m){const e=this.sessionDesc.mediaDescriptions.indexOf(m);this.sessionDesc.mediaDescriptions[e]=E}else this.sessionDesc.mediaDescriptions.push(E);return E}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,r=e===Fg.VIDEO?o.videoCodecs:o.audioCodecs,a=e===Fg.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:mv,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=te(e);return PI(n),DI(n,t),LI(n,t),kI(n),MI(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=te(e);return MI(i,t,this.localCapabilities.recv),jI(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>I()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}({remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:this.localCapabilities,cname:r});const a=this.remoteSDP.toString(),c=II.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find((e=>"audio"===e.media.mediaType));d&&jI(d),this.useXR&&BI(c);const l=II.print(c),h=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),null==h||h(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});const u=this.peerConnection.getTransceivers()[0];if(null!=u&&u.receiver&&this.tryBindTransportEvents(u.receiver),T("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(t)}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}send(e,t,i){var n=this;return lI((function*(){const s=yield hI(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});s.push(t),e._updateRtpTransceiver(t)})),I()&&!0===T("SIMULCAST")&&(yield hI(n.applySimulcastForFirefox(s,e)));const o=yield hI(n.peerConnection.createOffer()),r=n.remoteSDP.predictReceivingMids(e.length),a=n.mungSendOfferSDP(o.sdp,e,r),c=II.parse(a),d=r.map((e=>{const t=c.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return OI(t,T("USE_PUB_RTX"))}));let l;try{l=yield d}catch(s){l=[],n.remoteSDP.receive(e,t,i,l);const o=n.remoteSDP.toString();throw yield hI(n.peerConnection.setLocalDescription({type:"offer",sdp:a})),yield hI(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield hI(n.stopSending(r,!0)),s}n.remoteSDP.receive(e,t,i,l);const h=n.remoteSDP.toString(),u=n.logSDPExchange(a,"offer","local","send");return yield hI(n.peerConnection.setLocalDescription({type:"offer",sdp:a})),yield hI(n.applySimulcastEncodings(s,e)),yield hI(n.applySendEncodings(s,e)),null==u||u(h),yield hI(n.peerConnection.setRemoteDescription({type:"answer",sdp:h})),s.map(((e,t)=>{const i=r[t];return{localSSRC:d[t],id:i,transceiver:e}}))}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);n&&"open"===n.readyState?t.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:T("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)),i.forEach((e=>{e._updateOriginDataChannel(n)}));const{needExchangeSDP:s}=this.remoteSDP.sendDataChannel();if(s){const e=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i),t.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else t.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof l?e:new l(h.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(e.toString()))}}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:r}=this.remoteSDP.send(e,i,n,s);if(r){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n),t.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else t.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e,transceiver:t}}))}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return lI((function*(){const n=yield hI(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ke().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===jg.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===jg.RELAY)return;i.remoteSDP.updateCandidates(e);const n=yield hI(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=wI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;i.remoteSDP.restartICE(o);const r=i.remoteSDP.toString(),a=i.logSDPExchange(n.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield hI(i.peerConnection.setLocalDescription(n)),null==a||a(r),yield hI(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){t.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),e)}finally{n()}}))()}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:gv(gv({},YI),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:gv(gv({},YI),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),T("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&"off"!==t.turnServer.mode&&(re(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...e.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),T("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(i.iceTransportPolicy="relay")})))),T("ENABLE_ENCODED_TRANSFORM")&&Ke().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat($T(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!T("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}tryBindTransportEvents(e){const i=e.transport;if(i){this.transportEventReceiver=e,i.onstatechange=()=>{var e;null!=i&&i.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,i.state))},i.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const n=i.iceTransport;n&&(n.onstatechange=()=>{const e=null==i?void 0:i.iceTransport.state;var t;e&&(null===(t=this.onICETransportStateChange)||void 0===t||t.call(this,e))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:e,remote:i}=n.getSelectedCandidatePair();t.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return t.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ke().supportSetRtpSenderParameters)return t.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(e._encoderConfig){var r;const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),jo(r=e._hints).call(r,He.LOW_STREAM)&&(i&&(o.maxFramerate=tC(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}if(T("DSCP_TYPE")&&ae()){var a;const e=T("DSCP_TYPE");jo(a=["very-low","low","medium","high"]).call(a,e)&&(o.networkPriority=e)}const c=i.getParameters(),d=null===(n=c.encodings)||void 0===n?void 0:n[0];I()&&!d&&(s.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await i.setParameters(c)}async applySendEncodings(e,i){try{if(!Ke().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];s instanceof We&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=II.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(DI(o,e),UI(o,e,this.store.codec))})),II.print(n)}mungReceiveAnswerSDP(e,t,i){const n=II.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&(i===Fg.AUDIO&&"audio"===s.media.mediaType&&jI(s),this.useXR&&BI(n)),II.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o,r;const c=e[a],d=t[a];if(d instanceof We&&!jo(i=d._hints).call(i,He.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof We&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(e){var t,i,n,s,o;return!!(e instanceof We&&T("SIMULCAST")&&"vp8"===this.store.codec&&!jo(t=e._hints).call(t,He.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=e._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(T("SDP_LOGGING"))return t.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(t){if(Ke().supportPCSetConfiguration){const i=e.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}};function Cv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function Rv(e,i){let n=document.createElement("video"),s=document.createElement("canvas");n.setAttribute("style","display:none"),s.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),s.width=tC(i.width),s.height=tC(i.height);const o=tC(i.framerate||15);document.body.append(n),document.body.append(s);let r=e._mediaStreamTrack;n.srcObject=new MediaStream([r]),n.play();const a=s.getContext("2d");if(!a)throw new hg(h.UNEXPECTED_ERROR,"can not get canvas context");const c=Ke(),d=s.captureStream(c.supportRequestFrame?0:o).getVideoTracks()[0];d.canvas||(d.canvas=s),s.startCapture=()=>{if(!n)return s.stopCapture&&s.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const e=n.videoWidth,i=n.videoHeight/e,o=s.width*i;Math.abs(o-s.height)>=2&&(t.debug("adjust low stream resolution","".concat(s.width,"x").concat(s.height," -> ").concat(s.width,"x").concat(o)),s.height=o)}a.drawImage(n,0,0,s.width,s.height),d.requestFrame&&d.requestFrame(),r!==e._mediaStreamTrack&&(r=e._mediaStreamTrack,n.srcObject=new MediaStream([r]))},s.stopCapture=Ye((()=>s.startCapture&&s.startCapture()),o);const l=d.stop;return d.stop=()=>{l.call(d),n&&(n.remove(),n.srcObject=null,n=null),s&&(s.width=0,s.remove(),s.stopCapture&&s.stopCapture(),s.startCapture=void 0,s.stopCapture=void 0,s=null),t.debug("clean low stream renderer")},d}function Iv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function vv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Iv(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Iv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}dg([Cv,lg("design:type",Function),lg("design:paramtypes",[Object,Object,Array,Object,String,String]),lg("design:returntype",eg)],Tv.prototype,"connect",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[Object,Array]),lg("design:returntype",eg)],Tv.prototype,"createDataChannels",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[String,Array,String,Object]),lg("design:returntype",eg)],Tv.prototype,"receive",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Tv.prototype,"batchReceive",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Tv.prototype,"stopReceiving",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Tv.prototype,"muteRemote",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Tv.prototype,"unmuteRemote",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Tv.prototype,"muteLocal",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Tv.prototype,"unmuteLocal",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",void 0)],Tv.prototype,"close",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],Tv.prototype,"updateEncoderConfig",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],Tv.prototype,"updateSendParameters",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[qe,String]),lg("design:returntype",eg)],Tv.prototype,"replaceTrack",null),dg([Cv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Tv.prototype,"getRemoteSSRC",null);const yv="v=0\no=- 0 0 IN IP4 127.0.0.1\ns=AgoraGateway\nt=0 0\na=group:BUNDLE 0\na=msid-semantic: WMS\na=ice-lite\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\nc=IN IP4 127.0.0.1\na=mid:0\n",Av="9",wv=2e4,Ov=4e4;class Nv{get localCapabilities(){return te(this._localCapabilities)}get rtpCapabilities(){return te(this._rtpCapabilities)}get candidates(){return te(this._candidates)}get iceParameters(){return te(this._iceParameters)}get dtlsParameters(){return te(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,e=te(e);const{remoteIceParameters:t,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:s,remoteSetup:o,localCapabilities:r,cname:a}=e,c=II.parse(yv);this._rtpCapabilities=s,this._candidates=n,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=r,this.setup=o,this.cname=a;const d=this.rtpCapabilities.send;for(const e of c.mediaDescriptions){if(e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd,e.attributes.fingerprints=i.fingerprints,e.attributes.candidates=n,e.attributes.setup=o,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=d.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.videoCodecs,e.attributes.extmaps=d.videoExtensions,T("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=bI([{ssrcId:Ov,rtx:T("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=d.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=d.audioCodecs,e.attributes.extmaps=d.audioExtensions,jI(e),T("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=bI([{ssrcId:wv}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=c,this.currentMidIndex=c.mediaDescriptions.length-1}updateRemoteRTPCapabilities(e){const t=II.parse(yv);this._rtpCapabilities=e;const i=this.rtpCapabilities.send;for(const e of t.mediaDescriptions){if(e.attributes.iceUfrag=this._iceParameters.iceUfrag,e.attributes.icePwd=this._iceParameters.icePwd,e.attributes.fingerprints=this._dtlsParameters.fingerprints,e.attributes.candidates=this._candidates,e.attributes.setup=this.setup,"application"===e.media.mediaType&&(e.attributes.sctpPort="5000"),"video"===e.media.mediaType&&(e.media.fmts=i.videoCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.videoCodecs,e.attributes.extmaps=i.videoExtensions,T("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=bI([{ssrcId:Ov,rtx:T("USE_SUB_RTX")?40001:void 0}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}if("audio"===e.media.mediaType&&(e.media.fmts=i.audioCodecs.map((e=>e.payloadType.toString(10))),e.attributes.payloads=i.audioCodecs,e.attributes.extmaps=i.audioExtensions,T("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:t,ssrcGroups:i}=bI([{ssrcId:wv}],this.cname);e.attributes.ssrcs=t,e.attributes.ssrcGroups=i}}this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1}preloadRemoteMedia(e){this.rtpCapabilities;const t=this.candidates,i=this.dtlsParameters,n=this.iceParameters,s=this.rtpCapabilities.send;for(let o=1;o<e;o++){const e=2*o+wv,r=2*o+Ov,{ssrcs:a,ssrcGroups:c}=bI([{ssrcId:e}],this.cname),{ssrcs:d,ssrcGroups:l}=bI([{ssrcId:r,rtx:T("USE_SUB_RTX")?r+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Av,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.videoCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:s.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Av,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.audioCodecs.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:t,extmaps:s.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:a,ssrcGroups:c,rtcpFeedbackWildcards:[],payloads:s.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*o)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return II.print(this.sessionDesc)}send(e,t,i,n){const{ssrcs:s,ssrcGroups:o}=bI(t,this.cname,T("SYNC_GROUP")?i:void 0),r=this.findPreloadMediaDesc(s);if(r){if(I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,r.attributes.mid),n&&(n.twcc||n.remb)){const e=this.sessionDesc.mediaDescriptions.indexOf(r);return this.sessionDesc.mediaDescriptions[e]=this.mungSendMediaDesc(r,n),{mid:r.attributes.mid,needExchangeSDP:!0}}return{mid:r.attributes.mid,needExchangeSDP:!1}}{const t=this.findAvailableMediaIndex(e,s);let i;return-1===t||se()||oe()||ce()||0===t&&T("USE_SUB_RTX")?(i=this.createOrRecycleSendMedia(e,s,o,"sendonly",n),this.updateBundleMids()):(i=te(this.sessionDesc.mediaDescriptions[t]),i.attributes.direction="sendonly",i.attributes.ssrcs=s,i.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[t]=this.mungSendMediaDesc(i,n)),I()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,i.attributes.mid),{mid:i.attributes.mid,needExchangeSDP:!0}}}batchSend(e){const t=e.map((e=>{let{kind:t,ssrcMsg:i,mslabel:n}=e;return this.send(t,i,n)})),i=[];let n=!1;return t.forEach((e=>{let{mid:t,needExchangeSDP:s}=e;s&&(n=!0),i.push(t)})),{mids:i,needExchangeSDP:n}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>t.attributes.mid&&-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((e=>{"0"===e.attributes.mid||I()||se()||oe()?e.attributes.ssrcs=[]:(e.attributes.ssrcs=[],e.attributes.direction="inactive",e.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>jo(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>jo(e).call(e,t.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((e=>{e.attributes.direction="recvonly"}))}receive(e,t,i,n){e.forEach(((e,s)=>{this.createOrRecycleRecvMedia(e,[],"recvonly",t,i,n[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((t=>-1!==e.indexOf(t.attributes.mid)));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((e=>{e.media.port="0",e.attributes.direction="inactive"})),this.updateBundleMids()}updateCandidates(e){e===jg.TCP?this._candidates.forEach((e=>{-1===this._candidates.findIndex((t=>"tcp"===t.transport&&t.connectionAddress===e.connectionAddress&&t.port===e.port))&&this._candidates.push(vv(vv({},e),{},{foundation:"tcpcandidate",priority:Number(e.priority)-1+"",transport:"tcp",port:Number(e.port)+90+""}))})):this._candidates=this._candidates.filter((e=>"tcp"!==e.transport));for(const e of this.sessionDesc.mediaDescriptions)e.attributes.candidates=this.candidates}restartICE(e){e=te(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const n=i.media.mediaType===e&&"0"!==i.media.port&&("sendonly"===i.attributes.direction||"sendrecv"===i.attributes.direction)&&0===i.attributes.ssrcs.length;if(I()){if(n){const e=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(e||"0"!==i.attributes.mid&&"1"!==i.attributes.mid)||!(!e||e!==i.attributes.mid)}return!1}return n}))}createOrRecycleRecvMedia(e,i,n,s,o,r){const a=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=this.localCapabilities.send;let l=[];if(a===Fg.VIDEO){var h,u;if(T("H264_PROFILE_LEVEL_ID")&&"h264"===s&&(l=c.videoCodecs.filter((e=>{var t,i,n;return jo(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,s)&&(null==e||null===(n=e.fmtp)||void 0===n?void 0:n.parameters["profile-level-id"])===T("H264_PROFILE_LEVEL_ID")}))),!l||0===(null===(h=l)||void 0===h?void 0:h.length)){const e=d.videoCodecs.filter((e=>{var t,i;return jo(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,s)}));0!==e.length&&(l=c.videoCodecs.filter((t=>e.some((e=>e.payloadType===t.payloadType)))))}if(T("USE_PUB_RTX")){const e=l.map((e=>e.payloadType.toString())),t=c.videoCodecs.filter((t=>{var i,n;return"rtx"===(null===(i=t.rtpMap)||void 0===i?void 0:i.encodingName)&&jo(e).call(e,(null===(n=t.fmtp)||void 0===n?void 0:n.parameters.apt)||"")}));l=[...l,...t]}if(0===l.length)t.warning("codec ".concat(s," not included in rtpCapabilities, fallback to default payloads: ").concat(null===(u=c.videoCodecs[0].rtpMap)||void 0===u?void 0:u.encodingName)),l=c.videoCodecs}else l=c.audioCodecs.filter((e=>{var t,i;return jo(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,o)})),0===l.length&&(t.warning("codec ".concat(o," not included in rtpCapabilities, fallback to opus")),l=c.audioCodecs.filter((e=>{var t,i;return jo(t=(null===(i=e.rtpMap)||void 0===i?void 0:i.encodingName.toLowerCase())||"").call(t,"opus")})));const p=a===Fg.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const _="".concat(this.currentMidIndex);let E={media:{mediaType:a,port:Av,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:p,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(_)}};E=this.mungRecvMediaDsec(E,e,r);const m=this.findFirstClosedMedia(a);if(m){const e=this.sessionDesc.mediaDescriptions.indexOf(m);this.sessionDesc.mediaDescriptions[e]=E}else this.sessionDesc.mediaDescriptions.push(E);return E}createOrRecycleSendMedia(e,t,i,n,s){const o=this.rtpCapabilities.send,r=e===Fg.VIDEO?o.videoCodecs:o.audioCodecs,a=e===Fg.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:Av,protos:["UDP","TLS","RTP","SAVPF"],fmts:r.map((e=>e.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:r,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const e=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[e]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>"0"!==e.media.port)).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,i){const n=te(e);return PI(n),DI(n,t),LI(n,t),kI(n),MI(n,i,this.localCapabilities.send),n}mungSendMediaDesc(e,t){const i=te(e);return MI(i,t,this.localCapabilities.recv),jI(i),i}updateRecvMedia(e,t){const i=this.sessionDesc.mediaDescriptions.findIndex((t=>t.attributes.mid===e));if(-1!==i){const e=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=e}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>I()?"0"===t.media.port&&t.media.mediaType===e:"0"===t.media.port))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var i;return(null===(i=t.attributes)||void 0===i||null===(i=i.ssrcs[0])||void 0===i?void 0:i.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return null===(t=this.sessionDesc.mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===t?void 0:t.attributes.ssrcs}}function bv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Dv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?bv(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):bv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class Pv extends rT{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,t,i){super(e,t),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=T("USE_XR"),this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new v("NVExtentionsConnection-mutex"),this.rtcMedia=void 0,this.store=t,this.peerConnection=i,this.statsFilter=dv(this.peerConnection,T("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(e){try{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const t=wI(e.sdp),i=await VI({filterRTX:!T("USE_PUB_RTX")&&!T("USE_SUB_RTX"),filterVideoFec:T("FILTER_VIDEO_FEC"),filterAudioFec:T("FILTER_AUDIO_FEC")},{useXR:this.useXR});return this.localCapabilities=i,this.initialOffer=e,Dv(Dv({},t),{},{rtpCapabilities:i,offerSDP:e.sdp})}catch(e){throw new hg(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e,t,i,n,s,o){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new Nv({remoteIceParameters:e,remoteDtlsParameters:t,candidates:i,remoteRTPCapabilities:n,remoteSetup:s,localCapabilities:FI(this.localCapabilities),cname:o});const r=this.remoteSDP.toString(),a=II.parse(this.initialOffer.sdp),c=a.mediaDescriptions.find((e=>"audio"===e.media.mediaType));c&&jI(c),this.useXR&&BI(a);const d=II.print(a),l=this.logSDPExchange(d||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:d}),null==l||l(r),await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(e.toString()))}}async updateRemoteConnect(e){var i,n,s;null===(i=this.remoteSDP)||void 0===i||i.updateRemoteRTPCapabilities(e),null===(n=this.remoteSDP)||void 0===n||n.preloadRemoteMedia(2);const o=null===(s=this.remoteSDP)||void 0===s?void 0:s.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r),t.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(e,t,i){var n=this;return lI((function*(){const s=yield hI(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const s=[];e.forEach((e=>{const t=n.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});s.push(t)})),I()&&!0===T("SIMULCAST")&&(yield hI(n.applySimulcastForFirefox(s,e)));const o=yield hI(n.peerConnection.createOffer()),r=n.remoteSDP.predictReceivingMids(e.length),a=n.mungSendOfferSDP(o.sdp,e,r),c=II.parse(a),d=r.map((e=>{const t=c.mediaDescriptions.find((t=>t.attributes.mid===e));if(!t)throw new Error("Cannot extract ssrc from mediaDescription.");return OI(t,T("USE_PUB_RTX"))}));let l;try{l=yield d}catch(s){l=[],n.remoteSDP.receive(e,t,i,l);const o=n.remoteSDP.toString();throw yield hI(n.peerConnection.setLocalDescription({type:"offer",sdp:a})),yield hI(n.peerConnection.setRemoteDescription({type:"answer",sdp:o})),yield hI(n.stopSending(r,!0)),s}n.remoteSDP.receive(e,t,i,l);const h=n.remoteSDP.toString(),u=n.logSDPExchange(a,"offer","local","send");return yield hI(n.peerConnection.setLocalDescription({type:"offer",sdp:a})),yield hI(n.applySimulcastEncodings(s,e)),yield hI(n.applySendEncodings(s,e)),null==u||u(h),yield hI(n.peerConnection.setRemoteDescription({type:"answer",sdp:h})),s.map(((e,t)=>{const i=r[t];return{localSSRC:d[t],id:i,transceiver:e}}))}catch(e){throw e instanceof hg?e:new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(e.toString()))}finally{s()}}))()}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async createDataChannels(e,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);return n&&"open"===n.readyState?t.debug("[P2PConnection] Channels are already available and can be reused directly."):(n=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:T("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)),void i.forEach((e=>{e._updateOriginDataChannel(n)}))}catch(e){throw e instanceof hg?e:new hg(h.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(e.toString()))}}async stopDataChannels(e){try{const t=this.dataStreamChannelMap.get(e);return null==t||t.close(),void this.dataStreamChannelMap.delete(e)}catch(e){throw e instanceof hg?e:new hg(h.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(e.toString()))}}async receive(e,i,n,s){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(e," before remoteSDP created."));const{mid:o,needExchangeSDP:r}=this.remoteSDP.send(e,i,n,s);if(r){const i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer(),r=this.mungReceiveAnswerSDP(s.sdp,o,e);null==n||n(r||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:r}),t.debug("[NVExtentionsConnection] receive ".concat(e," by exchanging SDP."))}else t.debug("[NVExtentionsConnection] receive ".concat(e," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o}}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async batchReceive(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);if(n){const e=this.remoteSDP.toString(),i=this.logSDPExchange(e,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n),t.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else t.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return i.map((e=>{const t=this.peerConnection.getTransceivers().find((t=>t.mid===e));if(!t)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:t.receiver.track,id:e}}))}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(e.toString()))}}async stopReceiving(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(e.toString()))}}async muteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(e.toString()))}}async unmuteRemote(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);const t=this.remoteSDP.toString(),i=this.logSDPExchange(t,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();null==i||i(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(e.toString()))}}async muteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((e=>{e.direction="inactive"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(e.toString()))}}async unmuteLocal(e){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const t=this.peerConnection.getTransceivers().filter((t=>t.mid&&-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");t.map((async(e,t)=>{e.direction="sendonly"}));const i=await this.peerConnection.createOffer(),n=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(e);const s=this.remoteSDP.toString();null==n||n(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(e.toString()))}}restartICE(e){var i=this;return lI((function*(){const n=yield hI(i.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ke().supportPCSetConfiguration){const n=i.peerConnection.getConfiguration(),s=e===jg.RELAY?"relay":"all";n.iceTransportPolicy!==s&&(t.debug("restartICE change iceTransportPolicy from [".concat(n.iceTransportPolicy,"] to [").concat(s,"]")),n.iceTransportPolicy=s,i.peerConnection.setConfiguration(n))}else if(e===jg.RELAY)return;e!==jg.RELAY&&i.remoteSDP.updateCandidates(e);const n=yield hI(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=wI(n.sdp),{remoteIceParameters:o}=yield s.iceParameters;i.remoteSDP.restartICE(o);const r=i.remoteSDP.toString(),a=i.logSDPExchange(n.sdp||"","offer","local","restartICE");yield hI(i.peerConnection.setLocalDescription(n)),null==a||a(r),yield hI(i.peerConnection.setRemoteDescription({type:"answer",sdp:r}))}catch(e){t.warning("restart ICE failed, abort operation",e)}finally{n()}}))()}close(){var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(i.sdp,[t],[e]);this.remoteSDP.updateRecvMedia(e,t);const s=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),null==o||o(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(e){throw new hg(h.EXCHANGE_SDP_FAILED,e.toString())}}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}getP2PConnectionParams(){var e;if(null===(e=this.peerConnection.currentLocalDescription)||void 0===e||!e.sdp||!this.localCapabilities)throw new Error;return Dv(Dv({},wI(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),T("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(re(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...Pv.turnServerConfigToIceServers(e.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...Pv.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),T("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat($T(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!T("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}async applySendEncodings(e,i){try{if(!Ke().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const h=e[t],u=i[t];if(u&&u instanceof We){var n,s,o;if(this.isVP8Simulcast(u))continue;const e={},t={};switch(u._optimizationMode){case"motion":e.degradationPreference="maintain-framerate";break;case"detail":e.degradationPreference="maintain-resolution";break;default:e.degradationPreference="balanced"}var r,a,c,d;if(null!==(n=u._encoderConfig)&&void 0!==n&&n.bitrateMax)t.maxBitrate=1e3*(null===(r=u._encoderConfig)||void 0===r?void 0:r.bitrateMax);if(jo(s=u._hints).call(s,He.LOW_STREAM))null!==(a=u._encoderConfig)&&void 0!==a&&a.frameRate&&(t.maxFramerate=tC(u._encoderConfig.frameRate)),null!==(c=u._encoderConfig)&&void 0!==c&&c.scaleResolutionDownBy&&(null===(d=u._encoderConfig)||void 0===d?void 0:d.scaleResolutionDownBy)>1&&(t.scaleResolutionDownBy=u._encoderConfig.scaleResolutionDownBy);if(T("DSCP_TYPE")&&ae()){var l;const e=T("DSCP_TYPE");jo(l=["very-low","low","medium","high"]).call(l,e)&&(t.networkPriority=e)}const i=h.sender.getParameters(),p=null===(o=i.encodings)||void 0===o?void 0:o[0];I()&&!p&&(e.encodings=[t]),p&&Object.assign(p,t),Object.assign(i,e),await h.sender.setParameters(i)}}}catch(e){t.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(e,t,i){const n=II.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(DI(o,e),UI(o,e,this.store.codec))})),II.print(n)}mungReceiveAnswerSDP(e,t,i){const n=II.parse(e),s=n.mediaDescriptions.find((e=>e.attributes.mid===t));return s&&i===Fg.AUDIO&&"audio"===s.media.mediaType&&jI(s),this.useXR&&BI(n),II.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o,r;const c=e[a],d=t[a];if(d instanceof We&&!jo(i=d._hints).call(i,He.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof We&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(e){var t,i,n,s,o;return!!(e instanceof We&&T("SIMULCAST")&&"vp8"===this.store.codec&&!jo(t=e._hints).call(t,He.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=e._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(T("SDP_LOGGING"))return t.upload("exchanging ".concat(n," ").concat(i," SDP during NVExtentionsConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}async getRemoteSSRC(e){if(!this.remoteSDP)return;const t=this.remoteSDP.getSSRC(e);return null==t?void 0:t[0].ssrcId}setConfiguration(e){if(Ke().supportPCSetConfiguration){const t=Pv.resolvePCConfiguration(e);this.peerConnection.setConfiguration(t)}}}function Lv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From NVExtentionsConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function kv(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=pI,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new Mv(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Mv(e){function t(e){if(Object(e)!==e)return eg.reject(new TypeError(e+" is not an object."));var t=e.done;return eg.resolve(e.value).then((function(e){return{value:e,done:t}}))}return Mv=function(e){this.s=e,this.n=e.next},Mv.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?eg.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?eg.reject(e):t(i.apply(this.s,arguments))}},new Mv(e)}dg([Lv,lg("design:type",Function),lg("design:paramtypes",[Object,Object,Array,Object,String,String]),lg("design:returntype",eg)],Pv.prototype,"connect",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[Object]),lg("design:returntype",eg)],Pv.prototype,"updateRemoteConnect",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[Object,Array]),lg("design:returntype",eg)],Pv.prototype,"createDataChannels",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[String,Array,String,Object]),lg("design:returntype",eg)],Pv.prototype,"receive",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Pv.prototype,"batchReceive",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Pv.prototype,"stopReceiving",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Pv.prototype,"muteRemote",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Pv.prototype,"unmuteRemote",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Pv.prototype,"muteLocal",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Pv.prototype,"unmuteLocal",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",void 0)],Pv.prototype,"close",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],Pv.prototype,"updateEncoderConfig",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],Pv.prototype,"updateSendParameters",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[qe,String]),lg("design:returntype",eg)],Pv.prototype,"replaceTrack",null),dg([Lv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Pv.prototype,"getRemoteSSRC",null);class Uv extends rT{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}constructor(e,t){super(e,t),this.store=void 0,this.peerConnection=void 0,this.cname=void 0,this.mutex=new v("DataChannelConnection-mutex"),this.dataChannel=void 0,this._p2pConnection=void 0,this.establishPromise=void 0,this._nvMedia=void 0,this.store=t,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(Uv.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new Pv(e,t,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var e;const t=null===(e=this._nvMedia)||void 0===e?void 0:e.getLocalRtpCapabilities();return await this._p2pConnection.establish(t)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(e,t,i,n,s,o){return this.cname=o,await this._p2pConnection.connect(e,t,i,n,s,o),await new eg(((e,t)=>{const n=setTimeout((()=>{this.closeSignal(),t(new hg(h.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))}),2e3);this.dataChannel.onopen=()=>{if("open"===this.dataChannel.readyState)return clearTimeout(n),void e()},this.dataChannel.onerror=e=>{this.closeSignal(),t(e)}})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}send(e,t,i){var n=this;return lI((function*(){const s=yield hI(n.mutex.lock("From DataChannelConnection.send"));try{return yield*uI(kv(n._p2pConnection.send(e,t,i)))}finally{s()}}))()}async stopSending(e,t){return this._p2pConnection.stopSending(e,t)}async createDataChannels(e,t){return this._p2pConnection.createDataChannels(e,t)}async stopDataChannels(e){return this._p2pConnection.stopDataChannels(e)}async receive(e,i,n,s){return this._nvMedia?(t.debug("[DataChannelConnection] receive ".concat(e," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(e,i,this.cname)):(t.debug("[DataChannelConnection] receive ".concat(e," by WebRTC.")),await this._p2pConnection.receive(e,i,n,s))}async batchReceive(e){return[...await this._p2pConnection.batchReceive(e)]}async stopReceiving(e){return await this._p2pConnection.stopReceiving(e)}async muteRemote(e){return await this._p2pConnection.muteRemote(e)}async unmuteRemote(e){return await this._p2pConnection.unmuteRemote(e)}async muteLocal(e){return await this._p2pConnection.muteLocal(e)}async unmuteLocal(e){return await this._p2pConnection.unmuteLocal(e)}restartICE(e){var t=this;return lI((function*(){return yield*uI(kv(t._p2pConnection.restartICE(e)))}))()}close(){var e;null===(e=this._nvMedia)||void 0===e||e.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(e){return this._p2pConnection.getRemoteVideoIsReady(e)}updateRemoteConnect(e){var t;null===(t=this._nvMedia)||void 0===t||t.setRemoteRtpCapabilities(e),this._p2pConnection.updateRemoteConnect(e)}async updateEncoderConfig(e,t){return await this._p2pConnection.updateEncoderConfig(e,t)}async updateSendParameters(e,t){return await this._p2pConnection.updateSendParameters(e,t)}setStatsRemoteVideoIsReady(e,t){this._p2pConnection.setStatsRemoteVideoIsReady(e,t)}async replaceTrack(e,t){return await this._p2pConnection.replaceTrack(e,t)}async getRemoteSSRC(e){return this._p2pConnection.getRemoteSSRC(e)}logSDPExchange(e,i,n,s){if(T("SDP_LOGGING"))return t.upload("exchanging ".concat(n," ").concat(i," SDP during DataChannelConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(re(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...Uv.turnServerConfigToIceServers(e.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...Uv.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),T("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.security?e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat($T(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}):(e.udpport&&!T("FORCE_TURN_TCP")&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.udpport,"?transport=udp")}),e.tcpport&&t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=tcp")}))})),t}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=e=>{var t;return null===(t=this.onICEConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onConnectionStateChange=e=>{var t;return null===(t=this.onConnectionStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportStateChange=e=>{var t;return null===(t=this.onDTLSTransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onDTLSTransportError=e=>{var t;return null===(t=this.onDTLSTransportError)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onICETransportStateChange=e=>{var t;return null===(t=this.onICETransportStateChange)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioReceived=e=>{var t;return null===(t=this.onFirstAudioReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoReceived=e=>{var t;return null===(t=this.onFirstVideoReceived)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstAudioDecoded=e=>{var t;return null===(t=this.onFirstAudioDecoded)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onFirstVideoDecoded=(e,t,i)=>{var n;return null===(n=this.onFirstVideoDecoded)||void 0===n?void 0:n.call(this,e,t,i)},this._p2pConnection.onFirstVideoDecodedTimeout=e=>{var t;return null===(t=this.onFirstVideoDecodedTimeout)||void 0===t?void 0:t.call(this,e)},this._p2pConnection.onSelectedLocalCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedLocalCandidateChanged)||void 0===i?void 0:i.call(this,e,t)},this._p2pConnection.onSelectedRemoteCandidateChanged=(e,t)=>{var i;return null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i?void 0:i.call(this,e,t)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}setConfiguration(e){this._p2pConnection.setConfiguration(e)}}function Vv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From DataChannelConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function xv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Fv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?xv(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):xv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}dg([Vv,lg("design:type",Function),lg("design:paramtypes",[Object,Object,Array,Object,String,String]),lg("design:returntype",eg)],Uv.prototype,"connect",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[Object,Array]),lg("design:returntype",eg)],Uv.prototype,"createDataChannels",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[String,Array,String,Object]),lg("design:returntype",eg)],Uv.prototype,"receive",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Uv.prototype,"stopReceiving",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Uv.prototype,"muteRemote",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Uv.prototype,"unmuteRemote",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Uv.prototype,"muteLocal",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Uv.prototype,"unmuteLocal",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",void 0)],Uv.prototype,"close",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],Uv.prototype,"updateEncoderConfig",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],Uv.prototype,"updateSendParameters",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[qe,String]),lg("design:returntype",eg)],Uv.prototype,"replaceTrack",null),dg([Vv,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],Uv.prototype,"getRemoteSSRC",null);class jv extends g{constructor(){super(),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0,this.transportStatsUploadInterval=void 0,this.uplinkExtensionStatsUploadInterval=void 0,this.downlinkExtensionStatsUploadInterval=void 0,this.extensionUsageStatsUploadInterval=void 0,this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0,this.lastStats=void 0,this.uploadUnplinkStarted=!1,this.uploadDownlinkStarted=!1,this.uploadTransportStarted=!1,this.uploadExtensionUsageStarted=!1,this.requestStats=void 0,this.requestTransportStats=void 0,this.requestLocalMedia=void 0,this.requestRemoteMedia=void 0,this.requestAllTracks=void 0,this.requestVideoIsReady=void 0,this.requestUpload=void 0}startUploadTransportStats(e){this.uploadTransportStarted||(this.uploadTransportStarted=!0,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=window.setInterval((()=>{var t;const i=null===(t=this.requestStats)||void 0===t?void 0:t.call(this);if(i){const t=nC(i);if(e){var n;const e=null===(n=this.requestStats)||void 0===n?void 0:n.call(this,!0);if(e){const i=nC(e);t.connectionType+=i.connectionType<<3}t.connectionType+=110}else t.connectionType+=100;W((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,qS.TRANSPORT_STATS,t)}))}}),1e3))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval);const e=new Map;this.extensionUsageStatsUploadInterval=window.setInterval((async()=>{var t,i,n;const s=Date.now(),o={connectionInterval:T("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:s};let r=[];const a=(null===(t=this.requestAllTracks)||void 0===t?void 0:t.call(this))||[];for(const e of a)!e.muted&&e.enabled&&(r=r.concat(await e.getProcessorUsage()));const c=(null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[];for(const[e,t]of c)t.has(Fg.VIDEO)&&e.videoTrack&&(r=r.concat(await e.videoTrack.getProcessorUsage())),t.has(Fg.AUDIO)&&e.audioTrack&&(r=r.concat(await e.audioTrack.getProcessorUsage()));if(0===r.length)return;o.details=function(e,t){const i={};for(const{id:r,value:a,level:c,direction:d}of e){var n;const e=null!==(n=t.get(r))&&void 0!==n?n:0,l=2===a?e+T("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:e;var s,o;t.set(r,l),i[r]?(2===a&&(i[r].value=a),c>i[r].level&&(i[r].level=c),"remote"===d&&(i[r].remoteUidCount+=1),i[r].totalTs=null!==(s=t.get(r))&&void 0!==s?s:0):i[r]={value:a,level:c,remoteUidCount:"local"===d?0:1,totalTs:null!==(o=t.get(r))&&void 0!==o?o:0}}return Object.keys(i).map((e=>{const{level:t,value:n,totalTs:s}=i[e];return{id:e,level:t,value:n,totalTs:s}}))}(r,e);const d=Date.now(),l=d>s?d:s+1;null===(n=this.requestUpload)||void 0===n||n.call(this,qS.EXTENSION_USAGE_STATS,{usageStats:o,sendTs:l})}),T("EXTENSION_USAGE_UPLOAD_INTERVAL"))}startUploadUplinkStats(){this.uploadUnplinkStarted||(this.uploadUnplinkStarted=!0,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&(this.uploadUplinkStats(t),this.lastStats=t)}),3e3),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkRelatedStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this);t&&this.uploadRelatedUplinkStats(t,this.lastStats),this.lastStats=t}),1e3),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestAllTracks)||void 0===e?void 0:e.call(this);t&&this.uploadDenoiserStats(t)}),2e3),this.uplinkExtensionStatsUploadInterval&&window.clearInterval(this.uplinkExtensionStatsUploadInterval),this.uplinkExtensionStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestAllTracks)||void 0===e?void 0:e.call(this);t&&this.uploadExtensionStats(t)}),2e3))}uploadUplinkStats(e){var t;((null===(t=this.requestLocalMedia)||void 0===t?void 0:t.call(this))||[]).forEach((t=>{let[i,{track:n,ssrcs:s}]=t;switch(i){case Gg.LocalVideoLowTrack:case Gg.LocalVideoTrack:{const t=function(e,t,i){var n;const s=t.videoSend.find((t=>t.ssrc===e));if(!s)return null;const o={id:M(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:s.ssrc.toString()};switch(o.A_vstd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",s.sentFrame&&(o.A_fhs=s.sentFrame.height.toString(),o.A_frs=s.sentFrame.frameRate.toString(),o.A_fws=s.sentFrame.width.toString()),s.adaptionChangeReason){case"none":o.A_ac="0";break;case"cpu":o.A_ac="1";break;case"bandwidth":o.A_ac="2";break;case"other":o.A_ac="3"}return o.A_lvps=Fe[i._player?i._player.videoElementStatus:"uninit"].toString(),o.A_nr=null===(n=s.nacksCount)||void 0===n?void 0:n.toString(),s.avgEncodeMs&&(o.A_aem=s.avgEncodeMs.toFixed(0).toString()),T("P2P")&&(s.bytes&&(o.bytesSent=s.bytes.toString()),"number"==typeof s.packetsLost&&(o.packetsLost=s.packetsLost.toString()),s.packets&&(o.packetsSent=s.packets.toString())),o}(s[0].ssrcId,e,n),o=i===Gg.LocalVideoTrack?function(e,t,i){var n,s,o,r,a,c,d,l;const h=t.videoSend.find((t=>t.ssrc===e));if(!h)return null;const u={id:M(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:h.ssrc.toString()},p=null!==(n=null!==(s=null===(o=h.inputFrame)||void 0===o?void 0:o.height)&&void 0!==s?s:null==i?void 0:i._videoHeight)&&void 0!==n?n:0,_=null!==(r=null!==(a=null===(c=h.inputFrame)||void 0===c?void 0:c.width)&&void 0!==a?a:null==i?void 0:i._videoWidth)&&void 0!==r?r:0,E=null!==(d=null===(l=h.inputFrame)||void 0===l?void 0:l.frameRate)&&void 0!==d?d:0;return p&&(u.A_fhi=p+""),_&&(u.A_fwi=_+""),E&&(u.A_fri=E+""),u}(s[0].ssrcId,e,n):null;t&&W((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,qS.PUBLISH_STATS,{stream_type:i===Gg.LocalVideoLowTrack?"low":"high",stats:Fv(Fv({},t),o)})}));const r=function(e){const t={id:"bweforvideo",timestamp:new Date(e.timestamp).toISOString(),type:"VideoBwe"};return e.bitrate.retransmit&&(t.A_rb=e.bitrate.retransmit.toString()),e.bitrate.targetEncoded&&(t.A_teb=e.bitrate.targetEncoded.toString()),t.A_aeb=e.bitrate.actualEncoded.toString(),t.A_tb=e.bitrate.transmit.toString(),void 0!==e.sendBandwidth&&(t.A_asb=e.sendBandwidth.toString()),t}(e);r&&setTimeout((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,qS.PUBLISH_STATS,{stream_type:i===Gg.LocalVideoLowTrack?"low":"high",stats:r})}),1e3);break}case Gg.LocalAudioTrack:{const t=function(e,t,i){const n=t.audioSend.find((t=>t.ssrc===e));if(!n)return null;const s={id:M(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:n.ssrc.toString()};return s.A_astd=i._originMediaStreamTrack&&!i._originMediaStreamTrack.enabled||i._mediaStreamTrack&&!i._mediaStreamTrack.enabled?"1":"0",n.inputLevel?s.A_ail=Math.round(100*n.inputLevel).toString():s.A_ail=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),s.A_apil=Math.round(100*i._source.getAccurateVolumeLevel()).toString(),n.aecReturnLoss&&(s.A_ecrl=Math.round(n.aecReturnLoss).toString()),n.aecReturnLossEnhancement&&(s.A_ecrle=Math.round(n.aecReturnLossEnhancement).toString()),T("P2P")&&(n.bytes&&(s.bytesSent=n.bytes.toString()),"number"==typeof n.packetsLost&&(s.packetsLost=n.packetsLost.toString()),n.packets&&(s.packetsSent=n.packets.toString())),s}(s[0].ssrcId,e,n);t&&W((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,qS.PUBLISH_STATS,{stream_type:"high",stats:t})}));break}}}))}uploadRelatedUplinkStats(e,t){var i;((null===(i=this.requestLocalMedia)||void 0===i?void 0:i.call(this))||[]).filter((e=>{let[t]=e;return t===Gg.LocalVideoLowTrack||t===Gg.LocalVideoTrack})).forEach((t=>{let[i,{ssrcs:n}]=t;const s=function(e,t){const i=t.videoSend.find((t=>t.ssrc===e));return i?{mediaType:"video",isVideoMute:!1,frameRateInput:i.inputFrame&&i.inputFrame.frameRate.toString(),frameRateSent:i.sentFrame&&i.sentFrame.frameRate.toString(),googRtt:i.rttMs.toString(),qpSumPerFrame:Math.floor(i.qpSumPerFrame).toString()}:null}(n[0].ssrcId,e);s&&W((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,qS.PUBLISH_RELATED_STATS,{stream_type:i===Gg.LocalVideoLowTrack?"low":"high",stats:s})}))}))}uploadDenoiserStats(e){for(let s=0;s<e.length;s++){const o=e[s];if(o instanceof Je){var t,i,n;const e=null===(t=(i=o._external).getDenoiserStats)||void 0===t?void 0:t.call(i);return void(e&&(null===(n=this.requestUpload)||void 0===n||n.call(this,qS.DENOISER_STATS,e)))}}}uploadExtensionStats(e){for(let t=0;t<e.length;t++){e[t].getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)}))}}stopUploadUplinkStats(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStatsUploadInterval&&window.clearInterval(this.uplinkStatsUploadInterval),this.uplinkRelatedStatsUploadInterval&&window.clearInterval(this.uplinkRelatedStatsUploadInterval),this.uplinkDenoiserStatsUploadInterval&&window.clearInterval(this.uplinkDenoiserStatsUploadInterval),this.uplinkStatsUploadInterval=void 0,this.uplinkRelatedStatsUploadInterval=void 0,this.uplinkDenoiserStatsUploadInterval=void 0)}startUploadDownlinkStats(){if(this.uploadDownlinkStarted)return;let e;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let t=!1;this.downlinkStatsUploadInterval=window.setInterval((()=>{var i;const n=null===(i=this.requestStats)||void 0===i?void 0:i.call(this,!0);n&&(this.uploadDownlinkStats(n,t,e),e=n),t=!t}),3e3),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkRelatedStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestStats)||void 0===e?void 0:e.call(this,!0);t&&(this.uploadRelatedDownlinkStats(t,this.lastStats),this.lastStats=t)}),1e3),this.downlinkExtensionStatsUploadInterval&&window.clearInterval(this.downlinkExtensionStatsUploadInterval),this.downlinkExtensionStatsUploadInterval=window.setInterval((()=>{var e;const t=null===(e=this.requestRemoteMedia)||void 0===e?void 0:e.call(this);t&&this.uploadDownlinkExtensionStats(t)}),2e3)}uploadDownlinkStats(e,t,i){var n;((null===(n=this.requestRemoteMedia)||void 0===n?void 0:n.call(this))||[]).forEach((n=>{let[s,o]=n;if(o.has(Fg.VIDEO)&&s.videoTrack){const n=s.videoTrack?function(e,t,i,n,s){const o=t.videoRecv.find((t=>t.ssrc===e));if(!o)return null;const r={id:M(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"video",type:"ssrc",ssrc:o.ssrc.toString()};var a,c;if(r.bytesReceived=o.bytes.toString(),r.packetsLost=o.packetsLost.toString(),r.packetsReceived=o.packets.toString(),o.framesRateFirefox&&(r.A_frr=o.framesRateFirefox.toString()),o.receivedFrame?(r.A_frr=o.receivedFrame.frameRate.toString(),r.A_fhr=o.receivedFrame.height.toString(),r.A_fwr=o.receivedFrame.width.toString()):(r.A_fhr=null===(a=n._videoHeight)||void 0===a?void 0:a.toString(),r.A_fwr=null===(c=n._videoWidth)||void 0===c?void 0:c.toString()),r.A_frd=o.decodeFrameRate.toString(),o.outputFrame&&(r.A_fro=o.outputFrame.frameRate.toString()),void 0!==o.jitterBufferMs&&(r.A_jbm=Math.floor(o.jitterBufferMs).toString()),void 0!==o.currentDelayMs&&(r.A_cdm=Math.floor(o.currentDelayMs).toString()),r.A_fs=o.firsCount.toString(),r.A_ns=o.nacksCount.toString(),r.A_ps=o.plisCount.toString(),n&&(r.A_vrtd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),n._player&&n._player.freezeTimeCounterList.length>0&&(r.A_vrft=Math.round(n._player.freezeTimeCounterList.splice(0,1)[0]).toString()),s&&n._player&&"visible"===je.visibility){const e=Math.min(6e3,n._player.renderFreezeAccTime);r.A_vrrft=Math.round(e).toString(),n._player.renderFreezeAccTime=Math.max(0,n._player.renderFreezeAccTime-e)}if(r.A_rvps=Fe[n._player?n._player.videoElementStatus:"uninit"].toString(),i){const t=i.videoRecv.find((t=>t.ssrc===e));if(t&&void 0!==o.totalInterFrameDelay&&void 0!==o.totalSquaredInterFrameDelay&&void 0!==t.totalInterFrameDelay&&void 0!==t.totalSquaredInterFrameDelay){const e=o.totalInterFrameDelay-t.totalInterFrameDelay,i=o.totalSquaredInterFrameDelay-t.totalSquaredInterFrameDelay,n=o.framesDecodeCount-t.framesDecodeCount,s=e/n*1e3,a=Math.round(1e3*Math.sqrt((i-Math.pow(e,2)/n)/n));!isNaN(a)&&s+a>Math.max(3*s,s+150)&&(r.A_ifdsd=a.toString())}}return r}(s._videoSSRC,e,i,s.videoTrack,t):void 0;n&&W((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,qS.SUBSCRIBE_STATS,{stream_id:s.uid,stats:n})}))}if(o.has(Fg.AUDIO)&&s.audioTrack){const t=s.audioTrack?function(e,t,i,n){const s=t.audioRecv.find((t=>t.ssrc===e));if(!s)return null;const o={id:M(10,""),timestamp:new Date(t.timestamp).toISOString(),mediaType:"audio",type:"ssrc",ssrc:s.ssrc.toString()};if(o.bytesReceived=s.bytes.toString(),o.packetsLost=s.packetsLost.toString(),o.packetsReceived=s.packets.toString(),s.outputLevel?o.A_aol=Math.round(100*s.outputLevel).toString():o.A_aol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),o.A_apol=Math.round(100*n._source.getAccurateVolumeLevel()).toString(),n&&(o.A_artd=n._originMediaStreamTrack.enabled&&n._mediaStreamTrack.enabled?"0":"1"),o.A_jr=s.jitterMs.toString(),o.A_jbm=Math.floor(s.jitterBufferMs).toString(),o.A_cdm=Math.floor(s.jitterBufferMs).toString(),o.A_raps=Fe[Be.getPlayerState(n.getTrackId())].toString(),i){const t=i.audioRecv.find((t=>t.ssrc===e));if(t){const e=s.concealedSamples-t.concealedSamples;e>0&&(o.A_cs=Math.round(e).toString())}}return o}(s._audioSSRC,e,i,s.audioTrack):void 0;t&&W((()=>{var e;return null===(e=this.requestUpload)||void 0===e?void 0:e.call(this,qS.SUBSCRIBE_STATS,{stream_id:s.uid,stats:t})}))}}))}uploadRelatedDownlinkStats(e,t){var i;((null===(i=this.requestRemoteMedia)||void 0===i?void 0:i.call(this))||[]).forEach((i=>{let[n,s]=i;if(s.has(Fg.VIDEO)&&n.videoTrack){var o;const i=!0===(n._videoSSRC&&(null===(o=this.requestVideoIsReady)||void 0===o?void 0:o.call(this,n._videoSSRC))||!1),s=function(e,t,i,n,s,o){const r=i.videoRecv.find((t=>t.ssrc===e)),a=s?s.videoRecv.find((t=>t.ssrc===e)):void 0;if(!r)return null;const c=zT.isRemoteVideoFreeze(o,r,a)&&t,d={mediaType:"video",isVideoMute:!1,peerId:n,frameRateReceived:r.receivedFrame&&r.receivedFrame.frameRate.toString(),frameRateDecoded:r.decodedFrame&&r.decodedFrame.frameRate.toString(),isFreeze:c,bytesReceived:r.bytes.toString(),packetsReceived:r.packets.toString(),packetsLost:r.packetsLost.toString(),qpSumPerFrame:Math.floor(r.qpSumPerFrame).toString()};return r.framesRateFirefox&&(d.frameRateDecoded=r.framesRateFirefox.toString(),d.frameRateReceived=r.framesRateFirefox.toString()),d}(n._videoSSRC,i,e,n.uid,t,n.videoTrack);s&&W((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,qS.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:s})}))}if(s.has(Fg.AUDIO)&&n.audioTrack){const t=function(e,t,i,n){const s=t.audioRecv.find((t=>t.ssrc===e));if(!s)return null;const o=zT.isRemoteAudioFreeze(n);return{mediaType:"audio",isAudioMute:!1,peerId:i,googJitterReceived:s.jitterMs.toString(),isFreeze:o,bytesReceived:s.bytes.toString(),packetsReceived:s.packets.toString(),packetsLost:s.packetsLost.toString(),frameReceived:s.receivedFrames.toString(),frameDropped:s.droppedFrames.toString()}}(n._audioSSRC,e,n.uid,n.audioTrack);t&&W((()=>{var e;null===(e=this.requestUpload)||void 0===e||e.call(this,qS.SUBSCRIBE_RELATED_STATS,{stream_id:n.uid,stats:t})}))}}))}stopUploadDownlinkStats(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval),this.downlinkRelatedStatsUploadInterval&&window.clearInterval(this.downlinkRelatedStatsUploadInterval),this.downlinkStatsUploadInterval=void 0,this.downlinkRelatedStatsUploadInterval=void 0)}stopUploadTransportStats(){this.uploadTransportStarted&&(this.uploadTransportStarted=!1,this.transportStatsUploadInterval&&window.clearInterval(this.transportStatsUploadInterval),this.transportStatsUploadInterval=void 0)}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.extensionUsageStatsUploadInterval&&window.clearInterval(this.extensionUsageStatsUploadInterval),this.extensionUsageStatsUploadInterval=void 0)}uploadDownlinkExtensionStats(e){e.forEach((e=>{let[t,i]=e;if(i.has(Fg.VIDEO)&&t.videoTrack){t.videoTrack.getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)}))}if(i.has(Fg.AUDIO)&&t.audioTrack){t.audioTrack.getProcessorStats().forEach((e=>{var t;null===(t=this.requestUpload)||void 0===t||t.call(this,e.type,e.stats)}))}}))}}function Bv(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Gv(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Bv(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Bv(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function Wv(e){var t,i,n,s=2;for("undefined"!=typeof Symbol&&(i=pI,n=Symbol.iterator);s--;){if(i&&null!=(t=e[i]))return t.call(e);if(n&&null!=(t=e[n]))return new Hv(t.call(e));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function Hv(e){function t(e){if(Object(e)!==e)return eg.reject(new TypeError(e+" is not an object."));var t=e.done;return eg.resolve(e.value).then((function(e){return{value:e,done:t}}))}return Hv=function(e){this.s=e,this.n=e.next},Hv.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var i=this.s.return;return void 0===i?eg.resolve({value:e,done:!0}):t(i.apply(this.s,arguments))},throw:function(e){var i=this.s.return;return void 0===i?eg.reject(e):t(i.apply(this.s,arguments))}},new Hv(e)}class Kv extends g{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Hg.StateChange,t,this._state)}constructor(e,i){super(),this.store=void 0,this.statsUploader=void 0,this.connection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.remoteDataChannelMap=new Map,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.statsCollector=void 0,this.isPlanB=!1,this.shouldForwardP2PCreation=void 0,this.iceFailedCount=0,this.dtlsFailedCount=0,this.mutex=new v("P2PChannel-mutex"),this._state=Wg.Disconnected,this._pcStatsUploadType=T("NEW_ICE_RESTART")?Bg.FIRST_CONNECTION:Bg.OLD_FIRST_CONNECTION,this._isInRestartIce=!1,this._isStartRestartIce=!1,this._restartStates=["disconnected","failed"],this._restartTimer=void 0,this._isFirstConnected=!0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Wg.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const n=this.filterTobeMutedTracks(e);if(0===n.length)return void t();const s=n.find((e=>"videoLowTrack"===e[0]));if(s){s[1].track._originMediaStreamTrack.stop()}await this.connection.muteLocal(n.map((e=>{let[,{id:t}]=e;return t})));const o=this.createMuteMessage(n);await le(this,Hg.RequestMuteLocal,o),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Wg.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const n=this.filterTobeUnmutedTracks(e);if(0===n.length)return void t();const s=n.find((e=>"videoLowTrack"===e[0]));if(s){const t=s[1];if(t.track._originMediaStreamTrack.stop(),!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ke().supportDualStreamEncoding){const i=e._mediaStreamTrack.clone();t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}else{const i=Rv(e,U(this,Hg.RequestLowStreamParameter));t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i}await new eg(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}await this.connection.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnmuteMessage(n);await le(this,Hg.RequestUnmuteLocal,o),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const i=this.localTrackMap.get(Gg.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==Wg.Connected)return void t();const{id:n,track:s}=i;await this.connection.updateSendParameters(n,s),await this.connection.updateEncoderConfig(n,s),this.emit(Hg.UpdateVideoEncoder,s),t()}catch(e){i(e)}finally{n()}},this.handleSetOptimizationMode=async(e,t,i)=>{const n=await this.mutex.lock("Locking from P2PChannel.handleSetOptimizationMode");try{const i=this.localTrackMap.get(Gg.LocalVideoTrack);if(!this.connection||!i||i.track!==e||this.state!==Wg.Connected)return;const{id:n,track:s}=i;await this.connection.updateSendParameters(n,s),t()}catch(e){i(e)}finally{n()}},this.handleReplaceTrack=async(e,i,n,s)=>{let o;t.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var r;const t=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.connection||!t||this.state!==Wg.Connected)return void i();if(await(null===(r=this.connection)||void 0===r?void 0:r.replaceTrack(e,t[1].id)),this.isPlanB){const i=t[1];i.id=e._mediaStreamTrack.id,this.localTrackMap.set(t[0],i)}if(t[0]===Gg.LocalVideoTrack&&!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ke().supportDualStreamEncoding){const t=this.localTrackMap.get(Gg.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new eg(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}i()}catch(e){n(e)}finally{var a;null===(a=o)||void 0===a||a()}},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new jv,this.bindStatsUploaderEvents(),this.isPlanB=!Ke().supportUnifiedPlan||T("CHROME_FORCE_PLAN_B")&&ae(),this.shouldForwardP2PCreation=T("FORWARD_P2P_CREATION")&&Ke().supportPCSetConfiguration&&he(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Uv({},this.store):this.isPlanB?new uv({},this.store):new Tv({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,i){var n;this.state=Wg.New;const s=this.shouldForwardP2PCreation&&"closed"===(null===(n=this.connection)||void 0===n?void 0:n.peerConnectionState);if(this.shouldForwardP2PCreation&&!s||(s&&this.connection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new Uv(e,this.store):this.isPlanB?new uv(e,this.store):new Tv(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=T("NEW_ICE_RESTART")?Bg.FIRST_CONNECTION:Bg.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,i,n,s,o){if(!this.connection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof Uv?this.connection.updateRemoteConnect(n):(this.store.peerConnectionStart(),await this.connection.connect(e,t,i,n,s,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Wg.Connected)}async preConnect(e,t,i,n,s,o){if(!this.connection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const r=await this.connection.connect(e,t,i,n,s,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Wg.Connected,r}getEstablishParams(){if(this.connection instanceof Uv)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection){if(this.state===Wg.Disconnected)throw new l(h.UNEXPECTED_ERROR,"PeerConnection already disconnected.");const t=e.filter((e=>-1!==this.pendingLocalDataChannels.findIndex((t=>t.id===e.id))));return void(this.pendingLocalDataChannels=this.pendingLocalDataChannels.concat(t))}const t=this.filterTobePublishedDataChannels(e);0!==t.length&&(t.forEach((e=>{const t=Date.now();this.store.publish(e.id.toString(),"datachannel",t)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((e=>{this.localDataChannels.push(e);const t=Date.now();this.store.publish(e.id+"","datachannel",void 0,t)})))}publish(e,t,i){var n=this;return lI((function*(){const s=yield hI(n.mutex.lock("From P2PChannel.publish"));try{if(!n.connection||n.state!==Wg.Connected){if(n.state===Wg.Disconnected)throw new l(h.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===n.pendingLocalTracks.indexOf(e)));return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(t))}n.store.pubId=n.store.pubId+1,YT.markPublishStart(n.store.clientId,n.store.pubId);const s=n.filterTobePublishedTracks(e,t,i);if(0===s.length)return void(yield hI(n.tryToUnmuteAudio(e)));yield*uI(Wv(n.doPublish(n.connection,s)))}finally{s()}}))()}doPublish(e,t){var i=this;return lI((function*(){t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===Gg.LocalAudioTrack?"audio":"video",s)})),i.bindLocalTrackEvents(t);const n=yield hI(e.send(t.map((e=>{let{track:t}=e;return t})),i.store.codec,i.store.audioCodec)),s=(yield hI(n.next())).value,o=i.createGatewayPublishMessage(t,s);let r;try{r=yield o}catch(e){throw n.throw(e),(null==e?void 0:e.code)===h.WS_ABORT&&t.forEach((e=>{let{track:t}=e;-1===i.pendingLocalTracks.indexOf(t)&&i.pendingLocalTracks.push(t)})),i.unbindLocalTrackEvents(t),e}const a=i.mapPubResToRemoteConfig(o,r),c=(yield hI(n.next(a))).value;t.forEach((e=>{let{type:t}=e;i.statsCollector.addLocalStats(t)})),i.assignLocalTracks(t,c),i.statsUploader.startUploadUplinkStats(),t.forEach((e=>{let{track:t,type:n}=e;const s=Date.now();i.store.publish(t.getTrackId(),n===Gg.LocalAudioTrack?"audio":"video",void 0,s)}))}))()}async updateVideoStreamParameter(e,i){const n=this.localTrackMap.get(i);if(!n)return;if(!(n.track instanceof We))return t.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof Tv||this.connection instanceof uv))return t.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:s}=n,o=function(e,t){const i={};return e.height&&e.width&&(i.scaleResolutionDownBy=aC(e,t)),i.maxFramerate=e.framerate?tC(e.framerate):void 0,i.maxBitrate=e.bitrate?1e3*e.bitrate:void 0,i}(e,s);if(s._encoderConfig||(s._encoderConfig={}),i!==Gg.LocalVideoLowTrack||!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ke().supportDualStreamEncoding)null!=o.scaleResolutionDownBy&&(s._encoderConfig.scaleResolutionDownBy=o.scaleResolutionDownBy);else{const i=s._originMediaStreamTrack;if(!i.canvas)return t.warn("[".concat(s.getTrackId(),"] no canvas on track"));!function(e,t){const i=e.canvas;t.width&&(i.width=tC(t.width)),t.height&&(i.height=tC(t.height)),t.framerate&&(i.stopCapture&&i.stopCapture(),i.stopCapture=Ye((()=>{!i.startCapture&&i.stopCapture&&i.stopCapture(),i.startCapture&&i.startCapture()}),tC(t.framerate)))}(i,e)}null!=o.maxBitrate&&(s._encoderConfig.bitrateMax=o.maxBitrate/1e3),null!=o.maxFramerate&&(s._encoderConfig.frameRate&&"object"==typeof s._encoderConfig.frameRate?s._encoderConfig.frameRate.max=o.maxFramerate:s._encoderConfig.frameRate={max:o.maxFramerate}),t.debug("[".concat(s.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(s._encoderConfig))),await this.connection.updateRtpSenderEncodings(s)}publishLowStream(e){var t=this;return lI((function*(){if(!t.connection||t.state!==Wg.Connected)return;const i=yield hI(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const i=t.localTrackMap.get(Gg.LocalVideoTrack);if(!i)throw new l(h.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(Gg.LocalVideoLowTrack))throw new l(h.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const s=[{track:t.getLowVideoTrack(i.track,e),type:Gg.LocalVideoLowTrack}];if(yield*uI(Wv(t.doPublish(t.connection,s))),i.track.muted||!i.track.enabled){var n;const e=null===(n=t.localTrackMap.get(Gg.LocalVideoLowTrack))||void 0===n?void 0:n.id;void 0!==e&&(yield hI(t.connection.muteLocal([e])))}}finally{i()}}))()}async republish(){this.pendingLocalTracks.length>0&&(t.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await b(this,Hg.RequestRePublish,this.pendingLocalTracks),this.emit(Hg.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(t.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await b(this,Hg.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){const{user:t,kind:i}=this.pendingRemoteTracks[e];(i!==Fg.AUDIO||t._audio_added_&&t._audioSSRC)&&(i!==Fg.VIDEO||t._video_added_&&t._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(e)await b(this,Hg.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:e,kind:t}of this.pendingRemoteTracks)await this.subscribe(e,t,t===Fg.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach((e=>{let{user:t}=e;this.emit(Hg.MediaReconnectEnd,t.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==Wg.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;const i=t.find((e=>"videoLowTrack"===e[0]));if(i){i[1].track.close()}return this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==Wg.Connected)return void e.forEach((e=>{const t=this.pendingLocalDataChannels.indexOf(e);-1!==t&&this.pendingLocalDataChannels.splice(t,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return 0!==t.length?(t.forEach((e=>{const t=this.localDataChannels.indexOf(e);-1!==t&&this.localDataChannels.splice(t,1)})),0===this.localDataChannels.length&&await this.connection.stopDataChannels(this.store.uid),t.map((e=>e.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==Wg.Connected)return;const e=this.localTrackMap.get(Gg.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[Gg.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((e=>{let[,{id:t}]=e;return t}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadUplinkStats(),i}async subscribeDataChannel(e,t){if(!this.connection||this.state!==Wg.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const i=t.filter((t=>{var i;return!(null!==(i=this.remoteDataChannelMap.get(e))&&void 0!==i&&i.get(t.id))}));if(0!==i.length)return await this.connection.createDataChannels(e.uid,i),i.forEach((t=>{var i;this.remoteDataChannelMap.has(e)?null===(i=this.remoteDataChannelMap.get(e))||void 0===i||i.set(t.id,t):this.remoteDataChannelMap.set(e,new Map([[t.id,t]]));const n=this.pendingRemoteDataChannels.findIndex((i=>{let{user:n,id:s}=i;return n.uid===e.uid&&s===t.id}));-1!==n&&this.pendingRemoteDataChannels.splice(n,1)})),i.map((e=>e.id))}async subscribe(e,i,n,s,o){var r;if(!this.connection||this.state!==Wg.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if(null!==(r=this.remoteUserMap.get(e))&&void 0!==r&&r.has(i))return;let a,c,d;if(o){const t=o.find((e=>{let{stream_type:t}=e;return t===i}));if(!t)throw new l(h.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(i," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(i,"."));const n=await this.connection.receive(i,t.ssrcs,String(e._uintid),t.attributes);this.connection instanceof Tv&&(d=n.transceiver),a=n.track,c=n.id}else{const t=await this.connection.receive(i,[{ssrcId:n,rtx:s}],String(e._uintid),void 0);this.connection instanceof Tv&&(d=t.transceiver),a=t.track,c=t.id}i===Fg.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(a):(e._audioTrack=new Xe(a,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),d&&e._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(a):(e._videoTrack=new ze(a,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),d&&e._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._videoTrack));const u=this.remoteUserMap.get(e);u?u.set(i,c):this.remoteUserMap.set(e,new Map([[i,c]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadDownlinkStats();const p=this.pendingRemoteTracks.findIndex((t=>{let{user:n,kind:s}=t;return n.uid===e.uid&&i===s}));-1!==p&&(this.pendingRemoteTracks.splice(p,1),this.emit(Hg.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==Wg.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((e=>{var t;let{user:i,mediaType:n}=e;return!(null!==(t=this.remoteUserMap.get(i))&&void 0!==t&&t.has(n))}));const i=await this.connection.batchReceive(e.map((e=>{let{user:t,mediaType:i,ssrcId:n,rtxSsrcId:s}=e;return{kind:i,ssrcMsg:[{ssrcId:n,rtx:s}],mslabel:String(t._uintid)}})));e.forEach(((e,n)=>{let{user:s,mediaType:o}=e;const{track:r,id:a,transceiver:c}=i[n];o===Fg.AUDIO?(s._audioTrack?s._audioTrack._updateOriginMediaStreamTrack(r):(s._audioTrack=new Xe(r,s.uid,s._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(s._audioTrack.getTrackId()))),c&&s._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(s,s._audioTrack)):(s._videoTrack?s._videoTrack._updateOriginMediaStreamTrack(r):(s._videoTrack=new ze(r,s.uid,s._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(s._videoTrack.getTrackId()))),c&&s._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(s,s._videoTrack));const d=this.remoteUserMap.get(s);d?d.set(o,a):this.remoteUserMap.set(s,new Map([[o,a]])),this.statsCollector.addRemoteStats(s.uid),this.statsUploader.startUploadDownlinkStats();const l=this.pendingRemoteTracks.findIndex((e=>{let{user:t,kind:i}=e;return t.uid===s.uid&&o===i}));-1!==l&&(this.pendingRemoteTracks.splice(l,1),this.emit(Hg.MediaReconnectEnd,s.uid))}))}async unsubscribe(e,t,i){const n=this.pendingRemoteTracks.filter((i=>{let{user:n,kind:s}=i;return void 0!==t?n.uid===e.uid&&t===s:n.uid===e.uid}));if(n.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.connection&&this.state===Wg.Connected||i||n.forEach((t=>{let{kind:i}=t;var n;if(i===Fg.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===Fg.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==Wg.Connected)return;const s=this.filterTobeUnSubscribedTracks(e,t);if(0===s.length)return;await this.connection.stopReceiving(s.map((e=>{let[,{id:t}]=e;return t})));const o=this.createUnsubscribeMessage(s);return this.withdrawRemoteTracks(s),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),s.forEach((e=>{let[t,{kind:n}]=e;var s,o;n===Fg.VIDEO&&t._videoSSRC&&(null===(s=this.connection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(n===Fg.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),i||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(n===Fg.AUDIO){var r;if(this.unbindRemoteTrackEvents(t._audioTrack),!i)null===(r=t._audioTrack)||void 0===r||r._destroy(),t._audioTrack=void 0}})),o}async unsubscribeDataChannel(e,t){if(t.forEach((e=>{const t=this.pendingRemoteDataChannels.findIndex((t=>t.id===e.id));-1!==t&&this.pendingRemoteDataChannels.splice(t,1)})),!this.connection)return;const i=this.filterTobeUnSubscribedDataChannels(e,t);if(0===i.length)return;t.forEach((e=>{e._close()}));const n=this.remoteDataChannelMap.get(e);return i.forEach((e=>{n&&n.delete(e.id)})),n&&0===n.size&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),i.map((e=>e.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:i,mediaType:n}of e){const e=this.pendingRemoteTracks.filter((e=>{let{user:t,kind:s}=e;return void 0!==n?t.uid===i.uid&&n===s:t.uid===i.uid}));e.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),t=t.concat(e)}if(!this.connection||this.state!==Wg.Connected)return void t.forEach((e=>{let{user:t,kind:i}=e;var n;if(i===Fg.AUDIO)null===(n=t._audioTrack)||void 0===n||n._destroy(),t._audioTrack=void 0;else if(i===Fg.VIDEO){var s;null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0}}));const i=Mp(e).call(e,((e,t)=>{let{user:i,mediaType:n}=t;const s=this.filterTobeUnSubscribedTracks(i,n);return e.concat(s)}),[]);if(0===i.length)return;await this.connection.stopReceiving(i.map((e=>{let[,{id:t}]=e;return t})));const n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),i.forEach((e=>{let[t,{kind:i}]=e;var n,s;i===Fg.VIDEO&&t._videoSSRC&&(null===(n=this.connection)||void 0===n||n.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(i===Fg.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),null===(s=t._videoTrack)||void 0===s||s._destroy(),t._videoTrack=void 0;else if(i===Fg.AUDIO){var o;this.unbindRemoteTrackEvents(t._audioTrack),null===(o=t._audioTrack)||void 0===o||o._destroy(),t._audioTrack=void 0}})),n}async muteRemote(e,i){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(i))return void t.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const s=i===Fg.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.connection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,i){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(i)||t.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(Gg.LocalAudioTrack);if((null==t?void 0:t.track)instanceof Le){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==Gg.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===Gg.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===Gg.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,s,o){if(e){const n=this.localTrackMap.get(Gg.LocalAudioTrack),r=s?this.localTrackMap.get(Gg.LocalVideoLowTrack):this.localTrackMap.get(Gg.LocalVideoTrack);i.publish(this.store.sessionId,{eventElapse:YT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==r?void 0:r.track.getTrackLabel(),screenshare:-1!==(null==r?void 0:r.track._hints.indexOf(He.SCREEN_TRACK)),audio:!!n,video:!!r,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var r;n||(n=[]);const a=n.find((e=>e instanceof Ge)),c=s?null===(r=this.localTrackMap.get(Gg.LocalVideoTrack))||void 0===r?void 0:r.track:n.find((e=>e instanceof We));i.publish(this.store.sessionId,{eventElapse:YT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==a?void 0:a.getTrackLabel(),videoName:null==c?void 0:c.getTrackLabel(),screenshare:-1!==(null==c?void 0:c._hints.indexOf(He.SCREEN_TRACK)),audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,n,s){const o=s===Fg.VIDEO?n._videoSSRC:n._audioSSRC;o&&i.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===Fg.VIDEO,audio:s===Fg.AUDIO,peerid:n.uid,subscribeRequestid:s===Fg.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:YT.measureFromSubscribeStart(this.store.clientId,o)})}reset(){t.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new v("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Uv({},this.store):this.isPlanB?new uv({},this.store):new Tv({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(Gg.LocalAudioTrack);if((null==e?void 0:e.track)instanceof Le){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Wg.Disconnected}getStats(){var e;return null===(e=this.connection)||void 0===e?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.connection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(Gg.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(Gg.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof We||t&&t.track instanceof Ge?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;const i=Array.from(CI(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(Gg.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=$C(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.connection&&(t.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Wg.Reconnecting,T("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new Uv({},this.store):this.isPlanB?new uv({},this.store):new Tv({},this.store),this.bindConnectionEvents(this.connection)),0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[i,{track:n}]=e;switch(i){case Gg.LocalVideoTrack:jo(t=n._hints).call(t,He.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case Gg.LocalAudioTrack:n instanceof Le?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case Gg.LocalVideoLowTrack:}})),this.emit(Hg.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(CI(i).call(i)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(Hg.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),0!==this.localDataChannels.length&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),0!==this.remoteDataChannelMap.size&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,i]=e;Array.from(CI(i).call(i)).forEach((e=>{this.setPendingRemoteDataChannel(t,e)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),t.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const i of this.pendingRemoteDataChannels){const{user:n,id:s}=i;if((e instanceof eI?e.uid:e)===n.uid&&s===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof eI?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return lI((function*(){if(!t.connection||t.state!==Wg.Connected||t.connection instanceof Uv)return;const i=yield hI(t.mutex.lock("From P2PChannel.restartICE"));let n;try{n=yield hI(t.connection.restartICE(e));const i=yield hI(n.next());if(i.done)return;const s=i.value,o=yield s;switch(t.reportPCDisconnectedOrFailed(e),e){case jg.TCP:t._pcStatsUploadType=Bg.TCP_RESTART;break;case jg.RELAY:t._pcStatsUploadType=Bg.RELAY_RESTART;break;default:t._pcStatsUploadType=Bg.OLD_RESTART}t._isInRestartIce=!0,n.next(o)}catch(e){var s;null===(s=n)||void 0===s||s.throw(e)}finally{i()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(Gg.LocalVideoTrack),i=this.localTrackMap.get(Gg.LocalAudioTrack),n=e.videoSend.find((e=>e.ssrc===(null==t?void 0:t.ssrcs[0].ssrcId))),s=e.audioSend.find((e=>e.ssrc===(null==i?void 0:i.ssrcs[0].ssrcId)));if(!n||!s)return 1;const o=D(this,Hg.NeedSignalRTT),r=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=r&&a?(r+a)/2:r||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(He.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return Yo[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,r=e.audioRecv.find((e=>e.ssrc===s)),a=e.videoRecv.find((e=>e.ssrc===o));if(!r&&!a)return void(t+=1);const c=D(this,Hg.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=r?r.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new eg(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],s=Ke(),o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=ue(e);let r=!1,a=!1;for(const o of e){if(o instanceof We&&(this.localTrackMap.has(Gg.LocalVideoTrack)||r?new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:Gg.LocalVideoTrack}),r=!0),t)){const e=this.getLowVideoTrack(o,i);n.push({track:e,type:Gg.LocalVideoLowTrack})}if(o instanceof Ge){const e=this.localTrackMap.get(Gg.LocalAudioTrack);if(e){if(!(e.track instanceof Le))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(a){const e=n.find((e=>{let{type:t}=e;return t===Gg.LocalAudioTrack}));if(!(e.track instanceof Le))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof Le||o._bypassWebAudio)n.push({track:o,type:Gg.LocalAudioTrack});else{const e=new Le;e.addAudioTrack(o),n.push({track:e,type:Gg.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=ue(e);for(const i of e){if(i instanceof Ge){const e=this.localTrackMap.get(Gg.LocalAudioTrack);if(!e)continue;e.track instanceof Le?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([Gg.LocalAudioTrack,e]),e.track.close())):t.push([Gg.LocalAudioTrack,e])}if(i instanceof We){const e=this.localTrackMap.get(Gg.LocalVideoTrack);if(!e)continue;t.push([Gg.LocalVideoTrack,e]);const i=this.localTrackMap.get(Gg.LocalVideoLowTrack);i&&t.push([Gg.LocalVideoLowTrack,i])}}return t}filterTobePublishedDataChannels(e){return e=(e=ue(e)).filter((e=>-1===this.localDataChannels.findIndex((t=>t.id===e.id))))}filterTobeUnpublishedDataChannels(e){return e=(e=(e=ue(e)).filter((e=>-1!==this.localDataChannels.indexOf(e)))).filter((e=>e._originDataChannel))}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Gg.LocalVideoTrack:t.addListener(Qe.GET_STATS,this.handleGetLocalVideoStats),t.addListener(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Qe.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(Qe.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(Qe.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Gg.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case Gg.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof Le?e.trackList.forEach((e=>{e.addListener(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Qe.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(Qe.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(Qe.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Gg.LocalVideoTrack:t.off(Qe.GET_STATS,this.handleGetLocalVideoStats),t.off(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Qe.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(Qe.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(Qe.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Gg.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case Gg.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof Le?e.trackList.forEach((e=>{e.off(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Qe.GET_STATS,this.handleGetLocalAudioStats),e.off(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(Qe.GET_STATS,this.handleGetLocalAudioStats),e.off(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Qe.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof ze&&t.addListener(Qe.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof Xe&&t.addListener(Qe.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Qe.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(Fg.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(Fg.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((e,i)=>{var n;let s,o,{track:r,type:a}=e;switch(a){case Gg.LocalAudioTrack:s=wg.Audio,o={dtx:r instanceof Je&&r._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Gg.LocalVideoTrack:s=jo(n=r._hints).call(n,He.SCREEN_TRACK)?wg.Screen:wg.High,o=Gv(Gv({},iC(r)),{},{codec:this.store.codec});break;case Gg.LocalVideoLowTrack:s=wg.Low,o=Gv(Gv({},iC(r)),{},{codec:this.store.codec})}return{stream_type:s,attributes:o,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Gg.LocalVideoTrack:i=jo(t=s._hints).call(t,He.SCREEN_TRACK)?wg.Screen:wg.High;break;case Gg.LocalAudioTrack:i=wg.Audio;break;case Gg.LocalVideoLowTrack:i=wg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}assignLocalTracks(e,t){e.forEach(((e,i)=>{let{track:n,type:s}=e;this.localTrackMap.set(s,{track:n,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{if(t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(i,")")),this.emit(Hg.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),"connected"===i&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),T("NEW_ICE_RESTART")){var n;if(jo(n=this._restartStates).call(n,i)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const i=i=>{if("disconnected"===e.iceConnectionState||"checking"===e.iceConnectionState||"failed"===e.iceConnectionState){t.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(i));"CONNECTED"===D(this,Hg.QueryClientConnectionState)&&this.emit(Hg.RequestRestartICE,i)}},n=()=>{"disconnected"!==e.iceConnectionState&&"checking"!==e.iceConnectionState&&"failed"!==e.iceConnectionState||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),t.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(Hg.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())},s=T("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout((()=>{if(T("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Ke().supportPCSetConfiguration)i(jg.RELAY),this._restartTimer=window.setTimeout(n,s);else if(I())i(jg.UDP),this._restartTimer=window.setTimeout(n,4e3);else{if(i(jg.TCP),Ke().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout((()=>{i(jg.RELAY),this._restartTimer=window.setTimeout(n,s)}),s));this._restartTimer=window.setTimeout(n,s)}}),800))}}else{if("disconnected"===i&&"disconnected"===e.iceConnectionState)return setTimeout((()=>{if("disconnected"===e.iceConnectionState&&T("ICE_RESTART")){"CONNECTED"===D(this,Hg.QueryClientConnectionState)&&this.emit(Hg.RequestRestartICE)}}),800),void setTimeout((()=>{"disconnected"===e.peerConnectionState&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout((()=>this.emit(Hg.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);"failed"===i&&(t.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout((()=>this.emit(Hg.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),i.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:X.TRACER}).onSuccess(),this.emit(Hg.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const o=Array.from(CI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var r;o&&(this.store.subscribe(o.uid,"audio",void 0,void 0,void 0,Date.now()),null===(r=o.audioTrack)||void 0===r||r.emit(Ze.FIRST_FRAME_DECODED),i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:o._uintid,subscribeElapse:YT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const o=Array.from(CI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));o&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:o._uintid,subscribeElapse:YT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{var t;const o=Array.from(CI(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));o&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:o._uintid,subscribeElapse:YT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,i)=>{const n="relay"===e.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(Hg.ConnectionTypeChange,n),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(cC(i))," -> ").concat(JSON.stringify(cC(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,i)=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(cC(i))," -> ").concat(JSON.stringify(cC(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(Gg.LocalAudioTrack);if(e instanceof Ge&&(null==i?void 0:i.track)instanceof Le)return i.track.isActive||t.push([Gg.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===Gg.LocalVideoTrack)){const e=this.localTrackMap.get(Gg.LocalVideoLowTrack);e&&t.push([Gg.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(Gg.LocalAudioTrack);if(e instanceof Ge&&(null==i?void 0:i.track)instanceof Le)return i.track.isActive&&t.push([Gg.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===Gg.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(Gg.LocalVideoLowTrack);e&&t.push([Gg.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Gg.LocalAudioTrack:i=wg.Audio;break;case Gg.LocalVideoTrack:i=jo(t=s._hints).call(t,He.SCREEN_TRACK)?wg.Screen:wg.High;break;case Gg.LocalVideoLowTrack:i=wg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}createUnmuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Gg.LocalAudioTrack:i=wg.Audio;break;case Gg.LocalVideoTrack:i=jo(t=s._hints).call(t,He.SCREEN_TRACK)?wg.Screen:wg.High;break;case Gg.LocalVideoLowTrack:i=wg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}filterTobeUnSubscribedDataChannels(e,t){const i=[];return t.forEach((t=>{var n;null!==(n=this.remoteDataChannelMap.get(e))&&void 0!==n&&n.has(t.id)&&i.push(t)})),i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case Fg.VIDEO:return void(i._videoSSRC&&t.push({stream_type:Fg.VIDEO,ssrcId:i._videoSSRC}));case Fg.AUDIO:return void(i._audioSSRC&&t.push({stream_type:Fg.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((e=>{let[i,{kind:n}]=e;if(t.has(i)){let e=t.get(i);n===Fg.VIDEO?e|=bg.Video:e|=bg.Audio,t.set(i,e)}else n===Fg.VIDEO?t.set(i,bg.Video):t.set(i,bg.Audio)})),{users:Array.from(t.entries()).map((e=>{let[t,i]=e;return{stream_id:t.uid,stream_type:i}}))}}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(Gg.LocalVideoTrack),i=this.localTrackMap.get(Gg.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.connection){return"connected"!==this.connection.peerConnectionState}return!0}mapPubResToRemoteConfig(e,t){return e.map(((e,i)=>{var n;let{stream_type:s}=e;return null===(n=t.find((e=>{let{stream_type:t}=e;return s===t})))||void 0===n?void 0:n.attributes}))}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof Ge){var t;const n=this.filterTobeUnmutedTracks(e[i]);if(0===n.length)continue;await(null===(t=this.connection)||void 0===t?void 0:t.unmuteLocal(n.map((e=>{let[,{id:t}]=e;return t}))));const s=this.createUnmuteMessage(n);return void await le(this,Hg.RequestUnmuteLocal,s)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.connection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Hg.RequestUploadStats,e,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await N(O(this.dtlsFailedCount,Z)),this.emit(Hg.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await b(this,Hg.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(Hg.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Gg.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof We))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof We)).length>1)throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof Ge)).length>1&&(e.some((e=>e instanceof Ge&&e._bypassWebAudio))||!Ke().webAudioMediaStreamDest))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof We&&this.pendingLocalTracks.some((e=>e instanceof We)))throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Ge&&this.pendingLocalTracks.some((e=>e instanceof Ge))&&(!Ke().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof Ge&&e._bypassWebAudio))))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ke().supportDualStreamEncoding,n=Gv(Gv({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():Rv(e,n);const o=M(8,"track-low-"),r=new We(s,Gv(Gv({},i&&{scaleResolutionDownBy:aC(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return r.on($e.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,et.LOW_STREAM)})),r._hints.push(He.LOW_STREAM),e.addListener(Qe.NEED_CLOSE,(()=>{r.close()})),r}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(this.connection&&this.connection instanceof Tv){var o,r,a,c;const d=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:l,dtlsTransportState:h,peerConnectionState:u}=this.connection,{local:p,remote:_}=await this.connection.getSelectedCandidatePair();i.pcStats(this.store.sessionId,{startTime:d,eventElapse:e-d||0,iceconnectionsate:l,dtlsstate:h,connectionstate:u,intSucc:t?1:2,error:s,selectedLocalCandidateProtocol:null!==(o=null==p?void 0:p.protocol)&&void 0!==o?o:"",selectedLocalCandidateType:null!==(r=p.candidateType)&&void 0!==r?r:"",selectedLocalCandidateAddress:"".concat(p.address,":").concat(p.port),selectedRemoteCandidateProtocol:null!==(a=_.protocol)&&void 0!==a?a:"",selectedRemoteCandidateType:null!==(c=_.candidateType)&&void 0!==c?c:"",selectedRemoteCandidateAddress:"".concat(_.address,":").concat(_.port),restartCnt:n})}}reportVideoFirstFrameDecoded(e,t,o,r){var a;const c=Array.from(CI(a=this.remoteUserMap).call(a)).find((t=>t._videoSSRC===e));if(c){r||this.store.subscribe(c.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,d=a.subscribe.find((e=>e.userId===c.uid&&"video"===e.type));i.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:c._uintid,videowidth:t,videoheight:o,subscribeElapse:YT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(null==d?void 0:d.subscribeEnd)||0,subscriberStart:(null==d?void 0:d.subscribeStart)||0,videoAddNotify:(null==d?void 0:d.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.connection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(e){t.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===Wg.Connected?(t.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===Dg.datachannel?new Uv({},this.store):this.isPlanB?new uv({},this.store):new Tv({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===Gg.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,et.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof Tv&&("disconnected"!==this.connection.iceConnectionState&&"checking"!==this.connection.iceConnectionState&&"failed"!==this.connection.iceConnectionState||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===Bg.TCP_RESTART&&e===jg.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,Bg.DISCONNECTED_OR_FAILED)))}}function qv(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PChannel.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}function Yv(e){let t=sy();return function(e,t){let i=e.appId;void 0!==i&&(Sy(t,10),hy(t,i));let n=e.cid;void 0!==n&&(Sy(t,16),Sy(t,n));let s=e.cname;void 0!==s&&(Sy(t,26),hy(t,s));let o=e.deviceId;void 0!==o&&(Sy(t,34),hy(t,o));let r=e.elapse;void 0!==r&&(Sy(t,40),gy(t,r));let a=e.fileSize;void 0!==a&&(Sy(t,48),gy(t,iy(a)));let c=e.height;void 0!==c&&(Sy(t,56),gy(t,iy(c)));let d=e.jpg;void 0!==d&&(Sy(t,66),Sy(t,d.length),function(e,t){let i=cy(e,t.length);e.bytes.set(t,i)}(t,d));let l=e.networkType;void 0!==l&&(Sy(t,72),gy(t,iy(l)));let h=e.osType;void 0!==h&&(Sy(t,80),gy(t,iy(h)));let u=e.requestId;void 0!==u&&(Sy(t,90),hy(t,u));let p=e.sdkVersion;void 0!==p&&(Sy(t,98),hy(t,p));let _=e.sequence;void 0!==_&&(Sy(t,104),gy(t,iy(_)));let E=e.sid;void 0!==E&&(Sy(t,114),hy(t,E));let m=e.timestamp;void 0!==m&&(Sy(t,120),gy(t,m));let f=e.uid;void 0!==f&&(Sy(t,128),Sy(t,f));let S=e.vid;void 0!==S&&(Sy(t,136),Sy(t,S));let g=e.width;void 0!==g&&(Sy(t,144),gy(t,iy(g)));let T=e.service;void 0!==T&&(Sy(t,152),Sy(t,T));let C=e.callbackData;void 0!==C&&(Sy(t,162),hy(t,C));let R=e.jpgEncryption;void 0!==R&&(Sy(t,168),Sy(t,R));let I=e.requestType;void 0!==I&&(Sy(t,176),Sy(t,I));let v=e.scorePorn;void 0!==v&&(Sy(t,185),my(t,v));let y=e.scoreSexy;void 0!==y&&(Sy(t,193),my(t,y));let A=e.scoreNeutral;void 0!==A&&(Sy(t,201),my(t,A));let w=e.scene;void 0!==w&&(Sy(t,208),Sy(t,w));let O=e.ossFilePrefix;void 0!==O&&(Sy(t,218),hy(t,O));let N=e.serviceVendor;if(void 0!==N)for(let e of N){Sy(t,226);let i=sy();zv(e,i),Sy(t,i.limit),uy(t,i),oy(i)}}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function Jv(e){return function(e){let t={};e:for(;!ay(e);){let i=fy(e);switch(i>>>3){case 0:break e;case 1:t.code=fy(e);break;case 2:t.msg=ly(e,fy(e));break;case 3:{let i=Qv(e);t.data=Xv(e),e.limit=i;break}default:Zv(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function Xv(e){let t={};e:for(;!ay(e);){let i=fy(e);switch(i>>>3){case 0:break e;case 1:t.requestId=ly(e,fy(e));break;case 2:t.requestType=fy(e)>>>0;break;case 3:t.scorePorn=Ey(e);break;case 4:t.scoreSexy=Ey(e);break;case 5:t.scoreNeutral=Ey(e);break;case 6:t.requestScene=fy(e)>>>0;break;case 7:t.scene=fy(e)>>>0;break;default:Zv(e,7&i)}}return t}function zv(e,t){let i=e.service;void 0!==i&&(Sy(t,8),Sy(t,i));let n=e.vendor;void 0!==n&&(Sy(t,16),Sy(t,n));let s=e.token;void 0!==s&&(Sy(t,26),hy(t,s));let o=e.callbackUrl;void 0!==o&&(Sy(t,34),hy(t,o))}function Qv(e){let t=fy(e),i=e.limit;return e.limit=e.offset+t,i}function Zv(e,t){switch(t){case 0:for(;128&py(e););break;case 2:ry(e,fy(e));break;case 5:ry(e,4);break;case 1:ry(e,8);break;default:throw new Error("Unimplemented type: "+t)}}dg([qv,lg("design:type",Function),lg("design:paramtypes",[Object,Boolean]),lg("design:returntype",eg)],Kv.prototype,"startP2PConnection",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[Object,Object,Array,Object,String,String]),lg("design:returntype",eg)],Kv.prototype,"connect",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[Object,Object,Array,Object,String,String]),lg("design:returntype",eg)],Kv.prototype,"preConnect",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Kv.prototype,"publishDataChannel",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Kv.prototype,"unpublish",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Kv.prototype,"unpublishDataChannel",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],Kv.prototype,"unpublishLowStream",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[eI,Array]),lg("design:returntype",eg)],Kv.prototype,"subscribeDataChannel",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[eI,String,Number,Number,Array]),lg("design:returntype",eg)],Kv.prototype,"subscribe",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Kv.prototype,"massSubscribe",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[eI,String,Boolean]),lg("design:returntype",eg)],Kv.prototype,"unsubscribe",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[eI,Array]),lg("design:returntype",eg)],Kv.prototype,"unsubscribeDataChannel",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],Kv.prototype,"massUnsubscribe",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[eI,String]),lg("design:returntype",eg)],Kv.prototype,"muteRemote",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[eI,String]),lg("design:returntype",eg)],Kv.prototype,"unmuteRemote",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[eI,String]),lg("design:returntype",eg)],Kv.prototype,"hasRemoteMediaWithLock",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],Kv.prototype,"disconnectForReconnect",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[Object]),lg("design:returntype",eg)],Kv.prototype,"updateBitrateLimit",null),dg([qv,lg("design:type",Function),lg("design:paramtypes",[eI,String,Number]),lg("design:returntype",eg)],Kv.prototype,"remoteMediaSsrcChanged",null);let $v=new Float32Array(1);new Uint8Array($v.buffer);let ey=new Float64Array(1),ty=new Uint8Array(ey.buffer);function iy(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let ny=[];function sy(){const e=ny.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function oy(e){ny.push(e)}function ry(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function ay(e){return e.offset>=e.limit}function cy(e,t){let i=e.bytes,n=e.offset,s=e.limit,o=n+t;if(o>i.length){let t=new Uint8Array(2*o);t.set(i),e.bytes=t}return e.offset=o,o>s&&(e.limit=o),n}function dy(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function ly(e,t){let i=dy(e,t),n=String.fromCharCode,s=e.bytes,o="ï¿½",r="";for(let e=0;e<t;e++){let a,c,d,l,h=s[e+i];0==(128&h)?r+=n(h):192==(224&h)?e+1>=t?r+=o:(a=s[e+i+1],128!=(192&a)?r+=o:(l=(31&h)<<6|63&a,l<128?r+=o:(r+=n(l),e++))):224==(240&h)?e+2>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],32896!=(49344&(a|c<<8))?r+=o:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?r+=o:(r+=n(l),e+=2))):240==(248&h)?e+3>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(a|c<<8|d<<16))?r+=o:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?r+=o:(l-=65536,r+=n(55296+(l>>10),56320+(1023&l)),e+=3))):r+=o}return r}function hy(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}Sy(e,n);let s=cy(e,n),o=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function uy(e,t){let i=cy(e,t.limit),n=e.bytes,s=t.bytes;for(let e=0,o=t.limit;e<o;e++)n[e+i]=s[e]}function py(e){return e.bytes[dy(e,1)]}function _y(e,t){let i=cy(e,1);e.bytes[i]=t}function Ey(e){let t=dy(e,8),i=e.bytes;return ty[0]=i[t++],ty[1]=i[t++],ty[2]=i[t++],ty[3]=i[t++],ty[4]=i[t++],ty[5]=i[t++],ty[6]=i[t++],ty[7]=i[t++],ey[0]}function my(e,t){let i=cy(e,8),n=e.bytes;ey[0]=t,n[i++]=ty[0],n[i++]=ty[1],n[i++]=ty[2],n[i++]=ty[3],n[i++]=ty[4],n[i++]=ty[5],n[i++]=ty[6],n[i++]=ty[7]}function fy(e){let t,i=0,n=0;do{t=py(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function Sy(e,t){for(t>>>=0;t>=128;)_y(e,127&t|128),t>>>=7;_y(e,t)}function gy(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=cy(e,o),a=e.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}function Ty(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}const Cy=new Map([["moderation",1],["supervise",2]]);class Ry extends g{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(Jg.CONNECTION_STATE_CHANGE,t,e)}get inspectType(){return this._inspectType}set inspectType(e){var t;this._inspectMode=Mp(t=e.map((e=>Cy.get(e)||0))).call(t,((e,t)=>e+t)),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(e){super(),this.name="AgoraRTCVideoContentInspect",this._connectionState=qg.CONNECTING,this._innerConnectionState=void 0,this.sequence=0,this.inspectStartTime=void 0,this.workerManagerConnection=void 0,this.workerConnection=void 0,this.workerMessageLengthLimit=void 0,this.inspectIntervalMinimum=void 0,this.qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=ut.CancelToken.source(),this._retryConfig=void 0,this.wmSequence=0,this.inspectInterval=void 0,this.inspectTimer=null,this.ossFilePrefix=void 0,this.extraInfo=void 0,this._inspectType=void 0,this._inspectMode=void 0,this._quality=1,this.qualityTimer=null,this._inspectId=void 0,this._needWorkUrlOnly=!1,this.inspectImage=()=>{if(this.connectionState!==qg.CONNECTED)throw new hg(h.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===qg.CONNECTED?this.requestToInspectImage():t.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()},this._inspectId=M(5,"inspect-"),this.workerMessageLengthLimit=T("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=T("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=T("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new vT("worker-manager-"+this._inspectId,Z),this.on(Jg.STATE_CHANGE,((e,i)=>{this._innerConnectionState=e,t.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Yg[e]," ").concat(i||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new vT("worker-"+this._inspectId,Z),this.handleWorkerEvents()}async init(e,t){this.emit(Jg.STATE_CHANGE,Yg.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new eg(((n,s)=>{this.on(Jg.CONNECTION_STATE_CHANGE,((e,t)=>{t===qg.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorkerManager(e)})).catch((e=>{s(e)}))}))}async requestAP(e,n,s){const o=T("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,n,s,o){let{appId:r,areaCode:a,cname:c,sid:d,token:l,uid:u}=n;bR++;const p="image_moderation_api",_={service_name:p,json_body:JSON.stringify({appId:r,areaCode:a,cname:c,command:"allocateEdge",requestId:bR,seq:bR,sid:d,token:l,ts:Date.now(),uid:u+""})};let E,m,f=e[0];return z((async()=>{E=Date.now();const e=await cR(f,{data:_,cancelToken:s,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(m=Date.now()-E,0!==e.code){const i=new hg(h.UNEXPECTED_RESPONSE,"image inspect ap error, code"+e.code,{retry:!0,responseTime:m});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new hg(h.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers||!Array.isArray(i.servers)||0===i.servers.length){const e=new hg(h.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:i.code,responseTime:m});throw t.error(e.toString()),e}const n=T("VIDEO_INSPECT_WORKER_MANAGER_HOST"),o=T("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:i.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(o||i)})).filter((e=>!!e)),workerToken:i.workerToken,vid:i.vid,responseTime:m}}),((t,n)=>(i.apworkerEvent(d,{success:!0,sc:200,serviceName:p,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:m,serverIp:e[n%e.length]}),!1)),((t,n)=>(i.apworkerEvent(d,{success:!1,sc:t.data&&t.data.code||200,serviceName:p,responseTime:m,serverIp:e[n%e.length]}),!!(t.code!==h.OPERATION_ABORTED&&t.code!==h.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(n+1)%e.length],!0))),o)}(o,e,n,s);this.emit(Jg.STATE_CHANGE,Yg.AP_CONNECTED);const{addressList:a}=r;return this.wmSequence++,a}async connectWorkerManager(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._needWorkUrlOnly=t,this.emit(Jg.STATE_CHANGE,Yg.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(e,1e4)}async connectWorker(e){await this.workerConnection.init([e])}handleWorkerManagerEvents(){this.workerManagerConnection.on(zS.CONNECTED,(async()=>{this.emit(Jg.STATE_CHANGE,Yg.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.19.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(zS.CLOSED,(()=>{this._innerConnectionState<Yg.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(zS.FAILED,(()=>{this._innerConnectionState<Yg.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(zS.RECONNECTING,(()=>{this._innerConnectionState<Yg.GET_WORKER_MANAGER_RESPONSE&&t.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(zS.ON_MESSAGE,(async e=>{this.emit(Jg.STATE_CHANGE,Yg.GET_WORKER_MANAGER_RESPONSE);const i=this.workerManagerConnection.url;this.workerManagerConnection.close();const n=JSON.parse(e.data);if(200!==n.code)throw t.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new hg(h.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&i))throw t.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new hg(h.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{const e=T("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,t=i.replace(/:\d+\/?$/,":".concat(e));this.emit(Jg.STATE_CHANGE,Yg.CONNECT_WORKER,t),this._needWorkUrlOnly?this.emit(Jg.REQUEST_NEW_WORKER_URL,t):await this.connectWorker(t)}})),this.workerManagerConnection.on(zS.WILL_RECONNECT,((e,t,i)=>{i(e)})),this.workerManagerConnection.on(zS.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}handleWorkerEvents(){this.workerConnection.on(zS.CONNECTED,(async()=>{this.emit(Jg.STATE_CHANGE,Yg.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=qg.CONNECTED})),this.workerConnection.on(zS.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const n=Jv(new Uint8Array(e.data));if(T("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&t.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),200===n.code){if(Array.isArray(this.inspectType)&&1===this.inspectType.length&&"supervise"===this.inspectType[0])return void this.emit(Jg.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var i;const e={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},t=Mp(i=Object.keys(e)).call(i,((t,i)=>e[t]>e[i]?t:i),"porn"),s=Object.keys(e).find((e=>e===t));this.emit(Jg.INSPECT_RESULT,s)}else this.emit(Jg.INSPECT_RESULT,void 0,new hg(h.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(Jg.INSPECT_RESULT,void 0,new hg(h.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else t.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Jg.INSPECT_RESULT,void 0,new hg(h.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(zS.CLOSED,(()=>{this.connectionState=qg.CLOSED})),this.workerConnection.on(zS.FAILED,(()=>{this.connectionState=qg.CLOSED})),this.workerConnection.on(zS.RECONNECTING,(()=>{this.connectionState=this.connectionState===qg.CONNECTED?qg.RECONNECTING:qg.CONNECTING})),this.workerConnection.on(zS.WILL_RECONNECT,((e,t,i)=>{"recover"===e&&i(e),i("tryNext")})),this.workerConnection.on(zS.REQUEST_NEW_URLS,((e,t)=>{this.workerManagerConnection.close(),this.once(Jg.REQUEST_NEW_WORKER_URL,(t=>{e([t])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((e=>{this.connectWorkerManager(e,!0)})).catch((e=>{t(e)}))}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){this.sequence++;const e=D(this,Jg.CLIENT_LOCAL_VIDEO_TRACK),t={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(Jg.INSPECT_RESULT,void 0,new hg(h.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(e,t);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(Jg.INSPECT_RESULT,void 0,new hg(h.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(e,i){let{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c}=i;const d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),h=await tt(l,n,s),u=this.sequence+"-"+o+"-"+c+"-"+d+"-"+M(12,""),p={appId:n,cid:o,cname:s,deviceId:"",elapse:Ry.intToLong(Number(d-this.inspectStartTime)),fileSize:h.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:h,networkType:6,osType:7,requestId:u,sdkVersion:"4.19.0",sequence:this.sequence,sid:a,timestamp:Ry.intToLong(d),uid:c,vid:r,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};void 0===this.extraInfo&&delete p.callbackData,void 0===this.ossFilePrefix&&delete p.ossFilePrefix;const _=Yv(p);if(_.byteLength<this.workerMessageLengthLimit){if(T("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ty(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ty(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},p);delete e.jpg,t.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(e))}return _}{const t=this.quality*this.qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ut.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=qg.CLOSED,this.emit(Jg.STATE_CHANGE,Yg.CLOSED)}}function Iy(e){let t=function(){const e=wy.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(e,t){let i=e.appId;void 0!==i&&(xy(t,10),ky(t,i));let n=e.cid;void 0!==n&&(xy(t,16),xy(t,n));let s=e.cname;void 0!==s&&(xy(t,26),ky(t,s));let o=e.deviceId;void 0!==o&&(xy(t,34),ky(t,o));let r=e.elapse;void 0!==r&&(xy(t,40),jy(t,r));let a=e.fileSize;void 0!==a&&(xy(t,48),jy(t,Ay(a)));let c=e.height;void 0!==c&&(xy(t,56),jy(t,Ay(c)));let d=e.jpg;void 0!==d&&(xy(t,66),xy(t,d.length),Py(t,d));let l=e.networkType;void 0!==l&&(xy(t,72),jy(t,Ay(l)));let h=e.osType;void 0!==h&&(xy(t,80),jy(t,Ay(h)));let u=e.requestId;void 0!==u&&(xy(t,90),ky(t,u));let p=e.sdkVersion;void 0!==p&&(xy(t,98),ky(t,p));let _=e.sequence;void 0!==_&&(xy(t,104),jy(t,Ay(_)));let E=e.sid;void 0!==E&&(xy(t,114),ky(t,E));let m=e.timestamp;void 0!==m&&(xy(t,120),jy(t,m));let f=e.uid;void 0!==f&&(xy(t,128),xy(t,f));let S=e.vid;void 0!==S&&(xy(t,136),xy(t,S));let g=e.width;void 0!==g&&(xy(t,144),jy(t,Ay(g)));let T=e.service;void 0!==T&&(xy(t,152),xy(t,T));let C=e.callbackData;void 0!==C&&(xy(t,162),xy(t,C.length),Py(t,C));let R=e.ticket;void 0!==R&&(xy(t,170),ky(t,R))}(e,t),function(e){let t=e.bytes,i=e.limit;return t.length===i?t:t.subarray(0,i)}(t)}function vy(e){return function(e){let t={};e:for(;!Ny(e);){let i=Vy(e);switch(i>>>3){case 0:break e;case 1:t.code=Vy(e);break;case 2:t.msg=Ly(e,Vy(e));break;case 3:t.requestId=Ly(e,Vy(e));break;case 4:t.timestamp=Fy(e,!1);break;default:yy(e,7&i)}}return t}({bytes:t=e,offset:0,limit:t.length});var t}function yy(e,t){switch(t){case 0:for(;128&My(e););break;case 2:Oy(e,Vy(e));break;case 5:Oy(e,4);break;case 1:Oy(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function Ay(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let wy=[];function Oy(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function Ny(e){return e.offset>=e.limit}function by(e,t){let i=e.bytes,n=e.offset,s=e.limit,o=n+t;if(o>i.length){let t=new Uint8Array(2*o);t.set(i),e.bytes=t}return e.offset=o,o>s&&(e.limit=o),n}function Dy(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function Py(e,t){let i=by(e,t.length);e.bytes.set(t,i)}function Ly(e,t){let i=Dy(e,t),n=String.fromCharCode,s=e.bytes,o="ï¿½",r="";for(let e=0;e<t;e++){let a,c,d,l,h=s[e+i];0==(128&h)?r+=n(h):192==(224&h)?e+1>=t?r+=o:(a=s[e+i+1],128!=(192&a)?r+=o:(l=(31&h)<<6|63&a,l<128?r+=o:(r+=n(l),e++))):224==(240&h)?e+2>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],32896!=(49344&(a|c<<8))?r+=o:(l=(15&h)<<12|(63&a)<<6|63&c,l<2048||l>=55296&&l<=57343?r+=o:(r+=n(l),e+=2))):240==(248&h)?e+3>=t?r+=o:(a=s[e+i+1],c=s[e+i+2],d=s[e+i+3],8421504!=(12632256&(a|c<<8|d<<16))?r+=o:(l=(7&h)<<18|(63&a)<<12|(63&c)<<6|63&d,l<65536||l>1114111?r+=o:(l-=65536,r+=n(55296+(l>>10),56320+(1023&l)),e+=3))):r+=o}return r}function ky(e,t){let i=t.length,n=0;for(let e=0;e<i;e++){let s=t.charCodeAt(e);s>=55296&&s<=56319&&e+1<i&&(s=(s<<10)+t.charCodeAt(++e)-56613888),n+=s<128?1:s<2048?2:s<65536?3:4}xy(e,n);let s=by(e,n),o=e.bytes;for(let e=0;e<i;e++){let n=t.charCodeAt(e);n>=55296&&n<=56319&&e+1<i&&(n=(n<<10)+t.charCodeAt(++e)-56613888),n<128?o[s++]=n:(n<2048?o[s++]=n>>6&31|192:(n<65536?o[s++]=n>>12&15|224:(o[s++]=n>>18&7|240,o[s++]=n>>12&63|128),o[s++]=n>>6&63|128),o[s++]=63&n|128)}}function My(e){return e.bytes[Dy(e,1)]}function Uy(e,t){let i=by(e,1);e.bytes[i]=t}function Vy(e){let t,i=0,n=0;do{t=My(e),i<32&&(n|=(127&t)<<i),i+=7}while(128&t);return n}function xy(e,t){for(t>>>=0;t>=128;)Uy(e,127&t|128),t>>>=7;Uy(e,t)}function Fy(e,t){let i,n=0,s=0,o=0;return i=My(e),n=127&i,128&i&&(i=My(e),n|=(127&i)<<7,128&i&&(i=My(e),n|=(127&i)<<14,128&i&&(i=My(e),n|=(127&i)<<21,128&i&&(i=My(e),s=127&i,128&i&&(i=My(e),s|=(127&i)<<7,128&i&&(i=My(e),s|=(127&i)<<14,128&i&&(i=My(e),s|=(127&i)<<21,128&i&&(i=My(e),o=127&i,128&i&&(i=My(e),o|=(127&i)<<7))))))))),{low:n|s<<28,high:s>>>4|o<<24,unsigned:t}}function jy(e,t){let i=t.low>>>0,n=(t.low>>>28|t.high<<4)>>>0,s=t.high>>>24,o=0===s?0===n?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:s<128?9:10,r=by(e,o),a=e.bytes;switch(o){case 10:a[r+9]=s>>>7&1;case 9:a[r+8]=9!==o?128|s:127&s;case 8:a[r+7]=8!==o?n>>>21|128:n>>>21&127;case 7:a[r+6]=7!==o?n>>>14|128:n>>>14&127;case 6:a[r+5]=6!==o?n>>>7|128:n>>>7&127;case 5:a[r+4]=5!==o?128|n:127&n;case 4:a[r+3]=4!==o?i>>>21|128:i>>>21&127;case 3:a[r+2]=3!==o?i>>>14|128:i>>>14&127;case 2:a[r+1]=2!==o?i>>>7|128:i>>>7&127;case 1:a[r]=1!==o?128|i:127&i}}const By={},Gy={},Wy=4294967296,Hy=0x10000000000000000,Ky=Hy/2,qy=Qy(0,!0),Yy=Qy(0),Jy=Zy(0,-2147483648,!1),Xy=Zy(-1,2147483647,!1),zy=Zy(-1,-1,!0);function Qy(e,t){let i,n,s;return t?(s=0<=(e>>>=0)&&e<256)&&(n=Gy[e],n)?n:(i=Zy(e,0,!0),s&&(Gy[e]=i),i):(s=-128<=(e|=0)&&e<128)&&(n=By[e],n)?n:(i=Zy(e,e<0?-1:0,!1),s&&(By[e]=i),i)}function Zy(e,t,i){return{low:0|e,high:0|t,unsigned:!!i}}function $y(e,t){if(isNaN(e))return t?qy:Yy;if(t){if(e<0)return qy;if(e>=Hy)return zy}else{if(e<=-Ky)return Jy;if(e+1>=Ky)return Xy}return e<0?t?qy:Yy:Zy(e%Wy|0,e/Wy|0,t)}function eA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}class tA extends g{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;const t=this._connectionState;this._connectionState=e,this.emit(eT.CONNECTION_STATE_CHANGE,e,t)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(e){var i;super(),this.name="AgoraRTCImageModeration",this._connectionState=$g.CONNECTING,this._sequence=0,this._moderationStartTime=void 0,this._workerConnection=void 0,this._workerMessageLengthLimit=void 0,this._qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=ut.CancelToken.source(),this._retryConfig=void 0,this._moderationInterval=void 0,this._moderationTimer=null,this._moderationMode=1,this._quality=1,this._qualityTimer=null,this._ticket=void 0,this._moderationIntervalMinimum=void 0,this._uploadFailedNum=0,this._uploadNum=0,this._uploadTimer=null,this._moderationId=void 0,this.inspectImage=()=>{if(this.connectionState!==$g.CONNECTED)throw new hg(h.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===$g.CONNECTED?this.requestToInspectImage():t.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()},this._moderationId=M(5,"image-moderation-"),this._workerMessageLengthLimit=T("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=T("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=null!==(i=e.interval)&&void 0!==i?i:1e3,this._qualityRatio=T("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new vT("worker-"+this._moderationId,Z),this.on(eT.STATE_CHANGE,((e,i)=>{t.debug("[".concat(this._moderationId,"] Moderation operation :").concat(tT[e]," ").concat(i||""))})),this.handleWorkerEvents()}async init(e,t){this.emit(eT.STATE_CHANGE,tT.CONNECT_AP),this._connectInfo=e;const i=this._cancelTokenSource.token;return this._retryConfig=t,new eg(((n,s)=>{this.on(eT.CONNECTION_STATE_CHANGE,((e,t)=>{e===$g.CONNECTED&&n()})),this.requestAP(e,i,t).then((e=>{this.connectWorker(e)})).catch((e=>{s(e)}))}))}updateConfig(e){var i;this._moderationInterval=null!==(i=e.interval)&&void 0!==i?i:1e3,t.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===$g.CONNECTED&&this.inspectImage()}async requestAP(e,n,s){const o=T("WEBCS_DOMAIN").map((e=>"https://".concat(e,"/api/v1"))),r=await function(e,n,s,o){let{appId:r,areaCode:a,cname:c,sid:d,token:l,uid:u}=n;bR++;const p="moderation_plugin",_={service_name:p,json_body:JSON.stringify({appId:r,areaCode:a,cname:c,command:"allocateEdge",requestId:bR,seq:bR,sid:d,appToken:l,ts:Date.now(),uid:u+""})};let E,m,f=e[0];return z((async()=>{E=Date.now();const e=await cR(f,{data:_,cancelToken:s,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(m=Date.now()-E,0!==e.code){const i=new hg(h.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+e.code,{retry:!0,responseTime:m});throw t.error(i.toString()),i}const i=JSON.parse(e.json_body);if(200!==i.code){const e=new hg(h.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(i.code,", reason: ").concat(i.reason),{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers||!Array.isArray(i.servers)||0===i.servers.length){const e=new hg(h.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:i.code,responseTime:m});throw t.error(e.toString()),e}if(!i.servers.some((e=>!!e.wss))){const e=new hg(h.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:i.code,responseTime:m});throw t.error(e.toString()),e}const n=T("IMAGE_MODERATION_WORKER_HOST");return{addressList:i.servers.map((e=>{let{address:t,wss:i}=e;if(t&&i)return"wss://".concat(t.replace(/\./g,"-"),".").concat(n,":").concat(i,"/moderation")})).filter((e=>!!e)),workerToken:i.workerToken,vid:i.vid,ticket:i.appTicket,responseTime:m}}),((t,n)=>(i.apworkerEvent(d,{success:!0,sc:200,serviceName:p,responseDetail:JSON.stringify(t.addressList),firstSuccess:0===n,responseTime:m,serverIp:e[n%e.length]}),!1)),((t,n)=>(i.apworkerEvent(d,{success:!1,sc:t.data&&t.data.code||200,serviceName:p,responseTime:m,serverIp:e[n%e.length]}),!!(t.code!==h.OPERATION_ABORTED&&t.code!==h.UNEXPECTED_RESPONSE||t.data&&t.data.retry)&&(f=e[(n+1)%e.length],!0))),o)}(o,e,n,s);this.emit(eT.STATE_CHANGE,tT.AP_CONNECTED);const{addressList:a,ticket:c}=r;return this._ticket=c,a}async connectWorker(e){this.emit(eT.STATE_CHANGE,tT.CONNECT_WORKER),await this._workerConnection.init(e,1e4)}handleWorkerEvents(){this._workerConnection.on(zS.CONNECTED,(async()=>{this.emit(eT.STATE_CHANGE,tT.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=$g.CONNECTED})),this._workerConnection.on(zS.CLOSED,(()=>{this.connectionState=$g.CLOSED})),this._workerConnection.on(zS.FAILED,(()=>{this.connectionState=$g.CLOSED})),this._workerConnection.on(zS.RECONNECTING,(()=>{this.connectionState=this.connectionState===$g.CONNECTED?$g.RECONNECTING:$g.CONNECTING})),this._workerConnection.on(zS.ON_MESSAGE,(async e=>{if(e.data instanceof ArrayBuffer){const n=vy(new Uint8Array(e.data));T("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,void 0===n.code||0===n.code||(this._uploadFailedNum++,t.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{i.reportApiInvoke(this._connectInfo.sid||null,{name:J.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:X.TRACER}).onError(new hg(h.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null}),T("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else t.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(zS.WILL_RECONNECT,((e,t,i)=>{"recover"===e&&i(e),i("tryNext")})),this._workerConnection.on(zS.REQUEST_NEW_URLS,((e,t)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(t)}))}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}async requestToInspectImage(){const e=D(this,eT.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(T("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("Only the track being played can be inspected"));this._sequence++;const n=await this.generateRequestData(e,i);this._workerConnection.sendMessage(n,!0,!0)}else T("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&t.debug("Only the track being published can be inspected")}async generateRequestData(e,i){let{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c}=i;const d=Date.now(),l=await e.getCurrentFrameImage("image/jpeg",this.quality),h=await tt(l,n,s),u=this._sequence+"-"+o+"-"+c+"-"+d+"-"+M(12,""),p={appId:n,cid:o,cname:s,deviceId:"",elapse:tA.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:h,networkType:6,osType:7,requestId:u,sdkVersion:"4.19.0",sequence:this._sequence,sid:a,timestamp:$y(d),uid:c,vid:r,service:this._moderationMode,ticket:this._ticket},_=Iy(p);if(_.byteLength<this._workerMessageLengthLimit){if(T("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const e=function(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?eA(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):eA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}({},p);delete e.jpg,t.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(e))}return _}{const t=this.quality*this._qualityRatio;return this.quality=t,await this.generateRequestData(e,{appId:n,cname:s,cid:o,vid:r,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ut.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=$g.CLOSED,this.emit(eT.STATE_CHANGE,tT.CLOSED)}}function iA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function nA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?iA(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):iA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}class sA extends oT{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,t;return null!==(e=null===(t=this.peerConnection.getReceivers()[0])||void 0===t||null===(t=t.transport)||void 0===t?void 0:t.state)&&void 0!==e?e:null}constructor(e,t,i){super(e,t),this.direction=void 0,this.store=void 0,this.peerConnection=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.mutex=new v("P2PConnection-mutex"),this.dataChannel=void 0,this.onLocalCandidate=void 0,this.store=t,this.peerConnection=new RTCPeerConnection(sA.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.direction=null!=i?i:XS.SEND_ONLY,this.dataChannel=this.peerConnection.createDataChannel("agora-p2p-signal",{ordered:!0}),this.statsFilter=dv(this.peerConnection,T("STATS_UPDATE_INTERVAL"),void 0,I()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(e){try{if(e){await this.peerConnection.setRemoteDescription({type:"offer",sdp:e});const t=await this.peerConnection.createAnswer();if(await this.peerConnection.setLocalDescription(t),!t.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");return t.sdp}{const e=await this.peerConnection.createOffer();if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");return await this.peerConnection.setLocalDescription(e),e.sdp}}catch(e){throw new l(h.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}}async connect(e){try{await this.peerConnection.setRemoteDescription({type:"answer",sdp:e})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(e.toString()))}}async addRemoteCandidate(e){try{await this.peerConnection.addIceCandidate(e)}catch(e){throw new l(h.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(e.toString()))}}async send(e){try{const t=[];e.forEach((e=>{const i=this.peerConnection.addTransceiver(e._mediaStreamTrack,{direction:"sendonly"});t.push(i)})),I()&&!0===T("SIMULCAST")&&await this.applySimulcastForFirefox(t,e),await this.applySimulcastEncodings(t,e),await this.applySendEncodings(t,e);const i=await this.peerConnection.createOffer();if(await this.peerConnection.setLocalDescription(i),!i.sdp)throw new Error("Cannot get offer.sdp when trying to send PeerConnection.");const n=t.map((e=>{const t=this.getLocalSSRC(e.mid,i.sdp);if(!t)throw new Error("Cannot get ssrc when trying to send PeerConnection.");return{mid:e.mid,localSSRC:[{ssrcId:t}]}}));return{sdp:i.sdp,trackMessage:n}}catch(e){throw e instanceof l?e:new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(e.toString()))}}async stopSending(e,t){const i=t?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{const t=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(t.length!==e.length)throw new Error("Transceivers' length (".concat(t.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));t.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e),this.peerConnection.removeTrack(e.sender)}));const i=await this.peerConnection.createOffer();if(await this.peerConnection.setLocalDescription(i),!i.sdp)throw new Error("Cannot get offer.sdp when trying to send PeerConnection.");return i.sdp}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(e.toString()))}finally{i&&i()}}async receive(e,i,n){try{await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");await this.peerConnection.setLocalDescription(s),t.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."));const o=this.getRemoteMid(n,i);if(void 0===o)throw new Error("Cannot get transceiver mid when trying to receive track.");const r=this.peerConnection.getTransceivers().find((e=>e.mid===o));if(!r||null===r.mid)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:r.receiver.track,mid:r.mid,sdp:s.sdp}}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(e.toString()))}}async setDescription(e,i){try{if("remote"===e){await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");return await this.peerConnection.setLocalDescription(n),t.debug("[".concat(this.store.clientId,"] [P2PConnection] exchanging SDP, type is ").concat(e)),n.sdp}await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection.setDescription failed; ".concat(e.toString()))}}async stopReceiving(e,t){try{const i=this.peerConnection.getTransceivers().filter((t=>-1!==e.indexOf(t.mid)));if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map((e=>{var t;e.direction="inactive",null===(t=e.stop)||void 0===t||t.call(e)})),await this.peerConnection.setRemoteDescription({type:"offer",sdp:t});const n=await this.peerConnection.createAnswer();if(await this.peerConnection.setLocalDescription(n),!n.sdp)throw new Error("Cannot get answer sdp when trying to receive track.");return n.sdp}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}async restartICE(){try{const e=await this.peerConnection.createOffer({iceRestart:!0});if(!e.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");return this.store.descriptionStart(),await this.peerConnection.setLocalDescription(e),e.sdp}catch(e){throw new l(h.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(e.toString()))}}close(){var e;this.peerConnection.close(),null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transportEventReceiver=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}async updateEncoderConfig(e,t){}async updateSendParameters(e,t){const i=this.peerConnection.getTransceivers().filter((t=>t.mid===e));1===i.length&&(this.isVP8Simulcast(t)?I()||await this.applySimulcastEncodings(i,[t]):await this.applySendEncodings(i,[t]))}setStatsRemoteVideoIsReady(e,t){this.statsFilter.setVideoIsReady2(e,t)}async replaceTrack(e,t){const i=this.peerConnection.getTransceivers().find((e=>e.mid===t));i&&await i.sender.replaceTrack(e._mediaStreamTrack)}async getSelectedCandidatePair(){const e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){const t=e[0].transport.iceTransport,{local:i,remote:n}=t.getSelectedCandidatePair();return{local:nA(nA({},YI),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:nA(nA({},YI),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;null===(e=this.onICEConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;null===(e=this.onConnectionStateChange)||void 0===e||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{var i;e.candidate&&(null===(i=this.onLocalCandidate)||void 0===i||i.call(this,e.candidate));e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,t.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),T("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){const t={iceServers:[]};return e.iceServers?t.iceServers=e.iceServers:e.turnServer&&"off"!==e.turnServer.mode&&(re(e.turnServer.servers)?t.iceServers=e.turnServer.servers:(t.iceServers&&t.iceServers.push(...sA.turnServerConfigToIceServers(e.turnServer.servers)),T("USE_TURN_SERVER_OF_GATEWAY")&&t.iceServers&&e.turnServer.serversFromGateway&&t.iceServers.push(...sA.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),T("FORCE_TURN_TCP")?t.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach((e=>{e.forceturn&&(t.iceTransportPolicy="relay")})))),T("ENABLE_ENCODED_TRANSFORM")&&Ke().supportWebRTCEncodedTransform&&(t.encodedInsertableStreams=!0),t}static turnServerConfigToIceServers(e){const t=[];return e.forEach((e=>{e.tcpport&&(t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turns:".concat($T(e.turnServerURL),":").concat(e.tcpport,"?transport=tcp")}),t.push({username:e.username,credential:e.password,credentialType:"password",urls:"turn:".concat(e.turnServerURL,":").concat(e.tcpport,"?transport=udp")}),t.push({username:e.username,credential:e.password,credentialType:"password",urls:"stun:".concat(e.turnServerURL,":").concat(e.tcpport)}))})),t}tryBindTransportEvents(e){const i=e.transport;if(i){this.transportEventReceiver=e,i.onstatechange=()=>{var e;null!=i&&i.state&&(null===(e=this.onDTLSTransportStateChange)||void 0===e||e.call(this,i.state))},i.onerror=e=>{var t;null===(t=this.onDTLSTransportError)||void 0===t||t.call(this,"error"in e?e.error:e)};const n=i.iceTransport;n&&(n.onstatechange=()=>{const e=null==i?void 0:i.iceTransport.state;var t;e&&(null===(t=this.onICETransportStateChange)||void 0===t||t.call(this,e))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:e,remote:i}=n.getSelectedCandidatePair();t.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:e.type,protocol:e.protocol}),", remote ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(e,i){var n;if(!i){i=this.peerConnection.getSenders().find((t=>t.track===e._mediaStreamTrack))}if(!i)return t.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return t.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ke().supportSetRtpSenderParameters)return t.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(e._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;default:s.degradationPreference="balanced"}if(e._encoderConfig){var r;const{bitrateMax:t,frameRate:i,scaleResolutionDownBy:n}=e._encoderConfig;t&&(o.maxBitrate=1e3*t),jo(r=e._hints).call(r,He.LOW_STREAM)&&(i&&(o.maxFramerate=tC(i)),n&&n>=1&&(o.scaleResolutionDownBy=n))}if(T("DSCP_TYPE")&&ae()){var a;const e=T("DSCP_TYPE");jo(a=["very-low","low","medium","high"]).call(a,e)&&(o.networkPriority=e)}const c=i.getParameters(),d=null===(n=c.encodings)||void 0===n?void 0:n[0];I()&&!d&&(s.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,s),t.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await i.setParameters(c)}async applySendEncodings(e,i){try{if(!Ke().supportSetRtpSenderParameters)return;if(e.length!==i.length)return;for(let t=0;t<e.length;t++){const n=e[t],s=i[t];s instanceof We&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,n.sender)}}catch(e){t.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(e,t,i){const n=II.parse(e);return t.forEach(((e,t)=>{const s=i[t],o=n.mediaDescriptions.find((e=>e.attributes.mid===s));o&&(DI(o,e),UI(o,e,this.store.codec))})),II.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var t;null===(t=this.onFirstAudioReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var t;null===(t=this.onFirstVideoReceived)||void 0===t||t.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var t;null===(t=this.onFirstAudioDecoded)||void 0===t||t.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,t,i)=>{var n;null===(n=this.onFirstVideoDecoded)||void 0===n||n.call(this,e,t,i)},this.statsFilter.onSelectedLocalCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedLocalCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,t)=>{var i;null===(i=this.onSelectedRemoteCandidateChanged)||void 0===i||i.call(this,e,t)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var t;null===(t=this.onFirstVideoDecodedTimeout)||void 0===t||t.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(e,t){if(e.length===t.length)for(let a=0;a<e.length;a++){var i,n,s,o,r;const c=e[a],d=t[a];if(d instanceof We&&!jo(i=d._hints).call(i,He.LOW_STREAM)&&null!==(n=d._encoderConfig)&&void 0!==n&&n.bitrateMax&&(null===(s=d._encoderConfig)||void 0===s?void 0:s.bitrateMax)>200&&null!==(o=d._scalabilityMode)&&void 0!==o&&o.numSpatialLayers&&(null===(r=d._scalabilityMode)||void 0===r?void 0:r.numSpatialLayers)>1&&"vp8"===this.store.codec){const e={},t={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};e.encodings=[{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:t.high}];const i=c.sender.getParameters();await c.sender.setParameters(Object.assign(i,e))}}}async applySimulcastEncodings(e,t){if(!I()&&e.length===t.length)for(let i=0;i<e.length;i++){const n=t[i];if(n instanceof We&&this.isVP8Simulcast(n)){const t=e[i],s={},o={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:o.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:o.medium,scaleResolutionDownBy:4}];const r=t.sender.getParameters();await t.sender.setParameters(Object.assign(r,s))}}}isVP8Simulcast(e){var t,i,n,s,o;return!!(e instanceof We&&T("SIMULCAST")&&"vp8"===this.store.codec&&!jo(t=e._hints).call(t,He.LOW_STREAM)&&null!==(i=e._encoderConfig)&&void 0!==i&&i.bitrateMax&&(null===(n=e._encoderConfig)||void 0===n?void 0:n.bitrateMax)>200&&null!==(s=e._scalabilityMode)&&void 0!==s&&s.numSpatialLayers&&(null===(o=e._scalabilityMode)||void 0===o?void 0:o.numSpatialLayers)>1)}logSDPExchange(e,i,n,s){if(T("SDP_LOGGING"))return t.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(s,"\n"),e),"offer"===i?e=>{this.logSDPExchange(e,"answer","local"===n?"remote":"local",s)}:void 0}getLocalSSRC(e,t){var i,n;if(t=null!==(i=t)&&void 0!==i?i:null===(n=this.currentLocalDescription)||void 0===n?void 0:n.sdp){var s;const i=null===(s=II.parse(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===s?void 0:s.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}getRemoteMid(e,t){var i,n;if(t=null!==(i=t)&&void 0!==i?i:null===(n=this.currentRemoteDescription)||void 0===n?void 0:n.sdp){var s;return null===(s=II.parse(t).mediaDescriptions.find((t=>t.attributes.ssrcs.some((t=>t.ssrcId===e)))))||void 0===s?void 0:s.attributes.mid}}async getRemoteSSRC(e,t){var i,n;if(t=null!==(i=t)&&void 0!==i?i:null===(n=this.currentRemoteDescription)||void 0===n?void 0:n.sdp){var s;const i=null===(s=II.parse(t).mediaDescriptions.find((t=>t.attributes.mid===e)))||void 0===s?void 0:s.attributes.ssrcs;return null==i?void 0:i[0].ssrcId}}}function oA(e,t,i){const n=e[t];if("function"!=typeof n)throw new Error("Cannot use mutex on object property.");return i.value=async function(){const e=this.mutex,i=await e.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,o=new Array(s),r=0;r<s;r++)o[r]=arguments[r];return await n.apply(this,o)}finally{i()}},i}var rA;function aA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function cA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?aA(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):aA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}dg([oA,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],sA.prototype,"establish",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],sA.prototype,"connect",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[RTCIceCandidate]),lg("design:returntype",eg)],sA.prototype,"addRemoteCandidate",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],sA.prototype,"send",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[String,String,Number]),lg("design:returntype",eg)],sA.prototype,"receive",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[String,String]),lg("design:returntype",eg)],sA.prototype,"setDescription",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[Array,String]),lg("design:returntype",eg)],sA.prototype,"stopReceiving",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],sA.prototype,"restartICE",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",void 0)],sA.prototype,"close",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],sA.prototype,"updateEncoderConfig",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[String,qe]),lg("design:returntype",eg)],sA.prototype,"updateSendParameters",null),dg([oA,lg("design:type",Function),lg("design:paramtypes",[qe,String]),lg("design:returntype",eg)],sA.prototype,"replaceTrack",null),function(e){e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY"}(rA||(rA={}));class dA extends g{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Hg.StateChange,t,this._state)}constructor(e,i){super(),this.store=void 0,this.statsUploader=void 0,this.sendConnection=void 0,this.recvConnection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.statsCollector=void 0,this.dtlsFailedCount=0,this.sendMutex=new v("P2PChannel2-send-mutex"),this.recvMutex=new v("P2PChannel2-recv-mutex"),this._state=Wg.Disconnected,this._restartStates=["disconnected","failed"],this._restartTimer=void 0,this.handleMuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Wg.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const n=this.filterTobeMutedTracks(e);if(0===n.length)return void t();const r=n.find((e=>"videoLowTrack"===e[0]));if(r){r[1].track._originMediaStreamTrack.stop()}let a=!1;var s,o;if("video"===e.trackMediaType)a=!(null===(s=this.localTrackMap.get(Gg.LocalAudioTrack))||void 0===s||!s.track._muted);else a=void 0===(null===(o=this.localTrackMap.get(Gg.LocalVideoTrack))||void 0===o?void 0:o.id);const c=n.filter((e=>{let[t,i]=e;return(t!==Gg.LocalAudioTrack||a)&&void 0!==i.id})).map((e=>{let[,t]=e;return t}));let d;c.length>0&&(d=await this.sendConnection.stopSending(c.map((e=>e.id))),c.forEach((e=>{e.id=void 0,e.ssrcs=void 0})));const u=this.createMuteMessage(n),p="video"===e.trackMediaType?nT.MUTE_LOCAL_VIDEO:nT.MUTE_LOCAL_AUDIO,_=await b(this,Hg.RequestP2PMuteLocal,{action:p,sdp:d,message:u,isMuteAll:a});_&&await this.sendConnection.setDescription("local",_),(d||"audio"===e.trackMediaType)&&await le(this,Hg.RequestMuteLocal,u),t()}catch(e){i(e)}finally{n()}},this.handleUnmuteLocalTrack=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Wg.Connected)return void i(new l(h.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const n=this.filterTobeUnmutedTracks(e);if(0===n.length)return void t();const s=this.createUnmuteMessage(n),o="video"===e.trackMediaType?nT.UNMUTE_LOCAL_VIDEO:nT.UNMUTE_LOCAL_AUDIO;await le(this,Hg.RequestP2PMuteLocal,{action:o,message:s}),t()}catch(e){i(e)}finally{n()}},this.handleUpdateVideoEncoder=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const i=this.localTrackMap.get(Gg.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==Wg.Connected)return void t();const{id:n,track:s}=i;n&&(await this.sendConnection.updateSendParameters(n,s),await this.sendConnection.updateEncoderConfig(n,s),this.emit(Hg.UpdateVideoEncoder,s)),t()}catch(e){i(e)}finally{n()}},this.handleSetOptimizationMode=async(e,t,i)=>{const n=await this.sendMutex.lock("Locking from P2PChannel2.handleSetOptimizationMode");try{const i=this.localTrackMap.get(Gg.LocalVideoTrack);if(!this.sendConnection||!i||i.track!==e||this.state!==Wg.Connected)return;const{id:n,track:s}=i;n&&await this.sendConnection.updateSendParameters(n,s),t()}catch(e){i(e)}finally{n()}},this.handleReplaceTrack=async(e,i,n,s)=>{let o;t.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(e.getTrackId(),"]")),"boolean"==typeof s&&s||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var r;const t=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(!this.sendConnection||!t||void 0===t[1].id||this.state!==Wg.Connected)return void i();if(await(null===(r=this.sendConnection)||void 0===r?void 0:r.replaceTrack(e,t[1].id)),t[0]===Gg.LocalVideoTrack&&Ke().supportDualStreamEncoding){const t=this.localTrackMap.get(Gg.LocalVideoLowTrack);if(t){const i=e._mediaStreamTrack.clone();t.track._originMediaStreamTrack.stop(),t.track._mediaStreamTrack=i,t.track._originMediaStreamTrack=i,await new eg(((e,i)=>{this.handleReplaceTrack(t.track,e,i,!0)}))}}i()}catch(e){n(e)}finally{var a;null===(a=o)||void 0===a||a()}},this.handleGetLocalVideoStats=e=>{e(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=e=>{e(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=e=>this.statsCollector.getRemoteVideoTrackStats(e.uid)[e.uid],this.handleGetRemoteAudioStats=e=>this.statsCollector.getRemoteAudioTrackStats(e.uid)[e.uid],this.store=e,this.statsCollector=i,this.statsCollector.addP2PChannel(this),this.statsUploader=new jv,this.bindStatsUploaderEvents()}async startP2PConnection(e,t){throw new l(h.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,i,n,s,o){throw new l(h.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,i){if(this.state=Wg.New,this.sendConnection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset P2PConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),this.recvConnection&&(t.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset P2PConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),this.sendConnection=new sA(e,this.store),this.bindConnectionEvents(this.sendConnection),this.recvConnection=new sA(e,this.store,XS.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection),i){this.store.peerConnectionStart(),await this.recvConnection.establish(i);const e=await this.sendConnection.establish(i);return this.statsUploader.startUploadTransportStats(!0),this.statsUploader.startUploadExtensionUsageStats(),this.state=Wg.Connected,e}return await this.recvConnection.establish(i),this.sendConnection.establish(i)}async p2pConnect(e){if(!this.sendConnection||!this.recvConnection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.recvConnection.connect(e),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Wg.Connected}async addRemoteCandidate(e){if(!this.sendConnection||!this.recvConnection)throw new l(h.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e),await this.sendConnection.addRemoteCandidate(e)}async publish(e,t,i){if(!this.sendConnection||this.state!==Wg.Connected){this.throwIfTrackTypeNotMatch(e);const t=e.filter((e=>-1===this.pendingLocalTracks.indexOf(e)));return void(this.pendingLocalTracks=this.pendingLocalTracks.concat(t))}this.store.pubId=this.store.pubId+1,YT.markPublishStart(this.store.clientId,this.store.pubId);const n=this.filterTobePublishedTracks(e,t,i);if(0===n.length)return void await this.tryToUnmuteAudio(e);n.forEach((e=>{let{track:t,type:i}=e;const n=Date.now();this.store.publish(t.getTrackId(),i===Gg.LocalAudioTrack?"audio":"video",n)})),this.bindLocalTrackEvents(n);const s=this.createGatewayPublishMessage(n);return this.assignLocalTracks(n),n.forEach((e=>{let{track:t,type:i}=e;const n=Date.now();this.store.publish(t.getTrackId(),i===Gg.LocalAudioTrack?"audio":"video",void 0,n)})),s}async dopublish(e){if(!this.sendConnection||this.state!==Wg.Connected)return;const t=this.localTrackMap.get(e);if(t){const{sdp:i,trackMessage:n}=await this.sendConnection.send([t.track]),{mid:s,localSSRC:o}=n[0];t.id=s,t.ssrcs=o,this.statsCollector.addLocalStats(e),this.statsUploader.startUploadUplinkStats();const r=await b(this,Hg.RequestP2PPublish,{kind:e===Gg.LocalAudioTrack?Fg.AUDIO:Fg.VIDEO,sdp:i,ssrcId:o[0].ssrcId});await this.sendConnection.setDescription("local",r);const a=this.createUnmuteMessage([[e,t]]);await le(this,Hg.RequestUnmuteLocal,a)}else;}async setDescription(e,t){let i,n;"local"===e?(i=await this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection):(i=await this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection);try{if(!n||this.state!==Wg.Connected)return;return await n.setDescription(e,t)}finally{i()}}publishLowStream(e){return lI((function*(){throw new l(h.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(t.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await b(this,Hg.RequestRePublish,this.pendingLocalTracks),this.emit(Hg.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublish(e){if(!this.sendConnection||this.state!==Wg.Connected)return void(0===e.length?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((t=>!jo(e).call(e,t))));const t=this.filterTobeUnpublishedTracks(e);if(0===t.length)return;this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}})));const i=t.filter((e=>{let[,{id:t}]=e;return void 0!==t}));if(!this.sendConnection||this.state!==Wg.Connected)return void e.forEach((e=>{const t=this.pendingLocalTracks.indexOf(e);-1!==t&&this.pendingLocalTracks.splice(t,1)}));const n=t.find((e=>"videoLowTrack"===e[0]));if(n){n[1].track.close()}let s;const o=this.createGatewayUnpublishMessage(t);i.length>0&&(s=await this.sendConnection.stopSending(i.map((e=>{let[,{id:t}]=e;return t})))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((e=>{let[t,{track:i}]=e;return{type:t,track:i}}))),t.forEach((e=>{let[t]=e;this.statsCollector.removeLocalStats(t)})),0===this.localTrackMap.size&&this.statsUploader.stopUploadUplinkStats();const r=this.createMuteMessage(t);return await eg.all(r.map((async e=>{await le(this,Hg.RequestMuteLocal,[e])}))),{sdp:s,unpubMsg:o}}async unpublishLowStream(){throw new l(h.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async doUnpublish(e){if(!this.sendConnection||this.state!==Wg.Connected)return;const t=[];if(e!==Fg.AUDIO){const e=this.localTrackMap.get(Gg.LocalVideoTrack);void 0!==(null==e?void 0:e.id)&&t.push([Gg.LocalVideoTrack,e]);const i=this.localTrackMap.get(Gg.LocalVideoLowTrack);void 0!==(null==i?void 0:i.id)&&t.push([Gg.LocalVideoLowTrack,i]),this.statsCollector.removeLocalStats(Gg.LocalVideoTrack),this.statsCollector.removeLocalStats(Gg.LocalVideoLowTrack)}if(e!==Fg.VIDEO){const e=this.localTrackMap.get(Gg.LocalAudioTrack);void 0!==(null==e?void 0:e.id)&&t.push([Gg.LocalAudioTrack,e]),this.statsCollector.removeLocalStats(Gg.LocalAudioTrack)}if(t.length>0){const i=await this.sendConnection.stopSending(t.map((e=>{let[,t]=e;return t.id})));t.forEach((e=>{let[,t]=e;t.id=void 0,t.ssrcs=void 0}));const n=await b(this,Hg.RequestP2PUnPublish,{sdp:i,kind:e});await this.sendConnection.setDescription("local",n);const s=this.createMuteMessage(t);await eg.all(s.map((async e=>{await le(this,Hg.RequestMuteLocal,[e])})))}else;}async subscribe(e,i,n,s){var o;if(!this.recvConnection||this.state!==Wg.Connected)throw new l(h.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if(null!==(o=this.remoteUserMap.get(e))&&void 0!==o&&o.has(i))return;const{track:r,mid:a,sdp:c}=await this.recvConnection.receive(i,n,s);i===Fg.AUDIO?(e._audioSSRC=s,e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(r):(e._audioTrack=new Xe(r,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=s,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(r):(e._videoTrack=new ze(r,e.uid,e._uintid,this.store),t.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),this.bindRemoteTrackEvents(e,e._videoTrack));const d=this.remoteUserMap.get(e);d?d.set(i,a):this.remoteUserMap.set(e,new Map([[i,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadDownlinkStats(),await le(this,Hg.RequestP2PUnmuteRemote,i);const u=this.pendingRemoteTracks.findIndex((t=>{let{user:n,kind:s}=t;return n.uid===e.uid&&i===s}));return-1!==u&&(this.pendingRemoteTracks.splice(u,1),this.emit(Hg.MediaReconnectEnd,e.uid)),c}async unsubscribe(e,t,i,n){const s=this.pendingRemoteTracks.filter((t=>{let{user:n,kind:s}=t;return void 0!==i?n.uid===e.uid&&i===s:n.uid===e.uid}));if(s.forEach((e=>{const t=this.pendingRemoteTracks.indexOf(e);this.pendingRemoteTracks.splice(t,1)})),this.recvConnection&&this.state===Wg.Connected||n||s.forEach((t=>{let{kind:i}=t;var n;if(i===Fg.AUDIO)null===(n=e._audioTrack)||void 0===n||n._destroy(),e._audioTrack=void 0;else if(i===Fg.VIDEO){var s;null===(s=e._videoTrack)||void 0===s||s._destroy(),e._videoTrack=void 0}})),!this.recvConnection||this.state!==Wg.Connected)return;const o=this.filterTobeUnSubscribedTracks(e,i);if(0===o.length)return void(i!==Fg.VIDEO&&le(this,Hg.RequestP2PMuteRemote,Fg.AUDIO));const r=await this.recvConnection.stopReceiving(o.map((e=>{let[,{id:t}]=e;return t})),t);return this.withdrawRemoteTracks(o),0===this.remoteUserMap.size&&this.statsUploader.stopUploadDownlinkStats(),o.forEach((e=>{let[t,{kind:i}]=e;var s,o;i===Fg.VIDEO&&t._videoSSRC&&(null===(s=this.recvConnection)||void 0===s||s.setStatsRemoteVideoIsReady(t._videoSSRC,!1));if(i===Fg.VIDEO)this.unbindRemoteTrackEvents(t._videoTrack),n||(null===(o=t._videoTrack)||void 0===o||o._destroy(),t._videoTrack=void 0);else if(i===Fg.AUDIO){var r;if(this.unbindRemoteTrackEvents(t._audioTrack),!n)null===(r=t._audioTrack)||void 0===r||r._destroy(),t._audioTrack=void 0}})),o.filter((e=>{let[,{kind:t}]=e;return t!==Fg.AUDIO})).forEach((e=>{let[,{kind:t}]=e;le(this,Hg.RequestP2PMuteRemote,t)})),i!==Fg.VIDEO&&le(this,Hg.RequestP2PMuteRemote,Fg.AUDIO),r}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new l(h.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,i){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(i))return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."));const s=i===Fg.VIDEO?e._videoSSRC:e._audioSSRC;void 0!==s&&this.recvConnection.setStatsRemoteVideoIsReady(s,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,i){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void t.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(i)||t.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(i,"."))}getAllTracks(e){const t=this.localTrackMap.get(Gg.LocalAudioTrack);if((null==t?void 0:t.track)instanceof Le){const i=t.track;return Array.from(this.localTrackMap.entries()).filter((e=>{let[t]=e;return t!==Gg.LocalAudioTrack})).filter((t=>{let[i]=t;return!(e&&i===Gg.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t})).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter((t=>{let[i]=t;return!(e&&i===Gg.LocalVideoLowTrack)})).map((e=>{let[,{track:t}]=e;return t}))}reportPublishEvent(e,t,n,s,o){if(e){const n=this.localTrackMap.get(Gg.LocalAudioTrack),r=s?this.localTrackMap.get(Gg.LocalVideoLowTrack):this.localTrackMap.get(Gg.LocalVideoTrack);i.publish(this.store.sessionId,{eventElapse:YT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==n?void 0:n.track.getTrackLabel(),videoName:null==r?void 0:r.track.getTrackLabel(),screenshare:-1!==(null==r?void 0:r.track._hints.indexOf(He.SCREEN_TRACK)),audio:!!n,video:!!r,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}else{var r;n||(n=[]);const a=n.find((e=>e instanceof Ge)),c=s?null===(r=this.localTrackMap.get(Gg.LocalVideoTrack))||void 0===r?void 0:r.track:n.find((e=>e instanceof We));i.publish(this.store.sessionId,{eventElapse:YT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:null==a?void 0:a.getTrackLabel(),videoName:null==c?void 0:c.getTrackLabel(),screenshare:-1!==(null==c?void 0:c._hints.indexOf(He.SCREEN_TRACK)),audio:!!a,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:o})}}reportSubscribeEvent(e,t,n,s){const o=s===Fg.VIDEO?n._videoSSRC:n._audioSSRC;o&&i.subscribe(this.store.sessionId,{succ:e,ec:t,video:s===Fg.VIDEO,audio:s===Fg.AUDIO,peerid:n.uid,subscribeRequestid:s===Fg.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:YT.measureFromSubscribeStart(this.store.clientId,o)})}reset(){t.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new v("P2PChannel2-send-mutex"),this.sendMutex=new v("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(Gg.LocalAudioTrack);if((null==e?void 0:e.track)instanceof Le){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((e=>{t.removeAudioTrack(e)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.state=Wg.Disconnected}getStats(e){var t,i;return e?null===(i=this.recvConnection)||void 0===i?void 0:i.getStats():null===(t=this.sendConnection)||void 0===t?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return(null===(t=this.recvConnection)||void 0===t?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(Gg.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(Gg.LocalVideoTrack);if(e)return{width:e.track._videoWidth||0,height:e.track._videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof We||t&&t.track instanceof Ge?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;const i=Array.from(CI(t=this.remoteUserMap).call(t)).find((t=>t.uid===e));return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((e=>{let[t]=e;return{uid:t.uid,level:t.audioTrack?100*t.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(Gg.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=$C(e).call(e,((e,t)=>e.level-t.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(t.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Wg.Reconnecting,T("KEEP_LAST_FRAME")&&0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&(null===(i=t._videoTrack._player.getVideoElement())||void 0===i||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,0!==this.localTrackMap.size&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[i,{track:n}]=e;switch(i){case Gg.LocalVideoTrack:jo(t=n._hints).call(t,He.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case Gg.LocalAudioTrack:n instanceof Le?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case Gg.LocalVideoLowTrack:}})),this.emit(Hg.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),0!==this.remoteUserMap.size&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;Array.from(CI(i).call(i)).forEach((e=>{this.setPendingRemoteMedia(t,e)})),this.emit(Hg.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.statsUploader.stopUploadUplinkStats(),this.statsUploader.stopUploadDownlinkStats(),this.statsUploader.stopUploadTransportStats(),t.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const i of this.pendingRemoteTracks){const{user:n,kind:s}=i;if((e instanceof eI?e.uid:e)===n.uid&&t===s)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e){let t;t=e.direction===XS.SEND_ONLY?await this.sendMutex.lock("From P2PChannel.restartICE"):await this.recvMutex.lock("From P2PChannel.restartICE");try{const t=await e.restartICE(),i=await b(this,Hg.RequestP2PRestartICE,t);e.setDescription("local",i)}finally{t()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(Gg.LocalVideoTrack),i=this.localTrackMap.get(Gg.LocalAudioTrack),n=e.videoSend.find((e=>{var i;return e.ssrc===(null==t||null===(i=t.ssrcs)||void 0===i?void 0:i[0].ssrcId)})),s=e.audioSend.find((e=>{var t;return e.ssrc===(null==i||null===(t=i.ssrcs)||void 0===t?void 0:t[0].ssrcId)}));if(!n||!s)return 1;const o=D(this,Hg.NeedSignalRTT),r=n?n.rttMs:void 0,a=s?s.rttMs:void 0,c=r&&a?(r+a)/2:r||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,h=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,u=null==t?void 0:t.track;if(u&&u._encoderConfig&&-1===u._hints.indexOf(He.SCREEN_TRACK)){const t=u._encoderConfig.bitrateMax,i=e.bitrate.actualEncoded;if(t&&i){const e=(1e3*t-i)/(1e3*t);return Yo[e<.15?0:e<.3?1:e<.45?2:e<.6?3:4][h]}}return h}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((i=>{let[n]=i;const s=n._audioSSRC,o=n._videoSSRC,r=e.audioRecv.find((e=>e.ssrc===s)),a=e.videoRecv.find((e=>e.ssrc===o));if(!r&&!a)return void(t+=1);const c=D(this,Hg.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,h=r?r.jitterMs:void 0,u=e.recvPacketLossRate;let p=.7*u*100/50+.3*l/1500;h&&(p=.6*u*100/50+.2*l/1500+.2*h/400);t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new eg(((t,i)=>{this.handleMuteLocalTrack(e,t,i)}))}filterTobePublishedTracks(e,t,i){const n=[],s=Ke(),o=this.getAllTracks();e=e.filter((e=>-1===o.indexOf(e))),e=ue(e);let r=!1,a=!1;for(const o of e){if(o instanceof We&&(this.localTrackMap.has(Gg.LocalVideoTrack)||r?new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:o,type:Gg.LocalVideoTrack}),r=!0),t)){const e=this.getLowVideoTrack(o,i);n.push({track:e,type:Gg.LocalVideoLowTrack})}if(o instanceof Ge){const e=this.localTrackMap.get(Gg.LocalAudioTrack);if(e){if(!(e.track instanceof Le))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o),this.bindLocalAudioTrackEvents(o,!0)}else if(a){const e=n.find((e=>{let{type:t}=e;return t===Gg.LocalAudioTrack}));if(!(e.track instanceof Le))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(o._bypassWebAudio)throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");e.track.addAudioTrack(o)}else{if(!s.webAudioMediaStreamDest||o instanceof Le||o._bypassWebAudio)n.push({track:o,type:Gg.LocalAudioTrack});else{const e=new Le;e.addAudioTrack(o),n.push({track:e,type:Gg.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(e){const t=[],i=this.getAllTracks();e=e.filter((e=>-1!==i.indexOf(e))),e=ue(e);for(const i of e){if(i instanceof Ge){const e=this.localTrackMap.get(Gg.LocalAudioTrack);if(!e)continue;e.track instanceof Le?(e.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),0===e.track.trackList.length&&(t.push([Gg.LocalAudioTrack,e]),e.track.close())):t.push([Gg.LocalAudioTrack,e])}if(i instanceof We){const e=this.localTrackMap.get(Gg.LocalVideoTrack);if(!e)continue;t.push([Gg.LocalVideoTrack,e]);const i=this.localTrackMap.get(Gg.LocalVideoLowTrack);i&&t.push([Gg.LocalVideoLowTrack,i])}}return t}bindLocalTrackEvents(e){e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Gg.LocalVideoTrack:t.addListener(Qe.GET_STATS,this.handleGetLocalVideoStats),t.addListener(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(Qe.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.addListener(Qe.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.addListener(Qe.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Gg.LocalAudioTrack:this.bindLocalAudioTrackEvents(t);case Gg.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof Le?e.trackList.forEach((e=>{e.addListener(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Qe.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(Qe.GET_STATS,this.handleGetLocalAudioStats),e.addListener(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(Qe.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((e=>{let[t,{track:i}]=e;return{track:i,type:t}}))),e.forEach((e=>{let{track:t,type:i}=e;switch(i){case Gg.LocalVideoTrack:t.off(Qe.GET_STATS,this.handleGetLocalVideoStats),t.off(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(Qe.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),t.off(Qe.SET_OPTIMIZATION_MODE,this.handleSetOptimizationMode),t.off(Qe.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Gg.LocalAudioTrack:this.unbindLocalAudioTrackEvents(t);case Gg.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof Le?e.trackList.forEach((e=>{e.off(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Qe.GET_STATS,this.handleGetLocalAudioStats),e.off(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(Qe.GET_STATS,this.handleGetLocalAudioStats),e.off(Qe.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(Qe.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(Qe.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(Qe.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(Qe.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof ze&&t.addListener(Qe.GET_STATS,(t=>{t(this.handleGetRemoteVideoStats(e))})),t instanceof Xe&&t.addListener(Qe.GET_STATS,(t=>{t(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(Qe.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,i]=e;i.has(Fg.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(Fg.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e){return e.map((e=>{var t;let i,n,{track:s,type:o}=e;switch(o){case Gg.LocalAudioTrack:i=wg.Audio,n={dtx:s instanceof Je&&s._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Gg.LocalVideoTrack:i=jo(t=s._hints).call(t,He.SCREEN_TRACK)?wg.Screen:wg.High,n=cA(cA({},iC(s)),{},{codec:this.store.codec});break;case Gg.LocalVideoLowTrack:i=wg.Low,n=cA(cA({},iC(s)),{},{codec:this.store.codec})}return{kind:o===Gg.LocalAudioTrack?Fg.AUDIO:Fg.VIDEO,stream_type:i,attributes:n,isMuted:s.muted||!s.enabled}}))}createGatewayUnpublishMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Gg.LocalVideoTrack:i=jo(t=s._hints).call(t,He.SCREEN_TRACK)?wg.Screen:wg.High;break;case Gg.LocalAudioTrack:i=wg.Audio;break;case Gg.LocalVideoLowTrack:i=wg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}assignLocalTracks(e){e.forEach((e=>{let{track:t,type:i}=e;this.localTrackMap.set(i,{track:t})}))}withdrawLocalTracks(e){e.forEach((e=>{let[t]=e;this.localTrackMap.delete(t)}))}bindConnectionEvents(e){e.onConnectionStateChange=async i=>{var n;if(t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(i,")")),this.emit(Hg.PeerConnectionStateChange,i),"connected"!==i||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),jo(n=this._restartStates).call(n,i)||e.direction===XS.SEND_ONLY){if(this._restartTimer)return;const i=()=>{if("disconnected"===e.iceConnectionState||"checking"===e.iceConnectionState||"failed"===e.iceConnectionState){t.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE"));"CONNECTED"===D(this,Hg.QueryClientConnectionState)&&this.restartICE(e)}};this._restartTimer=window.setTimeout((()=>{i(),this._restartTimer=void 0}),800)}else;},e.onICEConnectionStateChange=e=>{"connected"!==e||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),i.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:X.TRACER}).onSuccess(),this.emit(Hg.IceConnectionStateChange,e)},e.onICETransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},e.onDTLSTransportStateChange=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},e.onDTLSTransportError=e=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},e.onFirstAudioDecoded=e=>{var t;const o=Array.from(CI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));var r;o&&(this.store.subscribe(o.uid,"audio",void 0,void 0,void 0,Date.now()),null===(r=o.audioTrack)||void 0===r||r.emit(Ze.FIRST_FRAME_DECODED),i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_DECODE,s.FIRST_AUDIO_DECODE,{peer:o._uintid,subscribeElapse:YT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=e=>{var t;const o=Array.from(CI(t=this.remoteUserMap).call(t)).find((t=>t._audioSSRC===e));o&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_AUDIO_RECEIVED,s.FIRST_AUDIO_RECEIVED,{peer:o._uintid,subscribeElapse:YT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(e,t,i)=>{this.reportVideoFirstFrameDecoded(e,t,i)},e.onFirstVideoReceived=e=>{var t;const o=Array.from(CI(t=this.remoteUserMap).call(t)).find((t=>t._videoSSRC===e));o&&i.firstRemoteFrame(this.store.sessionId,n.FIRST_VIDEO_RECEIVED,s.FIRST_VIDEO_RECEIVED,{peer:o._uintid,subscribeElapse:YT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(e,i)=>{const n="relay"===e.candidateType,s="relay"===i.candidateType;"unknown"!==i.candidateType&&n===s||this.emit(Hg.ConnectionTypeChange,n),t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(cC(i))," -> ").concat(JSON.stringify(cC(e)),")"))},e.onSelectedRemoteCandidateChanged=(e,i)=>{t.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(cC(i))," -> ").concat(JSON.stringify(cC(e)),")"))},e.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},e.onLocalCandidate=e=>{this.emit(Hg.LocalCandidate,e)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}filterTobeMutedTracks(e){const t=[];if(-1===this.getAllTracks().indexOf(e))return t;const i=this.localTrackMap.get(Gg.LocalAudioTrack);if(e instanceof Ge&&(null==i?void 0:i.track)instanceof Le)return i.track.isActive||t.push([Gg.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n&&(t.push(n),n[0]===Gg.LocalVideoTrack)){const e=this.localTrackMap.get(Gg.LocalVideoLowTrack);e&&t.push([Gg.LocalVideoLowTrack,e])}return t}filterTobeUnmutedTracks(e){const t=[],i=this.localTrackMap.get(Gg.LocalAudioTrack);if(e instanceof Ge&&(null==i?void 0:i.track)instanceof Le)return i.track.isActive&&t.push([Gg.LocalAudioTrack,i]),t;const n=Array.from(this.localTrackMap.entries()).find((t=>{let[,{track:i}]=t;return e===i}));if(n)if(n[0]===Gg.LocalVideoTrack){t.push(n);const e=this.localTrackMap.get(Gg.LocalVideoLowTrack);e&&t.push([Gg.LocalVideoLowTrack,e])}else t.push(n);return t}createMuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Gg.LocalAudioTrack:i=wg.Audio;break;case Gg.LocalVideoTrack:i=jo(t=s._hints).call(t,He.SCREEN_TRACK)?wg.Screen:wg.High;break;case Gg.LocalVideoLowTrack:i=wg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}createUnmuteMessage(e){return e.map((e=>{var t;let i,[n,{track:s,ssrcs:o,id:r}]=e;switch(n){case Gg.LocalAudioTrack:i=wg.Audio;break;case Gg.LocalVideoTrack:i=jo(t=s._hints).call(t,He.SCREEN_TRACK)?wg.Screen:wg.High;break;case Gg.LocalVideoLowTrack:i=wg.Low}return{stream_type:i,ssrcs:o,mid:r}}))}filterTobeUnSubscribedTracks(e,t){const i=[],n=this.remoteUserMap.get(e);if(!n)return i;if(t){const s=n.get(t);if(!s)return i;i.push([e,{kind:t,id:s}])}else Array.from(n.entries()).forEach((t=>{let[n,s]=t;i.push([e,{kind:n,id:s}])}));return i}createUnsubscribeMessage(e){const t=[];return e.forEach((e=>{let[i,{kind:n,id:s}]=e;switch(n){case Fg.VIDEO:return void(i._videoSSRC&&t.push({stream_type:Fg.VIDEO,ssrcId:i._videoSSRC}));case Fg.AUDIO:return void(i._audioSSRC&&t.push({stream_type:Fg.AUDIO,ssrcId:i._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((e=>{let[t,{kind:i}]=e;const n=this.remoteUserMap.get(t);n&&(n.delete(i),0===Array.from(n.entries()).length&&this.remoteUserMap.delete(t))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(Gg.LocalVideoTrack),i=this.localTrackMap.get(Gg.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return"connected"!==e&&"connected"!==t}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof Ge){const i=this.filterTobeUnmutedTracks(e[t]);if(0===i.length)continue;const n=this.createUnmuteMessage(i);return void await le(this,Hg.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!(null===(t=this.recvConnection)||void 0===t||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Hg.RequestUploadStats,e,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await N(O(this.dtlsFailedCount,Z)),this.emit(Hg.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(Gg.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof We))}throwIfTrackTypeNotMatch(e){if(e.filter((e=>e instanceof We)).length>1)throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((e=>e instanceof Ge)).length>1&&(e.some((e=>e instanceof Ge&&e._bypassWebAudio))||!Ke().webAudioMediaStreamDest))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof We&&this.pendingLocalTracks.some((e=>e instanceof We)))throw new l(h.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Ge&&this.pendingLocalTracks.some((e=>e instanceof Ge))&&(!Ke().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((e=>e instanceof Ge&&e._bypassWebAudio))))throw new l(h.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const i=!T("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ke().supportDualStreamEncoding,n=cA(cA({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():Rv(e,n);const o=M(8,"track-low-"),r=new We(s,cA(cA({},i&&{scaleResolutionDownBy:aC(n,e)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return r.on($e.TRANSCEIVER_UPDATED,(t=>{e._updateRtpTransceiver(t,et.LOW_STREAM)})),r._hints.push(He.LOW_STREAM),e.addListener(Qe.NEED_CLOSE,(()=>{r.close()})),r}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,o,r){var a;const c=Array.from(CI(a=this.remoteUserMap).call(a)).find((t=>t._videoSSRC===e));if(c){r||this.store.subscribe(c.uid,"video",void 0,void 0,void 0,void 0,Date.now());const a=this.store.keyMetrics,d=a.subscribe.find((e=>e.userId===c.uid&&"video"===e.type));i.firstRemoteVideoDecode(this.store.sessionId,n.FIRST_VIDEO_DECODE,s.FIRST_VIDEO_DECODE,{peer:c._uintid,videowidth:t,videoheight:o,subscribeElapse:YT.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(null==d?void 0:d.subscribeEnd)||0,subscriberStart:(null==d?void 0:d.subscribeStart)||0,videoAddNotify:(null==d?void 0:d.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.recvConnection)return!1;const n=this.remoteUserMap.get(e);if(!n)return!1;const s=n.get(t);if(!s)return!1;const o=await this.recvConnection.getRemoteSSRC(s);return void 0!==o&&o!==i}resetConnection(e){t.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===Wg.Connected?(t.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new l(h.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new l(h.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new l(h.NOT_SUPPORTED)}async preConnect(e,t,i,n,s,o){throw new l(h.NOT_SUPPORTED)}getEstablishParams(){throw new l(h.NOT_SUPPORTED)}async reSubscribe(e){throw new l(h.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new l(h.NOT_SUPPORTED)}unbindRtpTransceiver(){0!==this.localTrackMap.size&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:i}]=e;t===Gg.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,et.LOW_STREAM):i._updateRtpTransceiver(void 0)}))}}function lA(e){return function(t,i,n){const s=t[i];if("function"!=typeof s)throw new Error("Cannot use mutex on object property.");return n.value=async function(){for(var t=arguments.length,n=new Array(t),o=0;o<t;o++)n[o]=arguments[o];switch(e){case rA.SEND_ONLY:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}case rA.RECEIVE_ONLY:{const e=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e()}}default:{const e=await this.sendMutex.lock("From P2PChannel2.".concat(i)),t=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await s.apply(this,n)}finally{e(),t()}}}},n}}function hA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function uA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?hA(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):hA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}dg([lA(),lg("design:type",Function),lg("design:paramtypes",[Object,String]),lg("design:returntype",eg)],dA.prototype,"startP2P",null),dg([lA(),lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],dA.prototype,"p2pConnect",null),dg([lA(rA.SEND_ONLY),lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],dA.prototype,"dopublish",null),dg([lA(rA.SEND_ONLY),lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],dA.prototype,"unpublish",null),dg([lA(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],dA.prototype,"unpublishLowStream",null),dg([lA(rA.SEND_ONLY),lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],dA.prototype,"doUnpublish",null),dg([lA(rA.RECEIVE_ONLY),lg("design:type",Function),lg("design:paramtypes",[eI,String,String,Number]),lg("design:returntype",eg)],dA.prototype,"subscribe",null),dg([lA(rA.RECEIVE_ONLY),lg("design:type",Function),lg("design:paramtypes",[eI,String,String,Boolean]),lg("design:returntype",eg)],dA.prototype,"unsubscribe",null),dg([lA(rA.RECEIVE_ONLY),lg("design:type",Function),lg("design:paramtypes",[eI,String]),lg("design:returntype",eg)],dA.prototype,"muteRemote",null),dg([lA(rA.RECEIVE_ONLY),lg("design:type",Function),lg("design:paramtypes",[eI,String]),lg("design:returntype",eg)],dA.prototype,"unmuteRemote",null),dg([lA(rA.RECEIVE_ONLY),lg("design:type",Function),lg("design:paramtypes",[eI,String]),lg("design:returntype",eg)],dA.prototype,"hasRemoteMediaWithLock",null),dg([lA(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],dA.prototype,"disconnectForReconnect",null),dg([lA(rA.RECEIVE_ONLY),lg("design:type",Function),lg("design:paramtypes",[eI,String,Number]),lg("design:returntype",eg)],dA.prototype,"remoteMediaSsrcChanged",null);const pA=Date.now(),_A=20,EA=new Map,mA=new Map;async function fA(e){const t=EA.get(e),i=Array.isArray(t)&&t[t.length-1],n=mA.get(e);if(!i)return void(n.isSyncing=!1);const s={uid:i.uid,payload:B(i.payload)};0===n.firstRecvTs&&(n.firstRecvTs=i.recvTs,n.firstSendTs=i.sendTs);const o=i.sendTs-n.firstSendTs,r=o-(Date.now()-n.firstRecvTs);r>0&&(n.firstRecvTs=Date.now()-o);let a=i.mediaDelay+r;a<=0?(t.pop(),SA(i.context,s),a=0):a=Math.min(a,_A),setTimeout((()=>t.length&&fA(e)),a)}function SA(e,t){e.safeEmit(pe.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function gA(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return SA(i,{uid:e.uid,payload:B(e.payload)});const n="".concat(i.id,"-").concat(e.uid),s=EA.get(n)||[],o=s.findIndex((t=>e.sendTs>=t.sendTs)),r=uA(uA({},e),{},{context:i,mediaDelay:t,recvTs:Date.now()});-1===o?s.push(r):s.splice(o,0,r),EA.set(n,s);let a=!1;var c;mA.has(n)?a=!(null===(c=mA.get(n))||void 0===c||!c.isSyncing):mA.set(n,{isSyncing:a,firstRecvTs:0,firstSendTs:0});a||fA(n)}function TA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function CA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?TA(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):TA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}v.setLogger(t);class RA extends g{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return(null===(e=this._config)||void 0===e?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let o;if(super(),this.store=void 0,this._uid=void 0,this._channelName=void 0,this._uintUid=void 0,this._users=[],this._config=void 0,this._clientId=void 0,this._appId=void 0,this._sessionId=null,this._key=void 0,this._joinInfo=void 0,this._gateway=void 0,this._statsCollector=void 0,this._configDistribute=void 0,this._leaveMutex=new v("client-leave"),this._publishMutex=new v("client-publish"),this._renewTokenMutex=new v("client-renewtoken"),this._subscribeMutex=new v("client-subscribe"),this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._proxyServer=void 0,this._turnServer={servers:[],mode:"auto"},this._cloudProxyServerMode="disabled",this._isDualStreamEnabled=!1,this._defaultStreamFallbackType=void 0,this._lowStreamParameter=void 0,this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._axiosCancelSource=ut.CancelToken.source(),this._audioVolumeIndicationInterval=void 0,this._networkQualityInterval=void 0,this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0,this._injectStreamingClient=void 0,this._liveTranscodeStreamingClient=void 0,this._liveRawStreamingClient=void 0,this._channelMediaRelayClient=void 0,this._networkQualitySensitivity="normal",this._p2pChannel=void 0,this._useLocalAccessPoint=!1,this._setLocalAPVersion=void 0,this._joinAndNotLeaveYet=!1,this._numberOfJoinCount=0,this._remoteDefaultVideoStreamType=void 0,this._inspect=void 0,this._moderation=void 0,this._license=void 0,this._pendingPublishedUsers=[],this.ntpAlignErrorCount=0,this.remoteInboundOffset=0,this._handleLocalTrackEnable=(e,t,i)=>{this.publish(e,!1).then(t).catch(i)},this._handleLocalTrackDisable=(e,t,i)=>{this.unpublish(e).then(t).catch(i)},this._handleUserOnline=e=>{if(T("BLOCK_LOCAL_CLIENT")&&Xo(e.uid,this.channelName))return void t.debug("[".concat(e.uid,"] will be ignored in local"));this.isStringUID&&"string"!=typeof e.uid&&t.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const i=this._users.find((t=>t.uid===e.uid));if(i)i._trust_in_room_=!0;else{const i=new eI(e.uid,e.uint_id||e.uid);this._users.push(i),t.debug("[".concat(this._clientId,"] user online"),e.uid),this.safeEmit(pe.USER_JOINED,i)}},this._handleUserOffline=e=>{if(T("BLOCK_LOCAL_CLIENT")&&Xo(e.uid,this.channelName))return;const i=this._users.find((t=>t.uid===e.uid));i&&(this._handleRemoveStream(e),this._handleRemoveDataChannels(e),Ee(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),t.debug("[".concat(this._clientId,"] user offline"),e.uid,"reason:",e.reason),this.safeEmit(pe.USER_LEAVED,i,e.reason))},this._handleAddAudioOrVideoStream=(e,o,r,a,c,d,l)=>{if(T("BLOCK_LOCAL_CLIENT")&&Xo(o,this.channelName))return;const h=this._users.find((e=>e.uid===o));if(!h)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));t.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(e)),this.store.subscribe(h.uid,e,void 0,void 0,void 0,Date.now());const u="audio"===e?h.hasAudio:h.hasVideo;h._uintid||(h._uintid=c||o),"audio"===e?h._trust_audio_stream_added_state_=!0:h._trust_video_stream_added_state_=!0,"audio"===e?(h._audio_added_=!0,void 0!==r&&(h._audioSSRC=r),void 0!==a&&(h._cname=a),d&&(h._audioOrtc=d)):(h._video_added_=!0,void 0!==r&&(h._videoSSRC=r),void 0!==a&&(h._cname=a),void 0!==l&&(h._rtxSsrcId=l),d&&(h._videoOrtc=d)),("audio"===e?h.hasAudio:h.hasVideo)&&!u&&(t.info("[".concat(this._clientId,"] remote user ").concat(h.uid," published ").concat(e)),this.safeEmit(pe.USER_PUBLISHED,h,e)),"video"===e?i.onGatewayStream(this._sessionId,n.ON_ADD_VIDEO_STREAM,s.ON_ADD_VIDEO_STREAM,{peer:c||o,ssrc:h._videoSSRC}):i.onGatewayStream(this._sessionId,n.ON_ADD_AUDIO_STREAM,s.ON_ADD_AUDIO_STREAM,{peer:c||o,ssrc:h._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(h,e,r).then((i=>{if(i&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(h.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Kv))return this._p2pChannel.unsubscribe(h,e,!0).then((()=>this._subscribe(h,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(h,e)&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(h.uid," after reconnect.")),this._subscribe(h,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._handleRemoveStream=(e,o,r)=>{if(T("BLOCK_LOCAL_CLIENT")&&Xo(e.uid,this.channelName))return;const a=this._users.find((t=>t.uid===e.uid));if(!a)return void t.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));t.debug("[".concat(this._clientId,"] stream removed with uid ").concat(e.uid));let c=()=>{};if(a.hasAudio&&a.hasVideo?c=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(a.uid," unpublished audio track")),this.safeEmit(pe.USER_UNPUBLISHED,a,"audio"),t.info("[".concat(this._clientId,"] remote user ").concat(a.uid," unpublished video track")),this.safeEmit(pe.USER_UNPUBLISHED,a,"video")}:a.hasVideo?c=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(a.uid," unpublished video track")),this.safeEmit(pe.USER_UNPUBLISHED,a,"video")}:a.hasAudio&&(c=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(a.uid," unpublished audio track")),this.safeEmit(pe.USER_UNPUBLISHED,a,"audio")}),a._trust_audio_stream_added_state_=!0,a._trust_video_stream_added_state_=!0,a._audio_added_=!1,a._video_added_=!1,this._p2pChannel instanceof Kv)this._p2pChannel.unsubscribe(a).then((e=>{if(e)return this._gateway.unsubscribe(e,a.uid)}));else if(o&&r)if(e.sdp){const{sdp:t}=e;this._p2pChannel.unsubscribe(a,t).then((e=>{e&&o(e)})).catch(r)}else o&&o();a._audioSSRC=void 0,a._videoSSRC=void 0,a._audioOrtc=void 0,a._videoOrtc=void 0,a._rtxSsrcId=void 0,i.onGatewayStream(this._sessionId,n.ON_REMOVE_STREAM,s.ON_REMOVE_STREAM,{peer:e.uint_id||e.uid}),c()},this._handleSetStreamLocalEnable=(e,i,n)=>{if(T("BLOCK_LOCAL_CLIENT")&&Xo(i,this.channelName))return;const s=this._users.find((e=>e.uid===i));if(!s)return void t.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));t.debug("[".concat(this._clientId,"] local ").concat(e," ").concat(n?"enabled":"disabled"," with uid ").concat(i));const o="audio"===e?s.hasAudio:s.hasVideo;if("audio"===e){s._trust_audio_enabled_state_=!0;const e=s._audio_enabled_;if(s._audio_enabled_=n,s._audio_enabled_===e)return;{const e=s._audio_enabled_?"enable-local-audio":"disable-local-audio";t.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(e)),this.safeEmit(pe.USER_INFO_UPDATED,i,e)}}else{s._trust_video_enabled_state_=!0;const e=s._video_enabled_;if(s._video_enabled_=n,s._video_enabled_===e)return;{const e=s._video_enabled_?"enable-local-video":"disable-local-video";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(e)),this.safeEmit(pe.USER_INFO_UPDATED,i,e)}}const r="audio"===e?s.hasAudio:s.hasVideo;return o!==r?!o&&r?(t.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(e)),void this.safeEmit(pe.USER_PUBLISHED,s,e)):("video"===e&&s._videoTrack&&s._videoTrack._destroy(),"audio"===e&&s._audioTrack,this._p2pChannel.muteRemote(s,e),t.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(e)),void this.safeEmit(pe.USER_UNPUBLISHED,s,e)):void 0},this._handleMuteStream=(e,i,n,s,o,r)=>{if(T("BLOCK_LOCAL_CLIENT")&&Xo(e,this.channelName))return;t.debug("[".concat(this._clientId,"] receive mute message"),e,i,n);const a=this._users.find((t=>t.uid===e));if(!a)return void t.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(e));const c="audio"===i?a.hasAudio:a.hasVideo;if("audio"===i){a._trust_audio_mute_state_=!0;const i=a._audio_muted_;if(a._audio_muted_=n,a._audio_muted_===i)return;{const i=a._audio_muted_?"mute-audio":"unmute-audio";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(i)),this.safeEmit(pe.USER_INFO_UPDATED,e,i)}}else{a._trust_video_mute_state_=!0;const i=a._video_muted_;if(a._video_muted_=n,a._video_muted_===i)return;{const i=a._video_muted_?"mute-video":"unmute-video";t.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(e,", msg: ").concat(i)),this.safeEmit(pe.USER_INFO_UPDATED,e,i)}}const d="audio"===i?a.hasAudio:a.hasVideo;if(c!==d){if(!c&&d){if(!this.store.useP2P){if(!("audio"===i?a._audioSSRC:a._videoSSRC))return void t.warning("[".concat(this._clientId,"] remote user ").concat(e," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."))}return t.info("[".concat(this._clientId,"] remote user ").concat(e," published ").concat(i)),void this.safeEmit(pe.USER_PUBLISHED,a,i)}"video"===i&&a._videoTrack&&a._videoTrack._destroy(),"audio"===i&&a._audioTrack,o&&r&&this._p2pChannel instanceof dA&&(s?this._p2pChannel.unsubscribe(a,s,i).then((e=>{o(e)})).catch(r):o()),this._p2pChannel.muteRemote(a,i),t.info("[".concat(this._clientId,"] remote user ").concat(e," unpublished ").concat(i)),this.safeEmit(pe.USER_UNPUBLISHED,a,i)}},this._handleP2PLost=async e=>{t.debug("[".concat(this._clientId,"] receive p2p lost"),e),parseInt(e.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():t.warning("[".concat(this._clientId,"] P2PLost stream not found"),e)},this._handleTokenWillExpire=()=>{t.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(pe.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)},this._handleBeforeUnload=e=>{"beforeunload"===e.type&&void 0!==e.returnValue&&""!==e.returnValue||(this.leave(),t.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))},this._handleUpdateNetworkQuality=()=>{if("normal"===this._networkQualitySensitivity)return;if(navigator&&void 0!==navigator.onLine&&!navigator.onLine)return void this.safeEmit(pe.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const e={downlinkNetworkQuality:0,uplinkNetworkQuality:0};e.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),e.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(pe.NETWORK_QUALITY,e)},this._handleP2PAddAudioOrVideoStream=(e,i)=>{const n=this._users.find((e=>e.uid===i));if(!n)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));t.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(e)),this.store.subscribe(n.uid,e,void 0,void 0,void 0,Date.now());const s="audio"===e?n.hasAudio:n.hasVideo;"audio"===e?n._trust_audio_stream_added_state_=!0:n._trust_video_stream_added_state_=!0,"audio"===e?n._audio_added_=!0:n._video_added_=!0,("audio"===e?n.hasAudio:n.hasVideo)&&!s&&(t.info("[".concat(this._clientId,"] remote user ").concat(n.uid," published ").concat(e)),this.safeEmit(pe.USER_PUBLISHED,n,e)),this._p2pChannel.hasPendingRemoteMedia(n,e)&&(t.debug("[".concat(this._clientId,"] resubscribe ").concat(e," for user ").concat(n.uid," after reconnect.")),this._subscribe(n,e,!0).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe error"),e.toString())})))},this._config=e,this._clientId=M(5,"client-"),this.store=new me(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),t.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(H," build: ").concat(fe,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{Se(e.clientRoleOptions),o=Object.assign({},e.clientRoleOptions)}catch(e){t.warning("[".concat(this._clientId,"] ").concat(e.toString()))}this._statsCollector=new zT(this.store),this._statsCollector.onStatsException=(e,i,n)=>{t.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(e,", msg: ").concat(i,", uid: ").concat(n)),this.safeEmit(pe.EXCEPTION,{code:e,msg:i,uid:n})},this._statsCollector.onUploadPublishDuration=(e,t,n,s)=>{const o=this._users.find((t=>t.uid===e));o&&i.peerPublishStatus(this._sessionId,{subscribeElapse:s,audioPublishDuration:t,videoPublishDuration:n,peer:o._uintid})},this.store.useDataChannel=Ke().supportDataChannel&&T("SIGNAL_CHANNEL"),this.store.useP2P=T("P2P"),this._gateway=new oR(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||Z,httpRetryConfig:e.httpRetryConfig||Z,forceWaitGatewayResponse:void 0===e.forceWaitGatewayResponse||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:o}),this._configDistribute=new WR,this.store.useP2P?(this._p2pChannel=new dA(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Kv(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,i,n,s){let o=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],r=arguments.length>6&&void 0!==arguments[6]&&arguments[6];K("JOIN_GATEWAY_USE_443PORT_ONLY",o),K("JOIN_GATEWAY_USE_DUAL_DOMAIN",r);const a=this._gateway.signal.websocket;return a instanceof IT&&(a.use443PortOnly=o,a.tryDoubleDomain=r),ge("client.join",T("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,i,n,s)}async join(e,n,s,o,r){const a=++this._numberOfJoinCount;this.store.joinStart(),o&&(this.store.uid=o);const c=Te(),d=Ce()?window.isSecureContext:"Browser Not Support";if(!Ce()&&!c||!window.isSecureContext){const e="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";t.warning(e)}const l=ee();"DISCONNECTED"===this.connectionState&&(this.store.avoidJoinStart=Math.round(Date.now()),t.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart)));const u=i.reportApiInvoke(l,{name:J.JOIN,options:[e,n,s,o],states:{isHttps:c,isSecureContext:d},tag:X.TRACER});i.setAppId(e);try{if(!s&&null!==s)throw new hg(h.INVALID_PARAMS,"Invalid token: ".concat(s,". If you don not use token, set it to null"));s&&f(s,"token",1,2047),f(e,"appid",1,2047),ug(n),o&&pg(o),r&&f(r,"optionalInfo",1,2047)}catch(e){throw u.onError(e),e}if(t.info("[".concat(this._clientId,"] start join channel ").concat(n,", join number: ").concat(a)),this._leaveMutex.isLocked){t.debug("[".concat(this._clientId,"] join: waiting leave operation"));(await this._leaveMutex.lock())(),t.debug("[".concat(this._clientId,"] join: continue"))}if(this._joinAndNotLeaveYet=!0,"DISCONNECTED"!==this.connectionState){const e=new hg(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw u.onError(e),e}this._sessionId||(this._sessionId=l,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const p=CA({clientId:this._clientId,appId:e,sid:this._sessionId,cname:n,uid:"string"!=typeof o?o:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:s||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint},void 0!==this._remoteDefaultVideoStreamType&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(p.setLocalAPVersion=this._setLocalAPVersion),"string"==typeof o&&(p.stringUid=o,this._uintUid?(p.uid=this._uintUid,this._uintUid=void 0):p.uid=0),"none"!==this._encryptionMode&&this._encryptionSecret){if(p.aesmode=this._encryptionMode,p.aespassword=await Re(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new hg(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(p.aessalt=this._encryptionSalt)}this._startSession(this._sessionId,{channel:n,appId:e});const _=this._sessionId;setTimeout((()=>{"CONNECTING"===this.connectionState&&_===this._sessionId&&i.joinChannelTimeout(this._sessionId,5)}),5e3);try{var E;let o;const r=p.cloudProxyServer;if(jo(E=["proxy3","proxy4","proxy5"]).call(E,r)){const e=T("PROXY_SERVER_TYPE3");Array.isArray(e)?p.proxyServer=e[0]:p.proxyServer=e}if(i.setProxyServer(p.proxyServer),t.setProxyServer(p.proxyServer),this.store.requestAPStart(),p.stringUid&&!p.uid){const e=await MR(p.stringUid,p,this._axiosCancelSource.token,this._config.httpRetryConfig||Z,this.store);t.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(p.stringUid," => ").concat(e)),p.uid=e,o=await kR(p,this._axiosCancelSource.token,this._config.httpRetryConfig||Z,!0,this.store)}else o=await kR(p,this._axiosCancelSource.token,this._config.httpRetryConfig||Z,!0,this.store);if(!this._joinAndNotLeaveYet)throw new hg(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(p,this._axiosCancelSource.token),this._configDistribute.on(Vg.UPDATE_BITRATE_LIMIT,(e=>{this._p2pChannel.updateBitrateLimit(e)}))}),0),this._key=s||e;const a=o.gatewayInfo;this._joinInfo=CA(CA({},p),{},{cid:a.cid,uid:p.uid?p.uid:a.uid,vid:a.vid,apResponse:a.res,uni_lbs_ip:a.uni_lbs_ip,gatewayAddrs:a.gatewayAddrs});const c=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new hg(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));u.onSuccess(c),this._appId=e,this._channelName=p.cname,this._uid=c,this.store.uid=c,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(se()?"beforeunload":"pagehide",this._handleBeforeUnload)}),0);const d=p.stringUid?"string uid: ".concat(p.stringUid,",uid: ").concat(p.uid):"uid: ".concat(this._uid);return t.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(n,",").concat(d)),setTimeout((()=>{t.startUpload()}),5e3),this.store.joinEnd(),m=this,jo(Jo).call(Jo,m)||Jo.push(m),c}catch(e){const i=Array.isArray(e)?e[0]:e;throw i&&i.code===h.OPERATION_ABORTED?t.warning("[".concat(this._clientId,"] join number: ").concat(a,", Joining channel failed, rollback"),i):t.error("[".concat(this._clientId,"] join number: ").concat(a,", Joining channel failed, rollback"),i),i.code!==h.OPERATION_ABORTED&&this._numberOfJoinCount===a&&(this._gateway.state="DISCONNECTED",this._reset()),u.onError(i),i}var m}_joinGateway(){if(!this._joinInfo||!this._key)throw new hg(h.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!("disabled"!==this._joinInfo.cloudProxyServer||this._joinInfo.proxyServer||!T("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then((e=>e)).catch((e=>{if(e.code===h.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,L.FALLBACK),e;if(e.code===h.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,L.FALLBACK),e;throw e})).then((e=>{if(e instanceof hg){if(e.code===h.INIT_WEBSOCKET_TIMEOUT){if(t.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new hg(h.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const e=T("PROXY_SERVER_TYPE3");if(Array.isArray(e))if(this._joinInfo.apUrl){const t=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),i=t.slice(t.length-2).join(".");e.forEach((e=>{this._joinInfo&&jo(e).call(e,i)&&(this._joinInfo.proxyServer=e)})),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=e[0])}else this._joinInfo.proxyServer=e[0];else this._joinInfo.proxyServer=e;const n=T("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);n&&n[1]&&"443"!==n[1]&&t.setProxyServer(this._joinInfo.proxyServer),"443"!==T("STATS_COLLECTOR_PORT").toString()&&i.setProxyServer(this._joinInfo.proxyServer);return i.reportApiInvoke(this._sessionId,{name:J.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:X.TRACER}).onSuccess(),this.safeEmit(pe.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),T("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach((e=>{"forceturn"in e&&(e.forceturn=!0)})),this._gateway.join(this._joinInfo,this._key)}if(t.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new hg(h.INVALID_OPERATION);return i.reportApiInvoke(this._sessionId,{name:J.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:X.TRACER}).onSuccess(),this._joinGateway()}return e})).then((e=>e))}async leave(){t.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(se()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){const t=Jo.indexOf(e);-1!==t&&Jo.splice(t,1)}(this);const e=await this._leaveMutex.lock();if("DISCONNECTED"===this.connectionState)return t.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave("CONNECTED"!==this.connectionState),t.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!Array.isArray(e)){if(!(e instanceof qe))return this._publishDataChannel(e);e=[e]}if(0===e.length)throw new hg(h.INVALID_PARAMS,"param list is empty");const n=e;if("audience"===this._gateway.role)throw new hg(h.INVALID_OPERATION,"audience can not publish stream");for(const e of n){if(!(e instanceof qe))throw new hg(h.INVALID_PARAMS,"parameter is not local track");if(!e._enabled&&i)throw new hg(h.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(e.getTrackId()))}t.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))));const s=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),i&&n.forEach((e=>{const t=this._configDistribute.getBitrateLimit();e instanceof We&&t&&e.setBitrateLimit(t.uplink)}));try{await this._publishHighStream(n),t.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((e=>"".concat(e.getTrackId()," ")))))}catch(e){throw t.error("[".concat(this._clientId,"] publish error"),e.toString()),e}finally{s()}}async _publishDataChannel(e){_(e.id,"id",0,65535,!0),E(e.ordered,"ordered"),f(e.metadata,"metadata",0,512),t.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const i=await this._publishMutex.lock();try{if(-1!==this._p2pChannel.getAllDataChannels().findIndex((t=>t.id===e.id)))throw new hg(h.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||void 0===this._uid)throw new hg(h.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&T("FORCE_TURN")&&!T("TURN_ENABLE_TCP")&&!T("TURN_ENABLE_UDP"))throw new hg(h.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const i=new it(e);await this._p2pChannel.publishDataChannel([i]);try{const t={streamId:e.id,ordered:e.ordered,maxRetransmits:T("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:i._originDataChannelId};await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==h.DISCONNECT_P2P)throw e}return await i._waitTillOpen(),t.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(e){throw t.error("[".concat(this._clientId,"] publish datachannels error"),e.toString()),e}finally{i()}}async unpublish(e){if(!this._joinInfo||void 0===this._uid)throw new hg(h.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let i=[];if(e)if(Array.isArray(e))i=e;else{if(!(e instanceof qe))return this._unpublishDataChannel([e]);i=[e]}else this.store.useP2P||await this._unpublishDataChannel(),i=this._p2pChannel.getAllTracks(!0);t.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(i.map((e=>"".concat(e.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof dA){const e=await this._p2pChannel.unpublish(i);if(e){const t=await this._gateway.sendExtensionMessage(iT.UNPUBLISH,e);t&&await this._p2pChannel.setDescription("local",t)}}else{const e=await this._p2pChannel.unpublish(i);e&&await this._gateway.unpublish(e,this._uid),t.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(i.map((e=>"".concat(e.getTrackId())))))}}catch(e){throw t.error("[".concat(this._clientId,"] unpublish error"),e.toString()),e}finally{n&&n()}}async _unpublishDataChannel(e){void 0!==e&&0!==e.length||(e=this._p2pChannel.getAllDataChannels()),t.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((e=>"".concat(e.id," ")))," "));const i=await this._publishMutex.lock();try{const i=await this._p2pChannel.unpublishDataChannel(e);i&&await this._gateway.unpublishDataChannel(i),t.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((e=>"".concat(e.id)))))}catch(e){throw t.error("[".concat(this._clientId,"] unpublish dataChannel error"),e.toString()),e}finally{i&&i()}}async subscribe(e,t,i){return"datachannel"===t?this._subscribeDataChannel(e,i):this._subscribe(e,t)}async _subscribeDataChannel(e,i){var n;if(_(i,"channelId",0,65535,!0),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e)))throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new hg(h.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&0===e._dataChannels.length)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new hg(h.INVALID_REMOTE_USER,"user is not published");const s=null===(n=e._dataChannels)||void 0===n?void 0:n.find((e=>e.id===i));if(!s)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new hg(h.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const i=await this._p2pChannel.subscribeDataChannel(e,[s]);if(i&&jo(i).call(i,s.id))try{var r;if(!s._originDataChannelId)throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new hg(h.REMOTE_USER_IS_NOT_PUBLISHED);const i={id:s.id,datachannelId:s._originDataChannelId,ordered:s.ordered,maxRetransmits:s.maxRetransmits,metadata:null!==(r=s.metadata)&&void 0!==r?r:""};await this._gateway.subscribeDataChannel(e.uid,i,!0)}catch(t){if((null==t?void 0:t.code)!==h.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[s]),t;await this._p2pChannel.unsubscribeDataChannel(e,[s]),this._p2pChannel.setPendingRemoteDataChannel(e,s.id)}return await s._waitTillOpen(),t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),s}finally{o()}}async _p2pSubscribe(e,i,n){if(m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const i=new hg(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new hg(h.INVALID_REMOTE_USER,"user is not published");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!n&&("audio"===i&&!e.hasAudio||"video"===i&&!e.hasVideo)){const n=new hg(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),n}const s=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));const o="audio"===i?Gg.LocalAudioTrack:this._joinInfo.defaultVideoStream===nt.LOW_STREAM?Gg.LocalVideoLowTrack:Gg.LocalVideoTrack;try{await this._p2pChannel.hasRemoteMediaWithLock(e,i)?await this._p2pChannel.unmuteRemote(e,i):(this.store.subscribe(e.uid,i,Date.now()),this._p2pChannel instanceof dA&&await this._gateway.sendExtensionMessage(iT.SUBSCRIBE,{trackType:o})),t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{t.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===i?e._audioTrack:e._videoTrack;if(!n)throw new hg(h.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw t.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{s()}}async _subscribe(e,i,n){if(this._p2pChannel instanceof dA)return this._p2pSubscribe(e,i);if(m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((t=>t===e))){const i=new hg(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),i}if(!e.hasAudio&&!e.hasVideo){const i=new hg(h.INVALID_REMOTE_USER,"user is not published");throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),i}if(!(n||("audio"!==i||e.hasAudio&&void 0!==e._audioSSRC)&&("video"!==i||e.hasVideo&&void 0!==e._videoSSRC))){const n=new hg(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(i,", remote track is not published")),n}let s="audio"===i?e._audioSSRC:e._videoSSRC,o="audio"===i?e._audioOrtc:e._videoOrtc,r="video"===i?e._rtxSsrcId:void 0,a={stream_type:"audio"===i?Fg.AUDIO:Fg.VIDEO,ssrcId:s};const c=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(i));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,i))await this._p2pChannel.unmuteRemote(e,i);else try{const t="audio"===i?e._audioSSRC:e._videoSSRC;void 0!==t&&t!==s&&(s=t,o="audio"===i?e._audioOrtc:e._videoOrtc,r="video"===i?e._rtxSsrcId:void 0,a={stream_type:"audio"===i?Fg.AUDIO:Fg.VIDEO,ssrcId:s}),YT.markSubscribeStart(this.store.clientId,s),this.store.subscribe(e.uid,i,Date.now()),await this._p2pChannel.subscribe(e,i,s,r,o);try{await this._gateway.subscribe(e.uid,a,!0)}catch(t){if((null==t?void 0:t.code)!==h.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,i),t;await this._p2pChannel.unsubscribe(e,i,!0),this._p2pChannel.setPendingRemoteMedia(e,i)}this.store.subscribe(e.uid,i,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,i)}catch(t){throw this._p2pChannel.reportSubscribeEvent(!1,null==t?void 0:t.code,e,i),t}t.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(i)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((e=>{t.warning("[".concat(this._clientId,"] auto set fallback failed"),e)}));const n="audio"===i?e._audioTrack:e._videoTrack;if(!n)throw new hg(h.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(i){throw t.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),i),i}finally{c()}}async massSubscribe(e){if(S(e,"subscribeList"),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't subscribe stream, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const n=Date.now(),s=new Map,o=await this._subscribeMutex.lock();t.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; ")));const r=(e=[...e]).map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i}})),a=await this._p2pChannel.globalLock();try{var c;for(let i=e.length-1;i>=0;i--){const n=e[i],{user:o,mediaType:a}=n;if(m(a,"mediaType",["audio","video"]),!o){const e=new hg(h.INVALID_PARAMS,"user property does not exist in subscribeList item");throw t.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),e}if(!this._users.find((e=>e===o))){const n=new hg(h.INVALID_REMOTE_USER,"user is not in the channel");t.error("[".concat(this._clientId,"] can not massSubscribe ").concat(o.uid,", this user is not in the channel")),r[i].error=n,e.splice(i,1);continue}if("audio"===a&&(!o.hasAudio||void 0===o._audioSSRC)||"video"===a&&(!o.hasVideo||void 0===o._videoSSRC)){const n=new hg(h.REMOTE_USER_IS_NOT_PUBLISHED);t.error("[".concat(this._clientId,"] can not subscribe ").concat(o.uid," with mediaType ").concat(a,", remote user is not published")),r[i].error=n,e.splice(i,1);continue}const c=bg.Video|bg.LwoVideo,d=s.get(o);if(d){if("video"===a?d&c:d&bg.Audio){e.splice(i,1),t.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(o.uid,", mediaType:").concat(a," twice"));continue}s.set(o,d|("video"===a?c:bg.Audio))}else s.set(o,"video"===a?c:bg.Audio)}for(let t=e.length-1;t>=0;t--){const i=e[t],{user:n,mediaType:o}=i,r=bg.Video|bg.LwoVideo;if(this._p2pChannel.hasRemoteMedia(n,o)){await this._p2pChannel.unmuteRemoteNoLock(n,o);const i=s.get(n);s.set(n,"video"===o?i^r:i^bg.Audio),e.splice(t,1)}}this.store.massSubscribe(e.map((e=>({userId:e.user.uid,type:e.mediaType}))),n);const o=Mp(c=Array.from(s.entries())).call(c,((e,t)=>{let[i,n]=t;if(0===n)return e;const s={stream_id:i.uid,stream_type:n};return n&bg.Audio&&(s.audio_ssrc=i._audioSSRC),n&bg.Video&&(s.video_ssrc=i._videoSSRC),e.push(s),e}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((e=>{let{user:t,mediaType:i}=e;return{user:t,mediaType:i,ssrcId:i===Fg.VIDEO?t._videoSSRC:t._audioSSRC,rtxSsrcId:i===Fg.VIDEO?t._rtxSsrcId:void 0}})));const s=new Map;if(o.length>0){const e=await this._gateway.subscribeAll(o,!0);((null==e?void 0:e.users)||[]).forEach((e=>{let{stream_id:t,video_error_code:i,audio_error_code:n,error_code:o}=e;(i||n||o)&&s.set(t,{video_error_code:i,audio_error_code:n,error_code:o})}))}if(Array.from(s.entries()).length>0){const e=Array.from(s.entries()).map((e=>{let t,[i,n]=e;n.error_code||n.video_error_code&&n.audio_error_code?t=void 0:n.video_error_code?t=Fg.VIDEO:n.audio_error_code&&(t=Fg.AUDIO);return{user:this.remoteUsers.find((e=>e.uid===i)),mediaType:t}}));await this._p2pChannel.massUnsubscribeNoLock(e)}for(const e of r){const i=s.get(e.user.uid);if(i){const n=i.error_code||"audio"===e.mediaType&&i.audio_error_code||"video"===e.mediaType&&i.video_error_code;if(n){const i=lT(n);t.error("user:".concat(e.user.uid," mediaType:").concat(e.mediaType," has massSubscribe error ").concat(i.desc)),e.error=new hg(h.SUBSCRIBE_FAILED,"code ".concat(n,": ").concat(i.desc))}}e.error||("video"===e.mediaType?e.track=e.user.videoTrack:e.track=e.user.audioTrack)}return this.store.massSubscribe(r.filter((e=>!e.error)).map((e=>({userId:e.user.uid,type:e.mediaType}))),void 0,Date.now()),r.forEach((e=>{var t;i.subscribe(this.store.sessionId,{succ:!!e.error,ec:(null===(t=e.error)||void 0===t?void 0:t.code)||null,video:e.mediaType===Fg.VIDEO,audio:e.mediaType===Fg.AUDIO,peerid:e.user.uid,subscribeRequestid:e.mediaType===Fg.VIDEO?e.user._videoSSRC:e.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-n)},!0)})),t.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i)})).join("; "))),r}catch(t){throw await this._p2pChannel.massUnsubscribeNoLock(e),t}}finally{a(),o()}}async unsubscribe(e,i,n){if(i||this.store.useP2P){if("datachannel"===i)return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(i&&m(i,"mediaType",["audio","video"]),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((t=>t===e))){const i=new hg(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}t.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(i));const s=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof dA)await this._gateway.sendExtensionMessage(iT.UNSUBSCRIBE,{mediaType:i});else{const n=await this._p2pChannel.unsubscribe(e,i);n&&await this._gateway.unsubscribe(n,e.uid),t.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(i))}}catch(i){if(i.code===h.DISCONNECT_P2P)return void t.warning("disconnecting p2p, abort unsubscribe request.");throw t.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}finally{s()}}async _unsubscribeDataChannel(e,i){if(i&&_(i,"id",0,65535,!0),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((t=>t===e))){const i=new hg(h.INVALID_REMOTE_USER,"user is not in the channel");throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}let n;if("number"==typeof i){const t=e._dataChannels.find((e=>e.id===i));t&&(n=[t])}else n=e._dataChannels;if(void 0===n){const n=new hg(h.REMOTE_USER_IS_NOT_PUBLISHED);throw t.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(i,", remote datachannel is not published")),n}t.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(n.map((e=>e.id))));try{const i=await this._p2pChannel.unsubscribeDataChannel(e,n);i&&await this._gateway.unsubscribeDataChannel(i,e.uid),t.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===h.DISCONNECT_P2P)return void t.warning("disconnecting p2p, abort unsubscribe request.");throw t.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}}async massUnsubscribe(e){if(S(e,"unsubscribeList"),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");t.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join())),e=[...e];const i=new Map;for(let n=e.length-1;n>=0;n--){const{user:s,mediaType:o}=e[n];if(!s){const e=new hg(h.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw t.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),e}m(o,"mediaType",["video","audio",void 0]);if(!this._users.find((e=>e===s))){t.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(s.uid,", user is not in the channel")),e.splice(n,1);continue}const r=bg.Video|bg.LwoVideo;if(i.has(s)){const a=i.get(s);let c;switch(o){case"video":c=a&r;break;case"audio":c=a&bg.Audio;break;default:c=a&(bg.Audio|r)}if(c){t.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(s.uid,",mediaType:").concat(o," twice.")),e.splice(n,1);continue}o?"audio"===o?i.set(s,a|bg.Audio):"video"===o&&i.set(s,a|r):i.set(s,a|bg.Audio|r)}else o?"audio"===o?i.set(s,bg.Audio):"video"===o&&i.set(s,r):i.set(s,bg.Audio|r)}try{const i=await this._p2pChannel.massUnsubscribe(e);i&&await this._gateway.massUnsubscribe(i),t.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((e=>{let{user:t,mediaType:i}=e;return"user: ".concat(null==t?void 0:t.uid,", mediaType: ").concat(i,";")})).join()))}catch(e){if(e.code===h.DISCONNECT_P2P)return void t.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw t.error("[".concat(this._clientId,"] massUnsubscribe error"),e.toString()),e}}async setLowStreamParameter(e){st(e),(!e.width&&e.height||e.width&&!e.height)&&t.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),t.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const i=this._configDistribute.getLowStreamConfigDistribute();if(i&&i.bitrate&&e.bitrate&&i.bitrate<e.bitrate&&(e.bitrate=i.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,Gg.LocalVideoLowTrack)}async enableDualStream(){if(!Ke().supportDualStream)throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new hg(h.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new hg(h.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),t.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(Gg.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,i.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),t.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,i){if(Ie(e),i&&Se(i),"rtc"===this.mode)throw t.warning("[".concat(this._clientId,"]rtc mode can not use setClientRole")),new hg(h.INVALID_OPERATION,"rtc mode can not use setClientRole");if(i&&i.level&&"host"===e)throw new hg(h.INVALID_OPERATION,"host mode can not set audience latency level");if("audience"===e&&this._p2pChannel.hasLocalMedia())throw new hg(h.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,i),this._config.role=e,t.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(i&&i.level))}getRemoteInboundOffset(){var e;const t=null===(e=this._p2pChannel.getStats())||void 0===e?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const i=t.timestamp-Date.now();return Math.abs(i)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return"visible"===document.visibilityState&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,n){if(f(e,"proxyServer"),!n){if("DISCONNECTED"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Set proxy server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new hg(h.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,i.setProxyServer(this._proxyServer),t.setProxyServer(this._proxyServer),t.info("[".concat(this._clientId,"] Set proxy server ").concat(n?"by initialize call":""," success."))}setTurnServer(e,i){if(Array.isArray(e)||(e=[e]),!i){if("DISCONNECTED"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Set turn server before join channel");if("disabled"!==this._cloudProxyServerMode||this._useLocalAccessPoint)throw new hg(h.INVALID_OPERATION,"You have already set the proxy")}if(re(e))return this._turnServer={servers:e,mode:"original-manual"},void t.info("[".concat(this._clientId,"] Set original turnserver ").concat(i?"by initialize call":""," success: ").concat(e.map((e=>e.urls)).join(","),"."));e.forEach((e=>ve(e))),this._turnServer={servers:e,mode:"manual"},t.info("[".concat(this._clientId,"] Set turnserver ").concat(i?"by initialize call":""," success."))}setLicense(e){if("DISCONNECTED"!==this.connectionState){throw new hg(h.INVALID_OPERATION,"you should set license before join channel")}if(f(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new hg(h.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,t.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if("DISCONNECTED"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||"manual"===this._turnServer.mode||this._useLocalAccessPoint)throw new hg(h.INVALID_OPERATION,"You have already set the proxy");const i=[3,4,5];let n;switch(void 0===e&&(e=3),e){case 1:case 2:throw new hg(h.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new hg(h.INVALID_PARAMS,"proxy server mode must be ".concat(i.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,t.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if("DISCONNECTED"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Stop proxy server after leave channel");i.setProxyServer(),t.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",t.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new hg(h.INVALID_PARAMS,"accessPoints is required.");S(e.accessPoints.serverList,"accessPoints.serverList"),f(e.accessPoints.domain,"accessPoints.domain");const i=(e,t)=>{_(e,t,0,65535,!0)};let n=443;if(e.accessPoints.port&&(i(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new hg(h.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");T("CLOSE_AFB_FOR_LOCAL_AP")&&(K("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),K("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const s=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,o=e.accessPoints.domain,r=e.accessPoints.serverList.map((e=>s.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(o):e)),a=r.map((e=>"".concat(e,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,K("WEBCS_DOMAIN",a),K("WEBCS_DOMAIN_BACKUP_LIST",a),K("GATEWAY_DOMAINS",[o]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(S(e.report.hostname,"report.hostname"),K("EVENT_REPORT_DOMAIN",e.report.hostname[0]),K("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(K("EVENT_REPORT_DOMAIN",r[0]),K("EVENT_REPORT_BACKUP_DOMAIN",r[1]||r[0]));let c=6443;e.report&&e.report.port&&(i(e.report.port,"report.port"),c=e.report.port),K("STATS_COLLECTOR_PORT",c),e.report?K("ENABLE_EVENT_REPORT",!0):K("ENABLE_EVENT_REPORT",!1);let d="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(S(e.log.hostname,"log.hostname"),d=e.log.hostname[0]):d=r[0];let l=6444;e.log&&e.log.port&&(i(e.log.port,"log.port"),l=e.log.port),K("LOG_UPLOAD_SERVER","".concat(d,":").concat(l));let u=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(S(e.cds.hostname,"cds.hostname"),u=e.cds.hostname):u=r;let p=443;e.cds&&e.cds.port&&(i(e.cds.port,"cds.port"),p=e.cds.port),K("CDS_AP",u.map((e=>"".concat(e,":").concat(p)))),e.cds?K("ENABLE_CONFIG_DISTRIBUTE",!0):K("ENABLE_CONFIG_DISTRIBUTE",!1),t.info("set local access point v2 success")}setLocalAccessPoints(e,i){if(S(e,"serverList"),f(i,"domain"),this._proxyServer||"disabled"!==this._cloudProxyServerMode)throw new hg(h.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((e=>n.test(e)?"".concat(e.replace(/\./g,"-"),".").concat(i):e)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,K("WEBCS_DOMAIN",e),K("WEBCS_DOMAIN_BACKUP_LIST",e),K("GATEWAY_DOMAINS",[i]),K("EVENT_REPORT_DOMAIN",e[0]),K("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),K("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),t.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(m(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw t.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else t.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,i){m(i,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,i),setTimeout((()=>{const t=this._users.find((t=>t.uid===e));t&&t.videoTrack&&t.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(e){throw t.error("[".concat(this._clientId,"] set remote video stream type error"),e.toString()),e}t.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(i)),this._remoteStreamTypeCacheMap.set(e,i)}async setStreamFallbackOption(e,i){m(i,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,i)}catch(e){throw t.error("[".concat(this._clientId,"] set stream fallback option"),e.toString()),e}t.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(i)),this._streamFallbackTypeCacheMap.set(e,i)}setEncryptionConfig(e,i,n){ye(e),f(i,"secret");const s=["aes-128-gcm2","aes-256-gcm2"];if(jo(s).call(s,e)){if(!n||!(n instanceof Uint8Array&&32===n.length))throw new hg(h.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new hg(h.INVALID_PARAMS,"current encrypt mode does not need salt");new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'\"|{}\\[\\]])(?=.{8,})").test(i)||t.warning("The secret is not strong:\n      The secret must contain at least 1 lowercase alphabetical character,\n      The secret must contain at least 1 uppercase alphabetical character,\n      The secret must contain at least 1 numeric character,\n      The secret must contain at least one special character,\n      The secret must be eight characters or longer.\n      "),this._encryptionMode=e,this._encryptionSecret=i,n&&(this._encryptionSalt=j(n))}async renewToken(e){if(f(e,"token",1,2047),!this._key||!this._joinInfo)throw new hg(h.INVALID_OPERATION,"renewToken should not be called before user join");const i=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(T("USE_NEW_TOKEN")){t.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await jR(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Z);t.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:i})}else t.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});t.debug("[".concat(this._clientId,"] renewToken success"))}catch(e){throw this._key=i,this._joinInfo.token=i,t.error("[".concat(this._clientId,"] renewToken failed"),e.toString()),e}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?t.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(pe.VOLUME_INDICATOR,e)}),T("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if("h264"!==this.codec)throw new hg(h.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new hg(h.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new hg(h.LIVE_STREAMING_TASK_CONFLICT);const i=t?QS.TRANSCODE:QS.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(QS.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((t=>t&&t.hasUrl(e)));if(!t.length)throw new hg(h.INVALID_PARAMS,"can not find live streaming url to stop");await eg.all(t.map((t=>t&&t.stopLiveStreamingTask(e))))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new hg(h.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const i=this._createLiveStreamingClient(QS.INJECT);i.setInjectStreamConfig(t,0),await i.startLiveStreamingTask(e,QS.INJECT)}async removeInjectStreamUrl(){var e;const t=this._createLiveStreamingClient(QS.INJECT),i=Array.from(cg(e=t.streamingTasks).call(e)).find((e=>e.mode===QS.INJECT));if(!this._joinInfo||!i)throw new hg(h.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await t.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(e){QR(e);const t=this._createChannelMediaRelayClient();await t.startChannelMediaRelay(e)}async updateChannelMediaRelay(e){QR(e);const t=this._createChannelMediaRelayClient();await t.updateChannelMediaRelay(e)}async stopChannelMediaRelay(){const e=this._createChannelMediaRelayClient();await e.stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendStreamMessage(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!this._joinInfo)throw new hg(h.INVALID_OPERATION,"can not send data stream, not joined");if(("string"==typeof e||e instanceof Uint8Array)&&(e={payload:e}),"string"==typeof e.payload){const t=new TextEncoder;e.payload=t.encode(e.payload)}if(new Blob([e.payload]).size>1024)throw new hg(h.INVALID_PARAMS,"stream message out of range.");return this._gateway.signal.request(KS.DATA_STREAM,{payload:j(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-pA},!t)}sendMetadata(e){if(!this._joinInfo)throw new hg(h.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new hg(h.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(KS.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:j(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(r),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"can not send custom report, not joined");await i.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,i){m(i.spatialLayer,"spatialLayer",[0,1,2,3]),m(i.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,i)}catch(e){throw t.error("[".concat(this._clientId,"] pick SVC layer failed"),e.toString()),e}}setRTM2Flag(e){if(m(e,"flag",[0,1]),!this._joinInfo)throw new hg(h.INVALID_OPERATION,"Can't setRtm2Flag, not joined");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"Can't setRtm2Flag in ".concat(this.connectionState," state"));return this._gateway.setRTM2Flag(e)}_reset(){if(t.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=ut.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((e=>e._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),"fallback"===this._cloudProxyServerMode&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new v("client-publish"),this._subscribeMutex=new v("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch(e){}if(this._moderation)try{this.setImageModeration(!1)}catch(e){}}_startSession(e,n){const s=e||ee();e?t.debug("[".concat(this._clientId,"] new Session ").concat(s)):t.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(s)),this._sessionId=s,this.store.sessionId=s,n?i.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:n.channel,appid:n.appId,mode:this.mode}):this._joinInfo?i.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._joinInfo.cname,appid:this._joinInfo.appId,mode:this.mode}):this._gateway.joinInfo&&i.sessionInit(this._sessionId,{lts:(new Date).getTime(),cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId,mode:this.mode}),this._joinInfo&&(this._joinInfo.sid=s),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=s)}async _publishHighStream(e){if(!this._joinInfo||void 0===this._uid)throw new hg(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if("auto"===this._turnServer.mode&&T("FORCE_TURN")&&!T("TURN_ENABLE_TCP")&&!T("TURN_ENABLE_UDP"))throw new hg(h.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");t.debug("[".concat(this._clientId,"] publish high stream"));try{if(this._p2pChannel instanceof dA){const t=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(t)try{await this._gateway.sendExtensionMessage(iT.PUBLISH,t)}catch(t){throw this._p2pChannel.unpublish(e),t}}else{const t=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter),n=(await t.next()).value;if(n){var i;let e;try{e=await this._gateway.publish(this._uid,n,!0)}catch(e){if(e.code!==h.DISCONNECT_P2P)throw t.throw(e),e}await t.next((null===(i=e)||void 0===i?void 0:i.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const t of e)t instanceof We&&t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig),!t.muted&&t.enabled||await this._p2pChannel.muteLocalTrack(t)}}catch(t){if(this._p2pChannel.reportPublishEvent(!1,null==t?void 0:t.code,e),(null==t?void 0:t.code)===h.WS_ABORT)return;throw t}}async _publishLowStream(){if(!this._joinInfo||void 0===this._uid)throw new hg(h.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if("CONNECTED"!==this.connectionState&&"RECONNECTING"!==this.connectionState)throw new hg(h.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));t.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const e=await this._p2pChannel.publishLowStream(this._lowStreamParameter),t=(await e.next()).value;if(t){var i;let n;try{n=await this._gateway.publish(this._uid,t,!0)}catch(t){if(t.code!==h.DISCONNECT_P2P)throw e.throw(t),t}e.next((null===(i=n)||void 0===i?void 0:i.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(e){if(this._p2pChannel.reportPublishEvent(!1,null==e?void 0:e.code,void 0,!0),(null==e?void 0:e.code)===h.WS_ABORT)return;throw e}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId){return new hg(h.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw()}const t=()=>new XR(this._joinInfo,this._config.websocketRetryConfig||Z,this._config.httpRetryConfig||Z),n=e=>{e.onLiveStreamError=(e,t)=>{i.reportApiInvoke(this._sessionId,{name:J.ON_LIVE_STREAM_ERROR,options:[e,t],tag:X.TRACER}).onSuccess(),this.safeEmit(pe.LIVE_STREAMING_ERROR,e,t)},e.onLiveStreamWarning=(e,t)=>{i.reportApiInvoke(this._sessionId,{name:J.ON_LIVE_STREAM_WARNING,options:[e,t],tag:X.TRACER}).onSuccess(),this.safeEmit(pe.LIVE_STREAMING_WARNING,e,t)},e.on(Tg.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new hg(h.INVALID_OPERATION,"can not find join info to get worker manager"));xR(e,this._joinInfo,this._axiosCancelSource.token,Z).then(t).catch(i)}))};switch(e){case QS.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case QS.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case QS.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(Tg.REQUEST_WORKER_MANAGER_LIST,((e,t,i)=>{if(!this._joinInfo)return i(new hg(h.INVALID_OPERATION,"can not find join info to get worker manager"));xR(e,this._joinInfo,this._axiosCancelSource.token,Z).then(t).catch(i)})),this._injectStreamingClient.onInjectStatusChange=(e,t,i)=>{this.safeEmit(pe.INJECT_STREAM_STATUS,e,t,i)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo){return new hg(h.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw()}if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),i={width:e,height:t};this._channelMediaRelayClient=new $R(this._joinInfo,this._clientId,this._config.websocketRetryConfig||Z,this._config.httpRetryConfig||Z,i),this._channelMediaRelayClient.on("state",(e=>{e===yg.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(pe.CHANNEL_MEDIA_RELAY_STATE,e)})),this._channelMediaRelayClient.on("event",(e=>{this.safeEmit(pe.CHANNEL_MEDIA_RELAY_EVENT,e)})),this._statsCollector.onStatsChanged=(e,t)=>{var i;"resolution"===e&&(null===(i=this._channelMediaRelayClient)||void 0===i||i.setVideoProfile(t))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,i){const{added:n,deleted:s}=e,o=[];Array.isArray(n)&&n.length>0&&n.forEach((e=>{const{uid:n,stream_id:s,ordered:r,max_retrans_times:a,metadata:c}=e,d=this._users.find((e=>e._uintid===n));if(!d)return void t.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));t.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(n)),jo(o).call(o,d)||o.push(d),d._uintid||(d._uintid=n);if(!(-1!==d._dataChannels.findIndex((t=>t.id===e.stream_id)))){const e={id:s,ordered:!!r,maxRetransmits:a,metadata:c},n=new ot(e);d._dataChannels.push(n),t.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published datachannel")),i||this.safeEmit(pe.USER_PUBLISHED,d,"datachannel",e)}this._p2pChannel.hasPendingRemoteDataChannel(d,e.stream_id)&&(t.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(d.uid," after reconnect.")),this._subscribeDataChannel(d,e.stream_id).catch((e=>{t.error("[".concat(this._clientId,"] resubscribe datachannel error"),e.toString())})))})),i&&(this.safeEmit(pe.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(s)&&s.length>0&&s.forEach((e=>{const{uid:i,stream_id:n}=e,s=this._users.find((e=>e._uintid===i));if(!s)return void t.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const o=s._dataChannels.find((t=>t.id===e.stream_id));o&&(t.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(i)),this._p2pChannel.unsubscribeDataChannel(s,[o]).then((e=>{if(e)return s._dataChannels=s._dataChannels.filter((e=>e!==o)),this._gateway.unsubscribeDataChannel(e,s.uid)})),t.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished datachannel ,id:").concat(o.id)),this.safeEmit(pe.USER_UNPUBLISHED,s,"datachannel",o._config))}))}_handleRemoveDataChannels(e){const i=this._users.find((t=>t.uid===e.uid));if(i){if(void 0!==i._dataChannels&&i._dataChannels.length>0){t.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{t.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished datachannel")),i._dataChannels.forEach((e=>{this.safeEmit(pe.USER_UNPUBLISHED,i,"datachannel",e._config)}))};this._p2pChannel.unsubscribeDataChannel(i,i._dataChannels).then((e=>{if(e)return this._gateway.unsubscribeDataChannel(e,i.uid)})),n()}}else t.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Og.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(Og.CONNECTION_STATE_CHANGE,((e,n,s)=>{var o;if(s===L.FALLBACK)return;const r=()=>{this.safeEmit(pe.CONNECTION_STATE_CHANGE,e,n,s)};if(i.reportApiInvoke(this._sessionId||(null===(o=this._gateway.joinInfo)||void 0===o?void 0:o.sid)||null,{name:J.CONNECTION_STATE_CHANGE,options:[e,n,s],tag:X.TRACER}).onSuccess(JSON.stringify({cur:e,prev:n,reason:s})),t.info("[".concat(this._clientId,"] connection state change: ").concat(n," -> ").concat(e)),"DISCONNECTED"===e)return this._reset(),void r();if("RECONNECTING"===e)this._users.forEach((e=>{e._trust_in_room_=!1,e._trust_audio_enabled_state_=!1,e._trust_video_enabled_state_=!1,e._trust_audio_mute_state_=!1,e._trust_video_mute_state_=!1,e._trust_audio_stream_added_state_=!1,e._trust_video_stream_added_state_=!1,e._audioSSRC=void 0,e._videoSSRC=void 0,e._videoOrtc=void 0,e._audioOrtc=void 0,e._cname=void 0,e._rtxSsrcId=void 0})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if("CONNECTED"===e){var a;this._streamFallbackTypeCacheMap.forEach(((e,i)=>{this._gateway.setStreamFallbackOption(i,e).catch((e=>{t.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),e)}))})),this._remoteStreamTypeCacheMap.forEach(((e,i)=>{this._gateway.setRemoteVideoStreamType(i,e).catch((e=>{t.warning("[".concat(this._clientId,"] auto set remote stream type failed"),e)}))})),void 0!==this._remoteDefaultVideoStreamType&&void 0===(null===(a=this._joinInfo)||void 0===a?void 0:a.defaultVideoStream)&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{t.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((e=>{t.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(e))})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{if("CONNECTED"!==this.connectionState)return;this._userOfflineTimeout=void 0;this._users.filter((e=>!e._trust_in_room_)).forEach((e=>{t.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(e.uid)),this._handleUserOffline({uid:e.uid})}))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{"CONNECTED"===this.connectionState&&(this._streamRemovedTimeout=void 0,this._users.forEach((e=>{e._trust_audio_mute_state_||(t.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,Fg.AUDIO,!1)),e._trust_video_mute_state_||(t.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(e.uid)),this._handleMuteStream(e.uid,Fg.VIDEO,!1)),e._trust_audio_enabled_state_||(t.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(e.uid)),this._handleSetStreamLocalEnable("audio",e.uid,!0)),e._trust_video_enabled_state_||(t.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(e.uid)),this._handleSetStreamLocalEnable("video",e.uid,!0)),e._trust_video_stream_added_state_||(t.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(e.uid)),this._handleResetAddStream(e,"video")),e._trust_audio_stream_added_state_||(t.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(e.uid)),this._handleResetAddStream(e,"audio")),e._video_added_||e._audio_added_||(t.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(e.uid)),this._handleRemoveStream({uid:e.uid,uint_id:e._uintid}))})))}),1e3))}r()})),this._gateway.on(Og.REQUEST_NEW_GATEWAY_LIST,((e,t)=>{if(!this._joinInfo)return t(new hg(h.UNEXPECTED_ERROR,"can not recover, no join info"));LR(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Z,this.store).then((t=>{this._joinInfo&&(this._joinInfo.apResponse=t.gatewayInfo.res,this._joinInfo.gatewayAddrs=t.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=t.gatewayInfo.uni_lbs_ip);const i=[];t.gatewayInfo.gatewayAddrs.forEach((e=>{let{address:t}=e;const[n,s]=t.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:n,port:s}):i.push({host:n,port:s})})),e(i)})).catch(t)})),this._gateway.on(Og.NETWORK_QUALITY,(e=>{"normal"===this._networkQualitySensitivity&&this.safeEmit(pe.NETWORK_QUALITY,e)})),this._gateway.on(Og.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(pe.STREAM_TYPE_CHANGED,e,t);i.reportApiInvoke(this._sessionId,{name:J.STREAM_TYPE_CHANGE,options:[e,t],tag:X.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.on(Og.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(Og.NEED_RENEW_SESSION,(()=>{this._startSession()})),this._gateway.on(Og.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,i)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(e){i(e)}})),this._gateway.on(Og.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;const{dtlsParameters:i,iceParameters:n,candidates:s,rtpCapabilities:o,setup:r,cname:a}=NI(e.ortc,t);this._p2pChannel.connect(n,i,s,o,r,a)})),this._gateway.on(Og.REQUEST_DC_CONNECTION_PARAMS,(e=>{e(this._p2pChannel.getEstablishParams())})),this._gateway.on(Og.RESET_SIGNAL,(e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()})),this._gateway.on(Og.DATACHANNEL_FAILBACK,(()=>{this._joinGateway()})),this._gateway.on(Og.DATACHANNEL_PRECONNECT,(async(e,i,n,s)=>{var o,r,a,c,d,l;await this._p2pChannel.startP2PConnection({turnServer:null===(o=this._joinInfo)||void 0===o?void 0:o.turnServer},!0);const h=function(e,i){let n;return i&&i.ip&&"number"==typeof i.port?(n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip,port:i.port.toString(),type:"host",extension:{}}],t.debug("Using remote candidate from AP ".concat(i.ip,":").concat(i.port)),i.ip6&&(n.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:i.ip6,port:i.port.toString(),type:"host",extension:{}}),t.debug("Using IPV6 remote candidate from AP ".concat(i.ip6,":").concat(i.port)))):n=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],n}(e,i);return this._p2pChannel.preConnect({iceUfrag:"".concat(null===(r=this._joinInfo)||void 0===r?void 0:r.apResponse.cid,"_").concat(null===(a=this._joinInfo)||void 0===a?void 0:a.apResponse.cert),icePwd:"".concat(null===(c=this._joinInfo)||void 0===c?void 0:c.apResponse.cid,"_").concat(null===(d=this._joinInfo)||void 0===d?void 0:d.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:null!==(l=T("FINGERPRINT"))&&void 0!==l?l:e.fingerprint}]},h,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(s)}))}_handleGatewaySignalEvents(){this._gateway.signal.on(YS.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(YS.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(YS.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc))),this._gateway.signal.on(YS.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(YS.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(YS.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)})),this._gateway.signal.on(YS.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(YS.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(YS.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,Fg.AUDIO,!0))),this._gateway.signal.on(YS.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,Fg.AUDIO,!1))),this._gateway.signal.on(YS.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,Fg.VIDEO,!0))),this._gateway.signal.on(YS.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,Fg.VIDEO,!1))),this._gateway.signal.on(YS.RECEIVE_METADATA,(e=>{const t=B(e.metadata);this.safeEmit(pe.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(YS.ON_DATA_STREAM,(async e=>{if(!e)return;let t=0;if(e.ordered||e.syncWithAudio){const i=this._p2pChannel.getStats(),n=this.remoteUsers.find((t=>t.uid===e.uid)),s=null==i?void 0:i.audioRecv.find((e=>e.ssrc===(null==n?void 0:n._audioSSRC)));t=null==s?void 0:s.jitterBufferMs}null==t&&(t=0),gA(e,t,{id:this._clientId,onStreamMessage:"function"==typeof this.onStreamMessage?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(YS.ON_CRYPT_ERROR,(()=>{Ae((()=>{t.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(pe.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(YS.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(YS.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{t.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,L.TOKEN_EXPIRE),this.safeEmit(pe.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(YS.ON_STREAM_FALLBACK_UPDATE,(e=>{t.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(pe.STREAM_FALLBACK,e.stream_id,1===e.stream_type?"fallback":"recover")})),this._gateway.signal.on(YS.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),t.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(YS.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(YS.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(HS.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case KS.PUBLISH:{if(!t)return;const e=t.ortc;if(e){var n,s;const o=e.some((e=>{let{stream_type:t}=e;return t===wg.Audio})),r=e.some((e=>{let{stream_type:t}=e;return t!==wg.Audio})),a=e.some((e=>{let{stream_type:t}=e;return t===wg.Screen||t===wg.ScreenLow}));"offer"===t.state&&i.publish(this._joinInfo.sid,{eventElapse:YT.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:h.TIMEOUT,audio:o,video:r,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:o?null===(n=e.find((e=>{let{stream_type:t}=e;return t===wg.Audio})))||void 0===n||null===(n=n.ssrcs[0])||void 0===n?void 0:n.ssrcId.toString():void 0,videoName:r?null===(s=e.find((e=>{let{stream_type:t}=e;return t!==wg.Audio})))||void 0===s||null===(s=s.ssrcs[0])||void 0===s?void 0:s.ssrcId.toString():void 0})}break}case KS.SUBSCRIBE:t&&i.subscribe(this._joinInfo.sid,{succ:!1,ec:h.TIMEOUT,audio:t.stream_type===Fg.AUDIO,video:t.stream_type===Fg.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:YT.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}})),this._gateway.signal.on(YS.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(YS.ON_PUBLISHED_USER_LIST,(e=>{if(null==e||!e.users)return;T("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((e=>!Xo(e.string_id||e.stream_id,this.channelName))));const i=[],n=[];for(const s of e.users){let e=this._users.find((e=>e._uintid===s.stream_id));e?e._trust_in_room_=!0:(e=new eI(s.string_id||s.stream_id,s.stream_id),this._users.push(e),0===this.getListeners(pe.PUBLISHED_USER_LIST).length&&(t.debug("[".concat(this._clientId,"] user online"),s.stream_id),this.safeEmit(pe.USER_JOINED,e)));const o=bg.Audio&s.stream_type,r=(bg.Video|bg.LwoVideo)&s.stream_type,a=0!=(65280&s.stream_type),c=o&&e.hasAudio,d=r&&e.hasVideo;r&&(e._trust_video_stream_added_state_=!0,e._video_added_=!0,e._videoSSRC=s.video_ssrc,e._rtxSsrcId=s.video_rtx),o&&(e._trust_audio_stream_added_state_=!0,e._audio_added_=!0,e._audioSSRC=s.audio_ssrc),o&&!c&&0===this.getListeners(pe.PUBLISHED_USER_LIST).length&&(t.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published audio")),this.safeEmit(pe.USER_PUBLISHED,e,"audio")),r&&!d&&0===this.getListeners(pe.PUBLISHED_USER_LIST).length&&(t.info("[".concat(this._clientId,"] remote user ").concat(e.uid," published video")),this.safeEmit(pe.USER_PUBLISHED,e,"video")),(o&&!c||r&&!d||a)&&i.push(e),r&&this._p2pChannel.hasPendingRemoteMedia(e,"video")&&n.push({user:e,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(e,"audio")&&n.push({user:e,mediaType:"audio"})}n.length>0&&(t.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((e=>"user: ".concat(e.user.uid,", mediaType: ").concat(e.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((e=>{t.error("[".concat(this._clientId,"] mass resubscribe error"),e.toString())}))),this.getListeners(pe.PUBLISHED_USER_LIST).length>0?T("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=i:(t.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(i.map((e=>e.uid)).join(", "))),this.safeEmit(pe.PUBLISHED_USER_LIST,i)):t.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(i.map((e=>e.uid)).join(", ")))}))}_handleP2PEvents(){this._gateway.signal.on(YS.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(iT.PUBLISH,(async(e,t)=>{e.forEach((e=>e.kind===Fg.VIDEO?(this._handleP2PAddAudioOrVideoStream("video",t),e.isMuted?this._handleMuteStream(t,Fg.VIDEO,!0):this._handleMuteStream(t,Fg.VIDEO,!1)):(this._handleP2PAddAudioOrVideoStream("audio",t),e.isMuted?this._handleMuteStream(t,Fg.AUDIO,!0):this._handleMuteStream(t,Fg.AUDIO,!1))))})),this._gateway.signal.on(HS.P2P_START,(async(e,t)=>{if(this._p2pChannel instanceof dA){var i;t(await this._p2pChannel.startP2P({turnServer:null===(i=this._joinInfo)||void 0===i?void 0:i.turnServer},e))}})),this._gateway.signal.on(HS.P2P_CONNECTION,(async e=>{this._p2pChannel instanceof dA&&await this._p2pChannel.p2pConnect(e)})),this._gateway.signal.on(HS.P2P_REMOTE_CANDIDATE_UPDATE,(e=>{this._p2pChannel instanceof dA&&this._p2pChannel.addRemoteCandidate(JSON.parse(e))})),this._gateway.signal.on(iT.SUBSCRIBE,(async(e,t,i)=>{if(this._p2pChannel instanceof dA){const{trackType:n}=JSON.parse(e);try{await this._p2pChannel.dopublish(n),t()}catch(e){i(e)}}})),this._gateway.signal.on(iT.UNSUBSCRIBE,(async(e,t,i)=>{if(this._p2pChannel instanceof dA){const{mediaType:n}=JSON.parse(e);try{await this._p2pChannel.doUnpublish(n),t()}catch(e){i(e)}}})),this._gateway.signal.on(iT.EXCHANGE_SDP,(async(e,t,i)=>{if(this._p2pChannel instanceof dA){const{type:n,sdp:s}=JSON.parse(e);try{t(await this._p2pChannel.setDescription(n,s))}catch(e){i(e)}}})),this._gateway.signal.on(iT.UNPUBLISH,(async(e,i,n)=>{if(this._p2pChannel instanceof dA){const{unpubMsg:s,uid:o}=e;if(1===s.length){const r=s[0].stream_type===wg.Audio?Fg.AUDIO:Fg.VIDEO;this._handleMuteStream(o,r,!0);const{sdp:a}=e;if(this._p2pChannel instanceof dA&&a){const e=this._users.find((e=>e.uid===o));if(!e)return t.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(o)),void i();this._p2pChannel.unsubscribe(e,a,r).then((e=>{e&&i(e)})).catch(n)}else i()}else this._handleRemoveStream(e,i,n)}})),this._gateway.signal.on(iT.CONTROL,(async(e,t,i)=>{const{action:n,sdp:s,isMuteAll:o,uid:r}=e;switch(n){case nT.MUTE_LOCAL_VIDEO:this._handleMuteStream(r,Fg.VIDEO,!0,s,t,i);break;case nT.MUTE_LOCAL_AUDIO:t(),this._handleMuteStream(r,Fg.AUDIO,!0);break;case nT.UNMUTE_LOCAL_VIDEO:t(),this._handleP2PAddAudioOrVideoStream("video",r),this._handleMuteStream(r,Fg.VIDEO,!1);break;case nT.UNMUTE_LOCAL_AUDIO:t(),this._handleP2PAddAudioOrVideoStream("audio",r),this._handleMuteStream(r,Fg.AUDIO,!1)}o&&this._handleRemoveStream(e,t,i)})),this._gateway.signal.on(iT.DO_SUBSCRIBE,(async(e,i,n)=>{if(this._p2pChannel instanceof dA){const{kind:s,sdp:o,ssrcId:r,uid:a}=e,c=this._users.find((e=>e.uid===a));if(!c)return t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)")),void i();try{i(await this._p2pChannel.subscribe(c,s,o,r))}catch(e){n(e)}}})),this._gateway.signal.on(iT.DO_UNSUBSCRIBE,(async(e,i,n)=>{if(this._p2pChannel instanceof dA){const{uid:s,kind:o,sdp:r}=e,a=this._users.find((e=>e.uid===s));if(!a)return t.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)")),void i();try{i(await this._p2pChannel.unsubscribe(a,r,o))}catch(e){n(e)}}})),this._gateway.signal.on(iT.RESTART_ICE,(async(e,t,i)=>{if(this._p2pChannel instanceof dA)try{t(await this._p2pChannel.setDescription("remote",e))}catch(e){i(e)}})),this._p2pChannel.on(Hg.RequestP2PRestartICE,(async(e,t,i)=>{try{t(await this._gateway.sendExtensionMessage(iT.RESTART_ICE,e))}catch(e){i(e)}})),this._p2pChannel.on(Hg.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(iT.CANDIDATE,JSON.stringify(e))})),this._p2pChannel.on(Hg.RequestP2PMuteLocal,(async(e,t,i)=>{try{t(await this._gateway.sendExtensionMessage(iT.CONTROL,e))}catch(e){i(e)}})),this._p2pChannel.on(Hg.RequestP2PPublish,(async(e,t,i)=>{try{t(await this._gateway.sendExtensionMessage(iT.DO_SUBSCRIBE,e))}catch(e){i(e)}})),this._p2pChannel.on(Hg.RequestP2PUnPublish,(async(e,t,i)=>{try{t(await this._gateway.sendExtensionMessage(iT.DO_UNSUBSCRIBE,e))}catch(e){i(e)}})),this._p2pChannel.on(Hg.RequestP2PUnmuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Hg.RequestP2PMuteRemote,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Hg.StateChange,((e,t)=>{t===Wg.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(Hg.RequestMuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Hg.RequestUnmuteLocal,(async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(e){e.code===h.DISCONNECT_P2P?t():i(e)}else t()})),this._p2pChannel.on(Hg.RequestRePublish,((e,t,i)=>{this.publish(e,!1).then(t).catch(i)})),this._p2pChannel.on(Hg.RequestRePublishDataChannel,((e,t,i)=>{eg.all(e.map((async e=>{await this._p2pChannel.publishDataChannel([e]);const t={streamId:e.id,ordered:e.ordered,maxRetransmits:e.maxRetransmits,metadata:e.metadata,channelId:e._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,t,!0)}catch(e){if(e.code!==h.DISCONNECT_P2P)throw e}}))).then(t).catch(i)})),this._p2pChannel.on(Hg.RequestReSubscribe,(async(e,t,i)=>{try{for(const{user:t,kind:i}of e)i===Fg.VIDEO?await this.subscribe(t,"video"):await this.subscribe(t,"audio");t()}catch(e){i(e)}})),this._p2pChannel.on(Hg.RequestUploadStats,((e,t)=>{this._gateway.uploadStats(e,t)})),this._p2pChannel.on(Hg.MediaReconnectStart,(e=>{this.safeEmit(pe.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(Hg.MediaReconnectEnd,(e=>{this.safeEmit(pe.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(Hg.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(Hg.RequestRestartICE,(async e=>{if(this._p2pChannel instanceof dA)return;const t=await this._p2pChannel.restartICE(e),i=await t.next();if(i.done)return;const n=i.value;let s;try{s=await this._gateway.restartICE({iceParameters:n})}catch(e){return void t.throw(e)}const{iceParameters:o}=function(e){const t=e.iceParameters;return{iceParameters:{iceUfrag:t.iceUfrag,icePwd:t.icePwd}}}(s);await t.next({remoteIceParameters:o})})),this._p2pChannel.on(Hg.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(Hg.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:i,rtpCapabilities:n}=await this._p2pChannel.startP2PConnection({turnServer:null===(e=this._joinInfo)||void 0===e?void 0:e.turnServer}),{gatewayEstablishParams:s,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:n}),{dtlsParameters:r,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:h}=NI(s,o);await this._p2pChannel.connect(a,r,c,d,l,h),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(Hg.RequestUnpublishForReconnectPC,(async(e,t,i)=>{this._joinInfo&&void 0!==this._uid?(await this._gateway.unpublish(e,this._uid),t()):i()})),this._p2pChannel.on(Hg.P2PLost,(()=>{this.safeEmit(pe.P2P_LOST,this.store.uid)})),this._p2pChannel.on(Hg.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(Hg.ConnectionTypeChange,(e=>{this.safeEmit(pe.IS_USING_CLOUD_PROXY,e)})),this._p2pChannel.on(Hg.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(Hg.QueryClientConnectionState,(e=>{e(this.connectionState)}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if("CONNECTED"!==this.connectionState||!this._joinInfo)throw new hg(h.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new hg(h.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new hg(h.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new hg(h.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach((e=>{var t;if(!jo(t=["supervise","moderation"]).call(t,e))throw new hg(h.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(e," is not a valid inspect type."))})),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new hg(h.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new Ry(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Z)}catch(e){throw Array.isArray(e)?e[0]:e}}async disableContentInspect(){if(!this._inspect)throw new hg(h.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(E(e,"enabled"),e){if(!t)throw new hg(h.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(_(t.interval,"interval",1e3,1/0),"CONNECTED"!==this.connectionState||!this._joinInfo)throw new hg(h.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);const e=new tA(t);this._moderation=e,this.handleImageModerationEvents(this._moderation),await e.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Z)}catch(e){throw Array.isArray(e)?e[0]:e}}else{if(!this._moderation)throw new hg(h.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}}handleImageModerationEvents(e){e.on(eT.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(pe.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,i),t===$g.CONNECTED){if("CONNECTED"!==this.connectionState)throw this.setImageModeration(!1),new hg(h.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(eT.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}handleVideoInspectEvents(e){e.on(Jg.CONNECTION_STATE_CHANGE,((t,i)=>{if(this.safeEmit(pe.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,i),i===qg.CONNECTED){if("CONNECTED"!==this.connectionState)return void this.safeEmit(pe.CONTENT_INSPECT_ERROR,new hg(h.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(Jg.INSPECT_RESULT,((e,i)=>{var n;if((null==i?void 0:i.code)===h.INVALID_OPERATION&&"DISCONNECTED"===this.connectionState)return t.debug("Stop inspect content because that has left channel"),null==this||null===(n=this._inspect)||void 0===n||n.close(),void(this._inspect=void 0);this.safeEmit(pe.CONTENT_INSPECT_RESULT,e,i)})),e.on(Jg.CLIENT_LOCAL_VIDEO_TRACK,(e=>{e(this.localTracks.filter((e=>"video"===e.trackMediaType))[0])}))}getJoinChannelServiceRecords(){return t.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){E(e,"enabled"),K("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}function IA(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const t=i.reportApiInvoke(null,{name:J.CREATE_CLIENT,options:[e],tag:X.TRACER});try{_e(e)}catch(e){throw t.onError(e),e}return void 0===e.audioCodec&&(e.audioCodec="opus"),t.onSuccess(),new RA(CA(CA({forceWaitGatewayResponse:!0},e),{},{role:"rtc"===e.mode?"host":e.role||"audience"}))}async function vA(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;t.addTransceiver("video",{direction:"recvonly"}),t.addTransceiver("audio",{direction:"recvonly"});const i=(await t.createOffer()).sdp;if(!i)return e;t.close(),t=null,e=function(e){const t={video:[],audio:[]};return e.match(/ VP8/i)&&t.video.push("VP8"),e.match(/ VP9/i)&&t.video.push("VP9"),e.match(/ AV1/i)&&t.video.push("AV1"),e.match(/ H264/i)&&t.video.push("H264"),e.match(/ H265/i)&&t.video.push("H265"),e.match(/ opus/i)&&t.audio.push("OPUS"),e.match(/ PCMU/i)&&t.audio.push("PCMU"),e.match(/ PCMA/i)&&t.audio.push("PCMA"),e.match(/ G722/i)&&t.audio.push("G722"),t}(i)}catch(e){throw new hg(h.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return e}function yA(){const e=i.reportApiInvoke(null,{name:J.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:X.TRACER});let n=!1;try{const e=window.RTCPeerConnection,t=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,i=window.WebSocket;n=!!(e&&t&&i)}catch(e){return t.error("check system requirement failed: ",e),!1}let s=!1;const o=Q();o.name===ie.CHROME&&Number(o.version)>=58&&(!we()||Oe())&&(s=!0),o.name===ie.FIREFOX&&Number(o.version)>=56&&(s=!0),o.name===ie.OPERA&&Number(o.version)>=45&&(s=!0),o.name===ie.SAFARI&&Number(o.version)>=11&&(s=!0),(Ne()||be())&&(s=!0),t.debug("checkSystemRequirements, api:",n,"browser",s);const r=n&&s;return e.onSuccess(r),r}dg([o(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],RA.prototype,"leave",null),dg([o({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof qe))return[t];t=[t]}return t.map((e=>e?Object(e).toString():"null"))}}),lg("design:type",Function),lg("design:paramtypes",[Object,Boolean]),lg("design:returntype",eg)],RA.prototype,"publish",null),dg([o({argsMap:(e,t)=>(t||(t=[]),t instanceof it?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map((e=>e.getTrackId()))))}),lg("design:type",Function),lg("design:paramtypes",[Object]),lg("design:returntype",eg)],RA.prototype,"unpublish",null),dg([o({argsMap:(e,t,i,n)=>[t.uid,i,n]}),lg("design:type",Function),lg("design:paramtypes",[eI,String,Number]),lg("design:returntype",eg)],RA.prototype,"subscribe",null),dg([o({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return[null==t?void 0:t.uid,i]}))}),lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],RA.prototype,"massSubscribe",null),dg([o({argsMap:(e,t,i,n)=>[t.uid,i,n]}),lg("design:type",Function),lg("design:paramtypes",[eI,String,Number]),lg("design:returntype",eg)],RA.prototype,"unsubscribe",null),dg([o({argsMap:(e,t)=>t.map((e=>{let{user:t,mediaType:i}=e;return{uid:null==t?void 0:t.uid,mediaType:i}}))}),lg("design:type",Function),lg("design:paramtypes",[Array]),lg("design:returntype",eg)],RA.prototype,"massUnsubscribe",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Object]),lg("design:returntype",eg)],RA.prototype,"setLowStreamParameter",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],RA.prototype,"enableDualStream",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],RA.prototype,"disableDualStream",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[String,Object]),lg("design:returntype",eg)],RA.prototype,"setClientRole",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[String,Boolean]),lg("design:returntype",void 0)],RA.prototype,"setProxyServer",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Object,Boolean]),lg("design:returntype",void 0)],RA.prototype,"setTurnServer",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",void 0)],RA.prototype,"setLicense",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Number]),lg("design:returntype",void 0)],RA.prototype,"startProxyServer",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",void 0)],RA.prototype,"stopProxyServer",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Object]),lg("design:returntype",void 0)],RA.prototype,"setLocalAccessPointsV2",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Array,String]),lg("design:returntype",void 0)],RA.prototype,"setLocalAccessPoints",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Number]),lg("design:returntype",eg)],RA.prototype,"setRemoteDefaultVideoStreamType",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Object,Number]),lg("design:returntype",eg)],RA.prototype,"setRemoteVideoStreamType",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Object,Number]),lg("design:returntype",eg)],RA.prototype,"setStreamFallbackOption",null),dg([o({argsMap:(e,t)=>[t]}),lg("design:type",Function),lg("design:paramtypes",[String,String,Uint8Array]),lg("design:returntype",void 0)],RA.prototype,"setEncryptionConfig",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],RA.prototype,"renewToken",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",void 0)],RA.prototype,"enableAudioVolumeIndicator",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[String,Boolean]),lg("design:returntype",eg)],RA.prototype,"startLiveStreaming",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Object]),lg("design:returntype",eg)],RA.prototype,"setLiveTranscoding",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[String]),lg("design:returntype",eg)],RA.prototype,"stopLiveStreaming",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[String,Object]),lg("design:returntype",eg)],RA.prototype,"addInjectStreamUrl",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],RA.prototype,"removeInjectStreamUrl",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[zR]),lg("design:returntype",eg)],RA.prototype,"startChannelMediaRelay",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[zR]),lg("design:returntype",eg)],RA.prototype,"updateChannelMediaRelay",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],RA.prototype,"stopChannelMediaRelay",null),dg([o({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),lg("design:type",Function),lg("design:paramtypes",[Object]),lg("design:returntype",eg)],RA.prototype,"sendCustomReportMessage",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Object,Object]),lg("design:returntype",eg)],RA.prototype,"pickSVCLayer",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Number]),lg("design:returntype",eg)],RA.prototype,"setRTM2Flag",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Object]),lg("design:returntype",eg)],RA.prototype,"enableContentInspect",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",eg)],RA.prototype,"disableContentInspect",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Boolean,Object]),lg("design:returntype",eg)],RA.prototype,"setImageModeration",null),dg([o({reportResult:!0}),lg("design:type",Function),lg("design:paramtypes",[]),lg("design:returntype",Array)],RA.prototype,"getJoinChannelServiceRecords",null),dg([o(),lg("design:type",Function),lg("design:paramtypes",[Boolean]),lg("design:returntype",eg)],RA.prototype,"setPublishAudioFilterEnabled",null);const AA=Q().name;async function wA(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const s=i.reportApiInvoke(null,{tag:X.TRACER,name:J.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof We||e instanceof ze)){const e=new hg(h.INVALID_TRACK,"the parameter is not a video track");return s.onError(e),e.throw()}n&&n<1e3&&(n=1e3);const o=e instanceof We?e.getTrackLabel():"remote_track",r=e.getMediaStreamTrack(!0),a=document.createElement("video");a.style.width="1px",a.style.height="1px",a.setAttribute("muted",""),a.muted=!0,a.setAttribute("playsinline",""),a.controls=!1,(se()||De())&&(a.style.opacity="0.01",a.style.position="fixed",a.style.left="0",a.style.top="0",document.body.appendChild(a)),a.srcObject=new MediaStream([r]),a.play();const c=document.createElement("canvas");c.width=160,c.height=120;let d=0,l=0;try{const e=Date.now();d=await function(e,i,n,s){let o,r=0,a=null;return new eg(((c,d)=>{function l(){r>s&&o&&(o(),c(r));const i=n.getContext("2d");if(!i){const e=new hg(h.UNEXPECTED_ERROR,"can not get canvas 2d context.");return t.error(e.toString()),void d(e)}i.drawImage(e,0,0,160,120);const l=i.getImageData(0,0,n.width,n.height),u=Math.floor(l.data.length/3);if(a){for(let e=0;e<u;e+=3)if(l.data[e]!==a[e])return r+=1,void(a=l.data);a=l.data}else a=l.data}setTimeout((()=>{o&&(o(),c(r))}),i),o=Ye((()=>{l()}),30)}))}(a,n,c,4),l=Date.now()-e}catch(e){throw s.onError(e),e}AA===ie.SAFARI&&(a.pause(),a.remove()),a.srcObject=null;const u=d>4,p={duration:l,changedPicNum:d,deviceLabel:o,result:u};return t.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(p))),s.onSuccess(p),u}async function OA(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;const s=i.reportApiInvoke(null,{tag:X.TRACER,name:J.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[n]});if(!(e instanceof Ge||e instanceof Xe)){const e=new hg(h.INVALID_TRACK,"the parameter is not a audio track");return s.onError(e),e.throw()}n&&n<1e3&&(n=1e3);const o=e instanceof Ge?e.getTrackLabel():"remote_track",r=e.getVolumeLevel();let a=r,c=r;const d=Date.now();return new eg((i=>{const r=setInterval((()=>{const l=e.getVolumeLevel();a=l>a?l:a,c=l<c?l:c;const h=a-c>1e-4,u=Date.now()-d;if(h||u>n){clearInterval(r);const n=h,c={duration:u,deviceLabel:o,maxVolumeLevel:a,result:n};t.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(c))),s.onSuccess(c),i(n)}}),200)}))}class NA{constructor(e,t){this.id=0,this.element=void 0,this.peerPair=void 0,this.context=void 0,this.audioPlayerElement=void 0,this.audioTrack=void 0,NA.count+=1,this.id=NA.count,this.element=e,this.context=t}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{const t=document.createElement("audio");t.srcObject=new MediaStream([e.track]),t.play(),this.audioPlayerElement=t}}async switchSdp(){if(!this.peerPair)return;const e=async(e,t)=>{const i="offer"===t?await e.createOffer():await e.createAnswer();return await e.setLocalDescription(i),"complete"===e.iceGatheringState?e.localDescription:new eg((t=>{e.onicegatheringstatechange=()=>{"complete"===e.iceGatheringState&&t(e.localDescription)}}))},t=async(e,t)=>await e.setRemoteDescription(t);try{const i=await e(this.peerPair[0],"offer");await t(this.peerPair[1],i);const n=await e(this.peerPair[1],"answer");await t(this.peerPair[0],n)}catch(e){throw new hg(h.LOCAL_AEC_ERROR,e.toString()).print()}}async getTracksFromMediaElement(e){if(this.audioTrack)return this.audioTrack;let t;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),t=this.context.createMediaStreamDestination();this.context.createMediaElementSource(e).connect(t)}catch(e){throw new hg(h.LOCAL_AEC_ERROR,e.toString()).print()}if(!t){throw new hg(h.LOCAL_AEC_ERROR,"no dest node when local aec").print()}const i=t.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const e=this.element,t=await this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(t),await this.switchSdp()}close(){t.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((e=>{e.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}NA.count=0;const bA=window.AudioContext||window.webkitAudioContext;class DA{constructor(){this.units=[],this.context=void 0}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return t.debug("the system does not need to process local aec"),-1;this.context||(this.context=new bA);let i=this.units.find((t=>t&&t.getElement()===e));return i||(i=new NA(e,this.context),this.units.push(i)),i.startEchoCancellation(),t.debug("start processing local audio echo cancellation, id is",i.id),i.id}_doesEnvironmentNeedAEC(){return Q().name!==ie.SAFARI}}dg([o({report:i}),lg("design:type",Function),lg("design:paramtypes",[HTMLAudioElement]),lg("design:returntype",Number)],DA.prototype,"processExternalMediaAEC",null);const PA=new DA;function LA(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function kA(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?LA(Object(i),!0).forEach((function(t){gp(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):LA(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}const MA=window||document;function UA(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!MA)return;const i=JA._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);const n=e=>{if(!(e&&e.blockedURI&&(JA.onSecurityPolicyViolation||JA.getListeners(Qg.SECURITY_POLICY_VIOLATION).length>0)))return;const t=e.blockedURI;T("CSP_DETECTED_HOSTNAME_LIST").some((e=>jo(t).call(t,e)))&&(JA.onSecurityPolicyViolation&&"function"==typeof JA.onSecurityPolicyViolation&&JA.onSecurityPolicyViolation(e),JA.getListeners(Qg.SECURITY_POLICY_VIOLATION).length>0&&JA.safeEmit(Qg.SECURITY_POLICY_VIOLATION,e))};i&&MA.removeEventListener("securitypolicyviolation",i),(t||e&&"function"==typeof e||JA.getListeners(Qg.SECURITY_POLICY_VIOLATION).length>0)&&MA.addEventListener("securitypolicyviolation",n),JA._cspEventHandlerPointer=n}function VA(e){return ct.enumerateDevices(!0,!0,e)}function xA(e){return ct.getRecordingDevices(e)}function FA(e){return ct.getCamerasDevices(e)}function jA(e){return ct.getSpeakers(e)}function BA(){return new zR}function GA(e){if(t.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw t.debug("Invalid appType"),new hg(h.INVALID_PARAMS,"invalid app type",e);K("APP_TYPE",Math.floor(e))}function WA(e){t.setLogLevel(e)}function HA(){T("USE_NEW_LOG")?K("UPLOAD_LOG",!0):t.enableLogUpload()}function KA(){T("USE_NEW_LOG")?K("UPLOAD_LOG",!1):t.disableLogUpload()}function qA(e){PA.processExternalMediaAEC(e)}function YA(e){e.forEach((e=>{const n=e;n.__registered__=!0,n.logger.hookLog=t.extLog,n.reporter.hookApiInvoke=i.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach((e=>{n.parameters[e]=T(e)}))}))}K("PROCESS_ID",Pe()),rt(),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void t.error("Error loading sdk config",e.message)}if(e)try{const i=JSON.parse(window.atob(e)),n=Date.now();t.debug("Loading global parameters from cache",i),Object.keys(i).forEach((e=>{if(Object.prototype.hasOwnProperty.call(c,e)){const{value:t,expires:s}=i[e];if(s&&s<=n)return;d[e]=t,c[e]=t}}))}catch(i){t.error("Error loading mutableParamsCache: ".concat(e),i.message)}}(),Array.isArray(d.AREAS)&&d.AREAS.length>0&&fR(d.AREAS,!0);const JA=function(e){const t=new g,i=e,n={getListeners:t.getListeners.bind(t),on:(e,i)=>(function(e,t){e===Qg.SECURITY_POLICY_VIOLATION&&UA(t,!0)}(e,i),t.on.bind(t)(e,i)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return kA(kA({},i),n)}({});function XA(e){at.onAudioAutoplayFailed=e}function zA(e){at.onAutoplayFailed=e}function QA(e){JA.onSecurityPolicyViolation=e}function ZA(e){JA.onCameraChanged=e}function $A(e){JA.onMicrophoneChanged=e}Object.defineProperties(JA,{onAudioAutoplayFailed:{get:()=>at.onAudioAutoplayFailed,set:XA},onAutoplayFailed:{get:()=>at.onAutoplayFailed,set:zA},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>JA._onSecurityPolicyViolation,set(e){JA._onSecurityPolicyViolation=e,UA(e)}},__CLIENT_LIST__:{get:()=>T("SHOW_GLOBAL_CLIENT_LIST")?Jo:[]}}),ct.on(dt.CAMERA_DEVICE_CHANGED,(e=>{t.info("camera device changed",JSON.stringify(e)),JA.onCameraChanged&&JA.onCameraChanged(e),JA.safeEmit(Qg.CAMERA_CHANGED,e)})),ct.on(dt.RECORDING_DEVICE_CHANGED,(e=>{t.info("microphone device changed",JSON.stringify(e)),JA.onMicrophoneChanged&&JA.onMicrophoneChanged(e),JA.safeEmit(Qg.MICROPHONE_CHANGED,e)})),ct.on(dt.PLAYOUT_DEVICE_CHANGED,(e=>{t.debug("playout device changed",JSON.stringify(e)),JA.onPlaybackDeviceChanged&&JA.onPlaybackDeviceChanged(e),JA.safeEmit(Qg.PLAYBACK_DEVICE_CHANGED,e)})),Be.onAutoplayFailed=()=>{t.info("detect audio element autoplay failed"),at.onAudioAutoplayFailed&&at.onAudioAutoplayFailed()},lt.on("autoplay-failed",(()=>{t.info("detect webaudio autoplay failed"),at.onAudioAutoplayFailed&&at.onAudioAutoplayFailed(),JA.safeEmit(Qg.AUTOPLAY_FAILED)})),window&&(window.__ARTC__={ESM_BUNDLER:true,ESM:false,UMD:false,DEV:false,AgoraRTC:JA,__TRACK_LIST__:ht}),A.on(w.NETWORK_STATE_CHANGE,((e,i)=>{t.info("[network-indicator] network state changed, ".concat(i," => ").concat(e))}));const ew=(e,i,n)=>{t.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(i))),K(e,i,n)};export{Pg as AREAS,JA as AgoraRTC,Ag as ChannelMediaRelayError,vg as ChannelMediaRelayEvent,yg as ChannelMediaRelayState,Ho as DEV,Go as ESM,Bo as ESM_BUNDLER,Wo as UMD,Jo as __CLIENT_LIST__,OA as checkAudioTrackIsActive,yA as checkSystemRequirements,wA as checkVideoTrackIsActive,BA as createChannelMediaRelayConfiguration,IA as createClient,KA as disableLogUpload,HA as enableLogUpload,FA as getCameras,VA as getDevices,xA as getMicrophones,jA as getPlaybackDevices,vA as getSupportedCodec,XA as onAudioAutoplayFailed,zA as onAutoplayFailed,ZA as onCameraChanged,$A as onMicrophoneChanged,QA as onSecurityPolicyViolation,qA as processExternalMediaAEC,YA as registerExtensions,GA as setAppType,fR as setArea,WA as setLogLevel,ew as setParameter};
